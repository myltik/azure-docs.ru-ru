В этой статье описаны проверенные методы для запуска виртуальной машины Windows в Azure. Основное внимание уделяется вопросам масштабируемости, доступности, управляемости и безопасности.

> [!NOTE]
> Azure предоставляет две модели развертывания: с использованием [Azure Resource Manager][resource-manager-overview] и классическую. В этой статье описывается использование модели развертывания c использованием диспетчера ресурсов, которую рекомендует применять для новых развертываний корпорация Майкрософт.
>
>

Мы не рекомендуем использовать одну виртуальную машину для критически важных рабочих нагрузок, так как на ней создается единая точка отказа. Для повышения уровня доступности разверните несколько виртуальных машин в [группе доступности][availability-set]. Дополнительные сведения см. в статье [Running multiple VMs on Azure for scalability and availability][multi-vm] (Запуск нескольких виртуальных машин в Azure для обеспечения масштабируемости и доступности).

## <a name="architecture-diagram"></a>Схема архитектуры

Для подготовки виртуальной машины в Azure нужно больше подвижных частей, чем просто для ее создания. К таким элементам относятся вычислительные, сетевые ресурсы и ресурсы хранения.

> Документ Visio с этой схемой архитектуры можно скачать в [Центре загрузки Майкрософт][visio-download]. Эта схема находится на странице "Compute - single VM" (Среда выполнения приложений — одна виртуальная машина).
>
>

![[0]][0]

* **Группа ресурсов.** [*Группа ресурсов*][resource-manager-overview] представляет собой контейнер, содержащий связанные ресурсы. Создайте группу ресурсов для хранения ресурсов виртуальной машины.
* **Виртуальная машина**. Виртуальную машину можно подготовить на основе списка опубликованных образов или файла виртуального жесткого диска (VHD), передав его в хранилище BLOB-объектов Azure.
* **Диск ОС.** Этот диск представляет собой VHD-файл, сохраненный в [службе хранилища Azure][azure-storage]. Это означает, что он сохранится, даже если хост-компьютер выйдет из строя.
* **Временный диск.** Виртуальная машина создается с временным диском (в Windows это диск `D:`). Временный диск хранится на физическом диске хост-компьютера. Он *не* сохраняется в службе хранилища Azure и может быть удален во время перезагрузки и других событий жизненного цикла виртуальной машины. Используйте этот диск только для временных данных, таких как данные страниц или файлы подкачки.
* **Диски данных.** [Диск данных][data-disk] — это постоянный виртуальный жесткий диск, используемый для хранения данных приложений. Диски данных, такие как диск ОС, хранятся в службе хранилища Azure.
* **Виртуальная сеть и подсеть.** Каждая виртуальная машина в Azure развертывается в виртуальной сети, а виртуальные сети разделяются на подсети.
* **Общедоступный IP-адрес.** Общедоступный IP-адрес используется для связи с виртуальной машиной&mdash;. Например, через удаленный рабочий стол.
* **Сетевой интерфейс (сетевой адаптер)**. Сетевой адаптер обеспечивает взаимодействие виртуальной машины и виртуальной сети.
* **Группа безопасности сети**. [Группа безопасности сети][nsg] разрешает или запрещает прохождение сетевого трафика к подсети. Группу безопасности сети можно связать с отдельной сетевой картой или подсетью. Если она связывается с подсетью, то правила этой группы безопасности сети применяются ко всем виртуальным машинам в подсети.
* **Диагностика.** Ведение журналов диагностики очень важно для устранения неполадок виртуальной машины и управления ею.

## <a name="recommendations"></a>Рекомендации

Следующие рекомендации применимы для большинства ситуаций. Следуйте этим рекомендациям, если они не противоречат особым требованиям для вашего случая.

### <a name="vm-recommendations"></a>Рекомендации по виртуальным машинам

Azure предлагает виртуальные машины различных размеров, но мы советуем использовать виртуальные машины серий DS и GS, так как они поддерживают [хранилище класса Premium][premium-storage]. Если отсутствует специализированная рабочая нагрузка, например высокопроизводительные вычисления, выберите виртуальную машину одного из этих размеров. Дополнительную информацию см. в статье [Размеры виртуальных машин в Azure][virtual-machine-sizes].

При перемещении имеющейся рабочей нагрузки в Azure выберите начальный размер виртуальной машины, который точнее всего соответствует характеристикам локальных серверов. Затем измерьте производительность фактической рабочей нагрузки по таким ресурсам, как потребление ЦП, памяти и дисковых операций ввода-вывода в секунду, и при необходимости измените размер виртуальной машины. Если требуется несколько сетевых адаптеров для виртуальной машины, помните, что их максимально возможное количество зависит от [размера виртуальной машины][vm-size-tables].   

При подготовке виртуальной машины и других ресурсов необходимо указать регион. Обычно следует выбирать ближайший регион к месту расположения внутренних пользователей или клиентов. Но некоторые размеры виртуальных машин доступны не для всех регионов. Дополнительные сведения см. на странице [Службы по региону][services-by-region]. Чтобы получить список размеров виртуальных машин, доступных в нужном расположении, выполните следующую команду в интерфейсе командной строки Azure.

```
azure vm sizes --location <location>
```

Дополнительные сведения о выборе опубликованных образов виртуальных машин см. в статье [Просмотр и выбор образов виртуальных машин Windows в Azure с помощью оболочки PowerShell или интерфейса командной строки][select-vm-image].

### <a name="disk-and-storage-recommendations"></a>Рекомендации по дискам и хранилищам

Для лучшей производительности дисковых операций ввода-вывода мы рекомендуем использовать [хранилище класса Premium][premium-storage], в котором данные хранятся на твердотельных накопителях (SSD). Цена зависит от размера подготовленного диска. Скорость выполнения операций ввода-вывода и пропускная способность также зависят от размера диска. Поэтому во время подготовки диска следует учитывать все эти факторы.

Создайте отдельные учетные записи хранения Azure для виртуальных жестких дисков каждой виртуальной машины, чтобы не превышать ограничения по операциям ввода-вывода для учетных записей хранения.

Добавьте один или несколько дисков данных. При создании виртуальный машины жесткий диск не форматируется. Чтобы отформатировать диск, войдите в систему виртуальной машины. При наличии большого количества дисков данных учитывайте общие ограничения на количество операций ввода-вывода для учетной записи хранения. Дополнительные сведения см. в разделе [Ограничения для дисков виртуальной машины][vm-disk-limits].

Если это возможно, устанавливайте приложения на диск данных, а не на диск операционной системы. Однако некоторым устаревшим приложениям может потребоваться установить компоненты на диск C:. В этом случае вы можете [изменить размер диска операционной системы с помощью PowerShell][resize-os-disk].

Для повышения производительности храните журналы диагностики в отдельной учетной записи хранения. Учетной записи локально избыточного хранилища достаточно для хранения журналов диагностики.

### <a name="network-recommendations"></a>Рекомендации по сети

Общедоступный IP-адрес может быть динамическим или статическим. По умолчанию используется динамический IP-адрес.

* Зарезервируйте [статический IP-адрес][static-ip], если вам нужен постоянный IP-адрес &mdash; например, для создания записи А в DNS или добавления IP-адреса в список надежных отправителей.
* Можно также создать полное доменное имя для IP-адреса. Затем вы сможете зарегистрировать в DNS [запись CNAME][cname-record], которая указывает на полное доменное имя. Дополнительные сведения см. в статье [Создание полного доменного имени на портале Azure][fqdn].

Все группы безопасности сети содержат набор [правил по умолчанию][nsg-default-rules], включая правило, которое блокирует весь входящий интернет-трафик. Правила по умолчанию нельзя удалить, но их можно переопределить другими правилами. Чтобы разрешить интернет-трафик, создайте правила, разрешающие входящий трафик для определенных портов &mdash; например, это может быть порт 80 для протокола HTTP.  

Чтобы включить доступ по протоколу RDP, добавьте правило группы безопасности сети, которое разрешает входящий трафик через TCP-порт 3389.

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Размер виртуальной машины можно [увеличивать и уменьшать](../articles/virtual-machines/virtual-machines-windows-sizes.md) (масштабировать). Для горизонтального развертывания поместите две или больше виртуальных машин в группу доступности, регулируемую балансировщиком нагрузки. Подробные сведения см. в статье [Running multiple VMs on Azure for scalability and availability][multi-vm] (Использование нескольких виртуальных машин в Azure для обеспечения масштабируемости и доступности).

## <a name="availability-considerations"></a>Вопросы доступности

Для повышения уровня доступности разверните несколько виртуальных машин в группе доступности. Это также обеспечивает [соглашение об уровне обслуживания][vm-sla] (SLA) с более высоким уровнем услуг.

На виртуальную машину могут влиять процедуры [планового][planned-maintenance] и [внепланового технического обслуживания][manage-vm-availability]. Чтобы определить, вызвана ли перезагрузка плановым техническим обслуживанием, изучите [журналы перезагрузки виртуальной машины][reboot-logs].

Виртуальные жесткие диски хранятся в [службе хранилища Azure][azure-storage], которая реплицируется для обеспечения надежности и доступности.

Чтобы избежать случайной потери данных во время обычной работы (например, из-за ошибки пользователя), следует реализовать создание резервных копий на определенный момент времени с помощью [моментальных снимков больших двоичных объектов][blob-snapshot] или других инструментов.

## <a name="manageability-considerations"></a>Вопросы управляемости

**Группы ресурсов.** Поместите тесно связанные ресурсы с одинаковым жизненным циклом в одну [группу ресурсов][resource-manager-overview]. Группы ресурсов позволяют развертывать и отслеживать несколько ресурсов как единое целое, а также консолидировать счета по группам ресурсов. Можно также удалить ресурсы в виде набора, что очень удобно для тестирования развернутых служб. Присваивайте ресурсам информативные имена. Это упростит поиск определенного ресурса и понимание его роли. См. статью [Recommended naming conventions for Azure resources][naming conventions] (Рекомендуемые соглашения об именовании для ресурсов Azure).

**Диагностика виртуальной машины.** Включите мониторинг и диагностику, в том числе базовые метрики работоспособности, а также ведение журналов инфраструктуры диагностики и [диагностику загрузки][boot-diagnostics]. Если виртуальную машину невозможно загрузить, для обнаружения неисправностей можно использовать диагностику загрузки. Дополнительные сведения см. в статье [Включение мониторинга и диагностики][enable-monitoring]. Используйте расширение [Коллекция журналов Azure][log-collector], чтобы собирать журналы платформы Azure и отправлять их в службу хранилища Azure.   

Выполните следующую команду интерфейса командной строки, чтобы включить диагностику.

```
azure vm enable-diag <resource-group> <vm-name>
```

**Остановка виртуальной машины.** Azure различает состояния "Остановлена" и "Освобождена". Вы оплачиваете использование остановленных виртуальных машин, но не оплачиваете освобожденные виртуальные машины.

Используйте следующую команду интерфейса командной строки, чтобы освободить виртуальную машину.

```
azure vm deallocate <resource-group> <vm-name>
```

Также это можно сделать с помощью кнопки **Прервать** на портале Azure. Но если вы войдете в виртуальную машину и завершите работу операционной системы, виртуальная машина будет остановлена, а *не* освобождена, поэтому с вас по-прежнему будет взиматься плата.

**Удаление виртуальной машины.** Если вы удалите виртуальную машину, виртуальные жесткие диски останутся. Это означает, что вы можете удалить виртуальную машину без потери данных. Тем не менее плата за хранение по-прежнему будет взиматься. Чтобы удалить виртуальный жесткий диск, удалите соответствующий файл из [хранилища BLOB-объектов][blob-storage].

Для предотвращения случайного удаления используйте [блокировку ресурсов][resource-lock], чтобы заблокировать всю группу или отдельные ресурсы (например, виртуальную машину).

## <a name="security-considerations"></a>Вопросы безопасности

Благодаря [центру безопасности Azure][security-center] можно получить полное представление о состоянии безопасности ваших ресурсов Azure. Центр безопасности отслеживает потенциальные проблемы безопасности, а также обеспечивает полное представление о состоянии системы безопасности развертывания. Центр безопасности настраивается на уровне подписки Azure. Включите сбор данных безопасности, как описано в разделе [об использовании центра безопасности]. Когда сбор данных включен, центр безопасности автоматически проверяет все виртуальные машины, созданные для этой подписки.

**Управление исправлениями.** Если эта функция включена, то Центр безопасности проверяет, отсутствуют ли какие-либо обновления для системы безопасности и критические обновления. Установите для виртуальной машины [параметры групповой политики][group-policy], разрешающие автоматическое обновление системы.

**Защита от вредоносных программ.** Если эта функция включена, то Центр безопасности проверяет, установлена ли антивредоносное ПО. Центр безопасности позволяет также установить антивредоносное ПО с помощью портала Azure.

**Операции.** Используйте [управление доступом на основе ролей][rbac] (RBAC) для управления доступом к развертываемым ресурсам Azure. RBAC позволяет назначить роли авторизации участникам команды DevOps. Например, роль "Читатель" позволяет просматривать ресурсы Azure, но не позволяет создавать и удалять их или управлять ими. Некоторые роли относятся к определенным типам ресурсов Azure. Например, роль "Участник виртуальных машин" позволяет перезапустить виртуальную машину или отменить ее выделение, сбросить пароль администратора, создать новую виртуальную машину и т. д. Для этой архитектуры могут оказаться полезными и другие [встроенные роли RBAC][rbac-roles], например [Пользователь DevTest Labs][rbac-devtest] и [Участник сетей][rbac-network]. Пользователю можно назначить несколько ролей. Можно также создать пользовательские роли, чтобы более детально настроить разрешения.

> [!NOTE]
> RBAC не ограничивает действия, которые может выполнять пользователь, вошедший в виртуальную машину. Эти разрешения определяются типом учетной записи в гостевой ОС.   
>
>

Чтобы сбросить пароль локального администратора, выполните команду Azure CLI `vm reset-access` .

```
azure vm reset-access -u <user> -p <new-password> <resource-group> <vm-name>
```

Просматривать действия по подготовке и другие события для виртуальной машины можно с помощью [журналов аудита][audit-logs].

**Шифрование данных.** Если нужно шифровать диски ОС и диски данных, рекомендуем применить [шифрование дисков Azure][disk-encryption].

## <a name="solution-deployment"></a>Развертывание решения

Пример развертывания для этой архитектуры можно найти на портале [GitHub][github-folder]. Он содержит виртуальную сеть, NSG и одну виртуальную машину. Чтобы развернуть эту архитектуру, выполните следующие действия.

1. Щелкните правой кнопкой мыши показанную ниже кнопку и выберите пункт "Открыть ссылку в новой вкладке" или "Открыть ссылку в новом окне".  
   [![Развертывание в Azure](../articles/guidance/media/blueprints/deploybutton.png)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Freference-architectures%2Fmaster%2Fguidance-compute-single-vm%2Fazuredeploy.json)
2. Ссылка откроется на портале Azure, где нужно задать значения для следующих параметров.

   * Имя **группы ресурсов** уже определено в файле параметров, поэтому выберите **Создать** и введите `ra-single-vm-rg` в текстовом поле.
   * В раскрывающемся списке **Расположение** выберите регион.
   * Не изменяйте поля **Template Root Uri** (Корневой URI шаблона) или **Parameter Root Uri** (Корневой URI параметра).
   * В раскрывающемся списке **Тип ОС** выберите пункт **Windows**.
   * Прочтите условия использования и установите флажок **Я принимаю указанные выше условия**.
   * Нажмите кнопку **Приобрести**.
3. Дождитесь завершения развертывания.
4. В файлах параметров содержится жестко заданное имя пользователя с ролью "Администратор" и пароль. Мы настоятельно рекомендуем немедленно изменить эти параметры. Щелкните виртуальную машину с именем `ra-single-vm0 ` на портале Azure. Затем в колонке **Поддержка и устранение неполадок** щелкните **Сбросить пароль**. В раскрывающемся списке **Режим** выберите **Сбросить пароль** и введите новое **имя пользователя** и **пароль**. Нажмите кнопку **Обновить**, чтобы сохранить новое имя пользователя и пароль.

Дополнительные сведения о других методах развертывания этой эталонной архитектуры см. в файле сведений в папке [guidance-single-vm][github-folder]] на портале GitHub.

## <a name="customize-the-deployment"></a>Настройка развертывания
Если требуется изменить развертывание в соответствии со своими требованиями, выполните инструкции, приведенные в [файле сведений][github-folder].

## <a name="next-steps"></a>Дальнейшие действия
Для повышения доступности разверните две или несколько виртуальных машин за подсистемой балансировки нагрузки. Дополнительные сведения см. в статье [Running multiple VMs on Azure for scalability and availability][multi-vm] (Запуск нескольких виртуальных машин в Azure для обеспечения масштабируемости и доступности).

<!-- links -->

[audit-logs]: https://azure.microsoft.com/en-us/blog/analyze-azure-audit-logs-in-powerbi-more/
[availability-set]: ../articles/virtual-machines/virtual-machines-windows-create-availability-set.md
[azure-cli]: /cli/azure/get-started-with-az-cli2
[azure-storage]: ../articles/storage/storage-introduction.md
[blob-snapshot]: ../articles/storage/storage-blob-snapshots.md
[blob-storage]: ../articles/storage/storage-introduction.md
[boot-diagnostics]: https://azure.microsoft.com/en-us/blog/boot-diagnostics-for-virtual-machines-v2/
[cname-record]: https://en.wikipedia.org/wiki/CNAME_record
[data-disk]: ../articles/storage/storage-about-disks-and-vhds-windows.md
[disk-encryption]: ../articles/security/azure-security-disk-encryption.md
[enable-monitoring]: ../articles/monitoring-and-diagnostics/insights-how-to-use-diagnostics.md
[fqdn]: ../articles/virtual-machines/virtual-machines-windows-portal-create-fqdn.md
[github-folder]: http://github.com/mspnp/reference-architectures/tree/master/guidance-compute-single-vm
[group-policy]: https://technet.microsoft.com/en-us/library/dn595129.aspx
[log-collector]: https://azure.microsoft.com/en-us/blog/simplifying-virtual-machine-troubleshooting-using-azure-log-collector/
[manage-vm-availability]: ../articles/virtual-machines/virtual-machines-windows-manage-availability.md
[multi-vm]: ../articles/guidance/guidance-compute-multi-vm.md
[naming conventions]: ../articles/guidance/guidance-naming-conventions.md
[nsg]: ../articles/virtual-network/virtual-networks-nsg.md
[nsg-default-rules]: ../articles/virtual-network/virtual-networks-nsg.md#default-rules
[planned-maintenance]: ../articles/virtual-machines/virtual-machines-windows-planned-maintenance.md
[premium-storage]: ../articles/storage/storage-premium-storage.md
[rbac]: ../articles/active-directory/role-based-access-control-what-is.md
[rbac-roles]: ../articles/active-directory/role-based-access-built-in-roles.md
[rbac-devtest]: ../articles/active-directory/role-based-access-built-in-roles.md#devtest-labs-user
[rbac-network]: ../articles/active-directory/role-based-access-built-in-roles.md#network-contributor
[reboot-logs]: https://azure.microsoft.com/en-us/blog/viewing-vm-reboot-logs/
[resize-os-disk]: ../articles/virtual-machines/virtual-machines-windows-expand-os-disk.md
[Resize-VHD]: https://technet.microsoft.com/en-us/library/hh848535.aspx
[Resize virtual machines]: https://azure.microsoft.com/en-us/blog/resize-virtual-machines/
[resource-lock]: ../articles/resource-group-lock-resources.md
[resource-manager-overview]: ../articles/azure-resource-manager/resource-group-overview.md
[security-center]: https://azure.microsoft.com/en-us/services/security-center/
[select-vm-image]: ../articles/virtual-machines/virtual-machines-windows-cli-ps-findimage.md
[services-by-region]: https://azure.microsoft.com/en-us/regions/#services
[static-ip]: ../articles/virtual-network/virtual-networks-reserved-public-ip.md
[storage-account-limits]: ../articles/azure-subscription-service-limits.md#storage-limits
[storage-price]: https://azure.microsoft.com/pricing/details/storage/
[об использовании центра безопасности]: ../articles/security-center/security-center-get-started.md#use-security-center
[virtual-machine-sizes]: ../articles/virtual-machines/virtual-machines-windows-sizes.md
[visio-download]: http://download.microsoft.com/download/1/5/6/1569703C-0A82-4A9C-8334-F13D0DF2F472/RAs.vsdx
[vm-disk-limits]: ../articles/azure-subscription-service-limits.md#virtual-machine-disk-limits
[vm-resize]: ../articles/virtual-machines/virtual-machines-linux-change-vm-size.md
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines
[vm-size-tables]: ../articles/virtual-machines/virtual-machines-windows-sizes.md
[0]: ./media/guidance-blueprints/compute-single-vm.png "Архитектура с одной виртуальной машиной Windows в Azure"
[readme]: https://github.com/mspnp/reference-architectures/blob/master/guidance-compute-single-vm
[blocks]: https://github.com/mspnp/template-building-blocks
