# <a name="securing-docker-containers-in-azure-container-service"></a>Защита контейнеров Docker в службе контейнеров Azure

В этой статье описываются рекомендации по защите контейнеров Docker, развернутых в службе контейнеров Azure. Многие из этих рекомендаций применимы преимущественно к контейнерам Docker, развернутым в Azure или других средах. 

## <a name="image-security"></a>Безопасность образов

Контейнеры состоят из образов, которые хранятся в одном или нескольких репозиториях. Эти репозитории могут принадлежать общим или частным реестрам контейнеров. Примером общего реестра является [Docker Hub](https://hub.docker.com/). Примером частного реестра является [Docker Trusted Registry](https://docs.docker.com/datacenter/dtr/2.0/), который можно установить локально или в виртуальном частном облаке. Существуют также частные службы реестров контейнеров на основе облака, включая [реестр контейнеров Azure](../articles/container-registry/container-registry-intro.md).

### <a name="public-and-private-images"></a>Общие и частные образы
В целом, как и любой общедоступный опубликованный программный пакет, общедоступный образ контейнера не может гарантировать безопасность. Образы контейнеров состоят из нескольких программных слоев, у каждого из которых могут быть свои уязвимости. Очень важно понимать источник образа контейнера, включая владельца образа (чтобы можно было определить надежность источника), программные слои, из которых состоит этот образ, и версии программного обеспечения. 

Например, если откроете официальный [репозиторий nginx](https://hub.docker.com/_/nginx/) на Docker Hub, а затем перейдете на вкладку **Теги**, вы увидите уязвимости для каждого образа, выделенные цветом. Каждый цвет отражает уязвимость программного слоя образа. Дополнительные сведения о сканировании уязвимостей на Docker Hub см. в записи блога, посвященной [обзору официальных репозиториев на Docker Hub](https://blog.docker.com/2015/06/understanding-official-repos-docker-hub/).

![Образы Nginx на Docker Hub](./media/container-service-security/docker-hub-nginx.png)

Так как организации уделяют должное внимание безопасности, то чтобы защитить себя от рисков ее нарушения, для хранения и извлечения образов рекомендуется использовать частный реестр, например реестр контейнеров Azure или Docker Trusted Registry. Кроме предоставления управляемого частного реестра, реестр контейнеров Azure также поддерживает [проверку подлинности на основе субъекта-службы](../articles/container-registry/container-registry-authentication.md) с помощью Azure Active Directory для базовых потоков аутентификации, включая доступ на основе ролей только для чтения, записи и разрешений владельца.

### <a name="image-security-scanning"></a>Сканирование безопасности образов

Даже если вы используете частный реестр, мы советуем также использовать решения сканирования образов для дополнительной проверки безопасности. Каждый программный слой в образе контейнера потенциально подвержен уязвимостям независимо от других слоев. Так как организации стали все больше склоняться к развертыванию производственных рабочих нагрузок на основе технологий контейнеров, сканирование образов для предотвращения угроз безопасности в организации получило широкое распространение. 

Помимо прочих, такие решения мониторинга безопасности и сканирования, как [Twistlock](https://www.twistlock.com/2016/11/07/twistlock-supports-azure-container-registry) и [Aqua Security](http://blog.aquasec.com/image-vulnerability-scanning-in-azure-container-registry), можно использовать для сканирования образов контейнера в частном реестре и определения потенциальных уязвимостей. Важно понимать уровень сканирования, который обеспечивают различные решения. Например, некоторые решения могут использовать перекрестную проверку слоев образа на наличие известных уязвимостей. При этом они не смогут проверить программное обеспечение слоев образа, созданного на основе определенного программного обеспечения диспетчера пакетов. Для других решений предусмотрена более глубокая интеграция сканирования, и они могут обнаружить уязвимости в любом комплекте программного обеспечения.

### <a name="production-deployment-rules-and-audit"></a>Правила развертывания в рабочей среде и аудит
Когда приложение развернуто в рабочей среде, необходимо задать несколько правил, чтобы убедиться, что образы, используемые в рабочих средах, безопасны и не содержат уязвимостей.

* Обычно образы с уязвимостями (даже незначительными) не должны выполняться в рабочей среде. Кроме того, все образы, развернутые в рабочей среде, в идеале нужно сохранить в частном реестре, из которого их можно извлечь. Чтобы эффективно управлять рабочими образами, их количество должно быть ограничено.

* Так как из общедоступного образа контейнера сложно выявить источник программного обеспечения, рекомендуется создавать образы из источника для обеспечения уверенности в источнике слоя. Когда в автоматически созданном образе контейнера появляется уязвимость, клиенты могут достаточно быстро устранить эту проблему. Что касается общедоступного образа, клиентам понадобится найти корень этого образа, чтобы исправить его, или же получить другой безопасный образ в издателе.

* Тщательно сканированный образ, развернутый в рабочей среде, не обязательно будет обновляться в течение времени существования приложения. Вы можете получить сообщения об уязвимостях системы безопасности для слоев образа, с которыми вы не сталкивались ранее или которые были представлены после развертывания в рабочей среде. Периодический аудит образов, развернутых в рабочей среде, необходим для определения устаревших образов или образов, которые давно не обновлялись. Вы можете использовать "сине-зеленые" методы развертывания и последовательное обновление, чтобы обновлять образы контейнеров без простоя. Сканирование образа можно выполнить с помощью средств, описанных в разделе выше. 

* Конвейер непрерывной интеграции для создания образов и интегрированная проверка безопасности позволяет поддерживать защищенные частные реестры с безопасными образами контейнеров. Сканирование уязвимостей, встроенное в решение непрерывной интеграции, обеспечивает отправку прошедших все проверки образов в частный реестр, из которого развертываются производственные рабочие нагрузки. При сбое в конвейере непрерывной интеграции уязвимые образы не отправляются в частный реестр, используемый для развертываний производственных рабочих нагрузок. В случае значительного количества образов также запускается автоматическая проверка их безопасности. Выполнение аудита образов вручную для обнаружения уязвимостей системы безопасности очень долгий процесс, подверженный ошибкам.

## <a name="host-level-container-isolation"></a>Изоляция контейнера на уровне узла
Когда клиент развертывает приложения контейнера в ресурсах Azure, они развертываются в группах ресурсов на уровне подписки и не являются мультитенантными. Это значит, что если клиент предоставит доступ к подписке другим пользователям, границы между двумя развертываниями в одной подписке будут отсутствовать. Таким образом, безопасность на уровне контейнера не гарантируется. 

Также очень важно понимать, что контейнеры могут предоставлять доступ к ядру и ресурсам узла (в службе контейнеров Azure это виртуальная машина Azure в кластере). Следовательно, контейнеры, запущенные в рабочей среде, должны запускаться в непривилегированном пользовательском режиме. Запуск контейнера с привилегиями суперпользователя может привести к компрометации всей среды. Если к контейнеру предоставлен доступ на корневом уровне, злоумышленник может получить доступ ко всем привилегиям суперпользователя на узле. Кроме того, важно запускать контейнеры с файловыми системами только для чтения. Это предотвратит написание вредоносных сценариев для файловой системы и получение доступа к другим файлам пользователями, у которых есть доступ к скомпрометированному контейнеру. Точно так же важно ограничить ресурсы (память, ЦП и пропускную способность сети), выделенные контейнеру. Это поможет предотвратить захват ресурсов злоумышленниками и осуществление незаконных действий, например мошенническое использование кредитной карты, добывание биткойнов, что также предотвратит запуск других контейнеров на узле или кластере.

## <a name="orchestrator-considerations"></a>Оркестратор и вопросы безопасности

Для каждого оркестратора, доступного в службе контейнеров Azure, предусмотрены свои рекомендации по безопасности. Например, вам необходимо ограничить прямой доступ SSH к узлам оркестратора в службе контейнеров. Вместо этого следует использовать пользовательский интерфейс каждого оркестратора или средства командной строки (например, `kubectl` для Kubernetes), чтобы управлять средой контейнера без доступа к узлам. Дополнительные сведения см. в статье [Создание удаленного подключения к кластеру Kubernetes, DC/OS или Docker Swarm](../articles/container-service/kubernetes/container-service-connect.md).

Дополнительные сведения о безопасности оркестратора см. в ресурсах ниже.

* **Kubernetes**: [Security Best Practices for Kubernetes Deployment](http://blog.kubernetes.io/2016/08/security-best-practices-kubernetes-deployment.html) (Рекомендации по безопасности для развертывания Kubernetes)

* **DC/OS**: [Securing Your Cluster](https://dcos.io/docs/1.8/administration/securing-your-cluster/) (Защита кластера)

* **Docker Swarm**: [Docker Security](https://www.docker.com/docker-security) (Защита Docker)

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения об архитектуре Docker и защите контейнера см. в руководстве [Introduction to Container Security. Understanding the isolation properties of Docker](https://www.docker.com/sites/default/files/WP_IntrotoContainerSecurity_08.19.2016.pdf) (Обзор безопасности контейнеров. Свойства изоляции Docker).

* Дополнительные сведения о безопасности платформы Azure см. на странице [центра безопасности Azure](https://www.microsoft.com/en-us/trustcenter/cloudservices/azure).