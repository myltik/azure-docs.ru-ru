
# <a name="backup-and-disaster-recovery-for-azure-iaas-disks"></a>Архивация и аварийное восстановление для дисков IaaS Azure

В этой статье объясняется планирование архивации и аварийного восстановления виртуальных машин и дисков IaaS в Azure, а также рассматриваются управляемые и неуправляемые диски.

Сначала мы рассмотрим встроенные функции отказоустойчивости на платформе Azure, которые обеспечивают защиту от локальных сбоев. Затем обсудим сценарии аварийного восстановления, которые полностью не охватываются встроенными функциями восстановления. Это основная тема данной статьи. Мы также рассмотрим несколько примеров сценариев рабочих нагрузок, к которым можно применить разные рекомендации по аварийному восстановлению и созданию резервных копий. Также мы рассмотрим возможные решения для аварийного восстановления дисков IaaS. 

## <a name="introduction"></a>Введение

Платформа Azure использует различные методы для обеспечения избыточности и отказоустойчивости для защиты клиентов от локальных сбоев оборудования. Локальные сбои могут включать проблемы с компьютером сервера службы хранилища Azure, на котором размещается часть данных виртуального диска, или сбои дисков SSD или HDD на этом сервере. Такие сбои отдельных компонентов оборудования могут происходить во время обычной работы. 

Платформа Azure устойчива к этим сбоям. Серьезные аварии могут привести к сбоям или недоступности большого количества серверов хранилища или всего центра обработки данных. Хотя виртуальные машины и диски обычно защищены от локальных сбоев, необходимо предпринять дополнительные действия для защиты вашей рабочей нагрузки от сбоев на уровне региона (крупных аварий), которые могут повлиять на виртуальные машины и диски.

Кроме сбоев платформы могут возникать проблемы с приложениями или данными клиента. Например, новая версия приложения может непреднамеренно изменить данные и повредить их. В этом случае требуется восстановить приложение и данные до предыдущей работоспособной версии. Для этого необходима регулярная архивация.

Для регионального аварийного восстановления необходимо создать резервную копию дисков виртуальной машины IaaS в другом регионе. 

Прежде чем мы рассмотрим параметры резервного копирования и аварийного восстановления, вспомним несколько методов обработки локальных сбоев.

### <a name="azure-iaas-resiliency"></a>Устойчивость Azure IaaS

*Устойчивость* учитывает допустимое количество обычных сбоев, которые могут происходить в компонентах оборудования. Устойчивость представляет собой возможность восстановления после сбоев и продолжения работы. Устойчивость означает, что нужно не стараться избежать сбоев, а реагировать на них без простоя оборудования и потери данных. Назначение устойчивости состоит в том, чтобы вернуть приложение в рабочее состояние после сбоя. Виртуальные машины и диски Azure устойчивы к общим сбоям оборудования. Давайте рассмотрим, как в платформе Azure IaaS реализована эта устойчивость.

Виртуальная машина состоит в основном из двух частей: сервера вычислений и дисков для постоянного хранения данных. И то, и другое влияет на отказоустойчивость виртуальной машины.

Если на сервере вычислительного узла Azure, на котором расположена ваша виртуальная машина, произойдет сбой оборудования (что бывает редко), Azure автоматически восстановит виртуальную машину на другом сервере. В таком случае компьютер будет перезагружен, и виртуальная машина восстановится через некоторое время. Azure автоматически обнаруживает такие сбои оборудования и выполняет операции восстановления, чтобы виртуальная машина клиента стала доступной как можно быстрее.

Что касается дисков IaaS, устойчивость данных имеет важнейшее значение для платформы постоянного хранения данных. У клиентов Azure есть важные бизнес-приложения, которые работают в IaaS и зависят от сохраняемости этих данных. Azure обеспечивает защиту этих дисков IaaS, создавая три избыточные локальные копии данных, сохраненные в локальной среде. Эти копии обеспечивают надежную защиту от локальных сбоев. Сбой одного из компонентов оборудования, на котором расположен ваш диск, не затронет виртуальную машину, так как существуют две дополнительных копии для поддержки запросов к диску. Такая защита прекрасно работает даже в случае одновременного сбоя двух различных компонентов оборудования (что бывает очень редко). 

Чтобы гарантировать постоянное наличие трех реплик, служба хранилища Azure автоматически создает копию данных в фоновом режиме, если одна из трех копий становится недоступной. Поэтому использовать RAID с дисками Azure для обеспечения отказоустойчивости необязательно. Если необходимо создать тома большего размера, достаточно простой конфигурации RAID 0 для чередования дисков.

Благодаря этой архитектуре Azure удалось гарантировать надежность корпоративного уровня дисков IaaS с ведущим в отрасли нулевым показателем [процента сбоев в течение года](https://en.wikipedia.org/wiki/Annualized_failure_rate).

Локальные сбои оборудования на вычислительном узле или платформе хранения иногда могут приводить к временной недоступности виртуальной машины. Этот вопрос рассматривается в [соглашении об уровне обслуживания Azure](https://azure.microsoft.com/support/legal/sla/virtual-machines/) для доступности виртуальных машин. Azure также предоставляет ведущее в отрасли Соглашение об уровне обслуживания для отдельных экземпляров виртуальных машин, в которых используются диски хранилища Azure класса Premium.

Чтобы защитить рабочие нагрузки приложений от простоев из-за временной недоступности диска или виртуальной машины, клиенты могут использовать [группы доступности](../articles/virtual-machines/windows/manage-availability.md). Две или более виртуальных машин в группе доступности обеспечивают избыточность для приложения. Azure создает эти виртуальные машины и диски в отдельных доменах сбоя с различными компонентами питания, сетевыми компонентами и серверными компонентами. 

Из-за этих отдельных доменов сбоя локальные сбои оборудования обычно не влияют на несколько виртуальных машин в группе доступности одновременно, что позволяет обеспечить высокий уровень доступности для приложения. Мы рекомендуем использовать группы доступности, когда требуется высокая доступность. В следующем разделе рассматривается аварийное восстановление.

### <a name="backup-and-disaster-recovery"></a>Резервное копирование и аварийное восстановление

Аварийное восстановление обеспечивает восстановление после серьезных сбоев, которые случаются редко. Сюда можно отнести не исчезающие самостоятельно широкомасштабные сбои, такие как прерывание обслуживания, которое влияет на весь регион. Аварийное восстановление включает резервное копирование данных и архивацию и может включать ручное вмешательство, например восстановление базы данных из резервной копии.

Встроенная защита платформы Azure от локальных сбоев может не полностью защищать виртуальные машины или диски в случае серьезных сбоев, которые могут привести к обширному простою в работе. Такие сбои включают катастрофические события, например повреждение центра обработки данных вследствие урагана, землетрясения, пожара или крупномасштабные сбои оборудования. Кроме того, могут возникать сбои из-за проблем, связанных с данными или приложениями.

Для защиты рабочих нагрузок IaaS от сбоев необходимо запланировать избыточность и создание резервных копий. Для аварийного восстановления следует создать резервные копии в других географических регионах, отдаленных от основного сайта. Это гарантия того, что на резервную копию не повлияет то же событие, которое повлияло на виртуальные машины или диски. Дополнительные сведения см. в статье [Аварийное восстановление для приложений на платформе Azure](/azure/architecture/resiliency/disaster-recovery-azure-applications).

При планировании аварийного восстановления учитываются следующие аспекты:

- Высокий уровень доступности. Это способность приложения продолжать работу и находиться в работоспособном состоянии без значительного увеличения времени простоя. Под *работоспособным состоянием* мы подразумеваем возможность приложения реагировать на запросы, а также возможность пользователей подключиться к приложению и взаимодействовать с ним. Для некоторых критически важных приложений и баз данных может потребоваться постоянная доступность, даже при возникновении сбоев на платформе. Для этих рабочих нагрузок необходимо планировать избыточность приложения и данных.

- Устойчивость данных. В некоторых случаях главное сохранить данные в случае сбоя. Поэтому может потребоваться создание резервной копии данных на другом сайте. Для таких рабочих нагрузок может потребоваться не полная избыточность приложения, а регулярная архивация дисков.

## <a name="backup-and-dr-scenarios"></a>Сценарии резервного копирования и аварийного восстановления

Рассмотрим несколько типичных примеров сценариев рабочих нагрузок приложения, а также некоторые рекомендации по планированию аварийного восстановления.

### <a name="scenario-1-major-database-solutions"></a>Сценарий 1. Решения для крупных баз данных

Рассмотрим рабочий сервер базы данных, например SQL Server или Oracle, поддерживающий высокий уровень доступности. От этой базы данных зависят критически важные рабочие приложения и пользователи. План аварийного восстановления для этой системы должен удовлетворять следующим требованиям:

- Данные должны быть защищены и иметь возможность восстановления.
- Сервер должен быть доступен для использования.

Для этого плана может потребоваться поддержание реплики базы данных в регионе, отличном от того региона, в котором находится резервная копия. В зависимости от требований к доступности сервера и восстановлению данных решение может включать узел реплики в режиме "активный — активный" или "активный — пассивный" для периодического автономного резервного копирования данных. Реляционные базы данных, такие как SQL Server и Oracle, предоставляют различные варианты репликации. Для обеспечения высокого уровня доступности в SQL Server используйте [группы доступности Always On (SQL Server)](https://msdn.microsoft.com/library/hh510230.aspx).

Для обеспечения избыточности в базах данных NoSQL, таких как MongoDB, также поддерживаются [реплики](https://docs.mongodb.com/manual/replication/). Реплики используются для обеспечения высокого уровня доступности.

### <a name="scenario-2-a-cluster-of-redundant-vms"></a>Сценарий 2. Кластер избыточных виртуальных машин

Рассмотрим рабочую нагрузку, поддерживаемую кластером виртуальных машин, который обеспечивает избыточность и балансировку нагрузки. В качестве примера такой нагрузки можно рассмотреть кластер Cassandra, развернутый в регионе. Этот тип архитектуры уже обеспечивает высокий уровень избыточности в этом регионе. Тем не менее для защиты рабочей нагрузки от регионального сбоя следует распределить кластер по двум регионам или выполнять периодическое резервное копирование в другой регион.

### <a name="scenario-3-iaas-application-workload"></a>Сценарий 3. Рабочая нагрузка приложения IaaS

Рассмотрим рабочую нагрузку приложения IaaS. К такой рабочей нагрузке можно отнести обычную рабочую нагрузку, запущенную на виртуальной машине Azure. Это может быть веб-сервер или файловый сервер, на котором расположены содержимое и другие ресурсы сайта. Это также может быть пользовательское бизнес-приложение, запущенное на виртуальной машине. Данные, ресурсы и состояние приложения хранятся на дисках виртуальной машины. В этом случае важно регулярно создавать резервные копии. Интервал архивации зависит от характера рабочей нагрузки на виртуальной машине. Например, если приложение запускается каждый день и изменяет данные, то архивацию следует выполнять каждый час.

Еще один пример — сервер отчетов, который извлекает данные из других источников и создает статистические отчеты. Потеря этой виртуальной машины или дисков приведет к потере отчетов. Однако можно повторно запустить процесс создания отчетов и сформировать отчеты заново. В этом случае при сбое сервера отчетов потери данных не произойдет. Поэтому можно обеспечить более высокий уровень устойчивости к потере части данных на сервере отчетов. В этом случае можно снизить частоту резервного копирования, чтобы уменьшить расходы.

### <a name="scenario-4-iaas-application-data-issues"></a>Сценарий 4. Проблемы с данными для приложения IaaS

В случае проблем с данными для приложения IaaS стоит рассмотреть другие возможности. Рассмотрим приложение, которое вычисляет, хранит и обслуживает критически важные коммерческие данные, такие как сведения о ценах. В новой версии приложения была допущена ошибка в программном обеспечении, из-за которой цены были вычислены неправильно и существующие коммерческие данные платформы были повреждены. Оптимальным вариантом действий в таком случае является возврат к более ранней версии приложения и данных. Чтобы этот вариант стал возможным, включите периодическую архивацию системы.

## <a name="disaster-recovery-solution-azure-backup"></a>Решение для аварийного восстановления: Microsoft Azure Backup 

[Microsoft Azure Backup](https://azure.microsoft.com/services/backup/) используется для архивации и аварийного восстановления. Она работает с [управляемыми](../articles/virtual-machines/windows/managed-disks-overview.md) и [неуправляемыми дисками](../articles/virtual-machines/windows/about-disks-and-vhds.md#unmanaged-disks). Вы можете создавать задания архивации с учетом времени, легко восстанавливать виртуальные машины и использовать политики хранения архивов. 

Если вы используете [диски хранилища класса Premium](../articles/virtual-machines/windows/premium-storage.md), [управляемые диски](../articles/virtual-machines/windows/managed-disks-overview.md) или другие типы дисков с [локально избыточном хранилищем](../articles/storage/common/storage-redundancy-lrs.md), особенно важно периодически создавать резервные копии. Microsoft Azure Backup обеспечивает долговременное хранение данных в хранилище служб восстановления. Выберите вариант [геоизбыточное хранилище](../articles/storage/common/storage-redundancy-grs.md) для хранилища архивации служб восстановления. Таким образом резервное копирование будет выполняться в другой регион Azure, что позволит обеспечить защиту от региональных сбоев.

Для [неуправляемых дисков](../articles/virtual-machines/windows/about-disks-and-vhds.md#unmanaged-disks) можно использовать локально избыточное хранилище для дисков IaaS, но для хранилищ служб восстановления необходимо обязательно включить службу Microsoft Azure Backup с параметром "геоизбыточное хранилище".

> [!NOTE]
> Если вы используете вариант [геоизбыточное хранилище](../articles/storage/common/storage-redundancy-grs.md) или [геоизбыточное хранилище с доступом на чтение](../articles/storage/common/storage-redundancy-grs.md#read-access-geo-redundant-storage) для неуправляемых дисков, вам все равно потребуются согласованные моментальные снимки для архивации и аварийного восстановления. Используйте [Microsoft Azure Backup](https://azure.microsoft.com/services/backup/) или [согласованные моментальные снимки](#alternative-solution-consistent-snapshots).

 В таблице ниже приведены решения, доступные для аварийного восстановления.

| Сценарий | Автоматическая репликация | Решение аварийного восстановления |
| --- | --- | --- |
| Диски хранилища класса Premium | Локальная ([локально избыточное хранилище](../articles/storage/common/storage-redundancy-lrs.md)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/) |
| Управляемые диски | Локальная ([локально избыточное хранилище](../articles/storage/common/storage-redundancy-lrs.md)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/) |
| Неуправляемые диски локально избыточного хранилища | Локальная ([локально избыточное хранилище](../articles/storage/common/storage-redundancy-lrs.md)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/) |
| Неуправляемые диски геоизбыточного хранилища | Межрегиональная ([геоизбыточное хранилище](../articles/storage/common/storage-redundancy-grs.md)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/)<br/>[Согласованные моментальные снимки](#alternative-solution-consistent-snapshots) |
| Неуправляемые диски геоизбыточного хранилища с доступом на чтение | Межрегиональная ([геоизбыточное хранилище с доступом на чтение](../articles/storage/common/storage-redundancy-grs.md#read-access-geo-redundant-storage)) | [Служба архивации Azure](https://azure.microsoft.com/services/backup/)<br/>[Согласованные моментальные снимки](#alternative-solution-consistent-snapshots) |

Для обеспечения высокого уровня доступности можно использовать управляемые диски в группе доступности со службой Microsoft Azure Backup. Для неуправляемых дисков вы по-прежнему можете использовать службу Microsoft Azure Backup для аварийного восстановления. Если вы не можете использовать службу Microsoft Azure Backup, создайте [согласованные моментальные снимки](#alternative-solution-consistent-snapshots), как описано в следующем разделе. Моментальные снимки представляют собой альтернативное решение для архивации и аварийного восстановления.

Выбранные параметры высокой доступности, архивации и аварийного восстановления на уровне приложения или инфраструктуры можно представить следующим образом:

| Уровень |   высокую доступность;   | Резервное копирование или аварийное восстановление |
| --- | --- | --- |
| Приложение | SQL Server AlwaysOn | Служба архивации Azure |
| Инфраструктура    | Группа доступности  | Геоизбыточное хранилище с согласованными моментальными снимками |

### <a name="using-azure-backup"></a>Использование Microsoft Azure Backup 

[Microsoft Azure Backup](../articles/backup/backup-azure-vms-introduction.md) может выполнять архивацию виртуальных машин под управлением Windows или Linux в хранилище служб восстановления Azure. Архивация и восстановление критически важных для бизнеса данных осложняются тем, что архивация этих данных должна выполняться во время работы приложений, которые создают эти данные. 

Для решения этой проблемы Microsoft Azure Backup обеспечивает целостность на уровне приложений во время архивации рабочих нагрузок Майкрософт. Она использует службу теневого копирования томов, чтобы обеспечить правильную запись данных в хранилище. Для виртуальных машин Linux архивация возможна только при поддержании целостности файлов, так как в Linux не существует аналога службы теневого копирования томов.

![Поток в службе Microsoft Azure Backup][1]

Когда служба архивации Azure по установленному расписанию запускает задание архивации, расширение архивации, установленное на виртуальной машине, создает снимок текущего состояния. Этот процесс координируется со службой теневого копирования томов, что позволяет создать согласованный снимок дисков виртуальной машины без остановки ее работы. Перед созданием моментального снимка всех дисков расширение архивации на виртуальной машине очищает все операции записи. После создания моментального снимка Microsoft Azure Backup передает данные в резервное хранилище. Служба анализирует блоки данных и передает только те блоки, которые были изменены с момента предыдущего резервного копирования. Это позволяет повысить эффективность процесса резервного копирования.

Для восстановления можно просмотреть доступные резервные копии Azure с помощью службы архивации Azure и затем запустить восстановление. Вы можете создать и восстановить резервные копии в Azure с помощью [портала Azure](https://portal.azure.com/), [PowerShell](../articles/backup/backup-azure-vms-automation.md) или [интерфейса командной строки Azure](/cli/azure/). 

### <a name="steps-to-enable-a-backup"></a>Действия для включения архивации

Для включения архивации виртуальных машин на [портале Azure](https://portal.azure.com/) обычно используются действия, приведенные ниже. Возможны некоторые различия, обусловленные сценарием. Полные сведения см. в документации по [службе архивации Azure](../articles/backup/backup-azure-vms-introduction.md). Microsoft Azure Backup также [поддерживает виртуальные машины с управляемыми дисками](https://azure.microsoft.com/blog/azure-managed-disk-backup/).

1.  Создание хранилища служб восстановления для виртуальной машины

    a. На [портале Azure](https://portal.azure.com/) найдите **все ресурсы**. Затем найдите **Хранилища служб восстановления**.

    Б. В меню **Хранилища служб восстановления** щелкните **Добавить** и создайте новое хранилище в том же регионе, в котором расположена виртуальная машина. Например, если ваша виртуальная машина находится в регионе "Западная часть США", выберите "Западная часть США" при создании хранилища.

2.  Проверьте репликацию хранилища для созданного хранилища. Выберите хранилище в меню **Хранилища служб восстановления**, а затем — **Параметры** > **Резервная конфигурация**. По умолчанию должен быть выбран вариант **геоизбыточное хранилище**. Это позволит гарантировать, что ваше хранилище будет автоматически реплицировано в дополнительный центр обработки данных. Например, хранилище в регионе "Западная часть США" будет автоматически реплицировано в регион "Восточная часть США".

3.  Настройте политику архивации и выберите виртуальную машину в том же разделе.

4.  Убедитесь, что агент архивации установлен на виртуальной машине. Если виртуальная машина создается с помощью образа из коллекции образов Azure, то агент Microsoft Azure Backup уже установлен. В противном случае (для пользовательских образов) выполните действия, описанные в разделе по [установке агента виртуальной машины на виртуальной машине](../articles/backup/backup-azure-arm-vms-prepare.md#install-the-vm-agent-on-the-virtual-machine).

5.  Убедитесь, что виртуальная машина разрешает сетевые подключения к службе архивации. Для настройки сетевого подключения выполните действия, описанные в [этом разделе](../articles/backup/backup-azure-arm-vms-prepare.md#establish-network-connectivity).

6.  После завершения всех указанных выше действий архивация будет выполняться с регулярными интервалами, указанными в политике архивации. При необходимости можно запустить первую операцию архивации вручную на панели мониторинга хранилища на портале Azure.

Для автоматизации службы Microsoft Azure Backup с помощью скриптов ознакомьтесь со статьей [Архивация виртуальных машин с помощью командлетов AzureRM.RecoveryServices.Backup](../articles/backup/backup-azure-vms-automation.md).

### <a name="steps-for-recovery"></a>Действия для восстановления

Если вам нужно восстановить или повторно создать виртуальную машину, вы можете восстановить ее из любой сохраненной точки восстановления в хранилище. Существует несколько различных вариантов восстановления:

-   Вы можете создать новую виртуальную машину, которая будет представлять собой архивированную виртуальную машину в определенный момент времени.

-   Вы можете восстановить диски, настроить и повторно создать восстановленную виртуальную машину с помощью шаблона для виртуальной машины. 

Дополнительные сведения см. в разделе об [использовании портала Azure для восстановления виртуальных машин](../articles/backup/backup-azure-arm-restore-vms.md). В этой статье также приведены конкретные действия для восстановления архивированных виртуальных машин в сопряженном центре обработки данных с помощью геоизбыточного резервного хранилища в случае сбоя в основном центре обработки данных. В этом случае служба архивации Azure использует службы вычислений из дополнительного региона для создания восстановленной виртуальной машины.

Вы также можете [восстановить виртуальную машину](../articles/backup/backup-azure-arm-restore-vms.md#restore-a-vm-during-an-azure-datacenter-disaster) с помощью PowerShell или [создать новую виртуальную машину из восстановленных дисков](../articles/backup/backup-azure-vms-automation.md#create-a-vm-from-restored-disks).

## <a name="alternative-solution-consistent-snapshots"></a>Альтернативное решение: согласованные моментальные снимки

Если вы не можете использовать службу Microsoft Azure Backup, можно реализовать собственный механизм резервного копирования с использованием моментальных снимков. Создавать согласованные моментальные снимки для всех дисков, используемых виртуальной машиной, а затем реплицировать их в другой регион достаточно сложно. Поэтому служба Microsoft Azure Backup считается более предпочтительным вариантом по сравнению с созданием пользовательского решения. 

При использовании геоизбыточного хранилища с доступом на чтение (RA-GRS) или геоизбыточного хранилища (GRS) для дисков моментальные снимки автоматически реплицируются в дополнительный центр обработки данных. Если для дисков используется локально избыточное хранилище, необходимо реплицировать данные самостоятельно. Дополнительные сведения см. в статье [Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков](../articles/virtual-machines/windows/incremental-snapshots.md).

Моментальный снимок — это представление объекта в определенный момент времени. При создании моментального снимка выполняется тарификация для добавочного размера данных, которые он содержит. Дополнительные сведения см. в разделе [Создание моментального снимка BLOB-объекта](../articles/storage/blobs/storage-blob-snapshots.md).

### <a name="create-snapshots-while-the-vm-is-running"></a>Создание моментальных снимков во время работы виртуальной машины

Хотя моментальный снимок можно создать в любое время, если виртуальная машина запущена, то в момент создания снимка данные все еще передаются на диски, поэтому моментальные снимки могут содержать результаты частично выполненных операций. Кроме того, если используется несколько дисков, то моментальные снимки для различных дисков могут создаваться в различные моменты времени, то есть эти моментальные снимки могут быть не согласованы. Это представляет особенную сложность для томов с чередованием, файлы на которых могут быть повреждены, если в ходе архивации данные были изменены.

Чтобы избежать этой ситуации, в процессе архивации необходимо выполнить следующие действия:

1.  Заморозить все диски.

2.  Очистить все ожидающие операции записи.

3.  [Создать моментальный снимок большого двоичного объекта](../articles/storage/blobs/storage-blob-snapshots.md) для всех дисков.

Некоторые приложения Windows, такие как SQL Server, предоставляют координированный механизм архивации с использованием службы теневого копирования томов для создания архивов с обеспечением согласованности приложений. В Linux для координации дисков можно использовать такие средства, как fsfreeze. Это позволит создать архивы с обеспечением согласованности файлов, но не моментальные снимки с обеспечением согласованности приложений. Этот процесс весьма сложен, поэтому следует использовать [службу Microsoft Azure Backup](../articles/backup/backup-azure-vms-introduction.md) или стороннее решение архивации, в котором уже реализован этот механизм.

Описанный выше процесс приведет к созданию коллекции скоординированных моментальных снимков для всех дисков виртуальной машины, которые представляют состояние виртуальной машины в определенный момент времени. Это точка восстановления архива для виртуальной машины. Процесс можно повторить через запланированные промежутки времени, чтобы создать периодические архивы. Ознакомьтесь с [этим](#copy-the-snapshots-to-another-region) разделом, чтобы копировать моментальные снимки в другой регион для аварийного восстановления.

### <a name="create-snapshots-while-the-vm-is-offline"></a>Создание моментальных снимков, когда виртуальная машина находится в автономном режиме

Другой вариант создания согласованных моментальных снимков — выключить виртуальную машину и создать моментальные снимки большого двоичного объекта для каждого диска. Этот вариант проще, чем создание координированных моментальных снимков работающей виртуальной машины, но для его выполнения потребуется несколько минут простоя.

1. Выключите виртуальную машину.

2. Создайте моментальный снимок большого двоичного объекта для каждого виртуального жесткого диска. Это займет всего несколько секунд.

    Для создания моментального снимка можно использовать [PowerShell](../articles/storage/common/storage-powershell-guide-full.md), [API REST службы хранилища Azure](https://msdn.microsoft.com/library/azure/ee691971.aspx), [интерфейс командной строки Azure](/cli/azure/) или одну из клиентских библиотек службы хранилища Azure, например [клиентскую библиотеку хранилища для .NET](https://msdn.microsoft.com/library/azure/hh488361.aspx).

3. Запустите виртуальную машину. После запуска виртуальной машины время простоя будет завершено. На выполнение всего процесса обычно требуется несколько минут.

Этот процесс создает коллекцию согласованных моментальных снимков для всех дисков и в результате позволяет получить точку восстановления архива для виртуальной машины.

### <a name="copy-the-snapshots-to-another-region"></a>Копирование моментальных снимков в другой регион

Для аварийного восстановления может быть недостаточно создать только моментальные снимки. Также может потребоваться реплицировать резервные копии моментальных снимков в другой регион.

Если вы используете для дисков геоизбыточное хранилище с доступом на чтение или геоизбыточное хранилище, моментальные снимки автоматически будут реплицированы в дополнительный регион. Перед репликацией возможна задержка в несколько минут, и если в основном центре обработки данных произойдет сбой до того, как репликация моментальных снимков будет завершена, доступ к моментальным снимкам из дополнительного центра обработки данных будет невозможен. Вероятность такого события очень мала.

> [!NOTE] 
> Размещение дисков в учетной записи геоизбыточного хранилища (GRS) или геоизбыточного хранилища с доступом на чтение (RA-GRS) не защищает виртуальную машину от сбоев. Также необходимо создать скоординированные моментальные снимки или использовать службу архивации Azure. Это необходимо для восстановления согласованного состояния виртуальной машины.

При использовании локально избыточного хранилища необходимо скопировать моментальные снимки в другую учетную запись хранения сразу после создания моментального снимка. В качестве места назначения можно выбрать учетную запись хранения локально избыточного хранилища в другом регионе. В этом случае копия окажется в удаленном регионе. Также можно скопировать моментальный снимок в учетную запись хранения геоизбыточного хранилища с доступом на чтение в том же регионе. В этом случае моментальный снимок будет неактивно реплицирован в удаленный дополнительный регион. После завершения копирования и репликации архив защищен от сбоев на основном сайте.

Для эффективного копирования добавочных моментальных снимков для аварийного восстановления ознакомьтесь с инструкциями, приведенными в разделе [Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков](../articles/virtual-machines/windows/incremental-snapshots.md).

![Архивация неуправляемых дисков виртуальной машины Azure с помощью добавочных моментальных снимков][2]

### <a name="recovery-from-snapshots"></a>Восстановление из моментальных снимков

Для получения моментального снимка скопируйте его, чтобы создать новый BLOB-объект. При копировании моментального снимка из основной учетной записи можно перезаписать базовый большой двоичный объект моментального снимка. Таким образом диск будет возвращен к состоянию моментального снимка. Это называется повышением уровня моментального снимка. При копировании резервной копии моментального снимка из дополнительной учетной записи хранения (для RA-GRS) этот снимок необходимо скопировать в основную учетную запись. Для копирования моментального снимка можно использовать [PowerShell](../articles/storage/common/storage-powershell-guide-full.md) или служебную программу AzCopy. Дополнительные сведения см. в статье [Перенос данных с помощью AzCopy для Windows](https://docs.microsoft.com/azure/storage/common/storage-use-azcopy).

В случае виртуальных машин с несколькими дисками необходимо скопировать все моментальные снимки, которые являются частью одной и той же скоординированной точки восстановления. После копирования моментальных снимков для записываемых больших двоичных объектов виртуальных жестких дисков можно использовать эти объекты для повторного создания виртуальной машины с помощью шаблона виртуальной машины.

## <a name="other-options"></a>Другие варианты

### <a name="sql-server"></a>SQL Server;

SQL Server, запущенный на виртуальной машине, имеет собственные встроенные функции для архивации базы данных SQL Server в хранилище BLOB-объектов Azure или в общую папку. Если учетная запись хранения имеет тип GRS (геоизбыточное хранилище) или RA-GRS (геоизбыточное хранилище с доступом на чтение), то в случае сбоя вы сможете получить доступ к этим архивам в учетной записи хранения дополнительного центра обработки данных с теми же ограничениями, которые были описаны выше. Дополнительные сведения см. в статье [Резервное копирование и восстановление SQL Server в виртуальных машинах Azure](../articles/virtual-machines/windows/sql/virtual-machines-windows-sql-backup-recovery.md). Кроме резервного копирования и восстановления, [группы доступности SQL Server AlwaysOn](../articles/virtual-machines/windows/sql/virtual-machines-windows-sql-high-availability-dr.md) поддерживают вторичные реплики баз данных, что позволяет существенно сократить время восстановления после сбоя.

## <a name="other-considerations"></a>Дополнительные рекомендации

В этой статье описывается, как создать резервные копии или моментальные снимки виртуальной машины или дисков виртуальной машины для аварийного восстановления, а также как использовать их для восстановления данных. С моделью Azure Resource Manager многие пользователи создают виртуальные машины и другие компоненты инфраструктуры Azure с помощью шаблонов. С помощью шаблона вы сможете создавать виртуальные машины с заранее известной одинаковой конфигурацией. При создании виртуальных машин с помощью пользовательских образов необходимо также защитить эти образы с помощью учетной записи хранения RA-GRS.

Следовательно, процесс архивации представляет собой сочетание двух вещей:

- резервного копирования данных (дисков);
- резервного копирования конфигурации (шаблонов и пользовательских образов).

В зависимости от выбранного варианта архивации вам придется выполнять архивацию данных и конфигурации самостоятельно или воспользоваться службой архивации, которая сделает это за вас.

## <a name="appendix-understanding-the-impact-of-data-redundancy"></a>Приложение. Влияние избыточности данных

Для учетных записей хранения Azure существует три типа обеспечения избыточности данных, которые следует использовать при планировании аварийного восстановления: локально избыточное хранилище, геоизбыточное хранилище и геоизбыточное хранилище с доступом на чтение. 

Локально избыточное хранилище сохраняет три копии данных в одном центре обработки данных. При записи данных виртуальной машиной обновляются все три копии, и только после этого вызывающему объекту отправляется уведомление о том, что запись завершена успешно. Это позволяет гарантировать, что все три копии совпадают. Ваш диск защищен от локальных сбоев, так как повреждение всех трех копий в один момент времени крайне маловероятно. В случае использования локально избыточного хранилища отсутствует географическая избыточность, поэтому диск не защищен от катастрофических сбоев, которые могут повлиять на весь центр обработки данных или единицу хранения.

В случае использования геоизбыточного хранилища и геоизбыточного хранилища с доступом на чтение три копии данных сохраняются в основном регионе, выбранном вами, и еще три копии данных сохраняются в соответствующем дополнительном регионе, выбранном Azure. Например, если вы храните данные в регионе "Западная часть США", то данные будут реплицироваться в регион "Восточная часть США". Это происходит в асинхронном режиме, и существует небольшая задержка между обновлением основного и дополнительного регионов. Реплики дисков на вторичном сайте являются согласованными на уровне диска (с задержкой), но реплики нескольких активных дисков могут быть не синхронизированы между собой. Для получения согласованных реплик на нескольких дисках необходимо использовать моментальные снимки.

Основное различие между GRS и RA-GRS заключается в том, что в RA-GRS вы можете в любое время прочесть дополнительную копию. При наличии проблемы, которая не позволяет получить данные в основном регионе, команда Azure сделает все возможное для восстановления доступа. Если включено геоизбыточное хранилище с доступом на чтение, то во время сбоя основного региона вы сможете обращаться к данным в дополнительном центре обработки данных. Таким образом, если вам необходимо прочесть данные реплики, пока основной регион недоступен, следует использовать это хранилище.

Если сбой окажется серьезным, команда Azure может запустить географическую отработку отказа и изменить адреса DNS-серверов в основном регионе, так чтобы они указывали на хранилище в дополнительном регионе. В этом случае, если включено геоизбыточное хранилище или геоизбыточное хранилище с доступом на чтение, вы сможете получить доступ к данным в дополнительном регионе. Другими словами, если вы используете учетную запись хранения в геоизбыточном хранилище с доступом на чтение, то при возникновении проблемы вы сможете обратиться к хранилищу в дополнительном регионе только при географической отработке отказа.

Дополнительные сведения см. в разделе [Что делать в случае сбоя службы хранилища Azure](../articles/storage/common/storage-disaster-recovery-guidance.md). 

>[!NOTE] 
>Отработкой отказа управляет Майкрософт. Отработка отказа не контролируется на уровне отдельных учетных записей, поэтому она не может быть запущена по запросу отдельных клиентов. Для реализации аварийного восстановления для конкретных учетных записей хранения или дисков виртуальной машины необходимо использовать методики, описанные выше в этой статье.



[1]: ./media/virtual-machines-common-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-1.png
[2]: ./media/virtual-machines-common-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-2.png
