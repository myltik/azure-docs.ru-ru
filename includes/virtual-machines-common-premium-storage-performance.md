# <a name="azure-premium-storage-design-for-high-performance"></a>Хранилище Azure класса «Премиум»: разработка, обеспечивающая повышенную производительность

В этой статье приведены рекомендации по разработке высокопроизводительных приложений с использованием хранилища Azure класса «Премиум». Указания в этом документе можно использовать вместе с рекомендациями по производительности, применимыми к технологиям, которые используются приложением. Чтобы продемонстрировать упомянутые рекомендации, в этом документе в качестве примера использован SQL Server, запущенный в хранилище класса «Премиум».

Хотя в этой статье приведены сценарии повышения производительности для уровня хранилища, вам нужно будет оптимизировать уровень приложения. Например, при размещении фермы SharePoint в хранилище Azure класса «Премиум» для оптимизации работы сервера базы данных можно использовать примеры для SQL Server из этой статьи. Кроме того, для получения лучшей производительности можно также оптимизировать веб-сервер и сервер приложений фермы SharePoint.

В этой статье содержатся ответы на следующие распространенные вопросы об оптимизации производительности приложений в хранилище Azure класса «Премиум».

* Как измерить производительность приложения?  
* Почему не наблюдается ожидаемая высокая производительность?  
* Какие факторы влияют на производительность приложения в хранилище класса «Премиум»?  
* Как эти факторы влияют на производительность приложения в хранилище класса «Премиум»?  
* Как можно оптимизировать операции ввода-вывода, пропускную способность и задержку?  

Рекомендации в этой статье предназначены специально для хранилища класса «Премиум», так как рабочие нагрузки в этом хранилище очень чувствительны к уровню производительности. В соответствующих случаях приведены наглядные примеры. Некоторые из этих рекомендаций можно также применять к приложениям, выполняющимся в виртуальных машинах IaaS с использованием дисков хранилища класса «Стандартный».

Если вы не знакомы с хранилищем уровня "Премиум", перед началом работы ознакомьтесь со статьями [Высокопроизводительное хранилище класса Premium, а также неуправляемые и управляемые диски виртуальной машины Azure](../articles/virtual-machines/windows/premium-storage.md) и [Целевые показатели масштабируемости и производительности службы хранилища Azure](../articles/storage/common/storage-scalability-targets.md).

## <a name="application-performance-indicators"></a>Показатели производительности приложения
Оценка производительности приложения выполняется на основе определенных показателей, например скорость обработки запросов пользователя приложением, объем данных, обрабатываемых приложением для каждого запроса, количество запросов, обрабатываемых приложением в определенный период времени, а также период времени от отправки запроса и до получения ответа. Технически эти показатели производительности называются так: количество операций ввода-вывода в секунду, пропускная способность и задержка.

В этом разделе рассматриваются общие показатели производительности в контексте хранилища класса «Премиум». В следующем разделе («Сбор требований к производительности приложения») описывается, как измерить эти показатели производительности для приложения. Далее в разделе «Оптимизация производительности приложения» рассказывается о факторах, влияющих на эти показатели производительности, и рекомендациях по их оптимизации.

## <a name="iops"></a>ОПЕРАЦИЙ ВВОДА-ВЫВОДА
Количество операций ввода-вывода в секунду — это количество запросов, которые приложение отправляет на диски хранилища в секунду. Существуют такие типы операций ввода-вывода: операции чтения и записи, последовательные или случайные. Приложениям OLTP, таким как веб-сайт розничной торговли, необходимо обрабатывать множество одновременных запросов пользователей сразу. Запросы пользователя представляют собой ресурсоемкие транзакции вставки и обновления в базе данных, требующие быстрой обработки. Поэтому приложениям OLTP необходима очень высокая скорость выполнения операций ввода-вывода. Такие приложения обрабатывают миллионы небольших случайных запросов ввода-вывода. Для такого приложения следует разрабатывать инфраструктуру с учетом оптимизации операций ввода-вывода. В разделе *Оптимизация производительности приложения*подробно рассматриваются все факторы, которые необходимо учитывать для получения высокой скорости выполнения операций ввода-вывода.

При подключении диска хранилища класса «Премиум» к высокомасштабируемой виртуальной машине Azure выполняет подготовку гарантированного количества операций ввода-вывода в секунду в соответствии со спецификацией диска. Например, диск P50 позволяет подготовить 7500 операций ввода-вывода в секунду. Для каждого размера высокомасштабируемой виртуальной машины также установлено ограничение на количество выполняемых операций ввода-вывода в секунду. Например, для виртуальной машины серии GS5 класса «Стандартный» установлено ограничение в 80 000 операций ввода-вывода в секунду.

## <a name="throughput"></a>Throughput
Пропускная способность представляет собой объем данных, которые приложение отправляет на диски хранилища в течение заданного интервала. Если приложение выполняет операции ввода-вывода большого объема, ему требуется высокая пропускная способность. Приложения хранилища данных зачастую выдают операции с активным сканированием, которые получают доступ к данным большого объема за раз, и часто выполняют массовые операции. Поэтому таким приложениям требуется более высокая пропускная способность. Для такого приложения необходимо разрабатывать инфраструктуру с учетом оптимизации пропускной способности. В следующем разделе подробно рассмотрены показатели, которые необходимо настроить, чтобы достичь этой цели.

При подключении диска хранилища класса «Премиум» к высокомасштабируемой виртуальной машине Azure выполняет подготовку пропускной способности согласно спецификации диска. Например, диск P50 позволяет подготовить пропускную способность диска в 250 МБ в секунду. Каждая высокомасштабируемая виртуальная машина имеет установленное ограничение по пропускной способности. Например, максимальная пропускная способность виртуальной машины серии GS5 класса «Стандартный» составляет 2000 МБ в секунду. 

Между пропускной способностью и количеством операций ввода-вывода в секунду существует связь, как показано в следующей формуле.

![](media/premium-storage-performance/image1.png)

Поэтому очень важно определить для приложения оптимальные значения пропускной способности и количество операций ввода-вывода в секунду. Оптимизация одного из показателей обязательно повлияет на другой. В разделе *Оптимизация производительности приложения*более подробно рассмотрена оптимизация операций ввода-вывода и пропускной способности.

## <a name="latency"></a>Latency
Задержка — это время, необходимое приложению, чтобы получить один запрос, отправить его дискам хранилища, а затем отправить ответ клиенту. Наряду с количеством операций ввода-вывода в секунду и пропускной способностью этот показатель является критически важным для производительности приложения. Задержка на диске хранилища класса «Премиум» — это время, необходимое, чтобы извлечь информацию о запросе и передать ее приложению. Хранилище класса «Премиум» обеспечивает постоянно низкую задержку. Если включить кэширование узлов со значением ReadOnly на дисках хранилища класса «Премиум», это позволит сократить время задержки чтения. Более подробно кэширование дисков рассмотрено в разделе *Оптимизация производительности приложения*.

При оптимизации приложения для повышения скорости выполнения операций ввода-вывода и увеличения пропускной способности время задержки приложения также меняется. После настройки производительности приложения во избежание возникновения высокой задержки всегда оценивайте время задержки.

## <a name="gather-application-performance-requirements"></a>Сбор требований к производительности приложения
Первый шаг при разработке высокопроизводительных приложений, выполняющихся в хранилище Azure класса «Премиум», — понять требования к производительности приложения. После сбора этих требований на их основе можно оптимизировать приложение для достижения наиболее оптимальной производительности.

В предыдущем разделе описаны общие показатели производительности: количество операций ввода-вывода в секунду, пропускная способность и задержка. Чтобы предоставить необходимые возможности для пользователя, нужно определить, какие из этих показателей производительности критически важны для приложения. Например, высокая скорость выполнения операций ввода-вывода наиболее важна для приложений OLTP, обрабатывающих миллионы транзакций в секунду. Высокая пропускная способность, в свою очередь, критически важна для приложений хранилища данных, обрабатывающих большие объемы данных в секунду. Очень низкая задержка имеет решающее значение для приложений, выполняющихся в реальном времени, например веб-сайтов потоковой передачи видео.

Затем нужно определить максимальные требования к производительности приложения в течение его времени существования. В качестве начальной точки используйте пример контрольного списка ниже. Запишите максимальные требования к производительности при стандартной, пиковой рабочей нагрузке и рабочей нагрузке в нерабочее время. После определения требований для всех уровней рабочих нагрузок можно задать общее требование к производительности приложения. Например, стандартная рабочая нагрузка веб-сайта электронной коммерции — это объем транзакций, обрабатываемых на протяжении большинства дней в году. Пиковая рабочая нагрузка веб-сайта — это объем транзакций, обрабатываемых во время праздников или специальных периодов продаж. Пиковая рабочая нагрузка обычно наблюдается в течение ограниченного периода. Однако приложению при этом может потребоваться выполнять в несколько раз больше операций, чем в обычном режиме. Узнайте значения показателей для 50-го, 90-го и 99-го процентилей. Таким образом можно отфильтровать все выбросы в требованиях к производительности и сосредоточиться на оптимизации на основе правильных значений.

**Контрольный список требований к производительности приложения**

| **Требования к производительности** | **50-й процентиль** | **90-й процентиль** | **99-й процентиль** |
| --- | --- | --- | --- |
| Макс. Транзакций в секунду | | | |
| Операции чтения, % | | | |
| Операции записи, % | | | |
| Случайные операции, % | | | |
| Последовательные операции, % | | | |
| Размер запроса ввода-вывода | | | |
| Средняя пропускная способность | | | |
| Макс. Throughput | | | |
| Мин. Latency | | | |
| Среднее время задержки | | | |
| Макс. ЦП | | | |
| Средняя загрузка ЦП | | | |
| Макс. Память | | | |
| Среднее использование памяти | | | |
| Длина очереди | | | |

> [!NOTE]
> Эти показатели следует регулировать в зависимости от ожидаемого в будущем роста приложения. Рекомендуем подготовиться к росту приложения заранее, так как изменить инфраструктуру для повышения производительности позже будет сложнее.
>
>

Если требуется перейти от существующего приложения к хранилищу класса «Премиум», сначала заполните контрольный список выше для существующего приложения. Затем создайте прототип приложения в хранилище класса «Премиум» и разработайте приложение в соответствии с рекомендациями, приведенными в разделе *Оптимизация производительности приложения* ниже. В следующем разделе описываются инструменты для сбора информации о показателях производительности.

Создайте для прототипа такой же контрольный список, как для существующего приложения. С помощью инструментов тестирования производительности можно смоделировать рабочую нагрузку и измерить производительность прототипа приложения. Дополнительные сведения см. в разделе [Измерение производительности](#benchmarking). В результате вы сможете определить, может ли хранилище класса «Премиум» соответствовать требованиям к производительности приложения или превзойти их. Затем те же указания можно применить и для рабочего приложения.

### <a name="counters-to-measure-application-performance-requirements"></a>Счетчики для оценки требований к производительности приложения
Оптимальным способом оценки требований к производительности приложения являются инструменты мониторинга производительности, содержащиеся в операционной системе сервера. Можно использовать PerfMon для Windows и iostat для Linux. Эти инструменты собирают данные со счетчиков по каждому показателю, описанному в предыдущем разделе. Следует записывать значения этих счетчиков для приложения при стандартной, пиковой рабочей нагрузке и рабочей нагрузке в нерабочее время.

Доступны счетчики PerfMon для процессора, памяти и каждого логического и физического диска сервера. При использовании дисков хранилища класса «Премиум» в виртуальной машине счетчики физических дисков собирают данные с каждого диска хранилища, а счетчики логических дисков — с каждого тома, созданного на диске хранилища. Необходимо записывать значения для дисков, на которых выполняется рабочая нагрузка приложения. Если логические и физические диски сопоставляются по типу «один к одному», нужно рассматривать значения счетчиков физических дисков. В противном случае следует обращать внимание на значения счетчиков логических дисков. В Linux при выполнении команды iostat создается отчет об использовании ЦП и дискового пространства. В отчете об использовании дискового пространства содержатся статистические данные для каждого физического устройства или раздела. Если данные и журнал сервера базы данных расположены на разных дисках, нужно собрать данные для обоих дисков. В таблице ниже приведены счетчики для дисков, процессора и памяти.

| Счетчик | ОПИСАНИЕ | PerfMon | iostat |
| --- | --- | --- | --- |
| **Количество операций ввода-вывода или транзакций в секунду** |Количество запросов ввода-вывода, выдаваемых диску хранилища в секунду. |Операций чтения с диска в секунду  <br> Операций записи на диск в секунду |tps  <br> r/s  <br> w/s |
| **Количество операций чтения и записи на диске** |Процент операций чтения и записи, выполняемых на диске. |Процент активности диска при чтении  <br> Процент активности диска при записи |r/s  <br> w/s |
| **Пропускная способность** |Объем данных, считываемых с диска или записываемых на диск в секунду. |Скорость чтения с диска (байт/с)  <br> Скорость записи на диск (байт/с) |КБ/с прочитано <br> КБ/с записано |
| **Задержка** |Общее время завершения запроса ввода-вывода на диске. |Средняя скорость чтения с диска в секунду  <br> Средняя скорость записи на диск в секунду |await  <br> svctm |
| **Объем ввода-вывода** |Объем запросов ввода-вывода, выданных дискам хранилища. |Средняя скорость чтения с диска (байт/с)  <br> Средняя скорость записи на диск (байт/с) |avgrq-sz |
| **Длина очереди** |Количество необработанных запросов ввода-вывода, ожидающих чтения с диска хранилища или записи на диск хранилища. |Текущая длина очереди диска |avgqu-sz |
| **Макс. Память** |Объем памяти, необходимый для стабильной работы приложения |Использование выделенной памяти (в байтах), % |Использование vmstat |
| **Макс. ЦП** |Объем ЦП, необходимый для стабильной работы приложения |Загруженность процессора, % |%util |

См. дополнительные сведения об [iostat](https://linux.die.net/man/1/iostat) и [PerfMon](https://msdn.microsoft.com/library/aa645516.aspx).

## <a name="optimizing-application-performance"></a>Оптимизация производительности приложения
Основные факторы, влияющие на производительность приложения, выполняющегося в хранилище класса «Премиум», — характер запросов ввода-вывода, размер виртуальной машины, размер диска, количество дисков, кэширование диска, многопоточность и длина очереди. Некоторыми из этих факторов можно управлять с помощью средств, предоставляемых системой. В большинстве приложений не предусмотрена возможность изменения объема операций ввода-вывода и длины очереди напрямую. Например, при использовании SQL Server нельзя выбрать значения этих показателей. SQL Server выбирает оптимальные значения объема операций ввода-вывода и длины очереди для получения лучшей производительности. Важно понимать, какое влияние оба показателя оказывают на производительность приложения, чтобы выделить объем ресурсов в соответствии с потребностями в производительности.

Определить нужный уровень оптимизации производительности приложения можно с помощью созданного ранее контрольного списка требований приложения. Исходя из этого, можно определить, какие показатели из этого раздела необходимо настроить. Чтобы убедиться во влиянии каждого из показателей на производительность приложения, запустите инструменты тестирования производительности на установленном приложении. Шаги, необходимые для запуска общих инструментов тестирования производительности в виртуальных машинах Windows и Linux, см. в разделе [Измерение производительности](#Benchmarking) в конце этой статьи.

### <a name="optimizing-iops-throughput-and-latency-at-a-glance"></a>Краткий обзор оптимизации выполнения операций ввода-вывода, пропускной способности и задержки

В таблице ниже приведена сводка показателей производительности и шагов, необходимых для оптимизации выполнения операций ввода-вывода, пропускной способности и задержки. В следующих разделах более подробно описан каждый из показателей.

Дополнительные сведения о размерах виртуальных машин, операциях ввода-вывода в секунду, пропускной способности и задержке, доступных для каждого типа виртуальной машины, см. в статье [Размеры виртуальных машин Linux в Azure](../articles/virtual-machines/linux/sizes.md) и [Размеры виртуальных машин Windows в Azure](../articles/virtual-machines/windows/sizes.md).

| &nbsp; | **ОПЕРАЦИЙ ВВОДА-ВЫВОДА** | **Пропускная способность** | **Задержка** |
| --- | --- | --- | --- |
| **Пример сценария** |Корпоративное приложение OLTP, которому требуется высокая скорость выполнения транзакций в секунду. |Корпоративное приложение хранилища данных, обрабатывающее большие объемы данных. |Приложения, которые выполняются практически в реальном времени и требуют мгновенных ответов на запросы пользователей, например игры в сети. |
| Факторы производительности | &nbsp; | &nbsp; | &nbsp; |
| **Объем ввода-вывода** |Меньший объем ввода-вывода обеспечивает более высокую скорость выполнения операций ввода-вывода. |Больший объем ввода-вывода обеспечивает более высокую пропускную способность. | &nbsp;|
| **Размер виртуальной машины** |Используйте размер виртуальной машины, который обеспечивает более высокую скорость выполнения операций ввода-вывода, чем указано в требованиях приложения. |Используйте размер виртуальной машины с большей пропускной способностью, чем требует приложение. |Используйте размер виртуальной машины с более широкими пределами масштабируемости, чем требует приложение. |
| **Размер диска** |Используйте размер диска, который обеспечивает более высокую скорость выполнения операций ввода-вывода, чем требует приложение. |Используйте размер диска с более высокой пропускной способностью, чем требует приложение. |Используйте размер диска с более широкими пределами масштабируемости, чем требует приложение. |
| **Ограничения масштабируемости виртуальной машины и диска** |Ограничение количества операций ввода-вывода в секунду для выбранного размера виртуальной машины должно быть больше общего количества операций ввода-вывода в секунду, выполняемых на дисках хранилища класса «Премиум», подключенных к виртуальной машине. |Ограничение пропускной способности для выбранного размера виртуальной машины должно быть больше общей пропускной способности дисков хранилища класса «Премиум», подключенных к виртуальной машине. |Ограничение масштабируемости для выбранного размера виртуальной машины должно быть больше общего ограничения масштабируемости подключенных дисков хранилища класса «Премиум». |
| **Кэширование диска** |Включите кэш со значением ReadOnly на дисках хранилища класса «Премиум» с большим объемом операций чтения, чтобы повысить скорость выполнения операций ввода-вывода при чтении. | &nbsp; |Включите кэш со значением ReadOnly на дисках хранилища класса «Премиум» с большим объемом операций чтения, чтобы сократить время задержки при чтении до минимума. |
| **Чередование дисков** |Используйте несколько дисков и чередуйте их, чтобы повысить общее ограничение количества операций ввода-вывода и пропускной способности. Обратите внимание, что общее ограничение для каждой виртуальной машины должно быть больше, чем общие ограничения подключенных дисков «Премиум». | &nbsp; | &nbsp; |
| **Размер блока чередования** |Меньший размер блока чередования для случайных небольших запросов ввода-вывода в приложениях OLTP. Например, для приложения OLTP SQL Server можно использовать блок чередования на 64 КБ. |Больший размер блока чередования для последовательных объемных запросов ввода-вывода в приложениях хранилища данных. Например, для приложения хранилища данных SQL Server можно использовать блок чередования на 256 КБ. | &nbsp; |
| **Многопоточность** |Используйте многопоточность для передачи большего количества запросов хранилищу класса «Премиум». Это позволит увеличить скорость выполнения операций ввода-вывода и повысить пропускную способность. Например, укажите наибольшее значение для параметра MAXDOP на сервере SQL Server, чтобы выделить дополнительные ЦП для SQL Server. | &nbsp; | &nbsp; |
| **Длина очереди** |Более длинная очередь обеспечивает более высокую скорость выполнения операций ввода-вывода. |Более длинная очередь обеспечивает более высокую пропускную способность. |Более короткая очередь сокращает время задержки. |

## <a name="nature-of-io-requests"></a>Характер запросов ввода-вывода
Запрос ввода-вывода — это единица операции ввода-вывода, которую будет выполнять приложение. Определив характер запроса ввода-вывода (случайный или последовательный, чтение или запись, большого или небольшого размера), можно определить требования к производительности приложения. Очень важно понимать характер запросов ввода-вывода для принятия правильных решений при разработке инфраструктуры приложения.

Один из наиболее важных факторов — объем ввода-вывода. Это объем запроса на операцию ввода-вывода, созданного приложением. Объем ввода-вывода оказывает существенное влияние на производительность, особенно на показатели количества операций ввода-вывода и пропускной способности, которых может достигнуть приложение. Следующая формула демонстрирует взаимосвязь между количеством операций ввода-вывода в секунду, объемом ввода-вывода и пропускной способностью.  
    ![](media/premium-storage-performance/image1.png)

В одних приложениях можно изменять объем ввода-вывода, а в других — нет. Например, SQL Server определяет оптимальный объем ввода-вывода и не предоставляет пользователям никаких средств для его изменения. Oracle, в свою очередь, предоставляет параметр [DB\_BLOCK\_SIZE](https://docs.oracle.com/cd/B19306_01/server.102/b14211/iodesign.htm#i28815), с помощью которого можно настроить размер запроса ввода-вывода базы данных.

При использовании приложения, в котором нельзя изменять объем ввода-вывода, следуйте приведенным здесь рекомендациям для оптимизации ключевых показателей эффективности для производительности, необходимых приложению. Например,

* Приложения OLTP генерируют миллионы небольших случайных запросов ввода-вывода. Для обработки таких запросов необходимо разработать инфраструктуру приложения, чтобы повысить скорость выполнения операций ввода-вывода.  
* Приложения хранилища данных генерируют крупные последовательные запросы ввода-вывода. Для обработки таких запросов необходимо разработать инфраструктуру приложения, чтобы увеличить пропускную способность.

При использовании приложения, в котором можно изменять объем ввода-вывода, помимо других указаний для производительности, рекомендуем применять следующие принципы в отношении объема ввода-вывода.

* Меньший объем ввода-вывода обеспечивает более высокую скорость выполнения операций ввода-вывода. Например, 8 КБ для приложения OLTP.  
* Больший объем ввода-вывода обеспечивает более высокую пропускную способность. Например, 1024 КБ для приложения хранилища данных.

Приведенный ниже пример поможет рассчитать количество операций ввода-вывода в секунду и пропускную способность для приложения. Рассмотрим приложение, использующее диск P30. Максимальное количество операций ввода-вывода в секунду и максимальная пропускная способность диска P30 — 5000 операций ввода-вывода и 200 МБ в секунду соответственно. Если с приложением, которому требуется максимальное количество операций ввода-вывода диска P30, использовать меньший объем ввода-вывода, например 8 КБ, пропускная способность, которой можно будет добиться, составит 40 МБ в секунду. Однако, если с приложением, которому требуется максимальная пропускная способность диска P30, использовать больший объем операций ввода-вывода, например 1024 КБ, количество операций ввода-вывода в секунду, которого можно будет добиться, сократится до 200. Таким образом, объем ввода-вывода следует настраивать в соответствии с требованиями приложения к количеству операций ввода-вывода в секунду и пропускной способности. В следующей таблице приведены разные объемы ввода-вывода и соответствующее количество операций ввода-вывода в секунду, а также показатели пропускной способности для диска P30.

| Требование к приложению | Объем ввода-вывода | ОПЕРАЦИЙ ВВОДА-ВЫВОДА | Пропускная способность |
| --- | --- | --- | --- |
| Maкс. количество операций ввода-вывода в секунду |8 КБ |5 000 |40 МБ в секунду |
| Макс. пропускная способность |1024 КБ |200 |200 МБ в секунду |
| Макс. пропускная способность и высокая скорость выполнения операций ввода-вывода |64 КБ |3200 |200 МБ в секунду |
| Макс. скорость выполнения операций ввода-вывода и высокая пропускная способность |32 КБ |5 000 |160 МБ в секунду |

Для получения более высокой скорости выполнения операций ввода-вывода и пропускной способности, чем максимальное значение для одного диска хранилища класса «Премиум», чередуйте несколько дисков класса «Премиум». Например, чередуйте два диска P30, чтобы получить объединенную скорость выполнения операций ввода-вывода (10 000 операций ввода-вывода в секунду) или объединенную пропускную способность (400 МБ в секунду). Необходимо использовать размер виртуальной машины, который поддерживает объединенную скорость выполнения операций ввода-вывода и пропускную способность дисков, как описано в следующем разделе.

> [!NOTE]
> При увеличении скорости выполнения операций ввода-вывода или пропускной способности другой показатель также увеличивается. Поэтому, увеличивая один из показателей, убедитесь, что не достигнуто ограничение пропускной способности или скорости выполнения операций ввода-вывода диска или виртуальной машины.
>
>

Чтобы убедиться во влиянии объема ввода-вывода на производительность приложения, можно запустить инструменты тестирования производительности на виртуальной машине и дисках. Выполните несколько тестовых запусков и используйте для каждого из них разный объем ввода-вывода, чтобы увидеть влияние. Дополнительные сведения см. в разделе [Измерение производительности](#Benchmarking) в конце этой статьи.

## <a name="high-scale-vm-sizes"></a>Размеры высокомасштабируемых виртуальных машин
При разработке приложения нужно в первую очередь выбрать виртуальную машину для размещения приложения. Хранилище класса «Премиум» предусматривает использование высокомасштабируемых виртуальных машин, на которых могут выполняться приложения, требующие высокой вычислительной мощности и повышенной производительности операций ввода-вывода локального диска. Эти виртуальные машины отличаются более быстрыми процессорами, более высоким соотношением «память — ядро» и использованием твердотельного накопителя (SSD) в качестве локального диска. Примерами высокомасштабируемых виртуальных машин с поддержкой хранилища класса "Премиум" являются виртуальные машины серий DS, DSv2 и GS.

Доступны высокомасштабируемые виртуальные машины различных размеров с разным количеством ядер ЦП, объемом памяти, операционными системами и размером временного диска. Для каждого размера виртуальной машины также установлено максимальное количество дисков данных, которые можно подключить к виртуальной машине. Таким образом, выбранный размер виртуальной машины влияет на мощность обработки, объем памяти и хранилища, которые доступны для приложения. Он также влияет на затраты на вычисление и хранение. Например, ниже представлены спецификации виртуальной машины максимального размера серий DS, DSv2 и GS:

| Размер виртуальной машины | Ядра ЦП | Память | Размеры диска виртуальной машины | Макс. количество дисков данных | Объем кэша | ОПЕРАЦИЙ ВВОДА-ВЫВОДА | Ограничения количества операций ввода-вывода в секунду и пропускной способности кэша |
| --- | --- | --- | --- | --- | --- | --- | --- |
| Standard_DS14 |16 |112 ГБ |ОС = 1023 ГБ  <br> Локальный SSD = 224 ГБ |32 |576 ГБ |50 000 операций ввода-вывода в секунду  <br> 512 МБ в секунду |4000 операций ввода-вывода в секунду и 33 МБ в секунду |
| Standard_GS5 |32 |448 ГБ |ОС = 1023 ГБ  <br> Локальный SSD = 896 ГБ |64 |4224 ГБ |80 000 операций ввода-вывода в секунду  <br> 2000 МБ в секунду |5000 операций ввода-вывода в секунду и 50 МБ в секунду |

Полный список всех доступных размеров виртуальных машин Azure см. в статьях [Размеры виртуальных машин Windows](../articles/virtual-machines/windows/sizes.md) и [Размеры виртуальных машин Linux](../articles/virtual-machines/linux/sizes.md). Выберите размер виртуальной машины, который позволяет выполнять масштабирование в соответствии с требованиями к производительности приложения. Помимо этого, при выборе размеров виртуальной машины необходимо учитывать следующие важные аспекты.

*Ограничения масштабирования*  
Максимальные ограничения операций ввода-вывода в секунду на виртуальную машину и на диск различаются и не зависят друг от друга. Убедитесь, что количество операций ввода-вывода в секунду, выполняемое приложением и подключенными к нему дисками класса «Премиум», находится в пределах ограничений виртуальной машины. В противном случае производительность приложения нужно будет отрегулировать.

В качестве примера предположим, что максимальное количество операций ввода-вывода в секунду для приложения составляет 4000. Для достижения этого показателя на виртуальной машине DS1 необходимо подготовить диск P30. Диск P30 может выполнять до 5000 операций ввода-вывода в секунду. Но виртуальная машина DS1 может выполнять не более 3200 операций ввода-вывода в секунду. Следовательно, приложение также ограничивается 3200 операциями ввода-вывода в секунду и демонстрирует сниженную производительность. Во избежание этого выберите размеры диска и виртуальной машины, соответствующие требованиям приложения.

*Стоимость выполнения операций*  
Во многих случаях общая стоимость выполнения операций с использованием хранилища класса «Премиум» может быть меньше, чем при использовании хранилища класса «Стандартный».

В качестве примера рассмотрим приложение, требующее выполнения 16 000 операций ввода-вывода в секунду. Для достижения такой производительности потребуется виртуальная машина IaaS Azure Standard\_StandardD14, которая выполняет до 16 000 операций ввода-вывода в секунду, используя 32 диска хранилища класса "Стандартный" емкостью 1 ТБ. Каждый диск хранилища класса «Стандартный» емкостью 1 ТБ может выполнить до 500 операций ввода-вывода в секунду. Оценочная стоимость этой виртуальной машины в месяц составляет 1570 долл. США. Ежемесячная стоимость 32 дисков хранилища класса «Стандартный» составляет 1638 долл. США. Оценочная общая ежемесячная стоимость составляет 3208 долл. США.

Однако если разместить то же самое приложение в хранилище класса «Премиум», понадобится меньший размер виртуальной машины и меньшее количество дисков хранилища класса «Премиум», что уменьшит общую стоимость. Виртуальная машина Standard\_StandardDS13 может выполнять 16 000 операций ввода-вывода в секунду, используя четыре диска P30. Виртуальная машина DS13 выполняет до 25 600 операций ввода-вывода в секунду, а каждый диск P30 — до 5000. В целом, при такой конфигурации можно добиться 20 000 операций ввода-вывода в секунду (5000 x 4). Оценочная стоимость этой виртуальной машины в месяц составляет 1003 долл. США. Ежемесячная стоимость четырех дисков хранилища класса «Премиум» P30 составляет 544,34 долл. США. Оценочная общая ежемесячная стоимость составляет 1544 долл. США.

В следующей таблице представлены затраты по этому сценарию при использовании хранилища класса «Стандартный» и «Премиум».

| &nbsp; | **Стандартный** | **Премиальный** |
| --- | --- | --- |
| **Стоимость виртуальной машины в месяц** |1570,58 долл. США (Standard\_D14) |1003,66 долл. США (Standard\_DS13) |
| **Стоимость дисков в месяц** |1638,40 долл. США (32 диска емкостью 1 ТБ) |544,34 долл. США (4 диска P30) |
| **Общая стоимость в месяц** |3208,98 долл. США |1544,34 долл. США |

*Дистрибутивы Linux*  

Используя службу хранилища Azure категории "Премиум", можно добиться одинакового уровня производительности виртуальных машин под управлением Windows и Linux. Продукция корпорации Майкрософт поддерживает множество разных дистрибутивов Linux. Полный список можно просмотреть [здесь](../articles/virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json). Следует отметить, что для различных типов рабочих нагрузок подходят различные дистрибутивы. Каждый дистрибутив, используемый для рабочей нагрузки, обеспечивает разный уровень производительности. Протестируйте дистрибутивы Linux для приложения и выберите наиболее подходящий вариант.

При использовании хранилища класса «Премиум» под управлением Linux следует проверить последние обновления драйверов, необходимых для обеспечения высокой производительности.

## <a name="premium-storage-disk-sizes"></a>Размеры диска хранилища класса «Премиум»
В настоящее время хранилище уровня "Премиум" Azure предлагается с дисками семи размеров. Для диска каждого размера установлены различные ограничения масштабирования для операций ввода-вывода в секунду, пропускной способности и хранилища. Выберите диск хранилища класса «Премиум» правильного размера в соответствии с требованиями приложения и размером высокомасштабируемой виртуальной машины. В следующей таблице представлены диски семи размеров и их возможности. Размеры P4 и P6 в настоящее время поддерживаются только для службы "Управляемые диски".

| Диски уровня "Премиум"  | P4    | P6    | P10   | P20   | P30   | P40   | P50   | 
|---------------------|-------|-------|-------|-------|-------|-------|-------|
| Размер диска           | 32 ГБ | 64 ГБ | 128 ГБ| 512 ГБ            | 1024 ГБ (1 ТБ)    | 2048 ГБ (2 ТБ)    | 4095 ГБ (4 ТБ)    | 
| Количество операций ввода-вывода в секунду на диск       | 120   | 240   | 500   | 2300              | 5000              | 7500              | 7500              | 
| Пропускная способность на диск | 25 МБ в секунду  | 50 МБ в секунду  | 100 МБ в секунду | 150 МБ в секунду | 200 МБ в секунду | 250 МБ в секунду | 250 МБ в секунду | 


Выбор количества дисков зависит от выбранного размера диска. Для удовлетворения требований приложения можно использовать один диск P50 или несколько дисков P10. Выбирая размер диска, учитывайте приведенные ниже рекомендации.

*Ограничения масштабирования (на количество операций ввода-вывода в секунду и пропускную способность)*  
Ограничения на количество операций ввода-вывода в секунду и пропускную способность для каждого размера диска класса "Премиум" различаются и не зависят от ограничений масштабирования виртуальной машины. Убедитесь, что общее количество операций ввода-вывода в секунду и пропускная способность дисков не превышают установленные ограничения масштабирования выбранного размера виртуальной машины.

Например, рассмотрим, как следует поступить, если используется виртуальная машина DS4 с одним диском P30, а максимальная пропускная способность приложения составляет не более 250 МБ/с. Максимальная пропускная способность виртуальной машины DS4 — 256 МБ/с. У одного диска P30 установлено ограничение пропускной способности на уровне 200 МБ/с. Следовательно, из-за ограничений диска пропускная способность приложения будет равна 200 МБ/с. Чтобы устранить эту проблему, для виртуальной машины необходимо подготовить несколько дисков данных либо изменить размер дисков на P40 или P50.

> [!NOTE]
> Операции чтения, обрабатываемые с помощью кэша, не относятся к операциям ввода-вывода и пропускной способности диска, поэтому ограничения диска на них не распространяются. Для кэша существует отдельное ограничение на количество операций ввода-вывода в секунду и пропускную способность для каждой виртуальной машины.
>
> Например, изначально пропускная способность операций чтения и записи составляет 60 МБ/с и 40 МБ/с соответственно. Со временем кэш подготавливает и выполняет все больше операций чтения. В дальнейшем можно добиться более высокой пропускной способности операций записи с диска.
>
>

*Количество дисков*  
Определите необходимое количество дисков на основе оценки требований приложения. Для каждого размера виртуальной машины также установлено ограничение на количество дисков, которые можно подключить. Как правило, это количество в два раза превышает количество ядер. Убедитесь, что выбранный размер виртуальной машины поддерживает необходимое количество дисков.

Помните, что диски хранилища класса «Премиум» обеспечивают более высокую производительность по сравнению с дисками хранилища класса «Стандартный». Таким образом, при переходе с использования для приложения виртуальной машины IaaS Azure хранилища класса «Стандартный» на хранилище класса «Премиум», скорее всего, для достижения того же или более высокого уровня производительности приложения потребуется меньшее количество дисков класса «Премиум».

## <a name="disk-caching"></a>Кэширование диска
В высокомасштабируемых виртуальных машинах, которые используют хранилище Azure класса «Премиум», применяется технология многоуровневого кэширования под названием BlobCache. При таком кэшировании используется ОЗУ виртуальной машины и локальный SSD. Это кэширование доступно для постоянных дисков хранилища класса «Премиум» и локальных дисков виртуальной машины. По умолчанию для параметра кэширования задано значение Read/Write для дисков операционной системы и ReadOnly для дисков данных, размещенных в хранилище класса «Премиум». Если активировать функцию кэширования диска для дисков хранилища класса «Премиум», можно добиться чрезвычайно высокого уровня производительности высокомасштабируемых виртуальных машин, который превысит базовый уровень производительности диска.

> [!WARNING]
> При изменении параметра кэша диска Azure целевой диск отключается, а затем вновь подключается к виртуальной машине. Если это диск операционной системы, то виртуальная машина перезагрузится. Остановите все приложения и службы, работу которых может нарушить это событие, прежде чем изменять параметр кэша диска.
>
>

Дополнительные сведения о работе BlobCache см. в записи блога [Хранилища Azure класса "Премиум"](https://azure.microsoft.com/blog/azure-premium-storage-now-generally-available-2/).

Очень важно включить кэширование для правильного набора дисков. Необходимость включения функции кэширования диска для диска класса «Премиум» зависит от шаблона рабочей нагрузки, которую будет обрабатывать этот диск. В следующей таблице приведены параметры кэширования по умолчанию для дисков операционной системы и дисков данных.

| **Тип диска** | **Параметр кэширования по умолчанию** |
| --- | --- |
| Диск ОС |ReadWrite |
| Диск данных |ReadOnly |

Ниже приведены рекомендуемые параметры кэширования диска для дисков данных

| **Параметр кэширования диска** | **Рекомендации по использованию этого параметра** |
| --- | --- |
| None |Задайте для кэша узла значение None для дисков с высокой интенсивностью операций записи и дисков только для записи. |
| ReadOnly |Задайте для кэша узла значение ReadOnly для дисков, которые используются для чтения и записи или только для чтения. |
| ReadWrite |Задайте для кэша узла значение ReadWrite, только если приложение правильно обрабатывает операции записи кэшированных данных на постоянные диски. |

*ReadOnly*  
Задав для кэширования значение ReadOnly для дисков данных хранилища класса «Премиум», можно достичь низкой задержки операций чтения и очень высокой скорости выполнения операций ввода-вывода и пропускной способности при чтении для приложения. Это происходит по двум причинам.

1. Выполнение операций чтения из кэша, который находится в памяти виртуальной машины и локального SSD, происходит намного быстрее, чем выполнение операций чтения с диска данных, который находится в хранилище BLOB-объектов Azure.  
2. В хранилище класса «Премиум» операции чтения, выполненные из кэша, не относятся к операциям ввода-вывода и пропускной способности диска. Таким образом, приложение может выполнять больше операций ввода-вывода и достичь высокой пропускной способности.

*ReadWrite*  
На дисках операционной системы по умолчанию задано значение кэширования ReadWrite. Более того, с недавнего времени значение кэширования ReadWrite можно задать и для дисков данных. При использовании значения кэширования ReadWrite необходимо использовать правильный способ записи данных из кэша на постоянные диски. Например, SQL Server обрабатывает операции записи кэшированных данных на постоянные диски хранилища самостоятельно. Использование значения кэширования ReadWrite для приложения, которое не обеспечивает сохранение необходимых данных, может привести к потере данных в случае сбоя виртуальной машины.

Эти рекомендации можно применить для запуска SQL Server в хранилище класса «Премиум». Для этого нужно сделать следующее.

1. Задайте для кэша значение ReadOnly для дисков хранилища уровня "Премиум", на которых размещены файлы данных.  
   a.  Благодаря быстрому выполнению операций чтения из кэша уменьшается время обработки запроса SQL Server, так как страницы данных извлекаются из кэша гораздо быстрее, чем непосредственно с дисков данных.  
   Б.  Если операции чтения выполняются из кэша, это означает, что диски с данными класса «Премиум» дают дополнительную пропускную способность. Ее можно использовать на SQL Server для извлечения большего количества страниц данных и выполнения других операций, таких как резервное копирование и восстановление, пакетные загрузки и перестройки индекса.  
2. Задайте для кэша значение None для дисков хранилища уровня "Премиум", на которых размещены файлы журнала.  
   a.  В файлах журнала преимущественно содержатся данные операций с высокой интенсивностью записи. Поэтому на них никак не влияет использование кэша со значением ReadOnly.

## <a name="disk-striping"></a>Чередование дисков
Если к высокомасштабируемой виртуальной машине подключены несколько постоянных дисков хранилища класса «Премиум», диски можно чередовать для объединения операций ввода-вывода, пропускной способности и объема хранилища.

Для чередования дисков в операционной системе Windows можно использовать дисковое пространство. Для каждого диска в пуле необходимо настроить один столбец. В противном случае общая производительность чередующегося тома может быть ниже ожидаемой из-за неравномерного распределения трафика между дисками.

Важно! С помощью пользовательского интерфейса диспетчера сервера для чередующегося тома можно задать 8 столбцов. При подключении более 8 дисков используйте PowerShell для создания тома. С помощью PowerShell можно задать такое же количество столбцов, как и количество дисков. Например, если в одном чередующемся наборе 16 дисков, укажите 16 столбцов для параметра *NumberOfColumns* командлета PowerShell *New-VirtualDisk*.

В операционной системе Linux для чередования дисков используйте программу MDADM. Подробные инструкции по чередованию дисков в Linux см. в статье [Настройка программного RAID-массива в Linux](../articles/virtual-machines/linux/configure-raid.md).

*Размер блока чередования*  
При чередовании дисков размер блока чередования имеет большое значение. Размер блока чередования или размер блока — это наименьший фрагмент данных, к которым может обратиться приложение в чередующемся томе. Настраиваемый размер блока чередования зависит от типа приложения и шаблона запроса. Выбор неправильного размера блока чередования может привести к рассогласованию ввода-вывода, что, в свою очередь, влечет снижение производительности приложения.

Например, если размер созданного приложением запроса ввода-вывода больше размера блока чередования диска, система хранения запишет его на несколько дисков, выходя за пределы границ чередующейся единицы. При доступе к этим данным для выполнения запроса поиск будет осуществляться в нескольких чередующихся единицах. В результате производительность может существенно снизиться. Если же размер запроса ввода-вывода меньше размера блока чередования и сам запрос является случайным, запросы ввода-вывода будут добавляться на один и тот же диск. Как следствие, диск переполнится, что в конечном счете приведет к снижению производительности ввода-вывода.

Выберите подходящий размер блока чередования в зависимости от типа рабочей нагрузки приложения. Для случайных небольших запросов ввода-вывода следует использовать меньший размер блока чередования, а для больших последовательных запросов ввода-вывода — более крупный размер блока чередования. Узнайте больше о рекомендациях по размеру блока чередования для приложения, которое будет запущено в хранилище класса «Премиум». Дополнительную информацию см. в статье [Рекомендации по оптимизации производительности SQL Server на виртуальных машинах Azure](../articles/virtual-machines/windows/sql/virtual-machines-windows-sql-performance.md#disks-guidance) .

> [!NOTE]
> На виртуальной машине серии DS можно чередовать до 32 дисков хранилища класса «Премиум», а на виртуальной машине серии GS — до 64 дисков хранилища класса «Премиум».
>
>

## <a name="multi-threading"></a>Многопоточность
Платформа хранилища класса «Премиум» предназначена для массовой параллельной обработки. Так, многопоточное приложение обеспечивает более высокую производительность по сравнению с однопоточным приложением. Многопоточное приложение распределяет задачи между несколькими потоками, увеличивая эффективность их выполнения за счет максимального использования ресурсов виртуальной машины и диска.

Например, если приложение запущено на одноядерной виртуальной машине с использованием двух потоков, для увеличения эффективности ЦП может переключаться между двумя потоками. В то время как один поток ожидает завершения дисковой операции ввода-вывода, ЦП может переключиться на другой поток. Таким образом, используя два потока, можно выполнить намного больше задач, чем с использованием одного. Если у виртуальной машины несколько ядер, для выполнения задач требуется меньше времени, так как каждое ядро может выполнять задачи одновременно.

Способ осуществления однопоточной или многопоточной обработки в готовом приложении изменить невозможно. Например, SQL Server может выполнять задачи, используя несколько процессоров и ядер. Однако способ обработки запроса SQL Server (с использованием одного или нескольких потоков) зависит от определенных условий. С использованием многопоточности на этом сервере можно выполнять запросы и создавать индексы. Для обработки запроса, который включает в себя объединение таблиц с большим объемом информации и сортировку данных перед возвращением пользователю, SQL Server, скорее всего, воспользуется несколькими потоками. Пользователь не может управлять тем, каким образом SQL Server будет обрабатывать запрос — с использованием одного потока или нескольких.

Чтобы повлиять на многопоточность или параллельную обработку приложения, можно изменить некоторые параметры конфигурации. Например, в случае с SQL Server используется конфигурация максимальной степени параллелизма. С помощью параметра MAXDOP возможна настройка максимального количества процессоров, которые может использовать SQL Server при параллельной обработке. Этот параметр можно настроить для отдельных запросов и операций с индексами. Такая настройка полезна, если необходимо сбалансировать ресурсы системы для приложений, в работе которых производительность играет критически важную роль.

Например, допустим, приложение, которое использует SQL Server, одновременно выполняет запрос большого размера и индексирование. Предположим также, что необходимо, чтобы индексирование выполнялось с более высоким уровнем производительности, чем запрос большого размера. В таком случае для индексирования можно задать более высокое значение MAXDOP, чем для запроса. Тогда SQL Server сможет использовать больше процессоров для индексирования, чем он может выделить для запроса большого размера. Помните, что количество потоков, которые SQL Server будет использовать для каждой операции, не подлежит управлению. Но можно управлять максимальным количеством процессоров, выделяемых для нескольких потоков.

Дополнительные сведения см. в статье [Степень параллелизма](https://technet.microsoft.com/library/ms188611.aspx) в документации по SQL Server. Узнайте, какие параметры влияют на многопоточность в приложении и какие значения этих параметров являются оптимальными для обеспечения производительности.

## <a name="queue-depth"></a>Длина очереди
Длина, глубина или размер очереди — это количество ожидающих запросов ввода-вывода в системе. Значение длины очереди позволяет определить, сколько операций ввода-вывода приложение может поместить в очередь для их обработки дисками хранилища. Это значение влияет на все три показателя производительности приложения, которые рассматриваются в этой статье, а именно на операции ввода-вывода, пропускную способность и задержку.

Длина очереди и многопоточность тесно связаны. Значение длины очереди указывает, насколько многопоточным может быть приложение. Чем длиннее очередь, тем больше одновременных операций может выполнять приложение. Другими словами, оно может выполнять больше потоков. Если длина очереди небольшая, даже многопоточное приложение не поместити в очередь достаточно запросов для параллельного выполнения.

Обычно в готовых приложениях нельзя менять длину очереди, ведь если задать неправильное значение, это принесет больше вреда, чем пользы. В приложениях задается правильное значение длины очереди для достижения оптимальной производительности. Тем не менее важно понимать, как это происходит, чтобы иметь возможность устранять проблемы с производительностью. Кроме того, можно убедиться во влиянии длины очереди, запустив инструменты тестирования производительности в своей системе.

В некоторых приложениях доступны параметры, с помощью которых можно повлиять на длину очереди. Например, MAXDOP (параметр максимальной степени параллелизма) в SQL Server, описанный в предыдущем разделе. MAXDOP позволяет повлиять на длину очереди и многопоточность, но не меняет значение длины очереди SQL Server напрямую.

*Высокое значение длины очереди*  
Благодаря высокому значению длины в очередь на диске помещается больше операций. Диску заранее известен следующий запрос очереди. Следовательно, операции на диске могут планироваться заранее и он может обрабатывать их в оптимальной последовательности. Так как приложение отправляет на диск больше запросов, диск может обрабатывать больше параллельных операций ввода-вывода. В результате приложение сможет выполнять больше операций ввода-вывода в секунду. Обработка большего количества запросов также приводит к увеличению общей пропускной способности приложения.

Как правило, приложение может достигать максимальной пропускной способности при наличии 8–16 и более ожидающих выполнения операций ввода-вывода на подключенный диск. Если задать для длины очереди значение «1», приложение не будет отправлять достаточно операций ввода-вывода в систему и, следовательно, будет обрабатывать меньше операций за указанный период. Другими словами, пропускная способность будет меньше.

Например, значение "4" для параметра MAXDOP запроса в SQL Server указывает на то, что для выполнения запроса можно использовать до четырех ядер. SQL Server определит оптимальное значение длины очереди и количество ядер для выполнения запроса.

*Оптимальная длина очереди*  
Использование очень высокого значения длины очереди также имеет свои недостатки. При таком значении приложение будет пытаться выполнить очень много операций ввода-вывода в секунду. Если приложение использует непостоянные диски с недостаточным количеством подготовленных операций ввода-вывода в секунду, это может отрицательно повлиять на задержку. Следующая формула демонстрирует взаимосвязь между количеством операций ввода-вывода в секунду, значением задержки и длиной очереди.  
    ![](media/premium-storage-performance/image6.png)

Для длины очереди не следует задавать высокое значение. Ее значение должно быть оптимальным и обеспечивать выполнение достаточного количества операций ввода-вывода в секунду для приложения, не влияя на задержку. Например, если задержка приложения должна составлять 1 миллисекунду, у длины очереди, необходимой для выполнения 5000 операций ввода-вывода в секунду, должно быть значение «5» (5000 x 0,001 = 5).

*Длина очереди чередующегося тома*  
Для чередующегося тома следует использовать достаточно высокое значение длины очереди, чтобы у каждого диска было отдельное значение максимальной длины очереди. Например, рассмотрим приложение, которое отправляет запросы в очередь со значением длины «2», при этом в блоке чередования находится 4 диска. В таком случае два запроса ввода-вывода будут отправляться на два диска, а остальные два диска будут простаивать. Поэтому настройте длину очереди так, чтобы диски не простаивали. С помощью формулы ниже показано, как определить длину очереди для чередующихся томов.  
    ![](media/premium-storage-performance/image7.png)

## <a name="throttling"></a>Регулирование
Хранилище Azure класса «Премиум» позволяет подготовить указанное количество операций ввода-вывода в секунду и задать пропускную способность в зависимости от выбранного размера виртуальных машин и дисков. При каждой попытке приложения выполнить операции ввода-вывода или использовать пропускную способность за пределами ограничения обработки виртуальной машины или диска хранилище класса «Премиум» урегулирует эту проблему. Это ухудшает производительность приложения, что выражается в повышенной задержке, низкой пропускной способности или меньшем количестве операций ввода-вывода в секунду. Если хранилище класса «Премиум» не выполнит регулировку, может произойти сбой всего приложения, так как оно превысит максимальные значения, которых могут достичь его ресурсы. Таким образом, чтобы избежать проблем с производительностью, связанных с регулированием, всегда следует подготавливать для приложения достаточно ресурсов. Примите во внимание информацию о размерах виртуальных машин и дисков, приведенную в разделах выше. Лучший способ выяснить, какие ресурсы необходимы для размещения приложения, — протестировать производительность.

## <a name="benchmarking"></a>Тестирование производительности
Тестирование производительности — это процесс моделирования различных рабочих нагрузок приложения и измерения его производительности при каждой из них. Выполнив действия, описанные в предыдущем разделе, вы узнали требования к производительности приложения. Применив инструменты тестирования производительности в виртуальных машинах с приложением, можно определить уровень производительности, которого оно может достичь при использовании хранилища класса «Премиум». В этом разделе приведены примеры тестирования производительности виртуальной машины серии DS14 класса «Стандартный», для которой подготовлены диски хранилища класса «Премиум».

Мы использовали стандартные инструменты тестирования производительности Iometer для Windows и FIO для Linux. Эти инструменты порождают несколько потоков, моделирующих производительность при рабочей нагрузке, и измеряют производительность системы. С помощью этих инструментов можно задать такие параметры, как размер блока и длина очереди, которые обычно нельзя менять в приложениях. Это обеспечивает большую гибкость для достижения максимальной производительности в высокомасштабируемых виртуальных машинах с подготовленными дисками класса "Премиум" для различных рабочих нагрузок приложения. Дополнительные сведения о каждом инструменте измерения производительности см. на веб-сайте [Iometer](http://www.iometer.org/) и на странице [FIO](http://freecode.com/projects/fio).

Создайте виртуальную машину серии DS14 класса «Стандартный» и подключите к ней 11 дисков хранилища класса «Премиум» согласно примеру ниже. Для параметра кэширования узлов 10 из 11 дисков задайте значение None и чередуйте их в томе NoCacheWrites. Для параметра кэширования оставшегося диска задайте значение ReadOnly и создайте том CacheReads с этим диском. Благодаря такой настройке можно узнать максимальное значение производительности виртуальной машины серии DS14 класса «Стандартный» при чтении и записи. Подробные инструкции по созданию виртуальной машины DS14 с дисками уровня "Премиум" см. в разделе [Создание и использование учетной записи хранения класса "Премиум" для работы с дисками данных виртуальных машин](../articles/virtual-machines/windows/premium-storage.md).

*Подготовка кэша*  
Диск, для кэширования узла которого задано значение ReadOnly, сможет выполнять больше операций ввода-вывода в секунду, чем значение ограничения диска. Чтобы добиться максимальной производительности при чтении для кэша узла, сначала необходимо подготовить кэш диска. Это гарантирует, что операции ввода-вывода при чтении, которые инструмент тестирования производительности выполнит в томе CacheReads, на самом деле попадут в кэш, а не прямо на диск. Попадания в кэш увеличат количество операций ввода-вывода на единственном диске, на котором включен кэш.

> **Важно!**  
> После каждой перезагрузки виртуальной машины кэш необходимо подготавливать до тестирования производительности.
>
>

#### <a name="iometer"></a>Iometer
[Скачайте инструмент Iometer](http://sourceforge.net/projects/iometer/files/iometer-stable/2006-07-27/iometer-2006.07.27.win32.i386-setup.exe/download) на виртуальную машину.

*Тестовый файл*  
Инструмент Iometer использует тестовый файл, который хранится в томе, где будет выполняться тестирование производительности. Чтение и запись осуществляется в этот тестовый файл, что позволяет измерить количество операций ввода-вывода в секунду и пропускную способность диска. Если этот файл не указан, Iometer создаст его. Создайте тестовый файл iobw.tst размером 200 ГБ в томах CacheReads и NoCacheWrites.

*Спецификации доступа*  
Спецификации, объем ввода-вывода запроса, процент операций чтения и записи, а также процент случайных и последовательных операций можно настроить на вкладке "Access Specifications" (Спецификации доступа) в Iometer. Создайте спецификацию доступа для каждого из описанных ниже сценариев. Создайте спецификации доступа, задайте соответствующее имена, такие как RandomWrites\_8K и RandomReads\_8K, и нажмите кнопку "Сохранить". Выберите соответствующую спецификацию при выполнении сценария тестирования.

Ниже приведен пример спецификаций доступа для сценария с максимальным количеством операций ввода-вывода в секунду при записи.  
    ![](media/premium-storage-performance/image8.png)

*Спецификации тестирования при максимальном количестве операций ввода-вывода в секунду*  
Чтобы продемонстрировать максимальное значение операций ввода-вывода в секунду, используйте запрос меньшего размера. Используйте запрос размером 8 КБ и создайте спецификации для случайных операций записи и чтения.

| Спецификация доступа | Размер запроса | Случайные, % | Чтение, % |
| --- | --- | --- | --- |
| RandomWrites\_8K |8 КБ |100 |0 |
| RandomReads\_8K |8 КБ |100 |100 |

*Спецификации тестирования максимальной пропускной способности*  
Чтобы продемонстрировать максимальную пропускную способность, используйте запрос большего размера. Используйте запрос размером 64 КБ и создайте спецификации для случайных операций записи и чтения.

| Спецификация доступа | Размер запроса | Случайные, % | Чтение, % |
| --- | --- | --- | --- |
| RandomWrites\_64K |64 КБ |100 |0 |
| RandomReads\_64K |64 КБ |100 |100 |

*Выполнение теста Iometer*  
Выполните следующие шаги, чтобы подготовить кэш.

1. Создайте две спецификации доступа со значениями, указанными ниже.

   | ИМЯ | Размер запроса | Случайные, % | Чтение, % |
   | --- | --- | --- | --- |
   | RandomWrites\_1MB |1MB |100 |0 |
   | RandomReads\_1MB |1MB |100 |100 |
2. Запустите тест Iometer, чтобы инициализировать диск с кэшем со следующими параметрами. Используйте три рабочих потока для целевого тома и задайте значение «128» для длины очереди. На вкладке "Test Setup" (Настройка теста) для параметра "Run time" (Время выполнения) установите длительность 2 ч.

   | Сценарий | Целевой том | ИМЯ | Duration |
   | --- | --- | --- | --- |
   | Инициализация диска с кэшем |CacheReads |RandomWrites\_1MB |2 ч |
3. Запустите тест Iometer, чтобы подготовить кэш на диске со следующими параметрами. Используйте три рабочих потока для целевого тома и задайте значение «128» для длины очереди. На вкладке "Test Setup" (Настройка теста) для параметра "Run time" (Время выполнения) установите длительность 2 ч.

   | Сценарий | Целевой том | ИМЯ | Длительность |
   | --- | --- | --- | --- |
   | Подготовка диска с кэшем |CacheReads |RandomReads\_1MB |2 ч |

После подготовки диска с кэшем выполните сценарии тестирования, перечисленные ниже. Чтобы выполнить тест Iometer, используйте по крайней мере три рабочих потока для **каждого** целевого тома. Для каждого рабочего потока выберите целевой том, задайте длину очереди, а затем выберите одну из сохраненных спецификаций тестирования, указанных в следующей таблице, чтобы выполнить соответствующий сценарий тестирования. В таблице ниже также приведены ожидаемые результаты для значений количества операций ввода-вывода в секунду и пропускной способности при выполнении этих тестов. Во всех сценариях используется небольшой объем ввода-вывода, 8 КБ, и высокое значение длины очереди, «128».

| Сценарий тестирования | Целевой том | ИМЯ | Результат |
| --- | --- | --- | --- |
| Макс. количество операций вода-вывода в секунду при чтении |CacheReads |RandomWrites\_8K |50 000 операций ввода-вывода в секунду  |
| Макс. количество операций вода-вывода в секунду при записи |NoCacheWrites |RandomReads\_8K |64 000 операций ввода-вывода в секунду |
| Макс. количество объединенных операций ввода-вывода в секунду |CacheReads |RandomWrites\_8K |100 000 операций ввода-вывода в секунду |
| NoCacheWrites |RandomReads\_8K | &nbsp; | &nbsp; |
| Макс. скорость чтения, МБ/с |CacheReads |RandomWrites\_64K |524 МБ/с |
| Макс. скорость записи, МБ/с |NoCacheWrites |RandomReads\_64K |524 МБ/с |
| Скорость объединенных операций, МБ/с |CacheReads |RandomWrites\_64K |1000 МБ/с |
| NoCacheWrites |RandomReads\_64K | &nbsp; | &nbsp; |

Ниже приведены снимки экрана Iometer с результатами теста для сценариев, где используются объединенные операций ввода-вывода в секунду и пропускная способность.

*Максимальное количество операций ввода-вывода в секунду при объединенных операциях чтения и записи*  
![](media/premium-storage-performance/image9.png)

*Максимальная пропускная способность при объединенных операциях чтения и записи*  
![](media/premium-storage-performance/image10.png)

### <a name="fio"></a>FIO
FIO — это популярный инструмент для тестирования производительности хранилища виртуальных машин под управлением Linux. Благодаря своей гибкости он позволяет выбрать различные объемы ввода-вывода, а также порядок выполнения операций чтения и записи — последовательный или случайный. Он порождает рабочие потоки или процессы для выполнения указанных операций ввода-вывода. Можно указать тип операций ввода-вывода, которые должен выполнять каждый рабочий поток, используя файлы заданий. В примерах ниже продемонстрирован один файл задания для каждого сценария. Можно менять спецификации в этих файлах заданий, чтобы тестировать производительность при различных рабочих нагрузках хранилища класса "Премиум". В примерах используется виртуальная машина серии DS14 класса «Стандартный» под управлением **Ubuntu**. Прежде чем выполнить тестирование производительности, настройте параметры в соответствии с указаниями в начале раздела [Измерение производительности](#Benchmarking) и подготовьте кэш.

Прежде чем начать, [скачайте FIO](https://github.com/axboe/fio) и установите его на виртуальной машине.

В ОС Ubuntu выполните следующую команду:

```
apt-get install fio
```

Мы будем использовать четыре рабочих потока для выполнения операций записи и еще четыре для операций чтения на дисках. Для рабочих потоков операций записи будет использоваться трафик в томе nocache, в котором для значения кэша 10 дисков задано значение None. Для рабочих потоков операций чтения будет использоваться трафик в томе readcache, в котором для значения кэша 1 диска задано значение ReadOnly.

*Максимальное количество операций ввода-вывода в секунду при записи*  
Чтобы добиться максимального количества операций ввода-вывода в секунду при записи, создайте файл задания со следующими спецификациями. Назовите файл fiowrite.ini.

```
[global]
size=30g
direct=1
iodepth=256
ioengine=libaio
bs=8k

[writer1]
rw=randwrite
directory=/mnt/nocache
[writer2]
rw=randwrite
directory=/mnt/nocache
[writer3]
rw=randwrite
directory=/mnt/nocache
[writer4]
rw=randwrite
directory=/mnt/nocache
```

Обратите внимание на следующие ключевые аспекты, которые согласованы с рекомендациями по разработке, описанными в предыдущих разделах. Эти спецификации необходимы для выполнения максимального количества операций ввода-вывода в секунду:  

* высокое значение длины очереди: 256;  
* небольшой размер блока: 8 КБ;  
* несколько потоков, выполняющих случайные операции записи.

Выполните следующую команду, чтобы запустить тест FIO на 30 секунд:  

```
sudo fio --runtime 30 fiowrite.ini
```

Во время тестирования можно узнать количество операций ввода-вывода в секунду при записи, которое обеспечивают виртуальная машина и диски класса «Премиум». Как показано в примере ниже, максимальное количество операций ввода-вывода в секунду при записи, выполняемых виртуальной машиной DS14, — 50 000.  
    ![](media/premium-storage-performance/image11.png)

*Максимальное количество операций ввода-вывода при чтении*  
Чтобы добиться максимального значения операций ввода-вывода при чтении, создайте файл задания со следующими спецификациями. Назовите файл fioread.ini.

```
[global]
size=30g
direct=1
iodepth=256
ioengine=libaio
bs=8k

[reader1]
rw=randread
directory=/mnt/readcache
[reader2]
rw=randread
directory=/mnt/readcache
[reader3]
rw=randread
directory=/mnt/readcache
[reader4]
rw=randread
directory=/mnt/readcache
```

Обратите внимание на следующие ключевые аспекты, которые согласованы с рекомендациями по разработке, описанными в предыдущих разделах. Эти спецификации необходимы для выполнения максимального количества операций ввода-вывода в секунду:

* высокое значение длины очереди: 256;  
* небольшой размер блока: 8 КБ;  
* несколько потоков, выполняющих случайные операции записи.

Выполните следующую команду, чтобы запустить тест FIO на 30 секунд:

```
sudo fio --runtime 30 fioread.ini
```

Во время тестирования можно узнать количество операций ввода-вывода в секунду при чтении, которое обеспечивают виртуальная машина и диски класса «Премиум». Как показано в примере ниже, виртуальная машина DS14 выполняет более 64 000 операций ввода-вывода в секунду при чтении. Это количество представляет собой сочетание производительности диска и кэша.  
    ![](media/premium-storage-performance/image12.png)

*Максимальное количество операций ввода-вывода в секунду при чтении и записи*  
Чтобы добиться максимального количества операций ввода-вывода в секунду при объединенных операциях чтения и записи, создайте файл задания со следующими спецификациями. Назовите файл fioreadwrite.ini.

```
[global]
size=30g
direct=1
iodepth=128
ioengine=libaio
bs=4k

[reader1]
rw=randread
directory=/mnt/readcache
[reader2]
rw=randread
directory=/mnt/readcache
[reader3]
rw=randread
directory=/mnt/readcache
[reader4]
rw=randread
directory=/mnt/readcache

[writer1]
rw=randwrite
directory=/mnt/nocache
rate_iops=12500
[writer2]
rw=randwrite
directory=/mnt/nocache
rate_iops=12500
[writer3]
rw=randwrite
directory=/mnt/nocache
rate_iops=12500
[writer4]
rw=randwrite
directory=/mnt/nocache
rate_iops=12500
```

Обратите внимание на следующие ключевые аспекты, которые согласованы с рекомендациями по разработке, описанными в предыдущих разделах. Эти спецификации необходимы для выполнения максимального количества операций ввода-вывода в секунду:

* высокое значение длины очереди: 128;  
* небольшой размер блока: 4 КБ;  
* несколько потоков, выполняющих случайные операции чтения и записи.

Выполните следующую команду, чтобы запустить тест FIO на 30 секунд:

```
sudo fio --runtime 30 fioreadwrite.ini
```

Во время тестирования можно узнать количество операций ввода-вывода в секунду при объединенных операциях чтения и записи, которое обеспечивают виртуальная машина и диски класса «Премиум». Как показано в примере ниже, виртуальная машина DS14 выполняет более 100 000 операций ввода-вывода в секунду при объединенных операциях чтения и записи. Это количество представляет собой сочетание производительности диска и кэша.  
    ![](media/premium-storage-performance/image13.png)

*Максимальное значение объединенной пропускной способности*  
Чтобы добиться максимальной пропускной способности объединенных операций чтения и записи, используйте больший размер блока и длинную очередь с несколькими потоками, выполняющими операции чтения и записи. Можно использовать блоки размером 64 КБ и длину очереди со значением «128».

## <a name="next-steps"></a>Дальнейшие действия
Дополнительная информация о хранилище Azure класса «Премиум»:

* [Хранилище Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальной машины Azure](../articles/virtual-machines/windows/premium-storage.md)  

Если вы пользователь SQL Server, см. статьи с рекомендациями по оптимизации производительности SQL Server:

* [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](../articles/virtual-machines/windows/sql/virtual-machines-windows-sql-performance.md)
* [Хранилище Azure класса «Премиум» обеспечивает максимальную производительность SQL Server в виртуальных машинах Azure](http://blogs.technet.com/b/dataplatforminsider/archive/2015/04/23/azure-premium-storage-provides-highest-performance-for-sql-server-in-azure-vm.aspx)
