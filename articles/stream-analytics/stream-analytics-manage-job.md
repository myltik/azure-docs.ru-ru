---
title: Руководство по созданию задания Stream Analytics и управлению им с помощью портала Azure | Документация Майкрософт
description: В этом руководстве содержится комплексное описание использования Azure Stream Analytics для анализа мошеннических вызовов в потоке телефонных звонков.
services: stream-analytics
author: SnehaGunda
ms.author: sngun
manager: kfile
ms.service: stream-analytics
ms.workload: data-services
ms.topic: tutorial
ms.custom: mvc
ms.date: 04/04/2018
ms.openlocfilehash: 524b15747a275c76fec6c529e4f00d0da1b41420
ms.sourcegitcommit: 3c3488fb16a3c3287c3e1cd11435174711e92126
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/08/2018
ms.locfileid: "32778195"
---
# <a name="create-a-stream-analytics-job-to-analyze-phone-call-data-and-visualize-results-in-a-power-bi-dashboard"></a>Создание задания Stream Analytics для анализа данных телефонных звонков и визуализации результатов на панели мониторинга Power BI

В этом руководстве показано, как использовать Azure Stream Analytics для анализа примера телефонного звонка, созданного клиентским приложением. Данные телефонного звонка, созданные клиентским приложением, содержат некоторые мошеннические вызовы. Мы определим задание Stream Analytics для фильтрации таких вызовов.

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * создание примера данных телефонных звонков и их отправка в концентраторы событий Azure;  
> * Создание задания Stream Analytics   
> * настройка входных и выходных данных для задания;  
> * определение запроса для фильтрации мошеннических вызовов;  
> * тестирование и запуск задания;  
> * визуализация результатов в Power BI. 

## <a name="prerequisites"></a>предварительным требованиям

Чтобы начать, у вас должны быть следующие компоненты:

* Если у вас еще нет подписки Azure, создайте [бесплатную учетную запись Azure](https://azure.microsoft.com/free/).  
* Войдите на [портал Azure](https://portal.azure.com/).  
* Загрузите приложение генератора событий телефонных вызовов [TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip) из Центра загрузки Майкрософт или получите исходный код на сайте [GitHub](https://aka.ms/azure-stream-analytics-telcogenerator).  

## <a name="create-an-azure-event-hub"></a>Создание концентратора событий Azure 

Чтобы Stream Analytics могла проанализировать поток данных мошеннических вызовов, необходимо отправить данные в Azure. В этом руководстве данные будут отправлены в Azure с помощью [концентраторов событий Azure](https://docs.microsoft.com/azure/event-hubs/event-hubs-what-is-event-hubs). В рамках этого руководства вы создадите концентратор событий, а затем приложение генератора событий отправит данные вызовов в этот концентратор событий. Чтобы создать концентратор событий, выполните следующие действия:

1. Войдите на портал Azure.  
2. Выберите **Создать ресурс** > **Интернет вещей** > **Концентраторы событий**.  

   ![Поиск концентратора событий](media/stream-analytics-manage-job/find-eh.png)
3. Заполните область **Создание пространства имен** следующими значениями:  

   |**Параметр**  |**Рекомендуемое значение** |**Описание**  |
   |---------|---------|---------|
   |ИМЯ     | myEventHubNS        |  Уникальное имя для идентификации пространства имен концентратора событий.       |
   |Подписка     |   \<Ваша подписка\>      |   Выберите подписку Azure, в которой нужно создать концентратор событий.      |
   |Группа ресурсов     |   MyASADemoRG      |  Выберите **Создать** и введите новое имя группы ресурсов для учетной записи.       |
   |Расположение     |   Западная часть США 2      |    Расположение, в которое можно развернуть пространство имен концентратора событий.     |

4. Используйте значения по умолчанию для оставшихся параметров и нажмите кнопку **Создать**.  

   ![Создание пространства имен концентратора событий](media/stream-analytics-manage-job/create-ehns.png)

5. При завершении развертывания пространства имен перейдите к **Все ресурсы**, найдите пространство имен myEventHubNS в списке ресурсов Azure и выберите его, чтобы открыть.  
6. Затем выберите **+Концентратор событий** >  **и укажите имя** MyEventHub. Вы можете использовать другое имя. Используйте значение по умолчанию для оставшихся параметров и нажмите кнопку **Создать**, а затем ожидайте, пока развертывание не будет завершено.

   ![Создание концентратора событий](media/stream-analytics-manage-job/create-eh.png)

### <a name="grant-access-to-the-event-hub-and-get-a-connection-string"></a>Предоставление доступа к концентратору событий и получение строки подключения

Чтобы приложение смогло отправлять данные в концентраторы событий Azure, в концентраторе событий должна быть политика, обеспечивающая соответствующий доступ. Политика доступа создает строку подключения, которая включает сведения об авторизации.

1. Перейдите к **концентратору событий**, созданному на предыдущем шаге — MyEventHub, и выберите **Политики общего доступа** из области концентратора событий, а затем — **+Добавить**.  
2. Установите имя политики **Mypolicy** и выберите **Управление**, а затем — **Создать**.  

   ![Создание политики общего доступа к концентратору событий](media/stream-analytics-manage-job/create-ehpolicy.png)

3. После развертывания политики откройте ее и найдите **Строка подключения — первичный ключ**, а затем выберите **копировать** рядом со строкой подключения.  
4. Вставьте строку подключения в текстовый редактор. Эта строка подключения вам понадобится в следующем разделе.  

   Строка подключения выглядит следующим образом:

   `Endpoint=sb://<Your event hub namespace>.servicebus.windows.net/;SharedAccessKeyName=<Your shared access policy name>;SharedAccessKey=<generated key>;EntityPath=<Your event hub name>` 

   Обратите внимание, что строка подключения содержит несколько пар "ключ — значение", которые разделены точкой с запятой: Endpoint, SharedAccessKeyName, SharedAccessKey и EntityPath.  

5. Удалите пару EntityPath из строки подключения (не забудьте удалить точку с запятой после нее).

## <a name="start-the-event-generator-application"></a>Запуск приложения генератора событий

Перед запуском приложения TelcoGenerator необходимо настроить его для отправки данных в созданный ранее концентратор событий Azure.

1. Извлеките содержимое файла [TelcoGenerator.zip](http://download.microsoft.com/download/8/B/D/8BD50991-8D54-4F59-AB83-3354B69C8A7E/TelcoGenerator.zip).  
2. Откройте файл `TelcoGenerator\TelcoGenerator\telcodatagen.exe.config` в текстовом редакторе по своему выбору (если имеется более одного CONFIG-файла, убедитесь, что вы открываете нужный).  

3. Обновите элемент <appSettings> в файле конфигурации, указав следующие сведения:

   * Задайте для ключа EventHubName значение EntityPath в строке подключения.  
   * Задайте для ключа Microsoft.ServiceBus.ConnectionString строку подключения без значения EntityPath, полученного на шаге 5 в предыдущем разделе.

4. Сохраните файл.  
5. Затем откройте командное окно, перейдите в папку, в которой распаковано приложение TelcoGenerator, и введите следующую команду:

   ```
   telcodatagen.exe 1000 .2 2
   ```

   Эта команда принимает следующие параметры:
   * **Number of call data records per hour** (Число записей данных звонка в час).  
   * **Percentage of fraud Probability** (Вероятность мошенничества). Это частота моделирования приложением мошеннических вызовов. Значение .2 означает, что около 20 % записей вызовов будут мошенническими.  
   * **Duration in hours** (Продолжительность в часах). Количество часов, на протяжении которых должно выполняться приложение. Вы также можете остановить выполнение приложения, завершив процесс (CTRL+C) в командной строке.

   Через несколько секунд приложение запустит отображение записей вызовов на экране, так как будет отправлять их в концентратор событий. Данные телефонных звонков содержат следующие поля:

   |**Запись**  |**Определение**  |
   |---------|---------|
   |CallrecTime    |  Метка времени начала вызова.       |
   |SwitchNum     |  Телефонный переключатель, используемый для совершения вызова. В этом примере переключатели выражены строками, представляющими страну происхождения (США, Китай, Соединенное Королевство, Германия или Австралия).       |
   |CallingNum     |  Номер телефона звонящего.       |
   |CallingIMSI     |  Идентификатор абонента международной мобильной связи (IMSI). Это уникальный идентификатор звонящего.       |
   |CalledNum     |   Номер телефона получателя.      |
   |CalledIMSI     |  Идентификатор IMSI. Это уникальный идентификатор получателя звонка.       |

## <a name="create-a-stream-analytics-job"></a>Создание задания Stream Analytics 

Теперь, когда у вас есть поток событий звонков, можно создать задание Stream Analytics, которое считывает данные из концентратора событий.

1. Чтобы создать задание Stream Analytics, перейдите на портал Azure.  

2. Выберите **Создать ресурс** > **Интернет вещей** > **Задание Stream Analytics**.  

3. Заполните область **Новое задание Stream Analytics** такими значениями:  

   |**Параметр**  |**Рекомендуемое значение**  |**Описание**  |
   |---------|---------|---------|
   |Имя задания     |  ASATutorial       |   Уникальное имя для идентификации пространства имен концентратора событий.      |
   |Подписка    |  \<Ваша подписка\>   |   Выберите подписку Azure, в которой нужно создать задание.       |
   |Группа ресурсов   |   MyASADemoRG      |   Выберите **Use existing** (Использовать существующую) и введите новое имя группы ресурсов для учетной записи.      |
   |Расположение   |    Западная часть США 2     |      Расположение, в котором можно развернуть задание. Рекомендуется поместить задание и концентратор событий в одном регионе, чтобы достичь оптимальной производительности и не оплачивать передачу данных между регионами.      |
   |Среда размещения    | Облако        |     Задания Stream Analytics можно развернуть в облаке или на граничных устройствах. Значение "Облако" позволяет выполнять развертывание в облако Azure, а "Edge" — в пограничное устройство Центра Интернета вещей.    |
   |Единицы потоковой передачи     |    1       |      Единица потоковой передачи предоставляет вычислительные ресурсы, которые необходимы для выполнения задания. По умолчанию установлено значение 1. Чтобы узнать о масштабировании единиц потоковой передачи, ознакомьтесь со статьей [Обзор и настройка единиц потоковой передачи](stream-analytics-streaming-unit-consumption.md).      |

   ![создать задание;](media/stream-analytics-manage-job/create-a-job.png)   

4. Используйте значения по умолчанию для оставшихся параметров и нажмите кнопку **Создать**, а затем ожидайте, пока развертывание не будет завершено.

## <a name="configure-job-input"></a>Настройка входных данных для задания

Следующий шаг — определить источник входных данных, откуда задание будет считывать данные. В этом руководстве используется концентратор событий, созданный в предыдущем разделе в качестве входных данных. Выполните следующие действия, чтобы настроить входные данные для задания:

1. На портале Azure откройте область **Все ресурсы** и найдите задание Stream Analytics ASATutorial.  

2. В разделе **Топология задания** области задания Stream Analytics выберите вариант **Входные данные**.  

3. Выберите **+Add stream input** (+Добавить потоковые входные данные) (ссылочные входные данные относятся к статическим данным поиска, которые не используются в данном руководстве), **Концентратор событий**, а затем заполните область следующими значениями:  

   |**Параметр**  |**Рекомендуемое значение**  |**Описание**  |
   |---------|---------|---------|
   |Псевдоним входных данных     |  CallStream       |  Введите понятное имя для идентификации входных данных. Входной псевдоним может содержать только буквенно-цифровые символы, дефисы и знаки подчеркивания. Длина должна составлять от 3 до 63 символов.       |
   |Подписка    |   \<Ваша подписка\>      |   Выберите подписку Azure, в которой вы создали концентратор событий. Концентратор событий может находиться в той же подписке, что и задание Stream Analytics, или в другой.       |
   |Пространство имен концентратора событий    |  MyEventHubNS       |  Выберите пространство имен концентратора событий, созданного в предыдущем разделе. Все пространства имен концентраторов событий, доступные в текущей подписке, перечислены в раскрывающемся меню.       |
   |имя концентратора событий;    |   MyEventHub      |  Выберите концентратор событий, который был создан в предыдущем разделе. Все концентраторы событий, доступные в текущей подписке, перечислены в раскрывающемся меню.       |
   |Имя политики концентратора событий   |  Mypolicy       |  Выберите политику общего доступа концентратора событий, созданную в предыдущем разделе. Все политики концентраторов событий, доступные в текущей подписке, перечислены в раскрывающемся меню.       |

   ![Настройка входных данных](media/stream-analytics-manage-job/configure-input.png) 

4. Используйте значения по умолчанию для оставшихся параметров и выберите **Сохранить**, а затем ожидайте, пока развертывание не будет завершено.

## <a name="configure-job-output"></a>Настройка выходных данных для задания 

Осталось определить приемник выходных данных для задания, т. е. место для записи преобразованных данных. В этом руководстве результаты выводятся в Power BI, а данные визуализируются. Выполните следующие действия, чтобы настроить выходные данные для задания:

1. На портале Azure откройте область **Все ресурсы** и найдите задание Stream Analytics ASATutorial.  

2. В разделе **Топология задания** области задания Stream Analytics выберите вариант **Выходные данные**.  

3. Выберите **+Добавить** > **Power BI** и заполните форму следующими сведениями (вы можете указать понятное имя, чтобы идентифицировать псевдоним выходных данных, имя набора данных и имя таблицы, как показано в таблице) и нажмите кнопку **Авторизовать**:  

   |**Параметр**  |**Рекомендуемое значение**  |
   |---------|---------|---------|
   |Псевдоним выходных данных  |  MyPBIoutput  |
   |Имя набора данных  |   ASAdataset  | 
   |Имя таблицы |  ASATable  | 

   ![Настройка выходных данных](media/stream-analytics-manage-job/configure-output.png)  

4. Когда вы нажмете кнопку **Авторизовать**, откроется всплывающее окно и вам будет предложено ввести учетные данные для проверки подлинности учетной записи Power BI. Когда авторизация будет выполнена успешно, **сохраните** параметры. 

## <a name="define-a-query-to-analyze-input-data"></a>Определение запроса для анализа входных данных

Настроив задание Stream Analytics для считывания входящего потока данных, необходимо создать преобразование, которое анализирует данные в реальном времени. Определите запрос преобразования с помощью [языка запросов Stream Analytics](https://msdn.microsoft.com/library/dn834998.aspx). В этом руководстве определяется запрос, который обнаруживает мошеннические вызовы в данных телефона. 

В этом примере мы считаем, что мошеннические вызовы — это те вызовы, которые поступают от одного и того же пользователя, но из разных расположений и с задержкой между двумя вызовами в пять секунд. Например, один и тот же пользователь не может законным путем сделать звонок из США и Австралии одновременно. Чтобы определить запрос преобразования для задания Stream Analytics, выполните следующие действия:

1. На портале Azure откройте область **Все ресурсы** и откройте задание Stream Analytics **ASATutorial**, созданное ранее.  

2. В разделе **Топология задания** области задания Stream Analytics выберите вариант **Запрос**. Во всплывающем окне перечислены входные и выходные данные, настроенные для задания, и можно создать запрос, преобразовывающий входной поток.  

3. Затем замените имеющийся запрос в редакторе следующими данными. Этот запрос выполняет самосоединение с данными вызова за 5-секундный интервал:

   ```sql
   SELECT System.Timestamp AS WindowEnd, COUNT(*) AS FraudulentCalls
   INTO "MyPBIoutput"
   FROM "CallStream" CS1 TIMESTAMP BY CallRecTime
   JOIN "CallStream" CS2 TIMESTAMP BY CallRecTime
   ON CS1.CallingIMSI = CS2.CallingIMSI
   AND DATEDIFF(ss, CS1, CS2) BETWEEN 1 AND 5
   WHERE CS1.SwitchNum != CS2.SwitchNum
   GROUP BY TumblingWindow(Duration(second, 1))
   ```

   Чтобы проверить наличие мошеннических вызовов, нужно выполнить самосоединение потоковых данных на основе значения `CallRecTime`. Затем вы можете найти записи вызовов, в которых значение `CallingIMSI` (исходящий номер) остается неизменным, а значение `SwitchNum` (страна происхождения) изменяется. При использовании операции JOIN с потоковой передачей данных соединение должно предоставить некоторые ограничения в отношении того, насколько совпадающие строки могут быть разделены по времени. Так как поток данных бесконечен, укажите ограничения по времени для связи в предложении ON операции соединения с помощью функции [DATEDIFF](https://msdn.microsoft.com/azure/stream-analytics/reference/datediff-azure-stream-analytics). 

   Этот запрос не отличается от обычного соединения SQL, за исключением функции DATEDIFF. Функция DATEDIFF, используемая в этом запросе, относится к Stream Analytics и должна находиться внутри предложения `ON...BETWEEN`.  

4. **Сохраните** запрос.  

   ![Определение запроса](media/stream-analytics-manage-job/define-query.png) 

## <a name="test-your-query"></a>Тестирование запроса

Запрос можно протестировать из редактора запросов. Для этого вам потребуется пример данных. В рамках этого пошагового руководства вы извлечете пример данных из потока телефонных звонков, поступающего в концентратор событий. Выполните следующие действия, чтобы проверить запрос:

1. Проверьте, чтобы приложение TelcoGenerator работало и создавало записи телефонных звонков.  

2. В области **Запрос** выберите точки рядом с входными данными CallStream, а затем выберите **Sample data from input** (Пример данных со входа). Откроется область, в которой можно указать количество образцов данных для чтения из входного потока.  

   ![Пример входных данных](media/stream-analytics-manage-job/sample-input-data.png)  

3. Задайте для параметра **Минуты** значение "3" и нажмите кнопку **ОК**. Данные за три минуты будут созданы из входного потока, а вы получите уведомление, когда они будут готовы. Состояние выборки можно просмотреть на панели уведомлений. 

   Образец данных хранится временно и доступен, пока открыто окно запроса. Если закрыть окно запроса, образец данных будет удален и придется создать новый набор образцов данных. В качестве альтернативы можно получить JSON-файл, содержащий пример данных, с помощью [GitHub](https://github.com/Azure/azure-stream-analytics/blob/master/Sample Data/telco.json), а затем отправить этот файл для использования в качестве образца данных для псевдонима входных данных CallStream.  

4. Выберите **Тест**, чтобы проверить запрос. Должны отобразиться результаты выходных данных, как показано на этом снимке экрана:  

   ![Выходные данные тестирования](media/stream-analytics-manage-job/test-output.png)

## <a name="start-the-job-and-visualize-output"></a>Запуск задания и визуализация выходных данных

1. Перейдите к панели задания **Обзор** и выберите **Запуск**, чтобы запустить задание.  

2. Выберите время начала создания выходных данных задания **Сейчас**, а затем — **Запуск**. Задание будет запущено через несколько минут, и вы сможете просматривать состояние на панели уведомлений.  

3. После успешного выполнения задания перейдите на сайт [Powerbi.com](https://powerbi.com/) и войдите с помощью рабочей или учебной учетной записи. Если результаты запроса задания Stream Analytics были выведены, вы увидите уже созданный набор данных. Перейдите на вкладку **Наборы данных**, где можно просмотреть набор данных ASAdataset.  

4. В рабочей области выберите **+Создать**. Создайте панель мониторинга и назовите ее "Мошеннические вызовы". Добавьте две плитки на эту панель мониторинга: одна будет использоваться для просмотра количества мошеннических звонков в данном экземпляре, а вторая — для визуализации графика.  

5. В верхней части окна выберите **Добавить плитку**, а затем **Пользовательские данные потоковой передачи**, нажмите кнопку "Далее", выберите **ASAdataset**, для типа визуализации выберите **Карточка**, а поля задайте как **fraudulentcalls**. Нажмите кнопку **Далее** и введите имя плитки, а затем выберите **Применить**.  

   ![Создание плиток](media/stream-analytics-manage-job/create-tiles.png)

6. Выполните предыдущий шаг снова, выбрав следующие параметры:
   * В поле "Тип визуализации" выберите "График".  
   * Добавьте ось и выберите **windowend**.  
   * Добавьте значение и выберите **fraudulentcalls**.  
   * В списке **Отображаемый интервал времени** укажите последние 10 минут.  

7. После добавления обоих плиток панель мониторинга будет выглядеть, как на следующем снимке экрана. Вы заметите, что если приложение отправки концентратора событий и приложение Streaming Analytics запущены, панель мониторинга PowerBI будет периодически обновляться по мере поступления новых данных.  

   ![Результаты Power BI](media/stream-analytics-manage-job/power-bi-results.png)

## <a name="embedding-your-powerbi-dashboard-in-a-web-application"></a>Внедрение панели мониторинга Power BI в веб-приложение

В этой части руководства для внедрения панели мониторинга используется пример веб-приложения [ASP.NET](http://asp.net/), созданный командой Power BI. Дополнительные сведения о внедрении панелей мониторинга см. в [этой статье](https://docs.microsoft.com/power-bi/developer/embedding).

В руководстве мы будем следовать инструкциям для пользователя, владеющего приложением данных. Чтобы настроить приложение, перейдите к репозиторию GitHub [PowerBI-Developer-Samples](https://github.com/Microsoft/PowerBI-Developer-Samples) и следуйте инструкциям в разделе **User Owns Data** (Пользователь владеет данными) (используйте URL-адреса переадресации и домашней страницы в подразделе **subsection-dashboard-web-app**). Так как мы используем пример панели мониторинга, используйте пример кода integrate-dashboard-web-app, который находится в [репозиторий GitHub](https://github.com/Microsoft/PowerBI-Developer-Samples/tree/master/User Owns Data/integrate-dashboard-web-app).
Когда приложение будет запущено в браузере, выполните следующие действия, чтобы вставить созданную ранее панель инструментов на веб-страницу:

1. Выберите **Sign in to Power BI** (Вход в Power BI), что предоставит приложению доступ к панелям мониторинга в учетной записи Power BI.  

2. Нажмите кнопку **Get Dashboards** (Получить панели мониторинга), после чего панели мониторинга учетной записи отобразятся в таблице. Найдите имя панели мониторинга, которая была создана ранее (powerbi-embedded-dashboard), и скопируйте соответствующий **EmbedUrl**.  

3. Наконец, вставьте **EmbedUrl** в соответствующее текстовое поле и выберите **Embed Dashboard** (Внедрение панели мониторинга). Теперь та же панель мониторинга будет внедрена в веб-приложение.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве был создан пример задания Stream Analytics, проанализированы входные данные и представлены результаты на панели мониторинга Power BI. Чтобы узнать больше о заданиях Stream Analytics, перейдите к следующему руководству:

> [!div class="nextstepaction"]
> [Запуск решения "Функции Azure" из заданий Azure Stream Analytics](stream-analytics-with-azure-functions.md)
