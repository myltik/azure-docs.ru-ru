---
title: Обзор и настройка единиц потоковой передачи в Azure Stream Analytics
description: В этой статье описывается настройка единиц потоковой передачи и другие факторы, влияющие на производительность в Azure Stream Analytics.
services: stream-analytics
author: JSeb225
ms.author: jeanb
manager: kfile
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/20/2017
ms.openlocfilehash: ede0c0aa7b0e795760123246366f947889224b2d
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="understand-and-adjust-streaming-units"></a>Обзор и настройка единиц потоковой передачи

Azure Stream Analytics вычисляет показатель производительности при выполнении задания в единицах потоковой передачи, представляющих вычислительные ресурсы, которые используются для выполнения заданий. Единицы потоковой передачи предоставляют способ описания относительной мощности обработки события, основываясь на измерении загрузки ЦП, памяти и скорости чтения и записи. Эта емкость позволяет сосредоточиться на логике запросов. При этом вам не нужно знать рекомендации по производительности уровня хранилища, выделять память для задания вручную и определять приблизительное число ядер ЦП, необходимых для своевременного выполнения задания.

Для обеспечения потоковой обработки с низкой задержкой в задачах Azure Stream Analytics обработка выполняется в памяти. При нехватке памяти выполнение потокового задания завершается с ошибкой. Поэтому для производственного задания важно отслеживать использование ресурсов потокового задания и следить за тем, чтобы было выделено достаточное количество ресурсов для непрерывного выполнения заданий.

Метрика — это число в процентах от 0% до 100%. Для потокового задания, использующего минимальный объем памяти, метрика процентного использования единиц потоковой передачи обычно составляет от 10% до 20%. Лучше держать показатель метрики ниже 80% с учетом случайных всплесков.  Вы можете установить предупреждение по метрике (дополнительные сведения о настройке оповещений метрик см. [здесь](https://docs.microsoft.com/azure/monitoring-and-diagnostics/insights-alerts-portal)).



## <a name="configure-stream-analytics-streaming-units-sus"></a>Настройка единиц потоковой передачи Stream Analytics
1. Войдите на [портал Azure](http://portal.azure.com/).
2. В списке ресурсов найдите задание Stream Analytics для масштабирования и откройте его. 
3. В колонке задания в разделе "Настройка" щелкните **Масштаб**. 

    ![Настройка задания Stream Analytics на портале Azure][img.stream.analytics.preview.portal.settings.scale]
    
4. Используйте ползунок, чтобы задать количество единиц потоковой передачи для задания. Обратите внимание, что существуют определенные ограничения параметров единиц потоковой передачи. 


## <a name="monitor-job-performance"></a>Мониторинг производительности задания
На портале Azure можно отслеживать пропускную способность задания:

![Отслеживание заданий Azure Stream Analytics][img.stream.analytics.monitor.job]

Рассчитайте ожидаемую пропускную способность рабочей нагрузки. Если пропускная способность меньше, чем ожидалось, настройте входную секцию и запрос, а также добавьте в задание дополнительные единицы потоковой передачи.


## <a name="how-many-sus-are-required-for-a-job"></a>Сколько единиц потоковой передачи требуется для задания?

Выбор числа единиц потоковой передачи, требуемых для конкретного задания, зависит от конфигурации входных данных и запроса, определенного в задании. В колонке **Масштаб** можно задать требуемое число единиц потоковой передачи. Мы рекомендуем выделять больше единиц потоковой передачи, чем требуется. Модуль обработки Stream Analytics оптимизирует задержки и пропускную способность за счет выделения дополнительной памяти.

В общем лучше всего начать с 6 единиц потоковой передачи для запросов, не использующих **PARTITION BY**. Затем определите "золотую середину", используя метод проб и ошибок, при котором вы изменяете число единиц потоковой передачи после передачи репрезентативного объема данных и просмотра метрики процента использования единицы потоковой передачи.

Дополнительные сведения о выборе оптимального числа единиц потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности](stream-analytics-scale-jobs.md).

> [!Note]
> Выбор необходимого количества единиц потоковой передачи для конкретного задания зависит от конфигурации секции для входных данных и запроса, определенного для задания. Вы можете выбрать для задания количество единиц потоковой передачи согласно указанной квоте. По умолчанию каждая подписка Azure включает в себя квоту до 200 единиц потоковой передачи для всех заданий аналитики в определенном регионе. Чтобы увеличить количество единиц потоковой передачи для своей подписки, свяжитесь со [службой технической поддержки Майкрософт](http://support.microsoft.com). Для задания допустимые значения количества начинаются с 1, 3, 6 и затем по возрастающей с шагом в 6.



## <a name="factors-increasing-su-utilization"></a>Факторы, влияющие на увеличение процента использования единиц потоковой передачи 
### <a name="stateful-query-logic"></a>Логика запроса с отслеживанием состояния 
Одной из уникальных возможностей задания Azure Stream Analytics является выполнение обработки с учетом состояния, например агрегаты данных на основе периодов, темпоральные соединения и темпоральные аналитические функции. Каждый из этих операторов сохраняет некоторые состояния. 
#### <a name="windowed-aggregates"></a>Агрегаты данных на основе периодов
Размер состояния агрегата данных на основе периодов пропорционален числу групп (кратность) в группе оператора. Например, в следующем запросе число, связанное с clusterid, является кратностью запроса. 

    SELECT count(*)
    FROM input 
    GROUP BY  clusterid, tumblingwindow (minutes, 5)


Для решения проблем, вызванных большой кратностью в предыдущем запросе, можно отправить события, разделенные по clusterid, в концентратор событий и развернуть запрос, позволив системе обрабатывать каждый входной раздел по отдельности, используя ключевое слово **PARTITION BY**, как показано в следующем примере:


    SELECT count(*) 
    FROM PARTITION BY PartitionId
    GROUP BY PartitionId, clusterid, tumblingwindow (minutes, 5)

Секционированный запрос распределяется между несколькими узлами. В результате число идентификаторов clusterid, попадающих в каждый узел, уменьшается, тем самым уменьшая кратность группы по оператору. 

Разделы концентратора событий должны быть разделены с помощью ключа группирования, чтобы вам не нужно было выполнять шаг по уменьшению. Дополнительная информация описана [здесь](https://docs.microsoft.com/azure/event-hubs/event-hubs-overview). 
#### <a name="temporal-join"></a>Темпоральное соединение
Размер состояния темпорального соединения пропорционален количеству событий в области темпорального колебания соединения, которое представляет собой частоту входных событий, умноженную на размер области колебания. 

Число несопоставленных событий в соединении влияет на использование памяти для выполнения запроса. Следующий запрос ищет просмотры рекламы, которые привели к переходам:

    SELECT clicks.id
    FROM clicks 
    INNER JOIN impressions ON impressions.id = clicks.id AND DATEDIFF(hour, impressions, clicks) between 0 AND 10.

Например, возможно, рекламу просмотрело множество людей, но только некоторые щелкнули ее. При этом все события требуется хранить в рамках временного окна. Объем используемой памяти пропорционален размеру окна и частоте событий. 

Чтобы исправить эту ошибку, отправьте в концентратор событий события, разделенные с помощью ключей соединения (в этом случае id), и разверните запрос, разрешив системе обрабатывать каждый входной раздел отдельно, используя **PARTITION BY**, как показано ниже:

    SELECT clicks.id
    FROM clicks PARTITION BY PartitionId
    INNER JOIN impressions PARTITION BY PartitionId 
    ON impression.PartitionId = clicks.PartitionId AND impressions.id = clicks.id AND DATEDIFF(hour, impressions, clicks) between 0 AND 10 
</code>

Секционированный запрос распределяется между несколькими узлами. В результате уменьшается не только число событий, поступающих на каждый узел, но и размер состояния, сохраненного в окне соединения. 
#### <a name="temporal-analytic-function"></a>Темпоральная аналитическая функция
Размер состояния темпоральной аналитической функции пропорционален частоте событий умноженной на длительность. Решение аналогично решению для темпорального соединения. Вы можете развернуть запрос, используя **PARTITION BY**. 

### <a name="out-of-order-buffer"></a>Неупорядоченный буфер 
Пользователь может настроить размер неупорядоченного буфера на панели конфигурации упорядочения событий. Буфер используется для хранения входных данных в течение определенного периода и изменения их порядка. Размер буфера пропорционален частоте ввода событий, умноженной на размер неупорядоченного окна. Размер окна по умолчанию равен 0. 

Чтобы решить эту проблему, разверните запрос с помощью **PARTITION BY**. Секционированный запрос распределяется между несколькими узлами. В результате уменьшается не только число событий, поступающих на каждый узел, но и количество событий в каждом упорядоченном буфере. 

### <a name="input-partition-count"></a>Количество входящих разделов 
Для каждого входящего раздела входных данных задания предусмотрен буфер. Чем больше количество входных разделов, тем больше ресурсов потребляет задание. Для каждой единицы потоковой передачи Azure Stream Analytics может обработать входные данные со скоростью примерно 1 МБ/с, поэтому может потребоваться сопоставить количество единиц потоковой передачи Azure Stream Analytics с номером раздела вашего концентратора событий. Как правило задания на 1 единицу потоковой передачи достаточно для концентратора событий с двумя разделами (минимальное значение для концентратора событий). Если концентратор событий содержит большее число разделов, задание ASA потребляет больше ресурсов, но не всегда использует дополнительную пропускную способность, предоставляемую концентратором событий. Для задания с 6 единицами потоковой передачи может понадобиться 4 или 8 разделов из концентратора событий. Использование концентратора событий с 16 разделами или больше в задании на 1 единицу потоковой передачи часто способствует чрезмерному использованию ресурсов, чего следует избегать. 

### <a name="reference-data"></a>Ссылочные данные 
Ссылочные данные в ASA загружаются в память для быстрого поиска. В текущей реализации для каждой операции соединения со ссылочными данными их копия сохраняется в памяти даже при соединении с использованием одних ссылочных данных несколько раз. Для запросов, содержащих **PARTITION BY**, каждый раздел имеет копию ссылочных данных, поэтому разделы полностью разделены. Если вы несколько раз присоединяетесь к ссылочным данным с несколькими разделами, то из-за эффекта увеличения использование памяти может быстро вырасти.  

#### <a name="use-of-udf-functions"></a>Использование определяемых пользователем функций
При добавлении определяемой пользователем функции Azure Stream Analytics загружает в память среду выполнения JavaScript. Это влияет на процент единиц потоковой передачи.


## <a name="get-help"></a>Получение справки
За дополнительной помощью обращайтесь на наш [форум Azure Stream Analytics](https://social.msdn.microsoft.com/Forums/azure/home?forum=AzureStreamAnalytics).

## <a name="next-steps"></a>Дополнительная информация
* [Leverage query parallelization in Azure Stream Analytics](stream-analytics-parallelization.md) (Использование параллелизации запросов в Azure Stream Analytics)
* [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md)

<!--Image references-->

[img.stream.analytics.monitor.job]: ./media/stream-analytics-scale-jobs/StreamAnalytics.job.monitor-NewPortal.png
[img.stream.analytics.configure.scale]: ./media/stream-analytics-scale-jobs/StreamAnalytics.configure.scale.png
[img.stream.analytics.perfgraph]: ./media/stream-analytics-scale-jobs/perf.png
[img.stream.analytics.streaming.units.scale]: ./media/stream-analytics-scale-jobs/StreamAnalyticsStreamingUnitsExample.jpg
[img.stream.analytics.preview.portal.settings.scale]: ./media/stream-analytics-scale-jobs/StreamAnalyticsPreviewPortalJobSettings-NewPortal.png   
