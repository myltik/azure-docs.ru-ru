---
title: Обзор и настройка единиц потоковой передачи в Azure Stream Analytics
description: В этой статье описывается настройка единиц потоковой передачи и другие факторы, влияющие на производительность в Azure Stream Analytics.
services: stream-analytics
author: JSeb225
ms.author: jeanb
manager: kfile
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/12/2018
ms.openlocfilehash: c96e9825cddd0b60e67cd4752fab8f440ceaae76
ms.sourcegitcommit: 1362e3d6961bdeaebed7fb342c7b0b34f6f6417a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2018
---
# <a name="understand-and-adjust-streaming-units"></a>Обзор и настройка единиц потоковой передачи

Azure Stream Analytics вычисляет показатель производительности при выполнении задания в единицах потоковой передачи, представляющих вычислительные ресурсы, которые используются для выполнения заданий. Единицы потоковой передачи предоставляют способ описания относительной мощности обработки события, основываясь на измерении загрузки ЦП, памяти и скорости чтения и записи. Эта способность позволяет сосредоточиться на логике запросов и устраняет необходимость управления оборудованием для своевременного выполнения задания Stream Analytics.

Для обеспечения потоковой обработки с низкой задержкой в задачах Azure Stream Analytics обработка выполняется в памяти. При нехватке памяти выполнение потокового задания завершается с ошибкой. Поэтому для производственного задания важно отслеживать использование ресурсов потокового задания и следить за тем, чтобы было выделено достаточное количество ресурсов для непрерывного выполнения заданий.

Метрика — это число в процентах от 0% до 100%. Для потокового задания, использующего минимальный объем памяти, метрика процентного использования единиц потоковой передачи обычно составляет от 10% до 20%. Лучше держать показатель метрики ниже 80% с учетом случайных всплесков. Корпорация Майкрософт рекомендует настроить отправку предупреждения при использовании единиц потоковой передачи на уровне 80 % для предотвращения нехватки ресурсов. Дополнительные сведения см. в статье [Настройка оповещений для заданий Azure Stream Analytics](stream-analytics-set-up-alerts.md).

## <a name="configure-stream-analytics-streaming-units-sus"></a>Настройка единиц потоковой передачи Stream Analytics
1. Войдите на [портал Azure](http://portal.azure.com/).

2. В списке ресурсов найдите задание Stream Analytics для масштабирования и откройте его. 

3. На странице задания под заголовком **Настройка** выберите **Масштаб**. 

    ![Настройка задания Stream Analytics на портале Azure][img.stream.analytics.preview.portal.settings.scale]
    
4. Используйте ползунок, чтобы задать количество единиц потоковой передачи для задания. Обратите внимание, что существуют определенные ограничения параметров единиц потоковой передачи. 

## <a name="monitor-job-performance"></a>Мониторинг производительности задания
На портале Azure можно отслеживать пропускную способность задания:

![Отслеживание заданий Azure Stream Analytics][img.stream.analytics.monitor.job]

Рассчитайте ожидаемую пропускную способность рабочей нагрузки. Если пропускная способность меньше, чем ожидалось, настройте входную секцию и запрос, а также добавьте в задание дополнительные единицы потоковой передачи.

## <a name="how-many-sus-are-required-for-a-job"></a>Сколько единиц потоковой передачи требуется для задания?

Выбор числа единиц потоковой передачи, требуемых для конкретного задания, зависит от конфигурации входных данных и запроса, определенного в задании. В колонке **Масштаб** можно задать требуемое число единиц потоковой передачи. Мы рекомендуем выделять больше единиц потоковой передачи, чем требуется. Модуль обработки Stream Analytics оптимизирует задержки и пропускную способность за счет выделения дополнительной памяти.

В общем лучше всего начать с 6 единиц потоковой передачи для запросов, не использующих **PARTITION BY**. Затем определите "золотую середину", используя метод проб и ошибок, при котором вы изменяете число единиц потоковой передачи после передачи репрезентативного объема данных и просмотра метрики процента использования единицы потоковой передачи.

Дополнительные сведения о выборе оптимального числа единиц потоковой передачи см. в статье [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности](stream-analytics-scale-jobs.md).

> [!Note]
> Выбор необходимого количества единиц потоковой передачи для конкретного задания зависит от конфигурации секции для входных данных и запроса, определенного для задания. Вы можете выбрать для задания количество единиц потоковой передачи согласно указанной квоте. По умолчанию каждая подписка Azure включает в себя квоту до 200 единиц потоковой передачи для всех заданий аналитики в определенном регионе. Чтобы увеличить количество единиц потоковой передачи для своей подписки, свяжитесь со [службой технической поддержки Майкрософт](http://support.microsoft.com). Для задания допустимые значения количества начинаются с 1, 3, 6 и затем по возрастающей с шагом в 6.

## <a name="factors-that-increase-su-utilization"></a>Факторы, повышающие процент использования единиц потоковой передачи 

Элементы темпорального запроса (ориентированные на время) являются основным набором операторов с отслеживанием состояния, которые предоставляет Stream Analytics. Stream Analytics контролирует состояние этих операций изнутри от имени пользователя, управляя уровнем потребления памяти, контрольными точками для обеспечения устойчивости и восстановлением состояния во время обновления. Несмотря на то что Stream Analytics полностью управляет состоянием, существует несколько рекомендаций, которые следует учитывать пользователям.

## <a name="stateful-query-logic-in-temporal-elements"></a>Логика запроса с отслеживанием состояния во временных элементах
Одной из уникальных возможностей задания Azure Stream Analytics является выполнение обработки с учетом состояния, например агрегаты данных на основе периодов, темпоральные соединения и темпоральные аналитические функции. Каждый из этих операторов сохраняет сведения о состоянии. Максимальный период времени для этих элементов запроса составляет семь дней. 

Концепция временного окна представлена в следующих элементах запросов Stream Analytics.
1. Агрегаты данных на основе периодов (оператор группирования GROUP BY по "переворачивающимся", "прыгающим" и "скользящим" окнам).

2. Темпоральные соединения: функция JOIN с DATEDIFF.

3. Темпоральные аналитические функции: ISFIRST, LAST и LAG с LIMIT DURATION.

Следующие факторы влияют на объем памяти (элемент метрики единиц потоковой передачи), потребляемый заданиями Stream Analytics.

## <a name="windowed-aggregates"></a>Агрегаты данных на основе периодов
Объем потребляемой памяти (размер состояния) для агрегата данных на основе периодов не всегда прямо пропорционален периоду. На самом деле, потребляемая память пропорциональна кратности данных или количеству групп в каждом периоде.


Например, в следующем запросе число, связанное с `clusterid`, является кратностью запроса. 

   ```sql
   SELECT count(*)
   FROM input 
   GROUP BY  clusterid, tumblingwindow (minutes, 5)
   ```

Для решения проблем, вызванных большой кратностью в предыдущем запросе, можно отправить события, разделенные по `clusterid`, в концентратор событий и развернуть запрос, позволив системе обрабатывать каждый входной раздел по отдельности, используя ключевое слово **PARTITION BY**, как показано в следующем примере:

   ```sql
   SELECT count(*) 
   FROM PARTITION BY PartitionId
   GROUP BY PartitionId, clusterid, tumblingwindow (minutes, 5)
   ```

Секционированный запрос распределяется между несколькими узлами. В результате число значений `clusterid`, попадающих в каждый узел, уменьшается, тем самым уменьшая кратность группы по оператору. 

Разделы концентратора событий должны быть разделены с помощью ключа группирования, чтобы вам не нужно было выполнять шаг по уменьшению. Дополнительные сведения см. в статье [Что такое концентраторы событий?](../event-hubs/event-hubs-what-is-event-hubs.md) 

## <a name="temporal-joins"></a>Временные соединения
Потребляемая память (размер состояния) темпорального соединения пропорциональна количеству событий в области темпорального колебания соединения, которое представляет собой частоту входных событий, умноженную на размер области колебания. Другими словами, память, потребляемая соединением, пропорциональна диапазону времени DateDiff, умноженному на среднюю частоту событий.

Число несопоставленных событий в соединении влияет на использование памяти для выполнения запроса. Следующий запрос ищет просмотры рекламы, которые привели к переходам:

   ```sql
   SELECT clicks.id
   FROM clicks 
   INNER JOIN impressions ON impressions.id = clicks.id AND DATEDIFF(hour, impressions, clicks) between 0 AND 10.
   ```

Например, возможно, рекламу просмотрело множество людей, но только некоторые щелкнули ее. При этом все события требуется хранить в рамках временного окна. Объем используемой памяти пропорционален размеру окна и частоте событий. 

Чтобы исправить эту ошибку, отправьте в концентратор событий события, разделенные с помощью ключей соединения (в этом случае id), и разверните запрос, разрешив системе обрабатывать каждый входной раздел отдельно, используя **PARTITION BY**, как показано ниже:

   ```sql
   SELECT clicks.id
   FROM clicks PARTITION BY PartitionId
   INNER JOIN impressions PARTITION BY PartitionId 
   ON impression.PartitionId = clicks.PartitionId AND impressions.id = clicks.id AND DATEDIFF(hour, impressions, clicks) between 0 AND 10 
   ```

Секционированный запрос распределяется между несколькими узлами. В результате уменьшается не только число событий, поступающих на каждый узел, но и размер состояния, сохраненного в окне соединения. 

## <a name="temporal-analytic-functions"></a>Темпоральные аналитические функции
Потребляемая память (размер состояния) темпоральной аналитической функции пропорциональна частоте событий, умноженной на длительность. Память, потребляемая аналитическими функциями, не пропорциональна периоду, но пропорциональна количеству разделов в каждом периоде.

Решение аналогично решению для темпорального соединения. Вы можете развернуть запрос, используя **PARTITION BY**. 

## <a name="out-of-order-buffer"></a>Неупорядоченный буфер 
Пользователь может настроить размер неупорядоченного буфера на панели конфигурации упорядочения событий. Буфер используется для хранения входных данных в течение определенного периода и изменения их порядка. Размер буфера пропорционален частоте ввода событий, умноженной на размер неупорядоченного окна. Размер окна по умолчанию равен 0. 

Для устранения переполнения неупорядоченного буфера нужно развернуть запрос с помощью ключевого слова **PARTITION BY**. Секционированный запрос распределяется между несколькими узлами. В результате уменьшается не только число событий, поступающих на каждый узел, но и количество событий в каждом упорядоченном буфере. 

## <a name="input-partition-count"></a>Количество входящих разделов 
Для каждого входящего раздела входных данных задания предусмотрен буфер. Чем больше количество входных разделов, тем больше ресурсов потребляет задание. Для каждой единицы потоковой передачи Azure Stream Analytics может обработать примерно 1 МБ входных данных в секунду. Таким образом можно выполнить оптимизацию, сопоставив число единиц потоковой передачи Stream Analytics с числом разделов в концентраторе событий. 

Как правило, задания, настроенного с одной единицей потоковой передачи, достаточно для концентратора событий с двумя разделами (минимальное требование для концентратора событий). Если концентратор событий содержит большее число разделов, задание Stream Analytics потребляет больше ресурсов, но не всегда использует дополнительную пропускную способность, предоставляемую концентратором событий. 

Для задания с 6 единицами потоковой передачи может понадобиться 4 или 8 разделов из концентратора событий. Однако избегайте создания слишком большого количества ненужных разделов, так как это приводит к чрезмерному использованию ресурсов. Например, концентратор событий с 16 разделами (и больше) в задании Stream Analytics с 1 единицей потоковой передачи. 

## <a name="reference-data"></a>Ссылочные данные 
Ссылочные данные в ASA загружаются в память для быстрого поиска. В текущей реализации для каждой операции соединения со ссылочными данными их копия сохраняется в памяти даже при соединении с использованием одних ссылочных данных несколько раз. Для запросов, содержащих **PARTITION BY**, каждый раздел имеет копию ссылочных данных, поэтому разделы полностью разделены. Если вы несколько раз присоединяетесь к ссылочным данным с несколькими разделами, то из-за эффекта увеличения использование памяти может быстро вырасти.  

### <a name="use-of-udf-functions"></a>Использование определяемых пользователем функций
При добавлении определяемой пользователем функции Azure Stream Analytics загружает в память среду выполнения JavaScript. Это влияет на процент единиц потоковой передачи.

## <a name="next-steps"></a>Дополнительная информация
* [Leverage query parallelization in Azure Stream Analytics](stream-analytics-parallelization.md) (Использование параллелизации запросов в Azure Stream Analytics)
* [Масштабирование заданий Azure Stream Analytics для повышения пропускной способности базы данных](stream-analytics-scale-jobs.md)

<!--Image references-->

[img.stream.analytics.monitor.job]: ./media/stream-analytics-scale-jobs/StreamAnalytics.job.monitor-NewPortal.png
[img.stream.analytics.configure.scale]: ./media/stream-analytics-scale-jobs/StreamAnalytics.configure.scale.png
[img.stream.analytics.perfgraph]: ./media/stream-analytics-scale-jobs/perf.png
[img.stream.analytics.streaming.units.scale]: ./media/stream-analytics-scale-jobs/StreamAnalyticsStreamingUnitsExample.jpg
[img.stream.analytics.preview.portal.settings.scale]: ./media/stream-analytics-scale-jobs/StreamAnalyticsPreviewPortalJobSettings-NewPortal.png   
