---
title: Обнаружение аномалий в Azure Stream Analytics (предварительная версия)
description: В этой статье объясняется, как обнаруживать аномалии с помощью Azure Stream Analytics в сочетании со службой "Машинное обучение Azure".
services: stream-analytics
author: dubansal
ms.author: dubansal
manager: kfile
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/09/2018
ms.openlocfilehash: e7274e4507d901a209ed5832e98ca630feefda4f
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
ms.locfileid: "31420101"
---
# <a name="anomaly-detection-in-azure-stream-analytics"></a>Обнаружение аномалий в Azure Stream Analytics

> [!IMPORTANT]
> Эта функция доступна в предварительной версии. Мы не рекомендуем использовать ее с рабочими нагрузками.

Оператор **AnomalyDetection** позволяет обнаруживать разные типы аномалий в потоках событий. Например, медленное сокращение свободной памяти в течение длительного времени может свидетельствовать об утечке памяти. Также может значительно увеличиваться или уменьшаться число запросов к веб-службе, которые обычно демонстрируют стабильность.  

Оператор AnomalyDetection обнаруживает аномалии трех типов: 

* **Двунаправленное изменение уровня.** Продолжительное увеличение или уменьшение уровня значений (восходящее и нисходящее). Это значение не определяется во время пиков или спадов. Эти события относятся к мгновенным или кратковременным изменениям.  

* **Медленная положительная тенденция.** Медленное увеличение тенденции со временем.  

* **Медленная отрицательная тенденция.** Медленное снижение тенденции со временем.  

При использовании оператора AnomalyDetection необходимо указать предложение **Limit Duration**. Это предложение указывает, какой интервал времени (от текущего события) необходимо учитывать при обнаружении аномалий. При необходимости с помощью предложения  **When**  этот оператор можно ограничить только теми событиями, которые соответствуют определенному свойству или условию. Кроме того, он может обрабатывать отдельные группы событий на основе ключа, указанного в предложении  **Partition by** . Обучение и прогнозирование в каждой секции выполняется независимо. 

## <a name="syntax-for-anomalydetection-operator"></a>Синтаксис оператора AnomalyDetection

`ANOMALYDETECTION(<scalar_expression>) OVER ([PARTITION BY <partition key>] LIMIT DURATION(<unit>, <length>) [WHEN boolean_expression])` 

**Пример использования**  

`SELECT id, val, ANOMALYDETECTION(val) OVER(PARTITION BY id LIMIT DURATION(hour, 1) WHEN id > 100) FROM input`

### <a name="arguments"></a>Аргументы

* **scalar_expression**. Скалярное выражение, по которому выполняется обнаружение аномалий. Допустимые значения этого параметра: типы данных float или bigint, которые возвращают однозначное (скалярное) значение. Выражение с подстановочным знаком **\*** не допускается. Скалярное выражение не должно содержать других аналитических функций или внешних функций. 

* **предложение_partition_by**. Предложение `PARTITION BY <partition key>` разделяет изучение и обучение на отдельные секции. Другими словами, для каждого значения `<partition key>` будет использоваться отдельная модель, и для изучения и обучения в этой модели будут использоваться только события с этим значением. Например, следующий запрос обучает операцию чтения и оценивает ее на соответствие другим операциям чтения только одного датчика:

  `SELECT sensorId, reading, ANOMALYDETECTION(reading) OVER(PARTITION BY sensorId LIMIT DURATION(hour, 1)) FROM input`

* **предложение_limit_duration** (`DURATION(<unit>, <length>)`). Указывает, какой интервал времени (от текущего события) необходимо учитывать при обнаружении аномалий. Подробные сведения о поддерживаемых единицах и их сокращениях см. в описании функции [DATEDIFF](https://msdn.microsoft.com/azure/stream-analytics/reference/datediff-azure-stream-analytics). 

* **предложение_when**. Указывает логическое условие событий, которые учитываются при вычислении обнаружения аномалий.

### <a name="return-types"></a>Типы возвращаемого значения

Оператор AnomalyDetection возвращает запись, которая содержит в качестве выходных данных все три оценки. Свойства, связанные с различными типами средств обнаружения аномалий:

- BiLevelChangeScore
- SlowPosTrendScore
- SlowNegTrendScore

Чтобы извлечь из записи отдельные значения, используйте функцию **GetRecordPropertyValue**. Например: 

`SELECT id, val FROM input WHERE (GetRecordPropertyValue(ANOMALYDETECTION(val) OVER(LIMIT DURATION(hour, 1)), 'BiLevelChangeScore')) > 3.25` 

Аномалия определенного типа обнаруживается, когда один из этих показателей превышает пороговое значение. Пороговым значением может быть любое число с плавающей запятой больше или равное 0. Пороговое значение — это компромисс между чувствительностью и достоверностью. Например, более низкое пороговое значение сделает обнаружение более чувствительным к изменениям и создаст больше оповещений. А более высокое пороговое значение может сделать обнаружение менее чувствительным и более достоверным, но при этом некоторые аномалии будут маскироваться. Точное пороговое значение, которое следует использовать, зависит от конкретного сценария. Не существует верхнего предела, но рекомендуемый диапазон — от 3,25 до 5. 

Значение 3,25 из примера — просто рекомендуемая отправная точка. Чтобы настроить это значение, выполните операции в собственном наборе данных и наблюдайте за выходным значением, пока не достигнете приемлемого порога.

## <a name="anomaly-detection-algorithm"></a>Алгоритм обнаружения аномалий

* Оператор AnomalyDetection применяет подход **неконтролируемого обучения**, при котором не используется какой-либо тип распределения в событиях. Как правило, в любой момент времени создаются две модели: одна из них используется при оценке, а другая обучается в фоновом режиме. Модели обнаружения аномалий обучаются на основе данных их текущего потока. Данные за пределами диапазона не используются. Объем данных, используемых при обучении, зависит от размера окна (d), указанного пользователем в параметре Limit Duration. Каждая модель завершает обучение на основе соотношения d к 2d событий. Чтобы получить оптимальные результаты, в каждом окне должно содержаться не менее 50 событий. 

* Оператор AnomalyDetection обучает модели и оценивает события с использованием **семантики скользящего окна**. Это означает, что каждое событие оценивается на наличие аномалий и после этого возвращается оценка. Полученная оценка указывает на уровень достоверности этой аномалии. 

* Оператор AnomalyDetection **гарантирует**, что при вводе одинаковых данных всегда возвращается та же оценка независимо от времени начала создания выходных данных задания (это время создания первого выходного события в задании). Допустимые значения: текущее время, пользовательское значение или время последнего вывода данных (если задание ранее вернуло выходные данные). 

### <a name="training-the-models"></a>Обучение моделей 

Со временем модели обучаются по различным данным. Чтобы понять смысл оценок, важно знать базовый механизм обучения моделей. Здесь **t<sub>0</sub>** — это **время начала создания выходных данных задания**, а **d** — **размер окна**, указанный в параметре Limit Duration. Предположим, что время разделено на **прыжки размера d**, начиная с `01/01/0001 00:00:00`. Обучение модели и оценка событий состоит из следующих шагов:

* Когда задание запускается, считываются данные, начиная со времени t<sub>0</sub> — 2d.  
* Когда приходит время следующего прыжка, создается модель M1 и начинается ее обучение.  
* Во время следующего прыжка создается модель M2 и начинается ее обучение.  
* При достижении времени t<sub>0</sub> активируется модель M1 и выводится оценка.  
* В ходе следующего прыжка одновременно выполняются три действия:  

  * удаляется модель M1, так как она больше не нужна;  
  * завершается обучение модели M2, и теперь она используется при оценке;  
  * создается модель M3 и обучается в фоновом режиме.  

* Этот цикл повторяется при каждом прыжке: удаление активной модели, переход на параллельную модель и начало обучения третьей модели в фоновом режиме. 

Графически этот процесс выглядит так: 

![Обучение моделей](media/stream-analytics-machine-learning-anomaly-detection/training_model.png)

|**Модель** | **Время начала обучения** | **Время начала использования оценки** |
|---------|---------|---------|
|M1     | 11:20   | 11:33   |
|M2     | 11:30   | 11:40   |
|M3     | 11:40   | 11:50   |

* Обучение модели M1 начинается в 11:20. Это время следующего прыжка после начала операции чтения заданием в 11:13. Первые выходные данные получены от модели M1 в 11:33. Обучение происходило в течение 13 минут. 

* Обучение новой модели M2 начинается в 11:30, но ее оценка не использовалась до 11:40. Обучение происходило в течение 10 минут. 

* Модель M3 следует той же схеме, что и M2. 

### <a name="scoring-with-the-models"></a>Оценка с помощью моделей 

На уровне машинного обучения алгоритм обнаружения аномалий вычисляет значение странности каждого входящего события, сравнивая его с событиями в окне журнала. Вычисление этого значения зависит от типа аномалии.  

Рассмотрим вычисление значения странности более подробно (допустим, что имеется ряд данных о прошлом использовании с событиями): 

1. **Двунаправленное изменение уровня.** На основе данных из окна журнала обычный рабочий диапазон вычисляется как [10-й процентиль, 90-й процентиль]. В этом случае значение 10-го процентиля — это нижняя граница, а 90-го — верхняя. Значение странности текущего события вычисляется как:  

   - 0, если значение события — это обычный рабочий диапазон;  
   - значение события / 90-й процентиль, если значение события больше 90-го процентиля;  
   - 10-й процентиль / значение события, если значение события меньше 10-го процентиля.  

2. **Медленная положительная тенденция.** Линия тенденции вычисляется на основе значений в окне журнала. Операция находит положительную тенденцию в этой линии. Значение странности вычисляется как:  

   - slope, если наклон положительный;  
   - в противном случае 0. 

3. **Медленная отрицательная тенденция.** Линия тенденции вычисляется на основе значений в окне журнала. Операция находит отрицательную тенденцию в этой линии. Значение странности вычисляется как: 

   - slope, если наклон отрицательный;  
   - в противном случае 0.  

После вычисления значения странности входящего события на его основе рассчитывается значение мартингала. (Дополнительные сведения о вычислении значения мартингала см. в этой записи [блога по машинному обучению](https://blogs.technet.microsoft.com/machinelearning/2014/11/05/anomaly-detection-using-machine-learning-to-detect-abnormalities-in-time-series-data/).) Значение мартингала возвращается в качестве показателя аномалий. Оно медленно увеличивается под влиянием значений странности, что обеспечивает устойчивость средства обнаружения к случайным изменениям и снижает количество ложных предупреждений. Кроме того, оно имеет полезное свойство: 

вероятность [существует такое значение t, при котором M<sub>t</sub> > λ ] < 1/λ, где M<sub>t</sub> — значение мартингала на момент времени t, а λ — действительное значение. Например, если при значении M<sub>t</sub>>100 появляется предупреждение, вероятность ложных срабатываний составляет менее 1/100.  

## <a name="guidance-for-using-the-bi-directional-level-change-detector"></a>Руководство по использованию средства обнаружения двунаправленных изменений уровня 

Средство обнаружения двунаправленных изменений уровня можно использовать в таких сценариях, как сбой питания и восстановление или движение транспорта в час пик. Однако оно действует таким образом, что после обучения модели на основе определенных данных, другое изменение уровня считается аномальным, только если новое значение больше предыдущего верхнего предела (восходящее изменение уровня) или меньше предыдущего нижнего предела (нисходящее изменение уровня). Таким образом модель не должна видеть значения данных в диапазоне нового уровня (восходящего или нисходящего) в своем окне обучения, чтобы классифицировать их как аномальные. 

При использовании этого средства обнаружения следует учитывать следующие аспекты: 

1. Когда временные ряды внезапно обнаруживают увеличение или снижение значения, оператор AnomalyDetection определяет это. Но возможность обнаружения возвращения к нормальному состоянию требует дополнительного планирования. Чтобы обеспечить устойчивое состояние временных рядов перед обнаружением аномалии, в окне обнаружения оператора AnomalyDetection необходимо установить значение, составляющее по крайней мере половину длительности аномалии. Этот сценарий предполагает, что минимальную длительность аномалии можно рассчитать заранее, и в этом интервале времени имеется достаточное количество событий, чтобы обучить модель должным образом (не менее 50 событий). 

   Это показано на схемах 1 и 2 ниже с использованием изменения верхнего предела (та самая логика применяется к изменению нижнего предела). На обеих схемах "волны" обозначают аномальные изменения уровня. Оранжевые вертикальные линии — это границы прыжков. Размер прыжка совпадает с размером окна обнаружения, указанного в операторе AnomalyDetection. Зеленые линии обозначают размер окна обучения. На схеме 1 размер прыжка совпадает с временем длительности аномалии. На схеме 2 размер прыжка составляет половину времени длительности аномалии. Во всех случаях обнаруживается восходящее изменение, так как модель оценки обучена по обычным данным. Однако на основе принципа работы средства обнаружения двунаправленных изменений уровня ему необходимо исключить обычные значения из окна обучения модели, которая оценивает возврат в нормальное состояние. На схеме 1 модель оценки обучена с использованием обычных событий, поэтому она не может определить возврат в нормальное состояние. Но на схеме 2 обучение происходит только на основе данных об аномальном поведении, что позволяет определять возврат в нормальное состояние. По этой причине вы можете указать размер меньше половины, так как при использовании большего значения при обучении модели могут использоваться обычные события. 

   ![Средство обнаружения аномалий с размером окна равным длительности аномалии](media/stream-analytics-machine-learning-anomaly-detection/windowsize_equal_anomaly_length.png)

   ![Средство обнаружения аномалий с размером окна равным половине длительности аномалии](media/stream-analytics-machine-learning-anomaly-detection/windowsize_equal_half_anomaly_length.png)

2. Если длительность аномалии определить нельзя, это средство обнаружения действует по мере возможностей. Тем не менее выбор более узкого окна времени ограничивает объем данных обучения, что увеличивает возможность обнаружения возврата в нормальное состояние. 

3. В следующем сценарии более длительные аномалии не обнаруживаются, так как окно обучения уже содержит аномалию с таким же высоким значением. 

   ![Аномалии такого же размера](media/stream-analytics-machine-learning-anomaly-detection/anomalies_with_same_length.png)

## <a name="example-query-to-detect-anomalies"></a>Пример запроса обнаружения аномалий 

Следующий запрос можно использовать для вывода оповещения при обнаружении аномалии.
Когда входной поток не единообразен, с помощью шага статистической обработки можно преобразовать его в единообразные временные ряды. В этом примере используется AVG, но конкретный тип статистической обработки зависит от сценария пользователя. Более того, если временные ряды содержат разрывы, которые больше периода статистической обработки, то во временных рядах отсутствуют события запуска процесса обнаружения аномалий (в соответствии с семантикой скользящего окна). В результате предположение о единообразии нарушается, когда поступает следующее событие. В таких ситуациях промежутки во временных рядах необходимо заполнить. Одним из возможных решений является использование последнего события в каждом "прыгающем" окне, как показано ниже.

```sql
    WITH AggregationStep AS 
    (
         SELECT
               System.Timestamp as tumblingWindowEnd,

               AVG(value) as avgValue

         FROM input
         GROUP BY TumblingWindow(second, 5)
    ),

    FillInMissingValuesStep AS
    (
          SELECT
                System.Timestamp AS hoppingWindowEnd,

                TopOne() OVER (ORDER BY tumblingWindowEnd DESC) AS lastEvent

         FROM AggregationStep
         GROUP BY HOPPINGWINDOW(second, 300, 5)

    ),

    AnomalyDetectionStep AS
    (

          SELECT
                hoppingWindowEnd,
                lastEvent.tumblingWindowEnd as lastTumblingWindowEnd,
                lastEvent.avgValue as lastEventAvgValue,
                system.timestamp as anomalyDetectionStepTimestamp,

                ANOMALYDETECTION(lastEvent.avgValue) OVER (LIMIT DURATION(hour, 1)) as
                scores

          FROM FillInMissingValuesStep
    )

    SELECT
          alert = 1,
          hoppingWindowEnd,
          lastTumblingWindowEnd,
          lastEventAvgValue,
          anomalyDetectionStepTimestamp,
          scores

    INTO output

    FROM AnomalyDetectionStep

    WHERE

        CAST(GetRecordPropertyValue(scores, 'BiLevelChangeScore') as float) >= 3.25

        OR CAST(GetRecordPropertyValue(scores, 'SlowPosTrendScore') as float) >=
        3.25

       OR CAST(GetRecordPropertyValue(scores, 'SlowNegTrendScore') as float) >=
       3.25
```

## <a name="performance-guidance"></a>Рекомендации по производительности

* Используйте для заданий шесть единиц потоковой передачи. 
* Отправляйте события с интервалом не менее одной секунды.
* Несекционированный запрос, использующий оператор AnomalyDetection, может в результате привести к задержке вычисления в среднем около 25 мс.
* Задержка при выполнении секционированного запроса незначительно отличается в зависимости от количества секций, так как при таком запросе число вычислений выше. Тем не менее, задержка примерно такая же, как и в случае с несекционированным запросом, если общее число событий по всем секциям сопоставимо.
* При считывании данных не в режиме реального времени большой объем данных принимается быстро. Обработка этих данных в настоящее время происходит медленнее. Замечено, что при таких сценариях задержка увеличивалась линейно с количеством точек данных в окне, а не с увеличением размера окна или интервала между событиями. Чтобы сократить задержку в случаях работы не в режиме реального времени, по возможности используйте меньший размер окна. Кроме того, можно запускать задание от текущего времени. Несколько примеров задержки при несекционированном запросе: 
    - 60 точек данных в окне обнаружения могут привести к задержке в 10 секунд, если пропускная способность — 3 Мбит/с; 
    - при 600 точках данных задержка может достигать 80 секунд, если пропускная способность — 0,4 Мбит/с.

## <a name="limitations-of-the-anomalydetection-operator"></a>Ограничения использования оператора AnomalyDetection 

* Сейчас этот оператор не поддерживает определение пиков и спадов. Пики и спады — это спонтанные кратковременные изменения во временных рядах. 

* Сейчас этот оператор не обрабатывает шаблоны сезонных колебаний. Сезонные колебания — это повторяющиеся шаблоны в данных, например разное поведение трафика на выходных или разные тенденции покупок в "черную пятницу". Это не аномалии, а ожидаемое поведение. 

* Этот оператор ожидает, что входные временные ряды будут единообразными. Поток событий может сделать единообразным, если применить статистическую обработку с помощью "переворачивающегося" или "прыгающего" окна. В сценариях, где разрыв между событиями всегда меньше, чем период статистической обработки, "переворачивающегося" окна будет достаточно, чтобы сделать временные ряды единообразными. Если этот разрыв может быть больше, то разрывы заполняются повторением последнего значения с помощью "прыгающего" окна. 

## <a name="references"></a>Ссылки

* [Anomaly Detection – Using Machine Learning to Detect Abnormalities in Time Series Data](https://blogs.technet.microsoft.com/machinelearning/2014/11/05/anomaly-detection-using-machine-learning-to-detect-abnormalities-in-time-series-data/) (Обнаружение аномалий в данных временных рядов с помощью машинного обучения)
* [API обнаружения аномалий в машинном обучении](https://docs.microsoft.com/en-gb/azure/machine-learning/machine-learning-apps-anomaly-detection-api)
* [Time Series Anomaly Detection](https://msdn.microsoft.com/library/azure/mt775197.aspx) (Обнаружение аномалий во временных рядах)

## <a name="next-steps"></a>Дополнительная информация

* [Введение в Azure Stream Analytics](stream-analytics-introduction.md)
* [Приступая к работе с Azure Stream Analytics](stream-analytics-real-time-fraud-detection.md)
* [Масштабирование заданий в службе Azure Stream Analytics](stream-analytics-scale-jobs.md)
* [Справочник по языку запросов Azure Stream Analytics](https://msdn.microsoft.com/library/azure/dn834998.aspx)
* [Справочник по API-интерфейсу REST управления Stream Analytics](https://msdn.microsoft.com/library/azure/dn835031.aspx)

