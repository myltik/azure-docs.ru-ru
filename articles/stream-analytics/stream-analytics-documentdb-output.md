---
title: Выходные данные Azure Stream Analytics в Cosmos DB
description: Из этой статьи вы узнаете, как с помощью Azure Stream Analytics сохранять выходные данные в Azure Cosmos DB в формате JSON, что позволяет архивировать данные и уменьшать задержки запросов в отношении неструктурированных данных JSON.
services: stream-analytics
author: jseb225
ms.author: jeanb
manager: kfile
ms.reviewer: jasonh
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 03/28/2017
ms.openlocfilehash: f7115f7d19cd44ae7d0812d3aa6c48d8dd58c20d
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30907122"
---
# <a name="azure-stream-analytics-output-to-azure-cosmos-db"></a>Выходные данные Azure Stream Analytics в Azure Cosmos DB  
Stream Analytics позволяет направлять данные из [Azure Cosmos DB](https://azure.microsoft.com/services/documentdb/) в формат JSON, позволяя архивировать данные и уменьшать задержки запросов в отношении неструктурированных данных JSON. В этом документе представлены некоторые рекомендации по реализации данной конфигурации.

Тем, кто не знаком с Cosmos DB, мы рекомендуем просмотреть [схему обучения работе с Azure Cosmos DB](https://azure.microsoft.com/documentation/learning-paths/documentdb/). 

> [!Note]
> В настоящее время Azure Stream Analytics поддерживает соединение только с CosmosDB при помощи **API SQL**.
> Другие API Azure Cosmos DB в данный момент не поддерживаются. Если указать модулю Azure Stream Analytics учетные записи Azure Cosmos DB, созданные при помощи других API, это может привести к неправильному сохранению данных. 

## <a name="basics-of-cosmos-db-as-an-output-target"></a>Основные сведения о Cosmos DB как объекте вывода данных
Использование выходных данных Azure Cosmos DB в Stream Analytics позволяет записывать результаты обработки потока данных в коллекцию Cosmos DB в формате JSON. Stream Analytics не создает коллекции в базе данных. Их требуется создавать заранее. Благодаря этому выставление счетов за использование коллекций Cosmos DB является прозрачным для вас. Кроме того, вы можете регулировать производительность, согласованность и емкость своих коллекций напрямую с помощью [API-интерфейсов Cosmos DB](https://msdn.microsoft.com/library/azure/dn781481.aspx). Мы рекомендуем использовать одну базу данных Cosmos DB для одного потокового задания, чтобы обеспечить логическое разделение ваших коллекций для потокового задания.

Ниже приведены некоторые параметры коллекций Cosmos DB.

## <a name="tune-consistency-availability-and-latency"></a>Настройка согласованности, доступности и задержки
Для соответствия требованиям вашего приложения служба Cosmos DB позволяет настроить базу данных и коллекции и отрегулировать уровень согласованности, доступности и задержки. В зависимости от того, какие уровни согласованности чтения потребуются вашему сценарию для чтения и записи задержки, вы можете выбирать уровень согласованности в своей учетной записи базы данных. Кроме того, Cosmos DB по умолчанию активирует синхронное индексирование для каждой операции CRUD в вашей коллекции. Это еще один полезный параметр для контроля производительности чтения и записи в Cosmos DB. Дополнительные сведения см. в статье об [изменении уровней согласованности в для базы данных и запросов](../cosmos-db/consistency-levels.md).

## <a name="upserts-from-stream-analytics"></a>Вставка и обновление Upsert в Stream Analytics
Интеграция Stream Analytics с Cosmos DB позволяет вставлять или обновлять записи в коллекции Cosmos DB с помощью заданного столбца идентификаторов документов. Этот процесс называется также *Upsert*.

Stream Analytics использует оптимистичный подход Upsert, при котором обновления выполняются только тогда, когда операция вставки завершается ошибкой из-за конфликта с идентификатором документа. Это обновление выполняется службой Stream Analytics как исправление, поэтому оно допускает частичное обновление документа. Другими словами, добавление новых свойств или замена существующего свойства выполняется последовательно. Обратите внимание: изменение значений свойств массива в документе JSON приводит к перезаписи всего массива, т. е. массивы не объединяются.

## <a name="data-partitioning-in-cosmos-db"></a>Секционирование данных в Cosmos DB
[Секционированные коллекции](../cosmos-db/partition-data.md) Cosmos DB являются рекомендуемым способом секционирования данных. 

Для односекционных коллекций Cosmos DB служба Stream Analytics по-прежнему позволяет секционировать данные на основе шаблонов запросов и с учетом требований производительности приложения. Каждая коллекция может содержать до 10 ГБ данных (максимальный объем); в настоящее время увеличить ее размер (или выполнить ее переполнение) нельзя. При масштабировании Stream Analytics позволяет осуществлять запись в несколько коллекций с заданным префиксом (см. сведения об использовании ниже). Stream Analytics использует согласованную стратегию [Hash Partition Resolver](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.partitioning.hashpartitionresolver.aspx) (распознавателя разделов хэша), в основе которой лежит заданный пользователем столбец PartitionKey, для распределения записей выходных данных. Количество коллекций с заданным префиксом во время запуска потокового задания используется в качестве выходного количества разделов, в которые задание осуществляет запись параллельно (коллекции Cosmos DB = разделы выходных данных). Можно предположить, что для одной коллекции с отложенным индексированием, в которой выполняются только операции вставки, пропускная способность записи составит приблизительно 0,4 МБ/с. Использование нескольких коллекций может обеспечить более высокую пропускную способность и повысить емкость.

Если вы хотите увеличить количество разделов в будущем, возможно, вам потребуется остановить выполнение задания, перераспределить данные из существующих коллекций в новые коллекции, а затем перезапустить задание Stream Analytics. В следующую публикацию будут включены дополнительные сведения об использовании PartitionResolver и перераспределении, а также образец программного кода. Подробные сведения об этом есть также в статье о [секционировании и масштабировании в Cosmos DB](../cosmos-db/sql-api-partition-data.md).

## <a name="cosmos-db-settings-for-json-output"></a>Параметры Cosmos DB для выходных данных JSON
При создании Cosmos DB как средства обработки выходных данных в Stream Analytics создается запрос информации, показанный ниже. В этом разделе объясняются определения свойств.

Секционированная коллекция | Несколько односекционных коллекций
---|---
![экран выходных данных documentdb stream analytics](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-1.png) |  ![экран выходных данных documentdb stream analytics](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-2.png)


  
> [!NOTE]
> Для сценария с **несколькими односекционными коллекциями** требуется ключ секции и поддерживаемая конфигурация. 

* **Псевдоним выходных данных** — псевдоним для ссылки на эти выходные данные в запросе ASA.  
* **Имя учетной записи** — имя или универсальный код ресурса (URI) конечной точки учетной записи Cosmos DB.  
* **Ключ учетной записи** — общедоступный ключ доступа к учетной записи Cosmos DB.  
* **База данных** — имя базы данных Cosmos DB.  
* **Шаблон имени коллекции** — имя или шаблон имени для используемых коллекций. Формат имени коллекции можно составить с помощью необязательного маркера {partition}, где разделы начинаются с 0. Далее приведены примеры допустимых входных данных:  
  1\) MyCollection — должна существовать одна коллекция с именем MyCollection;  
  2\) MyCollection{partition} — должны существовать такие коллекции: MyCollection0, MyCollection1, MyCollection2 и т. д.  
* **Partition Key** — необязательно. Требуется, только если в шаблоне имени коллекции используется маркер {partition}. Имя поля в выходных событиях, указывающее ключ для разделения выходных данных между коллекциями. Для выходных данных одной коллекции можно использовать любой столбец произвольных выходных данных, например PartitionId.  
* **Document ID** — необязательно. Имя поля в выходных событиях, используемое для указания первичного ключа, на котором основываются операции вставки или обновления.  
