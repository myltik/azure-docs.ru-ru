---
title: Настройка ролей для облачной службы Azure в среде Visual Studio | Документация Майкрософт
description: Узнайте, как настроить роли для облачных служб Azure с помощью Visual Studio.
services: visual-studio-online
author: ghogen
manager: douge
assetId: d397ef87-64e5-401a-aad5-7f83f1022e16
ms.prod: visual-studio-dev15
ms.technology: vs-azure
ms.workload: azure
ms.topic: conceptual
ms.date: 03/21/2017
ms.author: ghogen
ms.openlocfilehash: 09e6c3a9c27342ef27d49674d62ccf74d70d2e0f
ms.sourcegitcommit: fa493b66552af11260db48d89e3ddfcdcb5e3152
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2018
ms.locfileid: "31798732"
---
# <a name="configure-azure-cloud-service-roles-with-visual-studio"></a>Настройка ролей для облачной службы Azure в Visual Studio
Облачной службе Azure можно назначить одну или несколько рабочих ролей или веб-ролей. Для каждой роли нужно определить способ настройки, а также настроить способ выполнения. Дополнительные сведения о ролях в облачных службах см. в видео [Введение в облачные службы Azure](https://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Introduction-to-Windows-Azure-Cloud-Services). 

Эта информация для облачной службы хранится в следующих файлах.

- **ServiceDefinition.csdef** — файл определения службы, в котором заданы параметры среды выполнения для облачной службы, в том числе требуемые роли, конечные точки и размер виртуальной машины. Данные хранящиеся в файле `ServiceDefinition.csdef`, нельзя изменить во время выполнения роли.
- **ServiceConfiguration.cscfg** — файл конфигурации службы, в котором задано количество выполняемых экземпляров роли и значения параметров, определенных для роли. Данные, хранящиеся в файле `ServiceConfiguration.cscfg`, можно изменить во время выполнения роли.

Для хранения различных значений параметров, контролирующих выполнение роли, можно задать несколько конфигураций службы. Разные конфигурации службы можно использовать для разных сред развертывания. Например, можно задать строку подключения к учетной записи хранения, чтобы использовать локальный эмулятор службы хранилища Azure в конфигурации локальной службы. Таким образом вы сможете создать другую конфигурацию службы для использования облачной службы хранилища Azure.

При создании облачной службы Azure в среде Visual Studio к вашему проекту Azure добавляются две автоматически созданные конфигурации службы:

- `ServiceConfiguration.Cloud.cscfg`
- `ServiceConfiguration.Local.cscfg`

## <a name="configure-an-azure-cloud-service"></a>Настройка облачной службы Azure
В среде Visual Studio можно настроить облачную службу Azure, используя обозреватель решений, как описано ниже.

1. Создайте или откройте проект облачной службы Azure в среде Visual Studio.

1. В **обозревателе решений** щелкните проект правой кнопкой мыши и в контекстном меню выберите пункт **Свойства**.
   
    ![Контекстное меню проекта в обозревателе решений](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-project-context-menu.png)

1. На странице свойств проекта выберите вкладку **Разработка**. 

    ![Страница свойств проекта — вкладка "Разработка"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-development-tab.png)

1. В списке **Конфигурация службы** выберите имя конфигурации службы, которую нужно изменить. (Если нужно изменить все конфигурации службы для этой роли, выберите пункт **Все конфигурации**.)
   
    > [!IMPORTANT]
    > При выборе конкретной конфигурации службы некоторые ее свойства будут отключены, так как их можно задать только для всех конфигураций. Чтобы изменить эти свойства, выберите пункт **Все конфигурации**.
    > 
    > 
   
    ![Список конфигураций службы для облачной службы Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/cloud-service-service-configuration-property.png)

## <a name="change-the-number-of-role-instances"></a>Изменение количества экземпляров роли
Чтобы повысить производительность облачной службы, можно изменить количество запущенных экземпляров роли в зависимости от количества пользователей или нагрузки, ожидаемой для определенной роли. При запуске облачной службы в Azure для каждого экземпляра роли создается отдельная виртуальная машина. От этого зависят выставленные счета за развертывание этой облачной службы. Дополнительные сведения о плате за использование Azure см. в статье [Расшифровка счета за использование Microsoft Azure](billing/billing-understand-your-bill.md).

1. Создайте или откройте проект облачной службы Azure в среде Visual Studio.

1. В **обозревателе решений** разверните узел проекта. В узле **Роли** щелкните правой кнопкой мыши роль, которую нужно обновить, и в контекстном меню выберите пункт **Свойства**.

    ![Контекстное меню роли в обозревателе решений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Перейдите на вкладку **Конфигурация**.

    ![Вкладка "Конфигурация"](./media/vs-azure-tools-configure-roles-for-cloud-service/role-configuration-properties-page.png)

1. В списке **Конфигурация службы** выберите конфигурацию службы, которую нужно обновить.
   
    ![Список "Конфигурация службы"](./media/vs-azure-tools-configure-roles-for-cloud-service/role-configuration-properties-page-select-configuration.png)

1. В поле **Количество экземпляров** введите количество экземпляров, которые будут запущены для этой роли. Каждый экземпляр выполняется на отдельной виртуальной машине при публикации облачной службы в Azure.

    ![Обновление количества экземпляров](./media/vs-azure-tools-configure-roles-for-cloud-service/role-configuration-properties-page-instance-count.png)

1. На панели инструментов Visual Studio щелкните **Сохранить**.

## <a name="manage-connection-strings-for-storage-accounts"></a>Управление строками подключения для учетных записей хранения
Вы можете добавлять, удалять или изменять строки подключения для конфигураций службы. Например, вы можете использовать строку локального подключения для конфигурации локальной службы, которая имеет значение `UseDevelopmentStorage=true`. Можно также настроить конфигурацию облачной службы, которая использует учетную запись хранения в Azure.

> [!WARNING]
> Когда вы вводите ключ учетной записи хранения Azure для строки подключения к учетной записи хранения, эти сведения сохраняются локально в CSCFG-файле. Тем не менее эти сведения в настоящее время не хранятся в виде зашифрованного текста.
> 
> 

Использование разных значений для разных конфигураций службы избавляет от необходимости использовать разные строки подключения в облачной службе или изменять код при публикации этой службы в Azure. Для строки подключения в коде можно использовать одно и то же имя и разные значения в зависимости от конфигурации службы, выбранной при сборке или публикации облачной службы.

1. Создайте или откройте проект облачной службы Azure в среде Visual Studio.

1. В **обозревателе решений** разверните узел проекта. В узле **Роли** щелкните правой кнопкой мыши роль, которую нужно обновить, и в контекстном меню выберите пункт **Свойства**.

    ![Контекстное меню роли в обозревателе решений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Перейдите на вкладку **Параметры**.

    ![Вкладка "Параметры"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab.png)

1. В списке **Конфигурация службы** выберите конфигурацию службы, которую нужно обновить.

    ![Конфигурация службы](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-select-configuration.png)

1. Чтобы добавить строку подключения, нажмите кнопку **Добавить параметр**.

    ![Добавление строки подключения](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting.png)

1. После добавления в список нового параметра введите необходимые сведения в строку списка.

    ![Новая строка подключения](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting-new-setting.png)

    - Поле **Имя**. Введите имя, которое будет использоваться для строки подключения.
    - Поле **Тип**. В раскрывающемся списке выберите пункт **Строка подключения**.
    - Поле **Значение**. Здесь вы можете ввести строку подключения непосредственно в ячейку **Значение** или щелкнуть многоточие (…), чтобы продолжить работу в диалоговом окне **Создание строки подключения к хранилищу**.  

1. В диалоговом окне **Создание строки подключения к хранилищу** выберите один из вариантов для параметра **Подключиться с помощью**. Затем следуйте инструкциям для выбранного варианта.

    - **Эмулятор хранилища Microsoft Azure**. Если вы выбрали этот вариант, остальные параметры в диалоговом окне будут отключены, так как они применяются только к Azure. Нажмите кнопку **ОК**.
    - **Ваша подписка**. Если выбран этот вариант, воспользуйтесь раскрывающимся списком, чтобы выбрать учетную запись Майкрософт и войти в нее или добавить учетную запись Майкрософт. Выберите подписку и учетную запись хранения Azure. Нажмите кнопку **ОК**.
    - **Введенные вручную учетные данные**. Введите имя учетной записи хранения, а также первичный или вторичный ключ. Выберите вариант **подключения** (в большинстве случаев рекомендуется использовать протокол HTTPS). Нажмите кнопку **ОК**.

1. Чтобы удалить строку подключения, выберите ее, а затем нажмите кнопку **Удалить параметр**.

1. На панели инструментов Visual Studio щелкните **Сохранить**.

## <a name="programmatically-access-a-connection-string"></a>Программный доступ к строке подключения

Ниже показано, как получить программный доступ к строке подключения с помощью C#.

1. Добавьте следующие директивы using в файл C#, в котором планируется использовать параметр:

    ```csharp
    using Microsoft.WindowsAzure;
    using Microsoft.WindowsAzure.Storage;
    using Microsoft.WindowsAzure.ServiceRuntime;
    ```

1. В следующем примере показано, как получить доступ к строке подключения. Замените заполнитель &lt;ConnectionStringName> соответствующим значением. 

    ```csharp
    // Setup the connection to Azure Storage
    var storageAccount = CloudStorageAccount.Parse(RoleEnvironment.GetConfigurationSettingValue("<ConnectionStringName>"));
    ```

## <a name="add-custom-settings-to-use-in-your-azure-cloud-service"></a>Добавление пользовательских параметров для использования в облачной службе Azure
Пользовательские параметры в файле конфигурации службы позволяют добавлять имя и значение строки для конкретной конфигурации службы. Можно использовать этот параметр, чтобы настроить функцию в облачной службе: значение параметра считывается и используется для управления логикой в коде. Вы можете изменять эти значения конфигурации службы без необходимости выполнять повторную сборку пакета служб, а также при запуске облачной службы. Ваш код может проверять наличие уведомлений об изменении параметра. См. статью, посвященную [событию RoleEnvironment.Changing](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.changing.aspx).

Вы можете добавлять, удалять или изменять пользовательские параметры для конфигураций службы. Также можно использовать разные значения этих строк для разных конфигураций службы.

Использование разных значений для разных конфигураций службы избавляет от необходимости использовать разные строки в облачной службе или изменять код при публикации этой службы в Azure. Для строки в коде можно использовать одно и то же имя и разные значения в зависимости от конфигурации службы, выбранной при сборке или публикации облачной службы.

1. Создайте или откройте проект облачной службы Azure в среде Visual Studio.

1. В **обозревателе решений** разверните узел проекта. В узле **Роли** щелкните правой кнопкой мыши роль, которую нужно обновить, и в контекстном меню выберите пункт **Свойства**.

    ![Контекстное меню роли в обозревателе решений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Перейдите на вкладку **Параметры**.

    ![Вкладка "Параметры"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab.png)

1. В списке **Конфигурация службы** выберите конфигурацию службы, которую нужно обновить.

    ![Список "Конфигурация службы"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-select-configuration.png)

1. Чтобы добавить пользовательский параметр, нажмите кнопку **Добавить параметр**.

    ![Добавление пользовательского параметра](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting.png)

1. После добавления в список нового параметра введите необходимые сведения в строку списка.

    ![Новый пользовательский параметр](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting-new-setting.png)

    - В поле **Имя** введите имя параметра.
    - В раскрывающемся списке **Тип** выберите пункт **Строка**.
    - В поле **Значение** задайте значение параметра. Вы можете ввести значение непосредственно в ячейку **Значение** или щелкнуть многоточие (…), чтобы задать значение в диалоговом окне **Изменить строку**.  

1. Чтобы удалить пользовательский параметр, сначала выберите его, а затем нажмите кнопку **Удалить параметр**.

1. На панели инструментов Visual Studio щелкните **Сохранить**.

## <a name="programmatically-access-a-custom-settings-value"></a>Программный доступ к значению пользовательского параметра
 
Ниже показано, как получить программный доступ к пользовательскому параметру с помощью C#.

1. Добавьте следующие директивы using в файл C#, в котором планируется использовать параметр:

    ```csharp
    using Microsoft.WindowsAzure;
    using Microsoft.WindowsAzure.Storage;
    using Microsoft.WindowsAzure.ServiceRuntime;
    ```

1. В следующем примере показано, как получить доступ к пользовательскому параметру. Замените заполнитель &lt;SettingName> соответствующим значением. 
    
    ```csharp
    var settingValue = RoleEnvironment.GetConfigurationSettingValue("<SettingName>");
    ```

## <a name="manage-local-storage-for-each-role-instance"></a>Управление локальным хранилищем для каждого экземпляра роли
Каждому экземпляру роли можно назначить хранилище локальной файловой системы. Данные, находящиеся в этом хранилище, недоступны для других экземпляров роли, для которой хранятся данные, или для других ролей.  

1. Создайте или откройте проект облачной службы Azure в среде Visual Studio.

1. В **обозревателе решений** разверните узел проекта. В узле **Роли** щелкните правой кнопкой мыши роль, которую нужно обновить, и в контекстном меню выберите пункт **Свойства**.

    ![Контекстное меню роли в обозревателе решений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Перейдите на вкладку **Локальное хранилище**.

    ![Вкладка "Локальное хранилище"](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab.png)

1. Убедитесь, что в списке **Конфигурация службы** выбран параметр **Все конфигурации**, так как локальные параметры хранилища применяются ко всем конфигурациям службы. Если выбрано любое другое значение, это приведет к отключению параметров во всех полях ввода данных на странице. 

    ![Список "Конфигурация службы"](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab-service-configuration.png)

1. Для добавления записи локального хранилища щелкните **Добавить локальное хранилище**.

    ![Добавление локального хранилища](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab-add-local-storage.png)

1. После добавления в список новой записи локального хранилища введите необходимые сведения в строку списка.

    ![Новая запись локального хранилища](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab-new-local-storage.png)

    - В поле **Имя** введите имя, которое будет использоваться для нового локального хранилища.
    - В поле **Размер (МБ)** задайте необходимый размер нового локального хранилища в мегабайтах.
    - В поле **Очистить при повторном использовании роли** установите флажок, чтобы удалить данные из нового локального хранилища при перезапуске виртуальной машины для этой роли.

1. Чтобы удалить запись локального хранилища, выберите запись, а затем нажмите кнопку **Удалить локальное хранилище**.

1. На панели инструментов Visual Studio щелкните **Сохранить**.

## <a name="programmatically-accessing-local-storage"></a>Программный доступ к локальному хранилищу

В этом разделе показано, как получить программный доступ к локальному хранилищу, написав тестовый текстовый файл `MyLocalStorageTest.txt` с помощью C#.  

### <a name="write-a-text-file-to-local-storage"></a>Написание текстового файла для локального хранилища

В следующем примере показано, как написать текстовый файл для локального хранилища. Замените заполнитель &lt;LocalStorageName> соответствующим значением. 

    ```csharp
    // Retrieve an object that points to the local storage resource
    LocalResource localResource = RoleEnvironment.GetLocalResource("<LocalStorageName>");
    
    //Define the file name and path
    string[] paths = { localResource.RootPath, "MyLocalStorageTest.txt" };
    String filePath = Path.Combine(paths);
    
    using (FileStream writeStream = File.Create(filePath))
    {
        Byte[] textToWrite = new UTF8Encoding(true).GetBytes("Testing Web role storage");
        writeStream.Write(textToWrite, 0, textToWrite.Length);
    }

    ```

### <a name="find-a-file-written-to-local-storage"></a>Поиск файла, написанного для локального хранилища

Чтобы просмотреть файл, созданный с помощью кода из предыдущего раздела, выполните следующие действия:
    
1.  В области уведомлений Windows щелкните правой кнопкой мыши значок Azure и в контекстном меню выберите пункт **Show Compute Emulator UI** (Показать пользовательский интерфейс эмулятора вычислений). 

    ![Показать пользовательский интерфейс эмулятора вычислений](./media/vs-azure-tools-configure-roles-for-cloud-service/show-compute-emulator.png)

1. Выберите веб-роль.

    ![Эмулятор вычислений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/compute-emulator.png)

1. В меню **Эмулятор вычислений Microsoft Azure** выберите **Средства** > **Open local store** (Открыть локальное хранилище).

    ![Пункт меню "Открыть локальное хранилище"](./media/vs-azure-tools-configure-roles-for-cloud-service/compute-emulator-open-local-store-menu.png)

1. Когда откроется окно проводника Windows, введите в текстовое поле **поиска** запрос "MyLocalStorageTest.txt'' и нажмите клавишу **ВВОД**, чтобы начать поиск. 

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения о проектах Azure в Visual Studio см. в статье [Настройка проекта облачной службы в Visual Studio](vs-azure-tools-configuring-an-azure-project.md). Дополнительные сведения о схеме облачной службы см. в статье [Справка по схемам Windows Azure](https://msdn.microsoft.com/library/azure/dd179398).

