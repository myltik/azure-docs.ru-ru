---
title: "Реагирование на события хранилища BLOB-объектов Azure (предварительная версия) | Документация Microsoft"
description: "Используйте службу \"Сетка событий Azure\" для подписки на события хранилища BLOB-объектов."
services: storage,event-grid
keywords: 
author: cbrooksmsft
ms.author: cbrooks
ms.date: 08/25/2017
ms.topic: article
ms.service: storage
ms.openlocfilehash: c760cf5a9bdd4b64a60470fa48cb9b57ec4ab5fc
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="reacting-to-blob-storage-events-preview"></a>Реагирование на события хранилища BLOB-объектов (предварительная версия)

События хранилища BLOB-объектов Azure позволяют приложениям реагировать на создание и удаление больших двоичных объектов с помощью современной безсерверной архитектуры и без необходимости написания сложного кода или использования дорогостоящих и неэффективных служб опроса.  Вместо этого события отправляются через службу [Сетка событий Azure](https://azure.microsoft.com/services/event-grid/) подписчикам, таким как [Функции Azure](https://azure.microsoft.com/services/functions/), [Azure Logic Apps](https://azure.microsoft.com/services/logic-apps/), или даже в настраиваемый вами прослушиватель HTTP. При этом вы оплачиваете только то, что используете.

К распространенным сценариям событий хранилища BLOB-объектов относятся обработка изображений и видео, индексирование поиска и любые рабочие процессы, ориентированные на файлы.  Асинхронная передача файлов идеально подходит для событий.  Когда изменения вносятся редко, а сценарий требует немедленного реагирования, архитектура на основе событий может быть особенно эффективной.

![Модель Сетки событий](./media/storage-blob-event-overview/event-grid-functional-model.png)

[!INCLUDE [cloud-shell-try-it.md](../../../includes/cloud-shell-try-it.md)]

## <a name="join-the-preview"></a>Присоединение к предварительной версии
События хранилища BLOB-объектов доступны в режиме предварительной версии.  Пользователи могут запрашивать присоединение к предварительной версии, выполнив в своей подписке следующие команды:
```azurecli-interactive
az provider register --namespace  Microsoft.EventGrid
az feature register --name storageEventSubscriptions --namespace Microsoft.EventGrid
```
Подписки добавляются в программу ознакомления с предварительной версией по мере доступности емкости.  Состояние запроса можно отслеживать с помощью следующей команды:
```azurecli-interactive
az feature show --name storageEventSubscriptions --namespace Microsoft.EventGrid
```
Когда состояние регистрации изменяется на "Зарегистрировано", это означает, что вы добавлены в программу ознакомления с предварительной версией и можете подписаться на события хранилища BLOB-объектов для учетных записей в расположениях ***Западная часть США 2*** или ***Западно-центральная часть США***.  Краткий пример можно просмотреть в статье [Перенаправление событий хранилища BLOB-объектов в пользовательскую конечную веб-точку (предварительная версия)](storage-blob-event-quickstart.md).

## <a name="blob-storage-accounts"></a>Учетные записи хранилища BLOB-объектов
События хранилища BLOB-объектов доступны в [учетных записях хранилища BLOB-объектов](../common/storage-create-storage-account.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#blob-storage-accounts) (а не в учетных записях хранения общего назначения).  Учетные записи хранения BLOB-объектов — это специализированные учетные записи хранения таких неструктурированных данных, как большие двоичные объекты, в службе хранилища Azure. Учетные записи хранилища BLOB-объектов похожи на учетные записи хранения общего назначения и обладают такими же функциями обеспечения устойчивости, надежности, масштабируемости и производительности, которые вы уже используете, а также отличаются полной согласованностью API в плане блочных BLOB-объектов и добавления больших двоичных объектов. Для приложений, требующих только блокировки или добавления больших двоичных объектов, рекомендуется использовать учетные записи хранения больших двоичных объектов.

## <a name="available-blob-storage-events"></a>Доступные события хранилища BLOB-объектов
Сетка событий использует [подписки на события](../../event-grid/concepts.md#event-subscriptions) для маршрутизации сообщений о событиях подписчикам.  Подписки на события хранилища BLOB-объектов могут включать два типа событий:  

> |Название мероприятия|Описание|
> |----------|-----------|
> |`Microsoft.Storage.BlobCreated`|Возникает при создании или замене большого двоичного объекта с помощью операций `PutBlob`, `PutBlockList` или `CopyBlob`.|
> |`Microsoft.Storage.BlobDeleted`|Возникает при удалении большого двоичного объекта с помощью операции `DeleteBlob`.|

## <a name="event-schema"></a>Схема событий
События хранилища BLOB-объектов содержат все сведения, необходимые для реагирования на изменения в данных.  Событие хранилища BLOB-объектов можно определить, так как свойство eventType начинается с Microsoft.Storage.  
Дополнительные сведения об использовании свойств событий Сетки событий приводятся в статье [Схема событий службы "Сетка событий Azure"](../../event-grid/event-schema.md).  

> |Свойство|Тип|Описание|
> |-------------------|------------------------|-----------------------------------------------------------------------|
> |Раздел|string|Полный идентификатор Azure Resource Manager учетной записи хранения, которая создает событие.|
> |subject|string|Относительный путь ресурса к объекту, который является темой события. Используется тот же расширенный формат Azure Resource Manager, который мы используем для описания учетных записей хранения, служб и контейнеров для Azure RBAC.  Этот формат включает не меняющее регистр имя большого двоичного объекта.|
> |eventTime|string|Дата и время создания события (в формате ISO 8601).|
> |eventType|string|Microsoft.Storage.BlobCreated или Microsoft.Storage.BlobDeleted.|
> |Идентификатор|string|Уникальный идентификатор этого события.|
> |data|object|Коллекция данных событий, относящихся к хранилищу BLOB-объектов.|
> |data.contentType|string|Тип содержимого большого двоичного объекта, возвращаемый в заголовке Content-Type из большого двоичного объекта.|
> |data.contentLength|number|Размер большого двоичного объекта в виде целого числа, представляющего число байтов, возвращаемое в заголовке Content-Length из большого двоичного объекта.  Отправляется при событии BlobCreated, но не отправляется при событии BlobDeleted.|
> |data.url|string|Url-адрес объекта, который является темой этого события.|
> |data.eTag|string|ETag объекта при возникновении события.  Недоступно для события BlobDeleted.|
> |data.api|string|Имя операции API, которая активировала это событие.  Для событий BlobCreated это значение — PutBlob, PutBlockList или CopyBlob.  А для событий BlobDeleted — DeleteBlob.  Эти значения совпадают с именами API, которые присутствуют в журналах диагностики службы хранилища Azure.  Ознакомьтесь со статьей [Storage Analytics Logged Operations and Status Messages](https://docs.microsoft.com/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) (Операции с протоколированием и сообщения о состоянии Аналитики Службы хранилища).|
> |data.sequencer|string|Значение непрозрачной строки, представляющее логическую последовательность событий для любого отдельного имени большого двоичного объекта.  Пользователи могут использовать стандартное сравнение строк для понимания относительной последовательности двух событий в одном имени большого двоичного объекта.|
> |data.requestId|string|Создаваемый службой идентификатор запроса для операции API хранилища.  Может использоваться для корреляции журналов диагностики службы хранилища Azure с помощью поля request-id-header в журналах. Возвращается при инициации вызова API в заголовке x-ms-request-id. Ознакомьтесь со статьей [Storage Analytics Log Format](https://docs.microsoft.com/rest/api/storageservices/storage-analytics-log-format) (Формат журналов Аналитики Службы хранилища).|
> |data.clientRequestId|string|Предоставляемый клиентом идентификатор запроса для операции API хранилища.  Может использоваться для корреляции журналов диагностики службы хранилища Azure с помощью поля client-request-id в журналах. А также может предоставляться в запросах клиента с помощью заголовка x-ms-client-request-id. Ознакомьтесь со статьей [Storage Analytics Log Format](https://docs.microsoft.com/rest/api/storageservices/storage-analytics-log-format) (Формат журналов Аналитики Службы хранилища).|
> |data.storageDiagnostics|object|Диагностические данные, которые иногда включаются службой хранилища Azure.  Если они присутствуют, то должны игнорироваться потребителями события.|

Ниже приведен пример события BlobCreated.
```json
[{
  "topic": "/subscriptions/319a9601-1ec0-0000-aebc-8fe82724c81e/resourceGroups/testrg/providers/Microsoft.Storage/storageAccounts/myaccount",
  "subject": "/blobServices/default/containers/testcontainer/blobs/file1.txt",
  "eventType": "Microsoft.Storage.BlobCreated",
  "eventTime": "2017-08-16T01:57:26.005121Z",
  "id": "602a88ef-0001-00e6-1233-1646070610ea",
  "data": {
    "api": "PutBlockList",
    "clientRequestId": "799304a4-bbc5-45b6-9849-ec2c66be800a",
    "requestId": "602a88ef-0001-00e6-1233-164607000000",
    "eTag": "0x8D4E44A24ABE7F1",
    "contentType": "text/plain",
    "contentLength": 447,
    "blobType": "BlockBlob",
    "url": "https://myaccount.blob.core.windows.net/testcontainer/file1.txt",
    "sequencer": "00000000000000EB000000000000C65A",
  }
}]

```

Дополнительные сведения см. в статье [Схема событий службы "Сетка событий Azure"](../../event-grid/event-schema.md#azure-blob-storage).

## <a name="filtering-events"></a>Фильтрация событий
Подписки на события больших двоичных объектов можно фильтровать на основе типа события, а также по имени контейнера и имени созданного или удаленного большого двоичного объекта.  Фильтры темы в Сетке событий работают на основе совпадений "начинается с" и "заканчивается на", что позволяет доставлять подписчику события с соответствующей темой.
Тема событий хранилища BLOB-объектов использует следующий формат:
```json
/blobServices/default/containers/<containername>/blobs/<blobname>
```
Чтобы сопоставить все события для учетной записи хранения, фильтры темы можно оставить пустыми.

Чтобы сопоставить события из больших двоичных объектов, созданных в наборе контейнеров с общим префиксом, используйте фильтр `subjectBeginsWith`, подобный этому:
```json
/blobServices/default/containers/containerprefix
```
Чтобы сопоставить события из больших двоичных объектов, созданных в конкретном контейнере, используйте фильтр `subjectBeginsWith`, подобный этому:
```json
/blobServices/default/containers/containername/
```
Чтобы сопоставить события из больших двоичных объектов, созданных в конкретном контейнере с общим префиксом имени большого двоичного объекта, используйте фильтр `subjectBeginsWith`, подобный этому:
```json
/blobServices/default/containers/containername/blobs/blobprefix
```

Чтобы сопоставить события из больших двоичных объектов, созданных в конкретном контейнере с общим суффиксом имени большого двоичного объекта, используйте фильтр `subjectEndsWith`, такой как .log или .jpg.

Дополнительные сведения см. в статье [Основные понятия в службе "Сетка событий Azure"](../../event-grid/concepts.md#filters).

## <a name="practices-for-consuming-events"></a>Рекомендации по потреблению событий
Приложения, которые обрабатывают события хранилища BLOB-объектов, должны следовать нескольким рекомендациям:
> [!div class="checklist"]
> * Так как в один обработчик событий можно настроить маршрутизацию событий из нескольких подписок, не следует предполагать, что события поступают из определенного источника. Но необходимо проверять тему сообщения, чтобы убедиться, что оно поступает из ожидаемой учетной записи хранения.
> * Подобным образом убедитесь, что вы готовы к обработке этого типа событий (eventType), а также не следует предполагать, что все получаемые события будут иметь ожидаемый тип.
> * Так как сообщения могут поступать не по порядку и после некоторой задержки, используйте поля ETag, чтобы понять, являются ли сведения об объектах актуальными.  Используйте поля sequencer для понимания последовательности событий для каждого отдельного объекта.
> * Используйте поле blobType чтобы понять, какой тип операций разрешен в большом двоичном объекте и какие типы клиентских библиотек следует использовать для доступа к большому двоичному объекту.
> * Для доступа к большому двоичному объекту используйте поле url с конструкторами `CloudBlockBlob` и `CloudAppendBlob`.
> * Игнорируйте поля, которые вам непонятны.  Такой подход поможет обеспечить устойчивость к новым функциям, которые могут быть добавлены в будущем.


## <a name="next-steps"></a>Дальнейшие действия

Ознакомьтесь с дополнительными сведениями о Сетке событий и попробуйте использовать события хранилища BLOB-объектов:

- [An introduction to Azure Event Grid](../../event-grid/overview.md) (Общие сведения о службе "Сетка событий Azure")
- [Перенаправление событий хранилища BLOB-объектов в пользовательскую конечную веб-точку (предварительная версия)](storage-blob-event-quickstart.md)