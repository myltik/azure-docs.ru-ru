---
title: Реагирование на события хранилища BLOB-объектов Azure | Документация Майкрософт
description: Используйте службу "Сетка событий Azure" для подписки на события хранилища BLOB-объектов.
services: storage,event-grid
keywords: ''
author: cbrooksmsft
ms.author: cbrooks
ms.date: 01/30/2018
ms.topic: article
ms.service: storage
ms.openlocfilehash: db062fc36478d6ba2cf0f00544793f635ccdbb06
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34650134"
---
# <a name="reacting-to-blob-storage-events"></a>Реагирование на события хранилища BLOB-объектов

События службы хранилища Azure позволяют приложениям реагировать на создание и удаление больших двоичных объектов с помощью современных бессерверных архитектур. При этом не требуется сложный код или дорогостоящие и неэффективные службы опроса.  Вместо этого события отправляются через службу [Сетка событий Azure](https://azure.microsoft.com/services/event-grid/) подписчикам, таким как [Функции Azure](https://azure.microsoft.com/services/functions/), [Azure Logic Apps](https://azure.microsoft.com/services/logic-apps/), или даже в настраиваемый вами прослушиватель HTTP. При этом вы оплачиваете только то, что используете. 

К распространенным сценариям событий хранилища BLOB-объектов относятся обработка изображений и видео, индексирование поиска и любые рабочие процессы, ориентированные на файлы.  Асинхронная передача файлов идеально подходит для событий.  Когда изменения вносятся редко, а сценарий требует немедленного реагирования, архитектура на основе событий может быть особенно эффективной.

Доступность событий хранилища привязывается к [доступности](../../event-grid/overview.md) службы "Сетка событий". Эта функция скоро станет доступной в других регионах вместе со службой "Сетка событий". С кратким примером можно ознакомиться в разделе [Перенаправление событий хранилища BLOB-объектов в пользовательскую конечную веб-точку с помощью Azure CLI](storage-blob-event-quickstart.md) или [Перенаправление событий хранилища BLOB-объектов в пользовательскую конечную веб-точку с помощью PowerShell](storage-blob-event-quickstart-powershell.md). 

![Модель Сетки событий](./media/storage-blob-event-overview/event-grid-functional-model.png)

## <a name="blob-storage-accounts"></a>Учетные записи хранения BLOB-объектов
События хранилища BLOB-объектов доступны в [учетных записях хранения BLOB-объектов](../common/storage-create-storage-account.md?toc=%2fazure%2fstorage%2fblobs%2ftoc.json#blob-storage-accounts) и [учетных записях хранения общего назначения версии 2](../common/storage-account-options.md#general-purpose-v2). Учетные записи **общего назначения версии 2 (GPv2)** являются учетными записями хранения, которые поддерживают все функции для всех служб хранилища, включая большие двоичные объекты, файлы, очереди и таблицы. **Учетные записи хранения BLOB-объектов** — это специализированные учетные записи хранения таких неструктурированных данных, как большие двоичные объекты, в службе хранилища Azure. Учетные записи хранилища BLOB-объектов похожи на учетные записи хранения общего назначения и обладают такими же функциями обеспечения устойчивости, надежности, масштабируемости и производительности, которые вы уже используете, а также отличаются полной согласованностью API в плане блочных BLOB-объектов и добавления больших двоичных объектов. Для приложений, требующих только блокировки или добавления больших двоичных объектов, рекомендуется использовать учетные записи хранения больших двоичных объектов. 

## <a name="available-blob-storage-events"></a>Доступные события хранилища BLOB-объектов
Сетка событий использует [подписки на события](../../event-grid/concepts.md#event-subscriptions) для маршрутизации сообщений о событиях подписчикам.  Подписки на события хранилища BLOB-объектов могут включать два типа событий:  

> |Название мероприятия|ОПИСАНИЕ|
> |----------|-----------|
> |`Microsoft.Storage.BlobCreated`|Возникает при создании или замене большого двоичного объекта с помощью операций `PutBlob`, `PutBlockList` или `CopyBlob`.|
> |`Microsoft.Storage.BlobDeleted`|Возникает при удалении большого двоичного объекта с помощью операции `DeleteBlob`.|

## <a name="event-schema"></a>Схема событий
События хранилища BLOB-объектов содержат все сведения, необходимые для реагирования на изменения в данных.  Событие хранилища BLOB-объектов можно определить, так как свойство eventType начинается с Microsoft.Storage.  
Дополнительные сведения об использовании свойств событий Сетки событий приводятся в статье [Схема событий службы "Сетка событий Azure"](../../event-grid/event-schema.md).  

> |Свойство|type|ОПИСАНИЕ|
> |-------------------|------------------------|-----------------------------------------------------------------------|
> |Раздел|строка|Полный идентификатор Azure Resource Manager учетной записи хранения, которая создает событие.|
> |subject|строка|Относительный путь ресурса к объекту, который является темой события. Используется тот же расширенный формат Azure Resource Manager, который мы используем для описания учетных записей хранения, служб и контейнеров для Azure RBAC.  Этот формат включает не меняющее регистр имя большого двоичного объекта.|
> |eventTime|строка|Дата и время создания события (в формате ISO 8601).|
> |eventType|строка|Microsoft.Storage.BlobCreated или Microsoft.Storage.BlobDeleted.|
> |Идентификатор|строка|Уникальный идентификатор этого события.|
> |dataVersion|строка|Версия схемы для объекта данных.|
> |metadataVersion|строка|Версия схемы свойств верхнего уровня.|
> |data|object|Коллекция данных событий, относящихся к хранилищу BLOB-объектов.|
> |data.contentType|строка|Тип содержимого большого двоичного объекта, возвращаемый в заголовке Content-Type из большого двоичного объекта.|
> |data.contentLength|number|Размер большого двоичного объекта в виде целого числа, представляющего число байтов, возвращаемое в заголовке Content-Length из большого двоичного объекта.  Отправляется при событии BlobCreated, но не отправляется при событии BlobDeleted.|
> |data.url|строка|Url-адрес объекта, который является темой этого события.|
> |data.eTag|строка|ETag объекта при возникновении события.  Недоступно для события BlobDeleted.|
> |data.api|строка|Имя операции API, которая активировала это событие.  Для событий BlobCreated это значение — PutBlob, PutBlockList или CopyBlob.  А для событий BlobDeleted — DeleteBlob.  Эти значения совпадают с именами API, которые присутствуют в журналах диагностики службы хранилища Azure.  Ознакомьтесь со статьей [Storage Analytics Logged Operations and Status Messages](https://docs.microsoft.com/rest/api/storageservices/storage-analytics-logged-operations-and-status-messages) (Операции с протоколированием и сообщения о состоянии Аналитики Службы хранилища).|
> |data.sequencer|строка|Значение непрозрачной строки, представляющее логическую последовательность событий для любого отдельного имени большого двоичного объекта.  Пользователи могут использовать стандартное сравнение строк для понимания относительной последовательности двух событий в одном имени большого двоичного объекта.|
> |data.requestId|строка|Создаваемый службой идентификатор запроса для операции API хранилища.  Может использоваться для корреляции журналов диагностики службы хранилища Azure с помощью поля request-id-header в журналах. Возвращается при инициации вызова API в заголовке x-ms-request-id. Ознакомьтесь со статьей [Storage Analytics Log Format](https://docs.microsoft.com/rest/api/storageservices/storage-analytics-log-format) (Формат журналов Аналитики Службы хранилища).|
> |data.clientRequestId|строка|Предоставляемый клиентом идентификатор запроса для операции API хранилища.  Может использоваться для корреляции журналов диагностики службы хранилища Azure с помощью поля client-request-id в журналах. А также может предоставляться в запросах клиента с помощью заголовка x-ms-client-request-id. Ознакомьтесь со статьей [Storage Analytics Log Format](https://docs.microsoft.com/rest/api/storageservices/storage-analytics-log-format) (Формат журналов Аналитики Службы хранилища).|
> |data.storageDiagnostics|object|Диагностические данные, которые иногда включаются службой хранилища Azure.  Если они присутствуют, то должны игнорироваться потребителями события.|
|data.blobType|строка|Тип большого двоичного объекта. Допустимые значения: BlockBlob или PageBlob.| 

Ниже приведен пример события BlobCreated.
```json
[{
  "topic": "/subscriptions/319a9601-1ec0-0000-aebc-8fe82724c81e/resourceGroups/testrg/providers/Microsoft.Storage/storageAccounts/myaccount",
  "subject": "/blobServices/default/containers/testcontainer/blobs/file1.txt",
  "eventType": "Microsoft.Storage.BlobCreated",
  "eventTime": "2017-08-16T01:57:26.005121Z",
  "id": "602a88ef-0001-00e6-1233-1646070610ea",
  "data": {
    "api": "PutBlockList",
    "clientRequestId": "799304a4-bbc5-45b6-9849-ec2c66be800a",
    "requestId": "602a88ef-0001-00e6-1233-164607000000",
    "eTag": "0x8D4E44A24ABE7F1",
    "contentType": "text/plain",
    "contentLength": 447,
    "blobType": "BlockBlob",
    "url": "https://myaccount.blob.core.windows.net/testcontainer/file1.txt",
    "sequencer": "00000000000000EB000000000000C65A",
  },
  "dataVersion": "",
  "metadataVersion": "1"
}]

```

Дополнительные сведения см. в статье [Схема событий службы "Сетка событий Azure"](../../event-grid/event-schema-blob-storage.md).

## <a name="filtering-events"></a>Фильтрация событий
Подписки на события больших двоичных объектов можно фильтровать на основе типа события, а также по имени контейнера и имени созданного или удаленного большого двоичного объекта.  Фильтры могут применяться к подпискам на события во время [создания](/cli/azure/eventgrid/event-subscription?view=azure-cli-latest#az_eventgrid_event_subscription_create) подписки на событие или [позже](/cli/azure/eventgrid/event-subscription?view=azure-cli-latest#az_eventgrid_event_subscription_update). Фильтры темы в службе "Сетка событий" работают на основе совпадений "начинается с" и "заканчивается на", что позволяет доставлять подписчику события с соответствующей темой. 

Тема событий хранилища BLOB-объектов использует следующий формат:

```
/blobServices/default/containers/<containername>/blobs/<blobname>
```

Чтобы сопоставить все события для учетной записи хранения, фильтры темы можно оставить пустыми.

Чтобы сопоставить события из больших двоичных объектов, созданных в наборе контейнеров с общим префиксом, используйте фильтр `subjectBeginsWith`, подобный этому:

```
/blobServices/default/containers/containerprefix
```

Чтобы сопоставить события из больших двоичных объектов, созданных в конкретном контейнере, используйте фильтр `subjectBeginsWith`, подобный этому:

```
/blobServices/default/containers/containername/
```

Чтобы сопоставить события из больших двоичных объектов, созданных в конкретном контейнере с общим префиксом имени большого двоичного объекта, используйте фильтр `subjectBeginsWith`, подобный этому:

```
/blobServices/default/containers/containername/blobs/blobprefix
```

Чтобы сопоставить события из больших двоичных объектов, созданных в конкретном контейнере с общим суффиксом имени большого двоичного объекта, используйте фильтр `subjectEndsWith`, такой как .log или .jpg.

Дополнительные сведения см. в статье [Основные понятия в службе "Сетка событий Azure"](../../event-grid/concepts.md#event-subscriptions).

## <a name="practices-for-consuming-events"></a>Рекомендации по потреблению событий
Приложения, которые обрабатывают события хранилища BLOB-объектов, должны следовать нескольким рекомендациям:
> [!div class="checklist"]
> * Так как в один обработчик событий можно настроить маршрутизацию событий из нескольких подписок, не следует предполагать, что события поступают из определенного источника. Но необходимо проверять тему сообщения, чтобы убедиться, что оно поступает из ожидаемой учетной записи хранения.
> * Подобным образом убедитесь, что вы готовы к обработке этого типа событий (eventType), а также не следует предполагать, что все получаемые события будут иметь ожидаемый тип.
> * Так как сообщения могут поступать не по порядку и после некоторой задержки, используйте поля ETag, чтобы понять, являются ли сведения об объектах актуальными.  Используйте поля sequencer для понимания последовательности событий для каждого отдельного объекта.
> * Используйте поле blobType чтобы понять, какой тип операций разрешен в большом двоичном объекте и какие типы клиентских библиотек следует использовать для доступа к большому двоичному объекту. Допустимые значения: `BlockBlob` или `PageBlob`. 
> * Для доступа к большому двоичному объекту используйте поле url с конструкторами `CloudBlockBlob` и `CloudAppendBlob`.
> * Игнорируйте поля, которые вам непонятны.  Такой подход поможет обеспечить устойчивость к новым функциям, которые могут быть добавлены в будущем.


## <a name="next-steps"></a>Дополнительная информация

Ознакомьтесь с дополнительными сведениями о Сетке событий и попробуйте использовать события хранилища BLOB-объектов:

- [An introduction to Azure Event Grid](../../event-grid/overview.md) (Общие сведения о службе "Сетка событий Azure")
- [Перенаправление событий хранилища BLOB-объектов в пользовательскую конечную веб-точку (предварительная версия)](storage-blob-event-quickstart.md)
