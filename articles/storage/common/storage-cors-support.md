---
title: Поддержка общего доступа к ресурсам независимо от источника (CORS) | Документация Майкрософт
description: Узнайте, как включить поддержку CORS для служб хранилища Microsoft Azure.
services: storage
documentationcenter: .net
author: cbrooksmsft
manager: carmonm
editor: tysonn
ms.assetid: a0229595-5b64-4898-b8d6-fa2625ea6887
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 2/22/2017
ms.author: cbrooks
ms.openlocfilehash: 8d189d3ec3e6081dd37b912824f287cd75f39b35
ms.sourcegitcommit: 6fcd9e220b9cd4cb2d4365de0299bf48fbb18c17
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2018
ms.locfileid: "23059849"
---
# <a name="cross-origin-resource-sharing-cors-support-for-the-azure-storage-services"></a>Поддержка общего доступа к ресурсам независимо от источника (CORS) для служб хранилища Azure
Начиная с версии 2013-08-15, службы хранилища Azure поддерживают общий доступ к ресурсам независимо от источника (CORS) для служб BLOB-объектов, таблиц, очередей и файлов. CORS является функцией HTTP, которая позволяет веб-приложению, работающему в одном домене, обращаться к ресурсам из другого домена. Веб-браузеры реализуют ограничение безопасности под названием [политика одного источника](http://www.w3.org/Security/wiki/Same_Origin_Policy), которое не позволяет веб-странице вызывать интерфейсы API из другого домена; CORS обеспечивает безопасный способ, который разрешает одному домену (исходному домену) вызывать интерфейсы API в другом домене. Дополнительные сведения о спецификации CORS см. на [этом сайте](http://www.w3.org/TR/cors/).

Чтобы задать правила CORS отдельно для каждой службы хранилища, обратитесь к разделам [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx) (Задание свойств службы BLOB-объектов), [Set Queue Service Properties](https://msdn.microsoft.com/library/hh452232.aspx) (Задание свойств службы очередей) и [Set Table Service Properties](https://msdn.microsoft.com/library/hh452240.aspx) (Задание свойств службы таблиц). Как только будут заданы правила CORS для службы, прошедший аутентификацию запрос к службе из другого домена будет оценен для определения его допустимости согласно заданным правилам.

> [!NOTE]
> Обратите внимание, что CORS не является механизмом аутентификации. Любой запрос к ресурсу хранилища, в котором включен механизм CORS, должен иметь правильную подпись аутентификации или быть направлен к открытому ресурсу.
> 
> 

## <a name="understanding-cors-requests"></a>Общие сведения о запросах CORS
Запрос CORS из исходного домена может состоять из двух отдельных запросов:

* Предварительный запрос, который запрашивает ограничения CORS, наложенные службой. Предварительный запрос является обязательным, если только методом запроса не является [простой метод](http://www.w3.org/TR/cors/), например GET, HEAD или POST.
* Фактический запрос нужного ресурса.

### <a name="preflight-request"></a>Предварительный запрос
Предварительный запрос запрашивает ограничения CORS, установленные для службы хранилища владельцем учетной записи. Браузер (или другой агент пользователя) отправляет запрос OPTIONS, содержащий заголовки запроса, метод и исходный домен. Служба хранилища оценивает планируемую операцию с учетом предварительно заданного набора правил CORS, которые указывают, какие исходные домены, методы и заголовки запросов могут быть указаны в фактических запросах к этому ресурсу хранилища.

Если для службы включен механизм CORS и установлены правила CORS, которым соответствует предварительный запрос, служба возвращает код состояния 200 (ОК) и включает в ответ требуемые заголовки Access-Control.

Если механизм CORS для службы выключен, либо предварительный запрос не соответствует ни одному правилу CORS, служба вернет код состояния 403 (доступ запрещен).

Если запрос OPTIONS не содержит необходимые заголовки CORS (заголовки Origin и Access-Control-Request-Method), служба вернет код состояния 400 (ошибочный запрос).

Обратите внимание, что предварительные запросы оцениваются относительно службы (BLOB-объектов, очередей и таблиц), а не запрошенного ресурса. Для успешного выполнения запроса владелец учетной записи должен включить механизм CORS при задании свойств службы учетных записей.

### <a name="actual-request"></a>Фактический запрос
После принятия предварительного запроса и возврата ответа браузер отправляет фактический запрос к ресурсу хранилища. В случае отклонения предварительного запроса браузер немедленно запретит данный запрос.

Фактический запрос считается обычным запросом к службе хранилища. Наличие заголовка Origin показывает, что запрос является запросом CORS, и служба проверит его на соответствие правилам CORS. Если запрос соответствует правилам, в ответ будут добавлены заголовки Access-Control, после чего запрос будет отправлен обратно клиенту. Если соответствие не будет установлено, заголовки CORS Access-Control не возвращаются.

## <a name="enabling-cors-for-the-azure-storage-services"></a>Включение CORS для служб хранилища Azure
Правила CORS задаются на уровне службы, поэтому включать или отключать CORS необходимо отдельно для каждой службы (BLOB-объектов, очередей и таблиц). По умолчанию механизм CORS отключен для всех служб. Чтобы включить CORS, необходимо задать соответствующие свойства службы с помощью версии 2013-08-15 или более поздней и добавить правила CORS в свойства службы. Дополнительные сведения о том, как включить или выключить CORS для службы и как задать правила CORS, см. в разделах [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx) (Задание свойств службы BLOB-объектов), [Set Queue Service Properties](https://msdn.microsoft.com/library/hh452232.aspx) (Задание свойств службы очередей) и [Set Table Service Properties](https://msdn.microsoft.com/library/hh452240.aspx) (Задание свойств службы таблиц).

Далее приведен образец одного правила CORS, заданного с помощью операции Set Service Properties.

```xml
<Cors>    
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com, http://www.fabrikam.com</AllowedOrigins>
        <AllowedMethods>PUT,GET</AllowedMethods>
        <AllowedHeaders>x-ms-meta-data*,x-ms-meta-target*,x-ms-meta-abc</AllowedHeaders>
        <ExposedHeaders>x-ms-meta-*</ExposedHeaders>
        <MaxAgeInSeconds>200</MaxAgeInSeconds>
    </CorsRule>
<Cors>
```

Ниже описаны все элементы, включаемые в правила CORS:

* **AllowedOrigins**. Исходные домены, которым разрешено выполнять запросы к службе хранилища с помощью CORS. Исходный домен — это домен, из которого поступает запрос. Обратите внимание, что исходный домен должен в точности соответствовать исходному домену (с учетом регистра), из которого агент пользователя отправляет запрос к службе. Можно также воспользоваться подстановочным знаком «*», чтобы разрешить всем исходным доменам делать запросы через CORS. В примере выше домены [http://www.contoso.com](http://www.contoso.com) и [http://www.fabrikam.com](http://www.fabrikam.com) могут выполнять запросы к службе с помощью CORS.
* **AllowedMethods**. Методы (команды HTTP-запросов), которые может использовать исходный домен для выполнения запроса CORS. В приведенном выше примере разрешены только запросы PUT и GET.
* **AllowedHeaders**. Заголовки запросов, которые исходный домен может указывать в запросах CORS. В приведенном выше примере разрешены все заголовки метаданных, которые начинаются с x-ms-meta-data, x-ms-meta-target и x-ms-meta-abc. Обратите внимание: подстановочный знак «*» указывает, что допустимыми являются все заголовки, начинающиеся с заданного префикса.
* **ExposedHeaders**. Заголовки ответа, которые могут быть отправлены в ответ на запрос CORS и предоставлены отправителю запроса с помощью браузера. В приведенном выше примере браузеру дано указание предоставлять любые заголовки, начинающиеся с x-ms-meta.
* **MaxAgeInSeconds**. Максимальная продолжительность хранения предварительных запросов OPTIONS в кэше браузера.

Службы хранилища Azure поддерживают заголовки с префиксами как для элементов **AllowedHeaders**, так и для элементов **ExposedHeaders**. Чтобы разрешить категорию заголовков, можно указать общий префикс для этой категории. Например, указав *x-ms-meta** в качестве заголовка с префиксом, вы тем самым устанавливаете правило, соответствующее всем заголовкам, начинающимся с x-ms-meta.

К правилам CORS применяются следующие ограничения:

* Для одной службы хранилища (BLOB-объектов, таблиц и очередей) можно задать до пяти правил CORS.
* Максимальный размер всех параметров правил CORS в запросе не должен превышать 2 КБ, исключая XML-теги.
* Длина разрешенного заголовка, представленного заголовка или разрешенного исходного домена не должна превышать 256 знаков.
* Разрешенные и представленные заголовки могут быть следующими:
  * Литеральные заголовки с точным именем заголовка, например **x-ms-meta-processed**. В запросе может быть указано до 64 литеральных заголовков.
  * Заголовки с префиксом, где указан префикс заголовка, например **x-ms-meta-data***. Указанный таким образом префикс разрешает или предоставляет любой заголовок, который начинается с этого префикса. В запросе можно задать не более 2 заголовков с префиксами.
* Методы (или HTTP-команды), указанные в элементе **AllowedMethods** , должны соответствовать методам, которые поддерживаются интерфейсами API службы хранилища Azure. Поддерживаемые методы: DELETE, GET, HEAD, MERGE, POST, OPTIONS и PUT.

## <a name="understanding-cors-rule-evaluation-logic"></a>Общие сведения о логике оценки правил CORS
Если служба хранилища получает предварительный или фактический запрос, она оценивает этот запрос по правилам CORS, которые заданы для данной службы с помощью соответствующей операции Set Service Properties. Правила CORS оцениваются в порядке, в котором они были заданы в тексте запроса операции Set Service Properties.

Правила CORS оцениваются следующим образом:

1. Сначала исходный домен, из которого поступил запрос, проверяется по списку доменов, заданных в элементе **AllowedOrigins** . Если исходный домен есть в списке или все домены разрешены с помощью подстановочного знака «*», оценка правил будет продолжена. Если исходного домена нет в списке, выполнить запрос не удастся.
2. Затем метод (или HTTP-команда) запроса проверяется по списку методов, заданных в элементе **AllowedMethods**. Если этот метод есть в списке, оценка правил будет продолжена. В противном случае выполнить запрос не удастся.
3. Если запрос соответствует правилу по своему исходному домену и методу, то это правило выбирается для обработки запроса, а проверка на соответствие другим правилам не производится. Однако запрос будет успешно выполнен только после того, как все указанные в нем заголовки будут проверены по списку заголовков, заданных в элементе **AllowedHeaders** . Если переданные заголовки не будут соответствовать допустимым заголовкам, выполнить запрос не удастся.

Так как правила обрабатываются в порядке, в котором они заданы в тексте запроса, рекомендуется сначала указывать наиболее строгие правила, чтобы оценивать их в первую очередь. Менее строгие правила указывайте в конце списка, например правило, разрешающее все исходные домены.

### <a name="example--cors-rules-evaluation"></a>Пример: проверка соответствия правилам CORS
В следующем примере показан частичный текст запроса операции задания правил CORS для служб хранилища. Дополнительные сведения о создании запросов см. в разделах [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx) (Задание свойств службы BLOB-объектов), [Set Queue Service Properties](https://msdn.microsoft.com/library/hh452232.aspx) (Задание свойств службы очередей) и [Set Table Service Properties](https://msdn.microsoft.com/library/hh452240.aspx) (Задание свойств службы таблиц).

```xml
<Cors>
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com</AllowedOrigins>
        <AllowedMethods>PUT,HEAD</AllowedMethods>
        <MaxAgeInSeconds>5</MaxAgeInSeconds>
        <ExposedHeaders>x-ms-*</ExposedHeaders>
        <AllowedHeaders>x-ms-blob-content-type, x-ms-blob-content-disposition</AllowedHeaders>
    </CorsRule>
    <CorsRule>
        <AllowedOrigins>*</AllowedOrigins>
        <AllowedMethods>PUT,GET</AllowedMethods>
        <MaxAgeInSeconds>5</MaxAgeInSeconds>
        <ExposedHeaders>x-ms-*</ExposedHeaders>
        <AllowedHeaders>x-ms-blob-content-type, x-ms-blob-content-disposition</AllowedHeaders>
    </CorsRule>
    <CorsRule>
        <AllowedOrigins>http://www.contoso.com</AllowedOrigins>
        <AllowedMethods>GET</AllowedMethods>
        <MaxAgeInSeconds>5</MaxAgeInSeconds>
        <ExposedHeaders>x-ms-*</ExposedHeaders>
        <AllowedHeaders>x-ms-client-request-id</AllowedHeaders>
    </CorsRule>
</Cors>
```

Далее рассмотрим следующие запросы CORS:

| Запрос |  |  | Ответ |  |
| --- | --- | --- | --- | --- |
| **Метод** |**Исходный домен** |**Заголовки запроса** |**Проверяемое правило** |**Результат** |
| **PUT** |http://www.contoso.com |x-ms-blob-content-type |Первое правило |Успешно |
| **GET** |http://www.contoso.com |x-ms-blob-content-type |Второе правило |Успешно |
| **GET** |http://www.contoso.com |x-ms-client-request-id |Второе правило |Сбой |

Первый запрос соответствует первому правилу: исходный домен совпадает с допустимыми исходными доменами, метод соответствует допустимым методам, а заголовок — допустимым заголовкам, поэтому он будет успешно выполнен.

Второй запрос не соответствует первому правилу, так как используемый метод не соответствует допустимым методам. Тем не менее, он соответствует второму правилу, поэтому также будет успешно выполнен.

Третий запрос соответствует второму правилу по исходному домену и методу, поэтому соответствие другим правилам не проверяется. Однако заголовок *x-ms-client-request-id header* не разрешен вторым правилом, поэтому запрос не удастся выполнить, хотя семантика третьего правила позволила бы ему успешно завершиться.

> [!NOTE]
> Несмотря на то, что в этом примере менее строгое правило задано перед более строгим, в общем рекомендуется первыми задавать более строгие правила.
> 
> 

## <a name="understanding-how-the-vary-header-is-set"></a>Общие сведения о задании заголовка Vary
Заголовок *Vary* является стандартным заголовком HTTP/1.1, который состоит из набора полей заголовка запроса. Они сообщают браузеру или агенту пользователя о критериях, выбранных сервером для обработки запроса. Заголовок *Vary* в основном используется для кэширования прокси-серверами, браузерами и сетями CDN, которые с его помощью определяют способ кэширования ответа. Дополнительную информацию см. в спецификации [заголовка Vary](http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html).

Если браузер или другой агент пользователя сохраняет ответ на запрос CORS в кэше, исходный домен кэшируется как разрешенный источник. Если второй домен выдает тот же запрос к ресурсу хранилища при активном кэше, агент пользователя получает кэшированный исходный домен. Второй домен не соответствует кэшированному домену, поэтому запрос все же не удастся выполнить, даже если по всем остальным параметрам он правильный. В некоторых случаях служба хранилища Azure присваивает заголовку Vary значение **Origin**, чтобы дать указание агенту пользователя отправлять последующий запрос CORS к службе, если отправляющий запрос домен отличается от кэшированного исходного домена.

Служба хранилища Azure присваивает заголовку *Vary* значение **Origin** для фактических запросов GET/HEAD в следующих случаях.

* Если источник запроса точно соответствует разрешенному исходному домену, заданному правилом CORS. Чтобы соответствие было точным, в правиле CORS не должно быть подстановочного знака «*».
* Источник запроса не соответствует ни одному правилу, но механизм CORS включен для службы хранилища.

Если запрос GET/HEAD соответствует правилу CORS, разрешающему все исходные домены, в ответе будет указано, что все они разрешены. А кэш агента пользователя также будет разрешать последующие запросы от любого исходного домена до тех пор, пока кэш будет активен.

Обратите внимание, что для запросов, в которых используются другие методы (отличные от GET/HEAD), службы хранилища не задают заголовок Vary, так как ответы на эти методы не кэшируются агентами пользователя.

В приведенной ниже таблице показано, как служба хранилища Azure будет реагировать на запросы GET/HEAD в описанных выше случаях.

| Запрос | Настройка учетной записи и результат проверки соответствия правилу |  |  | Ответ |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| **Заголовок исходного домена есть в запросе** |**Правила CORS, заданные для этой службы** |**Существует соответствующее правило, которое допускает все исходные домены(*)** |**Существует соответствующее правило для точно совпадающего исходного домена** |**Ответ содержит заголовок Vary, которому присвоено значение Origin** |**Ответ содержит Access-Control-Allowed-Origin: "*"** |**Ответ содержит Access-Control-Exposed-Headers** |
| Нет  |Нет  |Нет  |Нет  |Нет  |Нет  |Нет  |
| Нет  |Yes |Нет  |Нет  |Yes |Нет  |Нет  |
| Нет  |Yes |Yes |Нет  |Нет  |Yes |Yes |
| Yes |Нет  |Нет  |Нет  |Нет  |Нет  |Нет  |
| Yes |Yes |Нет  |Yes |Yes |Нет  |Yes |
| Yes |Yes |Нет  |Нет  |Yes |Нет  |Нет  |
| Yes |Yes |Yes |Нет  |Нет  |Yes |Yes |

## <a name="billing-for-cors-requests"></a>Выставление счетов за запросы CORS
Если в учетной записи вы включили CORS для какой-либо службы хранилища (вызвав операцию [Set Blob Service Properties](https://msdn.microsoft.com/library/hh452235.aspx) (Задание свойств службы BLOB-объектов), [Set Queue Service Properties](https://msdn.microsoft.com/library/hh452232.aspx) (Задание свойств службы очередей) или [Set Table Service Properties](https://msdn.microsoft.com/library/hh452240.aspx) (Задание свойств службы таблиц)), то за успешно выполненные предварительные запросы будет взиматься плата. Для максимального сокращения расходов рекомендуется установить большее значение для элемента **MaxAgeInSeconds** в правилах CORS, чтобы агент пользователя кэшировал запрос.

За невыполненные предварительные запросы плата не взимается.

## <a name="next-steps"></a>Дополнительная информация
[Задание свойств службы BLOB-объектов](https://msdn.microsoft.com/library/hh452235.aspx)

[Задание свойств службы очередей](https://msdn.microsoft.com/library/hh452232.aspx)

[Задание свойств службы таблиц](https://msdn.microsoft.com/library/hh452240.aspx)

[Спецификация общего доступа к ресурсам, независимо от источника W3C](http://www.w3.org/TR/cors/)

