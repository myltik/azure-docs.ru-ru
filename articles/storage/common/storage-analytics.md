---
title: Использование аналитики службы хранилища Azure для сбора данных журналов и метрик | Документация Майкрософт
description: Аналитика хранилища позволяет отслеживать данные метрик для всех служб хранилища, а также для сбора журналов по хранилищам BLOB-объектов, очередей и таблиц.
services: storage
documentationcenter: ''
author: roygara
manager: jeconnoc
editor: tysonn
ms.assetid: 7894993b-ca42-4125-8f17-8f6dfe3dca76
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 03/03/2017
ms.author: rogarana
ms.openlocfilehash: edda01cbfe1b53d934f9f4a7bb01c645fa680873
ms.sourcegitcommit: d74657d1926467210454f58970c45b2fd3ca088d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
ms.locfileid: "30243440"
---
# <a name="storage-analytics"></a>аналитики хранилища

Аналитика хранилища Azure ведет журналы и предоставляет данные метрик для учетной записи хранения. Эти данные можно использовать для трассировки запросов, анализа тенденций использования и диагностики проблем учетной записи хранения.

Для использования аналитики хранилища ее необходимо включить отдельно для каждой из отслеживаемых служб. Ее можно включить на [портале Azure](https://portal.azure.com). Дополнительные сведения см. в статье [Мониторинг учетной записи хранения на портале Azure](storage-monitor-storage-account.md). Аналитику хранилища также можно включить программно через REST API или клиентскую библиотеку. Чтобы включить аналитику хранилища для каждой службы, используйте операции [Get Blob Service Properties](https://msdn.microsoft.com/library/hh452239.aspx), [Get Queue Service Properties](https://msdn.microsoft.com/library/hh452243.aspx), [Get Table Service Properties](https://msdn.microsoft.com/library/hh452238.aspx) и [Get File Service Properties](https://msdn.microsoft.com/library/mt427369.aspx).

Объединенные данные хранятся в известном большом двоичном объекте (для ведения журнала) и в известных таблицах (для метрик), доступ к которым можно получить с помощью API службы BLOB-объектов и службы таблиц.

В аналитике хранилища установлено ограничение в 20 ТБ для объема хранимых данных, не зависящее от общего ограничения на вашу учетную запись хранения. Дополнительную информацию о выставлении счетов и политиках хранения данных см. в разделе [Аналитика хранилища и выставление счетов](https://msdn.microsoft.com/library/hh360997.aspx). Дополнительные сведения об ограничениях учетных записей хранения см. в разделе [Целевые показатели масштабируемости и производительности хранилища Azure](storage-scalability-targets.md).

Дополнительные указания о функциях аналитики хранилища и других инструментах идентификации, диагностики и устранения неполадок, связанных со службой хранилища Azure, см. в статье [Мониторинг, диагностика и устранение неполадок службы хранилища Microsoft Azure](storage-monitoring-diagnosing-troubleshooting.md).

## <a name="about-storage-analytics-logging"></a>Информация о ведении журнала аналитики хранилища
В аналитике хранилища регистрируется подробная информация об успешных и неудачных запросах к службе хранилища. Эта информация может использоваться для мониторинга отдельных запросов и диагностики неполадок в службе хранилища. Запросы вносятся в журнал наилучшим возможным образом.

Записи журнала создаются только при условии активности службы хранилища. Например, если обнаруживается активность учетной записи хранения в службе BLOB-объектов, но не в службе таблиц или очередей, то создаются журналы, которые относятся только к службе BLOB-объектов.

Ведение журнала службы "Аналитика Службы хранилища" недоступно для службы файлов Azure.

### <a name="logging-authenticated-requests"></a>Ведение журналов запросов, прошедших аутентификацию
Регистрируются запросы, прошедшие аутентификацию, следующих типов:

* успешные запросы;
* неудачные запросы, в том числе из-за ошибок, связанных с временем ожидания, регулированием, сетью, авторизацией и др.;
* запросы, в которых используется подписанный URL-адрес (SAS), в том числе неудачные и успешные запросы;
* запросы к данным аналитики.

Запросы, выполненные в самой аналитике хранилища, такие как запросы на создание или удаление журнала, не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](https://msdn.microsoft.com/library/hh343260.aspx) и [Формат журналов аналитики хранилища](https://msdn.microsoft.com/library/hh343259.aspx).

### <a name="logging-anonymous-requests"></a>Ведение журналов анонимных запросов
Регистрируются анонимные запросы следующих типов:

* успешные запросы;
* ошибки сервера;
* ошибки времени ожидания для клиента и сервера;
* неудачные запросы GET с кодом ошибки 304 (не изменено).

Остальные неудачные анонимные запросы не регистрируются. Полный список регистрируемых данных приведен в разделах [Операции с протоколированием и сообщения о состоянии аналитики хранилища](https://msdn.microsoft.com/library/hh343260.aspx) и [Формат журналов аналитики хранилища](https://msdn.microsoft.com/library/hh343259.aspx).

### <a name="how-logs-are-stored"></a>Хранение журналов
Все журналы хранятся в блочных больших двоичных объектах в контейнере $logs, который автоматически создается при включении аналитики хранилища для учетной записи хранения. Контейнер $logs находится в пространстве имен больших двоичных объектов учетной записи хранения, например: `http://<accountname>.blob.core.windows.net/$logs`. После включения аналитики хранилища этот контейнер нельзя удалить, но вы можете удалить его содержимое.

> [!NOTE]
> Контейнер $logs не отображается при выполнении операции листинга контейнеров, например с использованием метода [ListContainers](https://msdn.microsoft.com/library/azure/dd179352.aspx) . Доступ к нему можно получить только непосредственно. Например, для доступа к BLOB-объектам в контейнере `$logs` можно использовать метод [ListBlobs](https://msdn.microsoft.com/library/azure/dd135734.aspx).
> По мере регистрации запросов в аналитике хранилища промежуточные результаты передаются в качестве блоков. Периодически эти блоки фиксируются в аналитике хранилища и к ним предоставляется доступ как к большим двоичным объектам.
> 
> 

В журналах, созданных в один и тот же час, могут присутствовать повторяющиеся записи. Вы можете определить, является ли запись двойной, проверив идентификатор запроса **RequestId** и **номер операции**.

### <a name="log-naming-conventions"></a>Соглашения об именовании журналов
Каждый журнал записывается в следующем формате:

    <service-name>/YYYY/MM/DD/hhmm/<counter>.log

В следующей таблице описан каждый атрибут имени журнала:

| Атрибут | ОПИСАНИЕ |
| --- | --- |
| <service-name> |имя службы хранилища. Например: blob, table или queue. |
| YYYY |Четырехзначное обозначение года создания журнала. Например, 2011. |
| ММ |Двухзначное обозначение месяца создания журнала. Например, 07. |
| DD |Двухзначное обозначение месяца создания журнала. Например, 07. |
| hh |Двухзначное обозначение часа, которое указывает час начала ведения журнала, в 24-часовом формате UTC. Например, 18. |
| ММ |Двухзначное обозначение минуты, которое указывает минуту начала ведения журнала. Это значение не поддерживается в текущей версии аналитики хранилища, а его значение всегда равно 00. |
| <counter> |Шестизначный счетчик с отсчетом от нуля, который показывает количество больших двоичных объектов журнала, созданных для службы хранилища в течение часа. Отсчет этого счетчика начинается с 000000. Например, 000001. |

Ниже приведен пример полного имени журнала, в котором представлены все предыдущие примеры.

    blob/2011/07/31/1800/000001.log

Ниже приведен пример URI, который можно использовать для получения доступа к предыдущему журналу.

    https://<accountname>.blob.core.windows.net/$logs/blob/2011/07/31/1800/000001.log

При регистрации запроса хранилища имя результирующего журнала сопоставляется с часом завершения запрошенной операции. Например, если запрос GetBlob был завершен в 18:30 31 июля 2011 года, в журнал будет записан следующий префикс: `blob/2011/07/31/1800/`

### <a name="log-metadata"></a>Метаданные журнала
Все большие двоичные объекты журнала хранятся с метаданными, с помощью которых можно определить, какие данные журнала содержит большой двоичный объект. В следующей таблице описан каждый атрибут метаданных:

| Атрибут | ОПИСАНИЕ |
| --- | --- |
| LogType |Описывает, содержит ли журнал информацию, относящуюся к операциям чтения, записи или удаления. Это значение может содержать данные одного типа или сочетание всех трех типов данных, разделенных запятыми. Пример 1: write. Пример 2: read,write. Пример 3: read,write,delete. |
| StartTime |Время первой записи в журнале в формате ГГГГ-ММ-ДДTчч:мм:ссZ. Например, 2011-07-31T18:21:46Z. |
| EndTime |Время последней записи в журнале в формате ГГГГ-ММ-ДДTчч:мм:ссZ. Например, 2011-07-31T18:22:09Z. |
| LogVersion |Версия формата журнала. В настоящее время поддерживается только одно значение: 1.0 |

В следующем списке показан полный образец метаданных с использованием предыдущих примеров:

* LogType=write
* StartTime=2011-07-31T18:21:46Z
* EndTime=2011-07-31T18:22:09Z
* LogVersion=1.0

### <a name="accessing-logging-data"></a>Доступ к данным журнала
Доступ ко всем данным в контейнере `$logs` можно получить с помощью API службы BLOB-объектов, включая API-интерфейсы .NET, предоставленные в управляемой библиотеке Azure. Администратор учетной записи хранения может читать и удалять журналы, но не может создавать или обновлять их. Метаданные журнала и его имя можно использовать при запросе журнала. Журналы в определенный час могут отображаться не по порядку, но метаданные всегда указывают промежуток времени, охватываемый записями журнала. Таким образом, при поиске конкретного журнала можно использовать сочетание имен журналов и метаданных.

## <a name="about-storage-analytics-metrics"></a>Информация о метриках аналитики хранилища
Аналитика хранилища может хранить метрики, включающие сводную статистику по транзакциям и данные о емкости запросов к службе хранилища. Сообщения о транзакциях предоставляются как на уровне операций API, так и на уровне службы хранилища, а сообщения о емкости предоставляются на уровне службы хранилища. Данные метрик можно использовать для анализа использования службы хранилища, диагностики проблем с запросами к службе хранилища и повышения производительности приложений, использующих службу.

Для использования аналитики хранилища ее необходимо включить отдельно для каждой из отслеживаемых служб. Ее можно включить на [портале Azure](https://portal.azure.com). Дополнительные сведения см. в статье [Мониторинг учетной записи хранения на портале Azure](storage-monitor-storage-account.md). Аналитику хранилища также можно включить программно через REST API или клиентскую библиотеку. Используйте операции **Get Service Properties**, чтобы включить аналитику хранилища для каждой службы.

### <a name="transaction-metrics"></a>Метрики транзакций
Широкий набор данных записывается раз в час или раз в минуту для каждой службы хранилища и запрошенных операций API, включая входящие и выходящие данные, информацию о доступности, ошибки и процент категоризованных запросов. Полный список сведений о транзакциях см. в разделе [Схема таблицы для метрик аналитики хранилища](https://msdn.microsoft.com/library/hh343264.aspx).

Данные транзакций записываются на двух уровнях — уровне служб и уровне операций API. На уровне службы статистика, суммирующая все запрошенные операции API, записывается в сущность таблицы каждый час, даже если запросов к службе не было. На уровне операции API статистика записывается в сущность, только если в течение этого часа были запрошены операции.

Например, если вы выполняете операцию **GetBlob** в службе BLOB-объектов, метрики аналитики хранилища будут регистрировать запрос и включать его в объединенные данные как по службе BLOB-объектов, так и по операции **GetBlob**. Но если в течение часа операция **GetBlob** не запрашивается, сущность для этой операции не записывается в `$MetricsTransactionsBlob`.

Метрики транзакций записываются как для запросов пользователей, так и для запросов, сделанных самой аналитикой хранилища. Например, записываются запросы аналитики хранилища для записи сущностей журналов и таблиц. Дополнительную информацию о выставлении счетов для этих запросов см. в разделе [Аналитика хранилища и выставление счетов](https://msdn.microsoft.com/library/hh360997.aspx).

### <a name="capacity-metrics"></a>Метрики емкости
> [!NOTE]
> В настоящее время метрики емкости доступны только для службы BLOB-объектов. Метрики емкости для службы таблиц и службы очередей будут доступны в будущих версиях аналитики хранилища.
> 
> 

Данные о емкости записываются ежедневно для службы BLOB-объектов учетной записи хранения, и при этом записываются две сущности таблицы. Одна сущность содержит статистику пользовательских данных, а другая — статистику для контейнера больших двоичных объектов `$logs` , используемого аналитикой хранилища. Таблица `$MetricsCapacityBlob` содержит следующую статистику:

* **Capacity**. Объем хранилища, используемый службой BLOB-объектов учетной записи хранения, в байтах.
* **ContainerCount**. Количество контейнеров BLOB-объектов в службе BLOB-объектов учетной записи хранения.
* **ObjectCount**. Количество зафиксированных и незафиксированных блочных или страничных BLOB-объектов в службе BLOB-объектов учетной записи хранения.

Дополнительную информацию о метриках емкости см. в разделе [Схема таблицы для метрик аналитики хранилища](https://msdn.microsoft.com/library/hh343264.aspx).

### <a name="how-metrics-are-stored"></a>Как хранятся метрики
Все данные метрик для каждой из служб хранилища хранятся в таблицах, зарезервированных для этой службы: одна таблица для данных о транзакциях, вторая для данных о минутных транзакциях и третья для данных о емкости. Информация о транзакциях и минутных транзакциях включает в себя данные запросов и ответов, а информация о емкости содержит данные об использовании хранилища. Часовые метрики, минутные метрики и емкость для службы BLOB-объектов учетной записи хранения можно получить в таблицах, имена которых приведены в следующей таблице.

| Уровень метрик | Имена таблиц | Поддерживаемые версии |
| --- | --- | --- |
| Часовые метрики, основное расположение |$MetricsTransactionsBlob  <br/>$MetricsTransactionsTable <br/> $MetricsTransactionsQueue |Только версии до 15.08.2013 г. Таблицы с такими именами по-прежнему поддерживаются, но рекомендуется перейти на использование таблиц, приведенных ниже. |
| Часовые метрики, основное расположение |$MetricsHourPrimaryTransactionsBlob <br/>$MetricsHourPrimaryTransactionsTable <br/>$MetricsHourPrimaryTransactionsQueue |Все версии, включая 15.08.2013 г. |
| Минутные метрики, основное расположение |$MetricsMinutePrimaryTransactionsBlob <br/>$MetricsMinutePrimaryTransactionsTable <br/>$MetricsMinutePrimaryTransactionsQueue |Все версии, включая 15.08.2013 г. |
| Часовые метрики, вторичное расположение |$MetricsHourSecondaryTransactionsBlob  <br/>$MetricsHourSecondaryTransactionsTable <br/>$MetricsHourSecondaryTransactionsQueue |Все версии, включая 15.08.2013 г. Должна быть включена геоизбыточная репликация с доступом для чтения. |
| Минутные метрики, вторичное расположение |$MetricsMinuteSecondaryTransactionsBlob  <br/>$MetricsMinuteSecondaryTransactionsTable <br/>$MetricsMinuteSecondaryTransactionsQueue |Все версии, включая 15.08.2013 г. Должна быть включена геоизбыточная репликация с доступом для чтения. |
| Емкость (только для службы BLOB-объектов) |$MetricsCapacityBlob |Все версии, включая 15.08.2013 г. |

Эти таблицы автоматически создаются при включении аналитики хранилища для учетной записи хранения. Доступ к ним осуществляется через пространство имен учетной записи хранения, например: `https://<accountname>.table.core.windows.net/Tables("$MetricsTransactionsBlob")`

### <a name="accessing-metrics-data"></a>Доступ к данным метрик
Доступ ко всем данным в таблицах метрик можно получить с помощью API службы таблиц, включая API-интерфейсы .NET, предоставленные в управляемой библиотеке Azure. Администратор учетной записи хранения может читать и удалять сущности таблиц, но не может создавать или обновлять их.

## <a name="billing-for-storage-analytics"></a>Оплата аналитики хранилища
Все данные метрик записываются службами учетной записи хранения. В результате каждая из операций записи, выполняемая аналитикой хранилища, тарифицируется. Кроме того, объем хранилища, используемый данными метрик, также тарифицируется.

Плата взимается за следующие действия, выполняемые аналитикой хранилища:

* запросы на создание больших двоичных объектов для ведения журнала; 
* запросы на создание сущностей таблиц для метрик.

Если вы настроили политику хранения данных, за транзакции удаления, выполняемые, когда аналитика хранилища удаляет старые данные журналов и метрики, плата не взимается. В то же время транзакции удаления, инициируемые клиентом, тарифицируются. Дополнительную информацию о политиках хранения см. в разделе [Задание политики хранения данных для аналитик хранилища](https://msdn.microsoft.com/library/azure/hh343263.aspx).

### <a name="understanding-billable-requests"></a>Общая информация о тарифицируемых запросах
Каждый запрос к службе хранилища учетной записи либо тарифицируется, либо нет. Аналитика хранилища регистрирует каждый отдельный запрос к службе и включает сообщение о состоянии, указывающее, как был обработан запрос. Аналогичным образом аналитика хранилища сохраняет метрики как для операций службы, так и для операций API этой службы, включая процентные доли и количество определенных сообщений о состоянии. Совместно эти функции помогают проанализировать тарифицируемые запросы, улучшить приложение и диагностировать проблемы запросов к службам. Дополнительную информацию о выставлении счетов см. в разделе [Общая информация о выставлении счетов за использование хранилища Azure — пропускная способность, транзакции и емкость](http://blogs.msdn.com/b/windowsazurestorage/archive/2010/07/09/understanding-windows-azure-storage-billing-bandwidth-transactions-and-capacity.aspx).

При просмотре данных аналитики хранилища вы можете пользоваться таблицами из раздела [Операции с протоколированием и сообщения о состоянии аналитик хранилища](https://msdn.microsoft.com/library/azure/hh343260.aspx) , чтобы определить, какие запросы тарифицируются. Затем можно сверить данные журналов и метрик с сообщениями о состоянии, чтобы определить, тарифицировался ли отдельный запрос. Можно также воспользоваться таблицами из предыдущего раздела, чтобы определить доступность службы хранилища или отдельной операции API.

## <a name="next-steps"></a>Дополнительная информация
### <a name="setting-up-storage-analytics"></a>Настройка аналитики службы хранилища
* [Мониторинг учетной записи хранения на портале Azure](storage-monitor-storage-account.md)
* [Включение и настройка аналитик хранилища](https://msdn.microsoft.com/library/hh360996.aspx)

### <a name="storage-analytics-logging"></a>Ведение журнала аналитики хранилища
* [Информация о ведении журнала аналитики хранилища](https://msdn.microsoft.com/library/hh343262.aspx)
* [Формат журналов аналитик хранилища](https://msdn.microsoft.com/library/hh343259.aspx)
* [Операции с протоколированием и сообщения о состоянии аналитик хранилища](https://msdn.microsoft.com/library/hh343260.aspx)

### <a name="storage-analytics-metrics"></a>Метрики аналитики хранилища
* [Информация о метриках аналитики хранилища](https://msdn.microsoft.com/library/hh343258.aspx)
* [Схема таблицы метрик аналитики хранилища](https://msdn.microsoft.com/library/hh343264.aspx)
* [Операции с протоколированием и сообщения о состоянии аналитик хранилища](https://msdn.microsoft.com/library/hh343260.aspx)  

