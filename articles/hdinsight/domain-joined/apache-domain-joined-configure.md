---
title: "Управление присоединенными к домену кластерами HDInsight в Azure | Документы Майкрософт"
description: "Узнайте, как установить и настроить присоединенные к домену кластеры HDInsight"
services: hdinsight
documentationcenter: 
author: saurinsh
manager: jhubbard
editor: cgronlun
tags: 
ms.assetid: 0cbb49cc-0de1-4a1a-b658-99897caf827c
ms.service: hdinsight
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 11/02/2016
ms.author: saurinsh
ms.openlocfilehash: 2c844ce8aec04c74a9c2dbecdd1b3effb286df97
ms.sourcegitcommit: 6a22af82b88674cd029387f6cedf0fb9f8830afd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/11/2017
---
# <a name="configure-domain-joined-hdinsight-clusters-preview"></a>Настройка присоединенных к домену кластеров HDInsight (предварительная версия)

Узнайте, как настроить кластер Azure HDInsight с помощью Azure Active Directory (Azure AD) и [Apache Ranger](http://hortonworks.com/apache/ranger/), чтобы воспользоваться преимуществами политик строгой проверки подлинности и управления доступа на основе ролей (RBAC) с широкими возможностями.  Присоединенный к домену кластер HDInsight можно настроить только с помощью кластеров под управлением Linux. Дополнительные сведения см. в статье [Introduce Domain-joined HDInsight clusters](apache-domain-joined-introduction.md) (Введение в присоединенные к домену кластеры HDInsight).

> [!IMPORTANT]
> Oozie не включен в присоединенном к домену кластере HDInsight.

Эта статья является первым руководством в серии:

* Создайте кластер HDInsight, подключенный к Azure AD (с помощью возможностей доменных служб Azure Directory), с включенным Apache Ranger.
* Создайте и примените политики Hive с помощью Apache Ranger и разрешите пользователям (например, специалистам по обработке и анализу данных) подключиться к Hive с помощью средств на основе ODBC, например Excel, Tableau и т. д. Корпорация Майкрософт планирует в скором времени добавить другие рабочие нагрузки в присоединенный к домену кластер HDInsight, такие как HBase и Storm.

Имена служб Azure должны быть глобально уникальными. В этом руководстве используются имена, представленные ниже. Contoso — это вымышленное имя. При работе с руководством *contoso* необходимо заменить другим именем. 

**Имена:**

| Свойство | Значение |
| --- | --- |
| Каталог Azure AD |contosoaaddirectory |
| Доменное имя Azure AD |contoso (contoso.onmicrosoft.com) |
| Виртуальная сеть HDInsight |contosohdivnet |
| Группа ресурсов виртуальной сети HDInsight |contosohdirg |
| Кластер HDInsight |contosohdicluster |

В этом руководстве представлены шаги по настройке присоединенного к домену кластера HDInsight. В каждом разделе содержатся ссылки на другие статьи с дополнительными справочными сведениями.

## <a name="prerequisite"></a>Предварительные требования:
* Ознакомьтесь с [доменными службами Azure AD](https://azure.microsoft.com/services/active-directory-ds/) и их [ценовой](https://azure.microsoft.com/pricing/details/active-directory-ds/) структурой.
* Убедитесь, что ваша подписка внесена в список разрешенных подписок для этой общедоступной предварительной версии. Для этого можно отправить сообщение с идентификатором подписки по адресу hdipreview@microsoft.com.
* SSL-сертификат, подписанный заверителем подписи, или самозаверяющий сертификат для вашего домена. Сертификат требуется для настройки защищенного протокола LDAP.

## <a name="procedures"></a>Процедуры
1. Создайте виртуальную сеть HDInsight в режиме управления ресурсами Azure.
2. Создайте и настройте Azure AD и доменные службы Azure Active Directory.
3. Создание кластера HDInsight.

> [!NOTE]
> В этом руководстве предполагается, что служба Azure AD не установлена. Если она установлена, можно пропустить соответствующую часть инструкций.
> 
> 

## <a name="create-a-resource-manager-vnet-for-hdinsight-cluster"></a>Создание виртуальной сети Resource Manager для кластера HDInsight
В этом разделе вы создадите виртуальную сеть Azure Resource Manager, которая будет использоваться для кластера HDInsight. Дополнительные сведения о создании виртуальной сети Azure с помощью других методов см. в статье [Создание виртуальной сети с помощью портала Azure](../../virtual-network/virtual-networks-create-vnet-arm-pportal.md).

После создания виртуальной сети следует настроить Azure AD DS для использования этой виртуальной сети.

**Создание виртуальной сети Resource Manager**

1. Выполните вход на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать**, **Сети** и **Виртуальная сеть**. 
3. В разделе **Выбор модели развертывания** выберите **Resource Manager** и нажмите кнопку **Создать**.
4. Введите или выберите следующие значения:
   
   * **Имя**: contosohdivnet.
   * **Адресное пространство**: 10.0.0.0/16.
   * **Имя подсети**: Subnet1.
   * **Диапазон адресов подсети**: 10.0.0.0/24.
   * **Подписка**. Выберите подписку Azure.
   * **Группа ресурсов**: contosohdirg.
   * **Расположение**: (выберите то же расположение, что и для виртуальной сети Azure AD, например contosoaadvnet).
5. Щелкните **Создать**.

**Настройка DNS для виртуальной сети Resource Manager**

1. На [портале Azure](https://portal.azure.com) щелкните **Больше служб** > **Виртуальные сети**. Не щелкайте **Виртуальные сети (классика)**.
2. Щелкните **contosohdivnet**.
3. В левой части новой колонки щелкните **DNS-серверы**.
4. Щелкните **Определяется пользователем**, а затем введите следующие значения:
   
   * 10.0.0.4
   * 10.0.0.5     
     
5. Щелкните **Сохранить**.

## <a name="create-and-configure-azure-ad-ds-for-your-azure-ad"></a>Создание и настройка доменных служб Azure Active Directory для Azure AD
В этом разделе вы сделаете следующее:

1. Создадите каталог Azure AD.
2. Создадите пользователей Azure AD. Эти пользователи являются пользователями домена. Первый из них используется для настройки кластера HDInsight с помощью Azure AD.  В этом руководстве остальные два пользователя являются необязательными. Они будут использоваться в статье [Configure Hive policies for Domain-joined HDInsight clusters](apache-domain-joined-run-hive.md) (Настройка политик Hive для присоединенных к домену кластеров HDInsight) при настройке политики Apache Ranger.
3. Создадите группу "Администраторы контроллера домена AAD" и добавите в нее пользователя Azure AD. Этот пользователь используется для создания подразделения.
4. Включите доменные службы Azure Active Directory для Azure AD.
5. Настроите LDAPS для Azure AD. Протокол LDAP используется для чтения и записи в Azure AD.

Если вы предпочитаете использовать имеющийся каталог Azure AD, можно пропустить шаги 1 и 2.

**Создание каталога Azure AD**

1. На [классическом портале Azure](https://manage.windowsazure.com) щелкните **Создать** > **Службы приложений** > **Active Directory** > **Каталог** > **Настраиваемое создание**. 
2. Введите или выберите следующие значения:
   
   * **Имя**: contosoaaddirectory.
   * **Имя домена**: contoso.  Оно должно быть глобально уникальным.
   * **Страна или регион**. Выберите свою страну или регион.
3. Нажмите **Завершено**.

**Создание пользователя Azure AD**

1. На [портале Azure](https://portal.azure.com) щелкните **Azure Active Directory** > **contosoaaddirectory** > **Пользователи и группы**. 
2. Выберите в меню пункт **Все пользователи**.
3. Щелкните **Новый пользователь**.
4. Введите **Имя** и **Имя пользователя**, а затем нажмите кнопку **Далее**. 
5. Настройте профиль пользователя. В разделе **Роль** выберите **Глобальный администратор** и нажмите кнопку **Далее**.  Роль глобального администратора требуется для создания подразделений.
6. Создайте копию временного пароля.
7. Щелкните **Создать**. Далее в этом руководстве вы используете этого глобального администратора, чтобы создать кластер HDInsight.

Выполните ту же процедуру, чтобы создать еще двух пользователей с ролью **Пользователь** (hiveuser1 и hiveuser2). Они будут использоваться в статье [Configure Hive policies for Domain-joined HDInsight clusters](apache-domain-joined-run-hive.md) (Настройка политик Hive для присоединенных к домену кластеров HDInsight).

**Создание группы "Администраторы контроллера домена AAD" и добавление пользователя Azure AD**

1. На [портале Azure](https://portal.azure.com) щелкните **Azure Active Directory** > **contosoaaddirectory** > **Пользователи и группы**. 
2. В верхнем меню щелкните **Все группы**.
3. Щелкните **Новая группа**.
4. Введите или выберите следующие значения:
   
   * **Имя**: "Администраторы контроллера домена AAD".  Не изменяйте имя группы.
   * **Тип членства**: назначенное.
5. Нажмите кнопку **Выбрать**.
6. Нажмите кнопку **Участники**.
7. Выберите первого пользователя, созданного на предыдущем шаге, и нажмите **Выбрать**.
8. Повторите те же действия для создания другой группы с именем **HiveUsers** и добавьте в нее двух пользователей Hive.

Дополнительные сведения см. в разделе ["Создание группы администраторов контроллера домена AAD" в статье "Доменные службы Azure AD (предварительная версия)"](../../active-directory-domain-services/active-directory-ds-getting-started.md).

**Включение доменных служб Azure Active Directory для Azure AD**

1. На [портале Azure](https://portal.azure.com) щелкните **Создать ресурс** > **Безопасность и идентификация** > **Доменные службы Azure AD** > **Добавить**. 
2. Введите или выберите следующие значения:
   * **Имя каталога**: contosoaaddirectory
   * **Доменное имя DNS**: отображает DNS-имя по умолчанию для каталога Azure. Например, contoso.onmicrosoft.com.
   * **Расположение**: выберите свой регион.
   * **Сеть**: выберите виртуальную сеть и подсеть, которые созданы ранее. Например **contosohdivnet**.
3. Нажмите кнопку **ОК** на странице сводки. В области уведомлений будет отображено **Выполняется развертывание...**.
4. Подождите, пока исчезнет сообщение **Выполняется развертывание...** и заполнится поле **IP-адрес**. Будет указано два IP-адреса. Это IP-адреса контроллеров домена, подготовленных с помощью доменных служб. Все IP-адреса отобразятся после того, как соответствующий контроллер домена будет готов к использованию. Запишите эти два IP-адреса. Они вам потребуются позднее.

Дополнительные сведения см. в разделе [Включение доменных служб Azure Active Directory с помощью портала Azure](../../active-directory-domain-services/active-directory-ds-getting-started.md).

**Синхронизация пароля**

При использовании собственного домена необходимо синхронизировать пароль. См. раздел [Включение синхронизации паролей в доменных службах AAD для исключительно облачного каталога Azure AD](../../active-directory-domain-services/active-directory-ds-getting-started-password-sync.md).

**Настройка LDAPS для Azure AD**

1. Получите SSL-сертификат, подписанный заверителем подписи для вашего домена.
2. На [портале Azure](https://portal.azure.com) щелкните **Доменные службы Azure AD** > **contoso.onmicrosoft.com**. 
3. Включите **Защищенный протокол LDAP**.
6. Следуйте инструкциям, чтобы указать файл сертификата и пароль.  
7. Подождите, пока заполнится поле **Сертификат защищенного LDAP**. Это может занять более 10 минут.

> [!NOTE]
> Если в доменных службах Azure Active Directory выполняются некоторые фоновые задачи, при отправке сертификата может появиться следующая ошибка: <i>В этом клиенте выполняется операция. Повторите попытку позже</i>.  При возникновении этой ошибки повторите попытку через некоторое время. Для подготовки второго IP-адреса контроллера домена может понадобиться не более 3 часов.
> 
> 

Дополнительные сведения см. в статье [Настройка защищенного протокола LDAP (LDAPS) для управляемого домена доменных служб Azure AD](../../active-directory-domain-services/active-directory-ds-admin-guide-configure-secure-ldap.md).

## <a name="create-hdinsight-cluster"></a>Создание кластера HDInsight
В этом разделе вы создадите в HDInsight кластер Hadoop под управлением Linux с помощью портала Azure или [шаблона Azure Resource Manager](../../azure-resource-manager/resource-group-template-deploy.md). Сведения о других способах создания кластеров и их параметрах см. в статье [Создание кластеров Hadoop под управлением Linux в HDInsight](../hdinsight-hadoop-provision-linux-clusters.md). Дополнительные сведения о создании в HDInsight кластеров Hadoop с помощью шаблонов Resource Manager см. в статье [Создание кластеров Hadoop под управлением Windows в HDInsight с помощью шаблонов Azure Resource Manager](../hdinsight-hadoop-create-windows-clusters-arm-templates.md).

**Создание присоединенного к домену кластера HDInsight с помощью портала Azure**

1. Выполните вход на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать**, **Аналитика** и **HDInsight**.
3. В колонке **Новый кластер HDInsight** введите или выберите следующие значения:
   
   * **Имя кластера**. Введите имя нового кластера для присоединенного к домену кластера HDInsight.
   * **Подписка**. Выберите подписку Azure, используемую для создания этого кластера.
   * **Конфигурация кластера**:
     
     * **Тип кластера**: Hadoop. Сейчас присоединенный к домену кластер HDInsight поддерживается только в кластерах Hadoop, Spark и Interactive Query.
     * **Операционная система**: Linux.  Присоединенный к домену кластер HDInsight поддерживают только кластеры HDInsight под управлением Linux.
     * **Версия**: HDI 3.6. Присоединенный к домену кластер HDInsight поддерживает только кластер HDInsight версии 3.6.
     * **Тип кластера**: PREMIUM.
       
       Щелкните **Выбрать**, чтобы сохранить изменения.
   * **Учетные данные**. Настройте учетные данные для пользователя кластера и SSH.
   * **Источник данных**. Создайте учетную запись хранения или используйте существующую учетную запись хранения в качестве учетной записи хранения по умолчанию для кластера HDInsight. Расположение должно совпадать с расположением для двух виртуальных сетей.  В этом расположении также находится кластер HDInsight.
   * **Цены**. Выберите количество рабочих узлов для кластера.
   * **Advanced configurations** (Расширенные настройки): 
     
     * **Domain-joining & Vnet/Subnet** (Присоединение к домену, виртуальная сеть и подсеть): 
       
       * **Параметры домена**: 
         
         * **Доменное имя**: contoso.onmicrosoft.com.
         * **Имя пользователя в домене**. Введите имя пользователя домена. Назначьте этому домену следующие привилегии: присоединение компьютеров к домену и их помещение в указанное при создании кластера подразделение, создание субъектов-служб в указанном при создании кластера подразделении, создание обратных записей DNS. Этот пользователь домена станет администратором присоединенного к домену кластера HDInsight.
         * **Пароль домена**. Введите пароль пользователя домена.
         * **Подразделение**. Введите уникальное имя подразделения, которое необходимо использовать с кластером HDInsight. Например, OU=HDInsightOU,DC=contoso,DC=onmicrosoft,DC=com. Если такого подразделения не существует, то кластер HDInsight попытается создать его. Убедитесь, что подразделение уже существует или что учетная запись домена имеет разрешения на создание подразделения. Если использовать доменную учетную запись, которая является частью группы администраторов контроллера домена AAD, то она будет иметь необходимые разрешения для создания подразделения.
         * **LDAPS URL** (URL-адрес LDAPS): ldaps://contoso.onmicrosoft.com:636.
         * **Access user group** (Группа доступа пользователей). Укажите группу безопасности, пользователей которой требуется синхронизировать с кластером. Например, HiveUsers.
           
           Щелкните **Выбрать**, чтобы сохранить изменения.
           
           ![Настройка параметров домена на портале для присоединенного к домену кластера HDInsight](./media/apache-domain-joined-configure/hdinsight-domain-joined-portal-domain-setting.png)
       * **Виртуальная сеть**: contosohdivnet.
       * **Подсеть**: Subnet1.
         
         Щелкните **Выбрать**, чтобы сохранить изменения.        
         Щелкните **Выбрать**, чтобы сохранить изменения.
   * **Группа ресурсов**. Выберите группу ресурсов, использованную для виртуальной сети HDInsight (contosohdirg).
4. Щелкните **Создать**.  

Присоединенный к домену кластер HDInsight можно также создать с помощью шаблона управления ресурсами Azure. Эта процедура представлена далее.

**Создание присоединенного к домену кластера HDInsight с помощью шаблона управления ресурсами**

1. Щелкните следующее изображение, чтобы открыть шаблон Resource Manager на портале Azure. Шаблон Resource Manager хранится в общедоступном контейнере BLOB-объектов. 
   
    <a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fhditutorialdata.blob.core.windows.net%2Farmtemplates%2Fcreate-domain-joined-hdinsight-cluster.json" target="_blank"><img src="./media/apache-domain-joined-configure/deploy-to-azure.png" alt="Deploy to Azure"></a>
2. В колонке **Параметры** задайте следующие значения:
   
   * **Подписка**. Выберите подписку Azure.
   * **Группа ресурсов**. Щелкните **Использовать существующий** и укажите используемую группу ресурсов.  Например, contosohdirg. 
   * **Расположение**. Укажите расположение группы ресурсов.
   * **Имя кластера**. Введите имя создаваемого кластера Hadoop. Например, contosohdicluster.
   * **Тип кластера**. Выберите тип кластера.  Значение по умолчанию — **Hadoop**.
   * **Расположение**. Выберите расположение кластера.  Учетная запись хранения по умолчанию использует то же расположение.
   * **Cluster Worker Node count** (Количество рабочих узлов кластера). Выберите количество рабочих узлов.
   * **Имя для входа и пароль кластера**: имя для входа по умолчанию — **admin**.
   * **Имя пользователя SSH и пароль**: по умолчанию используется имя **sshuser**.  Это имя можно изменить. 
   * **Код виртуальной сети**: /subscriptions/&lt;идентификатор_подписки>/resourceGroups/&lt;имя_группы_ресурсов>/providers/Microsoft.Network/virtualNetworks/&lt;имя_виртуальной сети>.
   * **Подсеть виртуальной сети**: /subscriptions/&lt;идентификатор_подписки>/resourceGroups/&lt;имя_группы_ресурсов>/providers/Microsoft.Network/virtualNetworks/&lt;имя_виртуальной сети>/subnets/Subnet1.
   * **Доменное имя**: contoso.onmicrosoft.com.
   * **Organization Unit DN** (Различающееся имя подразделения): OU=HDInsightOU,DC=contoso,DC=onmicrosoft,DC=com.
   * **Cluster Users Group DNs** (Различающиеся имена групп пользователей кластера): [\"HiveUsers\"]
   * **LDAPUrls** (URL-адреса LDAPS): ["ldaps://contoso.onmicrosoft.com:636"].
   * **DomainAdminUserName** (Имя пользователя администратора домена). Введите имя пользователя администратора домена.
   * **DomainAdminPassword** (Пароль пользователя администратора домена). Введите пароль пользователя администратора домена.
   * **Я принимаю указанные выше условия**. Установите этот флажок.
   * **Закрепить на панели мониторинга**. Установите этот флажок.
3. Щелкните **Приобрести**. Вы увидите новый элемент под названием **Развертывание для развертывания шаблона**. Процесс создания кластера занимает около 20 минут. Когда кластер будет создан, щелкните его колонку на портале, чтобы открыть его.

После завершения работы с этим руководством кластер можно удалить. В случае с HDInsight ваши данные хранятся в службе хранилища Azure, что позволяет безопасно удалить неиспользуемый кластер. Плата за кластеры HDInsight взимается, даже когда они не используются. Поскольку стоимость кластера во много раз превышает стоимость хранилища, экономически целесообразно удалять неиспользуемые кластеры. Инструкции по удалению кластера см. в статье [Управление кластерами Hadoop в HDInsight с помощью портала Azure](../hdinsight-administer-use-management-portal.md#delete-clusters).

## <a name="next-steps"></a>Дальнейшие действия
* Сведения о настройке политик Hive и выполнении запросов Hive для присоединенного к домену кластера HDInsight см. [здесь](apache-domain-joined-run-hive.md).
* Сведения о подключении к присоединенным к домену кластерам HDInsight с использованием SSH см. в статье [Использование SSH с Hadoop на основе Linux в HDInsight из Linux, Unix или OS X](../hdinsight-hadoop-linux-use-ssh-unix.md#domainjoined).

