---
title: Подключение HDInsight к локальной сети в Azure HDInsight | Документация Майкрософт
description: Узнайте, как создать кластер HDInsight в виртуальной сети Azure, а затем подключить его к локальной сети. Узнайте, как настроить разрешение имен между HDInsight и локальной сетью с помощью DNS-сервера.
documentationcenter: ''
author: Blackmist
manager: jhubbard
editor: cgronlun
ms.service: hdinsight
ms.custom: hdinsightactive
ms.devlang: na
ms.topic: conceptual
ms.date: 02/23/2018
ms.author: larryfr
ms.openlocfilehash: 51307e1bdb31d902636787790d1c4f1248f3886b
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
ms.locfileid: "34361926"
---
# <a name="connect-hdinsight-to-your-on-premise-network"></a>Подключение HDInsight к локальной сети

Узнайте, как подключить HDInsight к локальной сети с помощью виртуальной сети Azure и VPN-шлюза. В этом документе содержатся следующие сведения о планировании:

* Использование HDInsight в виртуальной сети Azure, которая подключается к локальной сети.

* Настройка разрешения DNS-имен между виртуальной и локальной сетями.

* Настройка групп безопасности сети для ограничения доступа к HDInsight из Интернета.

* Порты, предоставляемые HDInsight в виртуальной сети.

## <a name="create-the-virtual-network-configuration"></a>Создание конфигурации виртуальной сети

Дополнительные сведения о том, как создать виртуальную сеть Azure, подключенную к локальной сети, см. в следующих документах:
    
* [Использование портала Azure](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal.md)

* [Использование Azure PowerShell](../vpn-gateway/vpn-gateway-create-site-to-site-rm-powershell.md)

* [Использование интерфейса командной строки Azure](../vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli.md)

## <a name="configure-name-resolution"></a>Настройка разрешения имен

Чтобы разрешить HDInsight и ресурсам в присоединенной сети связываться по имени, необходимо выполнить такие действия:

* Создать пользовательский DNS-сервер в виртуальной сети Azure.

* Настроить виртуальную сеть для использования пользовательского DNS-сервера вместо рекурсивного сопоставителя Azure по умолчанию.

* Настроить переадресацию между пользовательским и локальным DNS-сервером.

Такая конфигурация позволяет следующие действия:

* Переадресовывать запросы полных доменных имен с DNS-суффиксом __для виртуальных сетей__ к пользовательскому DNS-серверу. Затем пользовательский DNS-сервер переадресовывает эти запросы к рекурсивному сопоставителю Azure, который вернет IP-адрес.

* Переадресовывать остальные запросы на локальный DNS-сервер. Даже запросы к общедоступным интернет-ресурсам, таким как microsoft.com, переадресовываются на локальный DNS-сервер для разрешения имен.

На следующей схеме зеленые линии — это запросы ресурсов, которые заканчиваются на DNS-суффикс виртуальной сети. Синие линии — это запросы ресурсов в локальной сети или в общедоступном Интернете.

![Схема разрешения DNS-запросов в конфигурации, используемая в этом документе](./media/connect-on-premises-network/on-premises-to-cloud-dns.png)

### <a name="create-a-custom-dns-server"></a>Создание пользовательского DNS-сервера

> [!IMPORTANT]
> Перед установкой HDInsight в виртуальную сеть необходимо создать DNS-сервер и настроить его.

Чтобы создать виртуальную машину Linux, использующую программное обеспечение DNS [Bind](https://www.isc.org/downloads/bind/), выполните следующие действия:

> [!NOTE]
> В следующих шагах описывается, как с помощью [портала Azure](https://portal.azure.com) создать виртуальную машину Azure. Другие способы создания виртуальной машины см. в следующих документах:
>
> * [Создание виртуальной машины с помощью Azure CLI](../virtual-machines/linux/quick-create-cli.md)
> * [Создание виртуальной машины Linux с помощью Azure PowerShell](../virtual-machines/linux/quick-create-portal.md)

1. На [портале Azure](https://portal.azure.com) выберите __+__, __Вычисления__ и __Ubuntu Server 16.04 LTS__.

    ![Создание виртуальной машины Ubuntu](./media/connect-on-premises-network/create-ubuntu-vm.png)

2. В разделе __Основные сведения__ задайте следующие параметры:

    * __Имя.__ Понятное имя, идентифицирующее виртуальную машину. Например, __DNSProxy__.
    * __Имя пользователя.__ Имя учетной записи SSH.
    * __Открытый ключ SSH__ или __Пароль__. Метод аутентификации для учетной записи SSH. Мы рекомендуем использовать открытые ключи, так как они обеспечивают повышенную безопасность. Дополнительные сведения см.в статье [Как создать и использовать пару из открытого и закрытого ключей SSH для виртуальных машин Linux в Azure](../virtual-machines/linux/mac-create-ssh-keys.md).
    * __Группа ресурсов.__ Выберите __Использовать существующую__, а затем группу ресурсов с виртуальной сетью, созданной ранее.
    * __Расположение.__ Выберите такое же расположение, что и у виртуальной сети.

    ![Базовая конфигурация виртуальной машины](./media/connect-on-premises-network/vm-basics.png)

    Оставьте значения других записей по умолчанию и щелкните __ОК__.

3. В разделе __Выбор размера__ выберите размер виртуальной машины. Для этого руководства выберите вариант с наименьшим размером и стоимостью. Чтобы продолжить, щелкните __Выбрать__.

4. В разделе __Параметры__ задайте следующие параметры:

    * __Виртуальная сеть.__ Выберите виртуальную сеть, которая была создана ранее.

    * __Подсеть.__ Выберите подсеть по умолчанию для виртуальной сети. __Не выбирайте__ подсеть, используемую VPN-шлюзом.

    * __Учетная запись хранения диагностики.__ Создайте учетную запись хранения или выберите имеющуюся.

    ![Параметры виртуальной сети](./media/connect-on-premises-network/virtual-network-settings.png)

    Оставьте значения других записей по умолчанию и щелкните __ОК__, чтобы продолжить.

5. В разделе __Приобретение__ нажмите кнопку __Приобрести__, чтобы создать виртуальную машину.

6. После создания виртуальной машины для нее отобразится раздел __Обзор__. Из списка слева выберите __Свойства__. Сохраните значения __Общедоступный IP-адрес__ и __Частный IP-адрес__. Они будут использоваться в следующем разделе.

    ![Общедоступные и частные IP-адреса](./media/connect-on-premises-network/vm-ip-addresses.png)

### <a name="install-and-configure-bind-dns-software"></a>Установка и настройка Bind (программное обеспечение DNS)

1. Используйте SSH для подключения к __общедоступному IP-адресу__ виртуальной машины. В следующем примере устанавливается подключение к виртуальной машине по адресу 40.68.254.142:

    ```bash
    ssh sshuser@40.68.254.142
    ```

    Замените `sshuser` учетной записью пользователя SSH, указанной при создании кластера.

    > [!NOTE]
    > Есть несколько способов получить служебную программу `ssh`. В Linux, Unix и macOS она предоставляется как часть операционной системы. Если вы используете Windows, рассмотрите один из следующих вариантов:
    >
    > * [Azure Cloud Shell](../cloud-shell/quickstart.md);
    > * [Bash на платформе Ubuntu в Windows 10](https://msdn.microsoft.com/commandline/wsl/about);
    > * [Git (https://git-scm.com/)](https://git-scm.com/);
    > * [OpenSSH (https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH)](https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH).

2. Чтобы установить Bind, используйте следующие команды из сеанса SSH:

    ```bash
    sudo apt-get update -y
    sudo apt-get install bind9 -y
    ```

3. Чтобы настроить Bind на переадресацию запросов разрешения имен на локальный DNS-сервер, в качестве содержимого файла `/etc/bind/named.conf.options` добавьте следующий текст:

        acl goodclients {
            10.0.0.0/16; # Replace with the IP address range of the virtual network
            10.1.0.0/16; # Replace with the IP address range of the on-premises network
            localhost;
            localnets;
        };

        options {
                directory "/var/cache/bind";

                recursion yes;

                allow-query { goodclients; };

                forwarders {
                192.168.0.1; # Replace with the IP address of the on-premises DNS server
                };

                dnssec-validation auto;

                auth-nxdomain no;    # conform to RFC1035
                listen-on { any; };
        };

    > [!IMPORTANT]
    > Замените значения в разделе `goodclients` следующим диапазоном IP-адресов виртуальной и локальной сети. Этот раздел определяет адреса, по которым этот DNS-сервер принимает запросы.
    >
    > Замените запись `192.168.0.1` в разделе `forwarders` IP-адресом локального DNS-сервера. Эта запись направляет DNS-запросы к локальному DNS-серверу для разрешения.

    Чтобы изменить этот файл, используйте следующую команду:

    ```bash
    sudo nano /etc/bind/named.conf.options
    ```

    Чтобы сохранить файл, нажмите клавиши __CTRL+X__, затем — __Y__ и __ВВОД__.

4. В сеансе SSH используйте следующую команду:

    ```bash
    hostname -f
    ```

    Эта команда возвращает значение следующего вида:

        dnsproxy.icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net

    Текст `icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net` — это __DNS-суффикс__ для виртуальной сети. Сохраните это значение, так как оно будет использовано позже.

5. Чтобы настроить Bind для разрешения DNS-имен ресурсов в виртуальной сети, в качестве содержимого файла `/etc/bind/named.conf.local` добавьте следующий текст:

        // Replace the following with the DNS suffix for your virtual network
        zone "icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net" {
            type forward;
            forwarders {168.63.129.16;}; # The Azure recursive resolver
        };

    > [!IMPORTANT]
    > Текст `icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net` нужно заменить DNS-суффиксом, полученным ранее.

    Чтобы изменить этот файл, используйте следующую команду:

    ```bash
    sudo nano /etc/bind/named.conf.local
    ```

    Чтобы сохранить файл, нажмите клавиши __CTRL+X__, затем — __Y__ и __ВВОД__.

6. Чтобы запустить Bind, используйте следующую команду:

    ```bash
    sudo service bind9 restart
    ```

7. Чтобы убедиться, что привязка может разрешать имена ресурсов в локальной сети, используйте следующие команды:

    ```bash
    sudo apt install dnsutils
    nslookup dns.mynetwork.net 10.0.0.4
    ```

    > [!IMPORTANT]
    > Замените `dns.mynetwork.net` полным доменным именем (FQDN) ресурса в локальной сети.
    >
    > Замените `10.0.0.4` __внутренним IP-адресом__ пользовательского DNS-сервера в виртуальной сети.

    Ответ будет выглядеть следующим образом:

        Server:         10.0.0.4
        Address:        10.0.0.4#53

        Non-authoritative answer:
        Name:   dns.mynetwork.net
        Address: 192.168.0.4

### <a name="configure-the-virtual-network-to-use-the-custom-dns-server"></a>Настройка виртуальной сети для использования с пользовательским DNS-сервером

Чтобы настроить виртуальную сеть для использования с пользовательским DNS-сервером вместо рекурсивного сопоставителя Azure, сделайте следующее:

1. На [портале Azure](https://portal.azure.com) выберите виртуальную сеть, а затем — __DNS-серверы__.

2. Выберите __Custom__ (Пользовательский) и введите __внутренний IP-адрес__ пользовательского DNS-сервера. Наконец, щелкните __Сохранить__.

    ![Задание пользовательского DNS-сервера для сети](./media/connect-on-premises-network/configure-custom-dns.png)

### <a name="configure-the-on-premises-dns-server"></a>Настройка локального DNS-сервера

В предыдущем разделе пользовательский DNS-сервер настраивался для переадресации запросов на локальный DNS-сервер. Теперь необходимо настроить локальный DNS-сервер на перенаправление запросов на пользовательский DNS-сервер.

Конкретные указания о настройке DNS-сервера см. в документации по программному обеспечению конкретного DNS-сервера. Ищите указания по настройке __сервера условной пересылки__.

Сервер условной пересылки только переадресовывает запросы по определенным DNS-суффиксам. В этом случае необходимо настроить сервер пересылки для DNS-суффикса виртуальной сети. Запросы для этого суффикса должны переадресовываться на IP-адрес пользовательского DNS-сервера. 

Далее представлен пример конфигурации сервера условной пересылки для программного обеспечения DNS **Bind**:

    zone "icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net" {
        type forward;
        forwarders {10.0.0.4;}; # The custom DNS server's internal IP address
    };

Дополнительные сведения об использовании DNS в **Windows Server 2016** см. в документации по [Add-DnsServerConditionalForwarderZone](https://technet.microsoft.com/itpro/powershell/windows/dnsserver/add-dnsserverconditionalforwarderzone).

Настроив локальный DNS-сервер, можно использовать команду `nslookup` из локальной сети, чтобы убедиться, что можно разрешать имена в виртуальной сети. Следующий пример: 

```bash
nslookup dnsproxy.icb0d0thtw0ebifqt0g1jycdxd.ex.internal.cloudapp.net 196.168.0.4
```

В этом примере локальный DNS-сервер по адресу 196.168.0.4 используется для разрешения имен пользовательского DNS-сервера. Замените IP-адрес IP-адресом локального DNS-сервера. Замените адрес `dnsproxy` полным доменным именем пользовательского DNS-сервера.

## <a name="optional-control-network-traffic"></a>Управление сетевым трафиком (необязательно)

Для управления сетевым трафиком можно использовать группы безопасности сети или определяемые пользователем маршруты. Группы безопасности сети позволяют фильтровать входящий и исходящий трафик, а также разрешать или запрещать его. Определяемые пользователем маршруты позволяют управлять потоком трафика между ресурсами в виртуальной сети, Интернете и локальной сети.

> [!WARNING]
> Для HDInsight требуется входящий доступ с определенных IP-адресов в облаке Azure и неограниченный исходящий доступ. При использовании группы безопасности сети или определяемых пользователем маршрутов для управления трафиком, необходимо выполнить следующее:

1. Найдите IP-адреса расположения, которое содержит виртуальную сеть. Список требуемых IP-адресов по расположениям см. в [этом разделе](./hdinsight-extend-hadoop-virtual-network.md#hdinsight-ip).

2. Для IP-адресов, определенных на шаге 1, необходимо разрешить входящий трафик.

   * Если вы используете __NSG__: разрешите __входящий__ трафик через порт __443__ для этих IP-адресов.
   * Если вы используете __UDR__: задать __следующего прыжка__ тип маршрута для __Internet__ для IP-адресов.

Примеры использования Azure PowerShell и Azure CLI для создания групп безопасности см. в статье [Расширение возможностей HDInsight с помощью виртуальной сети Azure](./hdinsight-extend-hadoop-virtual-network.md#hdinsight-nsg).

## <a name="create-the-hdinsight-cluster"></a>Создание кластера HDInsight

> [!WARNING]
> Перед установкой HDInsight в виртуальной сети, необходимо настроить пользовательский DNS-сервер.

Следуйте указаниям в документе [Создание кластеров под управлением Linux в HDInsight с помощью портала Azure](./hdinsight-hadoop-create-linux-clusters-portal.md), чтобы создать кластер HDInsight.

> [!WARNING]
> * При создании кластера необходимо выбрать расположение, которое содержит вашу виртуальную сеть.
>
> * В разделе конфигурации __Дополнительные параметры__ нужно выбрать виртуальную сеть и подсеть, созданные ранее.

## <a name="connecting-to-hdinsight"></a>Подключение к HDInsight

В большей части документации по HDInsight предполагается, что у вас есть доступ к кластеру через Интернет. Например, что вы можете подключиться к кластеру по адресу https://CLUSTERNAME.azurehdinsight.net. Этот адрес использует общедоступный шлюз, который будет недоступен, если вы использовали группы безопасности сети или определяемые пользователем маршруты для ограничения доступа из Интернета.

В некоторых документах также указывается `headnodehost` при подключении к кластеру из сеанса SSH. Этот адрес доступен только узлам в кластере и не может использоваться в клиентах, подключенных через виртуальную сеть.

Для прямого подключения к HDInsight через виртуальную сеть сделайте следующее:

1. Чтобы найти внутренние полные доменные имена узлов кластера HDInsight, используйте один из следующих методов:

    ```powershell
    $resourceGroupName = "The resource group that contains the virtual network used with HDInsight"

    $clusterNICs = Get-AzureRmNetworkInterface -ResourceGroupName $resourceGroupName | where-object {$_.Name -like "*node*"}

    $nodes = @()
    foreach($nic in $clusterNICs) {
        $node = new-object System.Object
        $node | add-member -MemberType NoteProperty -name "Type" -value $nic.Name.Split('-')[1]
        $node | add-member -MemberType NoteProperty -name "InternalIP" -value $nic.IpConfigurations.PrivateIpAddress
        $node | add-member -MemberType NoteProperty -name "InternalFQDN" -value $nic.DnsSettings.InternalFqdn
        $nodes += $node
    }
    $nodes | sort-object Type
    ```

    ```azurecli
    az network nic list --resource-group <resourcegroupname> --output table --query "[?contains(name,'node')].{NICname:name,InternalIP:ipConfigurations[0].privateIpAddress,InternalFQDN:dnsSettings.internalFqdn}"
    ```

2. Чтобы определить порт, через который доступна служба, см. документ [Порты и универсальные коды ресурсов (URI), используемые кластерами HDInsight](./hdinsight-hadoop-port-settings-for-services.md).

    > [!IMPORTANT]
    > Некоторые службы, размещенные на головных узлах, одновременно активны только на одном узле. Если при попытке доступа к службе на одном головном узле происходит сбой, переключитесь к другому головному узлу.
    >
    > Например, Ambari одновременно активен только на одном головном узле. Если при попытке доступа к Ambari на одном головном узле он возвращает ошибку 404, значит он выполняется на другом головном узле.

## <a name="next-steps"></a>Дополнительная информация

* Дополнительные сведения об использовании HDInsight в виртуальной сети см. в статье [Расширение возможностей HDInsight с помощью виртуальной сети Azure](./hdinsight-extend-hadoop-virtual-network.md).

* Дополнительные сведения о виртуальных сетях Azure см. в статье [Виртуальная сеть Azure](../virtual-network/virtual-networks-overview.md).

* Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).

* Дополнительные сведения о пользовательских маршрутах см. в статье [User-defined routes and IP forwarding](../virtual-network/virtual-networks-udr-overview.md) (Определяемые пользователем маршруты и IP-пересылка).
