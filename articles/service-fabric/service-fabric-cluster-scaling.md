---
title: Масштабирование кластера Azure Service Fabric | Документация Майкрософт
description: Сведения о масштабировании кластеров Service Fabric.
services: service-fabric
documentationcenter: .net
author: rwike77
manager: timlt
editor: aljo
ms.assetid: 5441e7e0-d842-4398-b060-8c9d34b07c48
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/09/2018
ms.author: ryanwi
ms.openlocfilehash: f9e3f190decdc907cf57a0235b9d7142081bd2f1
ms.sourcegitcommit: eb75f177fc59d90b1b667afcfe64ac51936e2638
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2018
ms.locfileid: "34208035"
---
# <a name="scaling-service-fabric-clusters"></a>Масштабирование кластеров Service Fabric
Кластер Service Fabric — это подключенный к сети набор виртуальных машин или физических компьютеров, в котором вы развертываете микрослужбы и управляете ими. Компьютер или виртуальная машина, которая входит в состав кластера. Кластеры могут содержать тысячи узлов. После создания кластера Service Fabric можно масштабировать кластер горизонтально (изменение количества узлов) и вертикально (изменение ресурсов узлов).  Кластер можно масштабировать в любое время, даже когда в нем выполняются рабочие нагрузки.  Вместе с кластером автоматически масштабируются ваши приложения.

Зачем нужно масштабировать кластер? Требования приложения со временем изменяются.  Вам может понадобиться увеличить ресурсы кластера, чтобы удовлетворить повышенную рабочую нагрузку на приложения и высокий трафик, или уменьшить ресурсы кластера при снижении спроса.

### <a name="scaling-in-and-out-or-horizontal-scaling"></a>Свертывание и развертывание (горизонтальное масштабирование)
При таком масштабировании изменяется количество узлов в кластере.  После присоединения новых узлов к кластеру [диспетчер кластерных ресурсов](service-fabric-cluster-resource-manager-introduction.md) перемещает на них службы, что снижает общую нагрузку на существующие узлы.  При неэффективном использовании ресурсов кластера вы можете уменьшить количество узлов.  По мере уменьшения количества узлов в кластере службы перемещаются из этих узлов, а на оставшиеся узлы увеличивается нагрузка.  Уменьшение количества узлов в кластере, работающем в Azure, может сократить ваши затраты, так как вы платите за количество используемых виртуальных машин, а не за рабочую нагрузку на них.  

- Преимущества: теоретически бесконечные возможности масштабирования.  Если приложение предназначено для обеспечения масштабируемости, можно увеличивать размер без ограничений путем добавления дополнительных узлов.  Инструментарий в облачных средах позволяет легко добавлять и удалять узлы, поэтому можно легко изменить емкость и платить только за используемые ресурсы.  
- Недостатки: приложения должны быть [предназначены для масштабируемости](service-fabric-concepts-scalability.md).  В связи с этим может также потребоваться дополнительная работа с архитектурой для баз данных приложений и обеспечения сохраняемости.  Однако [надежные коллекции](service-fabric-reliable-services-reliable-collections.md) в службах Service Fabric с отслеживанием состояния значительно упрощают масштабирование данных приложения.

### <a name="scaling-up-and-down-or-vertical-scaling"></a>Увеличение и уменьшение масштаба (вертикальное масштабирование) 
При таком масштабировании изменяются ресурсы (ЦП, память и хранилище) узлов кластера.
- Преимущества: архитектура программного обеспечения и приложения остаются неизменными.
- Недостатки: предельный масштаб, так как есть ограничение на то, насколько можно увеличивать ресурсы отдельных узлов. Простой, так как нужно отключить физические или виртуальные машины, чтобы добавить или удалить ресурсы.

## <a name="scaling-an-azure-cluster-in-or-out"></a>Горизонтальное масштабирование кластера Azure
Наборы масштабирования виртуальных машин относятся к вычислительным ресурсам Azure. Их можно использовать для развертывания коллекции виртуальных машин и управления ею как набором. Каждый тип узла, определенный в кластере Azure, [настроен как отдельный масштабируемый набор](service-fabric-cluster-nodetypes.md). Каждый тип узла поддерживает возможность независимого масштабирования, имеет разные наборы открытых портов и собственные метрики емкости. 

При масштабировании кластера Azure учитывайте следующие рекомендации:
- Типы первичного узла, выполняющие производственные рабочие нагрузки, должны всегда иметь пять или более узлов.
- Типы вторичного узла, выполняющие производственные рабочие нагрузки с отслеживанием состояния, должны всегда иметь пять или более узлов.
- Типы вторичного узла, выполняющие производственные рабочие нагрузки без отслеживания состояния, должны всегда иметь два или больше узлов.
- Любой тип узла с [уровнем устойчивости](service-fabric-cluster-capacity.md#the-durability-characteristics-of-the-cluster) Gold или Silver всегда должен иметь пять или более узлов.
- Не удаляйте случайные экземпляры виртуальных машин или узлов из типа узла. Всегда используйте функцию уменьшения масштаба масштабируемого набора виртуальных машин. Удаление случайных экземпляров виртуальных машин может отрицательно сказаться на возможности системы распределять нагрузку.
- При использовании правил автоматического масштабирования настройте такие правила, чтобы уменьшение масштаба (удаление экземпляров виртуальной машины) выполнялось по одному узлу за раз. Одновременно уменьшать масштаб более одного экземпляра небезопасно.

Так как типы узлов Service Fabric в вашем кластере состоят из масштабируемых наборов виртуальных машин на сервере, для каждого типа узлов или масштабируемого набора необходимо [настроить правила автомасштабирования или выполнить масштабирование вручную](service-fabric-cluster-scale-up-down.md).

### <a name="programmatic-scaling"></a>Программное масштабирование
В большинстве сценариев [масштабирование кластера вручную или с помощью правил автомасштабирования](service-fabric-cluster-scale-up-down.md) — это оптимальное решение. В более сложных сценариях такие подходы неприемлемы. К их потенциальным недостаткам относятся следующие:

- При масштабировании вручную необходимо войти в систему и явным образом запросить операции масштабирования. Если операции масштабирования нужно выполнять часто или в непредвиденные моменты, этот подход может оказаться не лучшим решением.
- Если правила автомасштабирования удаляют экземпляр из масштабируемого набора виртуальных машин, они не удаляют автоматически сведения об этом узле из связанного кластера Service Fabric, за исключением случаев, когда тип узла имеет уровень устойчивости Silver или Gold. Правила автомасштабирования работают на уровне масштабируемого набора (а не на уровне Service Fabric), поэтому они могут удалять узлы Service Fabric без корректного завершения их работы. При таком грубом удалении узла остается фантомное состояние узла Service Fabric после операций уменьшения масштаба. Ответственное лицо (или служба) должно время от времени очищать состояние удаленных узлов из кластера Service Fabric.
- Тип узла с уровнем надежности Gold или Silver автоматически очищает удаленные узлы, поэтому дополнительная очистка не требуется.
- Правила автомасштабирования поддерживают [многие метрики](../monitoring-and-diagnostics/insights-autoscale-common-metrics.md), но их число все еще ограниченно. Если в вашем сценарии требуется масштабирование на основе метрики, которой нет в этом наборе, правила автомасштабирования могут оказаться не самым подходящим вариантом.

Подход к масштабированию Service Fabric зависит от сценария. Если масштабирование используется нечасто, возможности добавлять и удалять узлы вручную будет вполне достаточно. В более сложных сценариях используйте правила автомасштабирования и пакеты SDK, предоставляющие широкие возможности программного масштабирования.

Существуют API-интерфейсы Azure, позволяющие приложениям программно управлять масштабируемыми наборами виртуальных машин и кластерами Service Fabric. Если существующие параметры автомасштабирования не выполняются для вашего сценария, эти API-интерфейсы позволяют реализовать настраиваемую логику масштабирования. 

Один из способов реализации этой "самодельной" функции автомасштабирования заключается в добавлении новой службы без отслеживания состояния в приложение Service Fabric для управления масштабированием. Создание собственной службы масштабирования обеспечивает максимальный уровень контроля и настройки через поведение масштабирования приложения. Это может быть полезно в сценариях, в которых необходим точный контроль над временем или способом изменения масштаба приложения. Тем не менее этот элемент управления отличается сложностью кода. Для использования такого подхода нужен собственный нестандартный код масштабирования. В рамках метода `RunAsync` службы набор триггеров может определить, требуется ли масштабирование (включая проверку таких параметров, как максимальный размер кластера и время ожидания следующей операции масштабирования).   

API-интерфейс, использующийся для взаимодействий в масштабируемом наборе виртуальных машин (для проверки и изменения текущего количества экземпляров виртуальных машин), является свободной [библиотекой вычислений для управления Azure](https://www.nuget.org/packages/Microsoft.Azure.Management.Compute.Fluent/). Свободная библиотека вычислений предоставляет простой в использовании API-интерфейс для взаимодействия с масштабируемыми наборами виртуальных машин.  Для взаимодействия с кластером Service Fabric используется класс [System.Fabric.FabricClient](/dotnet/api/system.fabric.fabricclient).

Код масштабирования не должен выполняться как служба в кластере, который нужно масштабировать. Как `IAzure`, так и `FabricClient` могут удаленно подключаться к связанным ресурсам Azure, поэтому службой масштабирования вполне может быть консольное приложение или служба Windows, которая выполняется за пределами приложения Service Fabric.

С учетом этих ограничений вам может потребоваться [реализовать модели автомасштабирования с дополнительными возможностями настройки](service-fabric-cluster-programmatic-scaling.md).


## <a name="scaling-a-standalone-cluster-in-or-out"></a>Горизонтальное масштабирование автономного кластера
Автономные кластеры позволяют развертывать кластеры Service Fabric локально или у поставщика облачных служб по своему выбору.  В зависимости от развертывания типы узлов состоят из физических компьютеров или виртуальных машин. По сравнению с кластерами, запущенными в Azure, процесс масштабирования автономного кластера немного сложнее.  Необходимо вручную изменить число узлов в кластере, а затем запустить обновление его конфигурации.

При удалении узлов может выполниться несколько обновлений. Некоторые узлы будут отмечены тегом `IsSeedNode=”true”`. Их можно определить, запросив манифест кластера с использованием [Get-ServiceFabricClusterManifest](/powershell/module/servicefabric/get-servicefabricclustermanifest). Удаление таких узлов может занимать больше времени, чем других, так как в таких сценариях начальные узлы придется перемещать. Кластер должен поддерживать как минимум три первичных узла.

При масштабировании автономного кластера учитывайте следующие рекомендации:
- Замену основных узлов следует выполнять последовательно, вместо того чтобы удалять, а затем добавлять их массово.
- Прежде чем удалить тип узла, проверьте, нет ли узлов, которые ссылаются на этот тип. Перед удалением соответствующего типа узла удалите эти узлы. После удаления всех соответствующих узлов NodeType можно удалить из конфигурации кластера и начать обновление конфигурации с помощью [ServiceFabricClusterConfigurationUpgrade](/powershell/module/servicefabric/start-servicefabricclusterconfigurationupgrade).

Дополнительные сведения см. в статье [Добавление узлов в автономный кластер Service Fabric под управлением Windows Server или удаление узлов из него](service-fabric-cluster-windows-server-add-remove-nodes.md).

## <a name="scaling-an-azure-cluster-up-or-down"></a>Вертикальное масштабирование кластера Azure
Наборы масштабирования виртуальных машин относятся к вычислительным ресурсам Azure. Их можно использовать для развертывания коллекции виртуальных машин и управления ею как набором. Каждый тип узла, определенный в кластере Azure, [настроен как отдельный масштабируемый набор](service-fabric-cluster-nodetypes.md). Затем каждым типом узла можно управлять отдельно.  Вертикальное масштабирование типа узла включает в себя изменение номеров SKU экземпляров виртуальной машины в масштабируемом наборе. 

> [!WARNING]
> Мы рекомендуем не изменять номер SKU виртуальной машины масштабируемого набора или типа узла, если он не выполняется на [уровне надежности Silver или более высоком](service-fabric-cluster-capacity.md#the-durability-characteristics-of-the-cluster). Изменение размера (номера SKU) виртуальной машины — внутренняя операция инфраструктуры, которая может привести к потере данных. Без какой-либо возможности отложить или отследить это изменение вероятна ситуация, в которой операция приведет к потере данных служб с отслеживанием состояния или вызовет другие непредвиденные проблемы в работе, даже для рабочих нагрузок без отслеживания состояния. 
>

При масштабировании кластера Azure учитывайте следующие рекомендации:
- При уменьшении масштаба типа первичного узла никогда не следует задавать значение ниже, чем допускается [уровнем надежности](service-fabric-cluster-capacity.md#the-reliability-characteristics-of-the-cluster).

Процесс вертикального масштабирования типа узла отличается в зависимости от типа узла: вторичный или первичный.

### <a name="scaling-non-primary-node-types"></a>Масштабирование типов вторичных узлов
Создайте тип узла с необходимыми ресурсами.  Обновите ограничения размещения выполняемых служб, чтобы включить новый тип узла.  Постепенно (по одному за раз) уменьшите число экземпляров старого типа узла до нуля, чтобы не повлиять на надежность кластера.  Служба постепенно переходит на новый тип узла по мере вывода старого узла из эксплуатации.

### <a name="scaling-the-primary-node-type"></a>Масштабирование типа первичного узла
Мы рекомендуем не изменять номер SKU виртуальной машины типа первичного узла. Если необходима дополнительная емкость кластера, рекомендуем добавить больше экземпляров. 

Если это невозможно, создайте кластер и [восстановите состояние приложения](service-fabric-reliable-services-backup-restore.md) (если это применимо) из старого кластера. Не нужно восстанавливать состояния службы системы, так как при развертывании приложений в новом кластере они будут созданы заново. Если приложения в кластере выполнялись без отслеживания состояния, достаточно развернуть их в новом кластере. Восстановление выполнять не нужно. Если вы используете неподдерживаемый маршрут и хотите изменить номер SKU виртуальной машины, внесите изменения в определение модели масштабируемого набора виртуальных машин, указав новый номер SKU. Если в кластере используется только один тип узла, то убедитесь, что все приложения с отслеживанием состояния своевременно реагируют на все [события жизненного цикла реплики службы](service-fabric-reliable-services-lifecycle.md) (например, задержку сборки реплики) и длительность восстановления реплики службы не превышает пяти минут (для уровня устойчивости Silver). 

## <a name="next-steps"></a>Дополнительная информация
* Дополнительные сведения об [обновлениях приложений](service-fabric-concepts-scalability.md).
* [Руководство. Масштабирование кластера Service Fabric](service-fabric-tutorial-scale-cluster.md)
* [Масштабируйте кластер Azure программно](service-fabric-cluster-programmatic-scaling.md), используя свободный пакет SDK для вычислений Azure.
* [Добавление узлов в автономный кластер Service Fabric под управлением Windows Server или удаление узлов из него](service-fabric-cluster-windows-server-add-remove-nodes.md)

