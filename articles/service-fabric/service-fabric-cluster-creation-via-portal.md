
<properties
   pageTitle="Создание защищенного кластера Service Fabric с помощью портала Azure | Microsoft Azure"
   description="В этой статье описывается настройка защищенного кластера Service Fabric в Azure с помощью портала Azure и хранилища ключей Azure."
   services="service-fabric"
   documentationCenter=".net"
   authors="chackdan"
   manager="timlt"
   editor="vturecek"/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="09/21/2016"
   ms.author="vturecek"/>

# Создание кластера Service Fabric в Azure с помощью портала Azure

> [AZURE.SELECTOR]
- [Диспетчер ресурсов Azure](service-fabric-cluster-creation-via-arm.md)
- [Портал Azure](service-fabric-cluster-creation-via-portal.md)

Это пошаговое руководство поможет выполнить настройку защищенного кластера Service Fabric в Azure с помощью портала Azure. Данное руководство описывает следующие действия:

 - Настройка хранилища ключей для управления ключами для обеспечения безопасности кластера.
 - Создание защищенного кластера в Azure с помощью портала Azure.
 - Аутентификация администраторов с помощью сертификатов.

>[AZURE.NOTE] Для обеспечения дополнительных параметров безопасности, таких как аутентификация пользователей с помощью Azure Active Directory и настройка сертификатов для безопасности приложений, [создайте кластер с помощью Azure Resource Manager][create-cluster-arm].

Защищенный кластер — это кластер, который предотвращает несанкционированный доступ к операциям управления, включая развертывание, обновление и удаление приложений, служб и данных, которые они содержат. Незащищенный кластер — это кластер, к которому в любое время может подключиться любой пользователь и выполнять операции управления. Хотя можно создать незащищенный кластер, **настоятельно рекомендуется создать защищенный кластер**. Незащищенный кластер **невозможно будет защитить позднее**, для этого нужно будет создать новый кластер.

Принципы создания безопасных кластеров в Linux или Windows аналогичны. Дополнительные сведения о создании безопасных кластеров Linux, а также вспомогательные скрипты см. в разделе [Creating secure clusters on Linux](service-fabric-cluster-creation-via-arm.md#secure-linux-cluster) (Создание безопасных кластеров в Linux). Параметры, полученные с помощью вспомогательного скрипта, можно указать непосредственно на портале, как описано в разделе [Create a cluster in the Azure portal](#create-cluster-portal) (Создание кластера на портале Azure).

## Вход в Azure
В этом руководстве используется [Azure PowerShell][azure-powershell]. При запуске нового сеанса PowerShell войдите в свою учетную запись Azure и выберите подписку перед выполнением команд Azure.

Войдите в свою учетную запись Azure.

```powershell
Login-AzureRmAccount
```

Выберите свою подписку.

```powershell
Get-AzureRmSubscription
Set-AzureRmContext -SubscriptionId <guid>
```

## Настройка хранилища ключей

В этой части руководства описывается создание хранилища ключей для кластера Service Fabric в Azure и для приложений Service Fabric. Полное описание хранилища ключей см. в [руководстве по началу работы с хранилищем ключей][key-vault-get-started].

Для защиты кластера Service Fabric использует сертификаты X.509. Хранилище ключей Azure используется для управления сертификатами кластеров Service Fabric в Azure. При развертывании кластера в Azure поставщик ресурсов Azure, ответственный за создание кластеров Service Fabric, извлекает сертификаты из хранилища ключей и устанавливает их на виртуальные машины кластера.

На приведенной ниже схеме показана связь между хранилищем ключей, кластером Service Fabric и поставщиком ресурсов Azure, который использует сертификаты из хранилища ключей при создании кластера.

![Установка сертификата][cluster-security-cert-installation]

### Создание группы ресурсов

Первым шагом является создание новой группы ресурсов специально для хранилища ключей. Рекомендуется поместить хранилище ключей в собственную группу ресурсов. Это позволит удалять группы вычислительных ресурсов и ресурсов хранилища (например, группу ресурсов с кластером Service Fabric) без потери ключей и секретов. Группа ресурсов с хранилищем ключей должна находиться в том же регионе, что и кластер, который ее использует.

```powershell

	PS C:\Users\vturecek> New-AzureRmResourceGroup -Name mycluster-keyvault -Location 'West US'
	WARNING: The output object type of this cmdlet will be modified in a future release.
	
	ResourceGroupName : mycluster-keyvault
	Location          : westus
	ProvisioningState : Succeeded
	Tags              :
	ResourceId        : /subscriptions/<guid>/resourceGroups/mycluster-keyvault

```

### Создание хранилища ключей 

Создайте хранилище ключей в новой группе ресурсов. Хранилище ключей **должно быть доступно для развертывания**. Это позволит поставщику ресурсов Service Fabric получить из него сертификаты и установить их на узлах кластера.

```powershell

	PS C:\Users\vturecek> New-AzureRmKeyVault -VaultName 'myvault' -ResourceGroupName 'mycluster-keyvault' -Location 'West US' -EnabledForDeployment
	
	
	Vault Name                       : myvault
	Resource Group Name              : mycluster-keyvault
	Location                         : West US
	Resource ID                      : /subscriptions/<guid>/resourceGroups/mycluster-keyvault/providers/Microsoft.KeyVault/vaults/myvault
	Vault URI                        : https://myvault.vault.azure.net
	Tenant ID                        : <guid>
	SKU                              : Standard
	Enabled For Deployment?          : False
	Enabled For Template Deployment? : False
	Enabled For Disk Encryption?     : False
	Access Policies                  :
	                                   Tenant ID                :    <guid>
	                                   Object ID                :    <guid>
	                                   Application ID           :
	                                   Display Name             :    
	                                   Permissions to Keys      :    get, create, delete, list, update, import, backup, restore
	                                   Permissions to Secrets   :    all
	
	
	Tags                             :
```

При наличии существующего хранилища ключей можно сделать его доступным для развертывания с помощью командной строки Azure (Azure CLI).

```cli
> azure login
> azure account set "your account"
> azure config mode arm 
> azure keyvault list
> azure keyvault set-policy --vault-name "your vault name" --enabled-for-deployment true
```


## Добавление сертификатов в хранилище ключей

Сертификаты используются в Service Fabric, чтобы обеспечить функции аутентификации и шифрования для защиты различных аспектов кластера и его приложений. Дополнительные сведения о том, как сертификаты используются в Service Fabric, см. в статье [Сценарии защиты кластера Service Fabric][service-fabric-cluster-security].

### Сертификат кластера и сервера (обязательно) 

Этот сертификат требуется для защиты кластера и предотвращения несанкционированного доступа к нему. Он обеспечивает безопасность кластера несколькими способами.
 
 - **Аутентификация в кластере** позволяет аутентифицировать обмен данными между узлами для федерации кластера. Только узлы, которые могут подтвердить свою подлинность с помощью этого сертификата, могут присоединиться к кластеру.
 - **Аутентификация сервера** позволяет аутентифицировать конечные точки управления кластера в клиенте управления, чтобы он "знал", что обращается к настоящему кластеру. Этот сертификат также предоставляет SSL для API управления HTTPS и Service Fabric Explorer по протоколу HTTPS.

Для этого сертификат должен отвечать следующим требованиям:

 - Сертификат должен содержать закрытый ключ.
 - Сертификат должен быть создан для обмена ключами, которые можно экспортировать в файл обмена личной информацией (PFX-файл).
 - Имя субъекта сертификата должно совпадать с доменным именем, которое используется для обращения к кластеру Service Fabric. Это необходимо, чтобы предоставить протокол SSL для конечных точек управления HTTPS в кластере и Service Fabric Explorer. Невозможно получить SSL-сертификат от центра сертификации (ЦС) для домена `.cloudapp.azure.com`. Необходимо получить имя личного домена для кластера. При запросе сертификата из ЦС имя субъекта сертификата должно совпадать с именем личного домена, используемого для кластера.

### Сертификаты проверки подлинности клиента

Дополнительные сертификаты клиента используются для аутентификации администраторов при выполнении задач управления кластером. Service Fabric имеет два уровня доступа: **администратор** и **пользователь только для чтения**. Необходимо использовать хотя бы один сертификат для административного доступа. Для получения дополнительного доступа на уровне пользователя необходимо предоставить отдельный сертификат. Дополнительные сведения о ролях доступа см. в статье [Контроль доступа на основе ролей для клиентов Service Fabric][service-fabric-cluster-security-roles].

Для работы с Service Fabric не нужно передавать сертификаты проверки подлинности клиента в хранилище ключей. Эти сертификаты должны предоставляться только пользователям, уполномоченным осуществлять управление кластером.

>[AZURE.NOTE] Azure Active Directory является рекомендуемым способом аутентификации клиентов при допуске к операциям управления кластером. Для использования Azure Active Directory необходимо [создать кластер с помощью Azure Resource Manager][create-cluster-arm].

### Сертификаты приложения (необязательно)

В кластере можно установить любое количество дополнительных сертификатов для обеспечения безопасности приложений. Перед созданием кластера рассмотрите сценарии безопасности приложений, которые требуют установки сертификатов на узлах, в том числе:

 - шифрование и расшифровка значений конфигурации приложений;
 - шифрование данных между узлами во время репликации.

При создании кластера с помощью портала Azure настройка сертификатов приложения недоступна. Чтобы настроить сертификаты приложения в процессе настройки кластера, необходимо [создать кластер с помощью Azure Resource Manager][create-cluster-arm]. Также можно добавить сертификаты приложения в кластер после его создания.

### Форматирование сертификатов для использования поставщиком ресурсов Azure

Файлы закрытого ключа (PFX-файлы) можно добавить в хранилище ключей и использовать непосредственно из него. Тем не менее поставщику ресурсов Azure необходимо, чтобы ключи хранились в специальном формате JSON, включающем в себя PFX-файл в виде строки в кодировке Base64 и пароль закрытого ключа. Чтобы соблюсти эти требования, ключи должны быть помещены в строку JSON и сохранены как *секреты* в хранилище ключей.

Для упрощения этого процесса [на сайте GitHub][service-fabric-rp-helpers] доступен соответствующий модуль PowerShell. Ниже приведены указания по использованию этого модуля.

 1. Скачайте все содержимое репозитория в локальный каталог.
 2. Импортируйте модуль в окне PowerShell.

```powershell
  PS C:\Users\vturecek> Import-Module "C:\users\vturecek\Documents\ServiceFabricRPHelpers\ServiceFabricRPHelpers.psm1"
```
     
Команда `Invoke-AddCertToKeyVault` в этом модуле PowerShell автоматически форматирует закрытый ключ сертификата в строку JSON и передает ее в хранилище ключей. Используйте его для добавления сертификата кластера и всех дополнительных сертификатов приложения в хранилище ключей. Повторите этот шаг для всех дополнительных сертификатов, которые нужно установить в кластере.

```powershell
PS C:\Users\vturecek> Invoke-AddCertToKeyVault -SubscriptionId <guid> -ResourceGroupName mycluster-keyvault -Location "West US" -VaultName myvault -CertificateName mycert -Password "<password>" -UseExistingCertificate -ExistingPfxFilePath "C:\path\to\mycertkey.pfx"
	
	Switching context to SubscriptionId <guid>
	Ensuring ResourceGroup mycluster-keyvault in West US
	WARNING: The output object type of this cmdlet will be modified in a future release.
	Using existing valut myvault in West US
	Reading pfx file from C:\path\to\key.pfx
	Writing secret to myvault in vault myvault
	
	
Name  : CertificateThumbprint
Value : <value>

Name  : SourceVault
Value : /subscriptions/<guid>/resourceGroups/mycluster-keyvault/providers/Microsoft.KeyVault/vaults/myvault

Name  : CertificateURL
Value : https://myvault.vault.azure.net:443/secrets/mycert/4d087088df974e869f1c0978cb100e47

```

Это все обязательные компоненты хранилища ключей, необходимые для настройки шаблона Resource Manager кластера Service Fabric, который устанавливает сертификаты для аутентификации на узлах, защиты конечных точек управления и аутентификации на них, а также для каких-либо дополнительных функций безопасности приложений, которые используют сертификаты X.509. На этом этапе в Azure должна быть представлена следующая конфигурация:

 - группа ресурсов хранилища ключей;
   - хранилище ключей;
     - сертификат проверки подлинности сервера кластера;

</a "create-cluster-portal" ></a>
## Создание кластера на портале Azure

### Поиск кластерных ресурсов Service Fabric

![поиск шаблона кластера Service Fabric на портале Azure.][SearchforServiceFabricClusterTemplate]

 1. Выполните вход на [портал Azure][azure-portal].

 2. Щелкните **Создать**, чтобы добавить новый шаблон ресурсов. Найдите шаблон "Кластер Service Fabric" в **Marketplace** в разделе **Все**.

 3. Выберите в списке **Кластер Service Fabric**.

 4. Перейдите к колонке **Кластер Service Fabric** и щелкните **Создать**.

 5. В колонке **Создание кластера Service Fabric** необходимо выполнить четыре шага.

#### 1\. Основы

![Снимок экрана: создание группы ресурсов.][CreateRG]

В колонке "Основные сведения" требуется указать основные сведения для кластера.

 1. Введите имя кластера.

 2. Введите **имя пользователя** и **пароль** для удаленного рабочего стола виртуальных машин.

 3. Выберите **подписку**, в которой вы хотите развернуть кластер, особенно при наличии нескольких подписок.

 4. Создайте **новую группу ресурсов**. Рекомендуется присвоить ей имя, совпадающее с именем кластера. Это облегчит дальнейший поиск, особенно при внесении изменений в развертывание или удалении кластера.

    >[AZURE.NOTE] Хотя вы можете использовать существующую группу ресурсов, рекомендуется создать новую. Это позволит легко удалить ненужные кластеры.

 5. Выберите **регион**, в котором требуется создать кластер. Необходимо использовать тот же регион, в котором расположено ваше хранилище ключей.

#### 2) Конфигурация кластера

![Создание типа узла][CreateNodeType]

Настройте узлы кластера. Он определяет размер виртуальных машин, их количество и свойства. Кластер может содержать узлы нескольких типов, однако первичный узел (тот, который вы задали на портале) должен включать не менее пяти виртуальных машин, так как на узлах такого типа расположены системные службы Service Fabric. Не настраивайте параметры **Свойства размещения**, так как стандартное свойство размещения NodeTypeName добавляется автоматически.

   >[AZURE.NOTE] Распространенный сценарий для нескольких типов узлов — это приложение, содержащее интерфейсную и серверную службы. Интерфейсную службу нужно разместить на виртуальных машинах меньшего размера (например, D2) с портами, открытыми для доступа через Интернет, а серверную службу — на более крупных виртуальных машинах (D4, D6, D15 и т. д.) без портов, имеющих выход в Интернет.

 1. Выберите имя для типа узла (от 1 до 12 буквенно-цифровых символов).

 2. Минимальный **размер** виртуальных машин для первичного узла зависит от выбранного для кластера уровня **устойчивости**. Значение по умолчанию для уровня устойчивости — bronze (бронзовый). Дополнительные сведения об уровнях устойчивости см. в статье [Рекомендации по планированию загрузки кластера Service Fabric][service-fabric-cluster-capacity].

 3. Выберите ценовую категорию и размер виртуальной машины. Виртуальные машины серии D оснащены твердотельными накопителями (SSD) и настоятельно рекомендуются для приложений с отслеживанием состояния. Не используйте SKU виртуальной машины с частичными ядрами и менее чем 7 ГБ свободного места на диске.

 4. Минимальное **количество** виртуальных машин для первичного узла зависит от выбранного для кластера уровня **надежности**. Значение по умолчанию для уровня надежности — Silver. Дополнительные сведения о надежности см. в статье [Рекомендации по планированию загрузки кластера Service Fabric][service-fabric-cluster-capacity].

 5. Выберите количество виртуальных машин для типа узла. Количество виртуальных машин для типа узла можно увеличить или уменьшить позже, но минимальное количество виртуальных машин на первичном узле зависит от выбранного уровня надежности. Для других типов узлов можно задать минимум 1 виртуальную машину.

 6. Настройте пользовательские конечные точки. Это поле позволяет ввести список портов с разделителями-запятыми. С помощью Azure Load Balancer для приложений будет открыт общий доступ через Интернет к указанным здесь портам. Например, если вы планируете развернуть в своем кластере веб-приложение, то введите здесь "80", чтобы разрешить в этом кластере трафик через порт 80. Дополнительные сведения о конечных точках см. в статье [Подключение к службам в Service Fabric и взаимодействие с ними][service-fabric-connect-and-communicate-with-services].

 7. Настройте **систему диагностики** кластера. Диагностика в кластере включена по умолчанию. Это упрощает устранение неполадок. Если вы хотите отключить систему диагностику, установите переключатель **Состояние** в положение **Выкл.**. Отключать систему диагностики **не** рекомендуется.

 9. Выберите режим обновления Service Fabric, который необходимо задать для кластера. Если требуется, чтобы система автоматически получала последнюю версию и выполняла попытку обновить до нее кластер, выберите пункт **Автоматически**. Если вы хотите выбирать поддерживаемую версию, задайте режим **Вручную**.

>[AZURE.NOTE] Корпорация Майкрософт поддерживает только кластеры под управлением поддерживаемых версий Service Fabric. Выбрав режим **Вручную**, вы принимаете на себя ответственность за обновление кластера до поддерживаемой версии. Дополнительные сведения о режиме обновления Service Fabric см. в статье [Обновление кластера Service Fabric][service-fabric-cluster-upgrade].


#### 3\. Безопасность

![Снимок экрана: настройка безопасности на портале Azure.][SecurityConfigs]

Последним шагом является предоставление сведений о сертификате для защиты кластера с помощью хранилища ключей, а также ранее созданных сведений о сертификате.

 
- Заполните поля основного сертификата, используя выходные данные, полученные при передаче **сертификата кластера** в хранилище ключей с помощью команды PowerShell `Invoke-AddCertToKeyVault`.

```powershell
Name  : CertificateThumbprint
Value : <value>

Name  : SourceVault
Value : /subscriptions/<guid>/resourceGroups/mycluster-keyvault/providers/Microsoft.KeyVault/vaults/myvault

Name  : CertificateURL
Value : https://myvault.vault.azure.net:443/secrets/mycert/4d087088df974e869f1c0978cb100e47
```

- Установите флажок **Настройка дополнительных параметров**, чтобы ввести сертификаты клиента в поля **Клиент администратора** и **Клиент только для чтения**. В эти поля введите отпечаток сертификата клиента администратора и отпечаток сертификата клиента только для чтения (при наличии). Когда администраторы пытаются подключиться к кластеру, им предоставляется доступ только в том случае, если у них есть сертификат с отпечатком, соответствующим указанным здесь значениям.


#### 4\. Резюме

![Снимок экрана: начальная доска с заголовком "Развертывание кластера Service Fabric".][Notifications]

Чтобы завершить создание кластера, щелкните **Сводка** и проверьте указанные параметры или скачайте шаблон Azure Resource Manager, который используется для развертывания кластера. После указания обязательных параметров активируется кнопка **ОК**. Нажав ее, вы сможете начать процесс создания кластера.

Ход создания кластера будет отображаться в области уведомлений. (Щелкните значок колокольчика рядом со строкой состояния в правом верхнем углу экрана). Если при создании кластера вы установили флажок **Закрепить на начальной панели**, то на **начальной доске** вы увидите закрепленный элемент **Deploying Service Fabric Cluster** (Развертывание кластера Service Fabric).

### Просмотр состояния кластера

![Снимок экрана: сведения о кластере на панели мониторинга.][ClusterDashboard]

После создания кластера его можно просмотреть на портале.

 1. Щелкните **Обзор** и выберите **Кластеры Service Fabric**.

 2. Найдите нужный кластер и щелкните его.

 3. На панели мониторинга отобразятся подробные сведения о кластере, включая общедоступную конечную точку кластера и ссылку на Service Fabric Explorer.

В разделе **Node Monitor** (Монитор узла) колонки панели мониторинга кластера отображается количество работоспособных и неработоспособных виртуальных машин. Дополнительные сведения о состоянии работоспособности кластеров см. в статье [Общие сведения о наблюдении за работоспособностью системы в Service Fabric][service-fabric-health-introduction].

>[AZURE.NOTE] Для постоянной работы кластеров Service Fabric требуется определенное количество узлов, чтобы все время поддерживать доступность и сохранять состояние, которое называется "поддержание кворума". Поэтому обычно не рекомендуется завершать работу всех виртуальных машин в кластере, пока не будет выполнено [полное резервное копирование состояния][service-fabric-reliable-services-backup-restore], так как это может быть небезопасно.

## Удаленное подключение к экземпляру из набора масштабирования виртуальных машин или узлу кластера

Каждый из типов узлов, задаваемый в кластере, отражается на конфигурации набора масштабирования виртуальных машин. Дополнительные сведения см. в разделе [Удаленное подключение к экземпляру масштабируемого набора ВМ или узлу кластера][remote-connect-to-a-vm-scale-set].

## Дальнейшие действия

На этом этапе у вас имеется защищенный кластер, использующий сертификаты для аутентификации управления. Далее вы можете [подключиться к этому кластеру](service-fabric-connect-to-secure-cluster.md) и узнать, как [управлять секретами приложений](service-fabric-application-secret-management.md).


<!-- Links -->
[azure-powershell]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[service-fabric-rp-helpers]: https://github.com/ChackDan/Service-Fabric/tree/master/Scripts/ServiceFabricRPHelpers
[azure-portal]: https://portal.azure.com/
[key-vault-get-started]: ../key-vault/key-vault-get-started.md
[create-cluster-arm]: https://manage.windowsazure.com
[service-fabric-cluster-security]: service-fabric-cluster-security.md
[service-fabric-cluster-security-roles]: service-fabric-cluster-security-roles.md
[service-fabric-cluster-capacity]: service-fabric-cluster-capacity.md
[service-fabric-connect-and-communicate-with-services]: service-fabric-connect-and-communicate-with-services.md
[service-fabric-health-introduction]: service-fabric-health-introduction.md
[service-fabric-reliable-services-backup-restore]: service-fabric-reliable-services-backup-restore.md
[remote-connect-to-a-vm-scale-set]: service-fabric-cluster-nodetypes.md#remote-connect-to-a-vm-scale-set-instance-or-a-cluster-node
[service-fabric-cluster-upgrade]: service-fabric-cluster-upgrade.md

<!--Image references-->
[SearchforServiceFabricClusterTemplate]: ./media/service-fabric-cluster-creation-via-portal/SearchforServiceFabricClusterTemplate.png
[CreateRG]: ./media/service-fabric-cluster-creation-via-portal/CreateRG.png
[CreateNodeType]: ./media/service-fabric-cluster-creation-via-portal/NodeType.png
[SecurityConfigs]: ./media/service-fabric-cluster-creation-via-portal/SecurityConfigs.png
[Notifications]: ./media/service-fabric-cluster-creation-via-portal/notifications.png
[ClusterDashboard]: ./media/service-fabric-cluster-creation-via-portal/ClusterDashboard.png
[cluster-security-cert-installation]: ./media/service-fabric-cluster-creation-via-arm/cluster-security-cert-installation.png

<!---HONumber=AcomDC_0928_2016-->