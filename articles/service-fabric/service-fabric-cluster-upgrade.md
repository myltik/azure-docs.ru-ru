---
title: Обновление кластера Azure Service Fabric | Документация Майкрософт
description: Обновление кода и (или) конфигурации Service Fabric, под управлением которой работает кластер Service Fabric, в том числе изменение режима обновления кластера, обновление сертификатов, добавление портов приложений, применение исправлений для ОС и т. д. Чего можно ожидать при выполнении обновлений?
services: service-fabric
documentationcenter: .net
author: aljo-microsoft
manager: timlt
editor: ''
ms.assetid: 15190ace-31ed-491f-a54b-b5ff61e718db
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: conceptual
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 8/10/2017
ms.author: aljo
ms.openlocfilehash: 3e5ef2cbc9d7bec82cadc0c7663de52636938505
ms.sourcegitcommit: eb75f177fc59d90b1b667afcfe64ac51936e2638
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2018
ms.locfileid: "34207705"
---
# <a name="upgrade-an-azure-service-fabric-cluster"></a>Обновление кластера Azure Service Fabric
> [!div class="op_single_selector"]
> * [Кластер Azure](service-fabric-cluster-upgrade.md)
> * [Автономный кластер](service-fabric-cluster-upgrade-windows-server.md)
> 
> 

Для любой современной системы разработка с учетом возможности модернизации является неотъемлемой составляющей успеха продукта. Кластер Service Fabric Azure представляет собой ресурс, который принадлежит вам, но частично управляется корпорацией Майкрософт. В этой статье содержатся сведения о компонентах, управляемых автоматически, и о том, что можно настроить самостоятельно.

## <a name="controlling-the-fabric-version-that-runs-on-your-cluster"></a>Управление версиями Service Fabric в кластере
Вы можете настроить для кластера автоматическое обновление Service Fabric по мере выпуска новых версий корпорацией Майкрософт или выбрать поддерживаемую версию, в которой должен работать ваш кластер.

Для этого нужно настроить параметр upgradeMode в конфигурации кластера с помощью портала или Resource Manager. Это можно сделать как при создания кластера, так и во время его работы. 

> [!NOTE]
> Обязательно следите за тем, чтобы кластер работал под управлением поддерживаемой версии Service Fabric. Когда мы объявляем о выпуске новой версии Service Fabric, для предыдущей версии определяется срок завершения жизненного цикла. Этот срок составляет по меньшей мере 60 дней. О доступности новых выпусков сообщается в [блоге группы разработчиков Service Fabric](https://blogs.msdn.microsoft.com/azureservicefabric/). после чего вы можете использовать их. 
> 
> 

За 14 дней до истечения жизненного цикла выпуска, под управлением которого работает ваш кластер, будет создано событие работоспособности, которое переводит кластер в состояние предупреждения. Состояние предупреждения изменится, когда кластер будет обновлен до поддерживаемой версии.

### <a name="setting-the-upgrade-mode-via-portal"></a>Настройка режима обновления через портал
При создании кластера вы можете выбрать режим обновления: автоматический или вручную.

![Create_Manualmode][Create_Manualmode]

Эти варианты режима обновления можно также указать для работающего кластера, используя интерфейс управления. 

#### <a name="upgrading-to-a-new-version-on-a-cluster-that-is-set-to-manual-mode-via-portal"></a>Обновление кластера, для которого установлен режим обновления вручную, с помощью портала.
Чтобы обновить кластер до новой версии, нужно просто выбрать доступную версию в раскрывающемся списке и сохранить изменения. Обновление Service Fabric запустится автоматически. В ходе обновления соблюдаются все политики работоспособности кластера (политики, определяющие состояние работоспособности для узлов и всех приложений, выполняющихся в кластере).

Если требования политик работоспособности кластера не реализуются, выполняется откат обновления. Прокрутите этот документ вниз, чтобы узнать о том, как настроить пользовательские политики работоспособности. 

Устранив проблемы, которые привели к откату, запустите обновление снова, выполнив те же действия.

![Manage_Automaticmode][Manage_Automaticmode]

### <a name="setting-the-upgrade-mode-via-a-resource-manager-template"></a>Настройка режима обновления с помощью шаблона Resource Manager
Добавьте параметр upgradeMode к определению ресурса Microsoft.ServiceFabric/clusters, а для параметра clusterCodeVersion установите значение одной из поддерживаемых версий Service Fabric, как показано ниже, а затем разверните шаблон. Для параметра upgradeMode поддерживаются значения Manual и Automatic.

![ARMUpgradeMode][ARMUpgradeMode]

#### <a name="upgrading-to-a-new-version-on-a-cluster-that-is-set-to-manual-mode-via-a-resource-manager-template"></a>Обновление кластера, для которого установлен режим обновления вручную, с помощью шаблона Resource Manager
Чтобы обновить до новой версии кластер, для которого установлен режим обновления вручную, замените значение параметра clusterCodeVersion значением поддерживаемой версии и разверните шаблон. Развертывание шаблона автоматически запускает обновление Service Fabric. В ходе обновления соблюдаются все политики работоспособности кластера (политики, определяющие состояние работоспособности для узлов и всех приложений, выполняющихся в кластере).

Если требования политик работоспособности кластера не реализуются, выполняется откат обновления. Прокрутите этот документ вниз, чтобы узнать о том, как настроить пользовательские политики работоспособности. 

Устранив проблемы, которые привели к откату, запустите обновление снова, выполнив те же действия.

### <a name="get-list-of-all-available-version-for-all-environments-for-a-given-subscription"></a>Получение списка всех доступных версий для всех сред в указанной подписке
Запустите следующую команду, и вы увидите результат, аналогичный приведенному ниже.

Параметр supportExpiryUtc сообщает, когда истекает или истек срок действия текущей версии. Для последнего выпуска нет допустимой даты, то есть параметр имеет значение 9999-12-31T23:59:59.9999999. Это означает, что дата окончания срока действия еще не определена.

```REST
GET https://<endpoint>/subscriptions/{{subscriptionId}}/providers/Microsoft.ServiceFabric/locations/{{location}}/clusterVersions?api-version=2016-09-01

Example: https://management.azure.com/subscriptions/1857f442-3bce-4b96-ad95-627f76437a67/providers/Microsoft.ServiceFabric/locations/eastus/clusterVersions?api-version=2016-09-01

Output:
{
                  "value": [
                    {
                      "id": "subscriptions/35349203-a0b3-405e-8a23-9f1450984307/providers/Microsoft.ServiceFabric/environments/Windows/clusterVersions/5.0.1427.9490",
                      "name": "5.0.1427.9490",
                      "type": "Microsoft.ServiceFabric/environments/clusterVersions",
                      "properties": {
                        "codeVersion": "5.0.1427.9490",
                        "supportExpiryUtc": "2016-11-26T23:59:59.9999999",
                        "environment": "Windows"
                      }
                    },
                    {
                      "id": "subscriptions/35349203-a0b3-405e-8a23-9f1450984307/providers/Microsoft.ServiceFabric/environments/Windows/clusterVersions/4.0.1427.9490",
                      "name": "5.1.1427.9490",
                      "type": " Microsoft.ServiceFabric/environments/clusterVersions",
                      "properties": {
                        "codeVersion": "5.1.1427.9490",
                        "supportExpiryUtc": "9999-12-31T23:59:59.9999999",
                        "environment": "Windows"
                      }
                    },
                    {
                      "id": "subscriptions/35349203-a0b3-405e-8a23-9f1450984307/providers/Microsoft.ServiceFabric/environments/Windows/clusterVersions/4.4.1427.9490",
                      "name": "4.4.1427.9490",
                      "type": " Microsoft.ServiceFabric/environments/clusterVersions",
                      "properties": {
                        "codeVersion": "4.4.1427.9490",
                        "supportExpiryUtc": "9999-12-31T23:59:59.9999999",
                        "environment": "Linux"
                      }
                    }
                  ]
                }


```

## <a name="fabric-upgrade-behavior-when-the-cluster-upgrade-mode-is-automatic"></a>Обновление настроек Service Fabric для кластера с автоматическим режимом обновления
Майкрософт поддерживает код и конфигурацию системы Service Fabric, которая выполняется в кластере Azure. По мере необходимости мы выполняем автоматические контролируемые обновления программного обеспечения. Эти обновления могут затрагивать код, конфигурацию или и то, и другое. Чтобы обновления не затрагивали приложение или оказывали на него минимальное влияние, обновление выполняется поэтапно.

### <a name="phase-1-an-upgrade-is-performed-by-using-all-cluster-health-policies"></a>Этап 1. Выполнение обновления с помощью всех политик работоспособности кластера
В ходе этого этапа обновления применяются к одному домену обновления за раз, а приложения, которые были запущены в кластере, продолжают работать без простоев. В ходе обновления соблюдаются все политики работоспособности кластера (политики, определяющие состояние работоспособности для узлов и всех приложений, выполняющихся в кластере).

Если требования политик работоспособности кластера не реализуются, выполняется откат обновления. Затем владельцу подписки отправляется сообщение электронной почты. Оно содержит следующую информацию:

* Уведомление о том, что нам пришлось выполнить откат обновления кластера.
* Рекомендуемые действия по решению проблемы, при их наличии.
* Количество дней (n) до выполнения этапа 2.

Мы постараемся выполнить аналогичное обновление еще несколько раз в случае, если причины неудачи связаны с инфраструктурой. Через n дней с момента отправки сообщения мы переходим к этапу 2.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторного запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется. Это позволяет избежать отправки чрезмерного количества сообщений. Получение сообщения следует рассматривать как исключение из обычного режима. Мы надеемся, что большинство обновлений кластера будет выполнено без ущерба для доступности вашего приложения.

### <a name="phase-2-an-upgrade-is-performed-by-using-default-health-policies-only"></a>Этап 2. Выполнение обновления с помощью только политик работоспособности по умолчанию
Политики работоспособности на этом этапе задаются таким образом, что ряд приложений, которые были работоспособны в начале обновления, остаются неизменными в течение всего процесса обновления. Как и в ходе этапа 1, на этапе 2 обновления применяются к одному домену обновления за раз, а приложения, которые были запущены в кластере, продолжают работать без простоев. В течение применения обновления действуют политики работоспособности кластера (это сочетание состояния работоспособности узла и всех приложений, выполняющихся в кластере).

Если применяемые политики работоспособности кластера фактически не соблюдаются, выполняется откат обновления. Затем владельцу подписки отправляется сообщение электронной почты. Оно содержит следующую информацию:

* Уведомление о том, что нам пришлось выполнить откат обновления кластера.
* Рекомендуемые действия по решению проблемы, при их наличии.
* Количество дней (n) до выполнения этапа 3.

Мы постараемся выполнить аналогичное обновление еще несколько раз в случае, если причины неудачи связаны с инфраструктурой. За несколько дней до назначенного срока владельцу подписки отправляется сообщение с напоминанием. Через n дней с момента отправки сообщения мы переходим к этапу 3. К сообщениям, которые отправляются на этапе 2, следует отнестись серьезно и выполнить действия по устранению ошибок.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторного запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется.

### <a name="phase-3-an-upgrade-is-performed-by-using-aggressive-health-policies"></a>Этап 3. Выполнение обновления с помощью жестких политик работоспособности кластера
Эти политики работоспособности на данном этапе предназначены для выполнения обновления, а не обеспечения работоспособности приложений. Этот этап очень редко применяется для обновления кластера. Если ваш кластер достигает этого этапа, есть высокая вероятность того, что ваше приложение перейдет в неработоспособное состояние и (или) будет недоступно.

Как и на других двух этапах, обновления на этапе 3 применяются к одному домену обновления за раз.

Если требования политик работоспособности кластера не реализуются, выполняется откат обновления. Мы постараемся выполнить аналогичное обновление еще несколько раз в случае, если причины неудачи связаны с инфраструктурой. После этого кластер закрепляется и больше не будет получать поддержку и обновления.

Сообщение с этими сведениями и корректирующими действиями отправляется владельцу подписки. Мы не ожидаем перехода кластеров в состояние, в котором произошел сбой этапа 3.

Если политики работоспособности кластера соблюдены, обновление считается успешным и помечается как завершенное. Это может произойти во время первоначального или повторного запусков обновлений на этом этапе. В случае успешного выполнения сообщение с подтверждением не отправляется.

## <a name="cluster-configurations-that-you-control"></a>Управляемая пользователем конфигурация кластера
Наряду с настройкой режима обновления для работающего кластера можно изменить следующие параметры.

### <a name="certificates"></a>Сертификаты
На портале можно добавить новые или удалить имеющиеся сертификаты для кластера и клиента. Ознакомьтесь с [подробными инструкциями в этом документе](service-fabric-cluster-security-update-certs-azure.md)

![Снимок экрана, демонстрирующий отпечатки сертификатов на портале Azure.][CertificateUpgrade]

### <a name="application-ports"></a>Порты приложения
Порты приложения можно изменить путем изменения свойств ресурса балансировщика нагрузки, связанных с типом узла. Для этого можно использовать портал или диспетчер ресурсов PowerShell напрямую.

Чтобы открыть новый порт на всех виртуальных машинах в типе узла, необходимо выполнить следующие действия:

1. Добавьте новую проверку к соответствующему балансировщику нагрузки.
   
    Если вы развернули кластер с помощью портала, то балансировщикам нагрузки присваиваются имена "LB-<имя_группы_ресурсов>-<имя_типа_узла>" и т. д. по одному для каждого типа узла. Поскольку имена балансировщиков нагрузки являются уникальными только в группе ресурсов, рекомендуется искать их в данной группе ресурсов.
   
    ![Снимок экрана, демонстрирующий добавление проверки в балансировщик нагрузки на портале.][AddingProbes]
2. Добавьте новое правило к балансировщику нагрузки.
   
    Добавьте новое правило в тот же балансировщик нагрузки, используя проверку, созданную на предыдущем шаге.
   
    ![Добавление нового правила в подсистему балансировки нагрузки на портале][AddingLBRules]

### <a name="placement-properties"></a>Свойства размещения
Для каждого типа узла можно добавить настраиваемые свойства размещения, которые будут использоваться в приложениях. NodeType — это свойство по умолчанию, которое можно использовать без его явного добавления.

> [!NOTE]
> Дополнительные сведения об использовании ограничений на размещение, свойствах узла и способах их определения см. в разделе "Ограничения на размещение и свойства узлов" в документе по диспетчеру кластерных ресурсов Service Fabric на странице [Описание кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md).
> 
> 

### <a name="capacity-metrics"></a>Метрики емкости
Для каждого типа узла можно добавить настраиваемые метрики емкости, которые будут использоваться в приложениях для передачи данных о нагрузке. Дополнительные сведения об использовании метрик емкости для отчетах о нагрузке см. в документах по диспетчеру кластерных ресурсов Service Fabric на страницах [Описание кластера Service Fabric](service-fabric-cluster-resource-manager-cluster-description.md) и [Управление потреблением ресурсов и нагрузкой в Service Fabric с помощью метрик](service-fabric-cluster-resource-manager-metrics.md).

### <a name="fabric-upgrade-settings---health-polices"></a>Параметры обновления Service Fabric — политики работоспособности
Вы можете указать пользовательские политики работоспособности для обновления Service Fabric. Если для кластера выбран режим автоматического обновления, эти политики применяются на первом этапе автоматического обновления Service Fabric.
Если для кластера указано обновление вручную, эти политики применяются при каждом выборе новой версии, когда запускается обновление Service Fabric в кластере. Если политики не переопределить, будут использоваться значения по умолчанию.

Определить пользовательские политики работоспособности или просмотреть текущие параметры можно в колонке "Обновление Service Fabric", выбрав расширенные параметры обновления. Как это сделать, показано ниже. 

![Управление пользовательскими политиками работоспособности][HealthPolices]

### <a name="customize-fabric-settings-for-your-cluster"></a>Настройка параметров Service Fabric для кластера
В [этой статье](service-fabric-cluster-fabric-settings.md) описаны разные варианты настройки Service Fabric для кластера.

### <a name="os-patches-on-the-vms-that-make-up-the-cluster"></a>Исправления ОС на виртуальных машинах, составляющих кластер
[Приложение для управления исправлениями](service-fabric-patch-orchestration-application.md), которое можно развернуть в кластере, позволяет устанавливать исправления из Центра обновления Windows контролируемым образом, не нарушая доступность служб. 

### <a name="os-upgrades-on-the-vms-that-make-up-the-cluster"></a>Обновления ОС на виртуальных машинах, составляющих кластер
Вы должны обновить образ ОС на виртуальных машинах кластера; поочередно для каждой виртуальной машины. За это обновление отвечаете вы: в настоящее время автоматизация этой функции отсутствует.

## <a name="next-steps"></a>Дополнительная информация
* Узнайте, как настроить некоторые [параметры Service Fabric для кластера](service-fabric-cluster-fabric-settings.md)
* Ознакомьтесь с концепцией [масштабирования кластера](service-fabric-cluster-scale-up-down.md)
* Узнайте об [обновлениях приложений](service-fabric-application-upgrade.md)

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade2.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes2.PNG
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png
[HealthPolices]: ./media/service-fabric-cluster-upgrade/Manage_AutomodeWadvSettings.PNG
[ARMUpgradeMode]: ./media/service-fabric-cluster-upgrade/ARMUpgradeMode.PNG
[Create_Manualmode]: ./media/service-fabric-cluster-upgrade/Create_Manualmode.PNG
[Manage_Automaticmode]: ./media/service-fabric-cluster-upgrade/Manage_Automaticmode.PNG
