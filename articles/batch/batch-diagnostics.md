---
title: Метрики, оповещения и журналы диагностики для пакетной службы Azure | Документация Майкрософт
description: Запись и анализ событий журнала диагностики для ресурсов учетной записи пакетной службы Azure, таких как пулы и задачи.
services: batch
documentationcenter: ''
author: dlepow
manager: jeconnoc
editor: ''
ms.assetid: ''
ms.service: batch
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: multiple
ms.workload: big-compute
ms.date: 04/05/2018
ms.author: danlep
ms.custom: ''
ms.openlocfilehash: e64d272695c4e47c972df040d1c1c2a63bf3dddd
ms.sourcegitcommit: fa493b66552af11260db48d89e3ddfcdcb5e3152
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2018
ms.locfileid: "31788200"
---
# <a name="batch-metrics-alerts-and-logs-for-diagnostic-evaluation-and-monitoring"></a>Метрики, оповещения и журналы пакетной службы для диагностики и мониторинга

В этой статье описывается, как выполнять мониторинг учетной записи пакетной службы с помощью функций [Azure Monitor](../monitoring-and-diagnostics/monitoring-overview-azure-monitor.md). Azure Monitor собирает [метрики](../monitoring-and-diagnostics/monitoring-overview-metrics.md) и [журналы диагностики](../monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs.md) для ресурсов в учетной записи пакетной службы. Эти данные можно собирать и использовать разными способами. Они позволяют выполнять мониторинг и диагностику проблем для учетной записи пакетной службы. Вы также можете настроить [метрики оповещений](../monitoring-and-diagnostics/monitoring-overview-alerts.md#alerts-on-azure-monitor-data), чтобы получать уведомления о достижении определенных значений. 

## <a name="batch-metrics"></a>Метрики пакетной службы

Метриками называются данные телеметрии (счетчики производительности) Azure, которые создаются ресурсами Azure и передаются в службу Azure Monitor. Например, для учетной записи пакетной службы доступны такие метрики: события создания пула, число узлов с низким приоритетом и события завершения задач. 

См. [полный список поддерживаемых метрик для пакетной службы](../monitoring-and-diagnostics/monitoring-supported-metrics.md#microsoftbatchbatchaccounts).

Метрики:

* по умолчанию включены для всех учетных записей пакетной службы и не требуют настройки;
* создаются каждую минуту;
* не сохраняются автоматически, но доступны в течение 30 дней в обновляемом журнале. Метрики действий можно сохранять в [журнале ведения диагностики](#work-with-diagnostic-logs).

### <a name="view-metrics"></a>Просмотр метрик

Метрики для учетной записи пакетной службы можно просматривать на портале Azure. Страница **Обзор** для учетной записи по умолчанию отображает основные метрики по узлам, ядрам и задачам. 

Чтобы просмотреть все метрики пакетной учетной записи, сделайте следующее: 

1. Выберите на портале **Все службы** > **Учетные записи пакетной службы** и щелкните имя нужной учетной записи.
2. В разделе **Мониторинг** щелкните **Метрики**.
3. Выберите одну или несколько метрик. Чтобы выбрать метрики для дополнительных ресурсов, используйте раскрывающиеся списки **Подписки**, **Группы ресурсов**, **Тип ресурсов** и **Ресурсы**.

    ![Метрики пакетной службы](media/batch-diagnostics/metrics-portal.png)

Метрики можно получить программным способом с помощью API-интерфейсов Azure Monitor. Изучите пример [получения данных метрик Azure Monitor с помощью .NET](https://azure.microsoft.com/resources/samples/monitor-dotnet-metrics-api/).

## <a name="batch-metric-alerts"></a>Оповещения на основе метрик пакетной службы

Вы можете настроить необязательные *оповещения метрик*, которые срабатывают при выходе значения указанной метрики за установленные пределы. Оповещение создает настраиваемое [уведомление](../monitoring-and-diagnostics/insights-alerts-portal.md), когда оно переходит в активное состояние (т. е. когда значение метрики выходит за указанный предел и соответствует условиям оповещения) и когда оно разрешается (т. е. когда значение метрики возвращается в исходный диапазон, не соответствующий условиям оповещения). 

Например, вы можете настроить оповещение метрики, срабатывающее при снижении числа ядер с низким приоритетом ниже определенного уровня, чтобы управлять составом пулов.

Чтобы настроить оповещение метрики на портале, сделайте следующее:

1. Выберите **Все службы** > **Учетные записи пакетной службы** и щелкните имя учетной записи пакетной службы.
2. В разделе **Мониторинг** щелкните **Правила оповещений** > **Добавить оповещение метрики**.
3. Выберите метрику и условие оповещения (например, если метрика превышает определенное значение за некоторый период), а также одно или несколько уведомлений.

Также с помощью [API-интерфейса REST]() вы можете настроить оповещения практически в реальном времени. Дополнительные сведения см. в статье [Использование новых оповещений метрик для служб Azure на портале Azure](../monitoring-and-diagnostics/monitoring-near-real-time-metric-alerts.md).
## <a name="batch-diagnostics"></a>Диагностика пакетной службы

Журналы диагностики содержат сведения о работе каждого ресурса Azure, генерируемые этими ресурсами. Для пакетной службы можно собирать следующие журналы:

* **Журналы службы** содержат события, генерируемые пакетной службой Azure за время существования ресурса пакетной службы, например пула или задачи. 

* Журналы **метрик** на уровне учетной записи. 

По умолчанию сбор журналов диагностики не включен. Вам следует явным образом настроить параметры диагностики для каждой учетной записи пакетной службы, которую нужно отслеживать.

### <a name="log-destinations"></a>Целевое расположение для журналов

Обычно в целевого расположения для журналов используется учетная запись хранения Azure. Чтобы сохранять журналы в хранилище Azure, создайте учетную запись перед включением сбора журналов. Если у вас уже есть учетная запись хранения, связанная с учетной записью пакетной службы, вы можете выбрать ее в качестве целевого расположения для журналов. 

Также для журналов диагностики можно использовать следующие места назначения:

* Потоковая передача событий журнала диагностики пакетной службы в [концентратор событий Azure](../event-hubs/event-hubs-what-is-event-hubs.md). Концентраторы событий способны принимать миллионы событий в секунду, позволяя преобразовать и сохранять их с помощью любого поставщика аналитики в реальном времени. 

* Отправка журналов диагностики в [Azure Log Analytics](../log-analytics/log-analytics-overview.md), где вы сможете анализировать их с помощью портала Operations Management Suite (OMS) или экспортировать для анализа в Power BI или Excel.

> [!NOTE]
> Хранение и (или) обработка данных журнала диагностики в службах Azure может повлечь дополнительные расходы. 
>

### <a name="enable-collection-of-batch-diagnostic-logs"></a>Включение сбора журналов диагностики пакетной службы

1. Выберите на портале **Все службы** > **Учетные записи пакетной службы** и щелкните имя нужной учетной записи.
2. В разделе **Мониторинг** щелкните **Журналы диагностики** > **Включить диагностику**.
3. В разделе **Параметры диагностики** введите имя параметра и выберите расположение для журналов (существующую учетную запись хранения, концентратор событий или Log Analytics). Выберите **ServiceLog**, **AllMetrics** или оба параметра сразу.

    При выборе учетной записи хранилища можно настроить политику хранения (необязательно). Если вы не укажете число дней для хранения, данные будут храниться в течение всего срока существования учетной записи хранения.

4. Выберите команду **Сохранить**.

    ![Диагностика пакетной службы](media/batch-diagnostics/diagnostics-portal.png)

Вот еще несколько методов, которые позволяют включить сбор данных журналов: настройка параметров диагностики для Azure Monitor на портале, использование [шаблона Resource Manager](../monitoring-and-diagnostics/monitoring-enable-diagnostic-logs-using-template.md), а также использование Azure PowerShell или Azure CLI. См. дополнительные сведения о [сборе и использовании данных журнала из ресурсов Azure](../monitoring-and-diagnostics/monitoring-overview-of-diagnostic-logs.md#how-to-enable-collection-of-resource-diagnostic-logs).


### <a name="access-diagnostics-logs-in-storage"></a>Доступ к журналам диагностики в хранилище

Если вы настроили сохранение журналов диагностики в учетную запись хранения, при возникновении соответствующего события в ней будет создан контейнер хранения. Созданным BLOB-объектам присваиваются имена в соответствии со следующим шаблоном именования:

```
insights-{log category name}/resourceId=/SUBSCRIPTIONS/{subscription ID}/
RESOURCEGROUPS/{resource group name}/PROVIDERS/MICROSOFT.BATCH/
BATCHACCOUNTS/{batch account name}/y={four-digit numeric year}/
m={two-digit numeric month}/d={two-digit numeric day}/
h={two-digit 24-hour clock hour}/m=00/PT1H.json
```
Пример:

```
insights-metrics-pt1m/resourceId=/SUBSCRIPTIONS/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/
RESOURCEGROUPS/MYRESOURCEGROUP/PROVIDERS/MICROSOFT.BATCH/
BATCHACCOUNTS/MYBATCHACCOUNT/y=2018/m=03/d=05/h=22/m=00/PT1H.json
```
Каждый файл BLOB-объекта PT1H.json содержит большой двоичный объект в формате JSON с событиями, произошедшими в течение часа, указанного в URL-адресе этого объекта (например, h=12). В течение заданного часа события добавляются в файл PT1H.json по мере возникновения. Значение минуты (m=00) всегда равно 00, так как события журнала диагностики разбиваются на отдельные большие двоичные объекты каждый час. (Все значения времени указаны в формате UTC.)


Дополнительные сведения о схеме хранения журналов диагностики в учетной записи хранения см. в разделе [Схема журналов диагностики в учетной записи хранилища](../monitoring-and-diagnostics/monitoring-archive-diagnostic-logs.md#schema-of-diagnostic-logs-in-the-storage-account).

Для программного доступа к журналам в учетной записи хранения используйте API-интерфейсы хранилища. 

### <a name="service-log-events"></a>События журнала службы
Журналы пакетной службы Azure (если вы их собираете) содержат события, генерируемые пакетной службой Azure за время существования каждого ресурса пакетной службы, например пула или задачи. Каждое событие, генерируемое пакетной службой, сохраняется в журнал в формате JSON. Например, так выглядит текст **события создания пула**:

```json
{
    "poolId": "myPool1",
    "displayName": "Production Pool",
    "vmSize": "Small",
    "cloudServiceConfiguration": {
        "osFamily": "5",
        "targetOsVersion": "*"
    },
    "networkConfiguration": {
        "subnetId": " "
    },
    "resizeTimeout": "300000",
    "targetDedicatedComputeNodes": 2,
    "maxTasksPerNode": 1,
    "vmFillType": "Spread",
    "enableAutoscale": false,
    "enableInterNodeCommunication": false,
    "isAutoPool": false
}
```

В настоящее время пакетная служба генерирует следующие события журнала службы. Этот список может оказаться неполным, если с момента последнего обновления этой статьи были добавлены новые события.

| **События журнала службы** |
| --- |
| [Создание пула](batch-pool-create-event.md) |
| [Начало удаления пула](batch-pool-delete-start-event.md) |
| [Завершение удаления пула](batch-pool-delete-complete-event.md) |
| [Начало изменения размера пула](batch-pool-resize-start-event.md) |
| [Завершение изменения размера пула](batch-pool-resize-complete-event.md) |
| [Начало выполнения задачи](batch-task-start-event.md) |
| [Завершение выполнения задачи](batch-task-complete-event.md) |
| [Сбой выполнения задачи](batch-task-fail-event.md) |



## <a name="next-steps"></a>Дополнительная информация

* См. дополнительные сведения об [API-интерфейсах и средствах пакетной службы](batch-apis-tools.md) для сборки решений пакетной службы.
* См. дополнительные сведения о [мониторинге решений пакетной службы](monitoring-overview.md).
