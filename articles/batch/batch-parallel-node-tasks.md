<properties
	pageTitle="Повышение эффективности узлов в пакетной службе благодаря параллельному выполнению задач на узлах | Microsoft Azure"
	description="Вы можете увеличить эффективность и снизить стоимость, используя меньшее количество вычислительных узлов. Это возможно благодаря параллельному выполнению задач на каждом узле в пуле пакетной службы Azure."
	services="batch"
	documentationCenter=".net"
	authors="mmacy"
	manager="timlt"
	editor="" />
	
<tags
	ms.service="batch"
	ms.devlang="multiple"
	ms.topic="article"
	ms.tgt_pltfrm="vm-windows"
	ms.workload="big-compute"
	ms.date="01/22/2016"
	ms.author="marsma" />
	
# Повышение эффективности вычислительных ресурсов в пакетной службе Azure благодаря параллельному выполнению задач на узлах

В этой статье вы узнаете, как одновременно выполнять несколько задач на каждом вычислительном узле в пуле пакетной службы Azure. Используя выполнение параллельных задач на вычислительных узлах пула, вы обеспечите максимальную эффективность ресурсов с меньшим количеством узлов в пуле. Для некоторых рабочих нагрузок это позволяет сэкономить время и деньги.

Во многих случаях выгоднее использовать все ресурсы узла для выполнения одной задачи. Но для некоторых ситуаций совместное использование ресурсов несколькими задачами дает следующие преимущества.

 - Если задачи могут совместно использовать один набор данных, **уменьшается объем передачи данных**. В этом сценарии можно существенно сократить стоимость передачи данных, копируя общие данные на меньшее количество узлов и выполняя задачи в параллельном режиме на каждом узле. Это особенно актуально, если данные, которые копируются на каждый узел, необходимо передавать между географическими регионами.

 - Если задачам нужен большой объем памяти в течение коротких промежутков времени и на разных этапах выполнения, **повышается эффективность использования памяти**. Для эффективной обработки таких нагрузок можно использовать меньшее число более крупных вычислительных узлов с большим объемом памяти. Эти узлы могли бы иметь параллельные задачи, которые выполняются на каждом узле, но каждая задача использовала бы большой объем памяти узлов в разное время.

 - Если требуется взаимодействие между узлами в пуле, **уменьшается ограничение по количеству узлов**. Сейчас существует ограничение в 50 вычислительных узлов для пулов, в которых настроен обмен данными между узлами. Поэтому если каждый узел в таком пуле будет выполнять задачи параллельно, можно будет выполнять больше задач одновременно.

 - **Выполняется репликация локального вычислительного кластера**, например, как при первичном переходе в вычислительную среду Azure. Увеличение максимального числа задач на узле позволит более точно скопировать существующую физическую конфигурацию, если она ранее позволяла выполнять несколько задач на каждом вычислительном узле.

## Пример сценария

Ниже приведен пример, иллюстрирующий преимущества параллельного выполнения задач. Предположим, что приложение задачи имеет такие требования к ЦП и памяти, что их можно удовлетворить размером узла Standard\_D1. Однако для выполнения задачи в заданное время необходимы 1000 таких узлов.

Вместо узлов размера Standard\_D1, каждый из которых содержит одно ядро ЦП, вы можете использовать 16-ядерные узлы Standard\_D14, включив на них параллельное выполнение задач. В этом случае потребуется *в 16 раз меньше узлов*, то есть 63 узла вместо 1000. Это значительно ускорит выполнение работы и повысит эффективность, если для каждого узла требуются файлы приложения или справочные данные большого объема.

## Включение параллельного выполнения задач

Настройка параллельного выполнения задач для вычислительных узлов в пакетной службе выполняется на уровне пула. Если вы используете библиотеку .NET пакетной службы, задайте при создании пула свойство [CloudPool.MaxTasksPerComputeNode][maxtasks_net]. Если вы используете API REST пакетной службы, включите элемент [maxTasksPerNode][maxtasks_rest] в текст запроса при создании пула.

Пакетная служба Azure позволяет задать для каждого узла максимальное количество задач, в 4 раза превышающее количество ядер узла. Например, если для пула настроены узлы размера "Большой" (четыре ядра), для параметра `maxTasksPerNode` можно задать значение 16. Сведения о количестве ядер для каждого узла см. в разделе [Размеры для облачных служб](./../cloud-services/cloud-services-sizes-specs.md). Дополнительные сведения об ограничениях службы см. в разделе [Квоты и ограничения пакетной службы Azure](batch-quota-limit.md).

> [AZURE.TIP] Обязательно учитывайте значение параметра `maxTasksPerNode` при создании [формулы автомасштабирования][enable_autoscaling] для пула. Например, если в формуле учитывается параметр `$RunningTasks`, изменение количества задач существенно повлияет на результат ее применения. Дополнительные сведения см. в статье [Автоматическое масштабирование вычислительных узлов в пуле пакетной службы Azure](batch-automatic-scaling.md).

## Распределение задач

Если вычислительные узлы в пуле могут выполнять задачи параллельно, важно указать правила распределения задач между узлами пула.

С помощью свойства [CloudPool.TaskSchedulingPolicy][task_schedule] можно указать, что задачи должны назначаться ("распространяться") равномерно по всем узлам в кластере. Или можно указать, что перед переходом к следующему узлу необходимо назначить максимальное количество задач текущему узлу ("упаковка").

Чтобы понять важность этой функции, давайте рассмотрим пул из предыдущего примера. Он состоит из узлов размера Standard\_D14, для которых параметр [CloudPool.MaxTasksPerComputeNode][maxtasks_net] имеет значение 16. Если в свойстве [CloudPool.TaskSchedulingPolicy][task_schedule] для параметра [ComputeNodeFillType][fill_type] будет указано значение *Pack* (Упаковка), на каждом узле все 16 ядер будут задействованы по максимуму. При этом [автомасштабируемый пул](./batch-automatic-scaling.md) будет исключать неиспользуемые узлы (для которых не назначены задачи). Это снизит использование ресурсов и расходы на них.

## Пример использования компонента .NET пакетной службы

Этот фрагмент кода API для [компонента .NET пакетной службы][api_net] содержит запрос на создание пула с четырьмя большими узлами и максимальным количеством задач на каждый узел, равным четырем. Он задает политику планирования задач, при которой каждому узлу назначается максимальное количество задач перед переходом к следующему узлу пула. Дополнительные сведения о добавлении пулов с использованием API компонента .NET пакетной службы см. в описании метода [BatchClient.PoolOperations.CreatePool][poolcreate_net].

        CloudPool pool = batchClient.PoolOperations.CreatePool(poolId: "mypool",
        													osFamily: "2",
        													virtualMachineSize: "large",
        													targetDedicated: 4);
        pool.MaxTasksPerComputeNode = 4;
        pool.TaskSchedulingPolicy = new TaskSchedulingPolicy(ComputeNodeFillType.Pack);
        pool.Commit();

## Пример интерфейса REST API пакетной службы

Этот фрагмент кода для [REST API пакетной службы][api_rest] содержит запрос на создание пула с двумя большими узлами и максимальным количеством задач на каждый узел, равным четырем. Дополнительные сведения о добавлении пулов с помощью REST API см. в статье [Добавление пула к учетной записи][maxtasks_rest].

        {
          "id": "mypool",
          "vmSize": "Large",
          "osFamily": "2",
          "targetOSVersion": "*",
          "targetDedicated": 2,
          "enableInterNodeCommunication": false,
          "maxTasksPerNode": 4
        }

> [AZURE.NOTE] Элемент `maxTasksPerNode` и свойство [MaxTasksPerComputeNode][maxtasks_net] можно задать только во время создания пула. Их невозможно изменить после создания пула.

## Изучение примера проекта

Ознакомьтесь с проектом [ParallelNodeTasks][parallel_tasks_sample] на GitHub. Это рабочий образец кода, демонстрирующий использование [CloudPool.MaxTasksPerComputeNode][maxtasks_net].

Это консольное приложение C# использует библиотеку [компонента .NET пакетной службы][api_net] для создания пула с одним или несколькими вычислительными узлами. Для имитации переменной нагрузки оно выполняет заданное количество задач на этих узлах. Вывод приложения указывает, на каких узлах выполнялась каждая задача. Приложение также предоставляет сводку параметров задания и времени его выполнения. Ниже приводится часть сводки выходных данных примера приложения по двум различным запускам.

```
Nodes: 1
Node size: large
Max tasks per node: 1
Tasks: 32
Duration: 00:30:01.4638023
```

Первый запуск примера приложения показывает, что с одним узлом в пуле и с одной задачей на узел (настройка по умолчанию) на выполнение задания потребовалось более 30 минут.

```
Nodes: 1
Node size: large
Max tasks per node: 4
Tasks: 32
Duration: 00:08:48.2423500
```

Второй запуск примера показывает значительное уменьшение времени выполнения задания. Это вызвано тем, что пул был настроен с четырьмя задачами на узел, что позволяет параллельно выполнять задачи для выполнения задания примерно за четверть исходного времени.

> [AZURE.NOTE] В приведенных выше сводках длительность выполнения задания не включает время создания пула. Каждое из заданий в примерах выше отправлялось в уже созданные пулы, вычислительные узлы которых на момент отправки находились в состоянии *простоя*.

## Тепловая карта обозревателя пакетной службы

В списке [примеров приложений][github_samples] пакетной службы Azure есть [обозреватель пакетной службы Azure][batch_explorer]. Он содержит функцию *Тепловая карта*, которая иллюстрирует использование ядер на всех узлах в пуле. Используйте эту тепловую карту при выполнении примера приложения [ParallelTasks][parallel_tasks_sample], чтобы наглядно продемонстрировать параллельное выполнение задач на каждом узле.

![Тепловая карта обозревателя пакетной службы][1]

*Тепловая карта обозревателя пакетной службы, отображающая пул из четырех узлов, на каждом из которых выполняется четыре задачи.*

[api_net]: http://msdn.microsoft.com/library/azure/mt348682.aspx
[api_rest]: http://msdn.microsoft.com/library/azure/dn820158.aspx
[batch_explorer]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/BatchExplorer
[cloudpool]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.aspx
[enable_autoscaling]: https://msdn.microsoft.com/library/azure/dn820173.aspx
[fill_type]: https://msdn.microsoft.com/library/microsoft.azure.batch.common.computenodefilltype.aspx
[github_samples]: https://github.com/Azure/azure-batch-samples
[maxtasks_net]: http://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.maxtaskspercomputenode.aspx
[maxtasks_rest]: https://msdn.microsoft.com/library/azure/dn820174.aspx
[parallel_tasks_sample]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/ArticleProjects/ParallelTasks
[poolcreate_net]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.pooloperations.createpool.aspx
[task_schedule]: https://msdn.microsoft.com/library/microsoft.azure.batch.cloudpool.taskschedulingpolicy.aspx

[1]: ./media/batch-parallel-node-tasks\heat_map.png

<!---HONumber=AcomDC_0128_2016-->