---
title: Комплексное выполнение пакетных заданий Azure без написания кода (предварительная версия) | Документация Майкрософт
description: Узнайте, как создать файлы шаблонов для Azure CLI для создания пулов, заданий и задач пакетной службы.
services: batch
author: mscurrell
manager: jeconnoc
ms.assetid: ''
ms.service: batch
ms.devlang: na
ms.topic: article
ms.workload: big-compute
ms.date: 12/18/2017
ms.author: markscu
ms.openlocfilehash: c991a1535b82a76a3d0b9bdbf4ede8f3e22bc866
ms.sourcegitcommit: 20d103fb8658b29b48115782fe01f76239b240aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2018
---
# <a name="use-azure-batch-cli-templates-and-file-transfer-preview"></a>Использование шаблонов интерфейса командной строки для пакетной службы Azure и передачи файлов (предварительная версия)

Интерфейс командной строки Azure позволяет выполнять пакетные задания Azure без написания кода.

Создавайте и используйте файлы шаблонов при помощи Azure CLI, чтобы разрабатывать пулы, задания и задачи пакетной службы. Входные файлы задания можно с легкостью передать в учетную запись хранения, связанную с учетной записью пакетной службы, и выходные файлы задания — скачать.

## <a name="overview"></a>Обзор

Это расширение Azure CLI дает возможность пользователям, которые не являются разработчиками, комплексно использовать пакетную службу. Можно создавать пулы, задания и связанные с ними задачи, передавать входные данные и скачивать получаемые выходные данные — и все это без написания кода. При этом интерфейс командной строки используются напрямую или интегрируется в сценарии.

Шаблоны пакетной службы работают благодаря [поддержке пакетной службы в Azure CLI](https://docs.microsoft.com/azure/batch/batch-cli-get-started#json-files-for-resource-creation), которая позволяет указывать в JSON-файлах значения свойств для создания пулов, заданий, задач и других элементов. Благодаря шаблонам пакетной службы к имеющимся функциям JSON-файлов добавляются следующие возможности:

-   Возможность определять параметры. При использовании шаблона указываются только значения параметров для создания элемента, а остальные значения свойств элемента содержатся в теле шаблона. Пользователь, понимающий принцип работы пакетной службы и приложений, запускаемых пакетной службой, может создавать шаблоны, указывая значения свойств пулов, заданий и задач. Если пользователь мало знаком с пакетной службой и (или) приложениями, то ему необходимо указать только значения определенных параметров.

-   Фабрики задач создают одну или несколько задач, связанных с заданием, избавляя вас от необходимости создавать для них множество определений. Это значительно упрощает отправку заданий.


Для заданий необходимо предоставить файлы входных данных, а также часто создаются файлы выходных данных. По умолчанию с каждой учетной записью пакетной службы связывается учетная запись хранения, и вы можете легко передавать файлы в эту учетную запись хранения и обратно, используя интерфейс командной строки. Вам не нужно при этом писать код или использовать учетные данные хранилища.

Например, [ffmpeg](http://ffmpeg.org/) — это популярное приложение, которое обрабатывает аудио- и видеофайлы. Можно использовать интерфейс командной строки для пакетной службы Azure, чтобы вызвать приложение ffmpeg, которое перекодирует исходные видеофайлы в файлы с другим разрешением.

-   Создается шаблон пула. Пользователь, создающий шаблон, должен знать, как вызвать приложение ffmpeg и какие его требования. Необходимо указать соответствующую операционную систему, размер виртуальной машины, как было установлено приложение (например, из пакета приложения или с помощью диспетчера пакетов) и другие значения свойств пула. Создаются параметры, поэтому при использовании шаблона необходимо указать только идентификатор пула и число виртуальных машин.

-   Создается шаблон задания. Пользователь, создающий шаблон, должен знать, как вызвать приложение ffmpeg для перекодирования исходного видео в файл с другим разрешением и указать командную строку задачи. Он также должен знать, что существует папка, в которой содержатся исходные видеофайлы, и что для каждого входного файла требуется одна задача.

-   Сначала пользователь создает пул для набора видеофайлов, которые необходимо перекодировать. Он использует шаблон пула, указывая только идентификатор пула и требуемое число виртуальных машин. После этого можно передать исходные файлы для перекодирования. Затем с помощью шаблона можно отправить задание, указав только идентификатор пула и расположение переданных исходных файлов. Создается пакетное задание. Для каждого входного файла создается одна задача. Наконец, можно скачать перекодированные выходные файлы.

## <a name="installation"></a>Установка

Для использования функций шаблонов и передачи файлов требуется установить расширение.

Инструкции по установке Azure CLI см. на [этой странице](https://docs.microsoft.com/cli/azure/install-azure-cli).

После установки Azure CLI вы можете установить последнюю версию расширения пакетной службы с помощью следующей команды CLI:

```azurecli
az extension add --source https://github.com/Azure/azure-batch-cli-extensions/releases/download/azure-batch-cli-extensions-2.0.1/azure_batch_cli_extensions-2.0.1-py2.py3-none-any.whl
```

Дополнительные сведения о расширении пакетной службы см. в статье [Microsoft Azure Batch CLI Extensions for Windows, Mac and Linux](https://github.com/Azure/azure-batch-cli-extensions#microsoft-azure-batch-cli-extensions-for-windows-mac-and-linux) (Расширения командной строки для пакетной службы Microsoft Azure для Windows, Mac и Linux).

## <a name="templates"></a>Шаблоны

Интерфейс командной строки для пакетной службы Azure позволяет создавать элементы, такие как пулы, задания и задачи, указав JSON-файл, в котором содержатся имена и значения свойств. Например: 

```azurecli
az batch pool create –-json-file AppPool.json
```

Шаблоны пакетной службы Azure по функциональности и синтаксису похожи на шаблоны Azure Resource Manager. Они являются JSON-файлами, содержащими имена и значения свойств элементов, но в них добавлены следующие основные понятия:

-   **Параметры**

    -   Позволяют указывать значения свойств в теле шаблона. При использовании шаблона необходимо предоставить только значения параметров. Например, полное определение пула можно поместить в текст и определить только один параметр для идентификатора пула. Таким образом, для создания пула необходимо указать только строку идентификатора.
        
    -   Тело шаблона может создать пользователь, который знаком с пакетной службой и приложениями, запускаемыми пакетной службой. При использовании шаблона необходимо указать только значения параметров, определенных создателем шаблона. Поэтому пользователь, мало знакомый с пакетной службой и (или) приложениями, также может использовать шаблоны.

-   **Переменные**

    -   Позволяют указывать значения простых или сложных параметров в одном месте, а затем использовать их в одном или нескольких местах в теле шаблона. С помощью переменных можно упростить шаблон и уменьшить его размер, а также сделать его более удобным в использовании благодаря возможности в одном месте изменять свойства, значения которых могут меняться.

-   **Конструкции более высокого уровня**

    -   В шаблоне доступны некоторые конструкции более высокого уровня, которые еще не доступны в интерфейсах API пакетной службы. Например, в шаблоне задания на основе стандартного определения задач можно определить фабрику задач, которая создаст несколько задач для одного задания. Благодаря этим конструкциям не требуется писать код, чтобы динамически создать несколько JSON-файлов, например по одному файлу для каждой задачи, или создавать файлы сценариев для установки приложений через диспетчер пакетов.

    -   На определенном этапе (где это применимо) данные конструкции можно добавить в пакетную службу, сделав их доступными через интерфейсы API пакетной службы, пользовательские интерфейсы и т. д.

### <a name="pool-templates"></a>Шаблоны пула

Помимо стандартных возможностей шаблонов (параметры и переменные) шаблон пула поддерживает следующие конструкции более высокого уровня:

-   **Ссылки на пакет**

    -   Позволяют при необходимости копировать программное обеспечение в узлы пула с помощью диспетчеров пакетов. Указываются диспетчер пакетов и идентификатор пакета. Возможность объявить про один или несколько пакетов избавляет от необходимости создавать сценарий, который получает пакеты, устанавливать этот сценарий и запускать его на каждом узле пула.

Ниже приведен пример шаблона, при помощи которого создается пул виртуальных машин Linux с установленным приложением ffmpeg. Требуется только строка идентификатора пула и число используемых виртуальных машин:

```json
{
    "parameters": {
        "nodeCount": {
            "type": "int",
            "metadata": {
                "description": "The number of pool nodes"
            }
        },
        "poolId": {
            "type": "string",
            "metadata": {
                "description": "The pool ID "
            }
        }
    },
    "pool": {
        "type": "Microsoft.Batch/batchAccounts/pools",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('poolId')]",
            "virtualMachineConfiguration": {
                "imageReference": {
                    "publisher": "Canonical",
                    "offer": "UbuntuServer",
                    "sku": "16.04.0-LTS",
                    "version": "latest"
                },
                "nodeAgentSKUId": "batch.node.ubuntu 16.04"
            },
            "vmSize": "STANDARD_D3_V2",
            "targetDedicatedNodes": "[parameters('nodeCount')]",
            "enableAutoScale": false,
            "maxTasksPerNode": 1,
            "packageReferences": [
                {
                    "type": "aptPackage",
                    "id": "ffmpeg"
                }
            ]
        }
    }
}
```

Если имя файла шаблона — _pool-ffmpeg.json_, то шаблон будет вызываться следующим образом:

```azurecli
az batch pool create --template pool-ffmpeg.json
```

### <a name="job-templates"></a>Шаблоны задания

Помимо стандартных возможностей шаблонов (параметры и переменные) шаблон задания поддерживает следующие конструкции более высокого уровня:

-   **Фабрика задач**

    -   Создает несколько задач для одного задания, используя одно определение задачи. Поддерживается три типа фабрики задач: параметрический анализ, "по одной задаче на файл" и коллекция задач.

Ниже приведен пример шаблона, который создает задание, использующее приложение ffmpeg для перекодирования видеофайлов MP4 в один из двух форматов с более низким разрешением. На каждый исходный видеофайл создается по одной задаче.

```json
{
    "parameters": {
        "poolId": {
            "type": "string",
            "metadata": {
                "description": "The name of Azure Batch pool which runs the job"
            }
        },
        "jobId": {
            "type": "string",
            "metadata": {
                "description": "The name of Azure Batch job"
            }
        },
        "resolution": {
            "type": "string",
            "defaultValue": "428x240",
            "allowedValues": [
                "428x240",
                "854x480"
            ],
            "metadata": {
                "description": "Target video resolution"
            }
        }
    },
    "job": {
        "type": "Microsoft.Batch/batchAccounts/jobs",
        "apiVersion": "2016-12-01",
        "properties": {
            "id": "[parameters('jobId')]",
            "constraints": {
                "maxWallClockTime": "PT5H",
                "maxTaskRetryCount": 1
            },
            "poolInfo": {
                "poolId": "[parameters('poolId')]"
            },
            "taskFactory": {
                "type": "taskPerFile",
                "source": { 
                    "fileGroup": "ffmpeg-input"
                },
                "repeatTask": {
                    "commandLine": "ffmpeg -i {fileName} -y -s [parameters('resolution')] -strict -2 {fileNameWithoutExtension}_[parameters('resolution')].mp4",
                    "resourceFiles": [
                        {
                            "blobSource": "{url}",
                            "filePath": "{fileName}"
                        }
                    ],
                    "outputFiles": [
                        {
                            "filePattern": "{fileNameWithoutExtension}_[parameters('resolution')].mp4",
                            "destination": {
                                "autoStorage": {
                                    "path": "{fileNameWithoutExtension}_[parameters('resolution')].mp4",
                                    "fileGroup": "ffmpeg-output"
                                }
                            },
                            "uploadOptions": {
                                "uploadCondition": "TaskSuccess"
                            }
                        }
                    ]
                }
            },
            "onAllTasksComplete": "terminatejob"
        }
    }
}
```

Если имя файла шаблона — _job-ffmpeg.json_, то шаблон будет вызываться следующим образом:

```azurecli
az batch job create --template job-ffmpeg.json
```

## <a name="file-groups-and-file-transfer"></a>Группы файлов и передача файлов

Большинство заданий и задач принимают входные файлы и создают выходные файлы. Обычно входные и выходные файлы должны быть переданы от клиента на узел или с узла клиенту. Расширение интерфейса командной строки для пакетной службы Azure значительно упрощает передачу файлов и использует учетную запись хранения, которая по умолчанию создается для каждой учетной записи пакетной службы.

Группа файлов соответствует контейнеру, создаваемому в учетной записи хранения Azure. Группа файлов может иметь вложенные папки.

Расширение CLI для пакетной службы предоставляет команды, которые позволяют передать файлы от клиента в указанную группу файлов или скачать в клиент файлы из указанной группы файлов.

```azurecli
az batch file upload --local-path c:\source_videos\*.mp4 
    --file-group ffmpeg-input

az batch file download --file-group ffmpeg-output --local-path
    c:\output_lowres_videos
```

Шаблоны пула и задания позволяют указать файлы, хранящиеся в группах файлов, для копирования на узлы пула или с узлов пула обратно в группу файлов. Например, в приведенном выше шаблоне задания группа файлов ffmpeg-input указывается для фабрики задач как расположение исходных видеофайлов, которые копируются на узел для перекодирования. Группа файлов ffmpeg-output используется в качестве расположения, в которое копируются перекодированные выходные файлы из узла при выполнении каждой задачи.

## <a name="summary"></a>Сводка

Сейчас поддержка шаблонов и передачи файлов реализована только в Azure CLI. В будущем планируется расширить аудиторию пакетной службы до пользователей, которым не нужно разрабатывать код, используя интерфейсы API пакетной службы, например исследователей, ИТ-пользователи и т. д. Пользователи, знакомые с Azure, пакетной службой и приложениями, которые запускает пакетная служба, могут создавать шаблоны для создания пулов и заданий, не прибегая к написанию кода. Параметры шаблона позволяют использовать шаблоны даже пользователям с небольшим опытом работы с пакетной службой и приложениями.

Попробуйте использовать расширение пакетной службы для Azure CLI и оставьте отзыв или предложения в комментариях к этой статье или на [форуме по пакетной службе Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=azurebatch).

## <a name="next-steps"></a>Дополнительная информация

- Прочитайте запись блога о пакетной службе: [Running Azure Batch jobs using the Azure CLI – no code required](https://azure.microsoft.com/en-us/blog/running-azure-batch-jobs-using-the-azure-cli-no-code-required/) (Выполнение пакетных заданий Azure с помощью Azure CLI без написания кода).
- Подробная документация по установке и использованию, примеры и исходный код доступны в [репозитории Azure GitHub](https://github.com/Azure/azure-batch-cli-extensions).
