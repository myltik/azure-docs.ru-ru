---
title: Подготовка пулов пакетной службы Azure на основе пользовательских образов | Документация Майкрософт
description: Пул пакетной службы можно создать на основе пользовательского образа для подготовки вычислительных узлов, которые содержат программное обеспечение и данные, необходимые для приложения. Пользовательские образы представляют собой эффективный способ настройки вычислительных узлов для выполнения рабочих нагрузок пакетной службы.
services: batch
author: dlepow
manager: jeconnoc
ms.service: batch
ms.topic: article
ms.date: 04/23/2018
ms.author: danlep
ms.openlocfilehash: 78bc50a1189d8f42281f81643a5e907d94480082
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32158618"
---
# <a name="use-a-managed-custom-image-to-create-a-pool-of-virtual-machines"></a>Использование управляемого пользовательского образа для создания пула виртуальных машин 

При создании пула в пакетной службе Azure с помощью конфигурации виртуальной машины необходимо указать образ виртуальной машины, предоставляющий операционную систему, для каждого вычислительного узла в пуле. Пул виртуальных машин можно создать с использованием образа Azure Marketplace или пользовательского образа (образ виртуальной машины, который вы создали и настроили самостоятельно). Пользовательский образ должен быть ресурсом *управляемого образа* в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы.

## <a name="why-use-a-custom-image"></a>Преимущества пользовательского образа
При предоставлении пользовательского образа вы можете управлять конфигурацией и типом операционной системы, а также используемыми дисками данных. Пользовательский образ может содержать данные о приложениях и справочные данные, которые становятся доступными на всех узлах пула пакетной службы сразу после их подготовки.

Пользовательский образ позволяет сэкономить время за счет подготовки вычислительных узлов пула к выполнению рабочей нагрузки пакетной службы. Вы всегда можете использовать образ Azure Marketplace и установить программное обеспечение на каждом вычислительном узле после его подготовки. Однако использование пользовательского образа более эффективно.

Использование пользовательского образа, настроенного для конкретного сценария, дает определенные преимущества.

- **Настройки операционной системы (ОС)**. На диске операционной системы пользовательского образа можно выполнить специальную конфигурацию операционной системы. 
- **Предварительная установка приложений.** Вы можете создать пользовательский образ с предварительно установленными приложениями на диске операционной системы. Этот способ более эффективен и менее подвержен ошибкам, чем установка приложений после подготовки вычислительных узлов с помощью StartTask.
- **Экономия времени перезагрузки на виртуальных машинах.** Для установки приложения обычно требуется затратная по времени перезагрузка виртуальной машины. Это время можно сэкономить, установив приложения предварительно. 
- **Копирование очень больших объемов данных один раз.** Статические данные можно сделать элементом управляемого пользовательского образа, скопировав их на его диски данных. Это необходимо сделать только один раз, и данные станут доступными в каждом узле пула.
- **Выбор типов дисков.** Вы можете создать управляемый пользовательский образ из виртуального жесткого диска, управляемого диска виртуальной машины Azure, моментального снимка этих дисков или собственной настроенной установки Windows или Linux. Для диска операционной системы и диска данных можно использовать хранилище класса Premium.
- **Увеличение пулов до любого размера.** При создании пула на основе управляемого пользовательского образа пул можно увеличить до любого запрашиваемого размера. Вам не нужно делать копии виртуальных жестких дисков больших двоичных объектов образа, чтобы разместить несколько виртуальных машин. 


## <a name="prerequisites"></a>предварительным требованиям

- **Ресурс управляемого образа**. Чтобы создать пул виртуальных машин с помощью пользовательского образа, необходимо создать ресурс управляемого образа в той же подписке и в том же регионе Azure, к которым принадлежит учетная запись пакетной службы. Сведения о вариантах подготовки управляемого образа приведены в следующем разделе.
- **Проверка подлинности Azure Active Directory (AAD)**. API клиента пакетной службы должен использовать проверку подлинности AAD. Поддержка AAD пакетной службой Azure описана в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).

    
## <a name="prepare-a-custom-image"></a>Подготовка пользовательского образа
Управляемый образ можно подготовить из виртуального жесткого диска, виртуальной машины Azure с управляемыми дисками или из моментального снимка виртуальной машины. Для пакетной службы рекомендуется создать управляемый образ с виртуальной машины с управляемыми дисками или снимком виртуальной машины. Должны существовать управляемый образ и основной ресурс для увеличения масштаба пулов. Их можно удалить после удаления пула. 

При подготовке образа учитывайте следующие моменты:

* Убедитесь, что в базовом образе операционной системы, который используется для подготовки пулов пакетной службы, нет предварительно установленных расширений Azure, например расширения "Настраиваемый скрипт". Если образ содержит предварительно установленное расширение, могут возникнуть проблемы при развертывании виртуальной машины в Azure.
* Убедитесь, что предоставленный базовый образ операционной системы использует этот временный диск по умолчанию. Сейчас агент узла пакетной службы ожидает этот диск.
* Ресурс управляемого образа, на который ссылается пул пакетной службы, нельзя удалять в течение времени существования пула. В противном случае пул больше не сможет увеличиться. 

### <a name="to-create-a-managed-image"></a>Создание управляемого образа
Для создания управляемого образа можно использовать любой имеющийся подготовленный диск операционной системы Windows или Linux. Например, при необходимости использовать локальный образ отправьте локальный диск в учетную запись хранения Azure, которая находится в той же подписке и в том же регионе, что и учетная запись пакетной службы, используя AzCopy или другое средство передачи. Подробное описание действий для передачи VHD и создания управляемого образа см. в руководстве для виртуальных машин [Windows](../virtual-machines/windows/upload-generalized-managed.md) или [Linux](../virtual-machines/linux/upload-vhd.md).

Управляемый образ также можно подготовить из новой или имеющейся виртуальной машины Azure или моментального снимка виртуальной машины. 

* При создании виртуальной машины можно использовать образ Azure Marketplace в качестве базового для управляемого образа, а затем настроить его. 

* Если вы планируете записать образ с помощью портала, виртуальная машина должна быть создана с использованием управляемого диска. Это параметр хранилища по умолчанию при создании виртуальной машины.

* После запуска виртуальной машины подключитесь к ней с помощью RDP (для Windows) или SSH (для Linux). Установите все необходимое программное обеспечение или скопируйте необходимые данные и подготовьте виртуальную машину к использованию.  

Подробное описание действий для подготовки виртуальной машины Azure и создания управляемого образа см. в руководстве для виртуальных машин [Windows](../virtual-machines/windows/capture-image-resource.md) или [Linux](../virtual-machines/linux/capture-image.md).

В зависимости от того, как вы планируете создать пул пакетной службы с образом, требуется следующий идентификатор образа:

* Если вы планируете создать пул с образом с помощью API пакетной службы, **требуется идентификатор ресурса** образа в формате `/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage`. 
* Если вы планируете использовать портал, требуется **имя** образа. 





## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>Создание пула на основе пользовательского образа на портале

Если вы сохранили пользовательский образ и знаете его идентификатор ресурса или имя, можно создать пул пакетной службы из этого образа. Ниже показано, как это сделать с помощью портала Azure.

> [!NOTE]
> При создании пула с помощью API пакетной службы убедитесь, что идентификатор, используемый для проверки подлинности AAD, имеет разрешения на ресурс образа. Дополнительные сведения см. в статье [Аутентификация решений пакетной службы с помощью Active Directory](batch-aad-auth.md).
>

1. Войдите в свою учетную запись пакетной службы на портале Azure. Эта учетная запись должна принадлежать к той же подписке и к тому же региону, что и группа ресурсов, содержащая пользовательский образ. 
2. В окне **Параметры** слева выберите пункт меню **Пулы**.
3. В окне **Пулы** выберите команду **Добавить**.
4. В окне **Добавить пул** из раскрывающегося списка **Тип образа** выберите **Пользовательский образ (Linux или Windows)**. В раскрывающемся списке **Custom VM image** (Пользовательский образ виртуальной машины) выберите имя образа (краткую форму идентификатора ресурсов).
5. Выберите правильного **издателя, предложение, SKU** для пользовательского образа.
6. Укажите оставшиеся необходимые параметры, в том числе **Размер узла**, **Target dedicated nodes** (Целевые выделенные узлы) и **Узлы с низким приоритетом**, а также любые необходимые дополнительные параметры.

    Например, для пользовательского образа Microsoft Windows Server Datacenter 2016 окно **Добавить пул** отображается, как показано ниже:

    ![Добавление пула из пользовательского образа Windows](media/batch-custom-images/add-pool-custom-image.png)
  
Чтобы проверить, основан ли имеющийся пул на пользовательском образе, найдите свойство **Операционная система** в разделе сводки по ресурсу окна **Пул**. Если пул был создан с помощью пользовательского образа, ему будет присвоено значение **Пользовательский образ виртуальной машины**.

Все пользовательские образы, связанные с пулом, отображаются в окне **Свойства** пула.
 
## <a name="next-steps"></a>Дополнительная информация

- Исчерпывающий обзор пакетной службы см. в статье [Разработка решений для крупномасштабных параллельных вычислений с использованием пакетной службы](batch-api-basics.md).
