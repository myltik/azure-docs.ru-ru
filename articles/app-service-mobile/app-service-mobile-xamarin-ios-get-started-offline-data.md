---
title: Включение автономной синхронизации для мобильного приложения Azure (Xamarin iOS)
description: Использование мобильного приложения службы приложений для кэширования и синхронизации автономных данных в приложении Xamarin iOS
documentationcenter: xamarin
author: conceptdev
manager: cfowler
editor: ''
services: app-service\mobile
ms.assetid: 828a287c-5d58-4540-9527-1309ebb0f32b
ms.service: app-service-mobile
ms.workload: mobile
ms.tgt_pltfrm: mobile-xamarin-ios
ms.devlang: dotnet
ms.topic: article
ms.date: 10/01/2016
ms.author: crdun
ms.openlocfilehash: 287977d55656a4b2bc42d90730d16f522fae9b9e
ms.sourcegitcommit: df4ddc55b42b593f165d56531f591fdb1e689686
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/04/2018
ms.locfileid: "27594672"
---
# <a name="enable-offline-sync-for-your-xamarinios-mobile-app"></a>Включение автономной синхронизации для мобильного приложения Xamarin.iOS
[!INCLUDE [app-service-mobile-selector-offline](../../includes/app-service-mobile-selector-offline.md)]

## <a name="overview"></a>Обзор
В этом учебнике представлена функция автономной синхронизации мобильных приложений Azure для Xamarin.iOS. Автономная синхронизация позволяет конечным пользователям взаимодействовать с мобильным приложением — просматривать, добавлять или изменять данные — даже при отсутствии подключения к сети. Изменения сохраняются в локальной базе данных. Как только устройство возвращается в режим подключения к сети, эти изменения синхронизируются с удаленной службой.

Из этого руководства вы узнаете, как обновить проект приложения Xamarin.iOS, описанный в руководстве [Создание приложения Xamarin.iOS], чтобы обеспечить поддержку автономных функций мобильных приложений Azure. Если вы не используете скачанный проект быстрого запуска сервера, в проект необходимо добавить пакет расширений доступа к данным. в статье [Работа с пакетом SDK для внутреннего сервера .NET для мобильных приложений Azure](app-service-mobile-dotnet-backend-how-to-use-server-sdk.md).

Дополнительные сведения о функции автономной синхронизации см. в статье [Автономная синхронизация данных в мобильных приложениях Azure].

## <a name="update-the-client-app-to-support-offline-features"></a>Обновление клиентского приложения для поддержки автономных функций
Автономные функции мобильных приложений Azure позволяют взаимодействовать с локальной базой данных в случае автономной работы. Чтобы использовать эти функции в приложении, необходимо инициализировать [SyncContext] в локальном хранилище. Затем необходимо сослаться на таблицу с помощью интерфейса [IMobileServiceSyncTable]. SQLite используется как локальное хранилище на устройстве.

1. Откройте диспетчер пакетов NuGet в проекте, выполненном при работе с руководством [Создание приложения Xamarin.iOS], а затем найдите и установите пакет NuGet **Microsoft.Azure.Mobile.Client.SQLiteStore**.
2. Откройте файл QSTodoService.cs и раскомментируйте определение `#define OFFLINE_SYNC_ENABLED`.
3. Повторно выполните сборку и запустите клиентское приложение. Приложение работает так же, как и до включения автономной синхронизации. Тем не менее, локальная база данных теперь заполняется данными, которые можно использовать в автономном сценарии.

## <a name="update-sync"></a>Обновление приложения для отключения от серверной части
В этом разделе вы разорвете связь с серверной частью мобильного приложения для имитации автономного режима. При добавлении элементов данных обработчик исключений сообщает, что приложение работает в автономном режиме. В этом состоянии новые элементы добавляются в локальное хранилище и будут синхронизированы с серверной частью мобильного приложения при следующей отправке данных в подключенном состоянии.

1. Отредактируйте файл QSToDoService.cs в общем проекте. Укажите для параметра **applicationURL** недопустимый URL-адрес.

         const string applicationURL = @"https://your-service.azurewebsites.fail";

    Чтобы продемонстрировать поведение в автономном режиме, отключите на устройстве Wi-Fi и мобильную связь и включите режим "в самолете".
2. Выполните сборку и запустите приложение. Обратите внимание, синхронизацию не удалось выполнить при обновлении во время запуска приложения.
3. Введите новые элементы. Учтите, что при каждом нажатии кнопки **Сохранить** отправка завершается сбоем с состоянием [CancelledByNetworkError]. Однако новые элементы списка существуют в локальном хранилище, пока они не будут перемещены в серверную часть мобильного приложения.  В рабочем приложении при подавлении этих исключений клиентское приложение ведет себя так, как если бы оно по-прежнему было подключено к серверной части мобильного приложения.
4. Закройте приложение и перезапустите его, чтобы убедиться, что новые элементы сохранены в локальном хранилище.
5. (Необязательно.) Если на компьютере установлена среда Visual Studio, откройте **обозреватель серверов**. Перейдите к своей базе данных в **Azure**-> **Базы данных SQL**. Щелкните правой кнопкой мыши базу данных и выберите пункт **Открыть в обозревателе объектов SQL Server**. Теперь можно перейти к таблице базы данных SQL и ее содержимому. Убедитесь, что данные в серверной базе данных не изменились.
6. (Необязательно.) Воспользуйтесь инструментом REST, например Fiddler или Postman, чтобы выполнить запрос к мобильной серверной части с помощью запроса GET вида `https://<your-mobile-app-backend-name>.azurewebsites.net/tables/TodoItem`.

## <a name="update-online-app"></a>Обновление приложения для повторного подключения к серверной части мобильного приложения
В этом разделе вы повторно подключите приложение к серверной части мобильного приложения. Эта процедура имитирует переход приложения из автономного состояния в оперативное состояние для серверной части мобильного приложения.   Если вы имитировали повреждение сети, отключив сетевое подключение, вносить изменения в код не требуется.
Включите сеть снова.  При первом запуске приложения вызывается метод `RefreshDataAsync`. Это, в свою очередь, приведет к вызову `SyncAsync` для синхронизации локального хранилища с серверной базой данных.

1. Откройте файл QSToDoService.cs в общем проекте и отмените изменения в свойстве **applicationURL**.
2. Повторно выполните сборку и запустите приложение. Приложение синхронизирует локальные изменения с серверной частью мобильного приложения Azure, применяя операции отправки и извлечения после выполнения метода `OnRefreshItemsSelected`.
3. (Необязательно.) Просмотрите обновленные данные, используя обозреватель объектов SQL Server или инструмент REST, например Fiddler. Обратите внимание, что данные синхронизированы между базой данных серверной части мобильного приложения Azure и локальным хранилищем.
4. В приложении установите флажки рядом с некоторыми элементами, отметив их в локальном хранилище как выполненные.

   `CompleteItemAsync` вызывает `SyncAsync` для синхронизации каждого выполненного элемента с серверной частью мобильного приложения. `SyncAsync` вызывает операцию отправки и извлечения данных.
   **При каждом извлечении из таблицы, в которую клиент внес изменения, сначала всегда будет автоматически выполняться отправка для контекста синхронизации клиента**. Неявная отправка позволяет обеспечить согласованность всех таблиц в локальном хранилище, а также связей между ними. Дополнительные сведения об этом поведении см. в статье [Автономная синхронизация данных в мобильных приложениях Azure].

## <a name="review-the-client-sync-code"></a>Просмотр кода синхронизации клиента
Клиентский проект Xamarin, скачанный при изучении руководства [Создание приложения Xamarin.iOS], уже содержит код, который поддерживает автономную синхронизацию с использованием локальной базы данных SQLite. Вот краткое содержание материала, уже включенного в код учебника. Общие сведения об этой функции см. в статье [Автономная синхронизация данных в мобильных приложениях Azure].

* Прежде чем можно будет выполнить операции с таблицами, необходимо инициализировать локальное хранилище. Инициализация базы данных локального хранилища происходит, когда `QSTodoListViewController.ViewDidLoad()` выполняет `QSTodoService.InitializeStoreAsync()`. При этом создается новая локальная база данных SQLite с помощью класса `MobileServiceSQLiteStore`, предоставленного клиентским пакетом SDK для мобильных приложений Azure.

    Метод `DefineTable` создает в локальном хранилище таблицу, соответствующую полям в указанном типе, в данном случае это `ToDoItem`. Тип необязательно должен включать в себя все столбцы, которые находятся в удаленной базе данных. Можно хранить и подмножество столбцов.

        // QSTodoService.cs

        public async Task InitializeStoreAsync()
        {
            var store = new MobileServiceSQLiteStore(localDbPath);
            store.DefineTable<ToDoItem>();

            // Uses the default conflict handler, which fails on conflict
            await client.SyncContext.InitializeAsync(store);
        }
* Элемент `todoTable` в `QSTodoService` имеет тип `IMobileServiceSyncTable`, а не `IMobileServiceTable`. IMobileServiceSyncTable направляет все операции создания, чтения, обновления и удаления (CRUD) с таблицей в базу данных локального хранилища.

    Вы можете решить, когда эти изменения будут передаваться в серверную часть мобильного приложения, вызвав `IMobileServiceSyncContext.PushAsync()`. Контекст синхронизации помогает сохранить связи между таблицами, отслеживая и отправляя изменения во всех таблицах, измененных клиентским приложением при вызове `PushAsync` .

    Представленный код вызывает метод `QSTodoService.SyncAsync()` для синхронизации при каждом обновлении списка элементов Todoitem или добавлении либо завершении элемента Todoitem. Приложение синхронизируется после каждого локального изменения. При извлечении из таблицы, для которой есть ожидающие локальные обновления, отслеживаемые по контексту, операция извлечения сначала автоматически активирует отправку контекста.

    В представленном коде запрашиваются все записи из удаленной таблицы `TodoItem`, однако их можно также отфильтровать путем передачи идентификатора запроса и запроса в `PushAsync`. Дополнительные сведения см. в разделе *Добавочная синхронизация* статьи [Автономная синхронизация данных в мобильных приложениях Azure].

        // QSTodoService.cs
        public async Task SyncAsync()
        {
            try
            {
                await client.SyncContext.PushAsync();
                await todoTable.PullAsync("allTodoItems", todoTable.CreateQuery()); // query ID is used for incremental sync
            }

            catch (MobileServiceInvalidOperationException e)
            {
                Console.Error.WriteLine(@"Sync Failed: {0}", e.Message);
            }
        }

## <a name="additional-resources"></a>Дополнительные ресурсы
* [Автономная синхронизация данных в мобильных приложениях Azure]
* [Использование пакета SDK .NET для мобильных приложений Azure][8]

<!-- Images -->

<!-- URLs. -->
[Создание приложения Xamarin.iOS]: app-service-mobile-xamarin-ios-get-started.md
[Автономная синхронизация данных в мобильных приложениях Azure]: app-service-mobile-offline-data-sync.md
[SyncContext]: https://msdn.microsoft.com/library/azure/microsoft.windowsazure.mobileservices.mobileserviceclient.synccontext(v=azure.10).aspx
[8]: app-service-mobile-dotnet-how-to-use-client-library.md
