---
title: 'Диспетчер трафика Azure: методы маршрутизации трафика | Документация Майкрософт'
description: Эта статья поможет вам разобраться в различных методах маршрутизации трафика, используемых диспетчером трафика.
services: traffic-manager
documentationcenter: ''
author: KumudD
manager: timlt
editor: ''
ms.assetid: db1efbf6-6762-4c7a-ac99-675d4eeb54d0
ms.service: traffic-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 07/13/2017
ms.author: kumud
ms.openlocfilehash: c9bd9b4913e38ed5c1f7f4ec8ee7e3210fa3be8f
ms.sourcegitcommit: d74657d1926467210454f58970c45b2fd3ca088d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
ms.locfileid: "30245368"
---
# <a name="traffic-manager-routing-methods"></a>Методы маршрутизации диспетчера трафика

Диспетчер трафика Azure поддерживает четыре метода маршрутизации трафика, которые определяют правила маршрутизации сетевого трафика в разные конечные точки службы. Диспетчер трафика применяет выбранный метод маршрутизации трафика к каждому полученному запросу DNS. Метод маршрутизации трафика определяет, какая конечная точка будет возвращена в ответе DNS.

В диспетчере трафика доступно четыре метода маршрутизации трафика.

* **[По приоритету](#priority):** выберите метод **По приоритету**, если требуется использовать первичную конечную точку службы для всего трафика, а также предоставлять резервные конечные точки, если первичная или резервные конечные точки станут недоступны.
* **[Со взвешиванием](#weighted):** выберите метод **Со взвешиванием**, если требуется распределить трафик между несколькими конечными точками равномерно или согласно определяемым вами весовым коэффициентам.
* **[Производительность](#performance):** выберите метод **Производительность**, если конечные точки размещены в разных географических расположениях и нужно, чтобы клиенты использовали "ближайшие" конечные точки (с точки зрения минимальных задержек сети).
* **[Географический](#geographic):** выберите метод **Географический**, чтобы пользователи направлялись к определенным конечным точкам (Azure, внешним или вложенным) в зависимости от географического расположения, из которого исходит их DNS-запрос. Это позволяет клиентам диспетчера трафика реализовать сценарии, в которых важно знать географический регион пользователей и направлять их на основе этих данных. К примерам относятся соблюдение предписаний независимости данных, локализация содержимого и взаимодействия с пользователем, а также измерение трафика из разных регионов.

Все профили диспетчера трафика включают мониторинг работоспособности и автоматическую отработку отказа для всех конечных точек. Дополнительные сведения см. в статье [Мониторинг и отработка отказов конечной точки диспетчера трафика](traffic-manager-monitoring.md). Отдельный профиль диспетчера трафика может использовать только один метод маршрутизации трафика. В любое время для профиля можно выбрать другой метод маршрутизации трафика. Изменения применяются в течение одной минуты, не приводя к простою. Методы маршрутизации трафика можно комбинировать с помощью вложенных профилей диспетчера трафика. Вложенность позволяет создавать сложные и гибкие конфигурации для маршрутизации трафика в соответствии с потребностями крупных и сложных приложений. Дополнительную информацию см. в статье [Вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).

## <a name = "priority"></a>Метод маршрутизации трафика по приоритету

Как правило, организация стремится обеспечить надежность своих служб, развертывая одну или несколько резервных служб на случай, если основная служба выйдет из строя. Метод маршрутизации трафика "По приоритету" позволяет клиентам Azure легко реализовать эту схему отработки отказа.

![Диспетчер трафика Azure: маршрутизация трафика по приоритету][1]

В этом профиле диспетчера трафика создается упорядоченный список конечных точек службы. По умолчанию диспетчер трафика направляет весь трафик в первичную конечную точку (с наивысшим приоритетом). Если основная конечная точка недоступна, диспетчер трафика направляет трафик на вторую конечную точку. Если и первичная, и вторичная конечные точки становятся недоступны, трафик направляется к третьей и т. д. Доступность конечной точки определяется по указанному для нее состоянию (включена или отключена) и данным мониторинга конечных точек.

### <a name="configuring-endpoints"></a>Настройка конечных точек

В Azure Resource Manager можно явно указать приоритет для каждой конечной точки, изменяя значение свойства priority. Допускаются значения в диапазоне от 1 до 1000. Чем меньше значение, тем выше приоритет. Нельзя использовать одинаковые значения приоритетов для нескольких конечных точек. Это необязательное свойство. Если оно не указано, для конечной точки задается приоритет по умолчанию в соответствии с ее расположением в профиле.

##<a name = "weighted"></a>Метод маршрутизации трафика со взвешиванием
Маршрутизация трафика по методу взвешивания позволяет распределять трафик равномерно или в соответствии с предустановленными весовыми коэффициентами.

![Диспетчер трафика Azure: маршрутизации трафика по методу взвешивания][2]

При использовании метода взвешивания при маршрутизации трафика каждой конечной точке в профиле диспетчера трафика присваивается определенный весовой коэффициент. Это целое число в диапазоне от 1 до 1000. Это необязательный параметр. Если значение не указано, диспетчер трафика использует коэффициент 1 по умолчанию. Чем выше коэффициент, тем выше приоритет.

Для каждого полученного запроса DNS диспетчер трафика случайным образом выбирает конечную точку из числа доступных. Вероятность выбора конечной точки определяется сочетанием весовых коэффициентов всех доступных конечных точек. Если для всех конечных точек используются одинаковые коэффициенты, трафик будет распределяться между ними равномерно. Если задать больший (или меньший) вес для определенных конечных точек, они будут чаще (или реже) возвращаться в ответах DNS.

Метод взвешивания позволяет реализовать некоторые полезные сценарии.

* Постепенное обновление приложения: направляйте часть трафика в новую конечную точку и постепенно доведите объем трафика до 100 %.
* Миграция приложений в Azure: создайте профиль, который включает конечные точки, расположенные в среде Azure и за ее пределами. Настройте весовые коэффициенты так, чтобы приоритет отдавался новым конечным точкам.
* Повышение в облако для получения дополнительной емкости: быстро расширьте локальное развертывание в облако, изменив профиль диспетчера трафика. Если вам требуется дополнительная емкость в облаке, добавьте конечные точки и укажите, какая часть трафика направляется на ту или иную конечную точку.

Портал Azure на основе Resource Manager поддерживает конфигурацию взвешенной маршрутизации трафика.  Весовые коэффициенты можно настроить с помощью версий Azure PowerShell, интерфейса командной строки и интерфейсов REST API для Resource Manager.

Важно понимать, что ответы DNS кэшируются клиентами и рекурсивными DNS-серверами, которые клиенты используют для разрешения имен DNS. Это может повлиять на распределение трафика по приоритетам. При большом числе клиентов и рекурсивных DNS-серверов распределение трафика работает ожидаемым образом. Но если клиентов и (или) рекурсивных DNS-серверов мало, кэширование может ощутимо исказить распределение трафика.

Типичные примеры такой ситуации:

* среды для разработки и тестирования;
* обмен данных между приложениями;
* приложения, предназначенные для узкого круга пользователей, которые используют общую инфраструктуру рекурсивной DNS-службы (например, сотрудники компании, подключенные через общий прокси-сервер).

Такое воздействие кэширования DNS характерно для всех систем маршрутизации трафика на основе DNS, а не только для диспетчера трафика. В некоторых случаях может помочь явная очистка кэша DNS. В других случаях более подходящим может оказаться альтернативный метод маршрутизации трафика.

## <a name = "performance"></a>Метод маршрутизации трафика для повышения производительности

Скорость реагирования многих приложений можно повысить, развернув конечные точки в двух или больше расположениях в разных регионах и направляя трафик в соответствующее ближайшее расположение. Эта схема реализуется при маршрутизации трафика по производительности.

![Диспетчер трафика Azure: маршрутизация трафика по производительности][3]

Под ближайшей конечной точкой не обязательно подразумевается та, которая ближе всего географически. Вместо этого при определении расстояния для маршрутизации трафика по производительности используются характеристики задержки сети. Диспетчер трафика ведет собственную таблицу задержек Интернета, в которой сохраняет время кругового пути между диапазонами IP-адресов и центрами обработки данных Azure.

Для каждого входящего запроса DNS он находит в таблице задержек Интернета строки, соответствующие IP-адресу клиента. Диспетчер трафика выбирает доступную конечную точку, расположенную в том центре обработки данных Azure, который демонстрирует наименьшую задержку для этого диапазона IP-адресов, и возвращает адрес этой конечной точки в ответе DNS.

Как описано в статье [Как работает диспетчер трафика](traffic-manager-overview.md#how-traffic-manager-works), запросы DNS поступают к нему не напрямую от клиентов. Обычно запросы DNS отправляет рекурсивная служба DNS, которую используют клиенты. Поэтому для определения ближайшей конечной точки используется не IP-адрес пользователя, а IP-адрес рекурсивной службы DNS. На практике такая замена адреса обычно дает неплохой результат.


Чтобы учесть изменения в глобальной сети Интернет и добавление новых регионов Azure, диспетчер трафика регулярно обновляет используемую таблицу задержек Интернета. Но производительность приложения зависит от распределения и колебаний загрузки в сети Интернет на определенный момент времени. При маршрутизации трафика по производительности текущая нагрузка на конкретную конечную точку службы не отслеживается. Но если конечная точка становится недоступной, диспетчер трафика перестает включать ее в ответы на запросы DNS.


Примечания:

* Если профиль содержит несколько конечных точек, которые входят в один регион Azure, диспетчер трафика распределяет трафик равномерно между всеми доступными конечными точками в этом регионе. Если вы предпочитаете распределение трафика в пределах региона, используйте [вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).
* Если работоспособность всех задействованных конечных точек в ближайших регионах Azure снижена, диспетчер трафика перенаправляет трафик к конечным точкам в следующем ближайшем регионе Azure. Если вы хотите определить свою логику отработки сбоя, используйте [вложенные профили диспетчера трафика](traffic-manager-nested-profiles.md).
* Чтобы использовать маршрутизацию трафика по производительности между внешними или вложенными конечными точками, нужно вручную указать их расположение. Выберите ближайший к вашему развертыванию регион Azure. Именно эти расположения отслеживаются в таблице задержек Интернета.
* Алгоритм выбора конечной точки детерминирован. Повторные запросы DNS от одного клиента будут направляться к той же конечной точке. Обычно клиенты используют разные рекурсивные серверы DNS, когда путешествуют. Возможно, в этом случае клиент будет перенаправлен к другой конечной точке. Кроме того, на маршрутизацию могут влиять изменения в таблице задержек Интернета. Таким образом, маршрутизация трафика по производительности не гарантирует, что клиент всегда будет обращаться к одной конечной точке.
* При изменении таблицы задержек Интернета вы можете заметить, что некоторые клиенты переключились на другую конечную точку. Такие изменения маршрутизации основываются на свежих данных о задержках. Данные обновления необходимы, чтобы обеспечить точность маршрутизации трафика для повышения производительности, так как Интернет постоянно развивается.

## <a name = "geographic"></a>Метод географической маршрутизации трафика

Можно настроить профили диспетчера трафика для применения метода географической маршрутизации трафика. В этом случае пользователи будут направляться к определенным конечным точкам (Azure, внешним или вложенным) в зависимости от географического расположения, из которого исходит их DNS-запрос. Это позволяет клиентам диспетчера трафика реализовать сценарии, в которых важно знать географический регион пользователей и направлять их на основе этих данных. К примерам относятся соблюдение предписаний независимости данных, локализация содержимого и взаимодействия с пользователем, а также измерение трафика из разных регионов.
Если в профиле настроена географическая маршрутизация, то каждой конечной точке, связанной с профилем, необходимо назначить набор географических регионов. Ниже приведены возможные уровни детализации географических регионов. 
- Мир — любой регион.
- Группа регионов — например, Африка, Ближний Восток, Австралия и Тихоокеанский регион и т. д. 
- Страна или регион — например, Ирландия, Перу, Гонконг, САР и т. д. 
- Область, штат, округ — например, Калифорния (США), Квинсленд (Австралия), Альберта (Канада) и т д. (Обратите внимание: этот уровень детализации поддерживается только для штатов, областей и округов в Австралии, Канаде, Великобритании и США.)

Если конечной точкой назначен регион или набор регионов, все запросы из этих регионов направляются только к этой конечной точке. Диспетчер трафика использует исходный IP-адрес DNS-запроса, чтобы определить регион, из которого пользователь отправляет запрос. Обычно это IP-адрес локального сопоставителя DNS, выполняющего запрос от имени пользователя.  

![Диспетчер трафика Azure: метод географической маршрутизации трафика](./media/traffic-manager-routing-methods/geographic.png)

Диспетчер трафика считывает исходный IP-адрес DNS-запроса и определяет, из какого географического региона он поступил. Затем он определяет, имеется ли конечная точка, с которой сопоставлен этот географический регион. Этот поиск начинается с самого низкого уровня детализации (с уровня области, штата или округа, если он поддерживается; в противном случае — с уровня страны или региона) и выполняется вплоть до самого высокого уровня — **мира**. Первая найденная соответствующая конечная точка при этом обходе будет возвращена в ответе на запрос. Если это конечная точка вложенного типа, то будет возвращена конечная точка в соответствующем дочернем профиле, в зависимости от его метода маршрутизации. В такой ситуации возможно следующее.

- Если используется географическая маршрутизация, то географический регион может быть сопоставлен только с одной конечной точкой в профиле диспетчера трафика. Это гарантирует детерминированную маршрутизацию пользователей и дает клиентам возможность реализовывать сценарии, требующие установления однозначных географических границ.
- Если регион пользователя географически сопоставлен с двумя разными конечными точками, то диспетчер трафика выбирает конечную точку на нижнем уровне детализации и не учитывает запросы на маршрутизацию, исходящие из другой конечной точки этого региона. Рассмотрим пример профиля с географической маршрутизацией и двумя конечными точками: Endpoint1 и Endpoint2. Endpoint1 настроена для приема трафика из Ирландии, а Endpoint2 — для приема трафика из Европы. Если запрос исходит из Ирландии, он всегда будет направляться к Endpoint1.
- Так как регион может быть сопоставлен только с одной конечной точкой, диспетчер трафика возвращает ее независимо от того, является ли эта конечная точка работоспособной или нет.

    >[!IMPORTANT]
    >Клиентам настоятельно рекомендуется использовать метод географической маршрутизации с конечными точками вложенного типа, у которых имеются дочерние профили, содержащие по крайней мере по две конечные точки.
- Если найдена соответствующая конечная точка, которая **остановлена**, то диспетчер трафика вернет ответ NODATA. В этом случае поиск не продолжается вверх по иерархии географических регионов. Это также относится к конечным точкам вложенного типа, когда дочерний профиль **остановлен** или **отключен**.
- Если конечная точка **отключена**, она не участвует в процессе сопоставления с регионом. Это также относится к конечным точкам вложенного типа, когда конечная точка **отключена**.
- Если поступает запрос из географического региона, сопоставления с которым в данном профиле нет, то диспетчер трафика возвращает ответ NODATA. Поэтому клиентам настоятельно рекомендуется использовать географическую маршрутизацию с одной конечной точкой (лучше всего вложенного типа), в дочернем профиле которой имеются по крайней мере две конечные точки, которым назначен регион **Мир**. Это также гарантирует обработку всех IP-адресов, которые не соответствуют какому-либо региону.

Как описано в статье [Как работает диспетчер трафика](traffic-manager-how-traffic-manager-works.md), запросы DNS поступают к нему не напрямую от клиентов. Обычно запросы DNS отправляет рекурсивная служба DNS, которую используют клиенты. Поэтому для определения региона используется не IP-адрес клиента, а IP-адрес рекурсивной службы DNS. На практике такая замена адреса обычно дает неплохой результат.


## <a name="next-steps"></a>Дополнительная информация

Узнайте, как разрабатывать высокодоступные приложения с помощью [мониторинга конечных точек диспетчером трафика](traffic-manager-monitoring.md)

Узнайте, как [создать профиль диспетчера трафика](traffic-manager-create-profile.md)

<!--Image references-->
[1]: ./media/traffic-manager-routing-methods/priority.png
[2]: ./media/traffic-manager-routing-methods/weighted.png
[3]: ./media/traffic-manager-routing-methods/performance.png



