---
title: 'Диспетчер трафика Azure: вопросы и ответы | Документация Майкрософт'
description: Эта статья содержит ответы на часто задаваемые вопросы о диспетчере трафика Azure
services: traffic-manager
documentationcenter: ''
author: KumudD
manager: jeconnoc
editor: ''
ms.assetid: 75d5ff9a-f4b9-4b05-af32-700e7bdfea5a
ms.service: traffic-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/18/2018
ms.author: kumud
ms.openlocfilehash: d9db669ab905fb51390f6ca80736af4cde13d902
ms.sourcegitcommit: 48ab1b6526ce290316b9da4d18de00c77526a541
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2018
---
# <a name="traffic-manager-frequently-asked-questions-faq"></a>Диспетчер трафика Azure: вопросы и ответы

## <a name="traffic-manager-basics"></a>Основные сведения о диспетчере трафика

### <a name="what-ip-address-does-traffic-manager-use"></a>Какой IP-адрес использует диспетчер трафика?

В [обзоре диспетчера трафика How Traffic Manager Works](../traffic-manager/traffic-manager-overview.md#how-traffic-manager-works) объясняется, что диспетчер трафика работает на уровне DNS. Он использует ответы DNS, чтобы направлять клиентов в соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика.

Следовательно, диспетчер трафика не предоставляет конечную точку или IP-адрес для подключения клиентов. Если вашей службе требуется статический IP-адрес, он должен быть настроен на уровне службы, а не в диспетчере трафика.

### <a name="does-traffic-manager-support-sticky-sessions"></a>Поддерживает ли диспетчер трафика прикрепленные сеансы?

В [обзоре диспетчера трафика How Traffic Manager Works](../traffic-manager/traffic-manager-overview.md#how-traffic-manager-works) объясняется, что диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика. Таким образом, диспетчер трафика не может отслеживать HTTP-трафик, проходящий между клиентом и сервером.

Кроме того, исходный IP-адрес, откуда диспетчер трафика получает запрос DNS, принадлежит рекурсивной службе DNS, а не клиенту. Это значит, что диспетчер трафика не может отслеживать отдельные клиенты и не может реализовывать прикрепленные сеансы. Это общее ограничение для всех систем управления трафиком на основе DNS, а не особенность диспетчера трафика.

### <a name="why-am-i-seeing-an-http-error-when-using-traffic-manager"></a>Почему при использовании диспетчера трафика отображается HTTP-ошибка?

В [обзоре диспетчера трафика How Traffic Manager Works](../traffic-manager/traffic-manager-overview.md#how-traffic-manager-works) объясняется, что диспетчер трафика работает на уровне DNS. Он использует ответы DNS для направления клиентов на соответствующую конечную точку службы. Клиенты подключаются к конечной точке службы приложения напрямую, а не через диспетчер трафика. Диспетчер трафика не видит трафик HTTP, проходящий между клиентом и сервером. Это значит, что все отображаемые HTTP-ошибки создаются приложением. Если клиент подключился к приложению, значит все действия по разрешению имен DNS уже успешно выполнены. Сюда входят также действия, выполняемые диспетчером в отношении трафика приложения.

Таким образом, вам следует проанализировать возможные проблемы на уровне приложения.

Чаще всего проблемы возникают из-за HTTP-заголовка Host в запросе, который отправляет браузер пользователя. Убедитесь, что приложение правильно обрабатывает заголовок с используемым вами доменным именем. Если конечная точка размещается в службе приложений Azure, см. статью [Настройка личного доменного имени для веб-приложения в службе приложений Azure, использующей диспетчер трафика](../app-service/web-sites-traffic-manager-custom-domain-name.md).

### <a name="what-is-the-performance-impact-of-using-traffic-manager"></a>Как сказывается на производительности использование диспетчера трафика?

В [обзоре диспетчера трафика How Traffic Manager Works](../traffic-manager/traffic-manager-overview.md#how-traffic-manager-works) объясняется, что диспетчер трафика работает на уровне DNS. Так как клиенты подключаются к конечным точкам службы напрямую, использование диспетчера трафика при установленном соединении никак не влияет на производительность.

Диспетчер трафика интегрируется с приложениями на уровне DNS, поэтому в цепочку разрешения DNS включается дополнительный поиск DNS. Диспетчер трафика оказывает минимальное влияние на время разрешения DNS. Диспетчер трафика использует глобальную сеть серверов доменных имен и сетевую службу [произвольной рассылки](https://en.wikipedia.org/wiki/Anycast), обеспечивая передачу запросов DNS на ближайший доступный сервер доменных имен. Кроме того, кэширование DNS-ответов означает, что дополнительные задержки DNS, связанные с использованием диспетчера трафика, происходят только в некоторых сеансах.

В ходе маршрутизации по производительности трафик направляется в ближайшую доступную конечную точку. В итоге этот метод маршрутизации оказывает минимальное влияние на общую производительность. Возможное повышение задержки DNS будет компенсироваться снижением задержки сети при взаимодействии с конечной точкой.

### <a name="what-application-protocols-can-i-use-with-traffic-manager"></a>Какие протоколы приложения пригодны для использования с диспетчером трафика?

В [обзоре диспетчера трафика How Traffic Manager Works](../traffic-manager/traffic-manager-overview.md#how-traffic-manager-works) объясняется, что диспетчер трафика работает на уровне DNS. После завершения поиска DNS клиенты подключаются к конечной точке приложения напрямую, а не через диспетчер трафика. Следовательно, это подключение может использовать любой протокол приложения. Если выбрать протокол ТСР в качестве протокола мониторинга, мониторинг работоспособности конечной точки диспетчера трафика можно выполнить без использования любых протоколов приложения. Если для проверки работоспособности вы выбираете протокол приложения, конечная точка должна отвечать на HTTP- или HTTPS-запросы GET.

### <a name="can-i-use-traffic-manager-with-a-naked-domain-name"></a>Можно ли использовать диспетчер трафика с "голым" доменным именем (без префикса www)?

Нет. Стандарты DNS не допускают существование записей CNAME и других записей DNS для одного доменного имени. Для верхнего (корневого) имени в любой зоне DNS всегда определены две записи DNS — SOA и NS (для полномочных серверов доменных имен). Это означает, что на вершине зоны нельзя создать запись CNAME, не нарушив стандарты DNS.

Для работы диспетчера трафика обязательно требуется запись DNS CNAME для сопоставления с личным именем DNS. Например, вы можете сопоставить www.contoso.com с именем DNS профиля диспетчера трафика contoso.trafficmanager.net. Кроме того, профиль диспетчера трафика возвращает еще одну запись DNS CNAME, которая указывает клиенту конечную точку для подключения.

Чтобы решить эту проблему, мы рекомендуем выполнить перенаправление HTTP с "голого" доменного имени на другой URL-адрес, который затем можно использовать с диспетчером трафика. Например, можно перенаправлять пользователей с доменного имени contoso.com на адрес www.contoso.com, для которого указана запись CNAME, ведущая к доменному имени диспетчера трафика.

Полная поддержка таких доменов в диспетчере трафика отслеживается в списке подготавливаемых функций. Если вас интересует эта функция, [проголосуйте за нее на нашем сайте обратной связи](https://feedback.azure.com/forums/217313-networking/suggestions/5485350-support-apex-naked-domains-more-seamlessly).

### <a name="does-traffic-manager-consider-the-client-subnet-address-when-handling-dns-queries"></a>Учитывает ли диспетчер трафика адрес подсети клиента при обработке запросов DNS? 
Да, если используется метод маршрутизации по производительности или по географическому расположению, помимо IP-адреса, с которого получен DNS-запрос (обычно это IP-адрес сопоставителя DNS), диспетчер трафика также учитывает адрес подсети клиента (если сопоставитель, выполняющий запрос от имени пользователя, включил эти данные в запрос).  
В частности, стандарт [7871 RFC — подсеть клиента в запросах DNS](https://tools.ietf.org/html/rfc7871), который предоставляет [механизм расширения для DNS (EDNS0)](https://tools.ietf.org/html/rfc2671), позволяет сопоставителю передавать адрес поддерживаемых подсетей клиента на DNS-сервер.

### <a name="what-is-dns-ttl-and-how-does-it-impact-my-users"></a>Что такое срок жизни DNS и как он влияет на пользователей?

Когда запрос DNS передается диспетчеру трафика, он задает значение в ответе, который называется сроком жизни (TTL). Это значение, измеряющееся в секундах, указывает подчиненным сопоставителям DNS, в течение какого срока нужно хранить в кэше этот ответ. Хотя сопоставители DNS не всегда сохраняют в кэше этот результат, его кэширование позволяет им отвечать на любые последующие запросы из кэша, а не использовать DNS-серверы диспетчера трафика. Это влияет на ответы следующим образом:
- больший срок жизни уменьшает число запросов, передающихся DNS-серверам диспетчера трафика, что снижает для клиента затраты, так как за запросы, обслуживаемые сервером, взимается плата;
- больший срок жизни может потенциально сократить время, необходимое для выполнения поиска в DNS;
- больший срок жизни также означает, что данные не отражают последние сведения о работоспособности, полученные диспетчером трафика через его агенты проверки.

### <a name="how-high-or-low-can-i-set-the-ttl-for-traffic-manager-responses"></a>Каковы минимальный и максимальный сроки жизни, которые можно задать для ответов диспетчера трафика?

Для каждого уровня профиля вы можете задать срок жизни DNS от 0 до 2 147 483 647 секунд (максимальный диапазон согласно [RFC-1035](https://www.ietf.org/rfc/rfc1035.txt )). Срок жизни 0 означает, что подчиненные сопоставители DNS не сохраняют в кэше ответы на запросы, и все запросы будут передаваться на DNS-серверы диспетчера трафика для разрешения.

## <a name="traffic-manager-geographic-traffic-routing-method"></a>Диспетчер трафика: метод географической маршрутизации трафика

### <a name="what-are-some-use-cases-where-geographic-routing-is-useful"></a>В каких случаях следует использовать географическую маршрутизацию? 
Географическую маршрутизацию можно использовать в любой ситуации, когда клиенту Azure требуется различать пользователей из разных географических регионов. Например, географическая маршрутизация позволяет предоставлять разные интерфейсы пользователям из разных регионов. Другой пример — выполнение предписаний о независимости локальных данных, в соответствии с которыми пользователи из определенного региона должны обслуживаться только конечными точками в этом регионе.

### <a name="what-are-the-regions-that-are-supported-by-traffic-manager-for-geographic-routing"></a>Какие регионы диспетчер трафика поддерживает для географической маршрутизации? 
Иерархию стран или регионов, которую использует диспетчер трафика, см. [здесь](traffic-manager-geographic-regions.md). Эта страница регулярно дополняется при внесении изменений, но эту же информацию можно получить программным способом с помощью [REST API диспетчера трафика Azure](https://docs.microsoft.com/rest/api/trafficmanager/). 

### <a name="how-does-traffic-manager-determine-where-a-user-is-querying-from"></a>Как диспетчер трафика определяет, откуда пользователь обращается к приложению? 
Диспетчер трафика проверяет исходный IP-адрес запроса (скорее всего, это будет локальный сопоставитель DNS, который выполняет запрос от имени пользователя) и использует внутренний IP-адрес на карте регионов, чтобы определить расположение. Эта карта регулярно обновляется с учетом изменений в Интернете. 

### <a name="is-it-guaranteed-that-traffic-manager-can-correctly-determine-the-exact-geographic-location-of-the-user-in-every-case"></a>Есть ли гарантия, что диспетчер трафика правильно определит точное географическое расположение пользователя во всех случаях?
Нет, диспетчер трафика не может гарантировать, что географический регион, который мы вычисляем по IP-адресу отправителя DNS-запроса, всегда будет соответствовать расположению пользователя. Это связано сразу с несколькими причинами. 

- Во-первых, как описано в предыдущем вопросе, полученный нами исходный IP-адрес обычно принадлежит сопоставителю DNS, который выполняет поиск от имени пользователя. Географическое расположение сопоставителя DNS может достаточно точно обозначать географическое местоположение пользователя, но они могут и различаться в зависимости от сферы действия сопоставителя DNS и особенностей конкретной службы сопоставителя DNS, выбранной пользователем. Например, клиент из Малайзии может явным образом указать в настройках устройства некоторую службу сопоставителя DNS, обработку запросов к которой для этого пользователя или устройства будет обрабатывать DNS-сервер, расположенный в Сингапуре. В этом случае диспетчер трафика может только увидеть IP-адрес сопоставителя и определить, что он расположен в Сингапуре. См. также ответ о поддержке адресов подсети клиента, представленный на этой странице.

- Во-вторых, диспетчер трафика использует внутреннюю карту для преобразования IP-адресов в географические регионы. Несмотря на то, что эта карта постоянно проверяется и обновляется, чтобы повысить точность преобразования и учесть постоянные изменения сети Интернет, всегда есть вероятность того, что наши сведения неточно отображают географическое расположение некоторых IP-адресов.


###  <a name="does-an-endpoint-need-to-be-physically-located-in-the-same-region-as-the-one-it-is-configured-with-for-geographic-routing"></a>Должна дли конечная точка физически располагаться в том же регионе, что и регион, с которым она сопоставлена для географической маршрутизации? 
Нет, расположение конечной точки не влияет на регионы, с которыми она может быть сопоставлена. Например, на конечную точку в регионе Azure "Центральная часть США" могут быть направлены все пользователи из Индии.

### <a name="can-i-assign-geographic-regions-to-endpoints-in-a-profile-that-is-not-configured-to-do-geographic-routing"></a>Можно ли назначить географические регионы конечным точкам в профиле, в котором не настроена географическая маршрутизация? 

Да. Если в профиле используется другой метод маршрутизации (отличный от географического), вы можете назначить географические регионы конечным точкам в этом профиле с помощью [REST API диспетчера трафика Azure](https://docs.microsoft.com/rest/api/trafficmanager/). В профилях с негеографической маршрутизацией эта конфигурация игнорируется. Если позднее тип маршрутизации в профиле будет изменен на географический, диспетчер трафика может использовать эти сопоставления.


### <a name="why-am-i-getting-an-error-when-i-try-to-change-the-routing-method-of-an-existing-profile-to-geographic"></a>Почему, когда я пытаюсь изменить метод маршрутизации существующего профиля на географический, возникает ошибка?

Каждая конечная точка в профиле с географической маршрутизацией должна быть сопоставлена как минимум с одним регионом. Чтобы изменить тип маршрутизации в существующем профиле на географический, сначала необходимо связать географические регионы со всеми конечными точками профиля, используя [REST API диспетчера трафика Azure](https://docs.microsoft.com/rest/api/trafficmanager/). Если вы используете портал, сначала удалите конечные точки, измените метод маршрутизации профиля на географический, а затем добавьте конечные точки вместе с сопоставлением с географическим регионом. 


###  <a name="why-is-it-strongly-recommended-that-customers-create-nested-profiles-instead-of-endpoints-under-a-profile-with-geographic-routing-enabled"></a>Почему клиентам настоятельно рекомендуется создавать в профиле с географической маршрутизацией вложенные профили вместо конечных точек? 

Если в профиле используется географическая маршрутизация, регион можно назначить только одной точке в этом профиле. Если это не вложенная конечная точка с дочерним профилем, когда она будет неработоспособна, диспетчер трафика продолжит отправлять на нее трафик. Альтернативное поведение диспетчера в этом случае — не отправлять трафик, что ничем не лучше исходного варианта. Диспетчер трафика не отрабатывает отказ на другую конечную точку, даже если ее назначенный регион является родительским для неработоспособной конечной точки. Например, если становится неработоспособной конечная точка, которой назначен регион "Испания", отказ не отрабатывается на другую конечную точку, которой назначен регион "Европа". Таким образом диспетчер трафика будет учитывать ограничения, связанные с географическими регионами, которые клиент установил в своем профиле. Чтобы использовать отработку отказа на другую конечную точку, когда конечная точка становится неработоспособной, рекомендуется назначать географические регионы вложенным профилям с несколькими конечными точками, а не отдельным конечным точкам. Таким образом, в случае сбоя конечной точки во вложенном дочернем профиле трафик будет перенаправлен на другую конечную точку в том же профиле.

### <a name="are-there-any-restrictions-on-the-api-version-that-supports-this-routing-type"></a>Существуют ли ограничения на версии API, которые поддерживает этот тип маршрутизации?

Да. Географическую маршрутизацию поддерживают только новые API начиная с версии от 01.03.2017. Все более старые версии API не позволяют создавать профили с географической маршрутизацией и сопоставлять географические регионы с конечными точками. Если вы пытаетесь получить профили из подписки Azure с помощью более старой версии API, профили с географической маршрутизацией не будут возвращены. Кроме того, при использовании старых версий API в возвращенных профилях с конечными точками, которым назначен географический регион, этот регион не отображается.

## <a name="real-user-measurements"></a>Реальные измерения пользователя

### <a name="what-are-the-benefits-of-using-real-user-measurements"></a>Каковы преимущества при использовании реальных измерений пользователя?
При использовании метода маршрутизации по производительности диспетчер трафика выбирает лучший регион Azure для подключения пользователей, анализируя IP-адрес источника, подсеть клиента EDNS (если она передается в запросе) и данные о задержках сетей для этих адресов, которые поддерживает служба диспетчера трафика. Реальные измерения пользователя расширяют эту проверку на всех пользователей, что позволяет добавить дополнительные данные в таблицу задержек и более точно сопоставить ее с сетями, из которых ваши пользователи подключаются к Azure. Это позволяет более точно осуществлять маршрутизацию для ваших пользователей.

### <a name="can-i-use-real-user-measurements-with-non-azure-regions"></a>Можно ли использовать реальные измерения пользователя для регионов, отличных от регионов Azure?
Реальные измерения пользователя измеряют и сообщают задержку только до регионов Azure. Но даже если вы используете маршрутизацию на основе производительности для конечных точек, размещенных в регионах, отличных от регионов Azure, вы все равно можете использовать эту функцию. Она позволит получить больше информации о задержках для тех регионов Azure, которые вы выбрали для сопоставления со своими конечными точками.

### <a name="which-routing-method-benefits-from-real-user-measurements"></a>Какие методы маршрутизации могут лучше работать с реальными измерениями пользователя?
Дополнительная информация, которую предоставляют реальные измерения пользователя, применимы только для тех профилей, которые используют метод маршрутизации на основе производительности. Обратите внимание, что ссылка на реальные измерения пользователя доступна на портале Azure для всех профилей.

### <a name="do-i-need-to-enable-real-user-measurements-each-profile-separately"></a>Нужно ли включать реальные измерения пользователя для каждого профиля отдельно?
Нет, достаточно включить их один раз для подписки, и вся собираемая информация о задержках будет доступна во всех профилях.

### <a name="how-do-i-turn-off-real-user-measurements-for-my-subscription"></a>Как отключить реальные измерения пользователя для подписки?
Чтобы избежать расходов, связанных с реальными измерениями пользователя, достаточно прекратить сбор и отправку информации о задержках из клиентского приложения. Например, если измерение выполняется скриптом JavaScript, встроенным в веб-страницы, для отключения этой функции нужно удалить соответствующий блок JavaScript или отключить его автоматический запуск при отображении страницы.

Можно также отключить реальные измерения пользователя, удалив свой ключ. После удаления ключа все измерения, отправленные диспетчеру трафика с этим ключом, будут игнорироваться.

### <a name="can-i-use-real-user-measurements-with-client-applications-other-than-web-pages"></a>Можно ли использовать реальные измерения пользователя в других клиентских приложениях, кроме веб-страниц?
Да, реальные измерения пользователя поддерживают получение данных от разных типов клиентских программ на стороне пользователя. По мере добавления поддержки для новых типов клиентских приложений мы будем обновлять этот раздел вопросов и ответов.

### <a name="how-many-measurements-are-made-each-time-my-real-user-measurements-enabled-web-page-is-rendered"></a>Сколько измерений выполняется при каждом отображении страницы, для которой включены реальные измерения пользователя?
Когда вы используете реальные измерения пользователя с предложенным скриптом JavaScript, отображение каждой страницы сопровождается выполнением шести измерений. Затем информация передается в службу диспетчера трафика. Обратите внимание, что плата за эту функцию взимается по числу сообщений, переданных в службу диспетчера трафика. Например, если пользователь покинет веб-страницу, когда измерения уже начались, но информация о них еще не передана, такие измерения оплачиваться не будут.

### <a name="is-there-a-delay-before-real-user-measurements-script-runs-in-my-webpage"></a>Существует ли задержка перед запуском скрипта реальных измерений пользователя на веб-странице?
Нет, перед вызовом скрипта не бывает программной задержки.

### <a name="can-i-use-configure-real-user-measurements-with-only-the-azure-regions-i-want-to-measure"></a>Можно ли настроить реальные измерения пользователя так, чтобы они выполнялись только для нужных мне регионов Azure?
Нет, при каждом вызове скрипт реальных измерений пользователя выполняет измерения для шести регионов Azure, которые выбираются службой автоматически. Это набор будет разным при разных вызовах, и при большом количестве таких вызовов измерения охватывают множество регионов Azure.

### <a name="can-i-limit-the-number-of-measurements-made-to-a-specific-number"></a>Можно ли ограничить число измерений?
Скрипт JavaScript, выполняющий измерения, встраивается в вашу веб-страницу и вы можете самостоятельно решать, когда и при каких условиях вы будете его использовать или прекращать использование. Служба диспетчера трафика будет передавать набор регионов Azure для измерения каждый раз, когда она получает соответствующий запрос.

### <a name="can-i-see-the-measurements-taken-by-my-client-application-as-part-of-real-user-measurements"></a>Можно ли увидеть измерения, которые выполняет клиентское приложение в рамках реальных измерений пользователя?
Вся программная логика измерений задержки работает на вашем клиентском приложении, поэтому вы имеете полный контроль над их выполнением, в том числе можете увидеть результаты измерений. Диспетчер трафика не отображает обобщенные данные об измерениях, полученные с ключом из вашей подписки.

### <a name="can-i-modify-the-measurement-script-provided-by-traffic-manager"></a>Можно ли изменить скрипт измерения, полученный из диспетчера трафика?
Во можете выполнять любые действия с содержимым своей веб-страницы, но мы настоятельно не рекомендуем вносить изменения в скрипт измерения, чтобы не возникали ошибки при измерении задержек и передаче данных.

### <a name="will-it-be-possible-for-others-to-see-the-key-i-use-with-real-user-measurements"></a>Могут ли другие лица увидеть ключ, который я использую для реальных измерений пользователя?
Если вы встраиваете скрипт измерения в веб-страницу, другие лица смогут увидеть этот скрипт и используемый в нем ключ реальных измерений пользователя (RUM). Но не забывайте, что этот ключ отличается от идентификатора подписки и создается диспетчером трафика исключительно для сбора информации. Распространение информации о ключе RUM не нарушает безопасность учетной записи Azure.

### <a name="can-others-abuse-my-rum-key"></a>Могут ли злоумышленники использовать ключ RUM?
Ключ можно использовать для отправки в Azure неверных данных, но мы можем вас заверить, что несколько неправильных измерений не повлияют на маршрутизацию, поскольку наряду с ними мы учитываем и все остальные измерения. Если потребуется изменить ключ, вы всегда можете создать новый, после этого старый ключ становится недействительным.

###  <a name="do-i-need-to-put-the-measurement-javascript-in-all-my-web-pages"></a>Нужно ли размещать скрипт измерений JavaScript на всех веб-страницах?
Чем больше выполняется измерений, тем больше пользы принесут реальные измерения пользователя. Но вы можете самостоятельно решать, на каких веб-страницах размещать этот скрипт. Рекомендуем начать с размещения скрипта на самой популярной странице, где пользователи обычно задерживаются хотя бы на пять секунд.

### <a name="can-information-about-my-end-users-be-identified-by-traffic-manager-if-i-use-real-user-measurements"></a>Может ли диспетчер трафика получить сведения, идентифицирующие моих пользователей, когда я использую реальные измерения пользователя?
Если вы используете предлагаемый скрипт JavaScript для измерений, диспетчер трафика будет получать IP-адрес клиента, на котором работает пользователь, и исходный IP-адрес локального сопоставителя DNS, который он использует. Прежде чем использовать IP-адрес клиента в любых целях, диспетчер трафика усекает его так, чтобы было невозможно определить конкретного пользователя, от которого отправлены измерения. 

### <a name="does-the-webpage-measuring-real-user-measurements-need-to-be-using-traffic-manager-for-routing"></a>Обязательно ли использовать маршрутизацию диспетчера трафика для веб-страниц, на которых выполняются реальные измерения пользователя?
Нет, использовать диспетчер трафика не обязательно. Маршрутизация диспетчера трафика работает независимо от реальных измерений пользователя. Использовать их одновременно совершенно необязательно, но очень полезно.

### <a name="do-i-need-to-host-any-service-on-azure-regions-to-use-with-real-user-measurements"></a>Нужно ли размещать службы в регионах Azure, чтобы использовать реальные измерения пользователя?
Нет, вы не обязаны размещать серверные компоненты в Azure для поддержки функции "Измерения на стороне пользователей". Изображение размером в один пиксель, который скачивает скрипт измерений, и соответствующая служба в разных регионах Azure размещается и управляется Azure. 

### <a name="will-my-azure-bandwidth-usage-increase-when-i-use-real-user-measurements"></a>Увеличится ли мой трафик в Azure при использовании реальных измерений пользователя?
Как уже упоминалось в ответе выше, все серверные компоненты реального измерения пользователя размещаются и управляются Azure. Это означает, что использование реальных измерений пользователя не увеличит используемый вами трафик Azure. Обратите внимание, что это не относится к обычному трафику, который не включается в оплату Azure. Но мы стараемся свести такой трафик к минимуму, используя для измерений задержки до регионов Azure изображение размером всего один пиксель. 

## <a name="traffic-view"></a>Представление трафика

### <a name="what-does-traffic-view-do"></a>Что делает представление трафика?
Представление трафика — это компонент диспетчера трафика, который помогает получать сведения о пользователях и взаимодействии с ними. На основе запросов, которые получает диспетчер трафика, и таблиц сетевой задержки, которые поддерживает служба, этот компонент предоставляет следующие данные:
- регионы, из которых пользователи подключаются к конечным точкам в Azure;
- количество пользователей из каждого региона;
- регионы Azure, к которым их направляет служба маршрутизации;
- сетевая задержка до этих регионов Azure.

Эту информацию вы получаете в виде наложения на географическую карту и в табличных представлениях на портале. Также есть возможность скачать необработанные данные.

### <a name="how-can-i-benefit-from-using-traffic-view"></a>Какую пользу можно получить от представления трафика?

Представление трафика позволяет в обобщенном виде оценить трафик, который получают профили диспетчера трафика. В частности, он позволяет понять, откуда приходит больше пользователей и с какой сетевой задержкой сталкиваются эти пользователи. На основе этой информации вы сможете найти возможности для улучшений, например расширить свое присутствие на новый регион Azure, который сможет обеспечить для ваших пользователей более низкую задержку. Еще одно интересное наблюдение, которое можно сделать с помощь представления трафика — это тенденции маршрутизации к разным регионам, на основании которых можно принимать решения об увеличении или снижении мощностей в этих регионах.

### <a name="how-is-traffic-view-different-from-the-traffic-manager-metrics-available-through-azure-monitor"></a>Чем представление трафика отличается от метрик диспетчера трафика, доступных через монитор Azure?

Монитор Azure позволяет оценить обобщенную информацию о трафике для вашего профиля и конечных точек. Также в нем вы можете отслеживать состояние работоспособности конечных точек по результатам проверки работоспособности. Но если вам нужно больше информации о ваших пользователях, подключении к Azure и трафике на уровне регионов, в этом вам отлично поможет представление трафика.

### <a name="does-traffic-view-use-edns-client-subnet-information"></a>Использует ли представление трафика сведения о подсети клиента EDNS?

В DNS-запросах, обслуживаемых диспетчером трафика Azure, учитываются сведения ECS для повышения точности маршрута. Но при создании набора данных, который показывает, откуда подключаются пользователи, в представлении трафика используется только IP-адрес сопоставителя DNS.

### <a name="how-many-days-of-data-does-traffic-view-use"></a>За какой срок отображаются данные в представлении трафика?

Представление трафика выдает результат обработки данных за семь предыдущих дней. Этот период динамически сдвигается, то есть при каждом входе вы будете видеть свежие данные.

### <a name="how-does-traffic-view-handle-external-endpoints"></a>Как представление трафика обрабатывает внешние конечные точки

Если вы используете внешние конечные точки, размещенные за пределами регионов Azure, вы можете настроить в профиле диспетчера трафика сопоставление этих точек с регионами Azure, которые будут использоваться для оценки характеристик задержки (это обязательное условие, если вы хотите использовать метод маршрутизации по производительности). Если вы настроили сопоставление конечных точек с регионами Azure, для создания выходных данных представления трафика будут использоваться метрики задержки для соответствующих регионов Azure. Если не указан ни один регион Azure, сведения о задержке для этих внешних конечных точек будут пустыми.

### <a name="do-i-need-to-enable-traffic-view-for-each-profile-in-my-subscription"></a>Нужно ли включать просмотр трафика для каждого профиля в подписке?

В период использования предварительной версии представление трафика было включено на уровне подписки. В рамках улучшений, которые мы внесли перед переводом функции в общедоступный режим, теперь можно включить представление трафика на уровне профиля. Это позволяет активировать функцию с необходимыми настройками. По умолчанию представление трафика для профиля отключается.

>[!NOTE]
>Если вы включили представление трафика на уровне подписки во время использования предварительной версии, теперь необходимо включить его повторно для каждого профиля в этой подписке.
 
### <a name="how-can-i-turn-off-traffic-view"></a>Как отключить представление трафика? 
Представление трафика можно отключить для любого профиля с помощью портала или REST API. 

### <a name="how-does-traffic-view-billing-work"></a>Как выставляются счета за представление трафика?

Плата за представления трафика вычисляется по количеству точек данных, используемых для создания выходных данных. В настоящее время поддерживается только один тип данных — это количество запросов для профиля. Кроме того, оплата начисляется за обработку данных только в том периоде, когда было включено представление трафика. Таким образом, если вы включите представление трафика только на часть месяца, а затем отключите его, для расчета оплаты будут использоваться только те точки данных, которые относятся к периоду использования представления трафика.

## <a name="traffic-manager-endpoints"></a>Конечные точки диспетчера трафика

### <a name="can-i-use-traffic-manager-with-endpoints-from-multiple-subscriptions"></a>Можно ли использовать в диспетчере трафика конечные точки из нескольких подписок?

Использование конечных точек из нескольких подписок не поддерживается в веб-приложениях Azure. Для работы веб-приложений Azure требуется, чтобы любое имя пользовательского домена, используемое в них, использовалось только в пределах одной подписки. Невозможно использовать веб-приложения из нескольких подписок с одним и тем же доменным именем.

Для других типов конечных точек можно использовать диспетчер трафика, если эти конечные точки расположены в нескольких подписках. В Resource Manager в диспетчер трафика можно добавить конечные точки из любой подписки при условии, что у пользователя, настраивающего профиль диспетчера трафика, есть доступ на чтение к этим конечным точкам. Эти разрешения можно предоставить с помощью [управления доступом на основе ролей Azure Resource Manager](../active-directory/role-based-access-control-configure.md).


### <a name="can-i-use-traffic-manager-with-cloud-service-staging-slots"></a>Можно ли использовать диспетчер трафика с промежуточными слотами облачной службы?

Да. Промежуточные слоты облачной службы можно настроить в диспетчере трафика в качестве внешних конечных точек. Проверки работоспособности будут по-прежнему оплачиваться по тарифу для конечных точек Azure. Так как тип внешней конечной точки уже используется, изменения основной службы не применяются автоматически. При работе с внешними конечными точками диспетчер трафика не может обнаружить остановку или удаление облачной службы. Таким образом, диспетчер трафика продолжает выставлять счета за проверки работоспособности, пока конечная точка не будет отключена или удалена.

### <a name="does-traffic-manager-support-ipv6-endpoints"></a>Поддерживает ли диспетчер трафика конечные точки IP версии 6?

Диспетчер трафика в настоящее время не предоставляет серверы доменных имен с IPv6-адресованием. Тем не менее диспетчер трафика может использоваться IPv6-клиентами, подключающимся к конечным точкам IPv6. Клиент не отправляет DNS-запросы непосредственно к диспетчеру трафика. Вместо этого клиент использует рекурсивную службу DNS. Клиент, использующий только IPv6, отправляет запросы к рекурсивной службе DNS через IPv6. Затем рекурсивная служба должна иметь возможность связаться с серверами доменных имен диспетчера трафика, используя IPv4-адрес.

Диспетчер трафика возвращает ответ с DNS-именем конечной точки. Для поддержки конечной точки IPv6 должна существовать запись DNS типа AAAA, указывающая DNS-имя конечной точки для IPv6-адреса. Проверки работоспособности диспетчера трафика поддерживают только IPv4-адреса. Служба должна предоставлять конечную точку IPv4 с тем же DNS-именем.

### <a name="can-i-use-traffic-manager-with-more-than-one-web-app-in-the-same-region"></a>Можно ли использовать в диспетчере трафика несколько веб-приложений в одном и том же регионе?

Как правило, диспетчер трафика используется для перенаправления трафика в приложения, развернутые в разных регионах. Тем не менее его также можно использовать с приложениями, у которых есть несколько развертываний в одном и том же регионе. Конечные точки Azure диспетчера трафика не допускают добавление нескольких конечных точек веб-приложения, находящихся в одном и том же регионе Azure, в один и тот же профиль.

### <a name="how-do-i-move-my-traffic-manager-profiles-azure-endpoints-to-a-different-resource-group"></a>Как переместить конечные точки Azure профиля диспетчера трафика в другую группу ресурсов?

Конечные точки Azure, связанные с профилем диспетчера трафика, отслеживаются по идентификаторам ресурсов. Идентификатор ресурса Azure меняется, когда ресурс, используемый в качестве конечной точки (например, общедоступный IP-адрес, классическая облачная служба, веб-приложение или другой вложенный профиль диспетчера трафика), переносится в другую группу ресурсов. Сейчас в этом сценарии необходимо обновить профиль диспетчера трафика, сначала удалив, а затем добавив конечные точки в профиль. 

##  <a name="traffic-manager-endpoint-monitoring"></a>Мониторинг конечных точек в диспетчере трафика

### <a name="is-traffic-manager-resilient-to-azure-region-failures"></a>Устойчив ли диспетчер трафика к сбоям в регионе Azure?

Диспетчер трафика является ключевым компонентом, обеспечивающим высокую доступность приложений в Azure.
Для обеспечения высокого уровня доступности диспетчер трафика должен иметь исключительно высокий уровень доступности и быть устойчивым к сбоям регионов.

По умолчанию компоненты диспетчера трафика отказоустойчивы к полному сбою любого региона Azure. Эта устойчивость применяется ко всем компонентам диспетчера трафика: DNS-серверам, API-интерфейсам, уровню хранилища и службе мониторинга конечных точек.

В маловероятном случае сбоя всего региона Azure диспетчер трафика должен продолжить нормальную работу. Приложения, развернутые в нескольких регионах Azure, могут положиться на диспетчер трафика, который перенаправит трафик к доступному экземпляру приложения.

### <a name="how-does-the-choice-of-resource-group-location-affect-traffic-manager"></a>Каким образом выбор расположения группы ресурсов влияет на диспетчер трафика?

Диспетчер трафика — это единая глобальная служба. Она не является региональной. Выбор расположения группы ресурсов никак не влияет на профили диспетчера трафика, развернутые в этой группе ресурсов.

Для Azure Resource Manager требуется, чтобы все группы ресурсов указывали расположение, которое определяет расположение по умолчанию для ресурсов, развернутых в этой группе ресурсов. При создании профиля диспетчера трафика он создается в группе ресурсов. Во всех профилях диспетчера трафика в качестве расположения задано значение **Глобальный** (тем самым переопределяется группа ресурсов по умолчанию).

### <a name="how-do-i-determine-the-current-health-of-each-endpoint"></a>Как определить текущую работоспособность каждой конечной точки?

На портале управления Azure отображается текущее состояние мониторинга для каждой конечной точки, а также всего профиля. Эти сведения также можно получить с помощью [REST API](https://msdn.microsoft.com/library/azure/mt163667.aspx) отслеживания трафика, [командлетов PowerShell](https://msdn.microsoft.com/library/mt125941.aspx) и [кроссплатформенного интерфейса командной строки Azure](../cli-install-nodejs.md).

Azure Monitor может использоваться для отслеживания работоспособности конечных точек и просмотра их визуального представления. Дополнительные сведения об использовании Azure Monitor см. в статье [Обзор метрик в Microsoft Azure](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-overview-metrics).

### <a name="can-i-monitor-https-endpoints"></a>Можно ли отслеживать конечные точки HTTPS?

Да. Диспетчер трафика поддерживает проверку по протоколу HTTPS. Настройте **HTTPS** в качестве протокола в конфигурации мониторинга.

Диспетчер трафика не может предоставить проверку сертификатов. В частности:

* сертификаты на стороне сервера не проверяются;
* сертификаты SNI на стороне сервера не поддерживаются;
* клиентские сертификаты не поддерживаются.

### <a name="i-stopped-an-azure-cloud-service--web-application-endpoint-in-my-traffic-manager-profile-but-i-am-not-receiving-any-traffic-even-after-i-restarted-it-how-can-i-fix-this"></a>Работа облачной службы Azure и конечной точки в веб-приложениях в профиле диспетчера трафика была остановлена, но трафик все равно не приходит даже после перезапуска. Как это исправить?

После остановки облачной службы Azure и конечной точки в веб-приложениях диспетчер трафика прекращает проверку их состояния и перезапускает данную проверку только после перезапуска конечной точки. Во избежание этой задержки отключите и повторно включите эту конечную точку в профиле диспетчера трафика после перезагрузки.   

### <a name="can-i-use-traffic-manager-even-if-my-application-does-not-have-support-for-http-or-https"></a>Могу ли я использовать диспетчер трафика, даже если приложение не поддерживает протоколы HTTP и HTTPS?

Да. Вы можете указать протокол ТСР как протокол мониторинга. Диспетчер трафика запустит подключение TCP и будет ожидать ответ от конечной точки. Если конечная точка отвечает на запрос на подключение ответом на установку подключения (в течение периода ожидания), тогда такая конечная точка помечается как работоспособная.

### <a name="what-specific-responses-are-required-from-the-endpoint-when-using-tcp-monitoring"></a>Какие стоит рассмотреть ответы от конечной точки при использовании протокола ТСР как протокола мониторинга?

При использовании протокола мониторинга ТСР диспетчер трафика запускает трехстороннее подтверждение TCP, отправляя запрос SYN в конечную точку на указанном порте. Затем он определенный период времени (указанный в параметрах времени ожидания) ожидает ответ от конечной точки. Если конечная точка отвечает на запрос SYN ответом SYN-ACK в течение периода ожидания, указанного в параметрах мониторинга, тогда такая конечная точка считается работоспособной. При получении ответа SYN ACK диспетчер трафика сбрасывает подключение, отправляя ответ обратно с помощью RST.

### <a name="how-fast-does-traffic-manager-move-my-users-away-from-an-unhealthy-endpoint"></a>Насколько быстро диспетчер трафика перемещает пользователей из неработоспособной конечной точки?

Диспетчер трафика предоставляет несколько параметров, которые могут помочь в управлении отработкой отказа профиля диспетчера трафика следующим образом:
- Вы можете указать частоту проверки конечных точек диспетчером трафика, задав интервал проверки в 10 секунд. Это позволит обнаружить неработоспособную конечную точку как можно скорее. 
- Вы можете указать время ожидания запроса на проверку работоспособности (минимальное значение — 5 секунд).
- Вы можете указать количество сбоев, по достижении которых конечная точка будет помечена как неработоспособная. Вы можете установить значение от 0. В таком случае конечная точка будет помечена как неработоспособная, как только произойдет первый сбой при проверке работоспособности. Тем не менее использование минимального значения 0 для допустимого числа сбоев может привести к тому, что конечные точки перестанут использоваться из-за любых временных сбоев, которые могут произойти во время проверки.
- Вы можете указать для срока жизни ответа DNS значение от 0. Это означает, что сопоставители DNS не могут кэшировать ответ и каждый новый запрос получает ответ, включающий самые последние сведения о работоспособности, которые содержит диспетчер трафика.

С помощью этих параметров диспетчер трафика может обеспечивать отработку отказа в течение 10 секунд после того, как конечная точка определена как неработоспособная, и запрос DNS выполняется для соответствующего профиля.

### <a name="how-can-i-specify-different-monitoring-settings-for-different-endpoints-in-a-profile"></a>Как я могу указать в профиле другие параметры мониторинга для других конечных точек?

Параметры мониторинга диспетчера трафика заданы для каждого уровня профиля. Если вам нужно использовать другие параметры мониторинга только для одной конечной точки, это можно сделать, если задать эту конечную точку как [вложенный профиль](traffic-manager-nested-profiles.md), параметры мониторинга которого отличаются от родительского профиля.

### <a name="what-host-header-do-endpoint-health-checks-use"></a>Какой заголовок узла используется для проверки работоспособности конечной точки?

Для проверки работоспособности HTTP и HTTPS диспетчер трафика использует заголовки узлов. Заголовок узла, используемый диспетчером трафика, представляет собой имя целевой конечной точки, настроенной в профиле. Значение, используемое в заголовке узла, нельзя использовать отдельно от свойства цели.

### <a name="what-are-the-ip-addresses-from-which-the-health-checks-originate"></a>Что такое IP-адресов, используемые при проверке работоспособности?

Щелкните [здесь](https://azuretrafficmanagerdata.blob.core.windows.net/probes/azure/probe-ip-ranges.json), чтобы просмотреть JSON-файл со списком IP-адресов, с которых диспетчер трафика может запускать проверку работоспособности. Проверьте IP-адреса, перечисленные в JSON-файле, чтобы узнать, разрешены ли входящие подключения с этих адресов на конечных точках для проверки состояния их работоспособности.

### <a name="how-many-health-checks-to-my-endpoint-can-i-expect-from-traffic-manager"></a>Сколько проверок работоспособности конечной точки выполняет диспетчер трафика?

Число проверок работоспособности конечной точки диспетчером трафика зависит от следующих условий:
- Значения, которое вы задали для интервала мониторинга (меньший интервал означает больше запросов, которые передаются в конечную точку за любой указанный период времени).
- Количества расположений, из которых выполняются проверки работоспособности (IP-адреса, с которых диспетчер трафика может запускать проверку работоспособности, перечислены выше в часто задаваемых вопросах).

## <a name="traffic-manager-nested-profiles"></a>Вложенные профили диспетчера трафика

### <a name="how-do-i-configure-nested-profiles"></a>Как настроить вложенные профили?

Вложенные профили диспетчера трафика можно настроить с помощью Azure Resource Manager (ARM), классических интерфейсов REST API Azure, командлетов Azure PowerShell и команд кроссплатформенного интерфейса командной строки Azure. Они также поддерживаются на новом портале Azure.

### <a name="how-many-layers-of-nesting-does-traffic-manger-support"></a>Число уровней вложенности поддерживает диспетчер трафика?

Вложенность профилей может достигать 10 уровней. Нельзя использовать циклы (петли).

### <a name="can-i-mix-other-endpoint-types-with-nested-child-profiles-in-the-same-traffic-manager-profile"></a>Можно ли совмещать конечные точки других типов с вложенными дочерними профилями в одном профиле диспетчера трафика?

Да. Можно без каких-либо ограничений комбинировать в профиле конечные точки разных типов.

### <a name="how-does-the-billing-model-apply-for-nested-profiles"></a>Как модель выставления счетов применяется к вложенным профилям?

Использование вложенных профилей не приводит к повышению цен.

При выставлении счетов за использование диспетчера трафика учитываются два фактора: проверки работоспособности конечных точек и число запросов DNS (миллионы).

* Проверки работоспособности конечных точек: плата за дочерний профиль не взимается, если он настроен как конечная точка в родительском профиле. Мониторинг конечных точек в дочернем профиле тарифицируется обычным образом.
* Запросы DNS: каждый запрос учитывается только один раз. Запрос к родительскому профилю, который возвращает конечную точку из дочернего профиля, тарифицируется только для родительского профиля.

Подробнее см. на [странице цен для диспетчера трафика](https://azure.microsoft.com/pricing/details/traffic-manager/).

### <a name="is-there-a-performance-impact-for-nested-profiles"></a>Снижают ли вложенные профили производительность?

Нет. Использование вложенных профилей не отражается на производительности.

Серверы имен диспетчера трафика используют внутренний механизм опроса иерархии профилей при обработке каждого запроса DNS. На запрос DNS к родительскому профилю может предоставляться ответ DNS, указывающий на конечную точку дочернего профиля. Как для отдельного профиля, так и для вложенных профилей достаточно одной записи CNAME. Нет необходимости создавать запись CNAME для каждого профиля в иерархии.

### <a name="how-does-traffic-manager-compute-the-health-of-a-nested-endpoint-in-a-parent-profile"></a>Как диспетчер трафика вычисляет работоспособность вложенной конечной точки в родительском профиле?

Родительский профиль не проверяет состояние дочерних элементов напрямую. Вместо этого вычисляется общая характеристика работоспособности для дочернего профиля с учетом состояния работоспособности всех конечных точек этого профиля. Эта информация передается вверх по иерархии вложенных профилей для определения работоспособности вложенных конечных точек. Родительский профиль использует сводные данные о работоспособности и определяет, можно ли передавать трафик в дочерний профиль.

В следующей таблице описан алгоритм диспетчера трафика для проверки работоспособности вложенной конечной точки.

| Состояние монитора дочернего профиля | Состояние монитора родительской конечной точки | Заметки |
| --- | --- | --- |
| "Отключено". Дочерний профиль отключен. |Остановлено |Состояние родительской конечной точки — «Остановлено», а не «Отключено». Состояние «Отключено» указывает, что вы отключили конечную точку в родительском профиле. |
| "Пониженная функциональность". Как минимум одна конечная точка дочернего профиля находится в состоянии пониженной функциональности. |"В сети": количество конечных точек в дочернем профиле, находящихся в состоянии "В сети", не меньше значения MinChildEndpoints.<BR>"Проверка конечной точки": сумма конечных точек в дочернем профиле, находящихся в состояниях "В сети" и "Проверка конечной точки", не меньше значения MinChildEndpoints.<BR>В противном случае: "Пониженная функциональность". |Трафик перенаправляется к конечной точке с состоянием "Проверка конечной точки". Если задано слишком большое значение MinChildEndpoints, функциональность конечной точки будет понижена. |
| В сети. Как минимум одна конечная точка дочернего профиля находится в подключенном состоянии. Нет конечных точек в состоянии пониженной функциональности. |См. выше. | |
| "Проверка конечных точек". Как минимум одна конечная точка дочернего профиля находится в состоянии проверки конечной точки. Нет конечных точек в подключенном состоянии или в состоянии пониженной функциональности. |То же, что и выше. | |
| "Неактивно". Все конечные точки дочернего профиля находятся в отключенном или остановленном состоянии либо в этом профиле нет конечных точек. |Остановлено | |

## <a name="next-steps"></a>Дальнейшие действия:
- См. дополнительные сведения в статье [Мониторинг и отработка отказов конечной точки диспетчера трафика](../traffic-manager/traffic-manager-monitoring.md).
- См. дополнительные сведения в статье [Методы маршрутизации трафика диспетчером трафика](../traffic-manager/traffic-manager-routing-methods.md).
