---
title: Руководство по использованию протокола гибридных подключений ретранслятора Azure | Документация Майкрософт
description: Руководство по использованию протокола гибридных подключений ретранслятора Azure.
services: service-bus-relay
documentationcenter: na
author: clemensv
manager: timlt
editor: ''
ms.assetid: 149f980c-3702-4805-8069-5321275bc3e8
ms.service: service-bus-relay
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 01/23/2018
ms.author: sethm
ms.openlocfilehash: 1979746d143dbf8c3f4bca3f9a3a7925fe8e3f0d
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="azure-relay-hybrid-connections-protocol"></a>Протокол гибридных подключений ретранслятора Azure
Ретранслятор Azure является одной из ключевых функций платформы служебной шины Azure. Новая функция ретранслятора, называемая *Гибридные подключения*, представляет собой безопасный открытый протокол нового поколения, основанный на HTTP и WebSockets. Она заменяет собой прошлый компонент с тем же названием *Службы BizTalk*, основанный на собственной версии протокола. Интеграция гибридных подключений со службами приложений Azure будет по-прежнему работать.

Функция "Гибридные подключения" позволяет установить двунаправленное соединение и организовать передачу двоичных потоков между двумя сетевыми приложениями, в течение которой одно из приложений (или оба) может находиться за NAT или брандмауэром. В этой статье описывается взаимодействие на стороне клиента с ретранслятором гибридных подключений для подключения клиентов в роли прослушивателя и отправителя, а также процесс приема прослушивателями новых подключений.

## <a name="interaction-model"></a>Модель взаимодействия
Ретранслятор гибридных подключений подключает две стороны, предоставляя точку рандеву в облаке Azure, которую обе стороны могут обнаружить и с которой они могут установить соединение из своей сети. В этом и других документах, а также в интерфейсах API и на портале Azure точка рандеву называется "Гибридное подключение". Далее в этой статье мы будем называть конечную точку службы "Гибридные подключения" просто "служба". Модель взаимодействия полагается на номенклатуру, установленную многими другими сетевыми API.

Существует прослушиватель, который сначала указывает готовность обработать входящие подключения, а затем принимает их по мере их поступления. С другой стороны существует подключающий клиент, который предлагает подключение к прослушивателю, ожидая, что это подключение будет принято для формирования двустороннего пути обмена данными.
"Подключиться", "прослушать" и "принять" — это стандартные термины, которые встречаются в большинстве API-интерфейсах сокетов.

В любой модели взаимодействия с применением ретранслятора обе стороны выполняют исходящее подключение к конечной точке службы, и, таким образом, "прослушиватель" становится "клиентом" (как принято это называть в разговорной речи). Также возможно нагромождение других терминов. Поэтому ниже приводится точная терминология, которую мы используем для гибридных подключений.

Программы с обеих сторон подключения называются "клиентами", так как они являются клиентами для службы. Клиент, который ожидает подключения и принимает его, является "прослушивателем" или, другими словами, пребывает в "роли прослушивателя". Клиент, инициирующий новое подключение к прослушивателю через службу, называется "отправителем" или, другими словами, пребывает в "роли отправителя".

### <a name="listener-interactions"></a>Взаимодействия прослушивателя
Существует четыре типа взаимодействий между прослушивателем и службой. Подробнее все они описаны далее в этой статье.

#### <a name="listen"></a>Прослушивание
Чтобы сообщить службе о своей готовности принять подключения, прослушиватель создает исходящее подключение через веб-сокет. Подтверждение соединения содержит имя гибридного подключения, настроенное в пространстве имен ретранслятора, и маркер безопасности, который предоставляет этому имени право на прослушивание.
Когда служба принимает веб-сокет, регистрация завершается, а установленный веб-сокет поддерживается в рабочем состоянии как "канал управления" для всех последующих взаимодействий. При гибридном подключении служба поддерживает до 25 параллельных прослушивателей. При наличии двух и более активных прослушивателей входящие подключения распределяются между ними в произвольном порядке. Равномерное распределение при этом не гарантируется.

#### <a name="accept"></a>Принять
Когда отправитель открывает новое подключение к службе, она выбирает один из активных прослушивателей и уведомляет его о гибридном подключении. Уведомление отправляется в прослушиватель по открытому каналу управления в виде сообщения JSON, содержащего URL-адрес конечной точки веб-сокета, к которому прослушиватель должен подключиться, чтобы принять подключение.

URL-адрес может и должен использоваться прослушивателем напрямую без каких-либо дополнительных действий.
Закодированная информация действительна только в течение короткого периода времени; по сути, это время зависит от того, сколько отправитель готов ожидать установления полного подключения, но не может превышать 30 секунд. URL-адрес может быть использован только для одного успешного подключения. Сразу же после подключения через веб-сокет к URL-адресу рандеву все дальнейшие действия на этом веб-сокете ретранслируются от отправителя и обратно без какого-либо вмешательства или интерпретации со стороны службы.

#### <a name="renew"></a>Возобновление
Срок действия маркера безопасности, который должен использоваться для регистрации прослушивателя и обслуживания канала управления, может истечь, когда прослушиватель еще активен. Истечение срока действия маркера не влияет на текущие подключения, но приводит к отключению службы от канала управления в момент истечения срока действия или вскоре после этого. Операция возобновления является сообщением JSON, которое прослушиватель может отправить для замены маркера, связанного с каналом управления, чтобы канал управления оставался подключенным в течение длительного времени.

#### <a name="ping"></a>Проверка связи
Если канал управления долго простаивает, то посредники на его пути, например балансировщики нагрузки или NAT, могут отключить TCP-соединение. Операция проверки связи позволяет этого избежать, отправляя по каналу небольшой объем данных и напоминая всем на сетевом маршруте, что подключение еще активно. Это также служит тестом активности для прослушивателя. В случае сбоя проверки связи канал управления считается недоступным и прослушивателю требуется подключиться снова.

### <a name="sender-interaction"></a>Взаимодействия отправителя
Существует только одно взаимодействие отправителя со службой — подключение.

#### <a name="connect"></a>Подключение
Операция подключения открывает веб-сокет на стороне службы, указывая имя гибридного подключения и (необязательный, но требуемый по умолчанию) маркер безопасности, предоставляющий разрешение на отправку в строке запроса. Затем служба взаимодействует с прослушивателем, как описано ранее. При этом прослушиватель создает встречное подключение, которое объединяется с этим веб-сокетом. После приема веб-сокета все дальнейшие взаимодействия на нем выполняются с помощью подключенного прослушивателя.

### <a name="interaction-summary"></a>Сводка взаимодействий
В результате такой модели взаимодействия после подтверждения соединения клиент отправителя имеет "чистый" веб-сокет, который подключен к прослушивателю и не требует дальнейшей подготовки. Эта модель позволяет практически любой существующей реализации клиента веб-сокета с легкостью воспользоваться преимуществами службы гибридных подключений, указав правильно построенный URL-адрес на уровне клиента веб-сокета.

Веб-сокет встречного подключения, который прослушиватель получает при приеме, также является чистым и может передаваться любой существующей реализации сервера веб-сокета с минимальной дополнительной абстракцией, которая различает операции accept ("принять") на прослушивателях локальной сети своей платформы и удаленные операции accept гибридных подключений.

## <a name="protocol-reference"></a>Справочник по протоколу

В этом разделе подробно описываются взаимодействия протокола, упомянутые выше.

Все подключения через веб-сокет выполняются через порт 443 как обновление с HTTPS 1.1, которое часто абстрагируется некоторыми платформами веб-сокета или API. В данном описании не указывается конкретная реализации и не предлагается определенная платформа.

### <a name="listener-protocol"></a>Протокол прослушивателя
Протокол прослушивателя состоит из двух жестов подключения и трех операций с сообщениями.

#### <a name="listener-control-channel-connection"></a>Подключение канала управления прослушивателя
Канал управления открывается посредством создания подключения через веб-сокет по такому адресу:

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...[&sb-hc-id=...]&sb-hc-token=...
```

`namespace-address` — это полное доменное имя пространства имен ретранслятора Azure, в котором размещается гибридное подключение (как правило, в формате `{myname}.servicebus.windows.net`).

Ниже приведены варианты параметров строки запроса.

| Параметр | Обязательно | ОПИСАНИЕ |
| --- | --- | --- |
| `sb-hc-action` |Yes |Для роли прослушивателя значение параметра должно быть **sb-hc-action=listen**. |
| `{path}` |Yes |Закодированный в URL-адресе путь к пространству имен предварительно настроенного гибридного подключения для регистрации данного прослушивателя. Это выражение добавляется к фиксированному сегменту пути `$hc/`. |
| `sb-hc-token` |Да\* |Прослушиватель должен указать допустимый закодированный в URL-адресе общий маркер служебной шины для пространства имен или гибридного подключения, который предоставляет право на **прослушивание**. |
| `sb-hc-id` |Нет  |Этот необязательный идентификатор, предоставляемый клиентом, обеспечивает комплексную диагностическую трассировку. |

В случае сбоя подключения через веб-сокет из-за того, что путь гибридного подключения не зарегистрирован, маркер является недопустимым либо отсутствует или из-за какой-то другой ошибки, указываются сведения об ошибке. Для этого используется обычная модель предоставления сведений о состоянии HTTP 1.1. Описание состояния содержит идентификатор отслеживания ошибки, который можно сообщить в службу поддержки Azure.

| Код | Ошибка | ОПИСАНИЕ |
| --- | --- | --- |
| 404 |Не найдено |Путь гибридного подключения является недопустимым, или базовый URL-адрес имеет неправильный формат. |
| 401 |Не авторизовано |Маркер безопасности отсутствует, имеет неправильный формат или является недопустимым. |
| 403 |Запрещено |Маркер безопасности является недопустимым для этого пути и для этого действия. |
| 500 |Внутренняя ошибка |Произошла неизвестная ошибка в службе. |

Если служба намеренно завершает подключение через веб-сокет после того, как оно установлено, то причина такого действия сообщается с помощью соответствующего кода ошибки протокола веб-сокета и сообщения с описанием ошибки, которое также содержит идентификатор отслеживания. Служба не завершит работу канала управления при отсутствии условия ошибки. Любое завершение работы без ошибок контролируется клиентом.

| Состояние веб-сокета | ОПИСАНИЕ |
| --- | --- |
| 1001 |Путь гибридного подключения был удален или отключен. |
| 1008 |Истек срок действия маркера безопасности, поэтому нарушена политика авторизации. |
| 1011 |Произошла неизвестная ошибка в службе. |

### <a name="accept-handshake"></a>Подтверждение приема
Служба отправляет прослушивателю уведомление о приеме по ранее установленному каналу управления в виде сообщения JSON в текстовом окне веб-сокета. На это сообщение нет ответа.

Сообщение содержит объект JSON с именем accept, который определяет следующие свойства:

* **address** — строка URL-адреса, используемая при установлении соединения между веб-сокетом и службой. Указывает, чтобы служба приняла входящее подключение.
* **id** — уникальный идентификатор для этого подключения. Если идентификатор передан клиентом отправителя, он имеет значение, указанное отправителем. В противном случае это значение, сформированное системой.
* **connectHeaders** — все заголовки HTTP, предоставленные отправителем для конечной точки ретранслятора. Сюда также включаются заголовки Sec-WebSocket-Protocol и Sec-WebSocket-Extensions.

#### <a name="accept-message"></a>Сообщение accept

```json
{                                                           
    "accept" : {
        "address" : "wss://168.61.148.205:443/$hc/{path}?..."    
        "id" : "4cb542c3-047a-4d40-a19f-bdc66441e736",  
        "connectHeaders" : {                                         
            "Host" : "...",                                                
            "Sec-WebSocket-Protocol" : "...",                              
            "Sec-WebSocket-Extensions" : "..."                             
        }                                                            
     }                                                         
}
```

URL-адрес в сообщении JSON используется прослушивателем для того, чтобы указать веб-сокету принять или отклонить сокет отправителя.

#### <a name="accepting-the-socket"></a>Прием сокета
Чтобы принять, прослушиватель устанавливает подключение к указанному адресу по протоколу WebSocket.

Если сообщение accept содержит заголовок `Sec-WebSocket-Protocol`, ожидается, что прослушиватель примет веб-сокет, только если он поддерживает этот протокол. При установке подключения веб-сокета он также установит заголовок.

Это же относится и к заголовку `Sec-WebSocket-Extensions`. Если платформа поддерживает расширение, она должна задать заголовок для ответа на стороне сервера необходимого подтверждения `Sec-WebSocket-Extensions` для расширения.

URL-адрес должен использоваться "как есть" для приема сокета, но при этом содержит следующие параметры:

| Параметр | Обязательно | ОПИСАНИЕ |
| --- | --- | --- |
| `sb-hc-action` |Yes |Для приема сокета этот параметр должен иметь значение `sb-hc-action=accept`. |
| `{path}` |Yes |(см. следующий абзац). |
| `sb-hc-id` |Нет  |См. описание параметра **id**, приведенное выше. |

`{path}` — это закодированный в URL-адресе путь к пространству имен предварительно настроенного гибридного подключения для регистрации прослушивателя. Это выражение добавляется к фиксированному сегменту пути `$hc/`. 

Выражение `path` можно расширить с помощью суффикса и строкового выражения запроса, следующего за зарегистрированным именем после разделительной косой черты. Это позволяет клиенту отправителя передать аргументы перенаправления принимающему прослушивателю, когда невозможно включить заголовки HTTP. Ожидается, что платформа прослушивателя анализирует и выделяет часть фиксированного пути и зарегистрированное имя и сделает оставшуюся часть пути (возможно, без аргументов строки запроса с префиксом `sb-`) доступной для приложения, которое должно принять решение о принятии подключения.

Дополнительные сведения см. в разделе "Протокол отправителя" ниже.

Если есть ошибка, то ответ службы может быть следующим:

| Код | Ошибка | ОПИСАНИЕ |
| --- | --- | --- |
| 403 |Запрещено |URL-адрес является недопустимым. |
| 500 |Внутренняя ошибка |Произошла неизвестная ошибка в службе. |

После установления подключения сервер завершит работу веб-сокета, когда завершит работу веб-сокет отправителя. Кроме того, может отобразиться следующее состояние:

| Состояние веб-сокета | ОПИСАНИЕ |
| --- | --- |
| 1001 |Клиент отправителя прервал подключение. |
| 1001 |Путь гибридного подключения был удален или отключен. |
| 1008 |Истек срок действия маркера безопасности, поэтому нарушена политика авторизации. |
| 1011 |Произошла неизвестная ошибка в службе. |

#### <a name="rejecting-the-socket"></a>Отклонение сокета
Для отклонения сокета после проверки сообщения accept требуется похожее подтверждение, чтобы код состояния и описание состояния, сообщающие причину отклонения, были переданы обратно отправителю.

В выбранной конфигурации протокола используется подтверждение WebSocket (которое должно завершаться при определенном состоянии ошибки), чтобы реализации клиента прослушивателя могли по-прежнему полагаться на клиент WebSocket и не нуждались в использовании дополнительного чистого клиента HTTP.

Для отклонения сокета клиент использует URI адреса из сообщения accept и добавляет к нему два параметра строки запроса:

| Параметр | Обязательно | ОПИСАНИЕ |
| --- | --- | --- |
| statusCode |Yes |Числовой код состояния HTTP. |
| statusDescription |Yes |Понятная для пользователя причина отклонения. |

Затем полученный универсальный код ресурса (URI) используется для установления подключения WebSocket.

При правильном выполнении это подтверждение намеренно завершится ошибкой с кодом HTTP 410, так как подключение по протоколу WebSocket не было установлено. Если возникает ошибка, то возможны такие варианты:

| Код | Ошибка | ОПИСАНИЕ |
| --- | --- | --- |
| 403 |Запрещено |URL-адрес является недопустимым. |
| 500 |Внутренняя ошибка |Произошла неизвестная ошибка в службе. |

### <a name="listener-token-renewal"></a>Возобновление действия маркера прослушивателя
Когда истекает срок действия маркера прослушивателя, прослушиватель может заменить маркер, отправив текстовое сообщение в службу по подключенному каналу управления. Сообщение содержит объект JSON с именем `renewToken`, который определяет следующее свойство:

* **token** — допустимый закодированный в URL-адресе общий маркер служебной шины для пространства имен или гибридного подключения, который предоставляет право на **прослушивание**.

#### <a name="renewtoken-message"></a>Сообщение renewToken

```json
{                                                                                                                                                                        
    "renewToken" : {                                                                                                                                                      
        "token" : "SharedAccessSignature sr=http%3a%2f%2fcontoso.servicebus.windows.net%2fhyco%2f&amp;sig=XXXXXXXXXX%3d&amp;se=1471633754&amp;skn=SasKeyName"  
    }                                                                                                                                                                     
}
```

Если при проверке маркера произойдет сбой, в доступе будет отказано и облачная служба завершит работу веб-сокета канала управления с ошибкой. В противном случае ответа не будет.

| Состояние веб-сокета | ОПИСАНИЕ |
| --- | --- |
| 1008 |Истек срок действия маркера безопасности, поэтому нарушена политика авторизации. |

## <a name="sender-protocol"></a>Протокол отправителя
Протокол отправителя практически идентичен установке прослушивателя.
Целью является максимальная прозрачность для всего веб-сокета. Адрес подключения такой же, как для прослушивателя, но отличается сегмент action и для маркера требуется другое разрешение:

```
wss://{namespace-address}/$hc/{path}?sb-hc-action=...&sb-hc-id=...&sbc-hc-token=...
```

*namespace-address* — это полное доменное имя пространства имен ретранслятора Azure, в котором размещается гибридное подключение (как правило, в формате `{myname}.servicebus.windows.net`).

Запрос может содержать дополнительные заголовки HTTP произвольной формы, включая заголовки, определяемые приложением. Все передаваемые заголовки направляются в прослушиватель. Их можно найти в объекте `connectHeader` контрольного сообщения **accept**.

Ниже приведены варианты параметров строки запроса.

| Параметр | Обязательный? | ОПИСАНИЕ |
| --- | --- | --- |
| `sb-hc-action` |Yes |Для роли отправителя значение параметра должно быть `action=connect`. |
| `{path}` |Yes |(см. следующий абзац). |
| `sb-hc-token` |Да\* |Прослушиватель должен указать допустимый закодированный в URL-адресе общий маркер служебной шины для пространства имен или гибридного подключения, который предоставляет право на **отправку**. |
| `sb-hc-id` |Нет  |Необязательный идентификатор, который обеспечивает комплексную диагностическую трассировку и доступен для прослушивателя при подтверждении приема. |

`{path}` — это закодированный в URL-адресе путь к пространству имен предварительно настроенного гибридного подключения для регистрации прослушивателя. Выражение `path` можно расширить с помощью суффикса и строкового выражения запроса для дальнейшего взаимодействия. Если гибридное подключение регистрируется с путем `hyco`, выражение `path` может иметь вид `hyco/suffix?param=value&...`, после чего следуют параметры строки запроса, заданные здесь. Тогда полное выражение может иметь такой вид:

```
wss://{namespace-address}/$hc/hyco/suffix?param=value&sb-hc-action=...[&sb-hc-id=...&]sbc-hc-token=...
```

Выражение `path` передается на прослушиватель в URI адреса, который содержится в контрольном сообщении accept.

В случае сбоя подключения через веб-сокет из-за того, что путь гибридного подключения не зарегистрирован, маркер является недопустимым либо отсутствует или из-за какой-то другой ошибки, указываются сведения об ошибке. Для этого используется обычная модель предоставления сведений о состоянии HTTP 1.1. Описание состояния содержит идентификатор отслеживания ошибки, который можно сообщить в службу поддержки Azure.

| Код | Ошибка | ОПИСАНИЕ |
| --- | --- | --- |
| 404 |Не найдено |Путь гибридного подключения является недопустимым, или базовый URL-адрес имеет неправильный формат. |
| 401 |Не авторизовано |Маркер безопасности отсутствует, имеет неправильный формат или является недопустимым. |
| 403 |Запрещено |Маркер безопасности является недопустимым для этого пути и для этого действия. |
| 500 |Внутренняя ошибка |Произошла неизвестная ошибка в службе. |

Если служба намеренно завершает подключение через веб-сокет после того, как оно установлено, то причина такого действия сообщается с помощью соответствующего кода ошибки протокола веб-сокета и сообщения с описанием ошибки, которое также содержит идентификатор отслеживания.

| Состояние веб-сокета | ОПИСАНИЕ |
| --- | --- |
| 1000 |Прослушиватель завершил работу сокета. |
| 1001 |Путь гибридного подключения был удален или отключен. |
| 1008 |Истек срок действия маркера безопасности, поэтому нарушена политика авторизации. |
| 1011 |Произошла неизвестная ошибка в службе. |

## <a name="next-steps"></a>Дополнительная информация
* [Вопросы и ответы по ретранслятору](relay-faq.md)
* [Создание пространства имен](relay-create-namespace-portal.md)
* [Приступая к работе с .NET](relay-hybrid-connections-dotnet-get-started.md)
* [Приступая к работе с Node](relay-hybrid-connections-node-get-started.md)

