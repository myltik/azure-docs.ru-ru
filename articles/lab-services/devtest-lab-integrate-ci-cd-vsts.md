---
title: Интеграция Azure DevTest Labs в конвейер непрерывной интеграции и доставки VSTS | Документация Майкрософт
description: Сведения об интеграции Azure DevTest Labs в конвейер непрерывной интеграции и доставки VSTS.
services: devtest-lab,virtual-machines,lab-services
documentationcenter: na
author: spelluru
manager: femila
editor: ''
ms.assetid: a26df85e-2a00-462b-aac1-dd3539532569
ms.service: lab-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/17/2018
ms.author: spelluru
ms.openlocfilehash: 1af195e644fe93e0c59f5e4402dd8942f5fe1aba
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
---
# <a name="integrate-azure-devtest-labs-into-your-vsts-continuous-integration-and-delivery-pipeline"></a>Интеграция Azure DevTest Labs в конвейер непрерывной интеграции и доставки VSTS
Для легкой интеграции конвейера "сборки — выпуска" CI/CD с Azure DevTest Labs можно использовать расширение *Задачи Azure DevTest Labs*, установленное в Visual Studio Team Services (VSTS). Расширение устанавливает три задачи: 
* Создание виртуальной машины
* Создание пользовательского образа из виртуальной машины
* Удаление виртуальной машины 

Таким образом можно с легкостью, к примеру, быстро развернуть эталонный образ для определенной задачи теста и удалить его после выполнения теста.

В этой статье показано, как создать и развернуть виртуальную машину, создать пользовательский образ, а затем удалить виртуальную машину, — все как один полный конвейер. Обычно каждая задача выполняется по отдельности в вашем конвейере "сборка — тестирование — развертывание".

## <a name="before-you-begin"></a>Перед началом работы
Прежде чем интегрировать конвейер CI/CD с Azure DevTest Labs, необходимо установить расширение из Visual Studio Marketplace.
1. Перейдите на страницу расширения [Задачи Azure DevTest Labs](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).
1. Щелкните **Установить**.
1. Завершите работу мастера.

## <a name="create-a-resource-manager-template"></a>Создание шаблона Resource Manager
В этом разделе описывается создание шаблона Azure Resource Manager, который можно использовать для создания виртуальной машины Azure по запросу.

1. Для создания шаблона Resource Manager в подписке выполните процедуру, описанную в разделе [Использование шаблона Azure Resource Manager виртуальной машины](devtest-lab-use-resource-manager-template.md).
1. Перед созданием шаблона Resource Manager добавьте [артефакт WinRM](https://github.com/Azure/azure-devtestlab/tree/master/Artifacts/windows-winrm) как часть создания виртуальной машины.

   Доступ через WinRM необходим для использования задач по развертыванию, таких как *копирование файлов Azure* и *использование PowerShell на целевых компьютерах*.

   > [!NOTE]
   > При использовании WinRM с общим IP-адресом необходимо добавить правило NAT для сопоставления внешнего порта с портом WinRM. При создании виртуальной машины с общедоступным IP-адресом этот шаг необязателен.
   >
   >

1. Сохраните шаблон в виде файла на компьютере. Назовите файл **CreateVMTemplate.json**.
1. Добавьте шаблон в систему управления версиями.
1. Откройте текстовый редактор и вставьте в него следующий скрипт.

   ```powershell
   Param( [string] $labVmId)

   $labVmComputeId = (Get-AzureRmResource -Id $labVmId).Properties.ComputeId

   # Get lab VM resource group name
   $labVmRgName = (Get-AzureRmResource -Id $labVmComputeId).ResourceGroupName

   # Get the lab VM Name
   $labVmName = (Get-AzureRmResource -Id $labVmId).Name

   # Get lab VM public IP address
   $labVMIpAddress = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName
                   -Name $labVmName).IpAddress

   # Get lab VM FQDN
   $labVMFqdn = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName
              -Name $labVmName).DnsSettings.Fqdn

   # Set a variable labVmRgName to store the lab VM resource group name
   Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName"

   # Set a variable labVMIpAddress to store the lab VM Ip address
   Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress"

   # Set a variable labVMFqdn to store the lab VM FQDN name
   Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn"
   ```

1. Добавьте скрипт в систему управления версиями. Назовите его примерно так: **GetLabVMParams.ps1**.

   Если запустить скрипт в агенте как часть определения выпуска и использовать задачи *копирования файлов Azure* или *использования PowerShell на целевых компьютерах*, скрипт собирает значения, которые необходимы для развертывания приложения на виртуальной машине. Эти задачи обычно применяются для развертывания приложений на виртуальной машине Azure. Для выполнения задач необходимы такие значения, как имя группы ресурсов виртуальной машины, IP-адрес и полное доменное имя (FDQN).

## <a name="create-a-release-definition-in-release-management"></a>Создание определения выпуска в приложении Release Management
Чтобы создать определение выпуска, сделайте следующее:

1. На вкладке **Выпуски** центра **Сборка и выпуск** нажмите кнопку со знаком "плюс" (+).
2. В окне **Создание определения выпуска** выберите шаблон **Пустой**, а затем нажмите кнопку **Далее**.
3. Выберите **Выбрать позже**, а потом щелкните **Создать**, чтобы создать определение выпуска с одной средой по умолчанию без связанных артефактов.
4. Чтобы открыть контекстное меню в новом определении выпуска, нажмите кнопку с многоточием (...) рядом с именем среды, а затем выберите **Настроить переменные**. 
5. В окне **настройки среды** введите следующие значения переменных, используемых в задачах определения выпуска:

   a. В поле **vmName** введите имя, назначенное виртуальной машине при создании шаблона Resource Manager на портале Azure.

   Б. В поле **userName** введите имя пользователя, назначенное виртуальной машине при создании шаблона Resource Manager на портале Azure.

   c. В поле **password** введите пароль, назначенный виртуальной машине при создании шаблона Resource Manager на портале Azure. Используйте значок "замка" для скрытия и защиты пароля.

### <a name="create-a-vm"></a>Создание виртуальной машины

Следующий этап развертывания заключается в создании виртуальной машины, которая будет использоваться в качестве эталонного образа при последующих развертываниях. Вы создадите ее в экземпляре Azure DevTest Lab с помощью задачи, специально разработанной для этой цели. 

1. В определении выпуска выберите **Добавить задачи**.
2. На вкладке **Развертывание** добавьте задачу *Создание виртуальной машины Azure DevTest Labs*. Настройте задачу следующим образом.

   > [!NOTE]
   > Сведения о создании виртуальной машины для последующих развертываний с использованием расширения "Задачи Azure DevTest Labs" см. в [этой статье](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).

   a. В поле **Подписка на AzureRM** выберите подключение в списке **Доступные подключения к службе Azure** или создайте подключение с ограниченными разрешениями к вашей подписке Azure. Дополнительные сведения см. в разделе о [конечной точке службы Azure Resource Manager](https://docs.microsoft.com/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).

   Б. В поле **Имя лаборатории** выберите имя экземпляра, который был создан ранее.

   c. В поле **Имя шаблона** введите полный путь и имя файла шаблона, сохраненного в репозитории исходного кода. Вы можете использовать встроенные свойства Release Management для упрощения пути, например:

   ```
   $(System.DefaultWorkingDirectory)/Contoso/ARMTemplates/CreateVMTemplate.json
   ```

   d. В поле **Параметры шаблона** введите параметры для переменных, определенных в шаблоне. Используйте имена переменных, которые были определены в среде, например:

   ```
   -newVMName '$(vmName)' -userName '$(userName)' -password (ConvertTo-SecureString -String '$(password)' -AsPlainText -Force)
   ```

   д. В качестве **идентификатора лабораторной виртуальной машины в выходных переменных** необходимо указать идентификатор только что созданной виртуальной машины для последующих шагов. Имя переменной среды по умолчанию, которое автоматически заполняется этим идентификатором, устанавливается в разделе **Выходные переменные**. Если необходимо, можно отредактировать эту переменную, но не забудьте использовать правильное имя в последующих задачах. Идентификатор лабораторной виртуальной машины записывается в следующем формате:

   ```
   /subscriptions/{subId}/resourceGroups/{rgName}/providers/Microsoft.DevTestLab/labs/{labName}/virtualMachines/{vmName}
   ```

3. Выполните скрипт, созданный ранее, чтобы собрать подробные сведения о виртуальной машине DevTest Labs. 
4. В определении выпуска выберите **Добавить задачи**, а затем на вкладке **Развертывание** добавьте задачу *Azure PowerShell*. Настройте задачу следующим образом.

   > [!NOTE]
   > Чтобы собрать сведения о виртуальной машине DevTest Labs, перейдите [по этой ссылке для развертывания Azure PowerShell](https://github.com/Microsoft/vsts-tasks/tree/master/Tasks/AzurePowerShell) и выполните скрипт.

   a. В поле **Тип подключения Azure** выберите **Azure Resource Manager**.

   Б. В поле **Подписка на AzureRM** выберите подключение из списка **Доступные подключения к службе Azure** или создайте подключение с ограниченными разрешениями к вашей подписке Azure. Дополнительные сведения см. в разделе о [конечной точке службы Azure Resource Manager](https://docs.microsoft.com/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).

   c. В поле **Тип скрипта** выберите **Файл скрипта**.
 
   d. В поле **Путь к скрипту** введите полный путь и имя скрипта, который был сохранен в репозитории исходного кода. Вы можете использовать встроенные свойства Release Management для упрощения пути, например:
      ```
      $(System.DefaultWorkingDirectory/Contoso/Scripts/GetLabVMParams.ps1
      ```
   д. В поле **Аргументы скрипта** введите имя переменной среды, автоматически заполненной идентификатором лабораторной виртуальной машины в предыдущей задаче, например: 
      ```
      -labVmId '$(labVMId)'
      ```
    Скрипт собирает необходимые значения и сохраняет их в переменных среды в определении выпуска. Таким образом, вы можете легко просмотреть их на последующих шагах.

5. Разверните приложение на новой виртуальной машине DevTest Labs. Обычно для развертывания приложения используются задачи *копирование файлов Azure* и *использование PowerShell на целевых компьютерах*.
   Информация о виртуальной машине, необходимая для параметров этих задач, хранится в трех переменных конфигурации с именами **labVmRgName**, **labVMIpAddress** и **labVMFqdn** в определении выпуска. Если вы только хотите поэкспериментировать с созданием виртуальной машины DevTest Labs и пользовательского образа без развертывания приложения на ней, то этот шаг можно пропустить.

### <a name="create-an-image"></a>Создание образа

Следующий этап заключается в создании образа недавно развернутой виртуальной машины в экземпляре Azure DevTest Labs. Впоследствии образ можно использовать для создания копий виртуальной машины по запросу, когда потребуется выполнить задачу разработки или выполнить некоторые тесты. 

1. В определении выпуска выберите **Добавить задачи**.
2. На вкладке **Развертывание** добавьте задачу **Создание пользовательского образа Azure DevTest Labs**. Настройте его следующим образом.

   > [!NOTE]
   > Сведения о создании образа с использованием расширения "Задачи Azure DevTest Labs" см. в [этой статье](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).

   a. В поле **Подписка на AzureRM** в списке **Доступные подключения к службе Azure** выберите подключение из списка или создайте подключение с ограниченными разрешениями к вашей подписке Azure. Дополнительные сведения см. в разделе о [конечной точке службы Azure Resource Manager](https://docs.microsoft.com/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).

   Б. В поле **Имя лаборатории** выберите имя экземпляра, созданного ранее.

   c. В поле **Custom Image Name** (Имя пользовательского образа) введите имя пользовательского образа.

   d. (Необязательно.) В поле **Описание** введите описание, чтобы облегчить выбор нужного образа позже.

   д. Если вы изменили имя по умолчанию для переменной среды, которая была автоматически заполнена идентификатором лабораторной виртуальной машины в предыдущей задаче, внесите необходимые изменения в поле **идентификатора исходной лабораторной виртуальной машины**. По умолчанию установлено значение **$(labVMId)**.

   f. Для поля **Идентификатор пользовательского образа** в разделе "Выходные переменные" нужен идентификатор только что созданного образа, если вы хотите управлять им или удалить его. Имя переменной среды по умолчанию, для которой автоматически задается этот идентификатор, установлено в разделе **Выходные переменные**. При необходимости можно изменить переменную.

### <a name="delete-the-vm"></a>Удаление виртуальной машины

Последним этапом является удаление виртуальной машины, развернутой в экземпляре Azure DevTest Labs. Обычно после выполнения задач разработки или выполнения тестов на развернутой виртуальной машины ее удаляют. 

1. В определении выпуска выберите **Добавить задачи**, а затем на вкладке **Развертывание** добавьте задачу *Удаление виртуальной машины Azure DevTest Labs*. Настройте его следующим образом.

      > [!NOTE]
      > Сведения об удалении виртуальной машины с использованием расширения "Задачи Azure DevTest Labs" см. в [этой статье](https://marketplace.visualstudio.com/items?itemName=ms-azuredevtestlabs.tasks).

   a. В поле **Подписка на AzureRM** выберите подключение в списке **Доступные подключения к службе Azure** или создайте подключение с ограниченными разрешениями к вашей подписке Azure. Дополнительные сведения см. в разделе о [конечной точке службы Azure Resource Manager](https://docs.microsoft.com/vsts/build-release/concepts/library/service-endpoints#sep-azure-rm).
 
   Б. Если вы изменили имя по умолчанию для переменной среды, которая была автоматически заполнена идентификатором лабораторной виртуальной машины в предыдущей задаче, внесите необходимые изменения в поле **идентификатора лабораторной виртуальной машины**. По умолчанию установлено значение **$(labVMId)**.

2. Введите имя для определения выпуска и сохраните его.
3. Создайте новый выпуск, выбрав последнюю сборку и развернув ее в единую среду в определении.

На каждом этапе обновляйте представление своего экземпляра DevTest Labs на портале Azure, чтобы просмотреть создаваемые виртуальную машину и образ, а также удаляемую виртуальную машину.

Теперь вы можете использовать пользовательский образ для создания виртуальных машин, когда это необходимо.


[!INCLUDE [devtest-lab-try-it-out](../../includes/devtest-lab-try-it-out.md)]

## <a name="next-steps"></a>Дополнительная информация
* Дополнительные сведения см. в статье [Создание сред со множеством виртуальных машин и ресурсов PaaS с помощью шаблонов Azure Resource Manager](devtest-lab-create-environment-from-arm.md).
* Ознакомьтесь с кратким руководством по шаблонам Resource Manager для автоматизации работы в DevTest Labs в [общедоступном репозитории DevTest Labs на сайте GitHub](https://github.com/Azure/azure-quickstart-templates).
* При необходимости перейдите на страницу по [устранению неполадок в VSTS](https://docs.microsoft.com/vsts/build-release/actions/troubleshooting).
 
