---
title: "Общие сведения о поддержке Azure MQTT в Центре Интернета вещей | Документация Майкрософт"
description: "Руководство разработчика: поддержка устройств, подключающихся к конечной точке для устройств Центра Интернета вещей по протоколу MQTT. Содержит сведения о встроенной поддержке MQTT в пакетах SDK для устройств Azure IoT."
services: iot-hub
documentationcenter: .net
author: fsautomata
manager: timlt
editor: 
ms.assetid: 1d71c27c-b466-4a40-b95b-d6550cf85144
ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/11/2017
ms.author: elioda
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f1a3ce746601dc42f04f021f3ba142688abdb7e7
ms.sourcegitcommit: 9c3150e91cc3075141dc2955a01f47040d76048a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/26/2017
---
# <a name="communicate-with-your-iot-hub-using-the-mqtt-protocol"></a>Взаимодействие с Центром Интернета вещей с помощью протокола MQTT

Центр Интернета вещей позволяет устройствам взаимодействовать с конечными точками устройств Центра Интернета вещей с помощью протокола [MQTT версии 3.1.1][lnk-mqtt-org] и порта 8883 или протокола MQTT версии 3.1.1 через WebSocket и порта 443. Для Центра Интернета вещей требуется, чтобы весь обмен данными с устройствами был защищен с помощью протокола TLS/SSL (поэтому Центр Интернета вещей не поддерживает небезопасные подключения через порт 1883).

## <a name="connecting-to-iot-hub"></a>Подключение к центру IoT

Устройство может подключаться к Центру Интернета вещей по протоколу MQTT с помощью библиотек в [пакетах SDK для Azure IoT][lnk-device-sdks] или напрямую с помощью протокола MQTT.

## <a name="using-the-device-sdks"></a>Использование пакетов SDK для устройств

Доступны [пакеты SDK для устройств][lnk-device-sdks], поддерживающие протокол MQTT, для Java, Node.js, C, C# и Python. Для установки подключения к Центру Интернета вещей пакеты SDK для устройств используют стандартную строку подключения к Центру Интернета вещей. Чтобы использовать протокол MQTT, параметр протокола клиента должен быть задан как **MQTT**. По умолчанию пакеты SDK для устройств подключаются к Центру Интернета вещей, если для флага **CleanSession** установлено значение **0**, и используют **качество обслуживания первого уровня** для обмена сообщениями с Центром Интернета вещей.

Когда устройство подключено к Центру Интернета вещей, пакет SDK для устройства предоставляет методы, позволяющие устройству отправлять сообщения в Центр Интернета вещей и получать сообщения из него.

В следующей таблице содержатся ссылки на примеры кода для каждого поддерживаемого языка и указаны параметры, используемые для подключения к центру IoT по протоколу MQTT.

| Язык | Параметр протокола |
| --- | --- |
| [Node.js][lnk-sample-node] |azure-iot-device-mqtt |
| [Java][lnk-sample-java] |IotHubClientProtocol.MQTT |
| [C][lnk-sample-c] |MQTT_Protocol |
| [C#][lnk-sample-csharp] |TransportType.Mqtt |
| [Python][lnk-sample-python] |IoTHubTransportProvider.MQTT |

### <a name="migrating-a-device-app-from-amqp-to-mqtt"></a>Переход от AMQP на MQTT в приложении устройства

При использовании [пакетов SDK для устройств][lnk-device-sdks] для перехода с протокола AMQP на MQTT требуется изменить параметр протокола в инициализации клиента, как указано выше.

При этом обязательно проверьте следующее:

* AMQP возвращает ошибки для многих условий, а MQTT завершает подключение. В результате может потребоваться изменить логику обработки исключений.
* MQTT не поддерживает операции *отклонения* при получении [сообщений из облака на устройство][lnk-messaging]. Если нужно, чтобы серверная часть получала ответы от приложения для устройства, стоит использовать [прямые методы][lnk-methods].

## <a name="using-the-mqtt-protocol-directly"></a>Непосредственное использование протокола MQTT
Если устройство не может использовать пакеты SDK для устройств, оно может подключаться к общедоступным конечным точкам устройства по протоколу MQTT по порту 8883. В пакете **CONNECT** устройство должно использовать следующие значения.

* В поле **Идентификатор клиента** укажите значение **идентификатор устройства**.
* В поле **Имя пользователя** укажите значение `{iothubhostname}/{device_id}/api-version=2016-11-14`, где {iothubhostname} — это полная запись CName Центра Интернета вещей.

    Например, если имя Центра Интернета вещей — **contoso.azure-devices.net**, а имя устройства — **MyDevice01**, то полное поле **Имя пользователя** должно содержать `contoso.azure-devices.net/MyDevice01/api-version=2016-11-14`.
* В поле **Пароль** укажите маркер SAS. Формат маркера SAS аналогичен описанному для протоколов HTTPS и AMQP:<br/>`SharedAccessSignature sig={signature-string}&se={expiry}&sr={URL-encoded-resourceURI}`.

    Дополнительные сведения о способах создания маркеров SAS см. в соответствующем разделе статьи [Управление доступом к Центру Интернета вещей][lnk-sas-tokens].

    При тестировании также можно использовать [обозреватель устройств][lnk-device-explorer] для быстрого создания маркера SAS, который можно скопировать и вставить в собственный код:

  1. Перейдите на вкладку **Управление** в **обозревателе устройств**.
  2. Щелкните **Маркер SAS** (вверху справа).
  3. В разделе **SASTokenForm** выберите свое устройство в раскрывающемся списке **DeviceID**. Задайте значение **срока жизни**.
  4. Щелкните **Создать** , чтобы создать маркер.

     Созданный маркер SAS имеет такую структуру: `HostName={your hub name}.azure-devices.net;DeviceId=javadevice;SharedAccessSignature=SharedAccessSignature sr={your hub name}.azure-devices.net%2Fdevices%2FMyDevice01%2Fapi-version%3D2016-11-14&sig=vSgHBMUG.....Ntg%3d&se=1456481802`.

     Его часть используется в поле **Пароль** для подключения с использованием MQTT: `SharedAccessSignature sr={your hub name}.azure-devices.net%2Fdevices%2FMyDevice01%2Fapi-version%3D2016-11-14&sig=vSgHBMUG.....Ntg%3d&se=1456481802`.

Для пакетов подключения и отключения MQTT Центр Интернета вещей создает событие в канале **мониторинга операций** и предоставляет дополнительные сведения, которые помогут при устранении неполадок с подключением.

### <a name="tlsssl-configuration"></a>конфигурация протокола TLS/SSL

Чтобы напрямую использовать протокол MQTT, ваш клиент *должен* подключиться по протоколу TLS/SSL. Попытки пропустить эту процедуру будут завершаться ошибками соединения.

Чтобы установить соединение TLS, может потребоваться скачать корневой сертификат DigiCert Baltimore и добавить ссылку на него. Этот сертификат используется в Azure для защиты соединения. Его можно найти в [репозитории Azure-iot-sdk-c][lnk-sdk-c-certs]. Дополнительные сведения об этих сертификатах можно найти на [веб-сайте Digicert][lnk-digicert-root-certs].

Пример реализации с помощью версии библиотеки [Paho MQTT][lnk-paho] фонда Eclipse для Python может выглядеть следующим образом.

Сначала установите библиотеку Paho из командной строки:

```
>pip install paho-mqtt
```

Затем запустите клиент в сценарии Python:

```
from paho.mqtt import client as mqtt
import ssl
  
path_to_root_cer = "...local\\path\\to\\digicert.cer"
device_id = "<device id from device registry>"
sas_token = "<generated SAS token>"
subdomain = "<iothub subdomain>"

client = mqtt.Client(client_id=device_id, protocol=mqtt.MQTTv311)

client.username_pw_set(username=subdomain+".azure-devices.net/" + device_id, password=sas_token)

client.tls_set(ca_certs=path_to_root_cert, certfile=None, keyfile=None, cert_reqs=ssl.CERT_REQUIRED, tls_version=ssl.PROTOCOL_TLSv1, ciphers=None)
client.tls_insecure_set(False)

client.connect(subdomain+".azure-devices.net", port=8883)
```


### <a name="sending-device-to-cloud-messages"></a>Отправка сообщений из устройства в облако

После успешного подключения устройство может отправлять сообщения в Центр Интернета вещей, используя `devices/{device_id}/messages/events/` или `devices/{device_id}/messages/events/{property_bag}` в качестве значения параметра **Имя раздела**. Элемент `{property_bag}` позволяет устройству отправлять сообщения с дополнительными свойствами в формате URL-адреса. Например:

```
RFC 2396-encoded(<PropertyName1>)=RFC 2396-encoded(<PropertyValue1>)&RFC 2396-encoded(<PropertyName2>)=RFC 2396-encoded(<PropertyValue2>)…
```

> [!NOTE]
> В этом элементе `{property_bag}` используется та же кодировка, что и для строк запросов в протоколе HTTPS.
>
>

Приложение для устройства может также использовать `devices/{device_id}/messages/events/{property_bag}` в качестве значения параметра **Will topic name** (Будущее имя раздела) для определения *будущих сообщений*, которые будут пересылаться в качестве сообщения телеметрии.

- Центр Интернета вещей не поддерживает сообщения со вторым уровнем качества обслуживания. Если приложение для устройства публикует сообщение со **вторым уровнем качества обслуживания**, то Центр Интернета вещей закрывает сетевое подключение.
- Центр Интернета вещей не сохраняет сообщения retain. Если устройство отправляет сообщение с флагом **RETAIN**, имеющим значение 1, то Центр Интернета вещей добавляет в сообщение свойство приложения **x-opt-retain**. В этом случае Центр Интернета вещей не хранит сообщение retain, а передает его во внутреннее приложение.
- Центр Интернета вещей поддерживает только одно активное подключение MQTT на устройство. Любое новое подключение MQTT от имени того же идентификатора устройства приводит к тому, что Центр Интернета вещей разрывает существующее подключение.

Дополнительные сведения см. в статье [Отправка и получение сообщений в Центре Интернета вещей][lnk-messaging].

### <a name="receiving-cloud-to-device-messages"></a>Получение сообщений из облака на устройство

Для получения сообщений из Центра Интернета вещей устройство должно подписаться с использованием `devices/{device_id}/messages/devicebound/#` в качестве значения параметра **Topic Filter** (Фильтр разделов). Многоуровневый подстановочный знак **#** в параметре Topic Filter (Фильтр разделов) используется только для того, чтобы разрешить устройству получать дополнительные свойства в имени раздела. Центр Интернета вещей не допускает использование подстановочных знаков **#** и **?** для фильтрации вложенных разделов. Поскольку Центр Интернета вещей не является универсальным брокером сообщений на основе шаблона "издатель-подписчик", то он поддерживает только задокументированные имена разделов и фильтры разделов.

Устройство не будет получать сообщения из Центра Интернета вещей, пока не будет успешно подписано на соответствующую конечную точку устройства, представленную фильтром разделов `devices/{device_id}/messages/devicebound/#`. Когда подписка будет выполнена, устройство начнет получать сообщения, переданные из облака на устройство, только с момента подписки. Если устройство подключается с флагом **CleanSession**, имеющим значение **0**, то подписка будет сохраняться в разных сеансах. В этом случае при следующем подключении с флагом **CleanSession 0** устройство получит ожидающие сообщения, которые были отправлены на него, пока оно было отключено. Если устройство использует флаг **CleanSession** со значением **1**, то оно не будет получать сообщения из Центра Интернета вещей, пока не будет подписано на конечную точку устройства.

Центр Интернета вещей передает сообщения с **именем раздела** `devices/{device_id}/messages/devicebound/` или `devices/{device_id}/messages/devicebound/{property_bag}` при наличии свойств сообщения. `{property_bag}` содержит закодированные в формате URL-адреса пары "ключ-значение" свойств сообщения. В контейнер свойств входят только свойства приложений и задаваемые пользователем системные свойства (такие как **messageId** или **correlationId**). Имена системных свойств имеют префикс **$**, свойства приложений используют исходное имя свойства без префикса.

Если приложение для устройства подписывается на раздел со **вторым уровнем качества обслуживания**, то Центр Интернета вещей присваивает пакету **SUBACK** уровень качества обслуживания не выше первого. После этого Центр Интернета вещей доставляет сообщения на устройство, используя первый уровень качества обслуживания.

### <a name="retrieving-a-device-twins-properties"></a>Получение свойств двойника устройства

Сначала устройство подписывается на `$iothub/twin/res/#`, чтобы получать ответы операций. Затем оно отправляет пустое сообщение в раздел `$iothub/twin/GET/?$rid={request id}` с заполненным значением для **request id** (идентификатор запроса). Затем служба отправляет ответное сообщение, содержащее данные двойника устройства в разделе `$iothub/twin/res/{status}/?$rid={request id}`, используя то же значение **request id**, что и в запросе.

Идентификатором запроса может быть любое допустимое значение свойства сообщения, как указано в статье [Отправка и получение сообщений в Центре Интернета вещей][lnk-messaging], а состояние проверяется как целое число.
Текст ответа содержит раздел properties двойника устройства:

Текст записи реестра удостоверений ограничивается компонентом properties, например:

        {
            "properties": {
                "desired": {
                    "telemetrySendFrequency": "5m",
                    "$version": 12
                },
                "reported": {
                    "telemetrySendFrequency": "5m",
                    "batteryLevel": 55,
                    "$version": 123
                }
            }
        }

Возможны следующие коды состояний:

|Состояние | Описание |
| ----- | ----------- |
| 200 | Успешно |
| 429 | Слишком много запросов (регулирование), как указано в статье [Reference - quotas and throttling][lnk-quotas] (Справочные материалы. Квоты и регулирование) |
| 5** | ошибки сервера; |

Дополнительные сведения см. в статье [Двойники устройства][lnk-devguide-twin].

### <a name="update-device-twins-reported-properties"></a>Обновление сообщаемых свойств двойника устройства

Следующая последовательность действий описывает, как устройство обновляет сообщаемые свойства в двойнике устройства в Центре Интернета вещей:

1. Сначала устройство должно подписаться на раздел `$iothub/twin/res/#`, чтобы получать ответы операций из Центра Интернета вещей.

1. Устройство отправляет сообщение, содержащее обновление двойника устройства, в раздел `$iothub/twin/PATCH/properties/reported/?$rid={request id}`. Это сообщение содержит значение **request id** (идентификатор запроса).

1. Затем служба отправляет ответное сообщение, содержащее новое значение ETag для коллекции сообщаемых свойств в разделе `$iothub/twin/res/{status}/?$rid={request id}`. Это ответное сообщение использует то же значение **request id**, что и запрос.

В тексте сообщения запроса содержится документ JSON, который предоставляет новые значения сообщаемых свойств (другие свойства и метаданные не изменяются).
Каждый элемент документа JSON обновляет или добавляет соответствующий компонент в документе двойника устройства. Если элементу задано значение `null`, то этот компонент удаляется из содержащего его объекта. Например:

        {
            "telemetrySendFrequency": "35m",
            "batteryLevel": 60
        }

Возможны следующие коды состояний:

|Состояние | Описание |
| ----- | ----------- |
| 200 | Успешно |
| 400 | Недопустимый запрос. Неправильно сформированный JSON. |
| 429 | Слишком много запросов (регулирование), как указано в статье [Reference - quotas and throttling][lnk-quotas] (Справочные материалы. Квоты и регулирование) |
| 5** | ошибки сервера; |

Дополнительные сведения см. в статье [Двойники устройства][lnk-devguide-twin].

### <a name="receiving-desired-properties-update-notifications"></a>Получение уведомлений об обновлении требуемых свойств

При подключении устройства Центр Интернета вещей отправляет уведомления в раздел `$iothub/twin/PATCH/properties/desired/?$version={new version}`, в котором находится содержимое обновления, выполненного серверной частью решения. Например:

        {
            "telemetrySendFrequency": "5m",
            "route": null
        }

В обновлениях свойств значение `null` означает, что компонент объекта JSON удаляется.


> [!IMPORTANT] 
> Центр Интернета вещей создает уведомления об изменении только в том случае, если устройства подключены. Убедитесь, что выполняется [процедура при повторном подключении устройства][lnk-devguide-twin-reconnection], чтобы требуемые свойства продолжали синхронизироваться между Центром Интернета вещей и приложением для устройства.

Дополнительные сведения см. в статье [Двойники устройства][lnk-devguide-twin].

### <a name="respond-to-a-direct-method"></a>Ответ на прямой метод

Сначала устройство должно подписаться на `$iothub/methods/POST/#`. Центр Интернета вещей отправляет запросы метода в раздел `$iothub/methods/POST/{method name}/?$rid={request id}` с допустимым документом JSON или без текста.

Для ответа устройство отправляет сообщение с допустимым текстом в формат JSON или без текста в раздел `$iothub/methods/res/{status}/?$rid={request id}`, где значение **request id** должно совпадать с соответствующим значением в сообщении запроса, а значение **status** (состояние) — быть целым числом.

Дополнительные сведения см. в статье [Прямые методы][lnk-methods].

### <a name="additional-considerations"></a>Дополнительные замечания

И наконец, если вам необходимо настроить поведение протокола MQTT, то ознакомьтесь с разделом [Поддержка дополнительных протоколов для центра IoT][lnk-azure-protocol-gateway]. В нем описывается, как развернуть высокопроизводительный настраиваемый шлюз протокола, который напрямую взаимодействует с Центром Интернета вещей. Шлюз протокола Azure IoT позволяет настроить протокол устройства для уже существующих развертываний MQTT или других настраиваемых протоколов. Однако при этом подходе необходимо запустить настраиваемый шлюз протокола и управлять им.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о протоколе MQTT см. в [документации по MQTT][lnk-mqtt-docs].

Дополнительные сведения о планировании развертывания центра IoT см. в следующих руководствах:

* [Каталог устройств, сертифицированных по программе Microsoft Azure Certified for IoT][lnk-devices]
* [Поддержка дополнительных протоколов для центра IoT][lnk-protocols]
* [Сравнение центра IoT и концентраторов событий][lnk-compare]
* [Масштабирование центра IoT][lnk-scaling]

Для дальнейшего изучения возможностей центра IoT см. следующие статьи:

* [Руководство разработчика для Центра Интернета вещей][lnk-devguide]
* [Отправка сообщений с устройства в облако с помощью имитации устройства (Linux) с использованием Edge Интернета вещей Azure][lnk-iotedge]

[lnk-device-sdks]: https://github.com/Azure/azure-iot-sdks
[lnk-mqtt-org]: http://mqtt.org/
[lnk-mqtt-docs]: http://mqtt.org/documentation
[lnk-sample-node]: https://github.com/Azure/azure-iot-sdk-node/blob/master/device/samples/simple_sample_device.js
[lnk-sample-java]: https://github.com/Azure/azure-iot-sdk-java/blob/master/device/iot-device-samples/send-receive-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/SendReceive.java
[lnk-sample-c]: https://github.com/Azure/azure-iot-sdk-c/tree/master/iothub_client/samples/iothub_client_sample_mqtt
[lnk-sample-csharp]: https://github.com/Azure/azure-iot-sdk-csharp/tree/master/device/samples
[lnk-sample-python]: https://github.com/Azure/azure-iot-sdk-python/tree/master/device/samples
[lnk-device-explorer]: https://github.com/Azure/azure-iot-sdk-csharp/blob/master/tools/DeviceExplorer
[lnk-sas-tokens]: iot-hub-devguide-security.md#use-sas-tokens-in-a-device-app
[lnk-azure-protocol-gateway]: iot-hub-protocol-gateway.md

[lnk-devices]: https://catalog.azureiotsuite.com/
[lnk-protocols]: iot-hub-protocol-gateway.md
[lnk-compare]: iot-hub-compare-event-hubs.md
[lnk-scaling]: iot-hub-scaling.md
[lnk-devguide]: iot-hub-devguide.md
[lnk-iotedge]: iot-hub-linux-iot-edge-simulated-device.md

[lnk-methods]: iot-hub-devguide-direct-methods.md
[lnk-messaging]: iot-hub-devguide-messaging.md

[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-devguide-twin-reconnection]: iot-hub-devguide-device-twins.md#device-reconnection-flow
[lnk-devguide-twin]: iot-hub-devguide-device-twins.md
[lnk-sdk-c-certs]: https://github.com/Azure/azure-iot-sdk-c/blob/master/certs/certs.c
[lnk-digicert-root-certs]: https://www.digicert.com/digicert-root-certificates.htm
[lnk-paho]: https://pypi.python.org/pypi/paho-mqtt
