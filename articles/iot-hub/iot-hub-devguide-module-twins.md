---
title: Общие сведения о двойниках модулей в Центре Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика. Синхронизация данных состояния и конфигурации Центра Интернета вещей и устройств с помощью двойников модулей.
author: chrissie926
manager: ''
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 04/26/2018
ms.author: menchi
ms.openlocfilehash: 71d762b6f1c199db17058ac107aad7a0b3260ae7
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34633501"
---
# <a name="understand-and-use-module-twins-in-iot-hub"></a>Общие сведения о двойниках модулей и их использование в Центре Интернета вещей

В этой статье предполагается, что вы уже ознакомились с руководством [Общие сведения о двойниках устройств и их использование в Центре Интернета вещей][lnk-devguide-device-twins]. В Центре Интернета вещей для каждого удостоверения устройства можно создать до 20 удостоверений модуля. Каждое удостоверение модуля неявно создает двойник модуля. Аналогично двойникам устройств двойники модулей — это документы JSON, хранящие сведения о состоянии модуля, в том числе метаданные, конфигурации и условия. Центр Интернета вещей Azure сохраняет двойник модуля для каждого модуля, подключаемого к Центру Интернета вещей. 

Со стороны устройства пакеты SDK устройства Центра Интернета вещей позволяют вам создать модули, которые открывают независимое подключение к Центру Интернета вещей. Благодаря этому вы можете использовать отдельные пространства имен для разных компонентов на устройстве. Например, у вас есть торговый автомат с тремя разными датчиками. Каждым датчиком управляют разные отделы вашей компании. Для каждого датчика можно создать модуль. Таким образом, каждый отдел может отправлять задания или прямые методы только датчику, которым они управляют. Это позволит избежать конфликтов и ошибок пользователей.

 Удостоверение и двойник модуля предоставляют те же возможности, что и удостоверение и двойник устройства, но с большей степенью детализации. Благодаря этому совместимые устройства, например устройства на основе операционной системы или устройства со встроенным ПО, которые управляют несколькими компонентами, могут изолировать конфигурацию и условия для каждого из этих компонентов. Удостоверение модуля и двойники модулей позволяют разделить управление вопросами при работе с устройствами Интернета вещей с модульными программными компонентами. Наша цель — предоставить поддержку всем функциям двойников устройств на уровне двойника модуля с помощью общедоступной версии двойника устройств. 

[!INCLUDE [iot-hub-basic](../../includes/iot-hub-basic-whole.md)]

Содержание статьи

* структура двойника модуля: *теги*, *требуемые* и *сообщаемые свойства*;
* операции, которые модули и серверные части могут выполнить на двойнике модуля.

Руководство по использованию сообщаемых свойств, сообщений, отправляемых с устройства в облако, или передаче файла см. в статье [Руководство по обмену данными между устройством и облаком][lnk-d2c-guidance].
Руководство по использованию требуемых свойств, прямых методов или сообщений, отправляемых из облака на устройство, см. в статье [Руководство по обмену данными между облаком и устройством][lnk-c2d-guidance].

## <a name="module-twins"></a>Двойники модулей
Двойники модулей хранят сведения о модулях:

* Модули устройства и Центр Интернета вещей могут использовать их для синхронизации условий и конфигурации модуля.
* Серверная часть решения может использовать их для выполнения запроса и указания длительных операций.

Жизненный цикл двойника модуля связан с соответствующим [удостоверением модуля][lnk-identity]. Двойники модуля неявно создаются и удаляются при создании или удалении удостоверения модуля в Центре Интернета вещей.

Двойник модуля является документом JSON, содержащим следующие компоненты:

* **Теги**. Раздел документа JSON, который может считывать и в который может выполнять запись серверная часть решения. Теги не видны для модулей устройства. Теги задаются для выполнения запросов.
* **Требуемые свойства**. Используются совместно с сообщаемыми свойствами для синхронизации конфигурации или условий модуля. В серверной части решения можно задать нужные свойства, а приложение модуля может считывать их. Приложение модуля может также получать уведомления об изменениях в нужных свойствах.
* **Сообщаемые свойства**. Используется совместно с требуемыми свойствами для синхронизации конфигурации или условий модуля. Приложение модуля может задать сообщаемые свойства, а серверная часть решения может считывать и запрашивать их.
* **Свойства удостоверений модулей**. Корень документа JSON двойника модуля содержит свойства только для чтения из соответствующего удостоверения модуля, хранимые в [реестре удостоверений][lnk-identity].

![][img-module-twin]

Ниже приведен пример документа JSON двойника модуля:

```json
{
    "deviceId": "devA",
    "moduleId": "moduleA",
    "etag": "AAAAAAAAAAc=", 
    "status": "enabled",
    "statusReason": "provisioned",
    "statusUpdateTime": "0001-01-01T00:00:00",
    "connectionState": "connected",
    "lastActivityTime": "2015-02-30T16:24:48.789Z",
    "cloudToDeviceMessageCount": 0, 
    "authenticationType": "sas",
    "x509Thumbprint": {     
        "primaryThumbprint": null, 
        "secondaryThumbprint": null 
    }, 
    "version": 2, 
    "tags": {
        "$etag": "123",
        "deploymentLocation": {
            "building": "43",
            "floor": "1"
        }
    },
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata" : {...},
            "$version": 1
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            }
            "batteryLevel": 55,
            "$metadata" : {...},
            "$version": 4
        }
    }
}
```

В корневом объекте содержатся свойства удостоверения модуля и объекты контейнера для свойств `tags`, `reported` и `desired`. Контейнер `properties` содержит некоторые элементы только для чтения (`$metadata`, `$etag` и `$version`), описанные в разделах [Метаданные двойника модуля][lnk-module-twin-metadata] и [Оптимистичный параллелизм][lnk-concurrency].

### <a name="reported-property-example"></a>Пример сообщаемых свойств
В предыдущем примере двойник модуля содержит свойство `batteryLevel`, сообщаемое приложением модуля. Это свойство позволяет выполнить запрос и работать на модулях на основе последних сообщенных сведений об уровне заряда аккумулятора. Другой пример: приложение модуля сообщает о возможностях и вариантах подключения модуля.

> [!NOTE]
> Сообщаемые свойства упрощают сценарии, в которых серверной части решения нужно последнее известное значение свойства. Используйте [сообщения, отправленные с устройства в облако][lnk-d2c], если серверной части решения нужно обработать данные телеметрии модуля в виде последовательности событий с метками времени, например временные ряды.

### <a name="desired-property-example"></a>Пример требуемого свойства
В предыдущем примере требуемые и сообщаемые свойства двойника модуля `telemetryConfig` используются в серверной части решения и приложении для модуля, чтобы синхронизировать конфигурацию телеметрии для этого модуля. Например: 

1. Серверная часть решения задает требуемое свойство со значением требуемой конфигурации. Ниже приведен фрагмент документа с требуемым заданным свойством:

    ```json
    ...
    "desired": {
        "telemetryConfig": {
            "sendFrequency": "5m"
        },
        ...
    },
    ...
    ```

2. Приложение модуля получает уведомление об изменении немедленно, если оно подключено, или при первом повторном подключении. Затем приложение модуля сообщает об обновленной конфигурации (или об условии ошибки с помощью свойства `status`). Ниже представлена часть сообщаемого свойства.

    ```json
    ...
    "reported": {
        "telemetryConfig": {
            "sendFrequency": "5m",
            "status": "success"
        }
        ...
    }
    ...
    ```

3. Серверная часть решения может отслеживать результаты операции изменения конфигурации на множестве модулей, [отправляя запросы][lnk-query] на двойники модуля.

> [!NOTE]
> Предыдущие фрагменты являются примерами способа кодирования конфигурации модуля и его состояния, оптимизированными для удобства чтения. Центр Интернета вещей не использует специальную схему для требуемых и сообщаемых свойств в двойниках модулей.
> 
> 

## <a name="back-end-operations"></a>Операции серверной части
Серверная часть решения выполняет действия в двойнике модуля с помощью следующих атомарных операций, доступных по протоколу HTTPS:

* **Получение двойника модуля по идентификатору.** Эта операция возвращает документ двойника модуля, включая теги, а также требуемые и сообщаемые системные свойства.
* **Частичное обновление двойника модуля.** Эта операция позволяет серверной части решения частично обновить теги или требуемые свойства двойника модуля. Частичное обновление выражается в качестве документа JSON, который добавляет или обновляет все свойства. Свойства, для которых указано значение `null`, удаляются. Следующий пример создает требуемое свойство со значением `{"newProperty": "newValue"}`, перезаписывает существующее значение `existingProperty` на `"otherNewValue"` и удаляет `otherOldProperty`. Другие существующие требуемые свойства или теги не изменяются:

    ```json
    {
        "properties": {
            "desired": {
                "newProperty": {
                    "nestedProperty": "newValue"
                },
                "existingProperty": "otherNewValue",
                "otherOldProperty": null
            }
        }
    }
    ```

* **Заменить требуемые свойства**. Эта операция позволяет серверной части решения полностью перезаписать все существующие требуемые свойства и заменить новый документ JSON для `properties/desired`.
* **Заменить теги**. Эта операция позволяет серверной части решения полностью перезаписать все существующие теги и заменить новый документ JSON для `tags`.
* **Получение уведомлений двойника**. Эта операция позволяет серверной части решения получать уведомления при изменении двойника. Для этого в решении Интернета вещей необходимо создать маршрут и присвоить источнику данных значение *twinChangeEvents*. По умолчанию уведомления двойника не отправляются, то есть такие маршруты не существуют. Если скорость изменения слишком высока или имеются какие-либо другие причины (например, внутренние сбои), Центр Интернета вещей может отправлять только одно уведомление, которое содержит все изменения. Таким образом, если приложению требуется надежный аудит и регистрация всех промежуточных состояний, следует использовать сообщения, отправляемые с устройства в облако. Уведомление двойника содержит свойства и текст.

    - properties

    | ИМЯ | Значение |
    | --- | --- |
    $content-type | приложение/json |
    $iothub-enqueuedtime |  Время отправки уведомления |
    $iothub-message-source | twinChangeEvents |
    $content-encoding | utf-8 |
    deviceId | Идентификатор устройства |
    moduleId | Идентификатор модуля |
    hubName | Имя центра Интернета вещей |
    operationTimestamp | Метка времени операции по стандарту [ISO8601] |
    iothub-message-schema | deviceLifecycleNotification |
    opType | "replaceTwin" или "updateTwin" |

    Системные свойства сообщений начинаются с символов `'$'`.

    - Текст
        
    Этот раздел содержит все изменения двойника в формате JSON. Он использует тот же формат, что и исправление, с тем отличием, что он может содержать все разделы двойника (теги, properties.reported, properties.desired) и что он содержит элементы "$metadata". Например,

    ```json
    {
        "properties": {
            "desired": {
                "$metadata": {
                    "$lastUpdated": "2016-02-30T16:24:48.789Z"
                },
                "$version": 1
            },
            "reported": {
                "$metadata": {
                    "$lastUpdated": "2016-02-30T16:24:48.789Z"
                },
                "$version": 1
            }
        }
    }
    ```

Все предыдущие операции поддерживают [оптимистичный параллелизм][lnk-concurrency] и требуют разрешения **ServiceConnect**, как указано в статье о [безопасности][lnk-security].

Помимо выполнения этих операций серверная часть решений может:

* отправлять запросы к двойникам модулей с помощью [языка запросов Центра Интернета вещей][lnk-query] типа SQL.

## <a name="module-operations"></a>Операции модуля
Приложение модуля выполняет действия в двойнике модуля с помощью следующих атомарных операций:

* **Получение двойника модуля.** Эта операция возвращает документ двойника (включая теги, а также требуемые и сообщаемые системные свойства) для подключенного модуля.
* **Частично обновить сообщаемые свойства**. Эта операция позволяет частично обновить сообщаемые свойства подключенного модуля. В этой операции используется тот же формат обновления JSON, как и при частичном обновлении требуемых свойств в серверной части решения.
* **Отслеживать требуемые свойства**. Для подключенного модуля можно настроить немедленное получение уведомлений об обновлениях нужного свойства в момент такого обновления. Модуль выполняет такое же обновление (частичное обновление или полная замена), как и при выполнении в серверной части решения.

Все предыдущие операции требуют разрешения **ModuleConnect**, как указано в статье о [безопасности][lnk-security].

[Пакеты SDK для устройств Azure IoT][lnk-sdks] упрощают использование указанных выше операций на многих языках и платформах.

## <a name="tags-and-properties-format"></a>Формат тегов и свойств
Теги, а также требуемые и сообщаемые свойства являются объектами JSON, на которые накладываются следующие ограничения.

* Все ключи в объектах JSON представляют собой 64-байтовые строки Юникода UTF-8 с учетом регистра. Разрешено использовать все знаки, кроме управляющих символов Юникода (сегменты C0 и C1), а также `'.'`, `' '` и `'$'`.
* Все значения в объектах JSON могут быть следующих типов JSON: логический, число, строка и объект. Запрещено использовать массивы. Максимальное значение для целых чисел равно 4 503 599 627 370 495, минимальное значение для целых чисел равно –4 503 599 627 370 496.
* Все объекты JSON в тегах, требуемых и сообщаемых свойствах могут иметь глубину не более 5. Например, допустим следующий объект:

    ```json
    {
        ...
        "tags": {
            "one": {
                "two": {
                    "three": {
                        "four": {
                            "five": {
                                "property": "value"
                            }
                        }
                    }
                }
            }
        },
        ...
    }
    ```

* Все строковые значения могут быть длиной не более 4 КБ.

## <a name="module-twin-size"></a>Размер двойника модуля
Центр Интернета вещей ограничивает размер каждого из соответствующих итоговых значений `tags`, `properties/desired` и `properties/reported` до 8 КБ. Это ограничение не относится к элементам только для чтения.
Размер вычисляется путем подсчета всех знаков, кроме управляющих символов Юникода (сегменты C0 и C1) и пробелов, которые не входят в строковые константы.
Центр Интернета вещей отклоняет с ошибкой все операции, увеличивающие размер этих документов сверх ограничения.

## <a name="module-twin-metadata"></a>Метаданные двойника модуля
Центр Интернета вещей сохраняет метку времени последнего обновления для каждого объекта JSON в требуемых и сообщаемых свойствах двойника модуля. Метки времени указываются в формате UTC и кодируются в формате [ISO8601] (`YYYY-MM-DDTHH:MM:SS.mmmZ`).
Например: 

```json
{
    ...
    "properties": {
        "desired": {
            "telemetryConfig": {
                "sendFrequency": "5m"
            },
            "$metadata": {
                "telemetryConfig": {
                    "sendFrequency": {
                        "$lastUpdated": "2016-03-30T16:24:48.789Z"
                    },
                    "$lastUpdated": "2016-03-30T16:24:48.789Z"
                },
                "$lastUpdated": "2016-03-30T16:24:48.789Z"
            },
            "$version": 23
        },
        "reported": {
            "telemetryConfig": {
                "sendFrequency": "5m",
                "status": "success"
            }
            "batteryLevel": "55%",
            "$metadata": {
                "telemetryConfig": {
                    "sendFrequency": "5m",
                    "status": {
                        "$lastUpdated": "2016-03-31T16:35:48.789Z"
                    },
                    "$lastUpdated": "2016-03-31T16:35:48.789Z"
                }
                "batteryLevel": {
                    "$lastUpdated": "2016-04-01T16:35:48.789Z"
                },
                "$lastUpdated": "2016-04-01T16:24:48.789Z"
            },
            "$version": 123
        }
    }
    ...
}
```

Эти сведения хранятся на каждом уровне (а не только в конечных элементах структуры JSON) для сохранения обновлений, удаляющих ключи объекта.

## <a name="optimistic-concurrency"></a>Оптимистичный параллелизм
Теги, а также требуемые и сообщаемые свойства поддерживают оптимистичный параллелизм.
Теги содержат ETag (согласно [RFC7232]), являющийся представлением JSON тега. ETag можно использовать в операциях условного обновления в серверной части решения, чтобы обеспечить согласованность.

В требуемых и сообщаемых свойствах двойника модуля отсутствует ETag, но они содержат значение `$version`, которое гарантированно будет добавочным. Аналогично ETag для обеспечения согласованности обновлений компонент, выполняющий обновление, использует версию. Например, приложение модуля для сообщаемого свойства или серверная сторона для требуемого свойства.

Версии также полезны, если агент, выполняющий отслеживание (например, приложение модуля, отслеживающее требуемые свойства), должен устранить состояние гонки между результатом извлечения и отправкой уведомлений об обновлении. Дополнительные сведения см. в разделе [Процедура при повторном подключении устройства][lnk-reconnection]. 

## <a name="next-steps"></a>Дополнительная информация
Чтобы применить некоторые основные понятия, описанные в этой статье, просмотрите следующие руководства по Центру Интернета вещей:

* [Приступая к работе с удостоверением Центра Интернета вещей и двойником модуля с использованием резервной копии и устройства .NET][lnk-module-twin-tutorial]

<!-- links and images -->

[lnk-devguide-device-twins]: iot-hub-devguide-device-twins.md
[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-identity]: iot-hub-devguide-identity-registry.md
[lnk-d2c]: iot-hub-devguide-messages-d2c.md
[lnk-methods]: iot-hub-devguide-direct-methods.md
[lnk-security]: iot-hub-devguide-security.md
[lnk-c2d-guidance]: iot-hub-devguide-c2d-guidance.md
[lnk-d2c-guidance]: iot-hub-devguide-d2c-guidance.md
[ISO8601]: https://en.wikipedia.org/wiki/ISO_8601
[RFC7232]: https://tools.ietf.org/html/rfc7232

[lnk-module-twin-tutorial]: iot-hub-csharp-csharp-module-twin-getstarted.md
[lnk-module-twin-metadata]: iot-hub-devguide-module-twins.md#module-twin-metadata
[lnk-concurrency]: iot-hub-devguide-device-twins.md#optimistic-concurrency
[img-module-twin]: media/iot-hub-devguide-device-twins/module-twin.jpg
