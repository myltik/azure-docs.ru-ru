---
title: Общие сведения о реестре удостоверений Центра Интернета вещей Azure | Документация Майкрософт
description: Руководство разработчика. Описание реестра удостоверений Центра Интернета вещей, а также сведения о том, как с его помощью управлять своими устройствами. Содержит сведения об импорте и экспорте удостоверений устройств в пакетном режиме.
author: dominicbetts
manager: timlt
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 01/29/2018
ms.author: dobett
ms.openlocfilehash: 9a3d3d1c93ce0c8bc782a2634eb7be9b95fcf4b4
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34633576"
---
# <a name="understand-the-identity-registry-in-your-iot-hub"></a>Общие сведения о реестре удостоверений в Центре Интернета вещей

В каждом Центре Интернета вещей есть реестр удостоверений, в котором содержатся сведения об устройствах и модулях, имеющих права на подключение к этому Центру Интернета вещей. Перед подключением устройства или модуля к Центру Интернета вещей в реестр удостоверений нужно добавить запись об этом устройстве или модуле. Устройство или модуль также должны пройти аутентификацию в Центре Интернета вещей, то есть предоставить сохраненные в реестре удостоверений учетные данные.

Удостоверения устройств и модулей, хранящиеся в реестре удостоверений, используются с учетом регистра.

На высоком уровне реестр удостоверений является коллекцией с поддержкой REST, состоящей из ресурсов удостоверений устройств и (или) модулей. Добавляя записи в реестр удостоверений, Центр Интернета вещей создает уникальные ресурсы устройства (например, очередь с сообщениями, отправленными из облака на устройство).

Используйте реестр удостоверений для выполнения следующих действий:

* подготовка устройств и модулей, подключаемых к Центру Интернета вещей;
* управление доступом устройств и модулей к конечным точкам центра, доступным с устройства или модуля.

> [!NOTE]
> Реестр удостоверений не содержит метаданные конкретного приложения.

## <a name="identity-registry-operations"></a>операции с реестром удостоверений.

Реестр удостоверений Центра Интернета вещей поддерживает такие операции:

* создание удостоверения устройства или модуля;
* обновление удостоверения устройства или модуля;
* получение удостоверения устройства или модуля по его идентификатору;
* удаление удостоверения устройства или модуля;
* отображение списка, содержащего до 1000 удостоверений;
> Удостоверения модулей и двойники модулей предоставляются в общедоступной предварительной версии. Ниже перечислены функции, которые будут поддерживаться для удостоверений модуля после выхода общедоступной версии:
* экспорт удостоверений устройств в хранилище BLOB-объектов Azure;
* импорт удостоверений устройств из хранилища BLOB-объектов Azure.

Все эти операции могут использовать оптимистичный параллелизм (согласно [RFC7232][lnk-rfc7232]).

> [!IMPORTANT]
> Единственный способ получить все удостоверения, которые содержит реестр удостоверений Центра Интернета вещей, — использовать функцию [Экспорт][lnk-export].

Реестр удостоверений Центра Интернета вещей:

* не содержит метаданные приложения;
* доступен как словарь (в качестве ключа используется свойство **deviceId** или **moduleId**);
* не поддерживает выразительные запросы.

Решение IoT обычно включает в себя отдельное хранилище, содержащее метаданные приложений. Например, в хранилище решения для интеллектуального здания будут записываться данные о комнате, где установлен датчик температуры.

> [!IMPORTANT]
> Реестр удостоверений следует использовать только для управления устройствами и операций подготовки. Выполнение операций в реестре удостоверений не должно влиять на пропускную способность операций в среде выполнения. Например, проверка состояния подключения устройства перед отправкой команды не является поддерживаемым шаблоном. Проверьте [уровни регулирования][lnk-quotas] реестра удостоверений и шаблон [пульса устройств][lnk-guidance-heartbeat].

## <a name="disable-devices"></a>Отключение устройств

Чтобы отключить устройства, обновите в реестре свойство **status** удостоверения. Обычно это свойство используется в двух сценариях.

* В процессе оркестрации подготовки. Дополнительные сведения см. в разделе [Подготовка устройств][lnk-guidance-provisioning].
* Если по какой-либо причине вы решите, что безопасность устройства нарушена или оно является неавторизованным.

Эта функция недоступна для модулей.

## <a name="import-and-export-device-identities"></a>Импорт и экспорт удостоверений устройств

Используя асинхронные операции в [конечной точке поставщика ресурсов Центра Интернета вещей][lnk-endpoints], можно выполнить массовый экспорт удостоверений устройств из реестра удостоверений Центра Интернета вещей. Экспорт — это долгосрочное задание, использующее предоставленный клиентом контейнер больших двоичных объектов, необходимых для сохранения идентификационных данных устройств, прочитанных из реестра удостоверений устройств.

Используя асинхронные операции в [конечной точке поставщика ресурсов Центра Интернета вещей][lnk-endpoints], можно выполнить массовый импорт удостоверений устройств в реестр удостоверений Центра Интернета вещей. Импорт — это долгосрочное задание, использующее данные в предоставленном клиентом контейнере больших двоичных объектов, необходимых для записи идентификационных данных об устройстве в реестр удостоверений.

Дополнительные сведения об интерфейсах API импорта и экспорта см. в статье [Resource Provider APIs][lnk-resource-provider-apis] (Интерфейсы API поставщика ресурсов). Дополнительные сведения о выполнении заданий импорта и экспорта см. в статье [Массовое управление удостоверениями устройств Центра Интернета вещей][lnk-bulk-identity].

## <a name="device-provisioning"></a>Подготовка устройств

Данные устройства, которые хранятся в заданном решении IoT, зависят от конкретных требований этого решения. Но в решении как минимум должны сохраняться удостоверения устройства и ключи проверки подлинности. Центр Интернета вещей Azure имеет реестр удостоверений, который может хранить значения для каждого устройства, например идентификаторы, ключи проверки подлинности и коды состояния. Для хранения любых дополнительных данных устройств решение может использовать другие службы Azure, такие как хранилище таблиц, хранилище BLOB-объектов или Cosmos DB.

*Подготовка устройств* — это процесс добавления исходных данных устройства в хранилища в решении. Чтобы предоставить новому устройству доступ к центру, необходимо добавить идентификатор и ключи устройства в реестр удостоверений Центра Интернета вещей. В рамках процесса подготовки может потребоваться инициализировать данные устройства в других хранилищах решения. Вы можете использовать службу подготовки устройств для Центра Интернета вещей, чтобы настроить автоматическую подготовку JIT для одного или нескольких центров Интернета вещей без вмешательства оператора. Дополнительные сведения см. в [документации по подготовке службы][lnk-dps].

## <a name="device-heartbeat"></a>Пульс устройства

Реестр удостоверений Центра Интернета вещей содержит поле **connectionState**. Поле **connectionState** используется только во время разработки и отладки. Во время выполнения решения Интернета вещей не должны запрашивать это поле. Например, не запрашивайте поле **connectionState**, чтобы проверить подключение устройства, прежде чем отправить сообщение из облака на устройство или SMS.

Если решению Интернета вещей необходимо определять, подключено ли устройство, в него необходимо внедрить *шаблон пульса*.

При использовании шаблона пульса устройство отправляет сообщения с устройства в облака с заданной периодичностью (например не реже, чем каждый час). Если отправка данных при этом не требуется, устройство отправляет с устройства в облака пустое сообщение (обычно содержащее свойство, идентифицирующее его как пульс). На стороне службы решение хранит карту последнего пульса, полученного по каждому устройству, и если решение не получает от устройства сообщение пульса в ожидаемое время, то оно сообщает о проблеме.

Более сложные варианты могут включать в себя данные [мониторинга операций][lnk-devguide-opmon], позволяющие определять, какие устройства пытаются, но не могут установить подключение. Внедряя в решение шаблон пульса, учитывайте [квоты и ограничения Центра Интернета вещей][lnk-quotas].

> [!NOTE]
> Если решение Интернета вещей использует состояние подключения исключительно для того, чтобы определить, отправлять ли сообщения из облака на устройство, и сообщения не вещаются на большие наборы устройств, то следует рассмотреть более простой способ — использовать *небольшой срок действия*. Это позволяет добиться того же результата, что и при обслуживании реестра состояний подключения устройств, действующего по принципу пульса, но с большей эффективностью. При запросе подтверждения сообщений Центр Интернета вещей может сообщить о том, какие устройства могут получать сообщения, а какие не могут.

## <a name="device-and-module-lifecycle-notifications"></a>Уведомления жизненного цикла устройств и модулей

Центр Интернета вещей может уведомлять решение Интернета вещей о создании или удалении удостоверения, отправляя уведомления жизненного цикла. Для этого в решении Интернета вещей необходимо создать маршрут и присвоить источнику данных значение *DeviceLifecycleEvents* или *ModuleLifecycleEvents*. По умолчанию уведомления жизненного цикла не отправляются, то есть такие маршруты не существуют. Уведомление содержит свойства и текст.

Свойства: системные свойства сообщений начинаются с символа `'$'`.

Сообщения уведомлений для устройства.

| ИМЯ | Значение |
| --- | --- |
|$content-type | приложение/json |
|$iothub-enqueuedtime |  Время отправки уведомления |
|$iothub-message-source | deviceLifecycleEvents |
|$content-encoding | utf-8 |
|opType | **createDeviceIdentity** или **deleteDeviceIdentity** |
|hubName | Имя центра Интернета вещей |
|deviceId | Идентификатор устройства |
|operationTimestamp | Отметка времени операции по стандарту ISO8601 |
|iothub-message-schema | deviceLifecycleNotification |

Текст: этот раздел имеет формат JSON и представляет двойник созданного удостоверения устройства. Например,

```json
{
    "deviceId":"11576-ailn-test-0-67333793211",
    "etag":"AAAAAAAAAAE=",
    "properties": {
        "desired": {
            "$metadata": {
                "$lastUpdated": "2016-02-30T16:24:48.789Z"
            },
            "$version": 1
        },
        "reported": {
            "$metadata": {
                "$lastUpdated": "2016-02-30T16:24:48.789Z"
            },
            "$version": 1
        }
    }
}
```
Сообщения уведомлений для модуля.

| ИМЯ | Значение |
| --- | --- |
$content-type | приложение/json |
$iothub-enqueuedtime |  Время отправки уведомления |
$iothub-message-source | moduleLifecycleEvents |
$content-encoding | utf-8 |
opType | **createModuleIdentity** или **deleteModuleIdentity** |
hubName | Имя центра Интернета вещей |
moduleId | Идентификатор модуля |
operationTimestamp | Отметка времени операции по стандарту ISO8601 |
iothub-message-schema | moduleLifecycleNotification |

Текст: этот раздел имеет формат JSON и представляет двойник созданного удостоверения модуля. Например,

```json
{
    "deviceId":"11576-ailn-test-0-67333793211",
    "moduleId":"tempSensor",
    "etag":"AAAAAAAAAAE=",
    "properties": {
        "desired": {
            "$metadata": {
                "$lastUpdated": "2016-02-30T16:24:48.789Z"
            },
            "$version": 1
        },
        "reported": {
            "$metadata": {
                "$lastUpdated": "2016-02-30T16:24:48.789Z"
            },
            "$version": 1
        }
    }
}
```

## <a name="device-identity-properties"></a>Свойства удостоверений устройств

Удостоверения устройств отображаются как JSON-документы с нижеуказанными свойствами.

| Свойство | Параметры | ОПИСАНИЕ |
| --- | --- | --- |
| deviceId |Обязательно, при обновлениях доступно только для чтения |Строка с учетом регистра (длиной до 128 знаков), состоящая из букв и цифр в 7-битовом формате ASCII, а также определенные специальные символы: `- . + % _ # * ? ! ( ) , = @ $ '`. |
| generationId |Обязательно, только для чтения |Созданная Центром Интернета вещей строка с учетом регистра (длиной до 128 знаков). Это значение позволяет различать устройства с одинаковым свойством **deviceId**, которые были удалены, а затем созданы повторно. |
| etag |Обязательно, только для чтения |Строка, выполняющая функцию ненадежного заголовка ETag для удостоверения устройства (согласно [RFC7232][lnk-rfc7232]). |
| auth |необязательный |Составной объект, содержащий сведения об аутентификации и материалы безопасности. |
| auth.symkey |необязательный |Составной объект, содержащий первичный и вторичный ключи, хранящиеся в формате base64. |
| status |обязательно |Индикатор доступа. Доступно два значения: **Включено** или **Отключено**. Если указано значение **Включено**, устройство может подключаться. Если указано значение **Отключено**, устройство не может подключаться ни к одной конечной точке, обращенной к устройству. |
| statusReason |необязательный |Строка длиной 128 знаков, указывающая причину, по которой выбран тот или иной статус удостоверения устройства. Разрешены все символы UTF-8. |
| statusUpdateTime |Только для чтения |Временной индикатор, показывающий дату и время последнего обновления статуса. |
| connectionState |Только для чтения |Поле, отображающее состояние подключения: **Подключено** или **Отключено**. Это поле отображает состояние подключения устройства для Центра Интернета вещей. **Важно!** Используйте это поле только в целях разработки и отладки. Состояние подключения обновляется только для устройств, использующих протокол MQTT или AMQP. Кроме того, оно определяется по запросам проверки связи (по протоколу MQTT или AMQP) и может иметь максимальную задержку равную всего лишь 5 минутам. В связи с этим могут возникать ложно положительные результаты, например, когда отключенные устройства отображаются как подключенные. |
| connectionStateUpdatedTime |Только для чтения |Временной индикатор, показывающий дату и время последнего обновления состояния подключения. |
| lastActivityTime |Только для чтения |Временной индикатор, показывающий дату и время последнего подключения устройства, получения сообщения на устройство и отправки сообщения с него. |

> [!NOTE]
> Статус подключения отображает статус подключения для Центра Интернета вещей. При некоторых состояниях и конфигурациях сети обновления этого состояния могут задерживаться.

## <a name="module-identity-properties"></a>Свойства удостоверений модулей

Удостоверения модулей отображаются как JSON-документы с указанными ниже свойствами:

| Свойство | Параметры | ОПИСАНИЕ |
| --- | --- | --- |
| deviceId |Обязательно, при обновлениях доступно только для чтения |Строка с учетом регистра (длиной до 128 знаков), состоящая из букв и цифр в 7-битовом формате ASCII, а также определенные специальные символы: `- . + % _ # * ? ! ( ) , = @ $ '`. |
| moduleId |Обязательно, при обновлениях доступно только для чтения |Строка с учетом регистра (длиной до 128 знаков), состоящая из букв и цифр в 7-битовом формате ASCII, а также определенные специальные символы: `- . + % _ # * ? ! ( ) , = @ $ '`. |
| generationId |Обязательно, только для чтения |Созданная Центром Интернета вещей строка с учетом регистра (длиной до 128 знаков). Это значение позволяет различать устройства с одинаковым свойством **deviceId**, которые были удалены, а затем созданы повторно. |
| etag |Обязательно, только для чтения |Строка, выполняющая функцию ненадежного заголовка ETag для удостоверения устройства (согласно [RFC7232][lnk-rfc7232]). |
| auth |необязательный |Составной объект, содержащий сведения об аутентификации и материалы безопасности. |
| auth.symkey |необязательный |Составной объект, содержащий первичный и вторичный ключи, хранящиеся в формате base64. |
| status |обязательно |Индикатор доступа. Доступно два значения: **Включено** или **Отключено**. Если указано значение **Включено**, устройство может подключаться. Если указано значение **Отключено**, устройство не может подключаться ни к одной конечной точке, обращенной к устройству. |
| statusReason |необязательный |Строка длиной 128 знаков, указывающая причину, по которой выбран тот или иной статус удостоверения устройства. Разрешены все символы UTF-8. |
| statusUpdateTime |Только для чтения |Временной индикатор, показывающий дату и время последнего обновления статуса. |
| connectionState |Только для чтения |Поле, отображающее состояние подключения: **Подключено** или **Отключено**. Это поле отображает состояние подключения устройства для Центра Интернета вещей. **Важно!** Используйте это поле только в целях разработки и отладки. Состояние подключения обновляется только для устройств, использующих протокол MQTT или AMQP. Кроме того, оно определяется по запросам проверки связи (по протоколу MQTT или AMQP) и может иметь максимальную задержку равную всего лишь 5 минутам. В связи с этим могут возникать ложно положительные результаты, например, когда отключенные устройства отображаются как подключенные. |
| connectionStateUpdatedTime |Только для чтения |Временной индикатор, показывающий дату и время последнего обновления состояния подключения. |
| lastActivityTime |Только для чтения |Временной индикатор, показывающий дату и время последнего подключения устройства, получения сообщения на устройство и отправки сообщения с него. |

## <a name="additional-reference-material"></a>Дополнительные справочные материалы

Другие справочные статьи в руководстве разработчика для Центра Интернета вещей:

* Статья [IoT Hub endpoints][lnk-endpoints] (Конечные точки Центра Интернета вещей) содержит сведения о конечных точках, которые каждый центр Интернета вещей предоставляет для операций управления и среды выполнения.
* Статья [Квоты и регулирование в Центре Интернета вещей][lnk-quotas] содержит сведения о квотах, применимых к службе Центра Интернета вещей, и поведении регулирования.
* В статье [Пакеты SDK для устройств и служб Azure IoT][lnk-sdks] указаны различные языковые пакеты SDK, которые можно использовать при разработке приложений для устройств и служб, взаимодействующих с Центром Интернета вещей.
* В статье [Справочник — язык запросов Центра Интернета вещей для двойников устройств, заданий и маршрутизации сообщений][lnk-query] описывается язык запросов, который можно использовать для получения сведений о двойниках устройств и заданиях из Центра Интернета вещей.
* Статья [Поддержка MQTT в Центре Интернета вещей][lnk-devguide-mqtt] содержит дополнительные сведения о поддержке протокола MQTT в Центре Интернета вещей.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы узнали, как использовать реестр удостоверений Центра Интернета вещей, вас могут заинтересовать следующие статьи в руководстве разработчика для Центра Интернета вещей:

* [Управление доступом к Центру Интернета вещей][lnk-devguide-security]
* [Основные сведения о двойниках устройств (предварительная версия)][lnk-devguide-device-twins]
* [Вызов прямого метода на устройстве (предварительная версия)][lnk-devguide-directmethods]
* [Schedule jobs on multiple devices][lnk-devguide-jobs] (Планирование заданий на нескольких устройствах)

Чтобы применить некоторые основные понятия, описанные в этой статье, просмотрите следующие руководства по Центру Интернета вещей:

* [Приступая к работе с Центром Интернета вещей Azure][lnk-getstarted-tutorial]

Узнайте, как использовать службу подготовки устройств для Центра Интернета вещей, чтобы включить автоматическую подготовку JIT, из следующей статьи: 

* [Служба подготовки устройств для Центра Интернета вещей Azure][lnk-dps]


<!-- Links and images -->

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md
[lnk-resource-provider-apis]: https://docs.microsoft.com/rest/api/iothub/iothubresource
[lnk-guidance-provisioning]: iot-hub-devguide-identity-registry.md#device-provisioning
[lnk-guidance-heartbeat]: iot-hub-devguide-identity-registry.md#device-heartbeat
[lnk-rfc7232]: https://tools.ietf.org/html/rfc7232
[lnk-bulk-identity]: iot-hub-bulk-identity-mgmt.md
[lnk-export]: iot-hub-devguide-identity-registry.md#import-and-export-device-identities
[lnk-devguide-opmon]: iot-hub-operations-monitoring.md

[lnk-devguide-security]: iot-hub-devguide-security.md
[lnk-devguide-device-twins]: iot-hub-devguide-device-twins.md
[lnk-devguide-directmethods]: iot-hub-devguide-direct-methods.md
[lnk-devguide-jobs]: iot-hub-devguide-jobs.md

[lnk-getstarted-tutorial]: iot-hub-csharp-csharp-getstarted.md
[lnk-dps]: https://azure.microsoft.com/documentation/services/iot-dps
