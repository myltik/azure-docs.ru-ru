---
title: Концепции безопасности при использовании сертификата X.509 в Центре Интернета вещей Azure | Документация Майкрософт
description: Сведения о значении сертификатов центра сертификации X.509 при изготовлении устройств Интернета вещей и выполнении их аутентификации.
author: eustacea
manager: arjmands
ms.service: iot-hub
services: iot-hub
ms.topic: conceptual
ms.date: 09/18/2017
ms.author: eustacea
ms.openlocfilehash: 1f7a02f66a8d87f33d7bac9068628dbd29e5bd7c
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34635701"
---
# <a name="conceptual-understanding-of-x509-ca-certificates-in-the-iot-industry"></a>Концептуальное представление о сертификатах ЦС X.509 в отрасли Интернета вещей

В этой статье описывается значение использования сертификатов центра сертификации X.509 при производстве устройств Интернета вещей и аутентификация в Центре Интернета вещей.  Она содержит сведения о настройке цепочки поставок и преимуществах.

Содержание статьи

* Сертификаты ЦС X.509 и способы их получения.
* Регистрация сертификата ЦС X.509 в Центре Интернета вещей.
* Настройка производственной цепочки поставок для аутентификации на основе сертификатов ЦС X.509.
* Подключение к Центру Интернета вещей устройств, подписанных центром сертификации X.509.

## <a name="overview"></a>Обзор

Аутентификация на основе сертификата ЦС X.509 — это способ аутентификации устройств в Центре Интернета вещей с использованием метода, который значительно упрощает создание удостоверения устройства и управление жизненным циклом в цепочке поставок.

Отличительным признаком аутентификации на основе сертификата X.509 является отношение "один ко многим", которое имеет сертификат ЦС с его подчиненными устройствами.  Эта взаимосвязь позволяет регистрировать любое количество устройств в Центре Интернета вещей путем регистрации сертификата ЦС X.509 один раз. В противном случае уникальные сертификаты устройств должны быть предварительно зарегистрированы для каждого устройства до того, как устройство сможет подключиться. Отношение "один ко многим" также упрощает операции управления жизненным циклом сертификатов устройств.

Другим важным атрибутом проверки подлинности ЦС X.509 является упрощенная логистика цепочки поставок.  Для безопасной аутентификации устройств требуется, чтобы каждое устройство имело уникальный секрет, такой как ключ, в качестве основы для доверия. При проверке подлинности на основе сертификатов этим секретом является закрытый ключ. Типичный процесс производства устройств включает в себя несколько этапов и хранителей.  Безопасное управление закрытыми ключами устройства в нескольких хранителях и поддержание доверия является сложным и дорогостоящим.  Использование центров сертификации решает эту проблему за счет подписи каждого хранителя в криптографической цепочке доверия вместо того, чтобы доверять им закрытые ключи устройств.  В свою очередь каждый хранитель подписывает устройства на соответствующем этапе производственного процесса.  Общим результатом является оптимальная цепочка поставок со встроенной подотчетностью благодаря использованию зашифрованной цепочки доверия.  Стоит отметить, что этот процесс обеспечивает максимальную безопасность, когда устройства защищают свои уникальные закрытые ключи.  С этой целью настоятельно рекомендуется использовать аппаратные модули безопасности (HSM), способные создавать собственные ключи, которые остаются конфиденциальными.

В этой статье дается полное представление использования аутентификации на основе сертификата ЦС X.509, от настройки цепочки поставок до подключения устройства, с использованием реального примера для упрощения понимания.

## <a name="introduction"></a>Введение

Сертификат ЦС X.509 — это цифровой сертификат, владелец которого может подписывать другие сертификаты.  Этот цифровой сертификат является сертификатом X.509, так как он соответствует стандарту форматирования сертификатов, предписанному стандартом RFC 5280 IETF, и является сертификатом центра сертификации, поскольку его владелец может подписывать другие сертификаты.

Использование ЦС X.509 проще понять на конкретном примере.  Рассмотрим компанию X, производителя мини-приложений Smart-X-Widget, предназначенных для профессиональной установки. Компания X делегирует процесс производства и установки сторонним производителям.  Она заключает контракт с производителем Y на изготовление Smart-X-Widget и поставщиком услуг Z на установку. Компания X хочет, чтобы мини-приложение Smart-X-Widget напрямую отправлялось из фабрики Y к поставщику Z для установки и чтобы оно напрямую подключалось к экземпляру Центра Интернета вещей компании X после установки без дальнейшего вмешательства компании X. Чтобы решить эту задачу, компания X должна выполнить несколько одноразовых операций настройки для запуска автоматического подключения Smart-X-Widget.  С учетом комплексного сценария остальная часть этой статьи структурирована следующим образом:

* получение сертификата ЦС X.509;

* регистрация сертификата ЦС X.509 в Центре Интернета вещей;

* подпись устройств в цепочке доверия сертификатов;

* подключение устройств.

## <a name="acquire-the-x509-ca-certificate"></a>Получение сертификата ЦС X.509

Компания X имеет возможность приобрести сертификат ЦС X.509 у общедоступного корневого центра сертификации или создать его с помощью процесса самозаверения.  Оптимальный вариант зависит от сценария применения.  Независимо от варианта, процесс предусматривает два основных этапа: создание пары открытого и закрытого ключей и подписание открытого ключа в сертификате.

![img-csr-flow](./media/csr-flow.png)

Подробности выполнения этих шагов отличаются для различных поставщиков услуг.

### <a name="purchasing-an-x509-ca-certificate"></a>Приобретение сертификата ЦС X.509

Приобретение сертификата ЦС имеет преимущество — известный корневой ЦС выступает в качестве доверенной третьей стороны для подтверждения легитимности устройств Центра Интернета вещей при подключении устройств. Компания X выберет этот вариант, если она хочет, чтобы Smart-X-Widget взаимодействовал с продуктами или услугами сторонних производителей после первоначального подключения к Центру Интернета вещей.

Чтобы приобрести сертификат ЦС X.509, компания X выбирает поставщика служб корневых сертификатов. Поиск в Интернете фразы "корневой ЦС" даст сведения о потенциальных поставщиках.  Корневой ЦС поможет компании X создать пару открытого и закрытого ключей и создать запрос на подпись сертификата (CSR) для служб.  CSR является формальным процессом применения сертификата из центра сертификации.  Результатом этой покупки будет сертификат для использования в качестве сертификата центра сертификации.  Учитывая распространенность сертификатов X.509, сертификат, скорее всего, будет правильно отформатирован в соответствии со стандартном RFC 5280 IETF.

### <a name="creating-a-self-signed-x509-ca-certificate"></a>Создание самозаверяющего сертификата ЦС X.509

Процесс создания самозаверяющего сертификата ЦС X.509 аналогичен покупке, за исключением привлечения стороннего подписывающего лица, такого как корневой центр сертификации. В нашем примере компания X подписывает свой сертификат вместо корневого центра сертификации.  Компания может выбрать этот вариант для тестирования, пока не будет готова приобрести сертификат ЦС. Компания X также может использовать самозаверяющий сертификат ЦС X.509 в производстве, если не предполагается подключение Smart-X-Widget к каким-либо сторонним службам за пределами Центра Интернета вещей.

## <a name="register-the-x509-certificate-to-iot-hub"></a>Регистрация сертификата X.509 в Центре Интернета вещей

Компании X необходимо зарегистрировать ЦС X.509 в Центре Интернета вещей, где он будет служить для аутентификации Smart-X-Widget по мере их подключения.  Это однократный процесс, который дает возможность выполнять аутентификацию и управлять любым количеством устройств Smart-X-Widget.  Этот процесс является однократным из-за отношения "один ко многим" между сертификатом ЦС и устройствами. Это также одно из основных преимуществ использования метода проверки подлинности на основе сертификата ЦС X.509.  В качестве альтернативы можно передать отдельные отпечатки сертификатов для каждого устройства Smart-X-Widget, что увеличивает эксплуатационные расходы.

Регистрация сертификата ЦС X.509 — это двухэтапный процесс: передача сертификата и подтверждение владения сертификатом.

![img-pop-flow](./media/pop-flow.png)

### <a name="x509-ca-certificate-upload"></a>Отправка сертификата ЦС X.509

Чтобы отправить сертификат ЦС X.509, необходимо просто передать сертификат ЦС в Центр Интернета вещей.  Центр Интернета вещей ожидает, что сертификат содержится в файле. Компания X просто передает файл сертификата. Файл сертификата не должен ни при каких обстоятельствах содержать закрытые ключи.  Рекомендации согласно стандартам управления инфраструктурой открытых ключей (PKI) предусматривают, чтобы закрытые ключи были известны только в компании X.

### <a name="proof-of-possession-of-the-certificate"></a>Подтверждение владения сертификатом

Сертификат ЦС X.509, как и любой цифровой сертификат, является общедоступной информацией, которая подвержена атакам перехвата информации.  Таким образом, злоумышленник может перехватить сертификат и попытаться передать его как свой собственный.  В нашем примере Центр Интернета вещей хочет удостовериться, что передаваемый сертификат ЦС компании X действительно принадлежит этой компании. Центр Интернета вещей требует, чтобы компания доказала, что она действительно владеет сертификатом, [с помощью потока подтверждения владения](https://tools.ietf.org/html/rfc5280#section-3.1). В процессе подтверждения владения Центр Интернета вещей генерирует случайное число, которое должна подписать компания, используя свой закрытый ключ.  Если компания следует рекомендациям PKI и защищает закрытый ключ, тогда только она сможет пройти проверку подтверждения владения.  Центр Интернета вещей продолжает регистрацию сертификата ЦС X.509, когда проверка подтверждения владения будет успешно пройдена.

После успешного ответа на запрос подтверждения владения от Центра Интернета вещей регистрация сертификата ЦС X.509 завершается.

## <a name="sign-devices-into-a-certificate-chain-of-trust"></a>Подпись устройств в цепочке доверия сертификатов

Для Центра Интернета вещей требуется, чтобы у каждого устройства было уникальное удостоверение.  Эти удостоверения представлены в форме сертификатов для схем проверки подлинности на основе сертификатов.  В нашем примере это означает, что каждый Smart-X-Widget должен обладать уникальным сертификатом устройства.  Как компания X настраивает это в своей цепочке поставок?

Один из способов — предварительно создать сертификаты для Smart-X-Widget и доверить соответствующие уникальные закрытые ключи устройства партнерам по цепочке поставок.  Для компании X это означает, что необходимо доверить ключи фабрике Y и техническому специалисту Z.  Хотя это действующий метод, он имеет ряд проблем, которые необходимо преодолеть, чтобы обеспечить доверие следующим образом:

1. Предоставление закрытых ключей устройств партнерам по цепочке поставок, помимо игнорирования рекомендаций PKI, делает установку доверия в цепочке поставок дорогостоящей.  Это означает, что необходимо установить такие системы, как безопасные комнаты для размещения закрытых ключей устройств, и такие процессы, как периодическая проверка безопасности.  Оба способа увеличивают стоимость цепочки поставок.

2. Надежный учет устройств в цепочке поставок и последующее управление ими при развертывании становится задачей "один к одному" для каждой пары "ключ — устройство" с момента создания уникального сертификата устройства (закрытого ключа) до вывода устройства из эксплуатации. Это исключает возможность группового управления устройствами, если только концепция группы не явно встроена в процесс каким-либо образом. Таким образом, безопасный учет и управление жизненным циклом устройств существенно усложняются.  В нашем примере компания X берет эту нагрузку на себя.

Проверка подлинности на основе сертификатов центра сертификации X.509 предлагает элегантные решения перечисленных проблем благодаря использованию цепочки сертификатов.  Цепочка сертификатов начинается с центра сертификации, подписывающего промежуточный центр сертификации, который, в свою очередь, подписывает еще один промежуточный центр сертификации, и так продолжается до тех пор, пока конечный промежуточный центр сертификации не подпишет устройство.  В нашем примере компания X подписывает фабрику Y, которая, в свою очередь, подписывает специалиста Z, который, наконец, подписывает Smart-X-Widget.

![img-cert-chain-hierarchy](./media/cert-chain-hierarchy.png)

Вышеуказанный каскад сертификатов в цепочке представляет ​​логическую передачу полномочий.  Многие цепочки поставок следуют этой логической передаче, когда каждый промежуточный ЦС подписывается в цепочке при получении всех вышестоящих сертификатов CA, а последний промежуточный ЦС подписывает каждое устройство и вставляет все сертификаты ЦС из цепочки в устройство. Это обычное явление, когда подрядная производственная компания с иерархией фабрик поручает конкретной фабрике изготовлять продукцию.  Хотя иерархия может иметь несколько уровней (например, география/тип продукта/производственная линия), только фабрика в конце получает возможность взаимодействовать с устройством, а цепочка поддерживается с вершины иерархии.

Альтернативные цепочки могут иметь разные промежуточные ЦС, взаимодействующие с устройством, и в этом случае ЦС, взаимодействующий с устройством, внедряет содержимое цепочки сертификатов в этой точке.  Гибридные модели также возможны, когда только некоторые из ЦС физически взаимодействуют с устройством.

В нашем примере фабрика Y и технический специалист Z взаимодействуют со Smart-X-Widget.  Хотя компания X владеет Smart-X-Widget, она физически не взаимодействует с ними во всей цепочке поставок.  Таким образом, цепочка доверия сертификатов Smart-X-Widget включает в себя подпись компанией X фабрики Y, которая, в свою очередь, подписывает технического специалиста Z, который затем предоставляет окончательную подпись для Smart-X-Widget. Производство и установка Smart-X-Widget подразумевает использование подрядчиками Y и Z соответствующих промежуточных сертификатов ЦС для подписывания каждого устройства Smart-X-Widget. Конечным результатом всего этого процесса являются Smart-X-Widget с уникальными сертификатами устройств и цепочкой доверия сертификатов, которая начинается с сертификата ЦС компании.

![img-cert-mfr-chain](./media/cert-mfr-chain.png)

Самое время подытожить значение метода ЦС X.509.  Вместо предварительного создания и передачи сертификатов для каждого Smart-X-Widget в цепочке поставок компания всего лишь один раз подписывает фабрику Y.  Вместо того чтобы отслеживать каждое устройство на протяжении их жизненного цикла, компания X может не отслеживать устройства и не управлять ими с помощью групп, которые, естественно, возникают в процессе цепочки поставок, например устройства, установленные подрядчиком Z после июля определенного года.

Кроме того, метод аутентификации на основе ЦС обеспечивает надежную отчетность в цепочке поставок производства устройств. Из-за цепочки сертификатов действия каждого члена в цепочке криптографически записываются и проверяются.

Этот процесс основан на определенных предположениях, которые должны быть рассмотрены для полноты картины.  Требуется независимое создание уникальной пары открытого и закрытого ключей устройства и защита закрытого ключа внутри устройства.  К счастью, надежные кремниевые чипы в виде HSM способны создавать ключи внутри себя и защищать их.  Компании X нужно добавить одну из таких микросхем в спецификацию компонентов Smart-X-Widget.

## <a name="device-connection"></a>Подключение устройств

В предыдущих разделах описывались этапы от создания до подключения устройства.  Как, однократно зарегистрировав сертификат ЦС X.509 в Центре Интернета вещей, гарантировать подключение множества устройств с прохождением аутентификации с первого раза?  Это можно сделать с помощью процесса передачи сертификатов и подтверждения владения, с которым мы столкнулись ранее при регистрации сертификата ЦС X.509.

Устройства, которые должны пройти аутентификацию ЦС X.509, снабжены уникальными сертификатами устройств и цепочкой сертификатов соответствующей производственной цепочки поставок.  Даже первое подключение устройства происходит в два этапа: передача цепочки сертификатов и подтверждение владения.

Во время передачи цепочки сертификатов устройство отправляет свой уникальный сертификат устройства вместе с установленной на нем цепочкой сертификатов в Центр Интернета вещей.  Используя предварительно зарегистрированный сертификат ЦС X.509, Центр Интернета вещей может криптографически проверить несколько вещей: что переданная цепочка сертификатов внутренне согласована и что цепочка была создана истинным владельцем сертификата ЦС X.509.  Как и процесс регистрации ЦС X.509, Центр Интернета вещей инициирует процесс подтверждения владения, чтобы убедиться, что цепочка и, следовательно, сертификат устройства фактически принадлежат устройству, которое его передает.  Это достигается путем формирования случайных запросов, которые должны быть подписаны устройством с помощью закрытого ключа для проверки в Центре Интернета вещей.   В результате успешного ответа Центр Интернета вещей воспринимает устройство как аутентичное и разрешает ему подключиться.

В нашем примере каждый Smart-X-Widget будет загружать уникальный сертификат своего устройства вместе с сертификатами ЦС X.509 фабрики Y и поставщика Z, а затем проходить процесс подтверждения владения, инициированный Центром Интернета вещей.

![img-device-pop-flow](./media/device-pop-flow.png)

Обратите внимание, что основой доверия является защита закрытых ключей, включая закрытые ключи устройства.  Поэтому важно использовать надежные кремниевые микросхемы в виде модулей HSM для защиты закрытых ключей устройства и следовать рекомендации никогда не давать доступ к закрытым ключам, например, когда одна фабрика поручает другой свой закрытый ключ.

