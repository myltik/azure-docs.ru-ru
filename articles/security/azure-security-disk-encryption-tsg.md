---
title: Устранение неполадок шифрования дисков Azure | Документация Майкрософт
description: В этой статье приведены советы по устранению неполадок в шифровании дисков Microsoft Azure для виртуальных машин IaaS под управлением Windows и Linux.
services: security
documentationcenter: na
author: DevTiw
manager: avibm
editor: barclayn
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 11/21/2017
ms.author: DevTiw
ms.openlocfilehash: 4bc1f7cf64a2a08215cd82d8e72e40eba8db3093
ms.sourcegitcommit: 6cf20e87414dedd0d4f0ae644696151e728633b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/06/2018
ms.locfileid: "34809079"
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a>Руководство по устранению неполадок шифрования дисков Azure

Это руководство предназначено для ИТ-специалистов, аналитиков в сфере информационной безопасности и администраторов облака, организации которых используют шифрование дисков Azure и которым нужно руководство по устранению неполадок, связанных с шифрованием дисков.

## <a name="troubleshooting-linux-os-disk-encryption"></a>Устранение неполадок шифрования диска ОС Linux

Для шифрования диска операционной системы Linux нужно отключить диск операционной системы перед запуском процесса полного шифрования. Если это невозможно, вероятно отобразится сообщение об ошибке "не удалось отключить после...".

Эта ошибка вероятнее всего происходит при попытке шифрования диска ОС в целевой среде виртуальной машины, чей готовый образ из коллекции был изменен или заменен из поддерживаемой коллекции образов. Примеры погрешностей от поддерживаемого образа, который может мешать предоставляемой возможности расширения отключать диск ОС, включая:
- Настроенные образы, несоответствующие поддерживаемой файловой системе или схеме секционирования.
- Большие приложения, такие как SAP, MongoDB, Apache Cassandra или Docker, не поддерживаются, если они устанавливаются и выполняются в ОС перед шифрованием.  Служба шифрования дисков Azure не может безопасно завершить эти процессы (это необходимо сделать при подготовке диска ОС к шифрованию).  Если на диске ОС останутся активные процессы, не позволяющие закрыть дескрипторы файлов, диск ОС будет невозможно отключить, что в свою очередь приведет к сбою шифрования диска ОС. 
- Настраиваемые скрипты, выполняющиеся практически одновременно с включением шифрования или при внесении каких-либо других изменений на виртуальной машине во время процесса шифрования. Это может произойти, если шаблон Azure Resource Manager определяет несколько расширений для одновременного выполнения, или когда настраиваемое расширение скрипта или другое действие выполняются одновременно с шифрованием диска. Сериализация и изоляция таких шагов может помочь решить проблему.
- Если модуль Security Enhanced Linux (SELinux) не был отключен перед включением шифрования, отключение диска завершается ошибкой. SELinux можно будет снова включить после завершения шифрования.
- Диск операционной системы использует схему диспетчера логических томов. При этом доступна ограниченная поддержка диска данных диспетчера логических томов, но диск операционной системы диспетчера логических томов не поддерживается.
- Минимальные требования к памяти не выполняются (для шифрования диска операционной системы рекомендуется 7 ГБ памяти).
- Диски данных рекурсивно подключены в каталоге /mnt/ или любом другом (например, /mnt/data1, /mnt/data2, /data3 + /data3/data4).
- Другие [предварительные требования](https://docs.microsoft.com/azure/security/azure-security-disk-encryption) к шифрованию дисков Azure для ОС Linux не выполнены.

## <a name="unable-to-encrypt"></a>Сбой шифрования

В некоторых случаях шифрование диска зависает на этапе "OS disk encryption started" (Начато шифрование диска ОС) и SSH отключается. При выполнении в готовом образе из коллекции этот процесс может занять от 3 до 16 часов. Если добавляется диск данных объемом в несколько терабайт, процесс может занять несколько дней.

Последовательность шифрования диска операционной системы Linux временно отключает диск операционной системы. Затем выполняется блочное шифрование всего диска операционной системы перед его повторным подключением в зашифрованном состоянии. В отличие от шифрования дисков Azure в Windows во время шифрования диска в Linux нельзя параллельно использовать виртуальную машину. Характеристики производительности виртуальной машины могут существенно повлиять на время, необходимое для завершения шифрования. К таким характеристикам относится размер диска и класс учетной записи хранения ("Стандартный" или "Премиум" (SSD)).

Чтобы проверить состояние, запросите поле **ProgressMessage**, возвращаемое из команды [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus). Во время шифрования диска ОС виртуальная машина входит в состояние обслуживания, а также отключается SSH, чтобы предотвратить нарушение текущего процесса. В процессе шифрования часто появляется сообщение **EncryptionInProgress**. Через несколько часов появляется сообщение **VMRestartPending**, в котором вам будет предложено перезагрузить виртуальную машину. Например: 


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

Для выполнения заключительных действий на целевом объекте необходимо перезагрузить виртуальную машину и подождать 2–3 минуты до завершения перезагрузки. После завершения шифрования сообщение о состоянии изменится. Когда это сообщение появится, предполагается, что зашифрованный диск ОС и виртуальная машина готовы к использованию.

Мы рекомендуем восстановить виртуальную машину с помощью моментального снимка или резервной копии, созданными непосредственно перед шифрованием, в следующих случаях:
   - Если не происходит описанная ранее последовательность перезагрузки.
   - Если в сведениях о загрузке, сообщении о ходе выполнения или других индикаторах ошибки указывается, что во время шифрования ОС произошел сбой. Примером такого сообщения является ошибка сбоя отключения, описанная в этом руководстве.

До следующей попытки необходимо повторно вычислить характеристики виртуальной машины и убедиться, что выполнены все необходимые предварительные требования.

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a>Устранение неполадок шифрования диска Azure в связи с брандмауэром
Если подключение ограничивается брандмауэром, требованиями прокси-сервера или параметрами группы безопасности сети (NGS), способности расширения выполнять необходимые задачи могут быть нарушены. В результате может появиться такое сообщение о состоянии: "Сведения о состоянии расширения недоступны на виртуальной машине". В предполагаемых сценариях может произойти сбой шифрования. В следующих разделах можно ознакомиться с некоторыми распространенными проблемами с брандмауэром.

### <a name="network-security-groups"></a>Группы безопасности сети
Любые применяемые параметры группы безопасности сети должны позволять конечной точке соответствовать предусмотренным [предварительным требованиям](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) к конфигурации сети для шифрования диска.

### <a name="azure-key-vault-behind-a-firewall"></a>Azure Key Vault за брандмауэром
Виртуальная машина должна иметь доступ к хранилищу ключей. Дополнительные сведения о получении доступа к хранилищу ключей за брандмауэром, который поддерживает группа, работающая с Azure Key Vault, см. в статье [Доступ к хранилищу ключей Azure из-за брандмауэра](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall).

### <a name="linux-package-management-behind-a-firewall"></a>Управление пакетами Linux из-за брандмауэра

Во время шифрования диска Azure для Linux используется система управления пакетами целевого дистрибутива, устанавливающая необходимые компоненты перед включением шифрования. Если параметры брандмауэра не позволяют виртуальной машине скачивать и устанавливать эти компоненты, в дальнейшем могут произойти ошибки. Шаги для настройки этого пакета управления системой меняются в зависимости от распространителя. В Red Hat, когда требуется прокси-сервер, необходимо убедиться в правильности настроек диспетчера подписок и yum. Дополнительные сведения см. в статье [How to troubleshoot subscription-manager and yum problems](https://access.redhat.com/solutions/189533) (Устранение неполадок диспетчера подписки и yum).  

## <a name="troubleshooting-windows-server-2016-server-core"></a>Устранение неполадок в основных серверных компонентах Windows Server 2016

По умолчанию компонент bdehdcfg недоступен в основных серверных компонентах Windows Server 2016. Этот компонент требуется для шифрования дисков Azure. Он используется для разбиения системного том и тома операционной системы (выполняется только один раз за все время существования виртуальной машины). Эти двоичные файлы не требуются во время последующих операций шифрования.

Чтобы решить эту проблему, скопируйте указанные ниже 4 файла из виртуальной машины центра обработки данных Windows Server 2016 в то же расположение (основные серверные компоненты):

   ```
   \windows\system32\bdehdcfg.exe
   \windows\system32\bdehdcfglib.dll
   \windows\system32\en-US\bdehdcfglib.dll.mui
   \windows\system32\en-US\bdehdcfg.exe.mui
   ```

   2. Введите следующую команду:

   ```
   bdehdcfg.exe -target default
   ```

   3. С помощью этой команды создается системный раздел на 550 МБ. Перезагрузите систему.

   4. Используйте DiskPart, чтобы проверить тома, а затем продолжайте.  

Например: 

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="troubleshooting-encryption-status"></a>Устранение неполадок с состоянием шифрования

Если ожидаемое состояние шифрования не соответствует данным, отображающимся на портале, см. сведения о поддержке в статье [Состояние шифрования неправильно отображается на портале управления Azure](https://support.microsoft.com/en-us/help/4058377/encryption-status-is-displayed-incorrectly-on-the-azure-management-por)

## <a name="next-steps"></a>Дополнительная информация

В этом документе вы узнали о некоторых распространенных проблемах в шифровании дисков Azure и их устранении. Дополнительные сведения об этой службе и ее возможностях см. в статьях:

- [Шифрование диска в центре безопасности Azure](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [Шифрование виртуальной машины Azure](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [Шифрование неактивных данных в Azure](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)
