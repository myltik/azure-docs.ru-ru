---
title: Локальное профилирование облачной службы в эмуляторе вычислений | Документация Майкрософт
services: cloud-services
description: Анализ проблем производительности в облачных службах с помощью профилировщика Visual Studio
documentationcenter: ''
author: mikejo
manager: douge
editor: ''
tags: ''
ms.assetid: 25e40bf3-eea0-4b0b-9f4a-91ffe797f6c3
ms.service: cloud-services
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: multiple
ms.topic: article
ms.date: 11/18/2016
ms.author: mikejo
ms.openlocfilehash: 8ff7b88a3086488ab669288687c274237ca30b47
ms.sourcegitcommit: 34e0b4a7427f9d2a74164a18c3063c8be967b194
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2018
ms.locfileid: "30284563"
---
# <a name="testing-the-performance-of-a-cloud-service-locally-in-the-azure-compute-emulator-using-the-visual-studio-profiler"></a>Локальное тестирование производительности облачной службы в эмуляторе вычислений Azure с помощью профилировщика Visual Studio
Для тестирования производительности облачных служб доступны разнообразные средства и методы.
При публикации облачной службы в Azure вы можете собрать в Visual Studio данные профилирования и затем проанализировать их локально, как описывается в разделе о [профилировании приложения Azure][1].
Кроме того, с помощью системы диагностики можно отслеживать различные счетчики производительности, как описывается в статье [Создание и использование счетчиков производительности в приложении Azure][2].
Также может возникнуть необходимость выполнить профилирование приложения локально в эмуляторе вычислений перед развертыванием его в облаке.

В этой статье рассматривается метод профилирования "Выборка ЦП", который может осуществляться локально в эмуляторе. Выборка из ЦП — это метод профилирования, который не сильно влияет на работу среды. С указанным интервалом выборки профилировщик делает снимок стека вызовов. Данные собираются за период времени и отображаются в отчете. Данный метод профилирования с высокой вероятностью указывает, где в приложении с интенсивными вычислениями затрачивается большая часть ресурсов ЦП.  Это дает возможность сосредоточиться на "критическом пути", где приложение тратит большую часть времени.

## <a name="1-configure-visual-studio-for-profiling"></a>1. Настройка Visual Studio для профилирования
Во-первых, есть несколько параметров настройки Visual Studio, которые могут быть полезны при выполнении профилирования. Для работы с отчетами профилирования потребуются символы (PDB-файлы) для вашего приложения, а также символы для системных библиотек. Потребуется убедиться, что указаны доступные серверы символов. Для этого в меню **Средства** в Visual Studio выберите **Параметры**, а затем **Отладка** и **Символы**. Убедитесь, что в **Местоположение файла символов (PDB)** указаны серверы символов корпорации Майкрософт.  Можно также указать ссылку http://referencesource.microsoft.com/symbols, которая может обеспечить дополнительные файлы символов.

![Параметры "Символ"][4]

При желании можно упростить создаваемые профилировщиком отчеты, установив флажок "Только мой код". При включенном параметре "Только мой код" стеки вызова функции упрощаются благодаря скрытию в отчетах вызовов в пределах библиотек и платформы .NET Framework. В меню **Средства** выберите **Параметры**. Затем разверните узел **Средства производительности** и выберите команду **Общие**. Установите флажок **Включить только мой код для отчетов профилировщика**.

![Параметры "Только мой код"][17]

Эти инструкции можно использовать как для нового, так и для существующего проекта.  Создавая новый проект для методов, описанных ниже, выберите проект **Облачная служба Azure** на C# и выберите **Веб-роль** и **Роль рабочего процесса**.

![Роли проекта облачной службы Azure][5]

Для целей примера добавьте в проект код, выполнение которого занимает много времени и демонстрирует очевидные проблемы с производительностью. Например, добавьте в проект роли рабочего процесса следующий код:

```csharp
public class Concatenator
{
    public static string Concatenate(int number)
    {
        int count;
        string s = "";
        for (count = 0; count < number; count++)
        {
            s += "\n" + count.ToString();
        }
        return s;
    }
}
```

Вызовите этот код из метода RunAsync класса, производного от рабочей роли RoleEntryPoint. (Игнорируйте предупреждение о том, что метод выполняется синхронно.)

```csharp
private async Task RunAsync(CancellationToken cancellationToken)
{
    // TODO: Replace the following with your own logic.
    while (!cancellationToken.IsCancellationRequested)
    {
        Trace.TraceInformation("Working");
        Concatenator.Concatenate(10000);
    }
}
```

Выполните сборку и запуск облачной службы локально без отладки (Ctrl + F5) и с установленным в конфигурации решения параметром **Выпуск**. Это гарантирует, что все файлы и папки будут созданы для локального запуска приложения, а также гарантирует, что запущены все эмуляторы. Из панели задач запустите пользовательский интерфейс эмулятора вычислений, чтобы проверить, запускается ли рабочая роль.

## <a name="2-attach-to-a-process"></a>2. Присоединение к процессу
Вместо профилирования приложения с помощью его запуска в интегрированной среде разработки Visual Studio 2010 необходимо присоединить профилировщик к выполняющемуся процессу. 

Чтобы присоединить профилировщик к процессу, в меню **Анализ** выберите **Профилировщик**, а затем — **Присоединить/отсоединить**.

![Параметр "Присоединить профиль"][6]

Для роли рабочего процесса найдите процесс WaWorkerHost.exe.

![Процесс WaWorkerHost][7]

Если папка проекта находится на сетевом диске, профилировщик попросит указать другое расположение для сохранения отчетов профилирования.

 Можно также присоединиться к веб-роли путем присоединения к WaIISHost.exe.
При наличии в приложении нескольких процессов роли рабочего процесса они идентифицируются по значению processID. Запрос processID можно выполнить в программе путем обращения к объекту Process. Например, если вы добавите этот код в метод Run класса, производного от RoleEntryPoint в роли, вы сможете просмотреть журнал в пользовательском интерфейсе эмулятора вычислений, чтобы узнать, к какому процессу подключиться.

```csharp
var process = System.Diagnostics.Process.GetCurrentProcess();
var message = String.Format("Process ID: {0}", process.Id);
Trace.WriteLine(message, "Information");
```

Чтобы просмотреть журнал, запустите пользовательский интерфейс эмулятора вычислений.

![Запуск пользовательского интерфейса эмулятора вычислений][8]

Откройте окно консоли журнала роли рабочего процесса в пользовательском интерфейсе эмулятора вычислений, щелкнув строку заголовка окна консоли. Идентификатор процесса можно найти в журнале.

![Просмотр идентификатора процесса][9]

После подсоединения выполните действия в пользовательском интерфейсе приложения (при необходимости), чтобы воспроизвести сценарий.

Чтобы остановить профилирование, щелкните ссылку **Остановить профилирование** .

![Параметр "Остановить профилирование"][10]

## <a name="3-view-performance-reports"></a>3. Просмотр отчетов о производительности
Отображается отчет о производительности приложения.

На этом этапе профилировщик останавливает выполнение, сохраняет данные в VSP-файл и выводит отчет, показывающий анализ этих данных.

![Отчет профилировщика][11]

Если в критическом пути отображается String.wstrcpy, щелкните "Только мой код", чтобы переключиться в представление с отображением только пользовательского кода.  Если отображается String.Concat, попробуйте нажать кнопку "Показать весь код".

Вы увидите, что метод Concatenate и String.Concat занимают большую часть времени выполнения.

![Анализ отчета][12]

При добавлении кода сцепления строк в этой статье вы должны увидеть соответствующее предупреждение в окне "Список задач". Также вы можете увидеть предупреждение об избыточном объеме сбора мусора, что связано с числом создаваемых и подлежащих уничтожению строк.

![Предупреждения о производительности][14]

## <a name="4-make-changes-and-compare-performance"></a>4. Внесение изменений и сравнение производительности
Можно также сравнить производительность до и после изменения кода.  Остановите выполняемый процесс и измените код таким образом, чтобы заменить операцию сцепления строк с помощью класса StringBuilder:

```csharp
public static string Concatenate(int number)
{
    int count;
    System.Text.StringBuilder builder = new System.Text.StringBuilder("");
    for (count = 0; count < number; count++)
    {
        builder.Append("\n" + count.ToString());
    }
    return builder.ToString();
}
```

Выполните еще один прогон, а затем сравните производительность. В обозревателе производительности, если прогоны находятся в одном сеансе, достаточно выбрать оба отчета, открыть контекстное меню и нажать кнопку **Сравнить отчеты о производительности**. Если нужно выполнить сравнение с прогоном, находящимся в другом сеансе проверки производительности, откройте меню **Анализ** и выберите **Сравнить отчеты о производительности**. В открывшемся диалоговом окне укажите оба файла.

![Параметр "Сравнить отчеты о производительности"][15]

В отчетах выделены различия между двумя прогонами.

![Сравнительный отчет][16]

Поздравляем! Работа с профилировщиком начата.

## <a name="troubleshooting"></a>Устранение неполадок
* Убедитесь, что выполняется профилирование сборки для выпуска, и запустите без отладки.
* Если параметр "Присоединить/отсоединить" в меню профилировщика не включен, запустите мастер производительности.
* С помощью пользовательского интерфейса эмулятора вычислений просмотрите состояние приложения. 
* В случае возникновения неполадок с запуском приложения в эмуляторе или присоединением профилировщика завершите работу эмулятора вычислений и перезапустите его. Если неполадка не будет устранена, попробуйте перезагрузить компьютер. Это может происходить, если эмулятор вычислений используется для приостановки и удаления развертываний.
* При использовании команд профилирования из командной строки, особенно глобальных параметров, убедитесь, что вызван VSPerfClrEnv /globaloff и завершена работа VsPerfMon.exe.
* Если в ходе выборки будет выведено сообщение "PRF0025: данные не собраны", убедитесь, что в присоединенном процессе есть загрузка ЦП. Приложения, которые не производят вычислений, могут не предоставлять данных для выборки.  Это также может быть связано с завершением процесса до начала сбора данных. Убедитесь, что метод Run для профилируемой роли не завершен.

## <a name="next-steps"></a>Дальнейшие действия
Инструментирование двоичных файлов Azure в эмуляторе не поддерживается в профилировщике Visual Studio, но в случае, если нужно проверить распределение памяти, этот параметр можно выбрать при профилировании. Можно также выбрать параллельное профилирование — это поможет выявить затраты времени на конкурирование потоков за блокировку, или профилирование взаимодействия слоев, что поможет отслеживать проблемы с производительностью в ходе обмена данными между слоями приложения, чаще всего между уровнем данных и ролью рабочего процесса.  Можно просмотреть запросы к базе данных, создаваемые приложением, и использовать данные профилирования для повышения эффективности работы с базой данных. Сведения о профилировании межуровневого взаимодействия см. в записи блога [Walkthrough: Using the Tier Interaction Profiler in Visual Studio Team System 2010][3] (Пошаговое руководство. Использование профилировщика межуровневого взаимодействия в Visual Studio Team System 2010).

[1]: http://msdn.microsoft.com/library/azure/hh369930.aspx
[2]: http://msdn.microsoft.com/library/azure/hh411542.aspx
[3]: http://blogs.msdn.com/b/habibh/archive/2009/06/30/walkthrough-using-the-tier-interaction-profiler-in-visual-studio-team-system-2010.aspx
[4]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally09.png
[5]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally10.png
[6]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally02.png
[7]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally05.png
[8]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally010.png
[9]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally07.png
[10]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally06.png
[11]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally03.png
[12]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally011.png
[14]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally04.png 
[15]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally013.png
[16]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally012.png
[17]: ./media/cloud-services-performance-testing-visual-studio-profiler/ProfilingLocally08.png
