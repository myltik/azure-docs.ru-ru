---
title: Сведения о сетевом сопоставлении для репликации виртуальных машин Hyper-V в Azure с помощью Site Recovery | Документация Майкрософт
description: В этой статье описано, как настроить сетевое сопоставление для репликации виртуальных машин Hyper-V, управляемых в облаках VMM, с помощью Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 05/02/2018
ms.author: raynew
ms.openlocfilehash: fa596bf4941ac791fa1bc697399a4591d97ba68f
ms.sourcegitcommit: fc64acba9d9b9784e3662327414e5fe7bd3e972e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2018
ms.locfileid: "34076372"
---
# <a name="prepare-network-mapping-for-hyper-v-vm-replication-to-azure"></a>Подготовка сетевого сопоставления для репликации виртуальных машин Hyper-V в Azure


Из этой статьи вы узнаете, как подготовиться к сопоставлению сети во время репликации виртуальных машин Hyper-V в облако System Center Virtual Machine Manager (VMM) в Azure или на дополнительный сайт с помощью [службы Azure Site Recovery](site-recovery-overview.md).


## <a name="prepare-network-mapping-for-replication-to-azure"></a>Подготовка сетевого сопоставления для репликации в Azure

При репликации в Azure сопоставляются сети виртуальных машин на исходном сервере VMM и целевые виртуальные сети Azure. Это предоставляет следующие возможности:
    -  **Сетевое подключение.** Гарантирует, что реплицированные виртуальные машины Azure будут подключены к сопоставленной сети. Все компьютеры, перешедшие в состояние отказа в одной и той же сети, могут подключиться друг к другу, даже если отработка отказа в рамках разных планов восстановления.
    - **Сетевой шлюз.** Если в целевой сети Azure настроен сетевой шлюз, виртуальные машины смогут подключаться к другим локальным виртуальным машинам.

Сетевое сопоставление работает следующим образом:

- Вы сопоставляете исходную сеть виртуальной машины VMM с виртуальной сетью Azure.
- После отработки отказа виртуальные машины Azure в исходной сети будут подключены к сопоставленной целевой виртуальной сети.
- Новые виртуальные машины, добавленные к исходной сети виртуальных машин, будут подключены к сопоставленной сети Azure после репликации.
- Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины подключается к этой целевой подсети после отработки отказа.
- Если подсети с таким же именем отсутствуют, виртуальная машина подключается к первой подсети в сети.

## <a name="prepare-network-mapping-for-replication-to-a-secondary-site"></a>Подготовка сетевого сопоставления для репликации на дополнительный сайт

При репликации на дополнительный сайт сопоставляются сети виртуальных машин на исходном сервере VMM и сети виртуальных машин на целевом сервере VMM. Это предоставляет следующие возможности:

- **Сетевое подключение.** Подключает виртуальные машине к соответствующей сети после отработки отказа. Реплика виртуальной машины будет подключена к целевой сети, которая сопоставлена с исходной сетью.
- **Оптимальное размещение виртуальной машины.** Оптимально размещает реплику виртуальной машины на серверах узлов Hyper-V. Реплики виртуальных машин будут размещены на узлах, которые имеют доступ к сопоставленным сетям виртуальных машин.
- **Без сетевого сопоставления.** Если не настроить сетевое сопоставление, реплики виртуальных машин не будут подключаться к сетям виртуальных машин после отработки отказа.

Сетевое сопоставление работает следующим образом:

- Сетевое сопоставление можно настроить между сетями виртуальных машин на двух серверах VMM или на одном сервере VMM, если два сайта управляются одним сервером.
- Если сопоставление настроено правильно, а репликация включена, виртуальная машина из основного расположения будет подключена к сети, а ее реплика из целевого расположения будет подключена к сопоставленной с ней сети.
- При выборе целевой сети виртуальных машин во время сетевого сопоставления в Site Recovery отображаются исходные облака VMM, использующие исходную сеть виртуальных машин, а также доступные целевые сети виртуальных машин в целевых облаках, которые используются для защиты.
- Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.

## <a name="example"></a>Пример

Следующий пример иллюстрирует этот механизм. Рассмотрим организацию с двумя филиалами в Нью-Йорке и Чикаго.

**Местоположение.** | **Сервер VMM** | **Сети виртуальных машин** | **Сопоставление**
---|---|---|---
Нью-Йорк | VMM-NewYork| VMNetwork1-NewYork | Сопоставляется с VMNetwork1-Chicago
 |  | VMNetwork2-NewYork | Не сопоставлена
Чикаго | VMM-Chicago| VMNetwork1-Chicago | Сопоставляется с VMNetwork1-NewYork
 | | VMNetwork2-Chicago | Не сопоставлена

В данном примере:

- При создании реплики виртуальной машины для любой виртуальной машины, подключенной к VMNetwork1-NewYork, она будет подключена к VMNetwork1-Chicago.
- Когда создается реплика виртуальной машины для VMNetwork2-NewYork или VMNetwork2-Chicago, она не будет подключена ни к какой сети.

Ниже показано, как настраиваются облака VMM в нашем примере, а также представлены логические сети, связанные с облаками.

### <a name="cloud-protection-settings"></a>Параметры защиты облаков

**Защищенное облако** | **Защита облака** | **Логическая сеть (Нью-Йорк)**  
---|---|---
GoldCloud1 | GoldCloud2 |
SilverCloud1| SilverCloud2 |
GoldCloud2 | <p>Нет данных</p><p></p> | <p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p>
SilverCloud2 | <p>Нет данных</p><p></p> | <p>LogicalNetwork1-NewYork</p><p>LogicalNetwork1-Chicago</p>

### <a name="logical-and-vm-network-settings"></a>Параметры логической сети и сети виртуальных машин

**Местоположение.** | **Логические сети** | **Связанная сеть виртуальных машин**
---|---|---
Нью-Йорк | LogicalNetwork1-NewYork | VMNetwork1-NewYork
Чикаго | LogicalNetwork1-Chicago | VMNetwork1-Chicago
 | LogicalNetwork2Chicago | VMNetwork2-Chicago

### <a name="target-network-settings"></a>Параметры целевой сети

В следующей таблице показаны варианты, доступные при выборе целевой сети виртуальных машин, для этих параметров.

**Выбор** | **Защищенное облако** | **Защита облака** | **Доступная целевая сеть**
---|---|---|---
VMNetwork1-Chicago | SilverCloud1 | SilverCloud2 | Доступна
 | GoldCloud1 | GoldCloud2 | Доступна
VMNetwork2-Chicago | SilverCloud1 | SilverCloud2 | Недоступно
 | GoldCloud1 | GoldCloud2 | Доступна


Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то после отработки отказа реплика виртуальной машины будет подключена к этой целевой подсети. Если нет подсетей с таким же именем, виртуальная машина будет подключена к первой подсети в сети.


### <a name="failback-behavior"></a>Поведение восстановления размещения

Чтобы увидеть, что происходит в случае отработки отказа (обратной репликации), предположим, что VMNetwork1-NewYork сопоставляется с VMNetwork1-Chicago со следующими параметрами.


**Виртуальная машина** | **Подключенная сеть виртуальных машин**
---|---
VM1 | VMNetwork1-Network
VM2 (реплика VM1) | VMNetwork1-Chicago

Приняв эти параметры, рассмотрим, что происходит в нескольких возможных сценариях.

**Сценарий** | **Результат**
---|---
Сетевые свойства VM-2 не изменяются после отработки отказа. | VM-1 остается подключенной к исходной сети.
Сетевые свойства VM-2 изменяются после отработки отказа, и она отключается. | VM-1 отключается.
Сетевые свойства VM-2 изменяются после отработки отказа, и она подключается к VMNetwork2-Chicago. | Если VMNetwork2-Chicago не сопоставлена, VM-1 будет отключена.
Сетевое сопоставление VMNetwork1-Chicago изменяется. | VM-1 будет подключена к сети, сопоставленной с VMNetwork1-Chicago.



## <a name="next-steps"></a>Дополнительная информация

- [Set up IP addressing to connect to a secondary on-premises site after failover](hyper-v-vmm-networking.md) (Настройка назначения IP-адресов для подключения к дополнительному локальному сайту после отработки отказа).
- [Подробнее](concepts-on-premises-to-azure-networking.md) о настройке назначения IP-адресов после отработки отказа в Azure.
