---
title: Планирование ресурсов и масштабирования для репликации из VMware в Azure с помощью Azure Site Recovery | Документы Майкрософт
description: Используйте эту статью, чтобы запланировать ресурсы и масштабирование при репликации виртуальных машин VMware в Azure с помощью Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 02/27/2018
ms.author: rayne
ms.openlocfilehash: dbaf1e29fbf4be8ef9432842b7ea4d6511b21cbb
ms.sourcegitcommit: c765cbd9c379ed00f1e2394374efa8e1915321b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2018
ms.locfileid: "29692204"
---
# <a name="plan-capacity-and-scaling-for-vmware-replication-with-azure-site-recovery"></a>Планирование загрузки и масштабирования для репликации из VMware с помощью Azure Site Recovery

Используйте эту статью, чтобы выяснить, как планировать ресурсы и масштабирование при репликации локальных физических серверов и виртуальных машин VMware в Azure с помощью [Azure Site Recovery](site-recovery-overview.md).

## <a name="how-do-i-start-capacity-planning"></a>С чего начать планирование загрузки?

Соберите сведения о среде репликации, запустив [планировщик ресурсов Azure Site Recovery](https://aka.ms/asr-deployment-planner-doc) для репликации VMware. См. [дополнительные сведения](site-recovery-deployment-planner.md) об этом средстве. Планировщик поможет вам собрать данные о виртуальных машинах (совместимых и несовместимых), дисках на каждой виртуальной машине и обновлениях данных на каждом диске. Инструмент также проверяет соответствие требованиям к пропускной способности сети и инфраструктуре Azure для успешной репликации и тестовой отработки отказа.

## <a name="capacity-considerations"></a>Рекомендации по емкости

**Компонент** | **Дополнительные сведения** |
--- | --- | ---
**Репликация** | **Максимальный объем ежедневно изменяемых данных.** Защищенный компьютер может использовать только один сервер обработки, а объем ежедневно изменяемых данных на одном сервере обработки может составлять не более 2 ТБ. В связи с этим 2 ТБ — максимальный объем ежедневно изменяемых данных, поддерживаемый защищенным компьютером.<br/><br/> **Максимальная пропускная способность.** Реплицированный компьютер может принадлежать одной учетной записи хранения в Azure. Стандартная учетная запись хранения может обрабатывать не более 20 000 запросов в секунду. Мы рекомендуем не превышать количество в 20 000 операций ввода-вывода в секунду на исходном компьютере. Например, если есть исходный компьютер с 5 дисками, на каждом из которых выполняется по 120 операций ввода-вывода в секунду (размером в 8 КБ), то этот показатель не будет превышать ограничение в 500 операций ввода-вывода в секунду на диск в Azure. Число необходимых учетных записей хранения определяется путем деления общего числа операций ввода-вывода для исходного компьютера на 20 000.
**Сервер конфигурации** | Сервер конфигурации должен поддерживать суммарный объем ежедневно изменяемых данных для всех рабочих нагрузок, которые выполняются на защищенных компьютерах. Кроме того, он должен обладать достаточной пропускной способностью для непрерывной репликации данных в службу хранилища Azure.<br/><br/> Мы рекомендуем разместить сервер конфигурации в той же сети и в том же сегменте локальной сети, что и компьютеры, которые необходимо защитить. Его можно разместить и в другой сети при наличии у компьютеров, которые нужно защитить, доступа к этой сети третьего уровня.<br/><br/> В следующем разделе в таблице приведены рекомендации по размерам для сервера конфигурации.
**Сервер обработки** | Первый сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные серверы обработки. <br/><br/> Сервер обработки получает данные репликации с защищенных компьютеров и оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет их в Azure. Сервер обработки должен располагать достаточными ресурсами для выполнения этих задач.<br/><br/> Сервер обработки использует дисковый кэш. Чтобы обеспечить обработку хранящихся изменений данных в случае возникновения узкого места в сети или сбоя, установите отдельный диск кэша объемом 600 ГБ и более.

## <a name="size-recommendations-for-the-configuration-server"></a>Рекомендации по размеру сервера конфигурации

**ЦП** | **Память** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц) | 16 ГБ | 300 ГБ | 500 ГБ или менее | Репликация не более 100 компьютеров
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц) | 18 ГБ | 600 ГБ | От 500 ГБ до 1 ТБ | Репликация от 100 до 150 компьютеров
16 виртуальных ЦП (2 сокета * 8 ядер с частотой 2,5 ГГц) | 32 ГБ | 1 TБ | От 1 ТБ до 2 ТБ | Репликация от 150 до 200 компьютеров
Разверните другой сервер обработки | | | Более 2 ТБ | Разверните дополнительные серверы обработки при репликации более 200 компьютеров или объеме ежедневно изменяемых данных более 2 ТБ.

Описание

* Для каждого исходного компьютера настраивается 3 диска объемом по 100 ГБ каждый.
* Чтобы измерить показатели диска кэша, мы использовали хранилище для тестирования производительности с 8 дисками SAS с частотой вращения шпинделя 10 000 об/мин в конфигурации RAID 10.

## <a name="size-recommendations-for-the-process-server"></a>Рекомендации по размеру сервера обработки

Если необходимо защитить более 200 компьютеров или объем ежедневно изменяемых данных составляет более 2 ТБ, для обработки такой нагрузки репликации можно добавить серверы обработки. Для развертывания можно выполнить следующее.

* Увеличить количество серверов конфигурации. Например, с помощью двух серверов конфигурации можно защитить до 400 компьютеров.
* Добавить дополнительные серверы обработки и использовать их для обработки трафика вместо сервера конфигурации (или вместе с ним).

В таблице ниже описан следующий сценарий.

* Вы не планируете использовать сервер конфигурации в качестве сервера обработки.
* Вы настроили дополнительный сервер обработки.
* Вы настроили для защищенных виртуальных машин дополнительный сервер обработки.
* Для каждого защищенного исходного компьютера настраивается три диска объемом 100 ГБ каждый.

**Сервер конфигурации** | **Дополнительный сервер обработки** | **Размер диска кэша** | **Частота изменения данных** | **Защищенные компьютеры**
--- | --- | --- | --- | ---
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), 16 ГБ памяти | 4 виртуальных ЦП (2 сокета * 2 ядра с частотой 2,5 ГГц), 8 ГБ памяти | 300 ГБ | 250 ГБ или менее | Вы можете реплицировать до 85 компьютеров.
8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), 16 ГБ памяти | 8 виртуальных ЦП (2 сокета * 4 ядра с частотой 2,5 ГГц), 12 ГБ памяти | 600 ГБ | От 250 ГБ до 1 ТБ | Репликация от 85 до 150 компьютеров
12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), 18 ГБ памяти | 12 виртуальных ЦП (2 сокета * 6 ядер с частотой 2,5 ГГц), 24 ГБ памяти | 1 TБ | От 1 ТБ до 2 ТБ | Репликация от 150 до 225 компьютеров

Способ масштабирования серверов будет зависеть от выбора модели увеличения масштаба и развертывания.  Вы можете увеличить масштаб, развернув несколько современных серверов конфигурации и обработки, или выполнить развертывание, развернув несколько серверов с меньшим объемом ресурсов. Например, чтобы защитить 220 компьютеров, можно применить одну из следующих рекомендаций.

* Настроить сервер конфигурации с 12 виртуальными ЦП и памятью объемом 18 ГБ, дополнительный сервер обработки с 12 виртуальными ЦП и памятью объемом 24 ГБ, а также защищенные компьютеры для использования только дополнительного сервера обработки.
* Настроить два сервера конфигурации (8 виртуальных ЦП и 16 ГБ ОЗУ в каждом), два дополнительных сервера обработки (8 виртуальных ЦП в одном и 4 виртуальных ЦП, что позволит обрабатывать 220 (135 + 85) компьютеров) и указать, что защищенные компьютеры должны использовать только дополнительные серверы обработки.


## <a name="control-network-bandwidth"></a>Управление пропускной способностью сети

После того как [планировщик ресурсов](site-recovery-deployment-planner.md) рассчитает пропускную способность, необходимую для репликации (начальной и разностной), вы можете управлять объемом пропускной способности, используемой для репликации. Для этого существует несколько способов:

* **Регулирование пропускной способности**. Трафик VMware, который реплицируется в Azure, проходит через определенный сервер обработки. Пропускную способность можно регулировать на компьютерах, которые служат серверами обработки.
* **Изменение пропускной способности.** Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра:
  * Значение реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\UploadThreadsPerVM** задает количество потоков, используемых для передачи данных диска (для начальной или разностной репликации данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается.
  * Значение **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication\DownloadThreadsPerVM** задает количество потоков, используемых для передачи данных при восстановлении размещения.

### <a name="throttle-bandwidth"></a>Регулирование пропускной способности

1. Откройте оснастку MMC в службе архивации Azure на компьютере, который выступает в качестве сервера обработки. По умолчанию ярлык для службы архивации расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.

    ![Снимок экрана с параметром оснастки MMC в службе архивации Azure для изменения свойств](./media/site-recovery-vmware-to-azure/throttle1.png)
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности канала для операций резервного копирования**. Задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 1023 Мбит/с.

    ![Снимок экрана с диалоговым окном свойства службы архивации Azure](./media/site-recovery-vmware-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) . Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

### <a name="influence-network-bandwidth-for-a-vm"></a>Изменение пропускной способности сети для виртуальной машины

1. В реестре виртуальной машины перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.
   * Чтобы изменить скорость передачи данных при репликации диска, задайте новое значение для раздела **UploadThreadsPerVM** или создайте его, если он еще не существует.
   * Чтобы изменить скорость передачи данных при восстановлении размещения из Azure, задайте новое значение для раздела **DownloadThreadsPerVM**.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.


## <a name="deploy-additional-process-servers"></a>Развертывание дополнительных серверов обработки

Если вы увеличите развертывание так, что количество компьютеров-источников превысит 200 или объем ежедневно изменяемых данных превысит 2 ТБ, для обработки такой нагрузки потребуются дополнительные серверы обработки. Выполните эти инструкции, чтобы настроить сервер обработки. После настройки сервера необходимо перевести исходные компьютеры на его использование.

1. Выберите **Site Recovery servers** (Серверы Site Recovery), щелкните сервер конфигурации и пункт **Сервер обработки**.

    ![Снимок экрана с параметром Site Recovery servers (Серверы Site Recovery) для добавления сервера обработки](./media/site-recovery-vmware-to-azure/migrate-ps1.png)
2. В поле **Тип сервера** щелкните **Process server (on-premises)** (Сервер обработки (локальный)).

    ![Снимок экрана с диалоговым окном "Сервер обработки"](./media/site-recovery-vmware-to-azure/migrate-ps2.png)
3. Скачайте файл единой установки Site Recovery и запустите его, чтобы установить сервер обработки и зарегистрировать его в хранилище.
4. На странице **Перед началом работы** выберите **Add additional process servers to scale out deployment** (Добавить дополнительные серверы обработки для масштабирования развертывания).
5. Завершите работу мастера так же, как и при [настройке](#step-2-set-up-the-source-environment) сервера конфигурации.

    ![Снимок экрана с мастером единой установки Azure Site Recovery](./media/site-recovery-vmware-to-azure/add-ps1.png)
6. На странице **Сведения о сервере конфигурации** укажите IP-адрес сервера конфигурации и парольную фразу. Чтобы получить парольную фразу, выполните на сервере конфигурации команду **<папка_установки_Site_Recovery>\home\sysystems\bin\genpassphrase.exe –n**.

    ![Снимок экрана со страницей сведений о сервере конфигурации](./media/site-recovery-vmware-to-azure/add-ps2.png)

### <a name="migrate-machines-to-use-the-new-process-server"></a>Перенос компьютеров для использования нового сервера обработки
1. В разделе **Параметры** > **Серверы Site Recovery** щелкните сервер конфигурации и разверните список **Серверы обработки**.

    ![Снимок экрана с диалоговым окном "Сервер обработки"](./media/site-recovery-vmware-to-azure/migrate-ps2.png)
2. Щелкните используемый сервер обработки правой кнопкой мыши и выберите **Переключить**.

    ![Снимок экрана с диалоговым окном "Сервер конфигурации"](./media/site-recovery-vmware-to-azure/migrate-ps3.png)
3. В поле **Выбор целевого сервера обработки** выберите новый сервер обработки, который нужно использовать, а затем — виртуальные машины, с которыми он будет работать. Щелкните значок сведений, чтобы получить сведения о сервере. Чтобы помочь принять решение о скачивании, отображается средний объем свободного места, требуемый для репликации каждой выбранной виртуальной машины на новом сервере обработки. Щелкните значок галочки, чтобы начать репликацию на новом сервере обработки.


## <a name="next-steps"></a>Дополнительная информация

Скачайте и запустите [планировщик ресурсов Azure Site Recovery](https://aka.ms/asr-deployment-planner)
