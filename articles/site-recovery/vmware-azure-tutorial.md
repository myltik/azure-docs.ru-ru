---
title: Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware с помощью Azure Site Recovery | Документация Майкрософт
description: Сведения о настройке аварийного восстановления в Azure для локальных виртуальных машин VMware с помощью Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 04/08/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 6c86a98dd819b91608be04f1466dc1e6764ee4b9
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware

В этом руководстве показано, как настроить аварийное восстановление в Azure для локальных виртуальных машин VMware, работающих под управлением Windows. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Ввод источника и целевого объекта репликации.
> * Настройка исходной среды репликации, включая локальные компоненты Azure Site Recovery, и целевой среды репликации.
> * Создание политики репликации.
> * Включение репликации для виртуальных машин.

Это третье руководство в серии. В этом руководстве предполагается, что вы выполнили задачи в предыдущих руководствах:

* [Подготовка Azure.](tutorial-prepare-azure.md) Из этого руководства вы узнаете, как настроить учетную запись хранения Azure и сеть, проверить, предоставляет ли учетная запись Azure нужные разрешения, и создать хранилище служб восстановления.
* [Подготовка локальной среды VMware.](vmware-azure-tutorial-prepare-on-premises.md) С помощью этого руководства вы подготовите учетные записи, чтобы служба Site Recovery могла получить доступ к серверам VMware и обнаружить виртуальные машины, а также при необходимости принудительно установить компонент службы Mobility Service в Site Recovery при включении репликации для виртуальной машины. Кроме того, вы проверите, соответствуют ли ваши серверы и виртуальные машины VMware требованиям Site Recovery.

Перед началом работы полезно [изучить архитектуру](vmware-azure-architecture.md) для сценариев аварийного восстановления.


## <a name="select-a-replication-goal"></a>Выбор цели репликации

1. В разделе **Хранилища служб восстановления** выберите имя хранилища **ContosoVMVault**.
2. В разделе **Приступая к работе** выберите Site Recovery. Затем выберите **Подготовка инфраструктуры**.
3. Выберите **Protection goal** (Цель защиты)  > **Where are your machines located** (Где находятся компьютеры?), а затем — **On-premises** (Локально).
4. В разделе **Куда следует реплицировать компьютеры?** выберите **To Azure** (В Azure).
5. В разделе **Are your machines virtualized** (Ваши компьютеры виртуализированы?) выберите **Yes, with VMware vSphere Hypervisor** (Да, с помощью гипервизора VMware vSphere). Нажмите кнопку **ОК**.

## <a name="set-up-the-source-environment"></a>Настройка исходной среды


Чтобы настроить исходную среду, вам понадобится один высокодоступный локальный компьютер для размещения локальных компонентов Site Recovery. К этим компонентам относится сервер конфигурации и обработки, а также главный целевой сервер.

- Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
- Сервер обработки выступает в качестве шлюза репликации. Он получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования, а затем отправляет эти данные в службу хранилища Azure. Сервер обработки также устанавливает службу Mobility Service на виртуальных машинах, которые требуется реплицировать, и выполняет автоматическое обнаружение локальных виртуальных машин VMware.
- Главный целевой сервер обрабатывает данные репликации при восстановлении размещения с переносом из Azure.

Чтобы настроить сервер конфигурации в качестве высокодоступной виртуальной машины VMware, скачайте подготовленный шаблон Open Virtualization Format (OVF) и импортируйте его в VMware для создания виртуальной машины. После настройки сервера конфигурации зарегистрируйте его в хранилище. После регистрации Site Recovery обнаружит локальные виртуальные машины VMware.

> [!TIP]
> В этом руководстве для создания сервера конфигурации виртуальной машины VMware используется шаблон OVF. Если вам не подходит такой вариант, можно запустить [установку вручную](physical-manage-configuration-server.md). 


### <a name="download-the-vm-template"></a>Скачивание шаблона виртуальной машины

1. В хранилище выберите **Prepare Infrastructure** (Подготовка инфраструктуры)  > **Source** (Источник).
2. В колонке **Подготовка источника** выберите **+ Сервер конфигурации**.
3. В колонке **Add Server** (Добавление сервера) в поле **Server type** (Тип сервера) должно быть указано **Configuration server for VMware** (Сервер конфигурации для VMware).
4. Скачайте шаблон OVF для сервера конфигурации.

  > [!TIP]
  Вы можете скачать последнюю версию шаблона сервера конфигурации непосредственно из [Центра загрузки Майкрософт](https://aka.ms/asrconfigurationserver).

## <a name="import-the-template-in-vmware"></a>Импорт шаблона в VMware

1. Подключитесь к серверу VMware vCenter или узлу vSphere ESXi с помощью клиента VMWare vSphere.
2. В меню **Файл** (File) выберите **Deploy OVF Template** (Развернуть шаблон OVF), чтобы запустить мастер развертывания шаблона OVF. 

     ![Шаблон OVF](./media/vmware-azure-tutorial/vcenter-wizard.png)

3. Укажите расположение скачанного шаблона OVF в разделе **Выбрать источник**.
4. В разделе **Просмотр сведений** выберите **Далее**.
5. Примите значения параметров по умолчанию в разделах **Select name and folder** (Выбор имени и папки) и **Select configuration** (Выбор конфигурации).
6. В разделе **Select storage** (Выбор хранилища), чтобы улучшить производительность, выберите **Thick Provision Eager Zeroed** (Быстрое обнуление плотной подготовки) в области **Select virtual disk format** (Выбор формата виртуального диска).
7. На остальных страницах мастера примите значение параметров по умолчанию.
8. На странице **Ready to complete** (Все готово к выполнению) сделайте следующее:

    * Чтобы настроить виртуальную машину с параметрами по умолчанию, выберите **Power on after deployment** (Включение после развертывания)  > **Finish** (Готово).

    * Если вы хотите добавить дополнительный сетевой интерфейс, снимите флажок **Power on after deployment** (Включение после развертывания). Затем нажмите кнопку **Готово**. По умолчанию шаблон сервера конфигурации развертывается с одним сетевым адаптером. Вы можете добавить дополнительные сетевые адаптеры после развертывания.

## <a name="add-an-additional-adapter"></a>Добавление дополнительного адаптера

Добавлять дополнительный сетевой адаптер к серверу конфигурации необходимо до регистрации сервера в хранилище. Возможность добавления дополнительных адаптеров не поддерживается после регистрации.

1. В списке клиента vSphere щелкните виртуальную машину правой кнопкой мыши и выберите **Edit Settings** (Изменить параметры).
2. В разделе **Hardware** (Оборудование) выберите **Add** > **Ethernet Adapter** (Добавить > Адаптер Ethernet). Затем нажмите кнопку **Далее**.
3. Выберите тип адаптера и сеть. 
4. Чтобы подключить виртуальный сетевой адаптер на включенной виртуальной машине, выберите **Connect at power on** (Подключиться, когда включено). Выберите **Далее** > **Готово**. Нажмите кнопку **ОК**.


## <a name="register-the-configuration-server"></a>Регистрация сервера конфигурации 

1. Из консоли клиента VMWare vSphere включите виртуальную машину.
2. Виртуальная машина загружается в среду установки Windows Server 2016. Примите лицензионное соглашение и введите пароль администратора.
3. После установки войдите в виртуальную машину от имени администратора.
4. При первом входе в систему будет запущено средство конфигурации Azure Site Recovery.
5. Введите имя, которое использовалось для регистрации сервера конфигурации в службе Site Recovery. Затем нажмите кнопку **Далее**.
6. Средство проверяет, может ли виртуальная машина подключиться к Azure. После установки подключения выберите **Sign in** (Вход), чтобы войти в подписку Azure. Учетные данные должны иметь доступ к хранилищу, в котором вы хотите зарегистрировать сервер конфигурации.
7. Средство выполняет некоторые задачи конфигурации, а затем перезагружается.
8. Снова войдите в систему. Мастер управления сервером конфигурации запустится автоматически.

### <a name="configure-settings-and-add-the-vmware-server"></a>Настройка параметров и добавление сервера VMware

1. В мастере управления сервером конфигурации выберите **Setup connectivity** (Настройка подключения) и выберите сетевой адаптер, который будет принимать трафик репликации. Затем нажмите кнопку **Save** (Сохранить). Этот параметр уже нельзя изменить после настройки.
2. В разделе **Select Recovery Services vault** (Выбор хранилища служб восстановления) выберите подписку Azure и соответствующие группу и хранилище ресурсов.
3. В разделе **Install third-party software** (Установка стороннего программного обеспечения) примите лицензионное соглашение. Выберите **Download and Install** (Скачать и установить), чтобы установить сервер MySQL.
4. Выберите **Install VMware PowerLCI** (Установить VMware PowerCLI). Прежде чем это сделать, закройте все окна браузера. Затем выберите **Continue** (Продолжить).
5. Прежде чем вы продолжите, будут проверены предварительные требования в разделе **Validate appliance configuration** (Проверка конфигурации модуля).
6. В разделе **Configure vCenter Server/vSphere ESXi server** (Настройка сервера vCenter Server или vSphere ESXi) введите полное доменное имя или IP-адрес сервера vCenter или узел vSphere, на которых расположены виртуальные машины для репликации. Введите порт, от которого ожидается передача данных на сервер. Введите понятное имя для сервера VMware в хранилище.
7. Введите учетные данные, которые будут использоваться сервером конфигурации для подключения к серверу VMware. Site Recovery использует эти учетные данные для автоматического обнаружения виртуальных машин VMware, доступных для репликации. Выберите **Add** (Добавить), а затем нажмите кнопку **Continue** (Продолжить).
8. В разделе **Configure virtual machine credentials** (Настройка учетных данных виртуальной машины) введите имя пользователя и пароль, которые будут использоваться для автоматической установки службы Mobility Service на компьютерах с включенной репликацией. Для компьютеров Windows учетной записи должны быть предоставлены права локального администратора на компьютерах, которые требуется реплицировать. Для Linux предоставьте сведения для учетной записи root.
9. Выберите **Finalize configuration** (Завершение конфигурации) для завершения регистрации. 
10. По окончании регистрации на портале Azure убедитесь, что сервер конфигурации и VMware указаны на странице **Источник** в хранилище. Затем нажмите кнопку **OK** (ОК), чтобы настроить параметры целевого объекта.


Site Recovery подключается к серверам VMware, используя указанные параметры, и обнаруживает виртуальные машины.

> [!NOTE]
> Имя учетной записи появится на портале через 15 (или больше) минут. Чтобы выполнить обновление немедленно, выберите **Серверы конфигурации** > ***имя сервера*** > **Обновить сервер**.

## <a name="set-up-the-target-environment"></a>Настройка целевой среды

Выберите и проверьте целевые ресурсы.

1. Выберите **Подготовка инфраструктуры** > **Целевой объект**. Выберите подписку Azure, которую нужно использовать.
2. Укажите, какая целевая модель развертывания используется: классическая или модель на основе Azure Resource Manager.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.

   ![Вкладка "Целевой объект"](./media/vmware-azure-tutorial/storage-network.png)

## <a name="create-a-replication-policy"></a>Создание политики репликации

1. Откройте [портал Azure](https://portal.azure.com) и выберите **Все ресурсы**.
2. Выберите хранилище служб восстановления **ContosoVMVault**.
3. Чтобы создать политику репликации, выберите **Site Recovery infrastructure** (Инфраструктура Site Recovery) > **Политики репликации** > **+Replication Policy** (+Политика репликации).
4. На странице **Создать политику репликации** введите имя политики **VMwareRepPolicy**.
5. На странице **Пороговое значение RPO** используйте значение по умолчанию (60 минут). Это значение определяет, как часто создаются точки восстановления. Если непрерывная репликация превышает это значение, выдаются оповещения.
6. В поле **Хранение точки восстановления** используйте значение по умолчанию (24 часа) для продолжительности периода хранения каждой точки восстановления. В рамках этого руководства используется значение 72 часа. Реплицированные виртуальные машины можно восстановить до любой точки в рамках этого периода.
7. В разделе **App-consistent snapshot frequency** (Периодичность создания моментальных снимков) используйте значение по умолчанию (60 минут) для частоты создания согласованных с приложением моментальных снимков. Нажмите кнопку **OK**, чтобы создать политику.

   ![Создание политики репликации](./media/vmware-azure-tutorial/replication-policy.png)

Политика автоматически сопоставляется с сервером конфигурации. Для восстановления размещения по умолчанию автоматически создается соответствующая политика. Например, если политика репликации называется **rep-policy**, то политика восстановления размещения будет называться **rep-policy-failback**. Эта политика не используется, пока не будет запущено восстановление размещения из Azure.

## <a name="enable-replication"></a>Включение репликации

Site Recovery установит службу Mobility Service, если репликация включена для виртуальной машины. Может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

Включите репликацию следующим образом:

1. Выберите **Репликация приложения** > **Источник**.
2. В колонке **Источник** выберите нужный сервер конфигурации.
3. В поле **Тип компьютера** выберите параметр **Виртуальные машины**.
4. В поле **vCenter/vSphere Hypervisor** (Гипервизор vCenter или vSphere) выберите сервер vCenter, который управляет узлом vSphere, или сам узел.
5. Выберите сервер обработки (сервер конфигурации). Нажмите кнопку **ОК**.
6. В разделе **Целевой объект** выберите подписку и группу ресурсов, в которых нужно создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.
7. Выберите учетную запись службы хранения Azure, которую вы хотите использовать для репликации данных.
8. Выберите сеть и подсеть Azure для подключения виртуальных машин Azure, созданных после отработки отказа.
9. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым компьютерам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждого компьютера.
10. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.
11. В разделе **Свойства** > **Configure properties** (Настройка свойств) выберите учетную запись, которая будет использоваться сервером обработки для автоматической установки службы Mobility Service на компьютере.
12. Выберите **Параметры репликации** > **Настройка параметров репликации** и убедитесь, что выбрана правильная политика репликации.
13. Выберите **Включить репликацию**.

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Параметры** > **Задания** > **Задания Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

Для мониторинга добавляемых виртуальных машин укажите последнее время обнаружения, выбрав **Серверы конфигурации** > **Последний контакт в**. Чтобы добавить виртуальные машины, не дожидаясь запланированного обнаружения, выделите сервер конфигурации (не выбирая его) и нажмите кнопку **Обновить**.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Run a disaster recovery drill to Azure](site-recovery-test-failover-to-azure.md) (Выполнение отработки аварийного восстановления в Azure)
