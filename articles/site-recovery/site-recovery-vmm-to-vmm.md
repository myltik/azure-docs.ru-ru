<properties
	pageTitle="Репликация виртуальных машин Hyper-V из облачных сред VMM в дополнительный ЦОД VMM | Microsoft Azure"
	description="В статье описывается репликация виртуальных машин Hyper-V из облачных сред VMM в дополнительный ЦОД VMM с помощью Azure Site Recovery."
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="02/17/2016"
	ms.author="raynew"/>

# Репликация виртуальных машин Hyper-V из облачных сред VMM в дополнительный ЦОД VMM

Служба Azure Site Recovery помогает реализовать стратегии непрерывности бизнес-процессов и аварийного восстановления, управляя процессами репликации, отработки отказа и восстановления виртуальных машин и физических серверов. Виртуальные машины можно реплицировать в Azure или во вторичный локальный центр обработки данных. Краткий обзор см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

## Обзор

В этой статье описывается репликация виртуальных машин Hyper-V на серверах узла Hyper-V, управляемых в частных облаках VMM, в дополнительный ЦОД VMM с помощью Site Recovery.

Эта статья включает перечень необходимых компонентов и инструкции по настройке хранилища Site Recovery, установке поставщика Azure Site Recovery на исходном и целевом серверах VMM, регистрации серверов в хранилище, настройке параметров защиты для облаков VMM и включению защиты для виртуальных машин Hyper-V. В качестве завершения выполните отработку отказа, чтобы убедиться в том, что все работает правильно.

Все комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

## Архитектура

На рисунке ниже показаны различные каналы связи и порты, используемые Azure Site Recovery для оркестрации и репликации.

![Топология E2E](./media/site-recovery-vmm-to-vmm/e2e-topology.png)

## Перед началом работы

Убедитесь, что выполнены следующие предварительные требования.

**Предварительные требования** | **Дополнительные сведения** 
--- | ---
**Таблицы Azure**| Вам потребуется учетная запись [Microsoft Azure](https://azure.microsoft.com/). Начните с [бесплатной пробной версии](https://azure.microsoft.com/pricing/free-trial/). См. [дополнительные сведения](https://azure.microsoft.com/pricing/details/site-recovery/) о ценах на использование Site Recovery. 
**VMM** | Вам потребуется как минимум один сервер VMM.<br/><br/>Сервер VMM должен работать под управлением System Center 2012 SP1 или более поздней версии с последними накопительными пакетами обновления.<br/><br/>Чтобы настроить защиту с одним сервером VMM, вам потребуется как минимум два облака, настроенных на сервере.<br/><br/>При развертывании защиты с двумя серверами VMM для каждого сервера должно быть настроено как минимум одно облако на основном сервере VMM, который необходимо защитить, и одно облако на дополнительном сервере VMM, который вы хотите использовать для защиты и восстановления.<br/><br/>Для всех облаков VMM необходимо задать профиль емкости Hyper-V.<br/><br/>Исходное облако, которое требуется защитить, должно содержать одну или несколько групп узлов VMM.<br/><br/>Дополнительные сведения о настройке облаков VMM см. в [пошаговом руководстве по созданию частных облаков с помощью System Center 2012 SP1 VMM](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) в блоге Кита Майера (Keith Mayer).
**Hyper-V** | Вам потребуется один или несколько серверов узлов Hyper-V в основных и дополнительных группах узлов VMM, а также одна или несколько виртуальных машин на каждом сервере узла Hyper-V.<br/><br/>Серверы узлов и целевые серверы Hyper-V должны работать под управлением Windows Server 2012 (или более поздней версии) с ролью Hyper-V, и на них должны быть установлены последние пакеты обновлений.<br/><br/>Все серверы Hyper-V, содержащие виртуальные машины, которые необходимо защитить, должны быть расположены в облаке VMM.<br/><br/>Если Hyper-V выполняется в кластере, учтите, что брокер кластера не создается автоматически при наличии кластера на основе статических IP-адресов. Вам потребуется настроить брокер кластера вручную. См. [дополнительные сведения](https://www.petri.com/use-hyper-v-replica-broker-prepare-host-clusters) в записи блога Айдана Финна (Aidan Finn).
**Сетевое сопоставление** | Вы можете настроить сетевое сопоставление, чтобы оптимально разместить реплики виртуальных машин на дополнительных серверах узла Hyper-V после отработки отказа и обеспечить их подключение к соответствующим сетям виртуальных машин. Если не настроить сетевое сопоставление, реплики виртуальных машин не будут подключаться к сетям после отработки отказа.<br/><br/>Чтобы настроить сетевое сопоставление во время развертывания, убедитесь, что виртуальные машины на исходном сервере узла Hyper-V подключены к сети виртуальной машины VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.<br/<br/>Для целевого облака на дополнительном сервере VMM, используемом для восстановления, необходимо настроить соответствующую сеть виртуальных машин, которая, в свою очередь, должна быть связана с соответствующей логической сетью, сопоставленной с целевым облаком.<br/><br/>Дополнительные сведения о сетевом сопоставлении см. [здесь](site-recovery-network-mapping.md).
**Сопоставление хранилищ** | По умолчанию при репликации виртуальной машины на исходном сервере узла Hyper-V на целевой сервер узла Hyper-V реплицированные данные хранятся в расположении по умолчанию, указанном для целевого узла Hyper-V в диспетчере Hyper-V. Для усиления контроля над местом хранения реплицируемых данных можно настроить сопоставление хранилищ.<br/><br/>Чтобы настроить сопоставление хранилищ, необходимо настроить классификации хранилищ на исходном и целевом серверах VMM перед началом развертывания. [Подробнее](site-recovery-storage-mapping.md).


## Шаг 1. Создание хранилища Site Recovery

1. Войдите на [Портал управления](https://portal.azure.com) с сервера VMM, который хотите зарегистрировать.

2. Разверните **Службы данных** > **Службы восстановления** и щелкните **Хранилище Site Recovery**.

3. Выберите **Создать** > **Быстрое создание**.

4. В поле **Имя** введите понятное имя для идентификации хранилища.

5. В поле **Регион** выберите географический регион для хранилища. Сведения о поддерживаемых регионах см. в разделе "Регионы" на странице [Расценки на службу Azure Site Recovery](http://go.microsoft.com/fwlink/?LinkId=389880).

6. Щелкните элемент **Создать хранилище**.

	![Создать хранилище](./media/site-recovery-vmm-to-vmm/create-vault.png)

Убедитесь, что хранилище было создано (см. строку состояния). На главной странице служб восстановления это хранилище будет указано с состоянием **Активно**.

## Шаг 2. Создание ключа регистрации хранилища

Создайте ключ регистрации в хранилище. После загрузки поставщика Azure Site Recovery и установки его на сервер VMM этот ключ используется для регистрации сервера VMM в хранилище.

1. На странице **Службы восстановления** щелкните хранилище, чтобы открыть страницу быстрого запуска. Страницу быстрого запуска можно открыть и в любой другой момент, щелкнув этот значок.

	![Значок быстрого запуска](./media/site-recovery-vmm-to-vmm/quick-start-icon.png)

2. В раскрывающемся списке выберите **Between two on-premises Hyper-V sites** (Между двумя локальными сайтами Hyper-V).
3. В разделе **Подготовка серверов VMM** щелкните **Создать файл регистрационного ключа**. Файл ключа создается автоматически. Срок действия ключа — пять дней с момента создания. Если вы получаете доступ к порталу Azure не с сервера VMM, вам потребуется скопировать этот файл на сервер.

	![Регистрационный ключ](./media/site-recovery-vmm-to-vmm/register-key.png)

## Шаг 3. Установка поставщика Azure Site Recovery

4. На странице **Быстрый запуск** в разделе **Prepare VMM servers** (Подготовка серверов VMM) выберите пункт **Download Microsoft Azure Site Recovery Provider for installation on VMM servers** (Скачать поставщик Microsoft Azure Site Recovery для установки на серверы VMM), чтобы получить последнюю версию установочного файла приложения поставщика.

2. Запустите этот файл на исходном сервере VM. Если развертывание VMM выполняется в кластере и вы устанавливаете поставщик впервые, установите его на активном узле и завершите установку, чтобы зарегистрировать сервер VMM в хранилище. Затем установите поставщик на других узлах. Учтите, что при обновлении поставщика потребуется обновить его на всех узлах, так как все они должны работать под управлением одной версии.


3. Установщик выполняет несколько **проверок предварительных требований** и запрашивает разрешение на остановку службы VMM, чтобы начать установку поставщика. Служба VMM автоматически перезапустится после завершения установки. При установке в кластере VMM будет выдан запрос на остановку роли Cluster.

4. В **Центре обновления Майкрософт** вы можете настроить обновления. Если этот параметр включен, то обновления поставщика будут устанавливаться в соответствии с вашей политикой Центра обновления Майкрософт.

	![Центр обновления Майкрософт](./media/site-recovery-vmm-to-vmm/ms-update.png)

5. Задано такое расположение установки: **<SystemDrive>\\Program Files\\Microsoft System Center 2012 R2\\Virtual Machine Manager\\bin**. Нажмите кнопку "Установить", чтобы начать установку поставщика.

	![InstallLocation](./media/site-recovery-vmm-to-vmm/install-location.png)

6. После установки поставщика нажмите кнопку **Зарегистрировать**, чтобы зарегистрировать сервер в хранилище.

	![InstallComplete](./media/site-recovery-vmm-to-vmm/install-complete.png)

7. На странице **Подключение к Интернету** укажите, как запущенный на сервере VMM поставщик подключается к Интернету. Выберите **Подключиться с существующими настройками прокси-сервера**, чтобы использовать настройки подключения к Интернету, заданные на сервере по умолчанию.

	![Параметры Интернета](./media/site-recovery-vmm-to-vmm/proxy-details.png)

	- Если вы хотите использовать настраиваемый прокси-сервер, его следует настроить перед установкой поставщика. При настройке параметров прокси-сервера выполняется проверка подключения к прокси-серверу.
	- Если вы используете настраиваемый прокси-сервер или прокси-сервер по умолчанию требует выполнения проверки подлинности, вам потребуется указать сведения о прокси-сервере, включая его адрес и порт.
	- C сервера VMM должны быть доступны следующие URL-адреса и узлы Hyper-V:
		- *.hypervrecoverymanager.windowsazure.com
		- *.accesscontrol.windows.net
		- *.backup.windowsazure.com
		- *.blob.core.windows.net
		- *.store.core.windows.net
	- Разрешите IP-адреса, перечисленные в статье [Диапазоны IP-адресов центров обработки данных Azure ](https://www.microsoft.com/download/confirmation.aspx?id=41653) и протоколы HTTPS (443). Необходимо разрешить диапазоны IP-адресов региона Azure, который вы планируете использовать, и Запада США.
	- При использовании настраиваемого прокси-сервера автоматически создается учетная запись запуска от имени VMM (DRAProxyAccount), использующая указанные учетные данные прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени VMM можно изменить в консоли VMM. Для этого откройте рабочую область **Параметры**, разверните раздел **Безопасность**, щелкните **Учетные записи запуска от имени**, а затем измените пароль для учетной записи DRAProxyAccount. Чтобы параметры вступили в силу, потребуется перезапустить службу VMM.

8. В поле **Регистрационный ключ** укажите, что вы скачали его с Azure Site Recovery и скопировали на сервер VMM.
9. В поле **Имя хранилища** проверьте имя хранилища, в котором будет зарегистрирован сервер. Нажмите кнопку *Далее*.

	![Регистрация сервера](./media/site-recovery-vmm-to-vmm/vault-creds.png)

10.  Параметр шифрования используется только при репликации виртуальных машин Hyper-V в облаках VMM в Azure. При репликации на дополнительный сайт он не используется.

	![Регистрация сервера](./media/site-recovery-vmm-to-vmm/encrypt.png)

11.  В поле **Имя сервера** укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.
12.  В поле **Синхронизация метаданных в облаке** выберите, нужно ли синхронизировать метаданные для всех облаков сервера VMM в хранилище. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM.
 
	![Регистрация сервера](./media/site-recovery-vmm-to-vmm/friendly-name.png)

13.  Для завершения процесса нажмите кнопку **Далее**. После регистрации метаданные с сервера VMM извлекаются службой Azure Site Recovery. Сервер отображается на вкладке **Серверы VMM** на странице **Серверы** в хранилище.


### Установка из командной строки

Поставщик Azure Site Recovery также можно установить с помощью командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\\ASR.
2. Остановите службу System Center Virtual Machine Manager.
3. Извлеките установщик поставщика, выполнив приведенные ниже команды в командной строке. Для этого нужны права **администратора**.

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

4. Установите поставщика, выполнив следующую команду:

    	C:\ASR> setupdr.exe /i

5. Зарегистрируйте поставщик, выполнив следующую команду:

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>     

Используются следующие параметры:

 - **/Credentials**: обязательный параметр, который задает расположение ключа регистрации.  
 - **/FriendlyName**: обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
 - **/EncryptionEnabled**: необязательный параметр, который необходимо использовать только при репликации из VMM в Azure, если требуется шифрование виртуальных машин, хранящихся в Azure. Убедитесь, что указанный файл имеет расширение **PFX**.
 - **/proxyAddress**: необязательный параметр, указывающий адрес прокси-сервера.
 - **/proxyport**: необязательный параметр, указывающий порт прокси-сервера.
 - **/proxyusername**: необязательный параметр, указывающий имя пользователя прокси-сервера (если прокси-сервер требует выполнения проверки подлинности).
 - **/proxypassword**: необязательный параметр, который указывает пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует выполнения проверки подлинности).  

## Шаг 4. Настройка параметров защиты облачных систем

После регистрации серверов VMM можно настроить параметры защиты облачных систем. Если параметр **Синхронизировать облачные данные с хранилищем** был включен при установке поставщика, все облака на сервере VMM будут отображаться на вкладке **Защищенные элементы** в хранилище. В противном случае можно настроить синхронизацию конкретного облака с Azure Site Recovery на вкладке **Общие** страницы свойств облака в консоли VMM.

![Опубликованное облако](./media/site-recovery-vmm-to-vmm/clouds-list.png)

1. На странице быстрого запуска щелкните **Set up protection for VMM clouds** (Установить защиту для облаков VMM).
2. На вкладке **Облака VMM** выберите облако для настройки и перейдите на вкладку **Конфигурация**.
3. В разделе **Цель** выберите **VMM**.
4. В поле **Целевое расположение** выберите локальный сервер VMM, управляющий облаком, которое требуется использовать для восстановления.
4. В поле **Целевое облако** укажите целевое облако, которое требуется использовать для отработки отказа виртуальных машин в исходном облаке. Обратите внимание на следующее.

	- Рекомендуется выбрать целевое облако, удовлетворяющее требованиям к восстановлению для виртуальных машин, которые планируется защитить.
	- Облако может относиться только к одной паре облаков — в качестве основного или целевого.

5. В поле **Частота копирования** укажите, как часто следует синхронизировать данные между исходным и конечным расположениями. Примечание. Этот параметр применяется, только если узел Hyper-V работает под управлением Windows Server 2012 R2. Для других серверов используется значение по умолчанию, равное 5 минутам.
6. В поле **Дополнительные точки восстановления** укажите, следует ли создавать дополнительные точки восстановления. При использовании нулевого значения по умолчанию на сервере размещения реплики хранится только последняя точка восстановления для основной виртуальной машины. Обратите внимание, что для включения нескольких точек восстановления требуется дополнительное хранилище для моментальных снимков, которые хранятся в каждой точке восстановления. По умолчанию точки восстановления создаются каждый час, чтобы каждая точка восстановления содержала данные, накопленные за час. Значение точки восстановления, назначенное виртуальной машине в консоли VMM, не должно быть меньше значения, назначаемого в консоли Azure Site Recovery.
7. В поле **Периодичность создания соответствующих приложению снимков** укажите, как часто следует создавать моментальные снимки, соответствующие состоянию приложения. Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени. Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. Примечание. Включение моментальных снимков, соответствующих приложению, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.

	![Настройка параметров защиты](./media/site-recovery-vmm-to-vmm/cloud-settings.png)

8. В поле **Сжатие данных при передаче** укажите, требуется ли сжимать передаваемые реплицированные данные.
9. В поле **Проверки подлинности** укажите, как осуществляется проверка подлинности трафика между серверами основного узла и узла восстановления Hyper-V. В отсутствие настроенной рабочей среды Kerberos выберите протокол HTTPS. Azure Site Recovery автоматически настроит сертификаты для аутентификации HTTPS. Никакой дополнительной настройки не требуется. При выборе Kerberos для взаимной проверки подлинности серверов узлов будет использоваться билет Kerberos. По умолчанию порт 8083 и 8084 (для сертификатов) будет открыт в брандмауэре Windows на серверах узлов Hyper-V. Обратите внимание, что этот параметр используется только при запуске серверов узлов Hyper-V в Windows Server 2012 R2.
10. В поле **Порт** измените номер порта, на котором исходный и целевой главные компьютеры прослушивают трафик репликации. Например, этот параметр можно изменить, если вы хотите применять регулирование полосы пропускания качества обслуживания (QoS) для трафика репликации. Убедитесь, что порт не используется другим приложением и что он открыт в настройках брандмауэра.
11. В поле **Метод репликации** укажите, как будет осуществляться начальная репликация данных из исходного расположения в целевое перед началом обычной репликации.

	- **По сети** — копирование данных через сеть может требовать много времени и ресурсов. Рекомендуется использовать этот параметр, если облако содержит виртуальные машины с относительно небольшими виртуальными жесткими дисками, а основной сервер подключен к дополнительному сайту через широкополосное соединение. Можно немедленно начать копирование или выбрать соответствующее время. При использовании репликации по сети рекомендуется запланировать ее на часы наименьшей нагрузки.
	- **Автономно** — этот метод указывает, что начальная репликация будет выполняться с помощью внешнего носителя. Это удобно, если требуется избежать снижения производительности сети, а также для местоположений, находящихся на большом расстоянии друг от друга. Для использования этого метода необходимо указать расположение экспорта в исходном облаке и расположение импорта в целевом облаке. При включении защиты для виртуальной машины виртуальный жесткий диск копируется в указанное расположение экспорта. Вы отправляете его на целевой сайт и копируете в расположение импорта. Система копирует импортированные сведения на виртуальные машины реплики. 

12. Выберите **Delete Replica Virtual Machine** (Удалить виртуальную машину реплики), чтобы указать, что виртуальная машина реплики должна быть удалена, когда защита виртуальной машины прекращена в результате выбора параметра **Delete protection for the virtual machine** (Удалить защиту виртуальной машины) на вкладке "Виртуальные машины" в свойствах облака. Когда этот параметр включен, то при отключении защиты виртуальная машина удаляется из Azure Site Recovery, параметры Site Recovery для виртуальной машины удаляются из консоли VMM, также удаляется реплика.

	![Настройка параметров защиты](./media/site-recovery-vmm-to-vmm/cloud-settings-replica.png)

После сохранения параметров создается задание, которое можно отслеживать на вкладке **Задания**. Все сервера узлов Hyper-V в исходном облаке VMM могут быть настроены для репликации. Параметры облака можно изменить на вкладке **Настройка**. Чтобы изменить целевое расположение или целевое облако после сохранения конфигурации, необходимо удалить эту конфигурацию облака и затем повторно настроить облако.

### Подготовка к начальной репликации в автономном режиме

Для подготовки к начальной репликации в автономном режиме потребуется выполнить следующие действия.

- На исходном сервере потребуется задать расположение пути, по которому будет выполняться экспорт данных. Назначьте уровень "Полный доступ" для службы NTFS и разрешения "Общий доступ" для службы VMM для пути экспорта. На исходном сервере потребуется задать расположение пути, по которому будет выполняться импорт данных. Назначьте те же разрешения для этого пути импорта.
- Если путь импорта или экспорта используется совместно, назначьте учетной записи службы VMM на удаленном компьютере с общей папкой членство в группах "Администратор", "Опытный пользователь", "Оператор печати" или "Оператор сервера".
- Если вы используете любые учетные записи запуска от имени для добавления узлов, назначьте в VMM для учетных записей запуска от имени разрешения на чтение и запись для путей импорта и экспорта.
- Общие папки импорта и экспорта нельзя размещать на компьютерах, используемых в качестве серверов узлов Hyper-V, так как конфигурация замыкания на себя не поддерживается Hyper-V.
- В Active Directory для каждого сервера узла Hyper-V, содержащего защищаемые виртуальные машины, включите и настройте ограниченное делегирование для настройки отношений доверия с удаленными компьютерами, на которых размещаются пути экспорта и импорта, следующим образом.
	1. На контроллере домена откройте средство **Пользователи и компьютеры Active Directory**.
	2. В дереве консоли щелкните **Имя\_домена** > **Компьютеры**.
	3. Щелкните имя сервера узла Hyper-V правой кнопкой мыши и выберите пункт **Свойства**.
	4. На вкладке **Делегирование** щелкните **Доверять компьютеру делегирование указанных служб**.
	5. Установите флажок **Использовать любой протокол проверки подлинности**.
	6. Щелкните **Добавить** > **Пользователи и компьютеры**.
	7. Введите имя компьютера, на котором размещается путь экспорта, и нажмите кнопку **ОК**. В списке доступных служб, нажав и удерживая клавишу CTRL, щелкните **CIFS** и нажмите кнопку **ОК**. Повторите процедуру для имени компьютера, на котором размещается путь импорта. При необходимости повторите процедуру для дополнительных серверов узлов Hyper-V.

## Действие 5. Настройка сетевого сопоставления
1. На странице быстрого запуска щелкните **Сопоставить сети**.
2. Выберите исходный сервер VMM, с которого требуется выполнять сопоставление сетей, а затем целевой сервер VMM, на котором будут сопоставляться сети. На экран будет выведен список исходных сетей и соответствующих им целевых сетей. Для сетей, которые не сопоставляются на данный момент, отображается пустое значение.
3. Выберите сеть в меню **Сеть источника** > **Сопоставить**. Служба обнаруживает сети виртуальных машин на целевом сервере и отображает их. Щелкните значок сведений рядом с именами исходной и целевой сетей для просмотра их подсетей.

	![Настройка сетевого сопоставления](./media/site-recovery-vmm-to-vmm/network-mapping1.png)

4. В диалоговом окне выберите одну из сетей виртуальных машин целевого сервера VMM.

	![Выбор целевой сети](./media/site-recovery-vmm-to-vmm/network-mapping2.png)

5. При выборе целевой сети отображаются защищенные облака, использующие сеть источника. Также отображаются доступные целевые сети, связанные с облаками, используемыми для защиты. Рекомендуется выбрать целевую сеть, которая доступна для всех облаков, используемых для защиты. Также можно перейти к серверу VMM и изменить свойства облака для добавления логической сети, соответствующей сети виртуальной машины, которую вы хотите выбрать.
6. Установите флажок для завершения процесса сопоставления. Запускается задание, отслеживающее ход выполнения сопоставления. Его можно просмотреть на вкладке **Задания**.


## Шаг 6. Настройка сопоставления хранилищ
По умолчанию при репликации виртуальной машины на исходном сервере узла Hyper-V на целевой сервер узла Hyper-V реплицированные данные хранятся в расположении по умолчанию, указанном для целевого узла Hyper-V в диспетчере Hyper-V. Чтобы иметь возможность точно контролировать место хранения реплицируемых данных, можно настроить сопоставление хранилищ следующим образом.



1. Задайте классификации хранилищ на исходном и целевом серверах VMM. [Подробнее](https://technet.microsoft.com/library/gg610685.aspx). Классификации должны быть доступны на серверах размещения Hyper-V в исходном и целевом облаках. Классификации не обязательно должны иметь одинаковый тип хранилища. Например, можно сопоставить исходную классификацию, содержащую общие папки SMB, с целевой классификацией, которая содержит CSV-файлы.
2. После определения классификаций можно приступить к созданию сопоставлений. Для этого на странице **быстрого запуска** щелкните **Сопоставить хранилище**.
3. Перейдите на вкладку **Хранилище** и щелкните **Сопоставление классификаций хранилищ**.
4. На вкладке **Сопоставление классификаций хранилищ** выберите классификации на исходном и целевом серверах VMM. Сохраните параметры.

	![Выбор целевой сети](./media/site-recovery-vmm-to-vmm/storage-mapping.png)


## Шаг 7. Включение защиты виртуальной машины
После успешной настройки серверов, облаков и сетей можно включить защиту для виртуальных машин в облаке.

1. На вкладке **Виртуальные машины** в облаке, где размещаются виртуальные машины, щелкните **Включить защиту** > **Добавить виртуальные машины**.
2. Из списка виртуальных машин в облаке выберите те, которые хотите защитить.

	![Включение защиты виртуальной машины](./media/site-recovery-vmm-to-vmm/enable-protection.png)

3. За ходом выполнения действия "Включение защиты", в том числе и за первоначальной репликацией, можно наблюдать на вкладке **Задания**. После запуска задачи финализации защиты виртуальная машина готова к отработке отказа. После включения защиты и репликации виртуальных машин вы сможете просматривать их в Azure.

	![Задание защиты виртуальной машины](./media/site-recovery-vmm-to-vmm/vm-jobs.png)
	
>[AZURE.NOTE] Защиту для виртуальных машин также можно включить в консоли VMM. На панели инструментов на вкладке **Azure Site Recovery** в свойствах виртуальной машины щелкните **Включить защиту**.

### Размещение существующих виртуальных машин

При наличии существующих виртуальных машин в VMM, которые реплицируются с помощью реплики Hyper-V, их потребуется разместить для защиты Azure Site Recovery следующим образом.

1. Убедитесь в наличии основного и дополнительного облака. Убедитесь, что сервер Hyper-V, на котором размещаются существующие виртуальные машины, располагается в основном облаке и что сервер Hyper-V, на котором размещается реплика виртуальной машины, располагается в дополнительном облаке. Убедитесь, что вы настроили параметры защиты для облаков. Параметры должны совпадать с текущими настроенными параметрами для реплики Hyper-V. В противном случае репликация виртуальной машины может не работать должным образом.
2. Затем включите защиту для основной виртуальной машины. Azure Site Recovery и VMM обеспечат обнаружение того же узла реплики и виртуальной машины, а Azure Site Recovery повторно использует и установит репликацию, используя параметры, заданные в ходе настройки облака.


## Выполните тестирование развертывания

Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления, состоящий из нескольких виртуальных машин, и запустить тестовую отработку отказа плана. Тестовая обработка отказа имитирует механизм отработки отказа и восстановления в изолированной сети.

### Создайте план восстановления

1. На вкладке **Планы восстановления** выберите **Создать план восстановления**.
2. Укажите имя плана восстановления, а также исходный и целевой серверы VMM. Исходный сервер должен содержать виртуальные машины, активированные для отработки отказа и восстановления. Выберите **Hyper-V**, чтобы просмотреть только те облака, которые настроены для репликации Hyper-V.

	![Создать план восстановления](./media/site-recovery-vmm-to-vmm/recovery-plan1.png)

3. В разделе **Выбор виртуальной машины** выберите группы репликации. Все виртуальные машины, связанные с группой репликации, будут выбраны и добавлены в план восстановления. Эти виртуальные машины добавляются в группу плана восстановления по умолчанию — группу 1. При необходимости можно внести дополнительные группы. Обратите внимание, что после репликации виртуальные машины запустятся в соответствии с порядком групп плана восстановления.

	![Добавить виртуальные машины](./media/site-recovery-vmm-to-vmm/recovery-plan2.png)

После создания план восстановления отобразится в списке на вкладке **Планы восстановления**.

###Запуск тестовой отработки отказа

1. На вкладке **Планы восстановления** выберите план и щелкните **Тестовая отработка отказа**.
2. На странице **Подтверждение тестовой отработки отказа** выберите **Нет**. Обратите внимание, что реплики виртуальных машин, перешедших на другой ресурс, не будут подключены к какой-либо сети, если этот параметр включен. В данном случае проверяется, происходит ли аварийный переход виртуальной машины на другой ресурс, но не проверяется сетевая среда репликации. Узнайте, как [выполнить тестовую отработку отказа](site-recovery-failover.md#run-a-test-failover), чтобы больше узнать об использовании различных вариантов сетевых подключений.
3. Тестовая виртуальная машина будет создана на том же узле, что и реплика виртуальной машины. Она добавляется в то же облако, в котором находится реплика виртуальной машины.

### Запустите план восстановления.
После завершения репликации реплика виртуальной машины может не получить IP-адрес, отличный от IP-адреса основной виртуальной машины. Виртуальные машины обновят используемый DNS-сервер после запуска. Также можно добавить скрипт для обновления DNS-сервера, чтобы обеспечить своевременное обновление.

#### Скрипт для получения IP-адресов
Запустите пример скрипта для получения IP-адреса.

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

#### Скрипт для обновления DNS
Запустите пример скрипта для обновления DNS, указав IP-адрес, полученный с помощью предыдущего примера скрипта.

		string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

## Дальнейшие действия

Протестировав отработку отказа и убедившись, что среда работает так, как нужно, [ознакомьтесь](site-recovery-failover.md) с разными типами отработки отказов.


## Сведения о конфиденциальности для Site Recovery

В этом разделе содержатся дополнительные сведения о конфиденциальности для службы Microsoft Azure Site Recovery (далее — служба). Заявление о конфиденциальности для служб Microsoft Azure см. на странице [Заявление о конфиденциальности Microsoft Azure](http://go.microsoft.com/fwlink/?LinkId=324899).

**Функция: регистрация**

- **Что она делает**: регистрирует сервер в службе, чтобы стала возможной защита виртуальных машин.
- **Собираемая информация**. После регистрации служба собирает, обрабатывает и передает сведения о сертификате управления с сервера VMM, предназначенного для обеспечения аварийного восстановления, используя имя службы сервера VMM и имена облаков виртуальных машин на сервере VMM.
- **Использование информации**.
	- Сертификат управления — служит для идентификации и проверки подлинности зарегистрированного сервера VMM для получения доступа к Службе. Служба использует часть открытого ключа сертификата для защиты маркера, к которому может получить доступ только зарегистрированный сервер VMM. Этот маркер требуется серверу для получения доступа к функциям Службы.
	- Имя сервера VMM — имя сервера VMM требуется для идентификации и обмена данными с соответствующим сервером VMM, на котором размещаются облака.
	- Имена облаков с сервера VMM — имя облака требуется при использовании функции связывания (отмены связывания) облаков Службы, которая описывается ниже. При связывании облака из основного центра обработки данных с другим облаком в центре обработки данных восстановления представляются имена всех облаков центра обработки данных восстановления.

- **Варианты действий**. Эти сведения — важная часть процесса регистрации службы, так как они помогают вам и службе идентифицировать сервер VMM, для которого требуется защита Azure Site Recovery, а также определить правильный зарегистрированный сервер VMM. Если вы не хотите отправлять эти сведения в Службу, откажитесь от использования этой Службы. После регистрации сервера отменить регистрацию можно, удалив сведения о сервере VMM из портала Службы (то есть портала Azure).

**Функция: включение защиты Azure Site Recovery**

- **Что она делает**: поставщик Azure Site Recovery, установленный на сервере VMM, является каналом для взаимодействия со службой. Поставщик представляет собой библиотеку DLL, размещаемую в процессе VMM. После установки поставщика в консоли администратора VMM включается функция "Восстановление центра обработки данных". На всех новых и существующих виртуальных машинах в облаке можно включить свойство "Восстановление центра обработки данных" для защиты виртуальных машин. После установки этого свойства поставщик отправляет имя и идентификатор виртуальной машины в Службу. Виртуальная защита обеспечивается технологией репликации Hyper-V Windows Server 2012 или Windows Server 2012 R2. Данные виртуальной машины реплицируются с одного узла Hyper-V на другой (как правило, он находится в другом центре обработки данных "восстановления").

- **Собираемая информация**. Служба собирает, обрабатывает и передает метаданные для виртуальной машины, включая имя, идентификатор, виртуальную сеть и имя облака, которому она принадлежит.

- **Использование информации**. Служба использует указанные выше сведения для заполнения раздела сведений о виртуальной машине на портале службы.

- **Варианты действий:** это важная функция Службы, и ее нельзя отключить. Если вы не хотите, чтобы эти данные передавались в Службу, не включайте защиту Azure Site Recovery для виртуальных машин. Примечание. Все данные, отправляемые поставщиком в Службу, передаются по протоколу HTTPS.

**Функция: создание плана восстановления**

- **Действие**. Эта функция позволяет создать план оркестрации для центра обработки данных восстановления. Можно определить порядок запуска виртуальной машины или группы виртуальных машин на сайте восстановления. Кроме того, можно указать выполняемые автоматизированные скрипты или ручные действия во время восстановления для каждой виртуальной машины. Отработка отказа (рассматриваемая в следующем разделе) обычно запускается на уровне плана восстановления для выполнения координированного восстановления.

- **Собираемая информация**. Служба собирает, обрабатывает и передает метаданные плана восстановления, включая метаданные виртуальной машины, метаданные сценариев автоматизации и заметки о выполняемых вручную действиях.

- **Использование информации**. Перечисленные выше метаданные используются для создания плана восстановления на портале службы.

- **Варианты действий**. Это важная функция службы, и ее нельзя отключить. Если вы не хотите, чтобы эти данные передавались в Службу, не создавайте планы восстановления в этой Службе.

**Функция: настройка сетевого сопоставления**

- **Действие**. Эта функция позволяет сопоставить сведения о сети между основным центром обработки данных и центром обработки данных восстановления. При восстановлении виртуальных машин на сайте восстановления это сопоставление помогает установить для них сетевое подключение.

- **Собираемая информация**. В рамках функции сетевого сопоставления служба собирает, обрабатывает и передает метаданные логических сетей для каждого сайта (основного и центра обработки данных).

- **Использование информации**: служба использует метаданные для заполнения разделов портала службы, в которых можно настроить сопоставление сведений о сетях.

- **Варианты действий:** это важная функция Службы, и ее нельзя отключить. Если вы не хотите, чтобы эти данные передавались в Службу, не используйте функцию сетевого сопоставления.

**Функция: отработка отказа — запланированная, незапланированная, тестовая**

- **Действие**. Эта функция обеспечивает отработку отказа виртуальной машины из одного управляемого VMM центра обработки данных на другой. Действие отработки отказа запускается пользователем на портале Службы. Возможные причины выполнения отработки отказа включают следующие: незапланированное событие (например,стихийное бедствие); запланированное событие (например, балансировка нагрузки центра обработки данных); тестовая отработка отказа (например, проверка плана восстановления).

Поставщик на сервере VMM получает уведомление о событии от Службы и выполняет действие отработки отказа на узле Hyper-V посредством интерфейсов VMM. Фактическая отработка отказа виртуальной машины с одного узла Hyper-V на другой (как правило, выполняемая в центре обработки данных "восстановления") осуществляется технологией репликации Hyper-V Windows Server 2012 или Windows Server 2012 R2. После отработки отказа поставщик, установленный на сервере VMM центра обработки данных "восстановления", отправляет сведения об успешном выполнении в Службу.

- **Собираемая информация**. Служба использует перечисленные выше сведения, чтобы заполнять состояние действия отработки отказа на портале службы.

- **Использование информации**. Служба использует указанные выше сведения следующим образом.

	- Сертификат управления — служит для идентификации и проверки подлинности зарегистрированного сервера VMM для получения доступа к Службе. Служба использует часть открытого ключа сертификата для защиты маркера, к которому может получить доступ только зарегистрированный сервер VMM. Этот маркер требуется серверу для получения доступа к функциям Службы.
	- Имя сервера VMM — имя сервера VMM требуется для идентификации и обмена данными с соответствующим сервером VMM, на котором размещаются облака.
	- Имена облаков с сервера VMM — имя облака требуется при использовании функции связывания (отмены связывания) облаков Службы, которая описывается ниже. При связывании облака из основного центра обработки данных с другим облаком в центре обработки данных восстановления представляются имена всех облаков центра обработки данных восстановления.

- **Варианты действий**. Это важная функция службы, и ее нельзя отключить. Если вы не хотите, чтобы эти данные передавались в Службу, не используйте эту Службу.

<!---HONumber=AcomDC_0218_2016-->