---
title: Сохранение IP-адресов при отработке отказа виртуальных машин Azure в другой регион Azure | Документация Майкрософт
description: В этой статье описывается, как сохранить IP-адреса в сценарии отработки отказа из Azure в Azure с помощью Azure Site Recovery.
services: site-recovery
documentationcenter: ''
author: mayanknayar
manager: rochakm
editor: ''
ms.assetid: ''
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/11/2018
ms.author: manayar
ms.openlocfilehash: 9a9c18bfe9073e5af94c7bd8f0fbb91651387731
ms.sourcegitcommit: c52123364e2ba086722bc860f2972642115316ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2018
ms.locfileid: "34071670"
---
# <a name="ip-address-retention-for-azure-virtual-machine-failover"></a>Сохранение IP-адресов при отработке отказа виртуальных машин Azure

Azure Site Recovery позволяет выполнять аварийное восстановление виртуальных машин Azure. При отработке отказа из одного региона Azure в другой клиентам часто требуется сохранение конфигураций IP. По умолчанию Site Recovery имитирует исходную виртуальную сеть и структуру подсети при создании этих ресурсов в целевом регионе. При отработке отказа виртуальных машин Azure со статическими частными IP-адресами Site Recovery старается предоставить аналогичные частные IP-адреса на целевых виртуальных машинах, если этот IP-адрес еще не заблокирован ресурсом Azure или реплицированной виртуальной машиной.

Для простых приложений требуется следующая конфигурация по умолчанию. Для более сложных корпоративных приложений клиентам может потребоваться предоставить дополнительные сетевые ресурсы для обеспечения возможности подключения к другим компонентам инфраструктуры после сбоя. В этой статье описываются требования к сети для отработки отказа на виртуальных машинах Azure из одного региона в другой при сохранении IP-адресов виртуальных машин.

## <a name="azure-to-azure-connectivity"></a>Подключения из Azure в Azure

В первом случае мы рассмотрим **компанию A** со всей инфраструктурой приложений в Azure. Для обеспечения непрерывности бизнес-процессов и соблюдения требований **компания A** решает использовать Azure Site Recovery для защиты своих приложений.

Учитывая требование сохранения IP-адресов (например, для привязки приложений), компания A имеет аналогичную структуру виртуальной сети и подсети в целевом регионе. Чтобы еще больше сократить целевое время восстановления (RTO), **компания A** использует узлы реплики для SQL AlwaysON, контроллеры домена и т. д., при этом узлы реплик помещаются в другую виртуальную сеть в целевой области. Использование другого адресного пространства для узлов реплики позволяет **компании A** устанавливать VPN-подключение "сеть — сеть" между исходным и целевым регионами, что в противном случае было бы невозможным, если одно и то же адресное пространство используется на обоих концах.

Перед выполнением отработки отказа архитектура сети выглядит следующим образом:
- Виртуальные машины приложения размещаются в регионе Azure "Восточная Азия", используя виртуальную сеть Azure с адресным пространством 10.1.0.0/16. Это **исходная виртуальная сеть**.
- Нагрузка приложений распределяется по трем подсетям — 10.1.1.0/24, 10.1.2.0/24, 10.1.3.0/24 (**Subnet 1**, **Subnet 2** и **Subnet 3** соответственно).
- Регион Azure "Юго-Восточная Азия" является целевым регионом и имеет виртуальную сеть для аварийного восстановления, которая имитирует исходное адресное пространство и конфигурацию подсети. Эта виртуальная сеть называется **виртуальной сетью для аварийного восстановления**.
- Узлы реплик, которые необходимы для Always On, контроллер домена и т. д. помещаются в виртуальную сеть с адресным пространством 10.2.0.0/16 внутри подсети Subnet 4 с адресом 10.2.4.0/24. Виртуальная сеть называется **виртуальной сетью Azure** и располагается в регионе Azure "Юго-Восточная Азия".
- **Исходная виртуальная сеть** и **виртуальная сеть Azure** соединены через VPN-подключение "сеть — сеть".
- **Виртуальная сеть для аварийного восстановления** не соединена с виртуальной сетью.
- **Компания A** назначает и проверяет целевой IP-адрес реплицированных элементов. В этом примере целевой IP-адрес аналогичен исходному IP-адресу каждой виртуальной машины.

![Подключения из Azure в Azure перед отработкой отказа](./media/site-recovery-retain-ip-azure-vm-failover/azure-to-azure-connectivity-before-failover2.png)

### <a name="full-region-failover"></a>Отработка отказа всего региона

В случае регионального сбоя **компания A** может быстро восстановить все развертывание с помощью [эффективных планов восстановления](site-recovery-create-recovery-plans.md) Azure Site Recovery. Установив целевой IP-адрес каждой виртуальной машины до отработки отказа, **компания A** может организовать отработку отказа и автоматизировать подключение между виртуальной сетью для аварийного восстановления и виртуальной сетью Azure, как показано на диаграмме ниже.

![Подключения из Azure в Azure при отработке отказа всего региона](./media/site-recovery-retain-ip-azure-vm-failover/azure-to-azure-connectivity-full-region-failover2.png)

В зависимости от требований приложения подключения между двумя виртуальными сетями в целевом регионе могут быть установлены до, во время (в качестве промежуточного шага) или после отработки отказа. Используйте [планы восстановления](site-recovery-create-recovery-plans.md), чтобы добавить сценарии и определить порядок отработки отказа.

Компания A также может использовать пиринг виртуальной сети или VPN-подключение "сеть — сеть", чтобы установить подключение между сетью для аварийного восстановления и виртуальной сетью Azure. При пиринге виртуальных сетей не используется VPN-шлюз и применяются другие ограничения. Кроме того, [цены на пиринг виртуальных сетей](https://azure.microsoft.com/pricing/details/virtual-network) рассчитываются не так, как [цены на VPN-шлюз "виртуальная сеть — виртуальная сеть"](https://azure.microsoft.com/pricing/details/vpn-gateway). Для отработки отказа обычно рекомендуется имитировать целевое подключение, включая его тип, чтобы минимизировать непредсказуемые инциденты, возникающие в результате изменений сети.

### <a name="isolated-application-failover"></a>Отработка отказа изолированных приложений

В определенных условиях пользователям может потребоваться отработка отказа части инфраструктуры приложений. Примером может быть отработка отказа отдельного приложения или уровня, который размещается в выделенной подсети. Хотя отработка отказа подсети с сохранением IP-адресов возможна, она не рекомендуется для большинства ситуаций, так как это существенно увеличивает несогласованности подключения. Кроме того, будут потеряны подключения между подсетями в пределах одной виртуальной сети Azure.

С учетом требований к отработке отказа подсети уровня приложения лучше использовать другой целевой IP-адрес для перехода на другой ресурс (если требуется подключение к другим подсетям в исходной виртуальной сети) или изолировать каждое приложение в собственной выделенной виртуальной сети в источнике. Последний подход позволяет установить межсетевое соединение в источнике и эмулировать аналогичное при отработке отказа в целевой регион.

При разработке отдельных приложений для обеспечения отказоустойчивости рекомендуется разместить приложение в собственной выделенной виртуальной сети и установить связь между этими виртуальными сетями по мере необходимости. Это позволяет изолировать отработку отказа приложения при сохранении оригинальных частных IP-адресов.

Конфигурация перед отработкой отказа выглядит следующим образом:
- Виртуальные машины приложения размещаются в регионе Azure "Восточная Азия", используя виртуальную сеть Azure с адресным пространством 10.1.0.0/16 для первого приложения и 10.2.0.0/16 для второго. Виртуальные сети называются **Recovery VNet1** и **Recovery VNet2** для первого и второго приложения соответственно.
- Каждая виртуальная сеть в дальнейшем разбивается на две подсети.
- Регион Azure "Юго-Восточная Азия" является целевым регионом и содержит виртуальные сети для восстановления Recovery VNet1 и Recovery VNet2.
- Узлы реплик, которые необходимы для Always On, контроллер домена и т. д. помещаются в виртуальную сеть с адресным пространством 10.3.0.0/16 внутри подсети **Subnet 4** с адресом 10.3.4.0/24. Виртуальная сеть называется виртуальной сетью Azure и располагается в регионе Azure "Юго-Восточная Азия".
- **Source VNet1** и **виртуальная сеть Azure** соединены через VPN-подключение "сеть — сеть". Аналогично **Source VNet2** и **виртуальная сеть Azure** также соединены через VPN-подключение "сеть — сеть".
- **Source VNet1** и **Source VNet2** также подключены через VPN-подключение типа "сеть — сеть" в этом примере. Так как две виртуальные сети находятся в одном регионе, вместо VPN-подключения "сеть — сеть" можно использовать пиринг виртуальной сети.
- **Recovery VNet1** и **Recovery VNet2** не соединены с виртуальной сетью.
- Чтобы сократить целевое время восстановления, VPN-шлюзы настраиваются в сетях **Recovery VNet1** и **Recovery VNet2** до отработки отказа.

![Подключение из Azure в Azure изолированного приложения перед отработкой отказа](./media/site-recovery-retain-ip-azure-vm-failover/azure-to-azure-connectivity-isolated-application-before-failover2.png)

В случае аварийной ситуации, которая затрагивает только одно приложение (в этом примере размещенное в Source VNet2), компания A может восстановить его следующим образом:
- VPN-подключения между **Source VNet1** и **Source VNet2** и между **Source VNet2** и **виртуальной сетью Azure** будут отключены.
- VPN-подключения устанавливаются между **Source VNet1** и **Recovery VNet2** и между **Recovery VNet2** и **виртуальной сетью Azure**.
- Виртуальные машины из **Source VNet2** переносятся в **Recovery VNet2**.

![Подключение из Azure в Azure изолированного приложения после отработки отказа](./media/site-recovery-retain-ip-azure-vm-failover/azure-to-azure-connectivity-isolated-application-after-failover2.png)

Вышеупомянутый пример изолированной отработки отказа можно расширить, включив в него больше приложений и сетевых подключений. При отработке отказа из источника в целевое расположение рекомендуется следовать модели аналогичного подключения, насколько это возможно.

### <a name="further-considerations"></a>Дальнейшие рекомендации

VPN-шлюзы используют общедоступные IP-адреса и шлюзы для установки соединений. Если вы не хотите использовать общедоступный IP-адрес или хотите избежать дополнительных прыжков, вы можете использовать [пиринг виртуальной сети](../virtual-network/virtual-network-peering-overview.md) Azure для установки пиринговой связи между несколькими [поддерживаемыми регионами Azure](../virtual-network/virtual-network-manage-peering.md#cross-region).

## <a name="on-premises-to-azure-connectivity"></a>Подключения между локальной средой и Azure

Во втором сценарии рассмотрим **компанию Б**, часть инфраструктуры приложений которой работает на Azure, а другая часть в локальной среде. Для обеспечения непрерывности бизнес-процессов и соблюдения требований **компания Б** решает использовать Azure Site Recovery для защиты своих приложений в Azure.

Перед выполнением отработки отказа архитектура сети выглядит следующим образом:
- Виртуальные машины приложения размещаются в регионе Azure "Восточная Азия", используя виртуальную сеть Azure с адресным пространством 10.1.0.0/16. Это **исходная виртуальная сеть**.
- Нагрузка приложений распределяется по трем подсетям — 10.1.1.0/24, 10.1.2.0/24, 10.1.3.0/24 (**Subnet 1**, **Subnet 2** и **Subnet 3** соответственно).
- Регион Azure "Юго-Восточная Азия" является целевым регионом и имеет виртуальную сеть для аварийного восстановления, которая имитирует исходное адресное пространство и конфигурацию подсети. Эта виртуальная сеть называется **виртуальной сетью для аварийного восстановления**.
- Виртуальные машины в регионе Azure "Восточная Азия" подключаются к локальному центру обработки данных через ExpressRoute или VPN-подключение "сеть — сеть".
- Чтобы сократить целевое время восстановления, компания Б подготавливает шлюзы в Recovery VNet в регионе Azure "Юго-Восточная Азия" до отработки отказа.
- **Компания Б** назначает и проверяет целевой IP-адрес реплицированных элементов. В этом примере целевой IP-адрес аналогичен исходному IP-адресу каждой виртуальной машины.

![Подключения между локальной средой и Azure перед отработкой отказа](./media/site-recovery-retain-ip-azure-vm-failover/on-premises-to-azure-connectivity-before-failover2.png)

### <a name="full-region-failover"></a>Отработка отказа всего региона

В случае регионального сбоя **компания Б** может быстро восстановить все развертывание с помощью [эффективных планов восстановления](site-recovery-create-recovery-plans.md) Azure Site Recovery. Установив целевой IP-адрес каждой виртуальной машины до отработки отказа, **компания Б** может организовать отработку отказа и автоматизировать подключение между виртуальной сетью для аварийного восстановления и локальным центром обработки данных, как показано на диаграмме ниже.

Исходное соединение между регионом Azure "Восточная Азия" и локальным центром обработки данных должно быть отключено, прежде чем устанавливать связь между этим регионом и локальным центром обработки данных. Локальная маршрутизация также перенастраивается, чтобы указать на целевой регион и шлюз после отработки отказа.

![Подключения между локальной средой и Azure после отработки отказа](./media/site-recovery-retain-ip-azure-vm-failover/on-premises-to-azure-connectivity-after-failover2.png)

### <a name="subnet-failover"></a>Отработка отказа подсети

В отличие от сценария из Azure в Azure, описанного для **компании A**, в этом случае отработка отказа на уровне подсети для **компании Б** невозможна. Это связано с тем, что адресное пространство в исходных и восстановленных виртуальных сетях одинаково, а подключение между источником и локальной средой активно.

Чтобы добиться отказоустойчивости приложений, каждое приложение должно размещаться в собственной виртуальной сети Azure. В таком случае отработку отказа приложений можно выполнить изолированно, а требуемые локальные подключения к источнику могут быть перенаправлены в целевой регион, как описано выше.

## <a name="next-steps"></a>Дополнительная информация
- [Узнайте подробнее](site-recovery-create-recovery-plans.md) о планах восстановления.
