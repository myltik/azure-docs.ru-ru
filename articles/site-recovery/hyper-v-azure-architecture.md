---
title: Архитектура репликации из Hyper-V в Azure в Azure Site Recovery | Документация Майкрософт
description: В этой статье представлен обзор компонентов и архитектуры, используемых при репликации виртуальных машин Hyper-V (без VMM) из локальной среды в Azure с помощью службы Azure Site Recovery.
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 05/02/2018
ms.author: raynew
ms.openlocfilehash: 11ecc341977efb5c815581a77383d1c8cae51ed6
ms.sourcegitcommit: 870d372785ffa8ca46346f4dfe215f245931dae1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2018
ms.locfileid: "33894336"
---
# <a name="hyper-v-to-azure-replication-architecture"></a>Архитектура репликации из Hyper-V в Azure


Эта статья описывает архитектуру и процессы, используемые при репликации, отработке отказа и восстановлении виртуальных машин (ВМ) Hyper-V между локальными узлами Hyper-V и Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

Узлы Hyper-V могут управляться в частных облаках System Center Virtual Machine Manager (VMM).



## <a name="architectural-components---hyper-v-without-vmm"></a>Компоненты архитектуры — Hyper-V без VMM

Таблица и рисунок ниже позволяют получить общее представление о компонентах, используемых для репликации Hyper-V в Azure, когда узлы Hyper-V не управляются VMM.

**Компонент** | **Требование** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | Подписка Azure, учетная запись хранения Azure и сеть Azure. | Реплицированные данные из локальных рабочих нагрузок ВМ хранятся в учетной записи хранения. Виртуальные машины Azure создаются с использованием реплицированных данных рабочих нагрузок при отработке отказа с локального сайта.<br/><br/> При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Hyper-V** | Во время развертывания Site Recovery вы собираете узлы и кластеры Hyper-V в сайты Hyper-V. Установите поставщик Azure Site Recovery и агент служб восстановления на каждом отдельном хосте Hyper-V или на каждом узле кластера Hyper-V. | Поставщик оркестрирует репликацию через Интернет с помощью службы Site Recovery. Агент служб восстановления обрабатывает репликацию данных.<br/><br/> Обмен данными между поставщиком и агентом осуществляется по защищенным и зашифрованным каналам. Реплицированные данные в службе хранилища Azure также шифруются.
**Виртуальные машины Hyper-V** | На Hyper-V выполняется одна или несколько виртуальных машин. | На виртуальных машинах не нужно ничего устанавливать явным образом.


**Архитектура: из Hyper-V в Azure (без VMM)**

![Архитектура](./media/hyper-v-azure-architecture/arch-onprem-azure-hypervsite.png)



## <a name="architectural-components---hyper-v-with-vmm"></a>Компоненты архитектуры — Hyper-V с VMM

Таблица и рисунок ниже позволяют получить общее представление о компонентах, используемых для репликации Hyper-V в Azure, когда узлы Hyper-V управляются в облаках VMM.

**Компонент** | **Требование** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | Подписка Azure, учетная запись хранения Azure и сеть Azure. | Реплицированные данные из локальных рабочих нагрузок ВМ хранятся в учетной записи хранения. Виртуальные машины Azure создаются с использованием реплицированных данных при отработке отказа с локального сайта.<br/><br/> При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер VMM** | Сервер VMM содержит одно или несколько облаков с узлами Hyper-V. | На сервере VMM устанавливается поставщик Site Recovery для оркестрации репликации с Site Recovery, а сам сервер регистрируется в хранилище служб восстановления.
**Узел Hyper-V** | Один или несколько кластеров (узлов) Hyper-V под управлением VMM. |  Установите агент служб восстановления на каждом узле Hyper-V или узле кластера.
**Виртуальные машины Hyper-V** | Хотя бы одна виртуальная машина, запущенная на сервере узла Hyper-V. | На виртуальных машинах не нужно ничего устанавливать явным образом.
**Сеть** | Логическая сеть и сеть виртуальных машин, настроенные на сервере VMM. Сеть виртуальных машин должна быть связана с логической сетью, которая сопоставлена с облаком. | Сети виртуальных машин сопоставляются с виртуальными сетями Azure. При создании виртуальных машин Azure после отработки отказа они добавляются в сеть Azure, сопоставленную с сетью виртуальных машин.

**Архитектура: из Hyper-V в Azure (с VMM)**

![Компоненты](./media/hyper-v-azure-architecture/arch-onprem-onprem-azure-vmm.png)



## <a name="replication-process"></a>Процесс репликации

![Репликация из Hyper-V в Azure](./media/hyper-v-azure-architecture/arch-hyperv-azure-workflow.png)

**Процедура репликации и восстановления**


### <a name="enable-protection"></a>Включить защиту

1. После включения защиты для виртуальных машин Hyper-V на портале Azure или локально запустится рабочий процесс **Включение защиты**.
2. Это задание проверяет, соответствует ли компьютер необходимым требованиям перед вызовом метода [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx), который настраивает репликацию, используя определенные вами параметры.
3. Задание запускает начальную репликацию, вызывая метод [StartReplication](https://msdn.microsoft.com/library/hh850303.aspx), чтобы инициализировать полную репликацию виртуальной машины и отправить ее виртуальные диски в Azure.
4. На вкладке **Задания** можно отслеживать ход выполнения задания.      ![Список заданий](media/hyper-v-azure-architecture/image1.png)![Подробные сведения о включении защиты](media/hyper-v-azure-architecture/image2.png)


### <a name="initial-data-replication"></a>Начальная репликация данных

1. При запуске начальной репликации создается [моментальный снимок виртуальной машины Hyper-V](https://technet.microsoft.com/library/dd560637.aspx).
2. Виртуальные жесткие диски на виртуальной машине реплицируются по одному, пока все они не будут скопированы в Azure. В зависимости от размера виртуальной машины и пропускной способности сети это может занять некоторое время. [Дополнительные сведения](https://support.microsoft.com/kb/3056159) о том, как увеличить пропускную способность сети.
3. В случае возникновения изменений на диске при выполнении начальной репликации модуль отслеживания репликации реплики Hyper-V регистрирует их в журналах репликации Hyper-V (HRL), которые находятся в одной папке с дисками. С каждым диском связан HRL-файл, который отправляется в дополнительное хранилище. При начальной репликации файлы моментальных снимков и журналов потребляют ресурсы диска.
4. После завершения начальной репликации моментальный снимок виртуальной машины удаляется.
5. Разностные изменения на диске в журнале синхронизируются и объединяются в родительском диске.


### <a name="finalize-protection-process"></a>Процедура завершения подготовки защиты

1. После завершения начальной репликации запускается задача **Завершить подготовку защиты на виртуальной машине**. Она выполняет настройку сети и других параметров, действующих после репликации, для защиты виртуальной машины.
2. На этом этапе можно проверить параметры виртуальной машины, чтобы убедиться в ее готовности к отработке отказа. Вы можете запустить отработку аварийного восстановления (тестовая отработка отказа) для виртуальной машины, чтобы проверить правильность отработки отказа. 


## <a name="delta-replication"></a>Разностная репликация данных

1. После начальной репликации начинается разностная репликация в соответствии с политикой репликации.
2. Модуль отслеживания репликации реплики Hyper-V регистрирует изменения на виртуальном жестком диске в виде HRL-файлов. Для каждого диска, предназначенного для репликации, создается связанный HRL-файл.
3. Этот журнал передается в учетную запись хранения клиента. При передаче журнала в Azure изменения на основном диске фиксируются в дополнительном журнале, который находится в той же папке.
4. Во время начальной и разностной репликаций вы можете отслеживать состояние виртуальной машины на портале Azure.

### <a name="resynchronization-process"></a>Процедура повторной синхронизации

1. Если происходит сбой дельта-репликации и для полной репликации необходима высокая пропускная способность или требуется много времени, тогда виртуальная машина помечается для повторной синхронизации.
    - Например, когда HRL-файлы заполняют до 50 % объема диска, виртуальная машина отмечается для повторной синхронизации.
    -  По умолчанию повторная синхронизация автоматически выполняется в нерабочее время.
1.  При ней отправляются только разностные данные.
    - Это позволяет минимизировать объем передаваемых данных, вычисляя контрольные суммы исходной и целевой виртуальной машины.
    - Повторная синхронизация использует алгоритм фрагментации, то есть разбивает исходный и целевой файлы на фрагменты фиксированного размера.
    - Для каждого фрагмента данных создаются контрольные суммы. Их сравнение позволяет определить, какие из блоков нужно передать от источника к целевому объекту.
2. После завершения повторной синхронизации возобновляется обычная разностная репликация данных.
3. Если вы не хотите ждать времени повторной синхронизации по умолчанию, то можете повторно синхронизировать виртуальную машину вручную. Например, такая потребность может возникнуть в случае сбоя. Для этого на портале Azure выберите виртуальную машину и щелкните **Повторно синхронизир.**

    ![Повторная синхронизация вручную](./media/hyper-v-azure-architecture/image4-site.png)


### <a name="retry-process"></a>Процедура повторных попыток

При ошибке репликации используется встроенный механизм повторных попыток. Повторная попытка классифицируется согласно описанию в таблице.

**Категория** | **Дополнительные сведения**
--- | ---
**Неустранимые ошибки** | Без повторных попыток. Состояние виртуальной машины отображается как **Критическое**, что требует вмешательства администратора.<br/><br/> Это может быть обусловлено неисправной цепочкой виртуальных жестких дисков, недопустимым состоянием реплики виртуальной машины, ошибками проверки подлинности сети, ошибками авторизации и ошибками "Не найдено" для виртуальной машины (для отдельных серверов Hyper-V).
**Устранимые ошибки** | Повторные попытки выполняются в рамках каждого интервала репликации с использованием экспоненциального алгоритма отсрочки, то есть каждая следующая попытка выполняется с большей задержкой (1, 2, 4, 8 и 10 минут). Если проблема не устранена, повторные попытки выполняются каждые 30 минут. Примерами таких ошибок являются сетевые ошибки, нехватка места на диске и нехватка памяти.



## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

1. Вы можете запустить плановую или внеплановую отработку отказа с локальных виртуальных машин Hyper-V в Azure. Чтобы не допустить потери данных при выполнении плановой отработки отказа, выключите исходные виртуальные машины. Вы можете выполнять незапланированную отработку отказа, если основной сайт недоступен.
2. Вы можете выполнить отработку отказа одного компьютера или создать планы восстановления для координации отработки отказа нескольких компьютеров.
3. Вы запускаете отработку отказа. По окончании ее первого этапа в Azure должны отобразиться созданные виртуальные машины реплик. При необходимости виртуальной машине можно назначить общедоступный IP-адрес.
4. Затем требуется зафиксировать отработку отказа для получения доступа к рабочей нагрузке из виртуальной машины реплики Azure.

Восстановив работоспособность локальной инфраструктуры, вы можете восстановить размещение. Восстановление размещения выполняется в три этапа:

1. Запустите плановую отработку отказа из Azure на локальный сайт:
    - **Минимизировать простой**: если выбран этот параметр, Site Recovery синхронизирует данные перед отработкой отказа. Эта система проверяет наличие измененных блоков данных и скачивает их на локальный сайт, при этом виртуальная машина Azure продолжает работать, что сводит время простоя к минимуму. Если вы вручную указываете, что требуется выполнение отработки отказа, завершается работа виртуальной машины Azure, копируются все окончательные разностные изменения и начинается отработка отказа.
    - **Скачать полностью**: при выборе этого параметра данные синхронизируются во время отработки отказа. При этом скачивается весь диск. В этом случае работа идет быстрее, так как не нужно вычислять контрольные суммы, однако увеличивается время простоя. Используйте этот параметр, если вы уже некоторое время работаете с виртуальными машинами Azure реплики или была удалена локальная виртуальная машина.
    - **Создать виртуальную машину**: этот параметр можно выбрать, чтобы восстановить размещение в той же или другой виртуальной машине. Вы можете указать, что системе Site Recovery следует создать виртуальную машину, если она еще не существует.

2. После завершения начальной синхронизации вы решаете выполнить отработку отказа. После ее завершения вы можете войти в локальную виртуальную машину, чтобы проверить, правильно ли работают все компоненты. На портале Azure видно, что виртуальные машины Azure остановлены.
3.  После этого вы фиксируете отработку отказа для завершения и снова получаете доступ к рабочей нагрузке из локальной виртуальной машины.
4. После отработки отказа рабочих нагрузок вы включаете обратную репликацию, чтобы локальные виртуальные машины снова реплицировались в Azure.



## <a name="next-steps"></a>Дополнительная информация


Выполните инструкции [этого руководства](tutorial-prepare-azure.md), чтобы начать работу с Hyper-V для репликации в Azure.


