---
title: "Устранение ошибок и проблем с репликацией из Azure в Azure с помощью Azure Site Recovery | Документация Майкрософт"
description: "Устранение неполадок и ошибок при репликации виртуальных машин Azure для аварийного восстановления"
services: site-recovery
documentationcenter: 
author: sujayt
manager: rochakm
editor: 
ms.assetid: 
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 11/21/2017
ms.author: sujayt
ms.openlocfilehash: 02d68d091cbbe02e1b5b628924ded1c2155f7119
ms.sourcegitcommit: a648f9d7a502bfbab4cd89c9e25aa03d1a0c412b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/22/2017
---
# <a name="troubleshoot-azure-to-azure-vm-replication-issues"></a>Устранение неполадок репликации виртуальных машин из Azure в Azure

В этой статье описаны распространенные проблемы в Azure Site Recovery, которые возникают при репликации и восстановлении виртуальных машин Azure из одного региона в другой, и способы их устранения. Дополнительные сведения о поддерживаемых конфигурациях см. в статье [Azure Site Recovery support matrix for replicating from Azure to Azure](site-recovery-support-matrix-azure-to-azure.md) (Матрица поддержки Azure Site Recovery для репликации виртуальных машин из Azure в Azure).

## <a name="azure-resource-quota-issues-error-code-150097"></a>Проблемы с квотами ресурсов Azure (код ошибки 150097)
Чтобы создать виртуальные машины Azure в целевой области, которую планируется использовать в качестве региона аварийного восстановления, необходимо настроить подписку. Кроме того, подписка должна иметь достаточную квоту для создания виртуальных машин определенного размера. По умолчанию Site Recovery выбирает тот же размер для целевой виртуальной машины, что и для исходной. Если соответствующий размер не поддерживается, автоматически выбирается ближайший возможный. Если подходящий размер, поддерживающий конфигурацию исходной виртуальной машины, отсутствует, появится следующее сообщение об ошибке:

**Код ошибки** | **Возможные причины** | **Рекомендации**
--- | --- | ---
150097<br></br>**Сообщение**: не удалось включить репликацию для этой виртуальной машины VmName. | — Создание виртуальных машин в расположении целевой области может быть запрещено в идентификаторе подписки.</br></br>— Создание виртуальных машин определенных размеров в расположении целевой области может быть запрещено или не иметь достаточную квоту в идентификаторе подписки.</br></br>— Подходящий размер целевой виртуальной машины, соответствующий количеству сетевых адаптеров исходной виртуальной машины (2), не удалось найти для идентификатора подписки в расположении целевой области.| Сведения о том, как в подписке разрешить создание виртуальных машин необходимых размеров в целевом расположении, см. в статье [Запросы на увеличение квоты ядер Resource Manager](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request). После включения повторите неудавшуюся операцию.

### <a name="fix-the-problem"></a>Устранение проблемы
Чтобы разрешить в подписке создание виртуальных машин необходимых размеров в целевом расположении, можно обратиться [в службу выставления счетов в Azure](https://docs.microsoft.com/azure/azure-supportability/resource-manager-core-quotas-request).

Если целевое расположение имеет ограничение емкости, отключите репликацию и включите его в другом расположении, где подписка имеет достаточную квоту, чтобы создать виртуальные машины нужного размера.

## <a name="trusted-root-certificates-error-code-151066"></a>Доверенные корневые сертификаты (код ошибки 151066)

Если на виртуальной машине отсутствуют новейшие доверенные корневые сертификаты, включение репликации может завершиться ошибкой. Без сертификатов проверка подлинности и авторизация вызовов службы Site Recovery из виртуальной машины завершатся сбоем. Появится сообщение об ошибке для невыполненного задания включения репликации Site Recovery.

**Код ошибки** | **Возможная причина** | **рекомендации**;
--- | --- | ---
151066<br></br>**Сообщение**: сбой при выполнении настройки Site Recovery. | Необходимые доверенные корневые сертификаты, используемые для авторизации и проверки подлинности, отсутствуют на компьютере. | — На виртуальной машине под управлением Windows должны быть доверенные корневые сертификаты. Дополнительные сведения см. в статье [Настройка доверенных корневых сертификатов и запрещенных сертификатов](https://technet.microsoft.com/library/dn265983.aspx).<br></br>— Для виртуальных машин под управлением Linux следуйте указаниям по доверенным корневым сертификатам, опубликованным распространителем версий операционной системы Linux.

### <a name="fix-the-problem"></a>Устранение проблемы
**Windows**

Установите все последние обновления Windows на виртуальной машине, чтобы на компьютере присутствовали все доверенные корневые сертификаты. При работе в отключенной среде следуйте стандартной процедуре обновления Windows в вашей организации, чтобы получить сертификаты. Если необходимые сертификаты отсутствуют на виртуальной машине, вызовы к службе Site Recovery завершатся ошибкой по соображениям безопасности.

Выполните стандартный для вашей организации процесс управления обновлениями Windows или обновлениями сертификатов, чтобы получить последние корневые сертификаты и обновленный список отзыва сертификатов на виртуальных машинах.

Чтобы убедиться, что проблема устранена, перейдите на веб-сайт login.microsoftonline.com из браузера на виртуальной машине.

**Linux**

Следуйте инструкциям вашего распространителя Linux, чтобы получить последние доверенные корневые сертификаты и обновленный список отзыва сертификатов на виртуальной машине.

Так как SuSE Linux использует символические ссылки, чтобы получить список сертификатов, сделайте следующее.

1.  Войдите как привилегированный пользователь.

2.  Выполните следующую команду:

      ``# cd /etc/ssl/certs``

3.  Чтобы узнать, есть ли на компьютере сертификат, выпущенный корневым центром сертификации, выполните следующую команду:

      ``# ls VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem``

4.  Если файл не найден, выполните следующие команды:

      ``# wget https://www.symantec.com/content/dam/symantec/docs/other-resources/verisign-class-3-public-primary-certification-authority-g5-en.pem -O VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem``

      ``# c_rehash``

5.  Чтобы создать символьную ссылку с b204d74a.0 -> VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem, выполните следующую команду:

      ``# ln -s  VeriSign_Class_3_Public_Primary_Certification_Authority_G5.pem b204d74a.0``

6.  Проверьте, содержит ли эта команда следующие выходные данные. Если нет, то необходимо создать символьную ссылку.

      ``# ls -l | grep Baltimore
      -rw-r--r-- 1 root root   1303 Apr  7  2016 Baltimore_CyberTrust_Root.pem
      lrwxrwxrwx 1 root root     29 May 30 04:47 3ad48a91.0 -> Baltimore_CyberTrust_Root.pem
      lrwxrwxrwx 1 root root     29 May 30 05:01 653b494a.0 -> Baltimore_CyberTrust_Root.pem``

7. Если символьная ссылка 653b494a.0 отсутствует, используйте следующую команду, чтобы создать ее.

      ``# ln -s Baltimore_CyberTrust_Root.pem 653b494a.0``


## <a name="outbound-connectivity-for-site-recovery-urls-or-ip-ranges-error-code-151037-or-151072"></a>Исходящие подключения для URL-адресов Site Recovery или IP-диапазонов (код ошибки 151037 или 151072)

Чтобы реплика Site Recovery заработала, от виртуальной машины требуется исходящее подключение для конкретного URL-адреса или IP-диапазонов. Если виртуальная машина находится за брандмауэром или использует правила группы безопасности сети (NSG) для управления исходящими подключениями, может появиться сообщение об ошибке:

**Коды ошибок** | **Возможные причины** | **рекомендации**;
--- | --- | ---
151037<br></br>**Сообщение**: не удалось зарегистрировать виртуальную машину Azure в Site Recovery. | — Используется NSG для управления исходящим доступом к виртуальной машине, и требуемые IP-диапазоны не добавлены в список разрешений для исходящего доступа.</br></br>— Используются сторонние средства брандмауэра, и требуемые IP-диапазоны или URL-адреса не добавлены в список разрешений для исходящего доступа.</br>| — Если используется прокси-сервер брандмауэра для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что необходимые URL-адреса или диапазоны IP-адресов центров обработки данных добавлены в список разрешений. Дополнительные сведения см. в разделе [Исходящие подключения для URL-адресов Azure Site Recovery](https://aka.ms/a2a-firewall-proxy-guidance).</br></br>— Если используются правила группы безопасности сети для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что необходимые диапазоны IP-адресов центров обработки данных добавлены в список разрешений. Дополнительные сведения см. в статье [Networking guidance for replicating Azure virtual machines](https://aka.ms/a2a-nsg-guidance) (Руководство по настройке сети для репликации виртуальных машин в Azure).
151072<br></br>**Сообщение**: сбой при выполнении настройки Site Recovery. | Не удается подключиться к конечным точкам службы Site Recovery. | — Если используется прокси-сервер брандмауэра для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что необходимые URL-адреса или диапазоны IP-адресов центров обработки данных добавлены в список разрешений. Дополнительные сведения см. в разделе [Исходящие подключения для URL-адресов Azure Site Recovery](https://aka.ms/a2a-firewall-proxy-guidance).</br></br>— Если используются правила группы безопасности сети для управления исходящими сетевыми подключениями на виртуальной машине, убедитесь, что необходимые диапазоны IP-адресов центров обработки данных добавлены в список разрешений. Дополнительные сведения см. в статье [Networking guidance for replicating Azure virtual machines](https://aka.ms/a2a-nsg-guidance) (Руководство по настройке сети для репликации виртуальных машин в Azure).

### <a name="fix-the-problem"></a>Устранение проблемы
Чтобы внести [необходимые URL-адреса](site-recovery-azure-to-azure-networking-guidance.md#outbound-connectivity-for-azure-site-recovery-urls) или [диапазоны IP-адресов](site-recovery-azure-to-azure-networking-guidance.md#outbound-connectivity-for-azure-site-recovery-ip-ranges) в список разрешений, следуйте указаниям в [документации по настройке сети](site-recovery-azure-to-azure-networking-guidance.md).

## <a name="disk-not-found-in-the-machine-error-code-150039"></a>На компьютере не найден диск (код ошибки 150039)

Необходимо инициализировать новый диск, подключенный к виртуальной машине.

**Код ошибки** | **Возможные причины** | **рекомендации**;
--- | --- | ---
150039<br></br>**Сообщение**: диск данных Azure (имя_диска) (URI_диска) с логическим номером устройства (LUN) (значение_LUN) не был сопоставлен с соответствующим диском из виртуальной машины, о котором сообщается, что он имеет то же значение LUN. | Новый диск с данными был подключен к виртуальной машине, но не был инициализирован.</br></br>Диск с данными в виртуальной машине неправильно сообщает значение LUN, с использованием которого он был подключен к виртуальной машине.| Убедитесь, что диски с данными инициализированы, а затем повторите операцию.</br></br>Для Windows. [Вариант 1. Подключение и инициализация нового диска](https://docs.microsoft.com/azure/virtual-machines/windows/attach-disk-portal#option-1-attach-and-initialize-a-new-disk).</br></br>Для Linux. [Инициализация нового диска данных в Linux](https://docs.microsoft.com/azure/virtual-machines/linux/classic/attach-disk#initialize-a-new-data-disk-in-linux).

### <a name="fix-the-problem"></a>Устранение проблемы
Убедитесь, что диски с данными инициализированы, а затем повторите операцию.

- Для Windows. [Вариант 1. Подключение и инициализация нового диска](https://docs.microsoft.com/azure/virtual-machines/windows/attach-disk-portal#option-1-attach-and-initialize-a-new-disk).
- Для Linux. [Инициализация нового диска данных в Linux](https://docs.microsoft.com/azure/virtual-machines/linux/classic/attach-disk#initialize-a-new-data-disk-in-linux).

Если проблема не исчезнет, обратитесь в службу поддержки.


## <a name="unable-to-see-the-azure-vm-for-selection-in-enable-replication"></a>При включении репликации не видны виртуальные машины Azure для выбора

Если вы не видите виртуальную машину Azure для выбора при включении репликации, возможно, на виртуальной машине Azure осталась устаревшая конфигурация Site Recovery. Устаревшая конфигурация может остаться на виртуальной машине Azure в следующих случаях:

- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем удалили хранилище Site Recovery без явного отключения репликации на виртуальной машине.
- Вы включили репликацию для виртуальной машины Azure с помощью Site Recovery, а затем удалили группу ресурсов, содержащую хранилище Site Recovery, без явного отключения репликации на виртуальной машине.

### <a name="fix-the-problem"></a>Устранение проблемы

Вы можете использовать [скрипт для удаления устаревшей конфигурации ASR](https://gallery.technet.microsoft.com/Azure-Recovery-ASR-script-3a93f412) и удалить устаревшую конфигурацию Site Recovery на виртуальной машине Azure. После удаления устаревшей конфигурации вы увидите виртуальную машину на шаге включения репликации.

## <a name="vms-provisioning-state-is-not-valid-error-code-150019"></a>Недопустимое состояние подготовки Виртуальной машины (код ошибки 150019)

Чтобы включить репликацию на виртуальной Машине, должно быть состояние подготовки **успешно**. Можно проверить состояние виртуальной Машины, выполнив следующие действия.

1.  Выберите **обозреватель ресурсов** из **все службы** на портале Azure.
2.  Разверните **подписки** список и выберите свою подписку.
3.  Разверните **ResourceGroups** и выберите группу ресурсов виртуальной машины.
4.  Разверните **ресурсов** список и выберите свою виртуальную машину
5.  Проверьте **provisioningState** в представлении экземпляра правой стороны.

### <a name="fix-the-problem"></a>Устранение проблемы

- Если **provisioningState** — **сбой**, обратитесь в службу поддержки со сведениями для устранения неполадок.
- Если **provisioningState** — **обновление**, другое расширение удалось начало развернуть. Проверка наличия текущих операций на виртуальной Машине, дождитесь их завершения и повторите неуспешного завершения восстановления сайта **включить репликацию** задания.

## <a name="next-steps"></a>Дальнейшие действия
[Репликация виртуальных машин Azure](azure-to-azure-quickstart.md)
