<properties
	pageTitle="Проектирование сетевой инфраструктуры для аварийного восстановления | Microsoft Azure"
	description="В этой статье обсуждаются особенности проектирования сети для Azure Site Recovery"
	services="site-recovery"
	documentationCenter=""
	authors="prateek9us"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery"
	ms.date="09/19/2016"
	ms.author="pratshar"/>

#  Проектирование сетевой инфраструктуры для аварийного восстановления

Эта статья предназначена для ИТ-специалистов, которые отвечают за проектирование, реализацию и поддержку инфраструктуры непрерывности бизнес-процессов и аварийного восстановления (BCDR) и которые хотят использовать Microsoft Azure Site Recovery (ASR) для поддержки и улучшения служб BCDR. В этом документе обсуждаются практические рекомендации по развертыванию сервера System Center Virtual Machine Manager, преимущества и недостатки растянутых подсетей по сравнению с отработкой отказа подсети и способы организации аварийного восстановления для виртуальных сайтов в Microsoft Azure.

## Обзор

[Azure Site Recovery (ASR)](https://azure.microsoft.com/services/site-recovery/) — это служба Microsoft Azure, отвечающая за оркестрацию защиты и восстановления виртуальных приложений и обеспечивающая аварийное восстановление непрерывности бизнес-процессов (BCDR). В этом документе описывается процесс создания сетей и уделяется внимание проектированию диапазонов IP-адресов и подсетей на сайте аварийного восстановления во время репликации виртуальных машин с помощью Site Recovery.

Кроме того, в этой статье показано, как служба Site Recovery создает условия для проектирования и реализации виртуальных мультисайтовых центров данных, которые поддерживают службы BCDR во время тестирования или аварийных ситуаций.

В современном мире, где каждому пользователю требуется бесперебойное круглосуточное подключение, постоянная работоспособность приложений и инфраструктуры важна как никогда. Целью непрерывности бизнес-процессов и аварийного восстановления является восстановление неисправных компонентов, которое позволяет организации быстро возобновить нормальную работу. Разработка стратегии аварийного восстановления, которая будет применяться в случае маловероятных разрушительных сбоев, — чрезвычайно сложная задача. Это связано с высокой стоимостью адекватных мер защиты от масштабных катастроф и с тем, что очень сложно предсказать будущее, особенно маловероятные события.

Для планирования BCDR очень важно, чтобы целевое время восстановления (RTO) и целевая точка восстановления (RPO) были определены в рамках плана аварийного восстановления. Если в центре обработки данных клиента возникнет сбой, с помощью Azure Site Recovery клиент сможет быстро (низкое значение RTO) подключить к сети реплицированные виртуальные машины, размещенные в дополнительном центре обработки данных или в Microsoft Azure с минимальными потерями данных (низкое значение RPO).

Отработка отказа становится возможной благодаря службе ASR, которая с самого начала копирует указанные виртуальные машины из основного центра обработки данных в дополнительный центр обработки данных или в Azure (в зависимости от сценария) и периодически обновляет реплики. При планировании инфраструктуры следует рассматривать проект сети как потенциально уязвимое место, которое может помешать достичь целевых значений RTO и RPO, установленных в компании.

Когда администраторы планируют развертывание решения для аварийного восстановления, они должны в первую очередь решить, как будет осуществляться доступ к виртуальной машине после отработки отказа. ASR позволяет администратору выбрать сеть, к которой будет подключена виртуальная машина после отработки отказа. Если первичный сайт находится под управлением сервера VMM, то для такого выбора используется сетевое сопоставление. Для получения дополнительных сведений обратитесь к разделу [Подготовка сетевого сопоставления](site-recovery-network-mapping.md).

При проектировании сети для сайта восстановления администратор может выбрать один из следующих вариантов.

- Использование другого диапазона IP-адресов для сети на сайте восстановления. В этом сценарии виртуальная машина после отработки отказа получит новый IP-адрес, и администратор должен будет выполнить обновление DNS. Дополнительную информацию об обновлении DNS см. [здесь](site-recovery-vmm-to-vmm.md#test-your-deployment).
- Использование того же диапазона IP-адресов для сети на сайте восстановления. В некоторых случаях администраторы предпочитают даже после отработки отказа сохранять IP-адреса, которые они использовали на основном сайте. В стандартном сценарии администратор должен будет обновить маршруты, чтобы указать новое расположение IP-адресов. Но в сценарии с использованием растянутой виртуальной локальной сети, развернутой между основным и дополнительным сайтами восстановления, сохранение IP-адресов для виртуальных машин становится привлекательным вариантом. Сохранение тех же IP-адресов упрощает процесс восстановления, так как в этом случае после отработки отказа не требуются дополнительные действия, связанные с настройкой сети.


Когда администраторы планируют развертывание решения для аварийного восстановления, они должны в первую очередь решить, как будет осуществляться доступ к приложениям после отработки отказа. Современным приложениям практически всегда требуется доступ к сети. Следовательно, физическое перемещение службы с одного сайта на другой может представлять проблему для сети. Решения аварийного восстановления могут устранить эту проблему двумя основными способами. Первый подход заключается в поддержке фиксированных IP-адресов. Несмотря на перенос служб и размещение серверов в разных физических местоположениях, приложения сохраняют IP-адреса в их в новом расположении. Второй подход требует полной замены IP-адресов во время перехода на сайт восстановления. Каждый подход имеет несколько вариантов реализации, которые приведены ниже.

При проектировании сети для сайта восстановления администратор может выбрать один из следующих вариантов.

## Вариант 1. Сохранение IP-адресов 

С точки зрения процесса аварийного восстановления использование фиксированных IP-адресов кажется наиболее простым способом, но он может привести к ряду проблем, поэтому на практике используется редко. Azure Site Recovery предоставляет возможность сохранять IP-адреса во всех сценариях. Прежде чем пользователь решит сохранить IP-адреса, он должен оценить ограничения для отработки отказа, которые создаст это сохранение. Рассмотрим факторы, которые помогут решить, сохранять IP-адреса или нет. Это можно сделать двумя способами: с помощью растянутой подсети или полной отработкой отказа в подсеть.

### Растянутая подсеть

В этом сценарии подсеть становится доступной одновременно в основном расположении и в расположении аварийного восстановления. Проще говоря, это означает, что вы можете переместить сервер и его IP-конфигурацию (уровень 3) на дополнительный сайт, а сеть направит трафик в новое местоположение автоматически. Это является простейшей задачей с точки зрения сервера, но несет с собой ряд проблем.

- С точки зрения уровня 2 (уровень канала передачи данных) требуется сетевое оборудование, которое может управлять растянутой виртуальной локальной сетью, но это больше не проблема, так как это оборудование общедоступно. Вторая, более сложная проблема заключается в том, что при растягивании виртуальной локальной сети потенциальный домен сбоя распространяется на оба сайта, которые фактически становятся единой точкой отказа. Хотя это маловероятно, может произойти сетевая буря, которую не удастся изолировать. Мы встречали различные мнения о такой проблеме и видели множество успешных решений, в том числе "мы никогда не будем использовать эту топологию здесь".
- Растянутую подсеть нельзя реализовать, если вы используете Microsoft Azure как сайт аварийного восстановления.


### Отработка отказа подсети

Чтобы пользоваться преимуществами решения растянутой сети, описанными выше, без растягивания подсети на несколько сайтов, можно применить отработку отказа подсети. В этом сценарии любая отдельно взятая подсеть будет присутствовать на сайте 1 или 2, но никогда на обоих сайтах одновременно. Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой. В случае отработки отказа подсети перемещаются вместе со связанными с ними защищенными виртуальными машинами. Основной недостаток этого подхода: в случае сбоя необходимо переместить всю подсеть, что, возможно, и является приемлемым решением, но может повлиять на степень детализации отработки отказа.

Рассмотрим, как вымышленное предприятие Contoso может реплицировать свои виртуальные машины в предназначенное для восстановления расположение, переключив при этом всю подсеть. Сначала посмотрим, как Contoso сможет управлять своими подсетями во время репликации виртуальных машин между двумя локальными расположениями. Затем обсудим, как происходит отработка отказа подсетей [при использовании Azure в качестве сайта аварийного восстановления](#failover-to-azure).

#### Отработка отказа на дополнительный локальный сайт

Рассмотрим сценарий, в котором необходимо сохранить IP-адрес каждой виртуальной машины и переключить всю подсеть полностью. На основном объекте приложения работают в подсети 192.168.1.0/24. Когда происходит отработка отказа, все виртуальные машины подсети переключаются на сайт восстановления с сохранением своих IP-адресов. Необходимо соответственно изменить маршруты, учитывая, что все виртуальные машины, принадлежащие к подсети 192.168.1.0/24, перемещены на сайт восстановления.

На рисунке ниже маршруты между основным сайтом и сайтом восстановления, третьим сайтом и основным сайтом, а также третьим сайтом и сайтом восстановления необходимо изменить соответствующим образом.

На следующих рисунках показаны подсети до отработки отказа. Подсеть 192.168.0.1/24 активна на основном сайте до отработки отказа и становится активной на сайте восстановления после отработки отказа.

![Перед выполнением отработки отказа](./media/site-recovery-network-design/network-design2.png)

Перед выполнением отработки отказа


На рисунке ниже показаны сети и подсети после отработки отказа.
	
![После выполнения отработки отказа](./media/site-recovery-network-design/network-design3.png)

После выполнения отработки отказа

Если вторичный сайт является локальным и для управления им используется сервер VMM, то при включении защиты для конкретной виртуальной машины ASR выделит сетевые ресурсы в соответствии со следующим рабочим процессом:

- ASR выделяет IP-адреса для каждого сетевого интерфейса на виртуальной машине из пула статических IP-адресов, определенного в соответствующей сети для каждого экземпляра System Center VMM.
- Если администратор определяет для сети на сайте восстановления тот же пул IP-адресов, который используется в сети основного сайта, и при этом выделяет IP-адрес реплике виртуальной машины, ASR выделит тот же IP-адрес, что и у основной виртуальной машины. Этот IP-адрес зарезервирован в VMM, но не задан как IP-адрес отработки отказа. IP-адрес отработки отказа задается непосредственно перед отработкой отказа.

![Сохранение IP-адреса](./media/site-recovery-network-design/network-design4.png)
	
Рис. 5

На рис. 5 показаны параметры TCP/IP отработки отказа для реплики виртуальной машины (на консоли Hyper-V). Эти параметры будут заполняться непосредственно перед запуском виртуальной машины после отработки отказа.

Если тот же IP-адрес недоступен, ASR выделит другой доступный IP-адрес из определенного пула IP-адресов.

После включения защиты виртуальной машины вы сможете использовать следующий пример скрипта для проверки IP-адреса, назначенного виртуальной машине. Тот же IP-адрес будет задан в качестве IP-адреса отработки отказа и назначен виртуальной машине во время отработки отказа.

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

>[AZURE.NOTE] В сценарии, в котором виртуальные машины используют DHCP, управление IP-адресами не зависит от ASR. Администратор должен убедиться, что DHCP-сервер, предоставляющий IP-адреса на сайте восстановления, может назначать адреса из того же диапазона, который используется на основном сайте.

#### Отработка отказа в Azure

Azure Site Recovery (ASR) позволяет использовать Microsoft Azure в качестве сайта аварийного восстановления для виртуальных машин. В этом случае вы столкнетесь с еще одним ограничением.

Рассмотрим следующий сценарий. Вымышленная компания Woodgrove Bank размещает свои бизнес-приложения в локальной инфраструктуре, а мобильные приложения — в Azure. Подключение между виртуальными машинами Woodgrove Bank в Azure и локальными серверами обеспечивается через VPN-подключение типа "сеть — сеть". Благодаря подключению такого типа виртуальная сеть Woodgrove Bank рассматривается в Azure как расширение локальной сети Woodgrove Bank. Это взаимодействие обеспечивается VPN-подключением типа "сеть — сеть" между границей Woodgrove Bank и виртуальной сетью Azure. Теперь компания Woodgrove хочет использовать ASR для репликации рабочих нагрузок, выполняющихся в ее центре обработки данных, в Azure. Этот вариант соответствует требованиям компании Woodgrove, так как она хочет использовать экономичный вариант аварийного восстановления, при котором данные сохраняются в общедоступном облаке. В компании Woodgrove используются приложения и конфигурации, зависящие от жестко заданных IP-адресов, поэтому необходимо сохранить IP-адреса для приложений после отработки отказа в Azure.

Компания Woodgrove решила назначить IP-адреса из диапазона IP-адресов (172.16.1.0/24, 172.16.2.0/24) своим ресурсам в Azure.

Чтобы компания Woodgrove могла реплицировать свои виртуальные машины в Azure, сохраняя IP-адреса, необходимо создать виртуальную сеть Azure. Она должна быть расширением локальной сети, чтобы приложения могли легко переключаться с локального сайта в Azure. Azure позволяет добавлять VPN-подключения "сеть — сеть" и "точка — сеть" к виртуальным сетям, созданным в Azure. При настройке подключения "сеть — сеть" сеть Azure позволяет направить трафик в локальное расположение (в Azure оно называется "локальное расположение — сеть") только в том случае, если диапазон IP-адресов отличается от диапазона IP-адресов локальной сети, так как Azure не поддерживает растягивание подсетей. Это означает, что при наличии локальной подсети 192.168.1.0/24 нельзя добавить локальную сеть 192.168.1.0/24 в сеть Azure. Это происходит, поскольку Azure не знает, что в подсети нет активных виртуальных машин и что подсеть создается только в целях аварийного восстановления данных. Чтобы иметь возможность правильно направлять сетевой трафик из сети Azure, подсети в локальной сети и сети не должны конфликтовать.

![Перед выполнением отработки отказа подсети](./media/site-recovery-network-design/network-design7.png)

Перед выполнением отработки отказа

Чтобы компания Woodgrove могла выполнять свои задачи, нам нужно реализовать следующие рабочие процессы.

- Создайте дополнительную сеть (назовем ее сетью восстановления), в которой будут создаваться виртуальные машины после отработки отказа.
- Чтобы убедиться, что IP-адрес для виртуальной машины сохраняется после отработки отказа, откройте вкладку "Настройка" в разделе свойств виртуальной машины, укажите тот же IP-адрес, который использовался на виртуальной машине в локальной сети, и нажмите кнопку "Сохранить". При отработке отказа виртуальной машины служба Azure Site Recovery назначит указанный IP-адрес виртуальной машине.

![Свойства сети](./media/site-recovery-network-design/network-design8.png)

Когда будет активирована отработка отказа, а виртуальные машины будут созданы в сети восстановления с требуемым IP-адресом, к этой сети можно будет подключиться с помощью [подключения "виртуальная сеть — виртуальная сеть"](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md). При необходимости это действие можно включить в скрипт. Как уже говорилось в предыдущем разделе об отработке отказа подсети, даже в случае отработки отказа в Azure маршруты необходимо будет соответствующим образом изменить, чтобы отразить тот факт, что подсеть 192.168.1.0/24 теперь перемещена в Azure.

![После выполнения отработки отказа подсети](./media/site-recovery-network-design/network-design9.png)

После выполнения отработки отказа

При отсутствии "Сети Azure", как показано на рисунке выше, можно сделать следующее. Можно создать VPN-подключение "сайт-сайт" между основным сайтом и сетью восстановления после отработки отказа.


## Вариант 2. Изменение IP-адресов

Этот подход, по нашим наблюдениям, является наиболее распространенным. Он представляет собой изменение IP-адреса каждой виртуальной машины, которая участвует в отработке отказа. Недостаток этого подхода: сеть, из которой поступает входящий трафик, должна "понимать", что приложение, которое находилось по адресу IPx, теперь находится по адресу IPy. Даже если IPx и IPy — это логические имена, обычно требуется изменить или освободить DNS-записи во всей сети, а также обновить или освободить кэшированные записи в таблицах сети, поэтому возможен простой, длительность которого зависит от настроек инфраструктуры DNS. Частично этих проблем можно избежать за счет использования низких значений TTL в случае с приложениями интрасети и при использовании [диспетчера трафика Azure с ASR](http://azure.microsoft.com/blog/2015/03/03/reduce-rto-by-using-azure-traffic-manager-with-azure-site-recovery/) для интернет-приложений.

### Изменение IP-адресов — пример

Рассмотрим сценарий, когда вы планируете использовать разные IP-адреса на основном сайте и сайте восстановления. В следующем примере присутствует третий сайт, с которого можно получить доступ к приложениям, расположенным на основном сайте или сайте восстановления.

![Другой IP-адрес — до отработки отказа](./media/site-recovery-network-design/network-design10.png)

Рис. 11.

На рис. 11 некоторые приложения, размещенные в подсети 192.168.1.0/24 на основном сайте, были настроены для запуска на сайте восстановления в подсети 172.16.1.0/24 после отработки отказа. VPN-подключения/сетевые маршруты были настроены так, чтобы все три объекта могли иметь доступ друг к другу.
 
На рис. 12 показано, что после отработки отказа одного или нескольких приложений они будут восстановлены в подсети восстановления. В этом случае мы не будем привязываться к отработке отказа всей подсети одновременно. Для повторной настройки сетевых маршрутов или маршрутов VPN никакие изменения не требуются. Отработка отказа и некоторые обновления DNS обеспечат доступность приложений. Если в DNS разрешены динамические обновления, виртуальные машины будут регистрироваться, используя новый IP-адрес, при запуске после отработки отказа.

![Другой IP-адрес — после отработки отказа](./media/site-recovery-network-design/network-design11.png)

Рис. 12.

После отработки отказа реплика виртуальной машины может иметь IP-адрес, не совпадающий с IP-адресом основной виртуальной машины. Виртуальные машины обновят используемый DNS-сервер после запуска. Записи DNS обычно должны быть изменены или сброшены во всей сети, а кэшированные записи в сетевых таблицах должны быть обновлены или сброшены, поэтому при изменении данных состояний простой возникает нередко. Эту проблему можно решить следующим образом.

- Использование низких значений TTL для приложений интрасети.
- Использование диспетчера трафика Azure с ASR для интернет-приложений.
- С помощью следующего скрипта в плане восстановления для обновления DNS-сервера, чтобы обеспечить своевременное обновление (скрипт не требуется, если настроена динамическая регистрация DNS)

		string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord


### Изменение IP-адресов — аварийное восстановление в Azure

В публикации блога [Настройка инфраструктуры сети для Microsoft Azure как сайта аварийного восстановления](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) объясняется, как настроить необходимую сетевую инфраструктуру Azure, если сохранение IP-адресов не является обязательным требованием. Публикация начинается с описания приложения, затем в ней объясняется, как настроить сеть локально и в Azure, а в завершение приводятся инструкции по выполнению тестовой и плановой отработки отказа.



## Дальнейшие действия

[Узнайте](site-recovery-network-mapping.md), как Site Recovery сопоставляет исходную и целевую сети при использовании сервера VMM для управления на первичном сайте.

<!---HONumber=AcomDC_0921_2016-->