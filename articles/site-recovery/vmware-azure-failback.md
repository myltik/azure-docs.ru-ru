---
title: Восстановление размещения из Azure в VMware с помощью Azure Site Recovery | Документация Майкрософт
description: После отработки отказа виртуальных машин в Azure можно запустить восстановление размещения, чтобы вернуть их в локальную среду. Узнайте, как выполнить восстановление размещения.
services: site-recovery
author: nsoneji
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 03/05/2018
ms.author: nisoneji
ms.openlocfilehash: 8f580fa40bade2bf586dd116729881b249bbba88
ms.sourcegitcommit: 8aab1aab0135fad24987a311b42a1c25a839e9f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/16/2018
ms.locfileid: "29944013"
---
# <a name="fail-back-from-azure-to-an-on-premises-site"></a>Восстановление размещения из Azure на локальный сайт

В этой статье описывается, как восстановить размещение виртуальных машин из Azure в локальную среду VMware. Следуйте инструкциям, изложенным в этой статье, чтобы восстановить размещение виртуальных машин VMware или физических серверов Windows и Linux, отработка отказа которых выполнена c локального сайта в Azure (см. руководство [Отработка отказа в Site Recovery](site-recovery-failover.md)).

## <a name="prerequisites"></a>предварительным требованиям
- Обязательно прочтите подробные сведения о [различных видах восстановления размещения](concepts-types-of-failback.md) и соответствующие предупреждения.

> [!WARNING]
> Если вы [выполнили миграцию](migrate-overview.md#what-do-we-mean-by-migration), переместили виртуальную машину в другую группу ресурсов или удалили виртуальную машину Azure, то после этого невозможно выполнить восстановление размещения. Если вы отключили защиту виртуальной машины, то не сможете восстановить размещение.

> [!WARNING]
> Если защищенный физический сервер под управлением Windows Server 2008 R2 с пакетом обновления 1 (SP1) выполнил отработку отказа в Azure, то его нельзя восстановить в исходном расположении.

> [!NOTE]
> Если вы выполнили отработку отказа виртуальных машин VMware, то восстановить размещение на узле Hyper-V нельзя.


- Прежде чем продолжить, включите повторно защиту, чтобы запустить репликацию виртуальных машин и иметь возможность запустить отработку отказа обратно на локальный сайт. Дополнительные сведения см. в статье [Повторное включение защиты: Azure — локальная среда](vmware-azure-reprotect.md).

- Перед восстановлением размещения убедитесь, что сервер vCenter подключен. В противном случае отключение дисков и их присоединение к виртуальной машине завершится сбоем.

- Во время отработки отказа в Azure локальный сайт может стать недоступным, поэтому сервер конфигурации может быть недоступен или отключен. Во время повторной защиты и восстановления размещения локальный сервер конфигурации должен быть запущен и корректно подключен. 

- Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации, иначе восстановление не будет успешным. Обеспечьте регулярное плановое резервное копирование сервера. В случае аварии необходимо восстановить сервер с исходным IP-адресом, чтобы обеспечить восстановление размещения.

- На главном целевом сервере не должно быть моментальных снимков перед активацией повторной защиты или восстановления размещения.

## <a name="overview-of-failback"></a>Общие сведения о восстановлении размещения
Восстановление размещения на локальном сайте после отработки отказа в Azure происходит в несколько этапов.

1. [Включите повторную защиту](vmware-azure-reprotect.md) виртуальных машин в Azure, чтобы начать репликацию виртуальных машин VMware на локальный сайт. В рамках этого процесса также потребуется сделать следующее:

    * Настроить локальный главный целевой сервер. Используйте главный целевой сервер под управлением Windows для виртуальных машин Windows и [под управлением Linux](vmware-azure-install-linux-master-target.md) для виртуальных машин Linux.
    * Настроить [сервер обработки](vmware-azure-set-up-process-server-azure.md).
    * Запустить [повторное включение защиты](vmware-azure-reprotect.md), чтобы отключить локальную виртуальную машину и синхронизировать данные виртуальной машины Azure с локальными дисками.

2. После репликации виртуальных машин из Azure на локальный сайт запустите отработку отказа из Azure на локальный сайт.

3. После восстановления размещения данных повторно включите защиту локальных виртуальных машин, чтобы начать их репликацию в Azure.

Просмотрите видео ниже, чтобы получить общее представление о том, как выполнить восстановление размещения из Azure на локальный сайт.
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="steps-to-fail-back"></a>Инструкции по восстановлению размещения

> [!IMPORTANT]
> Перед запуском восстановления размещения обязательно повторно включите защиту виртуальных машин. Виртуальные машины должны быть защищенными и находиться в **рабочем** состоянии. Сведения о повторной защите виртуальных машин см. в [этой статье](vmware-azure-reprotect.md).

1. На странице "Реплицированные элементы" выберите виртуальную машину. Щелкните правой кнопкой мыши и выберите **Внеплановая отработка отказа**.
2. На странице **Подтверждение отработки отказа** должно быть указано направление отработки отказа "Из Azure". Затем выберите точку восстановления (последнюю или последнюю, согласованную с приложением), до которой будет выполняться отработка отказа. Точка, согласованная с приложением, следует за последней точкой во времени, что приведет к потере некоторых данных.
3. Во время отработки отказа служба Site Recovery завершает работу виртуальных машин в Azure. Если восстановление размещения выполнено правильно, вы можете убедиться, что работа виртуальных машин в Azure завершена.
4. Чтобы удалить из Azure виртуальную машину, для которой выполнена отработка отказа, необходимо выполнить **фиксацию**. Щелкните защищенный элемент правой кнопкой мыши и выберите **Применить**. Задание удалит из Azure виртуальные машины, для которых была выполнена отработка отказа.


## <a name="to-what-recovery-point-can-i-fail-back-the-virtual-machines"></a>До какой точки можно восстановить размещение виртуальных машин?

Вы можете выполнить восстановление размещения виртуальной машины (план восстановления) двумя способами.

- Если выбрать последнюю обработанную точку во времени, для всех виртуальных машин будет выполнена отработка отказа до их последней доступной точки во времени. Если в плане восстановления есть группа репликации, для каждой виртуальной машины в группе репликации будет выполнена отработка отказа до ее собственной последней точки во времени.

  Нельзя восстановить размещение виртуальной машины, если у нее нет ни одной точки восстановления. Нельзя восстановить размещение плана восстановления, если каждая из его виртуальных машин не содержит хотя бы одну точку восстановления.

  > [!NOTE]
  > Последняя точка восстановления является согласованной точкой восстановления после сбоя.

- Если выбрать согласованную точку восстановления приложения, восстановление размещения одной виртуальной машины будет выполнено до последней доступной согласованной точки в приложении. Если выполняется план восстановления для группы репликации, восстановление будет выполнено до общей доступной точки восстановления.
Согласованные с приложением точки восстановления могут быть позднее по времени. Из-за этого может произойти потеря данных.

## <a name="what-happens-to-vmware-tools-post-failback"></a>Что происходит со средствами VMware после восстановления размещения?

При использовании виртуальной машины Azure Site Recovery отключает инструменты VMware во время отработки отказа. При восстановлении размещения виртуальной машины Windows инструменты VMware снова включаются. 


## <a name="reprotect-from-on-premises-to-azure"></a>Повторное включение защиты из локальной среды в Azure
После того как вы выполните восстановление размещения и начнете операцию фиксации, восстановленные виртуальные машины в Azure будут удалены. Теперь виртуальная машина снова окажется на локальном сайте, но не будет защищена. Чтобы снова начать репликацию в Azure, сделайте следующее.

1. Щелкните **Хранилище** > **Настройка** > **Реплицированные элементы**, а затем выберите виртуальные машины, для которых выполнено восстановление размещения, и нажмите кнопку **Защитить повторно**.
2. Укажите сервер обработки, который необходимо использовать для отправки данных обратно в Azure.
3. Нажмите кнопку **ОК**, чтобы запустить задание повторной защиты.

> [!NOTE]
> После загрузки виртуальной машины в локальной среде потребуется некоторое время для повторной регистрации агента на сервере конфигурации (не более 15 минут). Если включить повторную защиту в течение этого времени, произойдет сбой и на экране отобразится сообщение о том, что агент не установлен. Подождите несколько минут, а затем включите повторную защиту еще раз.

## <a name="next-steps"></a>Дополнительная информация

Когда задание повторной защиты завершится, возобновится репликация виртуальной машины в Azure, и вы сможете выполнить [отработку отказа](site-recovery-failover.md), чтобы снова переместить виртуальную машину.


