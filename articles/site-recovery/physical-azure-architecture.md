---
title: Архитектура репликации с физического сервера в Azure Site Recovery | Документация Майкрософт
description: В этой статье представлен обзор компонентов и архитектуры, используемых при репликации физических серверов из локальной среды в Azure с помощью службы Azure Site Recovery.
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 03/09/2018
ms.author: raynew
ms.openlocfilehash: a8af2ee4a32925603d24aee2403ab504a0ca05a8
ms.sourcegitcommit: a0be2dc237d30b7f79914e8adfb85299571374ec
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2018
ms.locfileid: "29874898"
---
# <a name="physical-server-to-azure-replication-architecture"></a>Архитектура для репликации физического сервера в Azure

Эта статья описывает архитектуру и процессы, используемые при репликации, отработке отказа и восстановлении физических серверов Windows и Linux между локальным сайтом и Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).


## <a name="architectural-components"></a>Компоненты архитектуры

Таблица и рисунок ниже позволяют получить общее представление о компонентах, используемых для репликации физических серверов в Azure.  

**Компонент** | **Требование** | **Дополнительные сведения**
--- | --- | ---
**Таблицы Azure** | Подписка Azure, учетная запись хранения Azure и сеть Azure. | Реплицированные данные из локальных ВМ хранятся в учетной записи хранения. Виртуальные машины Azure создаются с использованием реплицированных данных при запуске отработки отказа из локальной среды в Azure. При создании виртуальные машины Azure подключаются к виртуальной сети Azure.
**Сервер конфигурации** | Отдельный локальный физический компьютер или виртуальная машина VMware развертываются для выполнения всех локальных компонентов Site Recovery. На этой виртуальной машине выполняется сервер конфигурации и обработки, а также главный целевой сервер. | Сервер конфигурации используется для управления обменом данными между локальным источником и Azure, а также репликацией данных.
 **Сервер обработки**  | По умолчанию устанавливается вместе с сервером конфигурации. | Выступает в качестве шлюза репликации. Получает данные репликации, оптимизирует их путем кэширования, сжатия и шифрования и отправляет эти данные в службу хранилища Azure.<br/><br/> Сервер обработки также устанавливает службу Mobility Service на серверах, которые требуется реплицировать.<br/><br/> По мере увеличения масштаба развертывания вы можете добавлять дополнительные отдельные серверы для обработки растущего объема данных репликации.
 **Главный целевой сервер** | По умолчанию устанавливается вместе с сервером конфигурации. | Обрабатывает данные репликации при восстановлении размещения с переносом из Azure.<br/><br/> Для крупных развертываний вы можете добавить отдельный главный целевой сервер для восстановления размещения.
**Реплицированные серверы** | Служба Mobility Service устанавливается на каждом реплицируемом сервере. | Рекомендуем разрешить автоматическую установку с сервера обработки. Кроме того, вы можете установить службу вручную или использовать средство автоматического развертывания, такое как System Center Configuration Manager.

**Архитектура: репликация физических компьютеров в Azure**

![Компоненты](./media/physical-azure-architecture/arch-enhanced.png)

## <a name="replication-process"></a>Процесс репликации

1. Необходимо настроить развертывание, в том числе локальные компоненты и компоненты Azure. В хранилище служб восстановления нужно указать источник и целевой объект репликации, настроить сервер конфигурации, создать политику репликации и включить репликацию.
2. Компьютеры выполняют репликацию в соответствии с политикой репликации, а репликация начальной копии данных сервера выполняется в службу хранилища Azure.
3. После завершения начальной репликации начинается репликация разностных изменений в Azure. Отслеживаемые изменения для компьютера хранятся в HRL-файле.
    - Компьютеры обмениваются данными с сервером конфигурации через порт HTTPS 443 для входящих подключений, чтобы управлять репликацией.
    - Компьютеры отправляют данные репликации на сервер обработки через порт HTTPS 9443 для входящих подключений (можно изменить).
    - Сервер конфигурации выполняет оркестрацию управления репликацией с Azure через порт HTTPS 443 для исходящих подключений.
    - Сервер обработки получает данные с исходных компьютеров, оптимизирует и зашифровывает их, а затем отправляет их в службу хранилища Azure через порт 443 для исходящих подключений.
    - Если включить согласованность между виртуальными машинами, компьютеры в группе репликации будут обмениваться данными друг с другом через порт 20004. Эту функция используется, если вы объединяете несколько компьютеров в группы репликации, и они совместно используют отказоустойчивые и согласованные точки восстановления после отработки отказа. Это полезно, если на компьютерах выполняется одна и та же рабочая нагрузка и они должны быть согласованы.
4. Трафик реплицируется в общедоступные конечные точки службы хранилища Azure через Интернет. Кроме того, можно использовать [общедоступный пиринг](../expressroute/expressroute-circuit-peerings.md#azure-public-peering) Azure ExpressRoute. Репликация трафика через VPN типа "сеть — сеть" с локального сайта в Azure не поддерживается.


**Процедура репликации физических компонентов в Azure**

![Процесс репликации](./media/physical-azure-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>Процесс отработки отказа и восстановления размещения

Настроив репликацию и выполнив отработку аварийного восстановления (тестовая отработка отказа) для проверки правильности работы всех компонентов, вы можете запустить отработку отказа и восстановление размещения по мере необходимости. Обратите внимание на следующее.

- Плановая отработка отказа не поддерживается.
- Размещение следует восстанавливать на локальную виртуальную машину VMware. Это означает, что даже при репликации локальных физических серверов в Azure требуется локальная инфраструктура VMware.
- Выполните отработку отказа одного компьютера или создайте планы восстановления, чтобы выполнить отработку отказа нескольких компьютеров.
- При выполнении отработки отказа из реплицированных данных создаются виртуальные машины Azure в службе хранилища Azure.
- После активации начальной отработки отказа выполняется ее фиксация для получения доступа к рабочей нагрузке из виртуальной машины Azure.
- Когда основной локальный сайт снова станет доступным, вы сможете выполнить восстановление размещения.
- Вам следует настроить инфраструктуру восстановления размещения, включая следующее:
    - **Временный сервер обработки в Azure**. Чтобы восстановить размещение из Azure, настройте виртуальную машину Azure как сервер обработки. Это позволит выполнять репликацию из Azure. После восстановления размещения эту виртуальную машину можно удалить.
    - **VPN-подключение**. Для восстановления размещения нужно настроить VPN-подключение (или Azure ExpressRoute) между сетью Azure и локальным сайтом.
    - **Отдельный главный целевой сервер**. По умолчанию главный целевой сервер, установленный вместе с сервером конфигурации на локальной виртуальной машине VMware, обрабатывает восстановление размещения. Однако при восстановлении размещения больших объемов трафика настройте отдельный локальный главный целевой сервер.
    - **Политика восстановления размещения.** Для репликации обратно на локальный сайт необходима политика восстановления размещения. Она была создана автоматически при создании политики репликации из локальной среды в Azure.
    - **Инфраструктура VMware**. Для восстановления размещения требуется инфраструктура VMware. Восстанавливать размещение на физический сервер нельзя.
- После готовности всех компонентов восстановление размещения выполняется в три этапа:
    - Этап 1. Повторно включите защиту виртуальных машин Azure, чтобы обеспечить их репликацию из Azure в локальные виртуальные машины VMware.
    - Этап 2. Запустите отработку отказа на локальном сайте.
    - Этап 3. После отработки отказа рабочих нагрузок повторно включите репликацию.

**Восстановление размещения VMware с переносом из Azure**

![Восстановление размещения](./media/physical-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>Дополнительная информация

Выполните инструкции из [этого руководства](physical-azure-disaster-recovery.md), чтобы включить репликацию с физического сервера в Azure.
