---
title: "Планирование сетей для Hyper-V (с использованием System Center VMM) для репликации в Azure с помощью Azure Site Recovery | Документация Майкрософт"
description: "В этой статье рассматривается планирование сетей, необходимое при репликации виртуальных машин Hyper-V (с использованием VMM) в Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 41c3c83e-6b1a-496a-8179-498c552ef0c7
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 07/23/2017
ms.author: raynew
ms.translationtype: HT
ms.sourcegitcommit: 74b75232b4b1c14dbb81151cdab5856a1e4da28c
ms.openlocfilehash: ef87cd82b021e40f0da05142878daff245cd9c62
ms.contentlocale: ru-ru
ms.lasthandoff: 07/26/2017

---

# <a name="step-4-plan-networking-for-hyper-v-with-vmm-to-azure-replication"></a>Шаг 4. Планирование сетей для репликации из Hyper-V (с VMM) в Azure

После [планирования ресурсов](vmm-to-azure-walkthrough-capacity.md) (при полном развертывании) ознакомьтесь с этой статьей. Здесь содержатся рекомендации по планированию сети при репликации локальных виртуальных машин Hyper-V в облаках System Center Virtual Machine Manager (VMM) в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md).

Все комментарии можно добавить в конце этой статьи. Вопросы можно задать на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="network-mapping-for-replication-to-azure"></a>Сопоставления сетей для репликации в Azure

Сетевое сопоставление используется при репликации виртуальных машин Hyper-V (управляемых в VMM) в Azure. При сетевом сопоставлении сопоставляются сети виртуальных машин, на исходном сервере VMM, и целевые сети Azure. Это предоставляет следующие возможности:

- **Сетевое подключение.** После отработки отказа все реплицированные виртуальные машины Azure подключаются к сопоставленной сети Azure. Все компьютеры, перешедшие в состояние отказа в одной и той же сети, могут подключиться друг к другу, даже если отработка отказа в рамках разных планов восстановления.
- **Сетевой шлюз.** Если в целевой сети Azure настроен сетевой шлюз, виртуальные машины смогут подключаться к другим локальным виртуальным машинам в сопоставленной локальной сети.

### <a name="prepare-vmm-for-network-mapping"></a>Подготовка VMM к сопоставлению сети

Подготовьте VMM к сопоставлению сетей следующим образом:

1. Подготовьте [логическую сеть VMM](https://docs.microsoft.com/system-center/vmm/network-logical) (при ее отсутствии), связанную с облаком, в котором находятся узлы Hyper-V.
2. Создайте [сеть виртуальной машины](https://docs.microsoft.com/system-center/vmm/network-virtual) (если ее нет), связанную с логической сетью, подготовленной ранее.
3. Подключите виртуальные машины на сервере или кластере узлов Hyper-V в облаке VMM к сети виртуальной машины.

 
Обратите внимание на следующее. 
- Новые виртуальные машины, добавленные к исходной сети виртуальных машин, будут подключены к сопоставленной сети Azure после репликации.
- Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины подключается к этой целевой подсети после отработки отказа.
- Если подсети с таким же именем отсутствуют, виртуальная машина подключается к первой подсети в сети.
- Подготовка сети Azure и настройка сопоставления сетей осуществляется при развертывании сценария.

## <a name="connecting-to-azure-vms-after-failover"></a>Подключение к виртуальным машинам Azure после отработки отказа

При планировании стратегии репликации и отработки отказа одним из ключевых вопросов является способ подключения к виртуальной машине Azure после отработки отказа. При разработке сетевой стратегии для виртуальных машин реплик Azure существует несколько вариантов:

- **Использование другого IP-адреса.** Для сети реплицируемых виртуальных машин Azure можно выбрать другой диапазон IP-адресов. В этом сценарии после отработки отказа виртуальная машина получает новый IP-адрес, а также требуется обновление DNS.
- **Использование того же IP-адреса.** После отработки отказа для сети Azure можно оставить тот же диапазон IP-адресов, который использовался d основной локальной сети.  Использование тех же IP-адресов упрощает процесс восстановления, уменьшая количество проблем с сетью после отработки отказа. Тем не менее, при выполнении репликации в Azure потребуется обновить маршруты, чтобы указать новое расположение IP-адресов после отработки отказа.


## <a name="retain-ip-addresses"></a>Использование тех же IP-адресов

При отработке отказа в Azure служба Site Recovery предоставляет возможность сохранить фиксированные IP-адреса, используя отработку отказа в подсети.

При отработке отказа в подсети отдельно взятая подсеть присутствует на сайте 1 или 2, но никогда на обоих сайтах одновременно. Чтобы сохранить пространство IP-адресов в случае отработки отказа, программными средствами можно сделать так, чтобы инфраструктура маршрутизаторов перемещала подсети с одного сайта на другой. При отработке отказа подсети перемещаются вместе со связанными с ними защищенными виртуальными машинами. Основным недостатком является то, что в случае сбоя необходимо переместить всю подсеть.



### <a name="failover-example"></a>Пример отработки отказа

Рассмотрим пример отработки отказа в Azure.

- Вымышленная компания, банк Woodgrove, имеет локальную инфраструктуру, в которой размещены ее бизнес-приложения. Ее мобильные приложения размещены в Azure.
- Подключение между виртуальными машинами банка Woodgrove в Azure и локальными серверами обеспечивается через VPN-подключение типа "сеть — сеть" между локальной сетью периметра и виртуальной сетью Azure.
- VPN означает, что виртуальная сеть компании в Azure является расширением ее локальной сети.
- Банк Woodgrove хочет использовать Site Recovery для репликации локальных рабочих нагрузок в Azure.
 - В банке Woodgrove используются приложения и конфигурации, зависящие от жестко заданных IP-адресов, поэтому необходимо сохранить IP-адреса для приложений после отработки отказа в Azure.
 - Банк Woodgrove назначил своим ресурсам в Azure IP-адреса из диапазона 172.16.1.0/24, 172.16.2.0/24.


Чтобы компания Woodgrove могла реплицировать свои виртуальные машины в Azure, сохранив IP-адреса, необходимо сделать следующее:

1. Создайте виртуальную сеть Azure. Она должна быть расширением локальной сети, чтобы приложения могли с легкостью выполнить отработку отказа.
2. Azure позволяет добавлять в виртуальные сети, созданные в Azure, VPN-подключения типа "сеть — сеть" в дополнение к подключениям типа "точка — сеть".
3. При настройке подключения типа "сеть — сеть" в сети Azure можно направить трафик в локальное расположение (локальную сеть) только в том случае, если диапазон IP-адресов отличается от диапазона IP-адресов локальной сети.
    - Это связано с тем, что Azure не поддерживает растянутые подсети. Поэтому при наличии локальной подсети 192.168.1.0/24 невозможно добавить локальную сеть 192.168.1.0/24 в сеть Azure.
    - Это происходит, так как Azure не знает, что в подсети нет активных виртуальных машин и что подсеть создается только в целях аварийного восстановления данных.
    - Чтобы иметь возможность правильно направлять сетевой трафик из сети Azure, подсети в локальной сети и сети не должны конфликтовать.

![Перед выполнением отработки отказа подсети](./media/vmm-to-azure-walkthrough-network/network-design7.png)

### <a name="before-failover"></a>Перед выполнением отработки отказа

1. Создайте дополнительную сеть (например, сеть восстановления). Это сеть, в которой создаются виртуальные машины, выполнившие отработку отказа.
2. Чтобы убедиться, что IP-адрес для виртуальной машины сохраняется после отработки отказа, откройте вкладку **Настройка** в разделе свойств виртуальной машины, укажите тот же IP-адрес, который использовался на виртуальной машине в локальной сети, и нажмите кнопку **Сохранить**.
3. При отработке отказа виртуальной машины служба Azure Site Recovery назначит ей указанный IP-адрес.

    ![Свойства сети](./media/vmm-to-azure-walkthrough-network/network-design8.png)

4. После запуска отработки отказа и создания в Azure виртуальных машин с необходимыми IP-адресами для подключения к сети можно использовать [подключение типа "виртуальная сеть — виртуальная сеть"](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md). Это действие можно выполнить с помощью сценария.
5. Маршруты необходимо соответствующим образом изменить, чтобы отразить тот факт, что подсеть 192.168.1.0/24 теперь перемещена в Azure.

    ![После выполнения отработки отказа подсети](./media/vmm-to-azure-walkthrough-network/network-design9.png)

### <a name="after-failover"></a>После выполнения отработки отказа

Если у вас нет сети Azure, как показано на рисунке выше, то после отработки отказа можно создать VPN-подключение типа "сеть — сеть" между основным сайтом и Azure.

## <a name="change-ip-addresses"></a>Изменение IP-адресов

В этой [записи блога](http://azure.microsoft.com/blog/2014/09/04/networking-infrastructure-setup-for-microsoft-azure-as-a-disaster-recovery-site/) описывается, как настроить сетевую инфраструктуру Azure, если нет необходимости сохранять IP-адреса после отработки отказа. Она начинается с описания приложения, затем рассматривается настройка сети в локальной среде и среде Azure, а в конце приводятся сведения о выполнении отработки отказа.  

## <a name="next-steps"></a>Дальнейшие действия

Перейдите к статье [Шаг 5. Подготовка ресурсов Azure для репликации Hyper-V в Azure](vmm-to-azure-walkthrough-prepare-azure.md).

