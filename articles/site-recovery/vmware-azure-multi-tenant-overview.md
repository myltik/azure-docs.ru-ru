---
title: Общие сведения о поддержке мультитенантности для репликации виртуальных машин VMware в Azure (CSP) с помощью Azure Site Recovery | Документация Майкрософт
description: Общие сведения о поддержке Azure Site Recovery для клиентских подписок в мультитенантной среде, реализуемой с помощью программы CSP.
services: site-recovery
author: mayanknayar
manager: rochakm
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.date: 05/11/2018
ms.author: manayar
ms.openlocfilehash: 0168849c01add3f714b139c7984e3def74f40a5b
ms.sourcegitcommit: c52123364e2ba086722bc860f2972642115316ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2018
ms.locfileid: "34071769"
---
# <a name="overview-of-multi-tenant-support-for-vmware-replication-to-azure-with-csp"></a>Общие сведения о поддержке мультитенантности для репликации VMware в Azure с помощью CSP

В службе [Azure Site Recovery](site-recovery-overview.md) реализована поддержка мультитенантных окружений для клиентских подписок. Такие среды также поддерживаются для подписок клиентов, созданных и управляемых с помощью программы поставщика облачных решений Майкрософт (CSP).

В этой статье описаны способы реализации мультитенантной репликации VMware в Azure и управления ею.

## <a name="multi-tenant-environments"></a>Среды с несколькими клиентами

Доступны три основные мультитенантные модели.

* **Поставщик общих услуг размещения.** В этом случае физическая инфраструктура принадлежит партнеру, и для размещения виртуальных машин нескольких клиентов в одной инфраструктуре используются общие ресурсы (vCenter, центры обработки данных, физическое хранилище и т. д.). Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение с самообслуживанием.

* **Поставщик выделенных услуг размещения.** В этом случае физическая инфраструктура принадлежит партнеру, но для размещения виртуальных машин каждого клиента в одной инфраструктуре используются выделенные ресурсы (несколько серверов vCenter, физические хранилища и т. д.). Для управления аварийным восстановлением можно использовать управляемую службу, предоставленную партнером, или принадлежащее клиенту решение с самообслуживанием.

* **Поставщик управляемых служб.** В этом случае физическая инфраструктура, в которой размещены виртуальные машины, принадлежит заказчику, а партнеры предоставляют поддержку аварийного восстановления и средства управления им.

## <a name="shared-hosting-services-provider-hsp"></a>Поставщик общих услуг размещения (HSP)

Кроме того, здесь описываются еще два сценария, которые являются разновидностями сценария совместного размещения и используют те же принципы. Разница между ними описана в конце этого раздела.

Основное требование в сценарии с несколькими клиентами заключается в том, что клиенты должны быть изолированы. На одном клиенте нельзя просматривать ресурсы, размещенные на другом. В управляемой партнером среде это не так важно. Однако в среде с самостоятельным обслуживанием это может играть решающую роль. В рамках этой статьи изоляция клиента обязательна.

Такая архитектура показана на схеме ниже.

![Поставщик общих услуг размещения с одним сервером vCenter](./media/vmware-azure-multi-tenant-overview/shared-hosting-scenario.png)  

**Совместное размещение с одним сервером vCenter**

На схеме у каждого клиента есть отдельный сервер управления. Такая конфигурация ограничивает доступ клиента к виртуальным машинам определенного клиента и позволяет изолировать клиент. При репликации виртуальных машин VMware используется сервер конфигурации для обнаружения виртуальных машин и установки агентов. Те же самые принципы используются в мультитенантных окружениях, в которых за счет контроля доступа vCenter также применяются дополнительные ограничения обнаружения виртуальных машин.

Требование к изоляции данных означает, что все конфиденциальные данные инфраструктуры (например, учетные данные для доступа) должны быть недоступными для клиентов. По этой причине мы советуем, чтобы все компоненты сервера управления находились полностью под управлением партнера. Ниже приведены компоненты сервера управления.

* Сервер конфигурации
* Сервер обработки
* Главный целевой сервер

Отдельный масштабируемый сервер обработки также находится под управлением партнера.

## <a name="configuration-server-accounts"></a>Учетные записи сервера конфигурации

Каждый сервер конфигурации в рамках этого сценария использует две учетные записи:

- **Учетная запись для доступа к vCenter.** Эта учетная запись используется для обнаружения виртуальных машин клиента. Ей назначаются разрешения доступа vCenter. Мы рекомендуем, чтобы партнер самостоятельно вводил эти учетные данные в средстве настройки во избежание утечек данных при доступе.

- **Учетная запись для доступа к виртуальной машине.** Эта учетная запись используется для принудительной установки агента служб Mobility Services на виртуальных машинах клиента. Обычно это учетная запись домена, предоставленная клиентом для партнера или управляемая непосредственно партнером. Если клиент не хочет предоставлять сведения партнеру напрямую, он может ввести учетные данные, используя временный доступ к серверу конфигурации. Кроме того, клиент может установить агент служб Mobility Services вручную при помощи партнера.

## <a name="vcenter-account-requirements"></a>Требования к учетной записи vCenter

Настройте сервер конфигурации с учетной записью, которой назначена специальная роль.

- Эту роль следует назначить учетной записи, используемой для доступа к vCenter, для каждого объекта vCenter. Она не должна распространяться на дочерние объекты. Такая конфигурация обеспечивает изоляцию клиента, так как при синхронизации доступа можно получить доступ к другим объектам.

    ![Параметр распространения на дочерние объекты](./media/vmware-azure-multi-tenant-overview/assign-permissions-without-propagation.png)

- Кроме того, вы можете назначить учетную запись и роль в объекте центра обработки данных и распространить их на дочерние объекты. Затем назначьте этой учетной записи роль **Без доступа** для каждого объекта (например, для виртуальных машин, принадлежащих другим клиентам), к которому должен быть ограничен доступ от определенного клиента. Такая конфигурация довольно сложная. Она не обеспечивает полный контроль доступа, так как каждый дочерний объект автоматически наследует права доступа родительского объекта. Поэтому рекомендуется использовать первый подход.

### <a name="create-a-vcenter-account"></a>Создание учетной записи vCenter

1. Создайте роль, клонировав предварительно определенную роль с доступом *Только для чтения* и назначив ей понятное имя (Azure_Site_Recovery в этом примере).
2. Назначьте этой роли следующие разрешения:

    * **Хранилище данных**: выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины.
    * **Сеть**: назначение сети.
    * **Ресурс**: назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины.
    * **Задачи**: создание задач, обновление задач.
    * **Виртуальная машина — конфигурация**: все
    - **Виртуальная машина — взаимодействие**: ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware.
    - **Виртуальная машина — инвентаризация**: создание на основе существующего, создание, регистрация, отмена регистрации.
    - **Виртуальная машина — подготовка**: разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины.
    - **Виртуальная машина - управление моментальными снимками**: удаление моментальных снимков.

        ![Диалоговое окно "Изменение ролей"](./media/vmware-azure-multi-tenant-overview/edit-role-permissions.png)

3. Назначьте уровень доступа к учетной записи vCenter (используемой на сервере конфигурации клиента) для различных объектов, как описано в таблице ниже.

>| Объект. | Роль | Примечания |
>| --- | --- | --- |
>| vCenter | Только для чтения | Эта роль используется, только чтобы предоставить vCenter доступ для управления разными объектами. Если эту учетную запись не планируют предоставлять клиенту или использовать для любых операций управления на сервере vCenter, это разрешение можно удалить. |
>| Центр обработки данных | Azure_Site_Recovery |  |
>| Узел и кластер узлов | Azure_Site_Recovery | Предоставляет доступ на уровне объектов, чтобы перед отработкой отказа и после восстановления размещения виртуальные машины клиента имели доступ только к этим узлам. |
>| Хранилище данных и кластер хранилища данных | Azure_Site_Recovery | То же, что и выше. |
>| Сеть | Azure_Site_Recovery |  |
>| Сервер управления | Azure_Site_Recovery | Предоставляет доступ ко всем компонентам (сервер конфигурации, сервер обработки и главный целевой сервер), которые находятся не на компьютере сервера конфигурации. |
>| Виртуальные машины клиента | Azure_Site_Recovery | Предоставляет эти разрешения на доступ всем новым виртуальным машинам определенного клиента. В противном случае их нельзя будет обнаружить с помощью портала Azure. |

Теперь настройка доступа для учетной записи vCenter завершена. Это минимальное требование для выполнения операций восстановления размещения. Эти разрешения на доступ также можно использовать с имеющимися политиками. Просто измените свои разрешения, добавив к ним разрешения роли из шага 2, описанного выше.

### <a name="failover-only"></a>Только отработка отказа
Чтобы ограничить операции аварийного восстановления только отработкой отказа (то есть без функций восстановления размещения), используйте предыдущую процедуру со следующими исключениями.

- Назначьте этой учетной записи доступа к vCenter роль *Только для чтения* вместо роли *Azure_Site_Recovery*. Этот набор разрешений позволяет выполнить репликацию и отработку отказа виртуальных машин, но не допускает восстановление размещения.
- Все остальное в описанном ранее процессе остается без изменений. Чтобы изолировать клиент и ограничить обнаружение виртуальных машин, каждое разрешение должно по-прежнему назначаться только на уровне объектов и не распространяться на дочерние объекты.

### <a name="deploy-resources-to-the-tenant-subscription"></a>Развертывание ресурсов в подписку клиента

1. На портале Azure создайте группу ресурсов и разверните хранилище служб восстановления для обычного процесса.
2. Скачайте ключ регистрации хранилища.
3. Зарегистрируйте сервер конфигурации для клиента, используя ключ регистрации хранилища.
4. Введите данные двух учетных записей, чтобы получить доступ к серверу vCenter Server и виртуальной машине.

    ![Управление учетными записями сервера конфигурации](./media/vmware-azure-multi-tenant-overview/config-server-account-display.png)

### <a name="register-servers-in-the-vault"></a>Регистрация серверов в хранилище

1. На портале Azure в хранилище, созданном ранее, зарегистрируйте сервер vCenter на сервере конфигурации, используя созданную вами учетную запись vCenter.
2. Завершите подготовку инфраструктуры для Site Recovery.
3. Теперь виртуальные машины подготовлены к репликации. Убедитесь, что в разделе **Репликация** > **Выбор виртуальных машин** отображаются только виртуальные машины клиента.

## <a name="dedicated-hosting-solution"></a>Решение для выделенного размещения

Как показано на следующей схеме, разница в архитектуре решения для выделенного размещения заключается в том, что инфраструктура клиента подготавливается только для этого клиента.

![architecture-shared-hsp](./media/vmware-azure-multi-tenant-overview/dedicated-hosting-scenario.png)  
**Сценарий выделенного размещения с несколькими серверами vCenter**

## <a name="managed-service-solution"></a>Решение для управляемой службы

Как показано на следующей схеме, разница в архитектуре решения для управляемой службы заключается в том, что инфраструктура каждого клиента также физически отделена от других клиентов. Этот сценарий обычно возникает, когда клиент владеет инфраструктурой и ему нужен поставщик решений только для управления аварийным восстановлением.

![architecture-shared-hsp](./media/vmware-azure-multi-tenant-overview/managed-service-scenario.png)  
**Сценарий для управляемой службы с несколькими серверами vCenter**

## <a name="next-steps"></a>Дополнительная информация
- См. дополнительные сведения об [управлении доступом на основе ролей в Site Recovery](site-recovery-role-based-linked-access-control.md).
- Узнайте, как [настроить аварийного восстановление виртуальных машин VMware в Azure](vmware-azure-tutorial.md).
- Узнайте больше о реализации [мультитенантности с использованием поставщика служб шифрования для виртуальных машин VMWare](vmware-azure-multi-tenant-csp-disaster-recovery.md).
