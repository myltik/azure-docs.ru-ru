---
title: Отработка отказа в Site Recovery | Документация Майкрософт
description: Azure Site Recovery координирует репликацию, отработку отказа и восстановление виртуальных машин и физических серверов. Узнайте о функции отработки отказа с выполнением переноса в Azure или в дополнительный центр обработки данных.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 05/02/2018
ms.author: ponatara
ms.openlocfilehash: 40f35cde2b55da0763f6ee65b065f5dd8a55b9c6
ms.sourcegitcommit: 870d372785ffa8ca46346f4dfe215f245931dae1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2018
---
# <a name="failover-in-site-recovery"></a>Отработка отказа в Site Recovery
В этой статье описывается отработка отказа для виртуальных машин и физических серверов, защищаемых службой Site Recovery.

## <a name="prerequisites"></a>предварительным требованиям
1. Перед выполнением отработки отказа выполните [тестовую отработку отказа](site-recovery-test-failover-to-azure.md) и убедитесь, что все работает правильно.
1. [Подготовьте сеть](site-recovery-network-design.md) в конечном расположении перед отработкой отказа.  

Ознакомьтесь с таблицей ниже, чтобы изучить варианты отработки отказа, обеспечиваемые Azure Site Recovery. Эти варианты также указаны для разных сценариев отработки отказа.

| Сценарий | Требования к восстановлению приложения | Рабочий процесс для Hyper-V | Рабочий процесс для VMware
|---|--|--|--|
|Плановая отработка отказа из-за предстоящего простоя центров обработки данных| При выполнении запланированного действия отсутствие потери данных для приложения| Для Hyper-V ASR реплицирует данные с частотой копирования, которая задается пользователем. Плановая отработка отказа используется, чтобы переопределить частоту и реплицировать последние изменения до запуска отработки отказа. <br/> <br/> 1.    Планируйте период обслуживания согласно процессу управления изменениями вашего бизнеса. <br/><br/> 2. Отправьте уведомления пользователям о предстоящем времени простоя. <br/><br/> 3. Отключите приложения пользователей.<br/><br/>4. Инициируйте плановую отработку отказа с помощью портала ASR. Работа локальной виртуальной машины будет автоматически завершена.<br/><br/>Фактическая потеря данных приложения = 0 <br/><br/>Журнал точек восстановления можно также получить в окне сохранения для пользователя, который хочет использовать прежнюю точку восстановления. (Для Hyper-V период хранения составляет 24 часа.)| Для VMware ASR постоянно реплицирует данные с помощью CDP. Отработка отказа предоставляет пользователю возможность выполнить отработку отказа до последних данных (включая последующее завершение работы приложения)<br/><br/> 1. Планируйте период обслуживания согласно процессу управления изменениями. <br/><br/>2. Отправьте уведомления пользователям о предстоящем времени простоя. <br/><br/>3.    Отключите приложения пользователей. <br/><br/>4.  После перехода приложения в автономный режим запустите плановую отработку отказа до последней точки с помощью портала ASR. Используйте параметр "Внеплановая отработка отказа" на портале и выберите отработку отказа до последней точки. Работа локальной виртуальной машины будет автоматически завершена.<br/><br/>Фактическая потеря данных приложения = 0 <br/><br/>Журнал точек восстановления в окне сохранения предоставляется для пользователя, который хочет использовать прежнюю точку восстановления. (Для VMware период хранения составляет 72 часа.)
|Отработка отказа из-за незапланированного простоя центра обработки данных (естественного или вследствие аварии ИТ) | Минимальные потери данных для приложения | 1. Активируйте план BCP организации. <br/><br/>2. Запустите внеплановую отработку отказа до последней точки или точки из окна сохранения (журнала) с помощью портала ASR.| 1. Активируйте план BCP организации. <br/><br/>2.  Запустите внеплановую отработку отказа до последней точки или точки из окна сохранения (журнала) с помощью портала ASR.


## <a name="run-a-failover"></a>Запуск отработки отказа
В этой процедуре описывается, как запустить отработку отказа для [плана восстановления](site-recovery-create-recovery-plans.md). В качестве альтернативы можно запустить отработку отказа для одной виртуальной машины или физического сервера на странице **Реплицированные элементы**.


![Отработка отказа](./media/site-recovery-failover/Failover.png)

1. Выберите **Планы восстановления** > *имя_плана_восстановления*. Щелкните **Отработка отказа**.
2. На странице **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
    1.  **Последние** (по умолчанию). Этот параметр запускает задание, сначала обрабатывая все данные, которые были отправлены в службу Site Recovery. При обработке данных создается точка восстановления для каждой виртуальной машины. Эта точка восстановления используется виртуальной машиной во время отработки отказа. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
    1.  **Latest processed** (Последняя обработанная). В этом варианте отработка отказа всех виртуальных машин плана восстановления выполняется до последней точки восстановления из числа уже обработанных службой Site Recovery. При выполнении тестовой отработки отказа виртуальной машины также отображается метка времени последней обработанной точки восстановления. Если отработка отказа выполняется по плану восстановления, вы можете перейти к отдельной виртуальной машине и просмотреть плитку **Последняя точка восстановления** для получения этих сведений. Так как на обработку необработанных данных время не тратится, то этот вариант обеспечивает низкий показатель RTO (целевое время восстановления).
    1.  **Latest app-consistent** (Последняя с согласованием приложений). При этом варианте отработка отказа всех виртуальных машин плана восстановления выполняется до последней точки восстановления с согласованием приложений, которая уже была обработана службой Site Recovery. При выполнении тестовой отработки отказа виртуальной машины также отображается метка времени последней обработанной точки восстановления с согласованием приложений. Если отработка отказа выполняется по плану восстановления, вы можете перейти к отдельной виртуальной машине и просмотреть плитку **Последняя точка восстановления** для получения этих сведений.
    1.  **Последняя обработанная точка нескольких виртуальных машин**. Этот параметр доступен только для планов восстановления, которые содержат по крайней мере одну виртуальную машину с поддержкой согласованности нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней обработанной точки восстановления.  
    1.  **Последняя согласованная с приложением точка нескольких виртуальных машин**. Этот параметр доступен только для планов восстановления, которые содержат по крайней мере одну виртуальную машину с поддержкой согласованности нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной с приложением точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением.
    1.  **Custom** (Настраиваемая). Если вы выполняете тестовую отработку отказа виртуальной машины, можете использовать этот вариант для отработки отказа в определенную точку восстановления.

    > [!NOTE]
    > Выбор точки восстановления доступен только в том случае, если отработка отказа выполняется в Azure.
    >
    >


1. Если для некоторых виртуальных машин из плана восстановления отработка отказа уже была выполнена во время предыдущего запуска и теперь они активны и в исходном, и в целевом расположениях, примените вариант **Change direction** (Изменить направление). Он позволяет выбрать, в каком направлении выполняется отработка отказа.
1. Если при отработке отказа с переносом в Azure включена функция шифрования данных для облака (это применимо только для защиты виртуальных машин Hyper-V, размещенных на сервере VMM), в разделе **Ключ шифрования** выберите сертификат, который был выдан при включении шифрования данных во время настройки VMM-сервера.
1. Выберите **Shut-down machine before beginning failover** (Завершение работы виртуальной машины перед началом отработки отказа), чтобы служба Site Recovery попыталась выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить.  

    > [!NOTE]
    > Если параметр завершения работы указан для защиты виртуальных машин Hyper-V, то перед активацией отработки отказа будет также выполнена попытка синхронизировать локальные данные, которые еще не были отправлены в службу.
    >
    >

1. На странице **Задания** можно следить за ходом выполнения отработки отказа. Даже если во время незапланированной отработки отказа возникнут ошибки, план восстановления будет продолжать выполняться до полного завершения.
1. После отработки отказа войдите на виртуальную машину, чтобы проверить ее работу. Если при использовании виртуальной машины вы хотите переключиться на другую точку восстановления, выберите параметр **Изменить точку восстановления**.
1. Когда вы убедитесь, что после отработки отказа виртуальная машина работает правильно, **зафиксируйте** отработку отказа. **Этот процесс удаляет все точки восстановления, доступные в службе,** и параметр **Изменить точку восстановления** становится недоступен.

## <a name="planned-failover"></a>Плановая отработка отказа
Виртуальные машины и физические серверы, защищенные с помощью Site Recovery, также поддерживают **плановую отработку отказа**. При плановой отработке отказа потеря данных исключается. Когда выполняется плановая отработка отказа, сначала завершается работа исходных виртуальных машин, затем синхронизируются последние данные, и лишь затем запускается отработка отказа.

> [!NOTE]
> При отработке отказа виртуальных машин Hyper-V с одного локального сайта на другой локальный сайт может возникнуть необходимость вернуться на первичный сайт. Для этого сначала следует выполнить **обратную репликацию** виртуальной машины на первичный сайт, а затем запустить отработку отказа. Если первичная виртуальная машина недоступна, то перед запуском **обратной репликации** необходимо восстановить виртуальную машину из резервной копии.   
>
>
## <a name="failover-job"></a>Задание отработки отказа

![Отработка отказа](./media/site-recovery-failover/FailoverJob.png)

Выполнение отработки отказа включает следующие этапы.

1. Проверка необходимых компонентов. На этом этапе вы проверяете, соблюдены ли все условия, необходимые для отработки отказа.
1. Отработка отказа. На этом этапе данные обрабатываются и подготавливаются для создания виртуальной машины Azure. Если вы выбрали **последнюю** точку восстановления, на этом этапе создается точка восстановления на основе данных, отправленных в службу.
1. Запуск. Теперь создается виртуальная машина Azure с использованием данных, обработанных на предыдущем этапе.

> [!WARNING]
> **Не отменяйте уже начатую отработку отказа.** Перед началом отработки отказа останавливается репликация виртуальной машины. Если вы **отмените** выполняемое задание, отработка отказа остановится, но репликация виртуальной машины не возобновится. Репликацию невозможно запустить повторно.
>
>

## <a name="time-taken-for-failover-to-azure"></a>Время, необходимое для отработки отказа в Azure

В некоторых случаях для отработки отказа виртуальных машин требуется дополнительный промежуточный шаг, который обычно длится 8–10 минут. В следующих случаях время, необходимое для отработки отказа, будет больше, чем обычно:

* виртуальные машины VMware, использующие службу Mobility Service версии ниже 9.8;
* физические серверы;
* виртуальные машины VMware на платформе Linux;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware, на которых отсутствуют следующие драйверы в качестве драйверов загрузки:
    * storvsc;
    * vmbus;
    * storflt;
    * intelide;
    * atapi;
* виртуальные машины VMware, на которых не включена служба DHCP, вне зависимости от того, используется протокол DHCP или статические IP-адреса.

Во всех остальных случаях этот промежуточный шаг не обязателен, а время, необходимое для отработки отказа, ниже.





## <a name="using-scripts-in-failover"></a>Использование скриптов при отработке отказа
Вы можете автоматизировать некоторые действия, выполняемые при отработке отказа. Для этого можно включить в [планы восстановления](site-recovery-create-recovery-plans.md) скрипты или [модули Runbook службы автоматизации Azure](site-recovery-runbook-automation.md).

## <a name="post-failover-considerations"></a>Рекомендации после отработки отказа
Рекомендации, которым необходимо следовать после отработки отказа.
### <a name="retaining-drive-letter-after-failover"></a>Сохранение буквы диска после отработка отказа
Чтобы сохранить буквы дисков на виртуальных машинах после отработки отказа, укажите значение **OnlineAll** в **политике SAN** для виртуальной машины. [Дополнительные сведения](https://support.microsoft.com/en-us/help/3031135/how-to-preserve-the-drive-letter-for-protected-virtual-machines-that-are-failed-over-or-migrated-to-azure).



## <a name="next-steps"></a>Дополнительная информация

> [!WARNING]
> Когда завершится отработка отказа виртуальных машин и локальный центр обработки данных снова станет доступен, примените [**повторную защиту**](vmware-azure-reprotect.md) виртуальных машин VMware в локальном центре обработки данных.

Затем используйте вариант [**Плановая отработка отказа**](hyper-v-azure-failback.md), чтобы **восстановить размещение** виртуальных машин Hyper-V из Azure обратно в локальную среду.

Если отработка отказа для виртуальной машины Hyper-V была выполнена в другой локальный центр обработки данных под управлением сервера VMM, то после возобновления работы основного центра обработки данных можно применить вариант **Обратная репликация**, чтобы начать репликацию в основной центр обработки данных.
