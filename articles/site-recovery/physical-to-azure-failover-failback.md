---
title: Отработка отказа и восстановление размещения физических серверов, реплицированных в Azure, с помощью Site Recovery | Документация Майкрософт
description: Узнайте, как выполнить отработку отказа физических серверов в Azure и восстановить размещение на локальном сайте с помощью Azure Site Recovery
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 03/09/2018
ms.author: raynew
ms.openlocfilehash: d58dfd482b66d90748f0ca661e56fa281c14598a
ms.sourcegitcommit: a0be2dc237d30b7f79914e8adfb85299571374ec
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2018
ms.locfileid: "29876019"
---
# <a name="fail-over-and-fail-back-physical-servers-replicated-to-azure"></a>Отработка отказа и восстановление размещения физических серверов, реплицированных в Azure

В этом руководстве содержатся сведения об отработке отказа физических серверов в Azure. После отработки отказа при возможности восстанавливается размещение сервера на локальном сайте. 

## <a name="preparing-for-failover-and-failback"></a>Подготовка к отработке отказа и восстановлению размещения

Размещение физических серверов, реплицированных в Azure, можно восстановить только на виртуальных машинах VMware. Для этого вам требуется локальная инфраструктура VMware. 

Отработка отказа и восстановление размещения происходит в четыре этапа.

1. **Отработка отказа с переходом в Azure.** Отработка отказа с переносом компьютеров с локального сайта в Azure.
2. **Повторное включение защиты виртуальных машин Azure.** Повторно включите защиту виртуальных машин, чтобы начать их репликацию на виртуальные машины VMware, запущенные на локальном сайте.
3. **Переход на другой ресурс в локальной среде**. Выполнение отработки отказа для восстановления размещения из Azure.
4. **Повторное включение защиты локальных виртуальных машин.** После восстановления размещения данных повторно включите защиту локальных виртуальных машин VMware, на которых выполнено восстановление размещения, чтобы начать их репликацию в Azure.

## <a name="verify-server-properties"></a>Проверка свойств сервера

Проверьте свойства сервера и убедитесь, что он соответствует [требованиям Azure](vmware-physical-azure-support-matrix.md#replicated-machines) к виртуальным машинам Azure.

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину.

2. В области **Реплицированный элемент** находятся сводные данные о компьютере, в том числе состояние работоспособности и последние доступные точки восстановления. Щелкните **Свойства**, чтобы просмотреть дополнительные сведения.
3. В области **Вычисления и сеть** можно изменить имя Azure, группу ресурсов, целевой размер, [группу доступности](../virtual-machines/windows/tutorial-availability-sets.md) и [параметры управляемого диска](#managed-disk-considerations).
4. Можно просмотреть или изменить параметры сети, включая сеть (или подсеть), в которой будет размещаться виртуальная машина Azure после отработки отказа, и IP-адрес, который будет ей назначен.
5. В разделе **Диски** отображаются сведения об операционной системе и дисках данных на компьютере.

## <a name="run-a-failover-to-azure"></a>Выполнение отработки отказа в Azure

1. В разделе **Параметры** > **Реплицированные элементы** выберите компьютер и щелкните **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
   - **Последние** (по умолчанию). В этом случае сначала обрабатываются все данные, отправляемые в Site Recovery. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина Azure, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
   - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления компьютера, которая была обработана Site Recovery. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
   - **Последняя точка во времени согласованности приложений.** Отработка отказа компьютера выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery.
   - **Настраиваемая.** Следует указать точку восстановления.

3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа.**, чтобы служба Site Recovery попыталась выключить исходный компьютер, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.
4. Если вы готовы подключиться к виртуальной машине Azure, сделайте это, чтобы проверить ее после отработки отказа.
5. После проверки **зафиксируйте** отработку отказа. При этом будут удалены все доступные точки восстановления.

> [!WARNING]
> Не отменяйте отработку отказа в процессе выполнения. Перед началом отработки отказа репликация компьютера останавливается. Если отменить отработку отказа, она останавливается, но компьютер не будет реплицироваться повторно.
> Дополнительная отработка отказа физических серверов может длиться 8–10 минут. 

## <a name="create-a-process-server-in-azure"></a>Создание сервера обработки в Azure

Сервер обработки получает данные из виртуальных машин в Azure и отправляет их на локальный сайт. Между сервером обработки и защищенным компьютером должна быть настроена сеть с низкой задержкой.

- При наличии подключения к Azure ExpressRoute для целей тестирования можно использовать локальный сервер обработки, который автоматически устанавливается на сервере конфигурации.
- Если имеется VPN-подключение или восстановление размещения выполняется в рабочей среде, необходимо настроить виртуальную машину Azure как сервер обработки на основе Azure.
- Чтобы настроить сервер обработки в Azure, следуйте инструкциям в [этой статье](vmware-azure-set-up-process-server-azure.md).

## <a name="configure-the-master-target-server"></a>Настройка главного целевого сервера

По умолчанию главный целевой сервер принимает данные восстановления размещения. Он работает на локальном сервере конфигурации.

- Если виртуальная машина VMware, на которой выполняется восстановление размещения, находится в узле ESXi под управлением VMware vCenter Server, целевой главный сервер должен иметь доступ к хранилищу данных виртуальной машины (VMDK). Это обеспечит возможность записи реплицированных данных на диски виртуальной машины. Убедитесь, что хранилище данных виртуальной машины подключено к узлу главного целевого сервера с доступом на чтение и запись.
- Если узел ESXi не управляется сервером vCenter, служба Site Recovery создает виртуальную машину при повторном включении защиты. Виртуальная машина создается в узле ESX, в котором создана главная целевая виртуальная машина. Жесткий диск виртуальной машины должен находиться в хранилище данных, доступном для узла, на котором работает главный целевой сервер.
- При восстановлении размещения физических компьютеров перед повторным включением защиты выполните обнаружение узла, в котором работает главный целевой сервер.
- Или при наличии локальной виртуальной машины для восстановления размещения удалите ее, прежде чем выполнить восстановление размещения. Затем служба восстановления размещения создаст новую виртуальную машину на том же узле, где находится главный целевой узел ESX. Если восстановление размещения выполняется в альтернативном расположении, данные будут восстановлены в то же хранилище данных и тот же узел ESX, которые использует локальный главный целевой сервер.
- Вы не можете использовать технологию Storage vMotion на главном целевом сервере. В противном случае восстановление размещения не будет работать, поскольку отсутствуют доступные диски. Исключите главные целевые серверы из списка vMotion.

## <a name="reprotect-azure-vms"></a>Повторное включение защиты виртуальных машин Azure

Эта процедура предполагает, что локальная виртуальная машина недоступна и повторное включение защиты выполняется в альтернативное расположение.

1. В разделе **Параметры** > **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину, для которой была выполнена отработка отказа, и выберите **Защитить повторно**.
2. В окне **Повторная защита** выберите **Из Azure в локальную среду**.
3. Укажите локальный главный целевой сервер и сервер обработки.

4. В поле **Хранилище данных** выберите главное целевое хранилище данных, для которого нужно восстановить диски локальной среды. Используйте этот параметр, если локальная виртуальная машина была удалена и вам нужно создать новые диски. Хотя этот параметр не учитывается, если диски уже существуют, его значение необходимо указать.
5. Выберите главный целевой диск для хранения. Политика восстановления размещения выбирается автоматически.
6. Нажмите кнопку **ОК**, чтобы начать процесс повторной защиты. Задание начнет реплицировать виртуальную машину из Azure на локальный сайт. Ход выполнения операции можно отслеживать на вкладке **Задания** .

> [!NOTE]
> Если вы хотите восстановить виртуальную машину Azure в существующую локальную виртуальную машину, подключите ее хранилище данных локальной виртуальной машины с доступом на чтение и запись к узлу ESXi главного целевого сервера.


## <a name="run-a-failover-from-azure-to-on-premises"></a>Выполнение отработки отказа из Azure в локальную среду

Для репликации данных обратно в локальную среду используется политика восстановления размещения. Эта политика автоматически создается при создании политики репликации для репликации в Azure.

- Политика автоматически сопоставляется с сервером конфигурации.
- Политику невозможно изменить.
- Политика имеет следующие значения:
    - Пороговое значение RPO: 15 минут.
    - Хранение точки восстановления: 24 часа.
    - Периодичность создания моментальных снимков с согласованием приложений: 60 минут.

Выполните отработку отказа следующим образом:

1. На странице **Реплицированные элементы** щелкните правой кнопкой мыши виртуальную машину и выберите пункт **Внеплановая отработка отказа**.
2. На странице **Подтверждение отработки отказа** должно быть указано направление отработки отказа "Из Azure".

3. Выберите точку восстановления, которую вы хотите использовать для отработки отказа. Точка восстановления с согласованием приложений предшествует самой последней точке во времени, что приведет к потере некоторых данных. При отработке отказа служба Site Recovery отключает виртуальные машины Azure и загружает локальную виртуальную машину. Чтобы исключить время простоя, выберите подходящий момент.
4. Щелкните машину правой кнопкой мыши, а затем выберите пункт **Зафиксировать**. Будет запущено задание по удалению виртуальных машин Azure.
5. Убедитесь, что работа виртуальной машины Azure была завершена должным образом.


## <a name="reprotect-on-premises-machines-to-azure"></a>Повторное включение защиты локальных машин в Azure

Теперь данные будут снова находиться на локальном сайте, но они не реплицируются в Azure. Чтобы еще раз выполнить репликацию в Azure, сделайте следующее.

1. В разделе "Хранилище" > **Параметры** >**Реплицированные элементы** выберите виртуальные машины, для которых выполнено восстановление размещения, и щелкните **Защитить повторно**.
2. Выберите сервер обработки, который используется для отправки реплицированных данных в Azure, и нажмите кнопку **ОК**.

После завершения повторного включения защиты виртуальная машина будет снова реплицироваться в Azure, и вы сможете выполнять отработку отказа.

