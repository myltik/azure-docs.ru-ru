---
title: "Репликация виртуальных машин Hyper-V из облаков VMM в Azure | Документация Майкрософт"
description: "В статье описывается управление репликацией, отработкой отказа и восстановлением виртуальных машин Hyper-V, управляемых в облаках System Center VMM, в Azure."
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: tysonn
ms.assetid: 8e7d868e-00f3-4e8b-9a9e-f23365abf6ac
ms.service: site-recovery
ms.workload: backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: hero-=article
ms.date: 03/20/2017
ms.author: raynew
translationtype: Human Translation
ms.sourcegitcommit: 1429bf0d06843da4743bd299e65ed2e818be199d
ms.openlocfilehash: 95f4cb194d35d2781edef3b5a36e39724ea4850c
ms.lasthandoff: 03/22/2017


---
# <a name="replicate-hyper-v-virtual-machines-in-vmm-clouds-to-azure-using-site-recovery-in-the-azure-portal"></a>Репликация виртуальных машин Hyper-V из облаков VMM в Azure с помощью Site Recovery на портале Azure
> [!div class="op_single_selector"]
> * [Портал Azure](site-recovery-vmm-to-azure.md)
> * [Классическая модель Azure](site-recovery-vmm-to-azure-classic.md)
> * [PowerShell — Resource Manager](site-recovery-vmm-to-azure-powershell-resource-manager.md)
> * [PowerShell — классическая модель](site-recovery-deploy-with-powershell.md)


В этой статье описано, как выполнить репликацию локальных виртуальных машин Hyper-V, управление которыми осуществляется в облаках System Center VMM, в Azure с помощью службы [Azure Site Recovery](site-recovery-overview.md) на портале Azure.

Любые комментарии, которые возникнут после прочтения этой статьи, можно добавить в конце этой страницы или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).


## <a name="deployment-steps"></a>Шаги по развертыванию


1. [Узнайте больше](site-recovery-components.md#hyper-v-to-azure) об архитектуре этого развертывания. Кроме того, [получите дополнительные сведения](site-recovery-hyper-v-azure-architecture.md) о выполнении репликации Hyper-V в Site Recovery.
2. Выполните предварительные требования и ознакомьтесь с ограничениями.
3. Настройте сеть и учетные записи хранения Azure.
4. Подготовьте локальный сервер VMM и узлы Hyper-V.
5. Создайте хранилище служб восстановления, которое содержит параметры конфигурации и управляет репликацией.
6. Укажите параметры источника. Зарегистрируйте сервер VMM в хранилище. Установите поставщик Azure Site Recovery на сервере VMM, а также установите агент служб восстановления Майкрософт на узлах Hyper-V.
7. Настройте параметры целевого объекта и репликации.
8. Включите репликацию для виртуальных машин.
9. Запустите тестовую отработку отказа, чтобы убедиться в надлежащей работе всех компонентов.



## <a name="prerequisites"></a>Предварительные требования


**Необходимая поддержка** | **Дополнительные сведения**
--- | ---
**Таблицы Azure** | Ознакомьтесь с [требованиями Azure](site-recovery-prereq.md#azure-requirements).
**Локальные серверы** | [Ознакомьтесь](site-recovery-prereq.md#disaster-recovery-of-hyper-v-virtual-machines-in-virtual-machine-manager-clouds-to-azure) с требованиями к локальным серверам VMM и узлам Hyper-V.
**Локальные виртуальные машины Hyper-V** | Виртуальные машины, которые необходимо реплицировать, должны работать под управлением [поддерживаемой операционной системы](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions) и соответствовать [предварительным требованиям Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).
**URL-адреса Azure** | Сервер должен иметь доступ к этим URL-адресам:<br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]<br/><br/> При использовании правил брандмауэра на основе IP-адресов убедитесь, что эти правила разрешают обмен данными с Azure.<br/></br> Разрешите доступ для [диапазонов IP-адресов центра обработки данных Azure](https://www.microsoft.com/download/confirmation.aspx?id=41653) и использование порта HTTPS (443).<br/></br> Необходимо разрешить доступ для диапазонов IP-адресов региона Azure, в котором располагается ваша подписка, и региона "Западная часть США" (используется для контроля доступа и управления удостоверениями).


## <a name="prepare-for-deployment"></a>Подготовка к развертыванию
Чтобы подготовиться к развертыванию, необходимо сделать следующее:

1. [Настроить сеть Azure](#set-up-an-azure-network) , в которой будут размещаться виртуальные машины Azure после отработки отказа.
2. [Настроить учетную запись хранения Azure](#set-up-an-azure-storage-account) для реплицированных данных.
3. [Подготовить сервер VMM](#prepare-the-vmm-server) к развертыванию Site Recovery.
4. Подготовьтесь к сопоставлению сетей. Настройте сети, чтобы сопоставление сетей можно было настроить во время развертывания Site Recovery.

### <a name="set-up-an-azure-network"></a>Настроить сеть Azure
Вам потребуется сеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа.

* Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.
* В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для сети Azure необходимо настроить [режим Resource Manager](../virtual-network/virtual-networks-create-vnet-arm-pportal.md) или [классический режим](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).
* Рекомендуется настроить сеть перед началом работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery.
Сети Azure, используемые для Site Recovery, нельзя [перемещать](../azure-resource-manager/resource-group-move-resources.md) в одной подписке или между разными подписками.

### <a name="set-up-an-azure-storage-account"></a>Настроить учетную запись хранения Azure
* Для хранения данных, реплицированных в Azure, понадобится учетная запись хранения Azure класса "Стандартный". Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.
* В зависимости от модели ресурсов, которую нужно использовать для виртуальных машин Azure после отработки отказа, для учетной записи необходимо настроить [режим Resource Manager](../storage/storage-create-storage-account.md) или [классический режим](../storage/storage-create-storage-account-classic-portal.md).
* Рекомендуется настроить учетную запись до начала работы. В противном случае это нужно будет сделать во время развертывания службы Site Recovery.
- Обратите внимание, учетные записи хранения, используемые для Site Recovery, нельзя [перемещать](../azure-resource-manager/resource-group-move-resources.md) в одной подписке или между разными подписками.

### <a name="prepare-the-vmm-server"></a>Подготовить сервер VMM
* Убедитесь, что сервер VMM соответствует [предварительным требованиям](#on-premises-prerequisites).
* Во время развертывания службы Site Recovery можно указать, что все облака на сервере VMM должны быть доступны на портале Azure. Если нужно, чтобы на портале отображались только определенные облака, соответствующий параметр можно включить в консоли администратора VMM.

### <a name="prepare-for-network-mapping"></a>Подготовка к сопоставлению сетей
Во время развертывания службы Site Recovery необходимо настроить сопоставление сетей. Это позволит сопоставить исходные сети виртуальных машин VMM и целевые сети Azure, что предоставляет следующие возможности:

* Компьютеры, для которых отработка отказа выполняется в одной сети, могут подключаться друг к другу, даже если отработка отказа выполнялась по-разному или в рамках разных планов восстановления.
* При наличии сетевого шлюза в целевой сети Azure виртуальные машины могут подключиться к локальным виртуальным машинам.
* Чтобы настроить сопоставление сетей, необходимо следующее.

  * Виртуальные машины на сервере узла Hyper-V должны быть подключены к сети виртуальных машин VMM. Эта сеть должна быть подключена к логической сети, которая связана с облаком.
  * Сеть Azure, как описано [выше](#set-up-an-azure-network)

## <a name="create-a-recovery-services-vault"></a>Создание хранилища служб восстановления
1. Войдите на [портал Azure](https://portal.azure.com).
2. Щелкните **Создать** > **Управление** > **Службы восстановления**. Кроме того, можно щелкнуть **Обзор** > **Хранилища служб восстановления** > **Добавить**.

    ![Новое хранилище](./media/site-recovery-vmm-to-azure/new-vault3.png)
3. В поле **Имя**укажите понятное имя для идентификации хранилища. Если у вас имеется несколько подписок, выберите одну из них.
4. [Создайте новую группу ресурсов](../azure-resource-manager/resource-group-template-deploy-portal.md) или выберите существующую. Укажите регион Azure. В него будут реплицированы данные компьютеров. Сведения о поддерживаемых регионах см. в разделе "Географическая доступность" на странице [Расценки на службу Azure Site Recovery](https://azure.microsoft.com/pricing/details/site-recovery/).
5. Если вам нужно быстро получить доступ к хранилищу на панели мониторинга, щелкните **Закрепить на панели мониторинга** > **Создать хранилище**.

    ![Новое хранилище](./media/site-recovery-vmm-to-azure/new-vault-settings.png)

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и в основной колонке **Хранилища служб восстановления**.

## <a name="get-started"></a>Приступая к работе

В Site Recovery предусмотрен механизм для начала работы, который позволяет выполнить развертывание как можно быстрее. Перед развертыванием проверяется соответствие предварительным требованиям. Кроме того, вы получаете указания для выполнения этапов развертывания в правильной последовательности.

Необходимо выбрать тип компьютеров, которые требуется реплицировать, и место для репликации. Затем нужно настроить локальные серверы, учетные записи хранения Azure и сети. Кроме того, требуется создать политики репликации и выполнить планирование ресурсов. Когда инфраструктура будет готова, следует включить репликацию для виртуальных машин. Можно выполнить отработку отказа для конкретных компьютеров или создать план восстановления для отработки отказа на нескольких компьютерах.

Сначала выберите способ развертывания Site Recovery. Начальные процедуры немного изменяются в зависимости от требований к репликации.

## <a name="step-1-choose-your-protection-goals"></a>Шаг 1. Выбор целевых объектов для защиты
Выберите целевые объекты и место для репликации.

1. В колонке **Хранилища служб восстановления** выберите хранилище.
2. В области **Приступая к работе** щелкните **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

    ![Выбор цели](./media/site-recovery-vmm-to-azure/choose-goals.png)
3. На странице **Цель защиты** выберите **В Azure** и затем выберите **Да, с помощью Hyper-V**. Выберите **Да** , чтобы подтвердить, что для управления узлами Hyper-V и сайтом восстановления используется VMM. Нажмите кнопку **ОК**.

## <a name="step-2-set-up-the-source-environment"></a>Шаг 2. Настройка исходной среды
Установите поставщик Azure Site Recovery на сервере VMM и зарегистрируйте сервер в хранилище. Установите агент служб восстановления Azure на узлах Hyper-V.

1. Щелкните **Шаг 2. Подготовка инфраструктуры** > **Источник**.

    ![Настройка источника](./media/site-recovery-vmm-to-azure/set-source1.png)

2. В поле **Подготовка источника** щелкните **+ VMM**, чтобы добавить сервер VMM.

    ![Настройка источника](./media/site-recovery-vmm-to-azure/set-source2.png)

3. В колонке **Добавление сервера** убедитесь, что **сервер System Center VMM** появился в разделе **Тип сервера** и что он соответствует [предварительным требованиям и требованиям к URL-адресам](#on-premises-prerequisites).
4. Скачайте файл установки поставщика Azure Site Recovery.
5. Скачайте ключ регистрации. Он потребуется при запуске программы установки. Ключ действителен в течение пяти дней после создания.

    ![Настройка источника](./media/site-recovery-vmm-to-azure/set-source3.png)

6. Установите поставщик Azure Site Recovery на сервере VMM.

### <a name="set-up-the-azure-site-recovery-provider"></a>Настройка поставщика Azure Site Recovery
1. Запустите файл установки поставщика.
2. Обновления можно включить на странице **Центр обновления Майкрософт**. Это позволит устанавливать обновления поставщика в соответствии с политикой Центра обновления Майкрософт.
3. На странице **Установка** примите или измените расположение установки поставщика по умолчанию и нажмите кнопку **Установить**.

    ![Расположение установки](./media/site-recovery-vmm-to-azure/provider2.png)
4. После установки щелкните **Зарегистрировать**, чтобы зарегистрировать сервер VMM в хранилище.
5. На странице **Параметры хранилища** нажмите кнопку **Обзор**, чтобы выбрать файл ключа хранилища. Укажите подписку Azure Site Recovery и имя хранилища.

    ![Регистрация сервера](./media/site-recovery-vmm-to-azure/provider10.PNG)
6. На странице **Подключение к Интернету**укажите, как запущенный на сервере VMM поставщик будет подключаться к Site Recovery через Интернет.

   * Чтобы поставщик подключался напрямую, выберите **Подключиться к Azure Site Recovery напрямую без прокси-сервера**.
   * Если для имеющегося прокси-сервера требуется проверка подлинности или нужно использовать пользовательский прокси-сервер, выберите **Подключиться к Azure Site Recovery с использованием прокси-сервера**.
   * При использовании пользовательского прокси-сервера необходимо указать адрес, порт и учетные данные.
   * Если прокси-сервер используется, скорее всего, вы уже разрешили использовать URL-адреса, описанные в разделе о [предварительных требованиях](#on-premises-prerequisites).
   * При использовании настраиваемого прокси-сервера автоматически создается учетная запись запуска от имени VMM (DRAProxyAccount), использующая указанные учетные данные прокси-сервера. Настройте прокси-сервер так, чтобы эта учетная запись могла успешно проходить проверку подлинности. Параметры учетной записи запуска от имени VMM можно изменить в консоли VMM. В области **Параметры** разверните **Безопасность** > **Учетные записи запуска от имени**, а затем измените пароль для учетной записи DRAProxyAccount. Чтобы параметры вступили в силу, потребуется перезапустить службу VMM.

     ![Интернет](./media/site-recovery-vmm-to-azure/provider13.PNG)
7. Примите или измените расположение сертификата SSL, который создается автоматически для шифрования данных. Этот сертификат используется при включении шифрования данных для облачных сред, защищенных Azure, на портале Azure Site Recovery. Сертификат следует хранить в безопасном месте. При отработке отказа в Azure он понадобится для расшифровки, если включено шифрование данных.
8. В поле **Имя сервера**укажите понятное имя, описывающее сервер VMM в хранилище. В конфигурации кластера укажите имя роли кластера VMM.
9. Включите **синхронизацию метаданных в облаке**, если нужно синхронизировать метаданные для всех облаков сервера VMM в хранилище. На каждом сервере это действие требуется выполнять только один раз. Если не требуется синхронизировать все облака, можно оставить этот флажок снятым и синхронизировать каждое облако индивидуально в свойствах облака в консоли VMM. Для завершения процесса нажмите кнопку **Зарегистрировать** .

    ![Регистрация сервера](./media/site-recovery-vmm-to-azure/provider16.PNG)
10. Начнется процедура регистрации. После завершения регистрации сервер появится на вкладке **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Серверы VMM**.

#### <a name="command-line-installation-for-the-azure-site-recovery-provider"></a>Установка поставщика Azure Site Recovery в командной строке
Поставщик Azure Site Recovery можно установить с помощью командной строки. Этот метод можно использовать для установки поставщика на основные серверные компоненты Windows Server 2012 R2.

1. Скачайте файл установки поставщика и ключ регистрации в папку. Например, C:\ASR.
2. В командной строке с повышенными правами запустите следующие команды, чтобы извлечь установщик поставщика:

            C:\Windows\System32> CD C:\ASR
            C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
3. Выполните следующую команду для установки компонентов:

            C:\ASR> setupdr.exe /i
4. Затем выполните следующие команды для регистрации сервера в хранилище.

        CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
        C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>       

Описание

* **/Credentials**— обязательный параметр, который определяет расположение ключа регистрации.  
* **/FriendlyName**— обязательный параметр для имени сервера узла Hyper-V, который отображается на портале Azure Site Recovery.
* * **/EncryptionEnabled**— необязательный параметр, используемый при репликации виртуальных машин Hyper-V из облаков VMM в Azure. Укажите, следует ли шифровать виртуальные машины в Azure (шифрование неактивных данных). Имя файла должно иметь расширение **PFX** . По умолчанию шифрование отключено.
* **/proxyAddress**— необязательный параметр, определяющий адрес прокси-сервера.
* **/proxyport**— необязательный параметр, определяющий порт прокси-сервера.
* **/proxyUsername**— необязательный параметр, определяющий имя пользователя прокси-сервера (если прокси-сервер требует проверки подлинности).
* **/proxyPassword**— необязательный параметр, определяющий пароль для проверки подлинности на прокси-сервере (если прокси-сервер требует проверки подлинности).

### <a name="install-the-azure-recovery-services-agent-on-hyper-v-hosts"></a>Установка агента служб восстановления Azure на узлах Hyper-V
1. После настройки поставщика нужно скачать файл установки для агента служб восстановления Azure. Запустите программу установки на каждом сервере Hyper-V в облаке VMM.

    ![Сайты Hyper-V](./media/site-recovery-vmm-to-azure/hyperv-agent1.png)
2. В разделе **Проверка предварительных требований** нажмите кнопку **Далее**. Все отсутствующие предварительные требования будут установлены автоматически.

    ![Предварительные требования для агента служб восстановления](./media/site-recovery-vmm-to-azure/hyperv-agent2.png)
3. В разделе **Параметры установки** примите или измените место установки и расположение кэша. Можно настроить кэш на диске объемом от 5 ГБ. Однако рекомендуемый объем — не менее 600 ГБ. Нажмите **Install**(Установить).
4. После завершения установки нажмите кнопку **Закрыть** .

    ![Регистрация агента служб восстановления Microsoft Azure](./media/site-recovery-vmm-to-azure/hyperv-agent3.png)

#### <a name="command-line-installation-for-azure-site-recovery-services-agent"></a>Установка служб Azure Site Recovery в командной строке
Агент служб восстановления Microsoft Azure можно установить из командной строки, используя следующую команду:

     marsagentinstaller.exe /q /nu

#### <a name="set-up-internet-proxy-access-to-site-recovery-from-hyper-v-hosts"></a>Настройка доступа прокси-сервера к Site Recovery через Интернет для узлов Hyper-V
Агенту служб восстановления на узлах Hyper-V требуется доступ к Azure через Интернет для репликации виртуальных машин. Если доступ к Интернету осуществляется через прокси-сервер, настройте его так:

1. Откройте на узле Hyper-V оснастку MMC в службе архивации Microsoft Azure. По умолчанию ярлык для службы архивации Microsoft Azure расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Конфигурация прокси-сервера** укажите сведения о прокси-сервере.

    ![Регистрация агента служб восстановления Microsoft Azure](./media/site-recovery-vmm-to-azure/mars-proxy.png)
4. Проверьте, может ли агент связаться с URL-адресами, описанными в разделе с [предварительными требованиями](#on-premises-prerequisites).

## <a name="step-3-set-up-the-target-environment"></a>Шаг 3. Настройка целевой среды
Укажите учетную запись хранения Azure для репликации и сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.

1. Щелкните **Подготовка инфраструктуры** > **Цель**, выберите подписку и группу ресурсов, в которых вы хотите создавать виртуальные машины при отработке отказа. Выберите модель развертывания, которая будет использоваться в Azure (классическая или Resource Manager) для виртуальных машин после отработки отказа.

    ![Хранилище](./media/site-recovery-vmm-to-azure/enablerep3.png)

2. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure.
      ![Хранилище](./media/site-recovery-vmm-to-azure/compatible-storage.png)

4. Если учетная запись хранения еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Storage account** (+ Учетная запись хранения).  В колонке **Создание учетной записи хранения** укажите имя, тип, подписку и расположение учетной записи. Учетная запись должна находиться в том же регионе, что и хранилище служб восстановления.

   ![Хранилище](./media/site-recovery-vmm-to-azure/gs-createstorage.png)

   Обратите внимание на следующее.

   * Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на портале Azure. [Дополнительные сведения](../storage/storage-create-storage-account-classic-portal.md)
   * Если для реплицированных данных используется учетная запись хранения класса "Премиум", потребуется настроить дополнительную учетную запись хранения класса "Стандартный" для хранения журналов репликации, в которых фиксируются текущие изменения локальных данных.
5. Если сеть Azure еще не создана и ее нужно создать с помощью Resource Manager, щелкните **+Network** (+ Сеть), чтобы сделать это в процессе настройки. В колонке **Создание виртуальной сети** укажите имя, диапазон адресов, сведения о подсетях, подписку и расположение сети. Сеть должна располагаться в том же регионе, что и хранилище служб восстановления.

   ![Сеть](./media/site-recovery-vmm-to-azure/gs-createnetwork.png)

   Если нужно создать сеть, используя классическую модель, это можно сделать на портале Azure. [Подробнее](../virtual-network/virtual-networks-create-vnet-classic-pportal.md).

### <a name="configure-network-mapping"></a>Настройка сетевого сопоставления

* [Прочтите](#prepare-for-network-mapping) краткий обзор сопоставления сетей.
* Проверьте, подключены ли виртуальные машины на сервере VMM к сети виртуальной машины и создана ли по крайней мере одна виртуальная сеть Azure. Несколько сетей виртуальных машин можно сопоставить с одной сетью Azure.

Настройте сопоставление следующим образом:

1. Выберите **Site Recovery Infrastructure** (Инфраструктура Site Recovery) > **Сетевые сопоставления** > **Сетевое сопоставление** и щелкните значок **+Network Mapping** (+Сетевое сопоставление).

    ![Сетевое сопоставление](./media/site-recovery-vmm-to-azure/network-mapping1.png)
2. В разделе **Добавление сетевого сопоставления** выберите исходный сервер VMM, а в качестве целевого сервера — **Azure**.
3. Проверьте подписку и модель развертывания после отработки отказа.
4. На странице **Исходная сеть**в списке, связанном с сервером VMM, выберите исходную сеть локальной виртуальной машины, которую нужно сопоставить.
5. На странице **Целевая сеть**выберите сеть Azure, в которой будут размещены реплицированные виртуальные машины Azure после создания. Нажмите кнопку **ОК**.

    ![Сетевое сопоставление](./media/site-recovery-vmm-to-azure/network-mapping2.png)

Когда начинается сопоставление сетей, происходит следующее:

* При запуске сопоставления существующие виртуальные машины в исходной сети виртуальных машин подключаются к целевой сети. Новые виртуальные машины, подключенные к исходной сети виртуальных машин, будут подключены к сопоставленной сети Azure после репликации.
* Если изменить имеющееся сопоставление сетей, реплики виртуальных машин подключаются с новыми параметрами.
* Если целевая сеть включает несколько подсетей и одна из этих подсетей имеет то же имя, что и подсеть, в которой размещается исходная виртуальная машина, то реплика виртуальной машины подключается к этой целевой подсети после отработки отказа.
* Если подсети с таким же именем отсутствуют, виртуальная машина подключается к первой подсети в сети.

## <a name="step-4-set-up-replication-settings"></a>Этап 4. Настройка параметров репликации
1. Чтобы создать политику репликации, выберите **Подготовка инфраструктуры** > **Параметры репликации** > **Создание и связывание**.

    ![Сеть](./media/site-recovery-vmm-to-azure/gs-replication.png)
2. На странице **Создать и связать политику**укажите имя политики.
3. В раскрывающемся списке **Частота копирования**выберите периодичность репликации изменений данных после начальной репликации (каждые 30 секунд, 5 или 15 минут).
4. В поле **Хранение точки восстановления**укажите продолжительность периода хранения для каждой точки восстановления (в часах). Защищенные компьютеры будут восстанавливаться до любой точки в пределах этого периода.
5. В поле **Периодичность создания моментальных снимков с согласованием приложений** укажите, как часто (от 1 до 12 часов) будут создаваться точки восстановления, содержащие согласованные с приложениями моментальные снимки. Hyper-V использует два типа резервного копирования: стандартное резервное копирование, обеспечивающее создание добавочных резервных копий всей виртуальной машины, и соответствующие приложению моментальные снимки, обеспечивающие создание моментального снимка данных приложений в виртуальной машине на момент времени. Функция моментальных снимков, соответствующих приложению, использует службу теневого копирования томов (VSS), чтобы гарантировать согласованное состояние приложений на момент создания снимка. Примечание. Включение моментальных снимков, соответствующих приложению, влияет на производительность приложений, выполняющихся на исходных виртуальных машинах. Заданное значение должно быть меньше числа настроенных дополнительных точек восстановления.
6. Укажите необходимые данные в поле **Время запуска начальной репликации**. При репликации используется полоса пропускания Интернета. Поэтому проведение репликации нужно запланировать на свободное от работы время.
7. В области **Шифровать данные, хранящиеся в Azure**нажмите соответствующую кнопку. Нажмите кнопку **ОК**.

    ![Политика репликации](./media/site-recovery-vmm-to-azure/gs-replication2.png)
8. При создании политики она автоматически сопоставляется с облаком VMM. Нажмите кнопку **ОК**. С этой политикой репликации можно сопоставить дополнительные облака VMM (и виртуальные машины, содержащиеся в них). Для этого выберите **Репликация** > имя политики > **Associate VMM Cloud** (Сопоставить облако VMM).

    ![Политика репликации](./media/site-recovery-vmm-to-azure/policy-associate.png)

## <a name="step-5-capacity-planning"></a>Шаг 5. Планирование ресурсов
Теперь после настройки базовой инфраструктуры можно начать планирование ресурсов и выяснить, нужны ли дополнительные ресурсы.

Планировщик ресурсов Site Recovery позволяет выделить нужные ресурсы для исходной среды, компонентов Site Recovery, сети и хранилища с помощью планировщика ресурсов. Планировщик можно запустить в быстром режиме, чтобы получить оценку на основе среднего числа виртуальных машин и дисков, а также среднего объема хранилища, или в подробном режиме, в котором необходимо вводить показатели на уровне рабочей нагрузки. Перед началом работы:

* Соберите сведения о среде репликации, включая информацию о виртуальных машинах, количестве дисков на виртуальную машину и объеме хранилища на диск.
* Определите частоту ежедневных изменений (обновлений) реплицированных данных. Для этого можно воспользоваться [планировщиком ресурсов для реплики Hyper-V](https://www.microsoft.com/download/details.aspx?id=39057) .

1. Щелкните **Скачать**, чтобы скачать этот инструмент, и запустите его. Сведения об этом инструменте см. в [этой статье](site-recovery-capacity-planner.md).
2. После этого в поле **Have you run the Capacity Planner?** (Вы запустили планировщик ресурсов?) выберите **Да**.

   ![Планирование загрузки](./media/site-recovery-vmm-to-azure/gs-capacity-planning.png)

### <a name="network-bandwidth-considerations"></a>Рекомендации по пропускной способности сети
С помощью планировщика ресурсов можно рассчитать пропускную способность, необходимую для репликации (начальная и разностная репликации данных). Управлять объемом пропускной способности, используемой для репликации, можно несколькими способами:

* **Регулирование пропускной способности.** Трафик Hyper-V, который реплицируется на дополнительный сайт, проходит через определенный узел Hyper-V. Пропускную способность можно регулировать на сервере этого узла.
* **Настройка пропускной способности**. Пропускную способность, используемую для репликации, можно изменить с помощью нескольких разделов реестра.

#### <a name="throttle-bandwidth"></a>Регулирование пропускной способности
1. Откройте на сервере узла Hyper-V оснастку MMC в службе архивации Microsoft Azure. По умолчанию ярлык для службы архивации Microsoft Azure расположен на рабочем столе или в папке C:\Program Files\Microsoft Azure Recovery Services Agent\bin\wabadmin.
2. В оснастке щелкните **Изменить свойства**.
3. На вкладке **Регулирование** установите флажок **Разрешить регулирование уровня использования пропускной способности интернет-канала для операций архивации** и задайте ограничения для рабочего и нерабочего времени. Допустимы значения в диапазоне от 512 Кбит/с до 102 Мбит/с.

    ![Регулирование пропускной способности](./media/site-recovery-vmm-to-azure/throttle2.png)

Чтобы настроить регулирование, можно также использовать командлет [Set-OBMachineSetting](https://technet.microsoft.com/library/hh770409.aspx) . Рассмотрим пример:

    $mon = [System.DayOfWeek]::Monday
    $tue = [System.DayOfWeek]::Tuesday
    Set-OBMachineSetting -WorkDay $mon, $tue -StartWorkHour "9:00:00" -EndWorkHour "18:00:00" -WorkHourBandwidth  (512*1024) -NonWorkHourBandwidth (2048*1024)

**Set-OBMachineSetting -NoThrottle** указывает, что регулирование не требуется.

#### <a name="influence-network-bandwidth"></a>Изменение пропускной способности сети
Значение реестра **UploadThreadsPerVM** управляет количеством потоков, используемых для передачи данных диска (начальная или разностная репликация данных). Если задать высокое значение, пропускная способность сети, используемая для репликации, увеличивается. Значение реестра **DownloadThreadsPerVM** указывает количество потоков, используемых для передачи данных при восстановлении размещения.

1. В реестре перейдите в раздел **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Azure Backup\Replication**.

   * Измените значение **UploadThreadsPerVM** (или создайте раздел, если он не существует), чтобы управлять потоками, используемыми для репликации дисков.
   * Измените значение **DownloadThreadsPerVM** (или создайте раздел, если он не существует), чтобы управлять потоками, используемыми для трафика восстановления размещения в Azure.
2. Значение по умолчанию — 4. В сети со значительным избыточным резервом для этих разделов реестра необходимо изменить значения по умолчанию. Максимальное значение — 32. Следите за трафиком для оптимизации значения.

## <a name="step-6-enable-replication"></a>Шаг 6. Включение репликации

Включите репликацию следующим образом:

1. Последовательно выберите **Шаг 2. Репликация приложения** > **Источник**. Включив репликацию впервые, щелкните **+Replicate** (+ Реплицировать) в хранилище, чтобы включить репликацию для дополнительных машин.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication1.png)
2. В колонке **Источник** выберите сервер VMM и облако, в котором находятся узлы Hyper-V. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication-source.png)
3. В колонке **Цель** выберите подписку, модель развертывания после отработки отказа и учетную запись хранения, используемую для реплицируемых данных.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication-target.png)
4. Выберите учетную запись хранения, которую нужно использовать. Если вам нужна другая учетная запись хранения, [создайте ее](#set-up-an-azure-storage-account). Чтобы создать учетную запись хранения с использованием модели Resource Manager, щелкните **Создать**. Если нужно создать учетную запись хранения, используя классическую модель, это можно сделать на [портале Azure](../storage/storage-create-storage-account-classic-portal.md). Нажмите кнопку **ОК**.
5. Выберите сеть и подсеть Azure, к которой будут подключаться виртуальные машины Azure, созданные после отработки отказа. Выберите **Настроить сейчас для всех выбранных компьютеров**, чтобы применить параметр сети ко всем защищаемым машинам. Выберите **Отложить настройку**, чтобы выбрать сеть Azure для каждой машины. Если нужна другая сеть, [создайте ее](#set-up-an-azure-network). Чтобы создать сеть с использованием модели Resource Manager, щелкните **Создать**. Если нужно создать сеть, используя классическую модель, это можно сделать [на портале Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md). Выберите подсеть (если это применимо). Нажмите кнопку **ОК**.
6. В разделе **Виртуальные машины** > **Выбор виртуальных машин**, выберите каждую машину, которую нужно реплицировать. Можно выбрать только те компьютеры, для которых можно включить репликацию. Нажмите кнопку **ОК**.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication5.png)

7. В поле **Свойства** > **Настройка свойств**, выберите операционную систему для выбранных виртуальных машин и диск операционной системы. По умолчанию для репликации выбраны все диски виртуальной машины. Чтобы уменьшить использование пропускной способности и избежать репликации ненужных данных в Azure, может потребоваться исключить диски из репликации. Например, репликация может не требоваться для дисков с временными данными или данными, которые обновляются при каждом перезапуске компьютера или приложения (например, pagefile.sys или базы данных tempdb Microsoft SQL Server). Чтобы исключить диск из репликации, достаточно отменить его выбор. Убедитесь, что имя виртуальной машины Azure (имя целевого объекта) соответствует [требованиям к виртуальной машине Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) , и измените его, если нужно. Нажмите кнопку **ОК**. Позже можно задать дополнительные свойства.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication6-with-exclude-disk.png)

    >[!NOTE]
    >
    > * Из репликации можно исключать только базовые диски. Нельзя исключить диск операционной системы. Также не рекомендуется исключать динамические диски. Site Recovery не может определить тип виртуального жесткого диска (базовый или динамический) в гостевой виртуальной машине.  Если все зависимые диски динамических томов не исключены, то при отработке отказа виртуальной машины защищенный динамический диск будет считаться неисправным и данные на нем будут недоступны.
    > * После включения репликации добавить или удалить диски для репликации нельзя. Если вы хотите добавить или исключить диск, отключите защиту виртуальной машины, а затем включите ее повторно.
    > * Если вы исключили диск, необходимый для работы приложения, для выполнения реплицируемого приложения после отработки отказа в Azure вам необходимо будет создать его в Azure вручную. Кроме того, для создания диска во время отработки отказа компьютера вы можете интегрировать службу автоматизации Azure в план восстановления.
    > * Диски, создаваемые в Azure вручную, не будут восстановлены в исходном расположении. Например, если вы выполните отработку отказа трех дисков и создадите два диска непосредственно на виртуальной машине Azure, восстановление размещения из Azure в Hyper-V будет выполнено только для трех дисков, задействованных при отработке отказа. Восстановление размещения после сбоя и обратная репликация из Hyper-V в Azure недоступны для дисков, созданных вручную.
    >
    >


8. Щелкнув **Параметры репликации** > **Настройка параметров репликации**, выберите политику репликации, которую необходимо применить к защищенным виртуальным машинам. Нажмите кнопку **ОК**. Политику репликации можно изменить, последовательно выбрав **Политики репликации** > имя политики > **Изменить параметры**. Изменения будут применены как к ВМ, для которых уже выполняется репликация, так и к новым ВМ.

   ![Включение репликации](./media/site-recovery-vmm-to-azure/enable-replication7.png)

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Задания** > **Задания Azure Site Recovery**. После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.

### <a name="view-and-manage-vm-properties"></a>Просмотр свойств виртуальной машины и управление ими
Рекомендуется проверить свойства исходного компьютера. Помните, что имя виртуальной машины Azure должно соответствовать [требованиям к виртуальным машинам Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).

1. В разделе **Защищенные элементы** щелкните **Реплицированные элементы** и выберите виртуальную машину, чтобы просмотреть сведения о ней.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/vm-essentials.png)
2. На разделе **Свойства** можно просмотреть сведения о репликации и отработке отказа для виртуальной машины.

    ![Включение репликации](./media/site-recovery-vmm-to-azure/test-failover2.png)
3. В разделе **Вычисления и сеть** > **Свойства вычислений** можно указать имя и целевой размер виртуальной машины Azure. При необходимости измените имя в соответствии с [требованиями Azure](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) . Кроме того, можно просмотреть и изменить сведения о целевой сети, подсети и IP-адресе, назначенном виртуальной машине Azure.
Обратите внимание на следующее.

   * Вы можете задать целевой IP-адрес. Если не указать его, компьютер, для которого выполнена отработка отказа, будет использовать DHCP. Если задать адрес, недоступный при отработке отказа, произойдет сбой. Этот же целевой IP-адрес можно использовать для тестовой отработки отказа, если он доступен в сети тестовой отработки отказа.
   * Количество сетевых адаптеров зависит от размера, указанного для целевой виртуальной машины:

     * Если число сетевых адаптеров на исходной машине меньше или равно числу адаптеров, разрешенному для целевой машины, то количество адаптеров на целевой машине будет таким же.
     * Если число адаптеров на исходной виртуальной машине превышает допустимое для целевого размера, используется максимальный размер целевой машины.
     * Например, если на исходной машине есть два сетевых адаптера, а размер целевой машины поддерживает четыре, то на целевой машине будет два адаптера. Если на исходной машине два адаптера, но целевой размер поддерживает только один, то на целевой машине будет только один адаптер.     
     * Если для виртуальной машины настроено несколько сетевых адаптеров, они будут подключены к одной сети.

     ![Включение репликации](./media/site-recovery-vmm-to-azure/test-failover4.png)
4. На странице **Диски** отображаются сведения о дисках ОС и дисках данных на виртуальной машине, для которой будет выполняться репликация.

### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа
Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, обязательно сделайте следующее:

**На локальном компьютере до отработки отказа**.

* Чтобы получить доступ через Интернет, включите протокол RDP. Проверьте, добавлены ли правила TCP и UDP в разделе **Общее** и разрешен ли протокол RDP в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для всех профилей.
* Чтобы получить доступ через подключение типа "сеть — сеть", включите протокол RDP на компьютере. Проверьте, разрешен ли протокол RDP в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для сетей **домена** и **частных** сетей.
* Установите [агент виртуальной машины Azure](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) на локальном компьютере.
* Задайте для политики сети SAN операционной системы значение OnlineAll. [Дополнительные сведения](https://support.microsoft.com/kb/3031135)
* Перед выполнением отработки отказа отключите службу IPSec.

**На виртуальной машине Azure после отработки отказа**.

* Добавьте общедоступную конечную точку для протокола RDP (порт 3389) и укажите учетные данные для входа.
* Убедитесь в отсутствии политик домена, которые не допускают подключение к виртуальной машине с использованием общедоступного адреса.
* Попытайтесь подключиться. Если вам не удалось это сделать, убедитесь, что виртуальная машина запущена. Дополнительные советы по устранению неполадок см. в этой [статье](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Если после отработки отказа нужно получить доступ к виртуальной машине Azure под управлением Linux с помощью клиента SSH, выполните следующее:

**На локальном компьютере до отработки отказа**.

* Настройте автоматический запуск службы SSH на виртуальной машине Azure при загрузке системы (если он еще не настроен).
* Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.

**На виртуальной машине Azure после отработки отказа**.

* Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.
* Чтобы разрешить входящие подключения на порт SSH (TCP-порт 22 по умолчанию), необходимо создать общедоступную конечную точку.
* Если доступ к виртуальной машине осуществляется через VPN-подключение (Express Route или VPN типа "сеть — сеть"), можно использовать клиент для прямого подключения к виртуальной машине по протоколу SSH.


## <a name="step-7-test-your-deployment"></a>Шаг 7. Тестирование развертывания
Чтобы протестировать развертывание, можно запустить тестовую отработку отказа для отдельной виртуальной машины или создать план восстановления для одной или нескольких виртуальных машин.

1. Чтобы выполнить отработку отказа для одной виртуальной машины, в разделе **Реплицированные элементы** щелкните виртуальную машину и **+Test Failover** (+Тестовая отработка отказа).
1. Чтобы выполнить отработку отказа по плану восстановления, в разделе **Планы восстановления** щелкните план правой кнопкой мыши и выберите **Тестовая отработка отказа**. Чтобы создать план восстановления, [выполните эти инструкции](site-recovery-create-recovery-plans.md).
1. В разделе **Тестовая отработка отказа** выберите сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа.
1. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину, или в задании **тестовой отработки отказа** в разделе **Задания Site Recovery**.
1. После завершения отработки отказа реплика виртуальной машины Azure появится на портале Azure в разделе **Виртуальные машины**. Проверьте, имеет ли виртуальная машина соответствующий размер, подключена ли к соответствующей сети и работает ли она.
1. Если вы заранее [подготовились к подключению после отработки отказа](#prepare-to-connect-to-Azure-VMs-after-failover), то сможете подключиться к виртуальной машине Azure.
1. Когда все будет готово, нажмите кнопку **Очистить тестовую отработку отказа** в плане восстановления. При необходимости в разделе **примечаний** можно записать и сохранить ваши наблюдения касательно тестовой отработки отказа. Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.

См. дополнительные сведения о [тестовой отработке отказа в Azure](site-recovery-test-failover-to-azure.md).

## <a name="monitor-your-deployment"></a>Мониторинг развертывания
Вот как можно отслеживать параметры конфигурации, состояние и работоспособность развертывания Site Recovery:

1. Щелкните имя хранилища, чтобы открыть панель мониторинга **Основные компоненты** . На этой панели мониторинга можно просмотреть сведения о заданиях Site Recovery, состоянии репликации, планах восстановления, работоспособности сервера и событиях.  Панель **Основные компоненты** можно настроить таким образом, чтобы на ней отображались самые необходимые элементы и макеты, а также сведения о состоянии других хранилищ Site Recovery и службы архивации.

    ![Основные компоненты](./media/site-recovery-vmm-to-azure/essentials.png)
2. Элемент **Работоспособность** позволяет выявлять проблемы в работе локальных серверов (серверов VMM или серверов конфигурации), а также наблюдать за событиями, о которых сообщила служба Site Recovery за последние 24 часа.
3. Мониторинг репликации и управление ею осуществляется с помощью элементов **Реплицированные элементы**, **Планы восстановления** и **Site Recovery Jobs** (Задания Site Recovery). Чтобы получить подробные сведения о заданиях, выберите **Задания** > **Задания Site Recovery**.

## <a name="next-steps"></a>Дальнейшие действия
Настроив и запустив развертывание, ознакомьтесь с [дополнительными сведениями](site-recovery-failover.md) об отработке отказов.

