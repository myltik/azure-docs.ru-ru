---
title: Повторное включение защиты виртуальных машин, восстанавливаемых из Azure на локальном сайте | Документы Майкрософт
description: После отработки отказа виртуальных машин в Azure можно инициировать восстановление размещения, чтобы вернуть их в локальную среду. Сведения о включении повторной защиты перед восстановлением размещения.
services: site-recovery
documentationcenter: ''
author: rajani-janaki-ram
manager: gauravd
editor: ''
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 02/06/2018
ms.author: rajanaki
ms.openlocfilehash: c336966f9a785707e76bc6a10c4a9283d797d064
ms.sourcegitcommit: 0b02e180f02ca3acbfb2f91ca3e36989df0f2d9c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/07/2018
ms.locfileid: "29767789"
---
# <a name="reprotect-from-azure-to-an-on-premises-site"></a>Повторное включение защиты виртуальных машин, восстанавливаемых из Azure на локальный сайт



## <a name="overview"></a>Обзор
В этой статье описывается, как повторно включить защиту виртуальных машин Azure, восстанавливаемых из Azure на локальном сайте. Чтобы восстановить размещение виртуальных машин VMware или физических серверов Windows или Linux, для которых была выполнена отработка отказа с локального сайта в Azure (как описано в статье [Репликация виртуальных машин VMware и физических серверов в Azure с помощью Azure Site Recovery](site-recovery-failover.md)), следуйте инструкциям, изложенным в этой статье.

> [!WARNING]
> Если вы [выполнили миграцию](site-recovery-migrate-to-azure.md#what-do-we-mean-by-migration), переместили виртуальную машину в другую группу ресурсов или удалили виртуальную машину Azure, то после этого невозможно будет выполнить восстановление размещения. Если вы отключили защиту виртуальной машины, то вы не можете восстановить размещение. Если виртуальная машина была изначально создана в Azure (имеет облачную природу), вы не сможете повторно защитить ее при переносе обратно в локальную среду. Компьютер должен быть изначально защищен локально и выполнить отработку отказа в Azure, прежде чем включить повторную защиту.


После того как защита будет повторно включена и начнется репликация защищенных виртуальных машин, вы сможете запустить восстановление размещения виртуальных машин, чтобы вернуть их на локальный сайт.

> [!NOTE]
> Вы можете повторно включить защиту и выполнить восстановление размещения только на узел ESXi. Невозможно восстановить размещение виртуальной машины на узлы Hyper-V, рабочие станции VMware или любые другие платформы виртуализации.

Комментарии или вопросы можно добавить в конце этой статьи или на [форуме по службам восстановления Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).

Просмотрите видео ниже, чтобы получить общее представление о том, как выполнить отработку отказа из Azure на локальный сайт.
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="prerequisites"></a>предварительным требованиям

> [!IMPORTANT]
> Во время отработки отказа в Azure локальный сайт может стать недоступным, поэтому сервер конфигурации может быть недоступен или отключен. Во время повторной защиты и восстановления размещения локальный сервер конфигурации должен быть запущен и корректно подключен.


При подготовке к повторной защите виртуальных машин примите во внимание указанные ниже моменты и выполните ряд предварительных действий.

* Если управление виртуальными машинами, в которые необходимо выполнить восстановление размещения, осуществляется с помощью сервера vCenter Server, убедитесь в наличии [требуемых разрешений](site-recovery-vmware-to-azure-classic.md) для обнаружения виртуальных машин на серверах vCenter Server.

  > [!WARNING]
  > Если на локальном главном целевом сервере или виртуальной машине есть моментальные снимки, повторное включение защиты завершится сбоем. Их можно удалить с главного целевого сервера, прежде чем продолжить повторное включение защиты. Во время выполнения задания повторного включения защиты моментальные снимки на виртуальной машине автоматически объединяются.

* Прежде чем восстановить размещение, создайте два дополнительных компонента.

  * **Сервер обработки**. [Сервер обработки](site-recovery-vmware-setup-azure-ps-resource-manager.md) получает данные из защищенных виртуальных машин в Azure и отправляет их на локальный сайт. Между сервером обработки и защищенной виртуальной машиной должна быть настроена сеть с низкой задержкой. Таким образом, при использовании подключения ExpressRoute сервер обработки может находиться в локальной среде, а при использовании VPN-подключения — в Azure.
  
  * **Главный целевой сервер**. Этот сервер получает данные восстановления размещения. На сервере управления, созданном локально, главный целевой сервер установлен по умолчанию. Но в зависимости от объема трафика восстановления размещения для него может потребоваться создать отдельный главный целевой сервер.
    * [Для виртуальной машины Linux необходим главный целевой сервер Linux.](site-recovery-how-to-install-linux-master-target.md)
    * Для виртуальной машины Windows необходим главный целевой сервер Windows. Вы можете повторно использовать локальный сервер обработки и главные целевые машины.
    * Другие предварительные требования для главного целевого сервера см. в разделе [Что нужно проверить после установки главного целевого сервера](site-recovery-how-to-reprotect.md#common-things-to-check-after-completing-installation-of-the-master-target-server).

> [!NOTE]
> Все виртуальные машины группы репликации должны иметь одинаковый тип операционной системы (Windows или Linux). Группа репликации с несколькими операционными системами сейчас не поддерживается для повторного включения защиты и восстановления размещения в локальной среде. Причина в том, что главный целевой объект должен иметь ту же операционную систему, что и виртуальная машина. Все виртуальные машины группы репликации должны иметь одинаковый главный целевой объект. 

    

* При восстановлении размещения в локальной среде должен быть сервер конфигурации. Во время восстановления размещения виртуальная машина должна существовать в базе данных сервера конфигурации. В противном случае восстановление размещения завершается сбоем. 

> [!IMPORTANT]
> Не забывайте регулярно создавать плановые резервный копии конфигурации сервера. В случае аварии восстановите сервер с тем же IP-адресом, чтобы обеспечить восстановление размещения.

> [!WARNING]
> Группа репликации должна иметь только виртуальные машины Windows или Linux (а не сочетание обоих вариантов), так как все виртуальные машины в группе репликации используют один и тот же главный целевой сервер и для виртуальных машин Linux или Windows необходим соответствующий главный целевой сервер (Linux или Windows).

* В конфигурации главной целевой виртуальной машины в VMware задайте параметр `disk.EnableUUID=true`. Если этого параметра нет, добавьте его. Это позволит предоставить согласованный UUID для правильного подключения диска виртуальной машины (VMDK).

* *Вы не можете использовать технологию Storage vMotion на главном целевом сервере*. Из-за этого восстановление размещения может завершиться сбоем. Виртуальная машина не может запуститься, так как для нее нет доступных дисков. Чтобы избежать этой проблемы, исключите главные целевые серверы из списка vMotion.

* Добавьте на главный целевой сервер новый диск: диск хранения. Добавьте новый диск и отформатируйте его.


### <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

#### <a name="why-do-i-need-a-s2s-vpn-or-an-expressroute-connection-to-replicate-data-back-to-the-on-premises-site"></a>Зачем нужно VPN-подключение типа "сеть — сеть" или подключение ExpressRoute для репликации данных на локальный сайт?
Так как репликация из локальной среды в Azure может осуществляться через Интернет или подключение ExpressRoute с общедоступным пирингом, при повторном включении защиты и восстановлении размещения для репликации данных требуется VPN-подключение типа "сеть — сеть". Предоставьте сеть, через которую виртуальные машины в Azure, перенесенные при отработке отказа, смогут связываться (проверять связь) с локальным сервером конфигурации. Вы можете также развернуть сервер обработки в сети Azure виртуальной машины, для которой выполнена отработка отказа. Кроме того, этот сервер обработки должен иметь возможность взаимодействовать с локальным сервером конфигурации.

#### <a name="when-should-i-install-a-process-server-in-azure"></a>Когда следует установить сервер обработки в Azure?


Виртуальные машины Azure, для которых нужно повторно включить защиту, отправляют данные репликации на сервер обработки. Настройте сеть таким образом, чтобы виртуальные машины Azure могли связаться с сервером обработки.

Сервер обработки можно развернуть в Azure или задействовать существующий сервер обработки, который использовался во время отработки отказа. Важно учитывать задержку при отправке данных из виртуальных машин Azure на сервер обработки.

Если настроено подключение ExpressRoute, то для отправки данных можно использовать локальный сервер обработки, так как между ним и виртуальной машиной низкая задержка.

 ![Схема архитектуры для ExpressRoute](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)



Однако если вы настроили только VPN типа "сеть — сеть", мы рекомендуем развернуть сервер обработки в Azure.

 ![Схема архитектуры для VPN](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)


Помните, что репликация из Azure в локальную среду может осуществляться только через VPN-подключение типа "сеть — сеть" или частный пиринг сети ExpressRoute. Убедитесь, что этот сетевой канал обеспечивает достаточную пропускную способность.

Сведения об установке сервера обработки на основе Azure см. в статье [Управление сервером обработки, запущенным в Azure](site-recovery-vmware-setup-azure-ps-resource-manager.md).

> [!TIP]
> Мы рекомендуем использовать при восстановлении размещения сервер обработки на основе Azure. Производительность репликации повышается, если сервер обработки расположен ближе к реплицируемой виртуальной машине (в Azure — к компьютеру, для которого выполняется отработка отказа). Однако при подтверждении концепции или демонстрации можно использовать локальный сервер обработки вместе с ExpressRoute и частным пирингом, чтобы ускорить работу.

> [!NOTE]
> Репликация из локальной среды в Azure может осуществляться только через Интернет или частный пиринг сети ExpressRoute. Репликация из Azure в локальную среду может осуществляться только через VPN-подключение типа "сеть — сеть" или частный пиринг сети ExpressRoute.


#### <a name="what-ports-should-i-open-on-different-components-so-that-reprotection-can-work"></a>Какие порты следует открыть в разных компонентах для корректной работы повторной защиты?

![Порты для отработки отказа и восстановления размещения](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

#### <a name="which-master-target-server-should-i-use-for-reprotection"></a>Какой главный целевой сервер следует использовать для повторного включения защиты?
Главный целевой сервер, расположенный в локальной среде, нужен для получения данных от сервера обработки и их записи в VMDK-файл локальной виртуальной машины. Если вы защищаете виртуальные машины Windows, то нужен главный целевой сервер Windows. Вы можете повторно использовать локальный сервер обработки и главный целевой сервер<!-- !todo component -->. Для виртуальных машин Linux вам потребуется настроить дополнительный главный целевой сервер Linux, развернутый в локальной среде.


Сведения об установке главного целевого сервера см. в следующих статьях:

* [Выполнение единой установки Site Recovery](site-recovery-vmware-to-azure.md)
* [Как установить главный целевой сервер Linux](site-recovery-how-to-install-linux-master-target.md)


#### <a name="what-datastore-types-are-supported-on-the-on-premises-esxi-host-during-failback"></a>Какие типы хранилища поддерживаются на локальном узле ESXi при восстановлении размещения?

Сейчас Azure Site Recovery поддерживает восстановление размещения только в файловой системе виртуальной машины (VMFS) или в хранилище данных vSAN. Хранилище данных NFS не поддерживается. Из-за этого ограничения информация о выбранном хранилище данных на экране повторного включения защиты не отображается для хранилища данных NFS или отображается хранилище данных vSAN, но во время задания происходит сбой. Если вы планируете выполнить восстановление размещения, можно создать локальное хранилище данных VMFS и выполнить в нем восстановление размещения. Это восстановление размещения приведет к полному скачиванию VMDK.

### <a name="common-things-to-check-after-completing-installation-of-the-master-target-server"></a>Что нужно проверить после установки главного целевого сервера

* Если виртуальная машина размещена локально на сервере vCenter Server, то главному целевому серверу требуется доступ к VMDK-файлу этой локальной виртуальной машины. Это необходимо для записи реплицированных данных на диски виртуальной машины. Убедитесь, что хранилище данных локальной виртуальной машины подключено к узлу главного целевого сервера с доступом на чтение и запись.

* Если виртуальная машина не размещена локально на сервере vCenter Server, то во время повторного включения защиты службе Site Recovery требуется создать виртуальную машину. Она создается на узле ESX, на котором создан главный целевой сервер. Выбирайте узел ESX внимательно, чтобы виртуальная машина для восстановления размещения была создана на нужном узле.

* *Вы не можете использовать технологию Storage vMotion на главном целевом сервере*. Из-за этого восстановление размещения может завершиться сбоем. Виртуальная машина не может запуститься, так как для нее нет доступных дисков.

  > [!WARNING]
  > Если на главном целевом сервере после повторного включения защиты выполняется задача Storage vMotion, диски защищенных виртуальных машин, подключенные к главному целевому серверу, переносятся на целевой сервер задачи vMotion. Если после этого попытаться восстановить размещение, отключение диска завершается неудачей, так как диски не найдены. После этого найти диски в учетных записях хранения становится трудно. Их необходимо найти вручную и подключить к виртуальной машине. После этого можно загрузить локальную виртуальную машину.

* Добавьте на имеющийся главный целевой сервер Windows диск хранения. Добавьте новый диск и отформатируйте его. Диск хранения используется для остановки точек во времени при репликации виртуальной машины обратно на локальный сайт. Ниже перечислены некоторые критерии для диска хранения. Если они не выполнены, то диск не появится на главном целевом сервере.

   * Том не используется ни для какой иной цели, к примеру, как цель репликации.

   * Том не находится в режиме блокировки.

   * Том не является томом кэша. На томе не должен присутствовать установленный экземпляр главного целевого сервера. Пользовательский том установки сервера обработки и главного целевого сервера не может использоваться как том хранения. Если на этом томе установлен сервер обработки и главный целевой сервер, он используется в качестве тома кэша главного целевого сервера.

   * Типом файловой системы тома не является FAT или FAT32.

   * Размер тома не равен нулю.

   * Том хранения по умолчанию для Windows — это том R.

   * Том хранения по умолчанию для Linux — /mnt/retention.

  > [!IMPORTANT]
  > Если вы используете существующий компьютер с сервером конфигурации и сервером обработки или компьютер с сервером обработки и главным целевым сервером, нужно добавить новый диск. Этот диск должен удовлетворять перечисленным выше требованиям. Если диск хранения отсутствует, он не отображается в раскрывающемся списке на портале. После добавления диска на локальный главный целевой сервер для его появления на портале может потребоваться до 15 минут. Если через 15 минут диск так и не появился, вы также можете обновить сервер конфигурации.

* Для виртуальной машины Linux, для которой выполнена отработка отказа, необходим главный целевой сервер Linux, а для виртуальной машины Windows (также после отработки отказа) — главный целевой сервер Windows.

* Установите инструменты VMware на главном целевом сервере. Без них не удастся обнаружить хранилища данных на узле ESXi главного целевого сервера.

* Включите параметр `disk.EnableUUID=true` на главной целевой виртуальной машине с использованием свойств vCenter. <!-- !todo Needs link. -->

* К главному целевому серверу должно быть подключено по крайней мере одно хранилище данных VMFS. Если такового нет, сведения о **хранилище данных** на странице повторного включения защиты отображаться не будут, и вы не сможете продолжить работу.

* На дисках главного целевого сервера не должно быть моментальных снимков. В противном случае при повторном включении защиты или восстановлении размещения происходит сбой.

* На главном целевом сервере не может находиться контроллер Paravirtual SCSI. На нем может быть только контроллер LSI Logic. Если контроллер LSI Logic отсутствует, при повторном включении защиты происходит сбой.

* В любом заданном экземпляре главный целевой сервер может иметь не более 60 подключенных дисков. Если несколько виртуальных машин, которые защищены повторно в локальном главном целевом сервере, имеют число дисков, превышающее 60, то включение защиты в главном целевом сервере будет завершаться сбоем. Убедитесь, что у вас есть достаточно слотов для дисков главного целевого сервера или разверните дополнительные главные целевые серверы.

<!--
### Failback policy
To replicate back to on-premises, you will need a failback policy. This policy get automatically created when you create a forward direction policy. Note that

1. This policy gets auto associated with the configuration server during creation.
2. This policy is not editable.
3. The set values of the policy are (RPO Threshold = 15 Mins, Recovery Point Retention = 24 Hours, App Consistency Snapshot Frequency = 60 Mins)
   ![](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

-->

## <a name="steps-to-reprotect"></a>Инструкции по повторному включению защиты

> [!NOTE]
> После загрузки виртуальной машины в Azure требуется некоторое время для повторной регистрации агента на сервере конфигурации (не более 15 минут). Если включить повторную защиту в течение этого времени, произойдет сбой, и на экране отобразится сообщение о том, что агент не установлен. Подождите несколько минут, а затем включите повторную защиту еще раз.



1. В разделе **Хранилище** > **Реплицированные элементы** щелкните виртуальную машину, для которой проводилась отработка отказа, правой кнопкой мыши и выберите **Защитить повторно**. Вы также можете щелкнуть машину и выбрать параметр **Защитить повторно**, используя кнопки управления.
2. Обратите внимание, что в открывшейся колонке уже выбрано направление защиты **Из Azure на локальный компьютер**.
3. В полях **Главный целевой сервер** и **Сервер обработки** выберите локальный главный целевой сервер и сервер обработки.
4. В поле **Хранилище данных** выберите хранилище данных, для которого нужно восстановить диски локальной среды. Используйте этот параметр, если локальная виртуальная машина была удалена и вам нужно создать диски. Хотя этот параметр не учитывается, если диски уже существуют, его значение необходимо указать.
5. Выберите диск хранения.
6. Политика восстановления размещения выбирается автоматически.
7. Нажмите кнопку **ОК**, чтобы начать процесс повторной защиты. Задание начнет реплицировать виртуальную машину из Azure на локальный сайт. Ход выполнения операции можно отслеживать на вкладке **Задания** .

Если необходимо выполнить восстановление в альтернативное расположение (если локальная виртуальная машина удалена), выберите диск хранения и хранилище данных, настроенные для главного целевого сервера. При восстановлении размещения на локальном сайте виртуальные машины VMware в плане защиты восстановления размещения используют то же хранилище данных, что и главный целевой сервер. В vCenter создается виртуальная машина.

Если вы хотите восстановить виртуальную машину Azure в имеющуюся локальную виртуальную машину, подключите хранилища данных локальной виртуальной машины с доступом на чтение и запись к узлу ESXi главного целевого сервера.
    ![Диалоговое окно "Защитить повторно"](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

Защиту можно также включить повторно на уровне плана восстановления. Группу репликации можно повторно защитить только с помощью плана восстановления. В этом случае необходимо предоставить значения для каждой защищенной машины.

> [!NOTE]
> Для повторной защиты группы репликации используйте тот же главный целевой сервер. При выборе другого главного целевого сервера он не сможет предоставить общую точку во времени.

> [!NOTE]
> Во время повторного включения защиты локальная виртуальная машина отключается. Это позволяет обеспечить согласованность данных во время репликации. Не включайте виртуальную машину после завершения повторного включения защиты.

После успешного повторного включения защиты виртуальная машина перейдет в защищенное состояние.

## <a name="common-issues"></a>Распространенные проблемы

* Если виртуальные машины созданы с помощью шаблона, убедитесь в том, что диски каждой виртуальной машины имеют UUID. При возникновении конфликта UUID локальной виртуальной машины и главного целевого сервера из-за того, что оба компонента созданы на основе одного шаблона, происходит сбой повторного включения защиты. В таком случае разверните другой главный целевой сервер, созданный на основе другого шаблона.

* Если выполнить обнаружение vCenter в режиме пользователя только для чтения и защитить виртуальные машины, операция настройки защиты завершится успешно и отработка отказа будет работать. Во время повторного включения защиты происходит сбой отработки отказа, так как невозможно обнаружить хранилища данных. Признаком этой ситуации является отсутствие списка хранилищ данных при повторном включении защиты. Для устранения этой проблемы можно обновить учетные данные vCenter, указав учетную запись с соответствующими разрешениями, и повторить задание. Дополнительные сведения см. в разделе [Репликация виртуальных машин VMware и физических серверов в Azure с помощью службы Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).

* При восстановлении размещения виртуальной машины Linux и ее последующем запуске в локальной среде вы видите, что с этой виртуальной машины удален пакет диспетчера сети. Это вызвано тем, что при восстановлении виртуальной машины в Azure пакет диспетчера сети удаляется.

* Если отработка отказа виртуальной машины Linux со статическим IP-адресом выполняется в Azure, IP-адрес предоставляется из DHCP. При восстановлении размещения в локальной среде виртуальная машина также будет получать IP-адрес из DHCP. Вручную войдите на виртуальную машину и снова настройте статический IP-адрес, если это необходимо. Виртуальная машина Windows может получать статический IP-адрес повторно.

* Если вы используете бесплатный выпуск ESXi версии 5.5 или vSphere Hypervisor версии 6, отработка отказа будет выполнена успешно, но восстановление размещения завершится сбоем. Чтобы включить восстановления размещения, необходимо выполнить обновление до любой из версий с ознакомительной лицензией.

* Если сервер конфигурации недоступен с сервера обработки, проверьте возможность подключения к серверу конфигурации по протоколу Telnet через порт 443. Вы также можете проверить связь с сервером конфигурации из сервера обработки. Сервер обработки должен также отвечать на пульс, когда он подключен к серверу конфигурации.

* Если вы пытаетесь восстановить размещение на альтернативном сервере vCenter, убедитесь в том, что новый сервер vCenter и главный целевой сервер обнаружены. Характерный симптом: хранилища недоступны и отсутствуют в диалоговом окне **Повторная защита**.

* Сервер Windows Server 2008 R2 с пакетом обновления 1 (SP1), защищенный как физический локальный сервер, не может быть восстановлен из Azure на локальный сайт.


## <a name="next-steps"></a>Дополнительная информация

После того как виртуальная машина перейдет в защищенное состояние, можно [инициировать восстановление размещения](site-recovery-how-to-failback-azure-to-vmware.md#steps-to-fail-back). 

При этом будет завершена работа виртуальной машины в Azure и загружена локальная виртуальная машина. В работе приложения будет незначительный простой. Выберите для восстановления размещения период, когда простой приложения допустим.