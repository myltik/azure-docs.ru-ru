---
title: Устранение неполадок с репликацией из Hyper-V в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье описаны способы устранения неполадок с репликацией из Hyper-V в Azure с помощью Azure Site Recovery.
services: site-recovery
documentationcenter: ''
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 04/09/2018
ms.author: rayne
ms.openlocfilehash: 95a33c80b1aeef7fbf8bea0ab760bbd66babdac8
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
ms.locfileid: "31426682"
---
# <a name="troubleshoot-hyper-v-to-azure-replication-and-failover"></a>Устранение неполадок с отработкой отказа и репликацией из Hyper-V в Azure

В этой статье описаны распространенные неполадки, которые могут возникнуть при репликации локальных виртуальных машин Hyper-V в Azure с помощью [Azure Site Recovery](site-recovery-overview.md).

## <a name="enable-protection-issues"></a>Проблемы при включении защиты

Если возникли проблемы при включении защиты виртуальных машин Hyper-V, сделайте следующее.

1. Убедитесь, что узлы и виртуальные машины Hyper-V соответствуют всем [предварительным требованиям](hyper-v-azure-support-matrix.md).
2. Если серверы Hyper-V расположены в облаках System Center Virtual Machine Manager (VMM), убедитесь, что [сервер VMM](hyper-v-prepare-on-premises-tutorial.md#prepare-vmm-optional) подготовлен.
3. Проверьте, запущена ли служба управления виртуальными машинами Hyper-V на узлах Hyper-V.
4. Проверьте журнал Hyper-V-VMMS\Admin на виртуальной машине на наличие проблем. Этот журнал расположен в папке **Applications and Services Logs** > **Microsoft** > **Windows**.
5. Включите на гостевой виртуальной машине инструментарий управления Windows (WMI) и проверьте, что он доступен.
  - Узнайте о [базовом тестировании инструментария WMI](https://blogs.technet.microsoft.com/askperf/2007/06/22/basic-wmi-testing/).
  - Узнайте об [устранении неполадок с помощью инструментария WMI](https://aka.ms/WMiTshooting).
  - Узнайте об [устранении неполадок](https://technet.microsoft.com/library/ff406382.aspx#H22) с помощью скриптов и служб WMI.
5. Проверьте, запущена ли на гостевой виртуальной машине последняя версия служб Integration Services.
    - [Убедитесь](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services), что у вас установлена последняя версия.
    - [Постоянно обновляйте](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services#keep-integration-services-up-to-date) службы Integration Services.
    
## <a name="replication-issues"></a>Проблемы с репликацией

Устраните неполадки с начальной и выполняющейся репликацией следующим образом.

1. Убедитесь, что вы используете [последнюю версию](https://social.technet.microsoft.com/wiki/contents/articles/38544.azure-site-recovery-service-updates.aspx) служб Site Recovery.
2. Проверьте, приостановлена ли репликация.
  - Проверьте состояние работоспособности виртуальной машины в консоли диспетчера Hyper-V.
  - Если оно критическое, щелкните правой кнопкой мыши виртуальную машину > **Репликация** > **Просмотреть состояние работоспособности репликации**.
  - Если репликация приостановлена, щелкните **Возобновить репликацию**.
3. Убедитесь, что все необходимые службы запущены. В противном случае перезапустите их.
    - Если вы выполняете репликацию Hyper-V без VMM, на узле Hyper-V должны быть запущены следующие службы:
        - служба управления виртуальными машинами;
        - служба агента служб восстановления Microsoft Azure;
        - служба Microsoft Azure Site Recovery;
        - служба узла поставщика WMI.
    - При выполнении репликации в среде с VMM проверьте, запущены ли следующие службы.
        - Убедитесь, что на узле Hyper-V запущена служба управления виртуальными машинами, агент служб восстановления Microsoft Azure и служба узла поставщика WMI.
        - Убедитесь, что на сервере VMM запущена служба System Center Virtual Machine Manager.
4. Проверьте подключение между сервером Hyper-V и Azure. Для этого откройте диспетчер задач на узле Hyper-V. На вкладке **Производительность** щелкните **Открыть монитор ресурсов**. На вкладке **Сеть** > **Processess with Network Activity** (Процессы с сетевой активностью) проверьте, передает ли файл cbengine.exe большие объемы данных (МБ).
5. Проверьте, могут ли узлы Hyper-V подключаться к URL-адресу хранилища BLOB-объектов Azure. Для этого выделите и проверьте файл **cbengine.exe**. Просмотрите **TCP-подключения**, чтобы проверить возможность подключения между узлом и хранилищем BLOB-объектов Azure.
6. Проверьте, есть ли проблемы с производительностью, как описано ниже.
    
### <a name="performance-issues"></a>Проблемы с производительностью

Ограничения пропускной способности сети могут повлиять на выполнение репликации. Устраните неполадки следующим образом.

1. [Проверьте](https://support.microsoft.com/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage), есть ли в среде ограничения пропускной способности и регулирования количества запросов.
2. Запустите профилировщик [Планировщик развертывания](hyper-v-deployment-planner-run.md).
3. После запуска профилировщика выполните рекомендации для настройки [пропускной способности](hyper-v-deployment-planner-analyze-report.md#recommendations-with-available-bandwidth-as-input) и [хранилища](hyper-v-deployment-planner-analyze-report.md#vm-storage-placement-recommendation).
4. Проверьте [ограничения обработки данных](hyper-v-deployment-planner-analyze-report.md#azure-site-recovery-limits). Если на виртуальной машине выполняется активная обработка данных, сделайте следующее.
  - Проверьте, отмечена ли виртуальная машина для повторной синхронизации.
  - Выполните [эти действия](https://blogs.technet.microsoft.com/virtualization/2014/02/02/hyper-v-replica-debugging-why-are-very-large-log-files-generated/), чтобы исследовать источник обработки данных.
  - Обработка может возникнуть, если файлы журналов HRL занимают больше 50 % доступного места на диске. Если это проблема, подготовьте дополнительное дисковое пространство для всех виртуальных машин, на которых она возникает.
  - Убедитесь, что репликация не приостановилась. Если она приостановлена, изменения продолжают записываться в HRL-файл, что может способствовать увеличению его размера.
 

## <a name="critical-replication-state-issues"></a>Критические проблемы с состоянием репликации

1. Чтобы проверить работоспособность репликации, подключитесь к локальной консоли диспетчера Hyper-V, выберите виртуальную машину и проверьте работоспособность.

    ![Состояние работоспособности репликации](media/hyper-v-azure-troubleshoot/replication-health1.png)
    

2. Чтобы просмотреть подробные сведения, выберите пункт **View Replication Health** (Просмотреть состояние работоспособности репликации).

    - Если репликация приостановлена, щелкните правой кнопкой мыши виртуальную машину > **Репликация** > **Возобновить репликацию**.
    - Перенос виртуальной машины с настроенного в Site Recovery узла Hyper-V на другой узел Hyper-V в том же кластере или на автономный компьютер не влияет на репликацию виртуальной машины. Просто убедитесь, что новый узел Hyper-V соответствует всем предварительным требованиям и настроен в Site Recovery.

## <a name="app-consistent-snapshot-issues"></a>Проблемы моментальных снимков с согласованием приложений

Моментальный снимок с согласованием приложений представляет собой созданный на определенный момент времени снимок данных приложения в виртуальной машине. Служба теневого копирования томов (VSS) обеспечивает согласованное состояние приложения в виртуальной машине при создании моментального снимка.  В этом разделе описаны распространенные проблемы.

### <a name="vss-failing-inside-the-vm"></a>Сбой VSS в виртуальной машине

1. Проверьте, установлена и запущена ли последняя версия служб Integration Services.  Проверьте, доступно ли обновление. В командной строке PowerShell с повышенными привилегиями на узле Hyper-V выполните следующую команду: **get-vm | выберите Name, State, IntegrationServicesState**.
2. Проверьте, запущены ли службы VSS, и убедитесь, что они работоспособны.
    - Для этого войдите на гостевую виртуальную машину. Затем для проверки работоспособности всех модулей записи VSS откройте командную строку с правами администратора и выполните следующие команды.
        - **Vssadmin list writers**
        - **Vssadmin list shadows**
        - **Vssadmin list providers**
    - Просмотрите выходные данные. Если модули записи находятся в состоянии сбоя, сделайте следующее.
        - Проверьте, нет ли в журнале событий приложений на виртуальной машине ошибок с операциями VSS.
    - Попробуйте перезапустить службы, связанные с неисправными модулями записи:
        - служба теневого копирования томов;
         - поставщик VSS Azure Site Recovery.
    - Затем через несколько часов проверьте, успешно ли созданы моментальные снимки с согласованием приложений.
    - В крайнем случае попробуйте перезагрузить виртуальную машину. Это может решить проблемы со службами, которые не отвечают.
3. Проверьте, имеются ли на виртуальной машине динамические диски. Эта возможность недоступна для моментальных снимков с согласованием приложений. Вы можете проверить управление дисками (diskmgmt.msc).

    ![Динамический диск](media/hyper-v-azure-troubleshoot/dynamic-disk.png)
    
4. Убедитесь, что диск iSCSI не подключен к виртуальной машине. Эта возможность не поддерживается.
5. Проверьте, включена ли служба резервного копирования. Для этого выберите **Параметры Hyper-V** > **Integration Services**.
6. Убедитесь, что между приложениями, создающими моментальные снимки VSS, не возникают конфликты. Они возникают, если несколько приложений попытаются создать моментальные снимки VSS одновременно. Например, если приложение резервного копирования создает моментальные снимки VSS в то время, когда по расписанию в политике репликации должно создавать снимки приложение Site Recovery.   
7. Проверьте, наблюдается ли большая скорость изменения данных на виртуальной машине.
    - Частоту ежедневного изменения данных для гостевых виртуальных машин можно измерить с помощью счетчиков производительности на узле Hyper-V. Для этого включите следующий счетчик. Зафиксируйте пример этого значения на дисках виртуальной машины в течение 5–15 минут, чтобы получить сведения об изменении данных виртуальной машины.
        - Категория: "Виртуальное устройство хранения Hyper-V".
        - Счетчик: "Записанных байтов в секунду".</br>
        - Скорость изменения данных увеличится или останется на высоком уровне. Это зависит от текущей загруженности виртуальной машины или ее приложений.
        - Для стандартного хранилища в Site Recovery среднее значение скорости изменения данных исходного диска составляет 2 МБ в секунду. [Подробнее](hyper-v-deployment-planner-analyze-report.md#azure-site-recovery-limits)
    - Кроме того, можно [проверить целевые показатели масштабируемости хранилища](https://docs.microsoft.com/azure/storage/common/storage-scalability-targets.md#scalability-targets-for-a-storage-account).
8. Запустите [планировщик развертывания](hyper-v-deployment-planner-run.md).
9. Просмотрите рекомендации для настройки [сети](hyper-v-deployment-planner-analyze-report.md#recommendations-with-available-bandwidth-as-input) и [хранилища](hyper-v-deployment-planner-analyze-report.md#recommendations-with-available-bandwidth-as-input).


### <a name="vss-failing-inside-the-hyper-v-host"></a>Сбой VSS внутри узла Hyper-V

1. Проверьте журналы событий на наличие ошибок VSS и просмотрите рекомендации.
    - На сервере узла Hyper-V откройте журнал событий администратора Hyper-V, выбрав **Средство просмотра событий** > **Applications and Services Logs** > **Microsoft** > **Windows** > **Hyper-V** > **Admin**.
    - Проверьте, есть ли там события, указывающие на сбои моментальных снимков с согласованием приложений.
    - Распространенная ошибка: "Hyper-V failed to generate VSS snapshot set for virtual machine 'XYZ': The writer experienced a non-transient error. Restarting the VSS service might resolve issues if the service is unresponsive" (Hyper-V не удалось создать набор моментальных снимков VSS для виртуальной машины XYZ. Повторяющаяся ошибка модуля записи. Если служба VSS не отвечает, можно попробовать перезапустить ее).

2. Чтобы создавать моментальные снимки VSS для виртуальной машины, установите на виртуальной машине службы Integration Services Hyper-V и включите службу интеграции резервного копирования (VSS).
    - Убедитесь, что службы или управляющие программы Integration Services VSS выполняются на гостевой виртуальной машине и находятся в состоянии **ОК**.
    - Это можно проверить из сеанса PowerShell с повышенными привилегиями на узле Hyper-V с помощью команды **et-VMIntegrationService -VMName<VMName>-Name VSS**. Эту информацию можно также получить, войдя на гостевую виртуальную машину. [Узнайте больше](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services).
    - Убедитесь, что службы интеграции резервного копирования или VSS на виртуальной машине запущены и находятся в работоспособном состоянии. В противном случае перезапустите эти службы и службу запросов на теневое копирование томов Hyper-V на сервере узла Hyper-V.

### <a name="common-errors"></a>Распространенные ошибки

**Код ошибки** | **Сообщение** | **Дополнительные сведения**
--- | --- | ---
**0x800700EA** | "Hyper-V failed to generate VSS snapshot set for virtual machine: More data is available. (0x800700EA). VSS snapshot set generation can fail if backup operation is in progress.<br/><br/> Replication operation for virtual machine failed: More data is available" (Hyper-V не удалось создать набор моментальных снимков VSS для виртуальной машины. Доступно больше данных. Процесс создания моментальных снимков VSS может завершиться неудачно, если выполняется операция резервного копирования. Не удалось выполнить операцию репликации для виртуальной машины. Доступно больше данных). | Проверьте, включен ли на виртуальной машине динамический диск. Эта возможность не поддерживается.
**0x80070032** | "Hyper-V Volume Shadow Copy Requestor failed to connect to virtual machine <./VMname> because the version does not match the version expected by Hyper-V" (Не удалось подключить службу запросов на теневое копирование томов Hyper-V к виртуальной машине <./имя ВМ>, так как имеющаяся версия не соответствует ожидаемый Hyper-V). | Проверьте, установлены ли последние обновления Windows.<br/><br/> [Обновите](https://docs.microsoft.com/windows-server/virtualization/hyper-v/manage/manage-hyper-v-integration-services.md#keep-integration-services-up-to-date) службы Integration Services до последней версии.



## <a name="collect-replication-logs"></a>Сбор журналов событий репликации

Все события репликации Hyper-V записываются в журнал Hyper-V-VMMS\Admin log, расположенный в папке **Applications and Services Logs** > **Microsoft** > **Windows**. Кроме того, для службы управления виртуальными машинами Hyper-V можно включить аналитический журнал.

1. Сначала убедитесь, что аналитический журнал и журнал отладки видны в средстве просмотра событий. Для этого откройте средство просмотра событий и выберите **Представление** > **Show Analytic and Debug Logs** (Отобразить аналитический и отладочный журналы). Аналитический журнал отображается в группе **Hyper-V-VMMS**.
2. В области **Действия** выберите **Включить журнал**. 

    ![Включить журнал](media/hyper-v-azure-troubleshoot/enable-log.png)
    
3. После включения журнал отображается в **системном мониторе** как **сеанс трассировки событий** в области **Группы сборщиков данных**. 
4. Для просмотра собранных сведений остановите сеанс трассировки, отключив журнал. Затем сохраните журнал и откройте его снова в средстве просмотра событий или используйте другое средство для преобразования журнала в необходимый формат.


### <a name="event-log-locations"></a>Расположения журналов событий

**Журнал событий** | **Дополнительные сведения** |
--- | ---
**Applications and Service Logs/Microsoft/VirtualMachineManager/Server/Admin** (сервер VMM) | Журналы, с помощью которых можно устранять проблемы с VMM.
**Applications and Service Logs/MicrosoftAzureRecoveryServices/Replication** (узел Hyper-V) | Журналы, с помощью которых можно устранять проблемы с агентом служб восстановления Microsoft Azure. 
**Applications and Service Logs/Microsoft/Azure Site Recovery/Provider/Operational** (узел Hyper-V)| Журналы, с помощью которых можно устранять проблемы со службой Microsoft Azure Site Recovery.
**Applications and Service Logs/Microsoft/Windows/Hyper-V-VMMS/Admin** (узел Hyper-V) | Журналы, с помощью которых можно устранять проблемы со службой управления виртуальными машинами Hyper-V.

### <a name="log-collection-for-advanced-troubleshooting"></a>Сбор данных журналов для использования при устранении неполадок

Эти средства могут помочь при устранении неполадок:

-   Для VMM выполните сбор данных журнала Site Recovery с помощью [средства Support Diagnostics Platform (SDP)](http://social.technet.microsoft.com/wiki/contents/articles/28198.asr-data-collection-and-analysis-using-the-vmm-support-diagnostics-platform-sdp-tool.aspx).
-   Для Hyper-V без VMM [загрузите это средство](https://dcupload.microsoft.com/tools/win7files/DIAG_ASRHyperV_global.DiagCab) и запустите его на узле Hyper-V для сбора данных журналов.

