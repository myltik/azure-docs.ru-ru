---
title: Репликация многоуровневого приложения SharePoint с помощью Azure Site Recovery | Документы Майкрософт
description: В этой статье рассматривается репликация многоуровневого приложения SharePoint с помощью возможностей Azure Site Recovery.
services: site-recovery
documentationcenter: ''
author: sujayt
manager: rochakm
editor: ''
ms.assetid: ''
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/02/2018
ms.author: sutalasi
ms.openlocfilehash: de787ec5078d4cec53bcd2fcc24129e651c711bc
ms.sourcegitcommit: 870d372785ffa8ca46346f4dfe215f245931dae1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2018
---
# <a name="replicate-a-multi-tier-sharepoint-application-for-disaster-recovery-using-azure-site-recovery"></a>Репликация многоуровневого приложения SharePoint для аварийного восстановления с помощью Azure Site Recovery | Документы Майкрософт

В этой статье подробно описывается защита приложения SharePoint с помощью [Azure Site Recovery](site-recovery-overview.md).


## <a name="overview"></a>Обзор

Microsoft SharePoint — это эффективное приложение, которое может помочь рабочей группе или отделу организовать информацию, обмениваться ею и осуществлять совместную работу. SharePoint может предоставлять порталы интрасети, функции управления файлами и документами, совместной работы, социальных сетей, экстрасетей, веб-сайтов, поиска в корпоративной среде и бизнес-аналитики. Эта система также включает возможности интеграции систем и процессов и автоматизации рабочих процессов. Как правило, организации рассматривают его как приложение первого уровня, чувствительное к простоям и потере данных.

На данный момент Microsoft SharePoint не предоставляет какие-либо готовые функции аварийного восстановления. Независимо от типа и масштаба аварии, восстановление включает использование резервного центра обработки данных, в котором можно восстановить ферму. Резервные центры обработки данных требуются для сценариев, когда локальные избыточные системы и резервные копии не позволяют выполнить восстановление после сбоя в основном центре обработки данных.

Хорошее решение аварийного восстановления должно допускать моделирование планов восстановления для сложных архитектур приложений, таких как SharePoint. Оно также должно включать возможность добавления настраиваемых действий для обработки сопоставлений приложений между различными уровнями и, таким образом, обеспечивать быструю отработку отказа с низким RTO в случае аварии.

В этой статье подробно описывается защита приложения SharePoint с помощью [Azure Site Recovery](site-recovery-overview.md). Здесь мы рассмотрим рекомендации по репликации трехуровневого приложения SharePoint в Azure, выполнение отработки аварийного восстановления и отработки отказа приложения в Azure.

В видеоролике ниже рассказывается о восстановлении многоуровневого приложения в Azure.

> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/Disaster-Recovery-of-load-balanced-multi-tier-applications-using-Azure-Site-Recovery/player]


## <a name="prerequisites"></a>предварительным требованиям

Прежде чем продолжить, ознакомьтесь со следующими статьями:

1. [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](site-recovery-vmware-to-azure.md)
2. [Проектирование сети для аварийного восстановления](site-recovery-network-design.md)
3. [Тестовая отработка отказа в Azure в Site Recovery](site-recovery-test-failover-to-azure.md)
4. [Отработка отказа в Site Recovery](site-recovery-failover.md)
5. [Защита Active Directory и DNS с Azure Site Recovery](site-recovery-active-directory.md)
6. [Защита SQL Server с помощью аварийного восстановления SQL Server и Azure Site Recovery](site-recovery-sql.md)

## <a name="sharepoint-architecture"></a>Архитектура SharePoint

SharePoint можно развертывать на одном или нескольких серверах с помощью многоуровневых топологий и ролей сервера для реализации архитектуры фермы, отвечающей конкретным требованиям и целям. Типичная большая ферма серверов SharePoint с высокой загрузкой, которая поддерживает большое число одновременных пользователей и элементов содержимого, использует группирование служб как часть стратегии масштабирования. Этот подход включает выполнение служб на выделенных серверах, их группирование, а затем масштабирование серверов как группы. Следующие топологии иллюстрирует группирование служб и серверов для трехуровневой фермы серверов SharePoint. Подробное руководство по различным топологиям SharePoint можно найти в документации по SharePoint и описаниях архитектур семейств продуктов. Дополнительные сведения о развертывании SharePoint 2013 см. в [этом документе](https://technet.microsoft.com/library/cc303422.aspx).



![Модель развертывания 1](./media/site-recovery-sharepoint/sharepointarch.png)


## <a name="site-recovery-support"></a>Поддержка Site Recovery

Для написания этой статьи использовались виртуальные машины VMware под управлением Windows Server 2012 R2 Enterprise. Кроме того, использовались выпуски SharePoint 2013 Enterprise и SQL Server 2014 Enterprise. Так как репликация Site Recovery не зависит от приложения, описанные здесь рекомендации также подходят для сценариев, представленных ниже.

### <a name="source-and-target"></a>Исходный и целевой объект

**Сценарий** | **На дополнительный сайт** | **В Azure**
--- | --- | ---
**Hyper-V** | Yes | Yes
**VMware** | Yes | Yes
**Физический сервер** | Yes | Yes
**Таблицы Azure** | Нет данных | Yes

### <a name="sharepoint-versions"></a>Версии SharePoint
Поддерживаются следующие версии SharePoint Server.

* SharePoint Server 2013 Standard
* SharePoint Server 2013 Enterprise
* SharePoint Server 2016 Standard
* SharePoint Server 2016 Enterprise

### <a name="things-to-keep-in-mind"></a>Важные аспекты

При использовании общего кластера на основе диска в качестве любого из уровней приложения вы не сможете использовать репликацию Site Recovery для репликации таких виртуальных машин. Можно использовать собственный механизм репликации, предоставляемый приложением, а затем применить [план восстановления](site-recovery-create-recovery-plans.md) для отработки отказа всех уровней.

## <a name="replicating-virtual-machines"></a>Репликация виртуальных машин

В [этом руководстве](site-recovery-vmware-to-azure.md) приводится процедура первой репликации виртуальных машин в Azure.

* После завершения репликации необходимо перейти к каждой виртуальной машине каждого уровня и выбрать одну и ту же группу доступности в разделе "Реплицируемый элемент" > "Параметры" > "Свойства" > "Вычисления и сети". Например, если веб-уровень включает три виртуальные машины, убедитесь, что все три виртуальные машины настроены как часть одной группы доступности в Azure.

    ![Set-Availability-Set](./media/site-recovery-sharepoint/select-av-set.png)

* Рекомендации по защите Active Directory и DNS см. в [соответствующем документе](site-recovery-active-directory.md).

* Рекомендации по защите уровня базы данных на сервере SQL Server см. в документе, посвященном [защите SQL Server](site-recovery-active-directory.md).

## <a name="networking-configuration"></a>Конфигурация сети

### <a name="network-properties"></a>Свойства сети

* Для виртуальных машин веб-уровня и уровня приложений настройте параметры сети на портале Azure таким образом, чтобы виртуальные машины подключались к правильной сети аварийного восстановления после отработки отказа.

    ![Выбор сети](./media/site-recovery-sharepoint/select-network.png)


* Если вы используете статический IP-адрес, укажите нужный IP-адрес для виртуальной машины в поле **Целевой IP-адрес**.

    ![Настройка статического IP-адреса](./media/site-recovery-sharepoint/set-static-ip.png)

### <a name="dns-and-traffic-routing"></a>DNS и маршрутизация трафика

Для сайтов, работающих с Интернетом, [создайте профиль диспетчера трафика типа "Приоритет"](../traffic-manager/traffic-manager-create-profile.md) в подписке Azure. Затем настройте профиль DNS и диспетчера трафика следующим образом.


| **Where** | **Источник** | **Цель**|
| --- | --- | --- |
| Общедоступное имя DNS | Общедоступное имя DNS для сайтов SharePoint <br/><br/> Например: sharepoint.contoso.com | Диспетчер трафика <br/><br/> contososharepoint.trafficmanager.net |
| Локальное имя DNS | sharepointonprem.contoso.com | Общедоступный IP-адрес в локальной ферме |


В профиле диспетчера трафика [создайте первичную конечную точку и конечную точку восстановления](../traffic-manager/traffic-manager-configure-priority-routing-method.md). Используйте внешнюю конечную точку для локальной конечной точки и общедоступный IP-адрес для конечной точки Azure. Убедитесь, что для локальной конечной точки задан более высокий приоритет.

Разместите тестовую страницу по определенному порту (например, 800) в веб-уровне SharePoint, чтобы диспетчер трафика мог автоматически обнаруживать доступность после отработки отказа. Это обходное решение на случай, если невозможно включить анонимную проверку подлинности для всех сайтов SharePoint.

[Настройте профиль диспетчера трафика](../traffic-manager/traffic-manager-configure-priority-routing-method.md), используя приведенные ниже параметры.

* Метод маршрутизации — "Приоритет"
* Срок жизни (TTL) DNS — "30 секунд"
* Параметры монитора конечной точки — если можно включить анонимную проверку подлинности, вы можете указать конечную точку определенного веб-сайта. В противном случае можно использовать тестовую страницу по конкретному порту (например, 800).

## <a name="creating-a-recovery-plan"></a>Создание плана восстановления

План восстановления в многоуровневом приложении позволяет выполнять виртуализацию отработки отказов различных уровней, а значит — поддерживает целостность на уровне приложения. При создании плана восстановления для многоуровневого веб-приложения следует выполнить действия, приведенные ниже. Дополнительные сведения см. в статье [Создание планов восстановления](site-recovery-runbook-automation.md#customize-the-recovery-plan).

### <a name="adding-virtual-machines-to-failover-groups"></a>Добавление виртуальных машин в группы отработки отказа

1. Создайте план восстановления, добавив виртуальные машины веб-уровня и уровня приложений.
2. Щелкните "Настроить", чтобы сгруппировать виртуальные машины. По умолчанию все виртуальные машины входят в группу 1.

    ![Настройка плана восстановления](./media/site-recovery-sharepoint/rp-groups.png)

3. Создайте другую группу (группа 2) и переместите виртуальные машины веб-уровня в эту новую группу. Виртуальные машины уровня приложений должны входить в группу 1, а виртуальные машины веб-уровня — в группу 2. Это позволяет гарантировать, что виртуальные машины уровня приложений будут загружаться до виртуальных машин веб-уровня.


### <a name="adding-scripts-to-the-recovery-plan"></a>Добавление скриптов в план восстановления

Наиболее часто используемые сценарии Azure Site Recovery можно развернуть в учетной записи автоматизации, нажав кнопку "Развертывание в Azure" ниже. При использовании любого опубликованного сценария необходимо выполнять указанные в нем инструкции.

[![Развертывание в Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)

1. Добавьте сценарий предварительного действия в группу 1 для отработки отказа группы доступности SQL. Используйте сценарий ASR-SQL-FailoverAG, опубликованный в примерах сценариев. Обязательно выполните инструкции, предусмотренные сценарием, и внесите необходимые изменения в сценарий соответствующим образом.

    ![Add-AG-Script-Step-1](./media/site-recovery-sharepoint/add-ag-script-step1.png)

    ![Add-AG-Script-Step-2](./media/site-recovery-sharepoint/add-ag-script-step2.png)

2. Добавьте сценарий завершающего действия для подключения подсистемы балансировки нагрузки на виртуальных машинах веб-уровня (группа 2), для которых выполнена отработка отказа. Используйте сценарий ASR-AddSingleLoadBalancer, опубликованный в примерах сценариев. Обязательно выполните инструкции, предусмотренные сценарием, и внесите необходимые изменения в сценарий соответствующим образом.

    ![Add-LB-Script-Step-1](./media/site-recovery-sharepoint/add-lb-script-step1.png)

    ![Add-LB-Script-Step-2](./media/site-recovery-sharepoint/add-lb-script-step2.png)

3. Добавьте действие вручную для изменения записей DNS для указания на новую ферму в Azure.

    * Для сайтов, работающих с Интернетом, изменение записей DNS после отработки отказа не требуется. Выполните действия, описанные в разделе "Руководство по настройке сети", чтобы настроить диспетчер трафика. Если профиль диспетчера трафика настроен, как описано в предыдущем разделе, добавьте сценарий для открытия фиктивного порта (например, 800) на виртуальной машине Azure.

    * Для внутренних сайтов добавьте действие вручную для изменения записи DNS для указания на IP-адресе подсистемы балансировки нагрузки новой виртуальной машины веб-уровня.

4. Добавьте действие вручную для восстановления приложения поиска из резервной копии или запуска новой службы поиска.

5. Для восстановления приложения-службы поиска из резервной копии выполните следующие действия.

    * Этот способ предполагает, что резервная копия приложения-службы поиска была создана до аварийного события и доступна на сайте аварийного восстановления.
    * Проще всего будет запланировать резервное копирование (например, раз в день) и использовать процедуру копирования для переноса резервной копии на сайт аварийного восстановления. Процедуры копирования могут включать программы на основе сценариев, такие как AzCopy (копирование Azure) или настройку DFSR (репликации распределенных файловых служб).
    * Когда ферма SharePoint будет запущена, перейдите в раздел "Архивация и восстановление" центра администрирования и выберите "Восстановить". Функция восстановления опрашивает указанное расположение архивации (может потребоваться обновить значение). Выберите резервную копию приложения-службы поиска, которую требуется восстановить.
    * Служба поиска будет восстановлена. Учтите, что служба восстановления ожидает ту же топологию (то же число серверов) и буквы жестких дисков, назначенные этим серверам. Дополнительные сведения см. в документе [Восстановление приложений-служб поиска в SharePoint 2013](https://technet.microsoft.com/library/ee748654.aspx).


6. Чтобы начать работу с новым приложением-службой поиска, выполните следующие действия.

    * Этот способ предполагает, что резервная копия базы данных "Администрирование поиска" доступна на сайте аварийного восстановления.
    * Поскольку другие базы данных приложения-службы поиска не реплицируются, их потребуется создать повторно. Для этого перейдите в центр администрирования и удалите приложение-службу поиска. На любых серверах, на которых размещается индекс поиска, удалите файлы индекса.
    * Повторно создайте приложение-службу поиска, при этом базы данных будут воссозданы автоматически. Рекомендуется заранее подготовить сценарий, который повторно создает это приложение-службу, поскольку вы не сможете выполнить все действия через графический интерфейс. Например, задание расположения диска индекса и настройку топологии поиска можно выполнить только с помощью командлетов PowerShell для SharePoint. Используйте командлет Windows PowerShell Restore-SPEnterpriseSearchServiceApplication и укажите базу данных администрирования поиска, для которой выполнена доставка журналов и репликация, Search_Service__DB. Этот командлет предоставляет конфигурацию поиска, схему, управляемые свойства, правила и источники и создает набор других компонентов по умолчанию.
    * Как только потребуется повторно создать приложение-службу поиска, вы должны будете запустить полный обход всех источников содержимого для восстановления этой службы. Будут потеряны некоторые данные аналитики из локальной фермы, например рекомендации по поиску.

7. После завершения всех этих действий сохраните план восстановления. Окончательный план восстановления будет похож на приведенный ниже.

    ![Сохраненный план восстановления](./media/site-recovery-sharepoint/saved-rp.png)

## <a name="doing-a-test-failover"></a>Тестовая отработка отказа
Чтобы выполнить тестовую отработку отказа, используйте [это руководство](site-recovery-test-failover-to-azure.md).

1.  Перейдите на портал Azure и выберите хранилище служб восстановления.
2.  Щелкните план восстановления, созданный для приложения SharePoint.
3.  Щелкните "Тестовая отработка отказа".
4.  Выберите точку восстановления и виртуальную сеть Azure, чтобы запустить тестовую отработку отказа.
5.  Как только будет запущена вторичная среда, вы сможете выполнить проверку.
6.  После завершения проверки можно нажать кнопку "Очистить тестовую отработку отказа" в плане восстановления. Тестовая среда отработки отказа будет очищена.

Инструкции по выполнению тестовой отработки отказа для AD и DNS см. в документе [Рекомендации по тестированию отработки отказа для AD и DNS](site-recovery-active-directory.md#test-failover-considerations).

Инструкции по выполнении тестовой отработки отказа для групп доступности SQL AlwaysOn см. в [соответствующем документе](site-recovery-sql.md#steps-to-do-a-test-failover).

## <a name="doing-a-failover"></a>Отработка отказа
При выполнении отработки отказа используйте [это руководство](site-recovery-failover.md).

1.  Перейдите на портал Azure и выберите хранилище служб восстановления.
2.  Щелкните план восстановления, созданный для приложения SharePoint.
3.  Щелкните "Отработка отказа".
4.  Выберите точку восстановления, чтобы запустить отработку отказа.

## <a name="next-steps"></a>Дополнительная информация
Вы можете больше узнать о [репликации других приложений](site-recovery-workload.md) с помощью Site Recovery.
