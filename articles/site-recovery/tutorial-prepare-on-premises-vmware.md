---
title: Подготовка локальных серверов VMware для аварийного восстановления виртуальных машин VMware в Azure | Документация Майкрософт
description: Узнайте, как подготовить локальные сервера VMware для аварийного восстановления виртуальных машин VMware в Azure с помощью службы Azure Site Recovery.
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 02/07/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 4fecd5f8ddb4a6f432995a7779e29479b5b1a7c0
ms.sourcegitcommit: 088a8788d69a63a8e1333ad272d4a299cb19316e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2018
ms.locfileid: "29677521"
---
# <a name="prepare-on-premises-vmware-servers-for-disaster-recovery-to-azure"></a>Подготовка локальных серверов VMware для аварийного восстановления в Azure

В этом руководстве показано, как подготовить локальную инфраструктуру VMware к репликации виртуальных машин VMware в Azure. Из этого руководства вы узнаете, как:

> [!div class="checklist"]
> * Подготовить учетную запись сервера vCenter или узла vSphere ESXi, чтобы автоматизировать виртуальную машину.
> * Подготовить учетную запись для автоматической установки службы Mobility Service на виртуальные машины VMware.
> * Проверить требования сервера VMware.
> * Проверить требования виртуальных машин VMware.

В этой серии руководств показано, как создать резервную копию одной виртуальной машины с помощью Azure Site Recovery. При необходимости защищать несколько виртуальных машин VMware необходимо скачать [инструмент планирования развертывания](https://aka.ms/asr-deployment-planner) для репликации VMware. Этот инструмент собирает сведения о совместимости виртуальной машины, дисках на каждой виртуальной машине и обработке данных на дисках. Инструмент также проверяет соответствие требованиям к пропускной способности сети и инфраструктуре Azure для успешной репликации и тестовой отработки отказа. [Узнайте больше](site-recovery-deployment-planner.md) об использовании этого инструмента.

Это второе руководство в серии. Убедитесь, что [компоненты Azure настроены](tutorial-prepare-azure.md), как описано в предыдущем руководстве.

## <a name="prepare-an-account-for-automatic-discovery"></a>Подготовка учетной записи для автоматического обнаружения

Site Recovery требуется доступ к серверам VMware, чтобы:

- Автоматически обнаруживать виртуальные машины. Требуется по крайней мере учетная запись только для чтения.
- Управлять репликацией, отработкой отказа и восстановлением размещения. Необходима учетная запись, которая позволяет выполнять операции, такие как создание и удаление дисков и включение виртуальных машин.

Создайте учетную запись следующим образом:

1. Чтобы использовать выделенную учетную запись, создайте роль на уровне vCenter. Присвойте роли имя, например **Azure_Site_Recovery**.
2. Назначьте роли разрешения, представленные в следующей таблице.
3. Создайте пользователя на сервере vCenter или узле vSphere. Назначьте роль для пользователя.

### <a name="vmware-account-permissions"></a>Разрешения учетной записи VMware

**Задача.** | **Роль/Разрешения** | **Дополнительные сведения**
--- | --- | ---
**Обнаружение виртуальных машин** | Пользователь только для чтения (минимум).<br/><br/> Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).
**Полная репликация, отработка отказа, восстановление размещения** |  Создайте роль VMware (Azure_Site_Recovery) с необходимыми разрешениями и назначьте эту роль пользователю или группе VMware.<br/><br/> Объект центра обработки данных –> распространение на дочерний объект, роль Azure_Site_Recovery<br/><br/> Хранилище данных -> выделение места, обзор хранилища данных, низкоуровневые операции с файлами, удаление файлов, обновление файлов виртуальной машины<br/><br/> Сеть -> Назначение сети<br/><br/> Ресурс -> назначение виртуальной машины в пул ресурсов, миграция отключенной виртуальной машины, миграция включенной виртуальной машины<br/><br/> Задачи -> Создание задач, Обновление задач<br/><br/> Виртуальная машина -> конфигурация<br/><br/> Виртуальная машина -> взаимодействие -> ответ на вопрос, подключение устройства, настройка компакт-диска носителя, настройка дискеты носителя, отключение, включение, установка средств VMware<br/><br/> Виртуальная машина -> инвентаризация -> создание, регистрация, отмена регистрации<br/><br/> Виртуальная машина -> подготовка -> разрешение загрузки виртуальной машины, разрешение отправки файлов виртуальной машины<br/><br/> виртуальная машина -> моментальные снимки -> удаление моментальных снимков. | Пользователь назначается на уровне центра обработки данных и поэтому имеет доступ ко всем объектам в центре обработки данных.<br/><br/> Если нужно ограничить доступ, назначьте дочерним объектам (узлы vSphere, хранилища данных, виртуальные машины и сети) роль **Без доступа** с параметром **Propagate to child** (Распространить на дочерний объект).

## <a name="prepare-an-account-for-mobility-service-installation"></a>Подготовка учетной записи к установке службы Mobility Service

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую нужно реплицировать. Site Recovery устанавливает эту службу автоматически при включении репликации для виртуальной машины. Для автоматической установки необходимо подготовить учетную запись, которую Site Recovery будет использовать для доступа к виртуальной машине. Укажите эту учетную запись при настройке аварийного восстановления в консоли Azure.

1. Подготовьте домен или локальную учетную запись с этими разрешениями для установки на виртуальной машине.
2. Если при установке на виртуальные машины Windows не используется учетная запись домена, отключите контроль удаленного доступа пользователей на локальном компьютере.
   - В разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.
3. Для установки на виртуальные машины Linux необходимо подготовить корневую учетную запись на исходном сервере Linux.


## <a name="check-vmware-server-requirements"></a>Проверка требований сервера VMware

Убедитесь, что серверы VMware соответствуют следующим требованиям.

**Компонент** | **Требование**
--- | ---
**Сервер vCenter** | vCenter 6.5, 6.0 или 5.5
**Узел vSphere** | vSphere 6.5, 6.0 или 5.5

## <a name="check-vmware-vm-requirements"></a>Проверка требований виртуальных машин VMware

Убедитесь, что виртуальная машина соответствует требованиям Azure, приведенным в следующей таблице.

**Требования виртуальной машины** | **Дополнительные сведения**
--- | ---
**Размер диска операционной системы** | До 2048 ГБ.
**Число дисков операционной системы** | 1
**Число дисков с данными** | 64 ГБ и меньше
**Размер виртуального жесткого диска с данными** | До 4095 ГБ.
**Сетевые адаптеры** | Поддерживаются несколько адаптеров
**Общий виртуальный жесткий диск** | Не поддерживается
**Диск FC** | Не поддерживается
**Формат жесткого диска** | VHD или VHDX.<br/><br/> Хотя Azure пока что не поддерживает формат VHDX, служба Site Recovery автоматически преобразует VHDX в VHD при отработке отказа с перемещением в Azure. При восстановлении к локальной системе виртуальные машины продолжают использовать формат VHDX.
**BitLocker** | Не поддерживается. Отключите перед включением репликации для виртуальных машин.
**Имя виртуальной машины** | От 1 до 63 символов,<br/><br/> при этом допустимы только буквы, цифры и дефисы Имя виртуальной машины должно начинаться и заканчиваться буквой или цифрой.
**Тип виртуальной машины** | Поколение 1 — Linux или Windows<br/><br/>Поколение 2 — только для Windows

Виртуальная машина также должна работать под управлением поддерживаемой операционной системы. Подробный список поддерживаемых версий см. в разделе [Поддержка версий ОС для реплицируемых виртуальных машин](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions).

## <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

При выполнении сценария отработки отказа может потребоваться подключение к реплицируемым виртуальным машинам в Azure из локальной сети.

Чтобы подключиться к виртуальным машинам Windows с помощью RDP после отработки отказа, сделайте следующее:

1. Чтобы получить доступ к Интернету, включите RDP на локальных виртуальных машинах перед отработкой отказа. Убедитесь в том, что правила TCP и UDP добавлены для **общедоступного** профиля, а RDP разрешен в разделе **Брандмауэр Windows** > **Allowed Apps** (Разрешенные приложения) для всех профилей.
2. Для доступа через VPN типа "сеть — сеть" включите RDP на локальном компьютере. Протокол удаленного рабочего стола должен быть разрешен в разделе **Брандмауэр Windows** -> **Allowed apps and features** (Разрешенные приложения и компоненты) для сетей **домена и частных сетей**.
   Убедитесь, что для политики сети SAN операционной системы задано значение **OnlineAll**. [Узнайте больше](https://support.microsoft.com/kb/3031135). Убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows, прежде чем активировать отработку отказа. Если они есть, вы не сможете войти в виртуальную машину до завершения обновления.
3. После отработки отказа на виртуальной машине Windows Azure проверьте **диагностику загрузки**, чтобы просмотреть снимок экрана виртуальной машины. Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).

Чтобы подключиться к виртуальной машине Linux с помощью SSH после отработки отказа, сделайте следующее:

1. На локальном компьютере перед отработкой отказа убедитесь, что для службы Secure Shell настроен автоматический запуск при загрузке системы. Убедитесь, что правила брандмауэра разрешают SSH-подключение.

2. Правила группы безопасности сети на виртуальной машине Azure, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.
   [Добавьте общедоступный IP-адрес](site-recovery-monitoring-and-troubleshooting.md) для виртуальной машины. Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Настройка аварийного восстановления в Azure для локальных виртуальных машин VMware](tutorial-vmware-to-azure.md)
