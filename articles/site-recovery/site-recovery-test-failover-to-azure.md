---
title: Тестовая отработка отказа в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: Сведения о запуске тестовой отработки отказа с переносом из локальной среды в Azure с помощью Azure Site Recovery
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: article
ms.date: 02/08/2018
ms.author: raynew
ms.openlocfilehash: bdbeee0e0caaa0e6db7249c2f4aeaa19d5d2ed0d
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34643657"
---
# <a name="test-failover-to-azure-in-site-recovery"></a>Тестовая отработка отказа в Azure с помощью Site Recovery


В этой статье описывается выполнение отработки аварийного восстановления в Azure с помощью тестовой отработки отказа Site Recovery.  

Тестовая отработка отказа выполняется для проверки стратегии репликации и аварийного восстановления без потери данных или простоя. Тестовая отработка отказа не влияет на текущую репликацию или рабочую среду. Тестовую отработку отказа можно выполнить на определенной виртуальной машине или в [плане восстановления](site-recovery-create-recovery-plans.md), содержащем несколько виртуальных машин. 


## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа
В этой процедуре описывается, как запустить тестовую отработку отказа для плана восстановления. 

![Тестирование отработки отказа](./media/site-recovery-test-failover-to-azure/TestFailover.png)


1. В службе Site Recovery на портале Azure щелкните **Планы восстановления** > *имя плана восстановления* > **Тестовая отработка отказа**.
2. Выберите **точку восстановления**, в которую будет выполнена отработка отказа. Можно выбрать один из следующих вариантов:
    - **Последняя обработанная**. Отработка отказа выполняется для всех виртуальных машин в плане в последнюю точку восстановления, которая была обработана Site Recovery. Для просмотра последней точки восстановления конкретной виртуальной машины ознакомьтесь с разделом **Последние точки восстановления** в параметрах виртуальной машины. Этот вариант обеспечивает низкий показатель целевого времени восстановления, так как не требует времени на обработку данных.
    - **Последняя точка во времени согласованности приложений**. Отработка отказа всех виртуальных машин в плане выполняется до последней точки восстановления с согласованным состоянием приложений, которая была обработана Site Recovery. Для просмотра последней точки восстановления конкретной виртуальной машины ознакомьтесь с разделом **Последние точки восстановления** в параметрах виртуальной машины. 
    - **Последняя**. При этом варианте сначала обрабатываются все данные, отправленные в службу Site Recovery, чтобы создать точку восстановления для каждой виртуальной машины, прежде чем выполнять в нее отработку отказа. Этот вариант обеспечивает самое низкое значение RPO (целевая точка восстановления), так как виртуальная машина, созданная после отработки отказа, будет иметь все данные, реплицированные в службу Site Recovery до момента активации отработки отказа.
    - **Последние обработанные для нескольких виртуальных машин**. Этот параметр доступен для планов восстановления, которые содержат одну или больше виртуальных машин с согласованностью нескольких виртуальных машин. Виртуальные машины с этим параметром выполняют отработку отказа до последней согласованной точки восстановления, общей для нескольких виртуальных машин. Другие виртуальные машины выполняют отработку отказа до последней обработанной точки восстановления.  
    - **Последняя для нескольких виртуальных машин с согласованием приложений**. Этот параметр доступен для планов восстановления, которые содержат одну или несколько виртуальных машин с согласованностью нескольких виртуальных машин. Виртуальные машины, которые являются частью группы репликации, выполняют отработку отказа до последней согласованной с приложением точки восстановления, общей для нескольких виртуальных машин. Остальные виртуальные машины выполняют отработку отказа до последней точки восстановления, согласованной с приложением. 
    - **Настраиваемая**. Выполняет отработку отказа определенной виртуальной машины до определенной точки восстановления.
3. Выберите виртуальную сеть Azure, в которой будут созданы тестовые виртуальные машины.

    - Служба Site Recovery попытается создать тестовые виртуальные машины в подсети с таким же именем, используя тот же IP-адрес, который был указан в разделе параметров **Вычисления и сеть** виртуальной машины.
    - Если подсеть с таким же именем недоступна в виртуальной сети Azure, используемой для тестовой отработки отказа, тестовая виртуальная машина создается в первой по алфавиту подсети.
    - Если тот же IP-адрес недоступен в подсети, виртуальная машина получает другой доступный IP-адрес в подсети. [Узнайте больше](#create-a-network-for-test-failover).
4. Если при отработке отказа с выполнением переноса в Azure включена функция шифрования данных, то в разделе **Ключ шифрования** выберите сертификат, который был выпущен, когда во время установки поставщика вы включили функцию шифрования. Этот шаг можно пропустить, если шифрование не включено.
5. Ход выполнения отработки отказа можно отслеживать на вкладке **Задания** . Кроме того, вы можете просмотреть тестовую реплицированную машину на портале Azure.
6. Чтобы инициировать подключение по протоколу RDP к виртуальной машине Azure, необходимо [добавить общедоступный IP-адрес](https://aka.ms/addpublicip) в сетевом интерфейсе виртуальной машины, для которой выполнена отработка отказа. 
7. Если все работает правильно, щелкните **Очистить тестовую отработку отказа**. Это приведет к удалению виртуальных машин, созданных при тестовой отработке отказа.
8. В разделе **Примечания** можно записать и сохранить любые замечания, связанные с тестовой отработкой отказа. 


![Тестирование отработки отказа](./media/site-recovery-test-failover-to-azure/TestFailoverJob.png)

При запуске тестовой отработки отказа происходит следующее:

1. **Предварительные требования**. Выполняется проверка на соблюдение всех необходимых условий для отработки отказа.
2. **Отработка отказа**. Операция отработки отказа обрабатывает и подготавливает данные для создания на их основе виртуальной машины Azure.
3. **Последняя**. При выборе последней точки восстановления создается точка восстановления на основе данных, отправленных в службу.
4. **Запуск**. Теперь создается виртуальная машина Azure с использованием данных, обработанных на предыдущем этапе.

### <a name="failover-timing"></a>Время отработки отказа

В следующих сценариях для отработки отказа требуется дополнительный промежуточный шаг, который обычно длится 8–10 минут:

* виртуальные машины VMware, использующие службу Mobility Service версии ниже 9.8;
* физические серверы;
* виртуальные машины Linux VMware;
* виртуальные машины Hyper-V, защищенные как физические серверы;
* виртуальные машины VMware, в которых следующие драйверы не являются драйверами загрузки:
    * storvsc;
    * vmbus;
    * storflt;
    * intelide;
    * atapi;
* виртуальные машины VMware, на которых не включена DHCP, вне зависимости от того, используется протокол DHCP или статические IP-адреса.

Во всех остальных случаях промежуточный шаг не обязателен, а отработка отказа занимает значительно меньше времени.


## <a name="create-a-network-for-test-failover"></a>Создание сети для тестовой отработки отказа

Для тестовой отработки отказа рекомендуется выбрать сеть, изолированную от рабочей сети сайта восстановления, указанной в разделе параметров **Вычисления и сеть** для каждой виртуальной машины. При создании виртуальной сети Azure она по умолчанию изолируется от других сетей. Тестовая сеть должна имитировать рабочую сеть:

- В тестовой сети должно быть такое же количество подсетей, что и в рабочей сети. Подсети должны иметь одинаковые имена.
- Тестовая сеть должна использовать тот же диапазон IP-адресов.
- Обновите DNS тестовой сети, используя IP-адрес, указанный для виртуальной машины DNS в параметрах **Вычисления и сети**. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа](site-recovery-active-directory.md#test-failover-considerations).


## <a name="test-failover-to-a-production-network-in-the-recovery-site"></a>Тестовая отработка отказа в рабочую сеть на сайте восстановления

Несмотря на то что тестовую сеть рекомендуется использовать отдельно от рабочей сети, при необходимости протестировать аварийное восстановление в рабочей сети обратите внимание на следующее: 

- При выполнении тестовой отработки отказа убедитесь, что работа основной виртуальной машины была завершена. В противном случае в одной сети будут одновременно работать две виртуальные машины с одинаковыми идентификаторами. Это может привести к непредвиденным последствиям.
- Любые изменения в виртуальных машинах, созданных для тестовой отработки отказа, будут потеряны при очистке отработки отказа. Они не реплицируются на основную виртуальную машину.
- Тестирование в рабочей среде приводит к простою рабочего приложения. Пользователи не должны использовать приложения, работающие на виртуальных машинах, во время тестовой отработки отказа.  



## <a name="prepare-active-directory-and-dns"></a>Подготовка Active Directory и DNS

Чтобы выполнить тестовую отработку отказа для тестирования приложения, потребуется копия рабочей среды Active Directory в тестовой среде. Дополнительные сведения см. в разделе [Рекомендации по тестированию отработки отказа](site-recovery-active-directory.md#test-failover-considerations).

## <a name="prepare-to-connect-to-azure-vms-after-failover"></a>Подготовка к подключению виртуальных машин Azure после отработки отказа

Если после отработки отказа нужно подключиться к виртуальным машинам Azure по протоколу удаленного рабочего стола, выполните требования, которые перечислены в таблице.

**Тип отработки отказа** | **Местоположение.** | **Действия**
--- | --- | ---
**Виртуальная машина Azure под управлением Windows** | Локальный компьютер до отработки отказа | Чтобы получить доступ к виртуальной машине Azure через Интернет, включите протокол RDP и проверьте, добавлены ли правила TCP и UDP в разделе **Общее** и разрешен ли протокол RDP в разделе **Брандмауэр Windows** > **Разрешенные программы** для всех профилей.<br/><br/> Чтобы получить доступ к виртуальной машине Azure через подключение типа "сеть — сеть", включите протокол RDP на компьютере. Проверьте, разрешен ли протокол RDP в разделе **Брандмауэр Windows** -> **Разрешенные программы и компоненты** для **сетей домена и частных сетей**.<br/><br/>  Задайте для политики сети SAN операционной системы значение **OnlineAll**. [Узнайте больше](https://support.microsoft.com/kb/3031135).<br/><br/> Прежде чем активировать отработку отказа, убедитесь, что на виртуальной машине нет ожидающих установки обновлений Windows. Когда вы начнете отработку отказа, может начаться обновление Windows. В этом случае вы не сможете войти на виртуальную машину до завершения обновления. 
**Виртуальная машина Azure под управлением Windows** | Виртуальная машина Azure после отработки отказа |  [Добавьте общедоступный IP-адрес](https://aka.ms/addpublicip) для виртуальной машины.<br/><br/> Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту RDP.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/> Если вы не можете подключиться к виртуальной машине, убедитесь, что она запущена, и ознакомьтесь с [рекомендациями по устранению неполадок](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx).
**Виртуальная машина Azure под управлением Linux** | Локальный компьютер до отработки отказа | Настройте автоматический запуск службы SSH на виртуальной машине при загрузке системы (если он еще не настроен).<br/><br/> Убедитесь, что правила брандмауэра разрешают SSH-подключение к виртуальной машине.
**Виртуальная машина Azure под управлением Linux** | Виртуальная машина Azure после отработки отказа | Правила группы безопасности сети на виртуальной машине, для которой выполнена отработка отказа, и подсети Azure, к которой она подключена, должны разрешать входящие подключения к порту SSH.<br/><br/> [Добавьте общедоступный IP-адрес](https://aka.ms/addpublicip) для виртуальной машины.<br/><br/> Чтобы просмотреть снимок виртуальной машины, можно проверить **диагностику загрузки**.<br/><br/>



## <a name="next-steps"></a>Дополнительная информация
После завершения руководства по аварийному восстановлению ознакомьтесь с другими типами [отработки отказа](site-recovery-failover.md).
