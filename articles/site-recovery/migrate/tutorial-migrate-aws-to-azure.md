---
title: Миграция виртуальных машин из AWS в Azure с помощью Azure Site Recovery | Документация Майкрософт
description: В этой статье описано, как перенести виртуальные машины, запущенные в Amazon Web Services (AWS), в Azure с помощью Azure Site Recovery.
services: site-recovery
documentationcenter: ''
author: rayne-wiselman
manager: carmonm
editor: ''
ms.assetid: ddb412fd-32a8-4afa-9e39-738b11b91118
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 11/27/2017
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 9b1aabcd88ce93ff9316d3ee99619eccaeb6a38e
ms.sourcegitcommit: 088a8788d69a63a8e1333ad272d4a299cb19316e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/27/2018
ms.locfileid: "29677736"
---
# <a name="migrate-amazon-web-services-aws-vms-to-azure"></a>Перенос виртуальных машин Amazon Web Services (AWS) в Azure

Из этого руководства вы узнаете, как перенести виртуальные машины Amazon Web Services (AWS) в виртуальные машины Azure с помощью Site Recovery. При миграции экземпляров EC2 в Azure компьютеры VMware считаются физическими локальными компьютерами. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Подготовка ресурсов Azure
> * Подготовка экземпляров EC2 AWS к миграции.
> * Развертывание сервера конфигурации.
> * Включение репликации для виртуальных машин.
> * Выполнение тестовой отработки отказа, чтобы убедиться в надлежащей работе всех компонентов.
> * Выполнение однократной отработки отказа в Azure.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/pricing/free-trial/), прежде чем начинать работу.


## <a name="prepare-azure-resources"></a>Подготовка ресурсов Azure 

Для перенесенных экземпляров EC2 понадобится подготовить несколько ресурсов в Azure, такие как учетная запись хранения, хранилище и виртуальная сеть.

### <a name="create-a-storage-account"></a>Создайте учетную запись хранения.

Образы реплицированных компьютеров хранятся в службе хранилища Azure. Виртуальные машины Azure создаются из хранилища при отработке отказа с переходом из локальной среды в Azure.

1. В меню на [портале Azure](https://portal.azure.com) щелкните **Создать ресурс** -> **Хранилище** -> **Учетная запись хранения**.
2. Выберите имя для своей учетной записи хранения. В этом руководстве мы используем имя **awsmigrated2017**. Имя должно быть уникальным в пределах Azure и содержать от 3 до 24 знаков (только цифры и строчные буквы).
3. Оставьте значения по умолчанию для параметров **Модель развертывания**, **Тип учетной записи**, **Производительности** и **Требуется безопасное перемещение**.
5. В разделе **Репликация** выберите значение по умолчанию для параметра **RA-GRS**.
6. Выберите подписку, которую нужно использовать для этого руководства.
7. Для параметра **Группа ресурсов** выберите **Создать**. В этом примере в качестве имени мы используем **migrationRG**.
8. Выберите значение **Западная Европа** в качестве расположения. 
9. Щелкните **Создать** , чтобы создать учетную запись хранения.

### <a name="create-a-vault"></a>Создание хранилища

1. В левой области навигации на [портале Azure](https://portal.azure.com) щелкните **Больше служб**, а затем найдите и выберите **хранилища служб восстановления**.
2. На странице "Хранилища служб восстановления" щелкните **+ Add** (+ Добавить) в левом верхнем углу страницы.
3. В поле **Имя** введите *myVault*. 
4. В поле **Подписка** выберите нужную подписку.
4. В разделе **Группа ресурсов** установите флажок **Использовать существующую** и выберите *migrationRG*. 
5. В разделе **Расположение** выберите *Западная Европа*. 
5. Для быстрого доступа к новому хранилищу с панели мониторинга выберите **Закрепить на панели мониторинга**.
7. Закончив, щелкните **Создать**.

Новое хранилище появится в колонке **Панель мониторинга** > **Все ресурсы** и на основной странице **Хранилища служб восстановления**.

### <a name="set-up-an-azure-network"></a>Настроить сеть

При создании после миграции (отработки отказа) виртуальные машины Azure присоединяются к этой сети.

1. На [портале Azure](https://portal.azure.com) последовательно выберите **Создать ресурс** > **Сети** >
    **Виртуальная сеть**
3. В поле **Имя** введите *myMigrationNetwork*.
4. Оставьте значение по умолчанию для параметра **Адресное пространство**.
5. В поле **Подписка** выберите нужную подписку.
6. В разделе **Группа ресурсов** выберите **Использовать существующую** и в раскрывающемся списке щелкните *migrationRG*.
7. В разделе **Расположение** выберите **Западная Европа**. 
8. Оставьте значения по умолчанию в разделе **Подсеть** для параметров **Имя** и **Диапазон IP-адресов**.
9. Не включайте **конечные точки службы**.
10. Закончив, щелкните **Создать**.


## <a name="prepare-the-ec2-instances"></a>Подготовка экземпляров EC2

Вам потребуется одна или несколько виртуальных машин, которые требуется перенести. Эти экземпляры EC2 должны работать под управлением 64-разрядной версии Windows Server 2008 R2 SP1 или более поздней версии, Windows Server 2012, Windows Server 2012 R2 или Red Hat Enterprise Linux 6.7 (только виртуализированные экземпляры HVM). На сервере должны быть установлены только драйверы Citrix PV или AWS PV. Экземпляры, работающие с драйверами RedHat PV, не поддерживаются.

Служба Mobility Service должна быть установлена на каждой виртуальной машине, которую нужно реплицировать. Site Recovery устанавливает эту службу автоматически при включении репликации для виртуальной машины. Для автоматической установки необходимо подготовить учетную запись на экземплярах EC2, которые Site Recovery будет использовать для доступа к виртуальной машине.

Вы можете использовать доменную или локальную учетную запись. Для виртуальных машин Linux учетная запись должна принадлежать привилегированному пользователю на исходном сервере Linux. Для виртуальных машин Windows, если учетная запись домена не используется, отключите контроль удаленного доступа пользователей на локальном компьютере:

  - В разделе реестра **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** добавьте запись DWORD **LocalAccountTokenFilterPolicy** и задайте для нее значение 1.
    
Вам также потребуется отдельный экземпляр EC2, который можно использовать в качестве сервера конфигурации Site Recovery. Он должен работать под управлением Windows Server 2012 R2. 
    

## <a name="prepare-the-infrastructure"></a>Подготовка инфраструктуры 

На странице портала хранилища в разделе **Приступая к работе** выберите **Site Recovery**, а затем щелкните **Подготовка инфраструктуры**.

### <a name="1-protection-goal"></a>1. Цель защиты

Укажите следующие значения на странице **Цель защиты**:
   
|    |  | 
|---------|-----------|
| Где находятся компьютеры? | **Локальная система**|
| Куда следует реплицировать компьютеры? |**В Azure**|
| Виртуализированы ли ваши компьютеры? | **Not virtualized/Other** (Не виртуализированы/Другое)|

После этого нажмите кнопку **ОК**, чтобы перейти к следующему разделу.

### <a name="2-source-prepare"></a>2. Подготовка источника 

На странице **Подготовка источника** щелкните **+ Configuration Server** (+ Сервер конфигурации). 

1. Используйте экземпляр EC2 под управлением Windows Server 2012 R2 для создания сервера конфигурации и его регистрации в хранилище восстановления.

2. Настройте прокси-сервер на виртуальной машине экземпляра EC2, используемой в качестве сервера конфигурации, чтобы она смогла получать доступ к [URL-адресам службы](../site-recovery-support-matrix-to-azure.md).

3. Загрузите программу [единой установки Microsoft Azure Site Recovery](http://aka.ms/unifiedinstaller_wus). Ее можно загрузить на локальный компьютер и скопировать на виртуальную машину, используемую в качестве сервера конфигурации.

4. Нажмите кнопку **Загрузка**, чтобы загрузить ключ регистрации хранилища. Скопируйте загруженный файл на виртуальную машину, используемую как сервер конфигурации.

5. На виртуальной машине щелкните правой кнопкой мыши установщик, загруженный для программы **единой установки Microsoft Azure Site Recovery**, и выберите **Запуск от имени администратора**. 

    1. На странице **Перед началом работы** выберите **Install the configuration server and process server** (Установить сервер конфигурации и сервер обработки) и нажмите кнопку **Далее**.
    2. В разделе **Third-Party Software License** (Лицензия на программное обеспечение стороннего поставщика) выберите **I accept the third-party license agreement** (Я принимаю условия лицензионного соглашения стороннего поставщика). Затем нажмите кнопку **Далее**.
    3. В разделе **Регистрация** нажмите кнопку обзора, перейдите к расположению, в котором находится файл ключа регистрации хранилища, и нажмите кнопку **Далее**.
    4. В разделе **Internet Settings** (Параметры браузера) выберите **Connect to Azure Site Recovery without a proxy server** (Подключаться к Azure Site Recovery без прокси-сервера). Затем нажмите кнопку **Далее**.
    5. На странице **Проверка предварительных требований** выполняется проверка нескольких элементов. По завершении проверки нажмите кнопку **Далее**. 
    6. В разделе **MySQL Configuration** (Конфигурация MySQL) укажите необходимые пароли и нажмите кнопку **Далее**.
    7. В разделе **Сведения о среде** выберите **Нет** (если защита компьютеров VMware не требуется), а затем нажмите кнопку **Далее**.
    8. В разделе **Расположение установки** нажмите кнопку **Далее**, чтобы принять значения по умолчанию.
    9. В разделе **Network Selection** (Выбор сети) нажмите кнопку **Далее**, чтобы принять значения по умолчанию.
    10. В разделе **Сводка** щелкните **Установить**.
    11. На странице **Installation Progress** (Ход выполнения установки) можно получить сведения об этапе установки. По завершении установки нажмите кнопку **Готово**. После этого появится всплывающее сообщение о необходимости перезагрузки. Нажмите кнопку **ОК**. Кроме того, появится всплывающее сообщение о парольной фразе для подключения к серверу конфигурации. Скопируйте парольную фразу в буфер обмена и сохраните в безопасном месте.
    
6. На виртуальной машине запустите файл **cspsconfigtool.exe**, чтобы создать одну или несколько учетных записей управления на сервере конфигурации. Убедитесь, что учетным записям управления назначены разрешения администратора для экземпляров EC2, которые требуется перенести. 

Настроив сервер конфигурации, вернитесь на портал, выберите сервер, созданный для **сервера конфигурации**, и нажмите кнопку *ОК**, чтобы перейти к разделу "Шаг 3. Подготовка цели".

### <a name="3-target-prepare"></a>3. Подготовка цели 

В этом разделе вы введете сведения о ресурсах, созданных во время работы с разделом [Подготовка ресурсов Azure](#prepare-azure-resources) ранее в этом руководстве.

1. В разделе **Подписка** выберите подписку Azure, использованную при работе с руководством [Подготовка ресурсов Azure к репликации локального компьютера](../tutorial-prepare-azure.md).
2. Выберите **Resource Manager** в качестве модели развертывания.
3. Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure. Это должны быть ресурсы, созданные при работе с разделом [Подготовка ресурсов Azure](#prepare-azure-resources) ранее в этом руководстве.
4. Когда все будет готово, нажмите кнопку **ОК**.


### <a name="4-replication-settings-prepare"></a>4. Подготовка параметров репликации 

Прежде чем вы сможете включить репликацию, необходимо создать политику репликации.

1. Щелкните **+ Replicate and Associate** (+ Репликация и связь).
2. В поле **Имя** введите **myReplicationPolicy**.
3. Оставьте остальные параметры по умолчанию и нажмите кнопку **ОК** для создания политики. Созданная политика автоматически сопоставляется с сервером конфигурации. 

### <a name="5-deployment-planning-select"></a>5. Выбор плана развертывания 

В разделе **Have you completed deployment planning?** (Вы спланировали развертывание?) в раскрывающемся меню выберите **I will do it later** (Выполню позже) и нажмите кнопку **ОК**.

Выполнив требования во всех 5 разделах **подготовки инфраструктуры**, нажмите кнопку **ОК**.


## <a name="enable-replication"></a>Включение репликации

Включите репликацию для всех виртуальных машин, которые требуется перенести. Если репликация включена, Site Recovery автоматически установит службу Mobility Service. 

1. Откройте [портал Azure](htts://portal.azure.com).
1. На странице хранилища в разделе **Приступая к работе** щелкните **Site Recovery**.
2. В разделе **For on-premises machines and Azure VMs** (Для локальных компьютеров и виртуальных машин Azure) щелкните **Step 1:Replicate application** (Шаг 1. Репликация приложения). Укажите на страницах мастера следующие сведения и нажмите кнопку **ОК** на каждой странице после завершения:
    - 1 Настройка источника:
      
    |  |  |
    |-----|-----|
    | Источник: | **Локально**|
    | Исходное расположение:| Имя экземпляра EC2 сервера конфигурации.|
    |Тип компьютера: | **Физические компьютеры**|
    | Сервер обработки: | Выберите сервер конфигурации в раскрывающемся списке.|
    
    - 2 Настройка цели
        
    |  |  |
    |-----|-----|
    | Цель: | Оставьте значение по умолчанию.|
    | Подписка: | Выберите используемую подписку.|
    | Группа ресурсов, которая будет использоваться после отработки отказа:| Используйте группу ресурсов, созданную при работе с разделом [Подготовка ресурсов Azure](#prepare-azure-resources).|
    | Модель развертывания, которая будет использоваться после отработки отказа: | Выберите **Resource Manager**.|
    | Учетная запись хранения: | Выберите учетную запись хранения, созданную при работе с разделом [Подготовка ресурсов Azure](#prepare-azure-resources).|
    | Сеть Azure: | Выберите **Configure now for selected machines** (Настроить сейчас для выбранных компьютеров).|
    | Сеть Azure, которая будет использоваться после отработки отказа: | Выберите сеть, созданную при работе с разделом [Подготовка ресурсов Azure](#prepare-azure-resources).|
    | Подсеть: | Выберите **значение по умолчанию** из раскрывающегося списка.|
    
    - 3 Выбор физических компьютеров
        
        Щелкните **+ Physical machine** (+ Физический компьютер), а затем введите **имя**, **IP-адрес** и **тип ОС** для экземпляра EC2, который необходимо перенести, и нажмите кнопку **ОК**.
        
    - 4 Настройка свойств
        
        Из раскрывающегося списка выберите учетную запись, созданную на сервере конфигурации, и нажмите кнопку **ОК**.
        
    - 5 Настройка параметров репликации
    
        Убедитесь, что в раскрывающемся списке выбрана политика репликации **myReplicationPolicy**, и нажмите кнопку **ОК**.
        
3. По завершении работы с мастером щелкните **Включить репликацию**.
        

Ход выполнения задания **включения защиты** можно отслеживать, выбрав **Мониторинг и отчеты** > **Задания** > **Site Recovery Jobs** (Задания Site Recovery). После выполнения задания **Завершить подготовку защиты** виртуальная машина будет готова к отработке отказа.        
        
При включении репликации для виртуальной машины может пройти более 15 минут, прежде чем изменения вступят в силу и появятся на портале.

## <a name="run-a-test-failover"></a>Запуск тестовой отработки отказа

При запуске тестовой отработки отказа происходит следующее:

1. выполняется проверка на соблюдение всех необходимых условий для отработки отказа;
2. операция отработки отказа обрабатывает данные для создания виртуальной машины Azure; если выбрана последняя точка восстановления, на основе данных создается точка восстановления;
3. создается виртуальная машина Azure с использованием данных, обработанных на предыдущем шаге.

На портале запустите тестовую отработку отказа следующим образом:

1. На странице хранилища выберите **Защищенные элементы** > **Реплицированные элементы**, щелкните "Виртуальная машина > **+ Test Failover**" (+ Тестовая отработка отказа).

2. Выберите точку восстановления для отработки отказа:
    - **Последняя обработанная.** Отработка отказа выполняется до последней точки восстановления виртуальной машины, которая была обработана Site Recovery. Для нее отображается метка времени. Этот вариант не требует времени на обработку данных, обеспечивая низкий показатель целевого времени восстановления.
    - **Последняя точка во времени согласованности приложений**. Отработка отказа всех виртуальных машин выполняется до последней точки восстановления с согласованным состоянием приложений. Для нее отображается метка времени.
    - **Пользовательская**. Вы можете выбрать любую точку восстановления.
3. На странице **Тестовая отработка отказа** выберите целевую сеть Azure, к которой будут подключаться виртуальные машины Azure после отработки отказа. Это должна быть сеть, созданная при работе с разделом [Подготовка ресурсов Azure](#prepare-azure-resources).
4. Нажмите кнопку **ОК** , чтобы запустить отработку отказа. За ходом выполнения можно следить в окне свойств, которое можно открыть, щелкнув виртуальную машину. Кроме того, можно щелкнуть задание **Тестовая отработка отказа** на странице хранилища в разделе **Мониторинг и отчеты** > **Задания** >
   **Site Recovery Jobs** (Задания Site Recovery).
5. Когда отработка отказа завершится, на вкладке **Виртуальные машины** портала Azure появится реплика виртуальной машины. Убедитесь, что виртуальная машина имеет соответствующий размер, подключена к соответствующей сети и работает.
6. Теперь вы можете подключиться к реплицированной виртуальной машине в Azure.
7. Чтобы удалить виртуальные машины Azure, созданные во время тестовой отработки отказа, щелкните **Очистить тестовую отработку отказа** в плане восстановления. В разделе **Примечания** можно записать и сохранить любые замечания, связанные с тестовой отработкой отказа.

В некоторых сценариях требуется дополнительная обработка отработки отказа, которая длится около 8–10 минут. 


## <a name="migrate-to-azure"></a>Миграция в Azure

Запустите фактическую отработку отказа для экземпляров EC2, чтобы перенести их в виртуальные машины Azure. 

1. В разделе **Защищенные элементы** > **Реплицированные элементы** щелкните экземпляры AWS и выберите **Отработка отказа**.
2. В разделе **Отработка отказа** выберите **точку восстановления**, в которую будет выполнена отработка отказа. Выберите последнюю точку восстановления.
3. Выберите **Завершение работы виртуальной машины перед началом отработки отказа**, чтобы служба Site Recovery попыталась выключить исходные виртуальные машины, прежде чем запускать отработку отказа. Отработка отказа продолжится, даже если их не удастся отключить. На странице **Задания** можно следить за ходом выполнения отработки отказа.
4. Убедитесь, что виртуальная машина отображается в разделе **Реплицированные элементы**. 
5. Щелкните каждую виртуальную машину правой кнопкой мыши и выберите **Завершение миграции**. Таким образом вы завершите миграцию, прекратите репликацию для виртуальной машины AWS и остановите выставление счетов Site Recovery для виртуальной машины.

    ![Завершение миграции](./media/tutorial-migrate-aws-to-azure/complete-migration.png)

> [!WARNING]
> **Не отменяйте выполняющуюся отработку отказа**. Перед запуском отработки отказа останавливается репликация виртуальной машины. Если отменить выполняющуюся отработку отказа, она остановится, но виртуальная машина не будет реплицирована повторно.  


    

## <a name="next-steps"></a>Дополнительная информация

В этом разделе вы узнали, как перенести экземпляры EC2 AWS на виртуальные машины Azure. Дополнительные сведения о виртуальных машинах Azure см. в руководствах для виртуальных машин Windows.

> [!div class="nextstepaction"]
> [Создание виртуальных машин Windows и управление ими с помощью модуля Azure PowerShell](../../virtual-machines/windows/tutorial-manage-vm.md)
