---
title: Репликация приложений с помощью SQL Server и Azure Site Recovery | Документы Майкрософт
description: В этой статье рассматривается репликация SQL Server с помощью возможностей аварийного восстановления SQL Server и Azure Site Recovery.
services: site-recovery
documentationcenter: ''
author: prateek9us
manager: gauravd
editor: ''
ms.assetid: 9126f5e8-e9ed-4c31-b6b4-bf969c12c184
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/09/2018
ms.author: pratshar
ms.openlocfilehash: f0c43eee127857edfd1692dce825ef295be09f7b
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="protect-sql-server-using-sql-server-disaster-recovery-and-azure-site-recovery"></a>Защита SQL Server с помощью аварийного восстановления SQL Server и Azure Site Recovery

В этой статье описывается способ организации защиты серверной части SQL Server приложения с помощью сочетания технологий непрерывности бизнес-процессов и аварийного восстановления (BCDR) SQL Server и [Azure Site Recovery](site-recovery-overview.md).

Прежде чем начать, убедитесь, что вы ознакомлены с возможностями аварийного восстановления SQL Server, включая отказоустойчивую кластеризацию, группы доступности AlwaysOn, зеркальное отображение базы данных и доставку журналов.


## <a name="sql-server-deployments"></a>Развертывания SQL Server

Многие рабочие нагрузки используют SQL Server как основу, которую можно интегрировать с такими приложениями, как SharePoint, Dynamics и SAP, для реализации служб данных.  Вы можете развернуть SQL Server несколькими способами:

* **Изолированный сервер SQL Server**. SQL Server и все базы данных размещаются на одном компьютере (физическом или виртуальном). Если сервер виртуальный, то для обеспечения локальной высокой доступности используется кластеризация размещения. Высокая доступность на уровне гостя не обеспечивается.
* **Экземпляры отказоустойчивых кластеров SQL Server (Always On FCI).** В этом случае два или несколько узлов экземпляров SQL Server с общими дисками настраиваются в отказоустойчивом кластере Windows. Если узел не работает, кластер может выполнить отработку отказа SQL Server в другой экземпляр. Эта настройка обычно используется для реализации высокого уровня доступности на основном сайте. Этот тип развертывания не защищает от сбоев и неполадок на уровне общего хранилища. Общий диск может быть реализован с использованием интерфейса iSCSI, Fiber Channel или общих VHDX-файлов.
* **Группы доступности SQL AlwaysOn.** В этом случае два или несколько узлов настраиваются в кластере без общих ресурсов, в котором базы данных SQL Server настроены в группе доступности с синхронной репликацией и автоматической отработкой отказа.

 Ниже описаны исходные технологии аварийного восстановления SQL для восстановления баз данных на удаленном сайте.

* Группы доступности SQL AlwaysOn, чтобы обеспечить аварийное восстановление для выпуска SQL Server Enterprise 2012 или 2014.
* Зеркальное отображение базы данных SQL в режиме высокого уровня безопасности для SQL Server Standard (любой версии) или SQL Server 2008 R2.

## <a name="site-recovery-support"></a>Поддержка Site Recovery

### <a name="supported-scenarios"></a>Поддерживаемые сценарии использования.
В таблице представлены сведения о защите SQL Server службой Site Recovery.

**Сценарий** | **На дополнительный сайт** | **В Azure**
--- | --- | ---
**Hyper-V** | Yes | Yes
**VMware** | Yes | Yes
**Физический сервер** | Yes | Yes
**Таблицы Azure**|Нет данных| Yes

### <a name="supported-sql-server-versions"></a>Поддерживаемые версии SQL Server
Для соответствующих сценариев поддерживаются следующие версии SQL Server:

* SQL Server 2016 Enterprise и Standard;
* SQL Server 2014 Enterprise и Standard;
* SQL Server 2012 Enterprise и Standard;
* SQL Server 2008 R2 Enterprise и Standard.

### <a name="supported-sql-server-integration"></a>Поддерживаемая интеграция SQL Server

Site Recovery может интегрироваться с собственными технологиями SQL Server BCDR, перечисленными в таблице ниже, для создания решения аварийного восстановления.

**Компонент** | **Дополнительные сведения** | **SQL Server** |
--- | --- | ---
**Группы доступности AlwaysOn** | Несколько отдельных экземпляров SQL Server, каждый из которых запущен в отказоустойчивом кластере с несколькими узлами.<br/><br/>Базы данных можно объединить в группы отработки отказа, которые затем можно скопировать (зеркальное отображение) на экземпляры SQL Server, благодаря чему исключается необходимость в общем хранилище.<br/><br/>Обеспечивает аварийное восстановление между основным сайтом и одним или несколькими дополнительными сайтами. Два узла можно настроить в кластере без общих ресурсов, в котором базы данных SQL Server настроены в группе доступности с синхронной репликацией и автоматической отработкой отказа. | Выпуски SQL Server 2016, SQL Server 2014 и SQL Server 2012 Enterprise
**Отказоустойчивая кластеризация (AlwaysOn FCI)** | SQL Server применяет отказоустойчивую кластеризацию Windows для обеспечения высокого уровня доступности локальных рабочих нагрузок SQL Server.<br/><br/>Узлы, на которых выполняются экземпляры SQL Server с общими дисками, настроены в отказоустойчивом кластере. Если экземпляр выходит из строя, выполняется переход кластера на другой ресурс.<br/><br/>Кластер не обеспечивает защиту от сбоев или простоев в общем хранилище. Общий диск может быть реализован с использованием интерфейса iSCSI, Fiber Channel или с помощью в общих VHDX-файлов. | Выпуски SQL Server Enterprise<br/><br/>SQL Server Standard (ограничено только двумя узлами)
**Зеркальное отображение базы данных (в режиме высокого уровня безопасности)** | Защищает одну базу данных переносом в одну дополнительную копию. Доступно как в режиме репликации с высоким уровнем безопасности (синхронный режим), так и в режиме репликации с высоким уровнем производительности (асинхронный режим). Не требует наличия отказоустойчивого кластера. | SQL Server 2008 R2<br/><br/>Все выпуски SQL Server Enterprise
**Автономный SQL Server** | SQL Server и база данных находятся на одном сервере (физическом или виртуальном). Если сервер виртуальный, то кластеризация размещения используется для обеспечения высокой доступности. Без высокой доступности гостевого уровня. | Выпуск Enterprise или Standard

## <a name="deployment-recommendations"></a>Рекомендации по развертыванию

В таблице перечислены рекомендации относительно интеграции технологий SQL Server BCDR в Site Recovery.

| **Версия** | **Выпуск** | **Развертывание** | **От локального к локальным** | **От локального к Azure** |
| --- | --- | --- | --- | --- |
| SQL Server 2014 или 2012 |Enterprise |Экземпляр отказоустойчивого кластера |Группы доступности AlwaysOn |Группы доступности AlwaysOn |
|| Enterprise |Группы доступности AlwaysOn для обеспечения высокой доступности |Группы доступности AlwaysOn |Группы доступности AlwaysOn | |
|| Стандартная |Экземпляр отказоустойчивого кластера (FCI) |Репликация Site Recovery с локальным зеркалом |Репликация Site Recovery с локальным зеркалом | |
|| Enterprise или Standard |Автономный |Репликация Site Recovery |Репликация Site Recovery | |
| SQL Server 2008 R2 или 2008 |Enterprise или Standard |Экземпляр отказоустойчивого кластера (FCI) |Репликация Site Recovery с локальным зеркалом |Репликация Site Recovery с локальным зеркалом |
|| Enterprise или Standard |Автономный |Репликация Site Recovery |Репликация Site Recovery | |
| SQL Server (любая версия) |Enterprise или Standard |Экземпляр отказоустойчивого кластера — приложение DTC |Репликация Site Recovery |Не поддерживается |

## <a name="deployment-prerequisites"></a>Предварительные условия для развертывания

* Локальное развертывание SQL Server с поддерживаемой версией SQL Server. Обычно также требуется служба Active Directory для SQL Server.
* Необходимые условия для сценария, который требуется развернуть. Ознакомьтесь с дополнительными сведениями о требованиях к поддержке для [репликации в Azure](site-recovery-support-matrix-to-azure.md), [в локальную среду](site-recovery-support-matrix.md) и с [предварительными требованиями для развертывания](site-recovery-prereq.md).
* Для настройки восстановления в Azure на виртуальных машинах SQL Server запустите средство [оценки готовности виртуальной машины Azure](http://www.microsoft.com/download/details.aspx?id=40898), чтобы убедиться в их совместимости с Azure и Site Recovery.

## <a name="set-up-active-directory"></a>настроить Active Directory;

Для правильной работы SQL Server на дополнительном сайте восстановления вам потребуется настроить службу Active Directory.

* **Для малых предприятий.** Если у вас имеется небольшое количество приложений и один контроллер домена для локального сайта, то для выполнения отработки отказа всего сайта мы рекомендуем использовать репликацию Site Recovery для репликации контроллера домена в дополнительный центр обработки данных или в Azure.
* **Для средних и крупных предприятий**. Если у вас имеется большое количество приложений и лес Active Directory, то для выполнения отработки отказа для каждого отдельного приложения или рабочей нагрузки мы рекомендуем настроить дополнительный контроллер домена в дополнительном центре обработки данных или в Azure. При использовании групп доступности AlwaysOn для восстановления удаленного сайта мы рекомендуем настроить другой дополнительный контроллер домена на дополнительном сайте или в Azure, который будет использоваться для восстановленного экземпляра SQL Server.

При выполнении инструкций, описанных в этой статье, предполагается, что в дополнительном расположении доступен контроллер домена. [Узнайте больше](site-recovery-active-directory.md) о защите Active Directory с помощью Site Recovery.


## <a name="integrate-with-sql-server-always-on-for-replication-to-azure"></a>Интеграция с SQL Server AlwaysOn для репликации в Azure

Необходимо сделать следующее:

1. Импортировать скрипты в учетную запись службы автоматизации Azure. Содержит скрипты для перехода на другой ресурс группы доступности SQL в [виртуальной машине Resource Manager](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAG.ps1) и [классической виртуальной машине](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAGClassic.ps1).

    [![Развертывание в Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)


1. Добавьте ASR SQL-FailoverAG как предварительное действие первой группы плана восстановления.

1. Следуйте инструкциям в скрипте для создания переменной автоматизации, чтобы предоставить имя группы доступности.

### <a name="steps-to-do-a-test-failover"></a>Действия по тестовой отработке отказа

В SQL AlwaysOn нет встроенной поддержки тестовой отработки отказа. Таким образом, мы рекомендуем следующее.

1. Установите [службу архивации Azure](../backup/backup-azure-arm-vms.md) на виртуальной машине, где размещена реплика группы доступности в Azure.

1. Прежде чем активировать тестовую отработку отказа для плана восстановления, восстановите виртуальную машину из резервной копии, полученной на предыдущем шаге.

    ![Восстановление из службы архивации Azure ](./media/site-recovery-sql/restore-from-backup.png)

1. [Создайте принудительный кворум](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum#PowerShellProcedure) на виртуальной машине, восстановленной из резервной копии.

1. Обновите IP-адрес прослушивателя до IP-адреса в сети тестовой отработки отказа.

    ![Обновление IP-адреса прослушивателя](./media/site-recovery-sql/update-listener-ip.png)

1. Подключите прослушиватель.

    ![Подключение прослушивателя](./media/site-recovery-sql/bring-listener-online.png)

1. Создайте балансировщик нагрузки с одним IP-адресом, созданным во внешнем пуле IP-адресов, соответствующим каждому прослушивателю группы доступности, и с виртуальной машиной SQL, добавленной в серверный пул.

     ![Создание балансировщика нагрузки — внешний пул IP-адресов ](./media/site-recovery-sql/create-load-balancer1.png)

    ![Создание балансировщика нагрузки — серверный пул IP-адресов ](./media/site-recovery-sql/create-load-balancer2.png)

1. Выполните тестовую отработку отказа для плана восстановления.

### <a name="steps-to-do-a-failover"></a>Действия по отработке отказа

После добавления скрипта в план восстановления и проверки плана восстановления с помощью тестовой отработки отказа можно выполнить отработку отказа плана восстановления.


## <a name="integrate-with-sql-server-always-on-for-replication-to-a-secondary-on-premises-site"></a>Интеграция с SQL Server AlwaysOn для репликации на дополнительный локальный сайт

Если SQL Server использует группы доступности для обеспечения высокой доступности (или экземпляр отказоустойчивого кластера), то на сайте восстановления также рекомендуется использовать группы доступности. Обратите внимание, что это актуально для приложений, не использующих распределенные транзакции.

1. [Настройте базы данных](https://msdn.microsoft.com/library/hh213078.aspx) для их добавления в группы доступности.
1. Создайте на дополнительном сайте виртуальную сеть.
1. Настройте подключение VPN типа "сеть — сеть" между виртуальной сетью и основным сайтом.
1. Создайте виртуальную машину на сайте восстановления и установите на нее SQL Server.
1. Расширьте существующие группы доступности AlwaysOn для новой виртуальной машины SQL Server. Настройте этот экземпляр SQL Server в качестве копии асинхронной реплики.
1. Создайте прослушиватель группы доступности или обновите существующий прослушиватель, включив в него виртуальную машину асинхронной реплики.
1. Убедитесь в том, что ферма приложений настроена с помощью прослушивателя. Если настройка выполнена с использованием имени сервера базы данных, обновите его, чтобы использовать прослушиватель и избежать повторной настройки после отработки отказа.

Для приложений, использующих распределенные транзакции, мы рекомендуем развернуть Site Recovery с помощью [репликации VMware или физического сервера типа "сеть — сеть"](site-recovery-vmware-to-vmware.md).

### <a name="recovery-plan-considerations"></a>Рекомендации по плану восстановления
1. Добавьте этот образец сценария в библиотеку VMM на основном и дополнительном сайтах.

        Param(
        [string]$SQLAvailabilityGroupPath
        )
        import-module sqlps
        Switch-SqlAvailabilityGroup -Path $SQLAvailabilityGroupPath -AllowDataLoss -force

1. При создании плана восстановления для приложения добавьте предварительное действие в шаг "Group-1", которое запускает сценарий для отработки отказа групп доступности.

## <a name="protect-a-standalone-sql-server"></a>Защита автономного сервера SQL Server

В этом примере для защиты компьютера SQL Server мы рекомендуем использовать репликацию Site Recovery. Конкретные шаги зависят от того, настроен ли SQL Server в качестве виртуальной машины или физического сервера, а также от необходимости реплицировать в Azure или в дополнительный локальный сайт. Дополнительные сведения см. в статье [Что такое Site Recovery?](site-recovery-overview.md)

## <a name="protect-a-sql-server-cluster-standard-editionwindows-server-2008-r2"></a>Защита кластера SQL Server (версия Standard для Windows Server 2008 R2)

Для кластера под управлением выпуска SQL Server Standard или SQL Server 2008 R2 рекомендуется использовать репликацию Site Recovery для защиты SQL Server.

### <a name="on-premises-to-on-premises"></a>Из локальной среды в локальную среду

* Если приложение использует распределенные транзакции, мы рекомендуем развернуть [репликацию Site Recovery с SAN](site-recovery-vmm-san.md) для среды Hyper-V или [репликацию VMware или физического сервера в VMware](site-recovery-vmware-to-vmware.md) для среды VMware.
* Для приложений без DTC описанный выше метод позволяет восстановить кластер в качестве автономного сервера, используя локальное зеркало баз данных с высоким уровнем безопасности.

### <a name="on-premises-to-azure"></a>Из локальной среды в Azure

Site Recovery не поддерживает гостевой кластер при репликации в Azure. SQL Server также не предоставляет экономичное решение для аварийного восстановления для выпуска Standard. В этом примере мы рекомендуем защитить локальный кластер SQL Server в автономный сервер SQL Server и восстановить его в Azure.

1. Настройте дополнительный автономный экземпляр SQL Server в локальном сайте.
1. Настройте этот экземпляр в качестве зеркальной копии баз данных, которые требуется защитить. Настройте зеркальное отображение в режиме высокого уровня безопасности.
1. Настройте Site Recovery на локальном сайте для [Hyper-V](site-recovery-hyper-v-site-to-azure.md) или [виртуальных машин VMware либо физических серверов](site-recovery-vmware-to-azure-classic.md).
1. Воспользуйтесь репликацией Site Recovery для репликации нового экземпляра SQL Server в Azure. Так как это зеркальная копия с высоким уровнем безопасности, она будет синхронизирована с основным кластером, однако в Azure она будет реплицирована с помощью репликации Site Recovery.


![Стандартный кластер](./media/site-recovery-sql/standalone-cluster-local.png)

### <a name="failback-considerations"></a>Рекомендации относительно восстановления размещения

В случае стандартных кластеров SQL Server восстановление размещения после внеплановой отработки отказа требует выполнения резервного копирования SQL Server и его восстановления из экземпляра зеркала в исходный кластер с повторной установкой зеркала.

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения об архитектуре Site Recovery см. [здесь](site-recovery-components.md).
