---
title: "Как использовать управление API Azure с виртуальными сетями"
description: "Узнайте, как настроить подключение к виртуальной сети в управлении API Azure и обращаться к веб-службам через него."
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.translationtype: HT
ms.sourcegitcommit: 1c730c65194e169121e3ad1d1423963ee3ced8da
ms.openlocfilehash: c733c61132a79381d5e025819ff944507fc3fb9b
ms.contentlocale: ru-ru
ms.lasthandoff: 08/30/2017

---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a>Как использовать управление API Azure с виртуальными сетями
Виртуальные сети Azure позволяют размещать любые ресурсы Azure в сети, недоступной из Интернета, доступом к которой управляете вы сами. Эти сети можно подключать к локальным сетям с помощью различных технологий VPN. Начать изучение виртуальных сетей Azure лучше всего со статьи [Обзор виртуальной сети](../virtual-network/virtual-networks-overview.md).

Службу управления API Azure можно развернуть в пределах виртуальной сети, обеспечив доступ к серверным службам в этой сети. Портал разработчика и шлюз API можно настроить для предоставления доступа как из Интернета, так и только в пределах виртуальной сети.

> [!NOTE]
> Служба управления API Azure поддерживает классические виртуальные сети и виртуальные сети Azure Resource Manager.
>
>

## <a name="enable-vpn"> </a>Включение подключения к виртуальной сети
> [!NOTE]
> Возможность подключения к виртуальным сетям доступна на уровнях **Премиум** и **Developer**. Чтобы перейти на другой уровень, откройте службу управления API на портале Azure и перейдите на вкладку **Scale and pricing** (Масштабирование и цены). В разделе **Ценовая категория** выберите уровень "Премиум" или Developer и нажмите кнопку "Сохранить".
>

Чтобы активировать подключения к виртуальным сетям, откройте службу управления API на портале Azure и перейдите на страницу **Виртуальная сеть**.

![Меню "Виртуальная сеть" для управления API][api-management-using-vnet-menu]

Выберите нужный тип доступа.

* **Внешний**: шлюз управления API и портал разработчика доступны из общедоступного Интернета через внешнюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

![Общедоступный пиринг][api-management-vnet-public]

* **Внутренний**: шлюз управления API и портал разработчика доступны только из виртуальной сети через внутреннюю подсистему балансировки нагрузки. Шлюз может обращаться к ресурсам в виртуальной сети.

![Частный пиринг][api-management-vnet-private]

Будет показан список всех регионов, где предоставляется служба управления API. Выберите виртуальную сеть и подсеть для каждого региона. Список заполняется классическими виртуальными сетями и виртуальными сетями Resource Manager, имеющимися в подписках Azure, которые настроены в настраиваемом регионе.

> [!NOTE]
> **Конечная точка службы** на схеме выше включает конечную точку шлюза или прокси-сервера, портала издателя и разработчика, GIT и конечную точку для прямого управления.
> На схеме выше **конечная точка управления** размещается в службе для управления конфигурацией через портал Azure и PowerShell.
> Кроме того, обратите внимание, что несмотря на то, что на схеме показаны IP-адреса различных конечных точек, служба управления API отвечает **только** на настроенных именах узлов.

> [!IMPORTANT]
> При развертывании экземпляра службы управления API Azure в виртуальной сети Resource Manager служба должна находиться в выделенной подсети, в которой нет других ресурсов, кроме экземпляров управления API Azure. Если попытаться развернуть экземпляр управления API Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, это приведет к сбою.
>
>

![Выбор VPN][api-management-setup-vpn-select]

Щелкните **Сохранить** в верхней части экрана.

> [!NOTE]
> Виртуальный IP-адрес экземпляра управления API будет изменяться при каждом включении или отключении виртуальной сети.  
> Кроме того, виртуальный IP-адрес будет изменяться при изменении типа доступа для управления API с **внешнего** на **внутренний** или наоборот.
>


> [!IMPORTANT]
> Если удалить службу управления API из виртуальной сети или изменить виртуальную сеть, в которой она развернута, ранее использовавшаяся виртуальная сеть может быть заблокирована на 4 часа. В этот период вы не сможете удалить виртуальную сеть или развернуть в ней новый ресурс.

## <a name="enable-vnet-powershell"> </a>Активация подключения к виртуальной сети с помощью командлетов PowerShell
Подключение к виртуальной сети можно также активировать с помощью командлетов PowerShell.

* **Создание службы управления API в виртуальной сети**. Чтобы создать службу управления API Azure в виртуальной сети, используйте командлет [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement).

* **Развертывание существующей службы управления API в виртуальной сети**. Чтобы переместить существующую службу управления API Azure внутри виртуальной сети, используйте командлет [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment).

## <a name="connect-vnet"> </a>Подключение к веб-службе, размещенной в виртуальной сети
После подключения службы управления API к виртуальной сети обращение к размещенным в ней внутренним службам ничем не будет отличаться от обращения к общедоступным службам. Просто введите локальный IP-адрес или имя узла (если для виртуальной сети настроен DNS-сервер) веб-службы в поле **URL-адрес веб-службы** при создании нового API или редактировании существующего.

![Добавление интерфейса API из VPN][api-management-setup-vpn-add-api]

## <a name="network-configuration-issues"> </a>Распространенные проблемы конфигурации сети
Ниже приведен список распространенных ошибок конфигурации, возникающих при развертывании службы управления API в виртуальной сети.

* **Настройка пользовательского DNS-сервера**. Служба управления API зависит от нескольких служб Azure. Если служба управления API размещается в виртуальной сети, в которой используется пользовательский DNS-сервер, она должна разрешить имена узлов этих служб Azure. Следуйте [этим](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) рекомендациям по настройке пользовательского DNS-сервера. Для справки ниже приведена таблица портов, а также другие требования к сети.

> [!IMPORTANT]
> При использовании настраиваемого DNS-сервера для виртуальной сети мы рекомендуем настроить его **перед** развертыванием службы управления API в этой сети. В противном случае службу управления API необходимо обновлять каждый раз при изменении DNS-сервера, выполняя [операцию применения конфигурации сети](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates).

* **Порты, необходимые для управления API**. Входящим и исходящим трафиком в подсети, в которой развернута служба управления API, можно управлять с помощью [группы безопасности сети][Network Security Group]. Если какой-либо из этих портов недоступен, служба управления API может не работать должным образом и даже стать недоступной. Блокировка одного или нескольких из этих портов является одной из распространенных проблем неправильной конфигурации при использовании управления API в виртуальной сети.

При размещении экземпляра службы управления API в виртуальной сети используются порты, указанные в следующей таблице.

| Исходные и конечные порты | Направление | Транспортный протокол | Назначение | Ресурс и назначение | Тип доступа |
| --- | --- | --- | --- | --- | --- |
| * / 80, 443 |Входящий трафик |TCP |Подключения клиентов к службе управления API |INTERNET — VIRTUAL_NETWORK |Внешний |
| * / 3443 |Входящий трафик |TCP |Конечная точка управления для портала Azure и PowerShell |INTERNET — VIRTUAL_NETWORK |Внешний и внутренний |
| * / 80, 443 |Исходящие |TCP |Зависимость для службы хранилища Azure и служебной шины Azure |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 1433 |Исходящие |TCP |Зависимость от SQL Azure |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 11000 - 11999 |Исходящие |TCP |Зависимость от SQL Azure V12 |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 14000 - 14999 |Исходящие |TCP |Зависимость от SQL Azure V12 |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / 5671 |Исходящие |AMQP |Зависимость для политики ведения журнала концентратора событий и агента мониторинга |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| 6381–6383 / 6381–6383 |Входящий и исходящий |TCP |Зависимость для кэша Redis |VIRTUAL_NETWORK — VIRTUAL_NETWORK |Внешний и внутренний |-
| * / 445 |Исходящие |TCP |Зависимость для общей папки Azure для GIT |VIRTUAL_NETWORK — INTERNET |Внешний и внутренний |
| * / * | Входящий трафик |TCP |Подсистема балансировки нагрузки инфраструктуры Azure | AZURE_LOAD_BALANCER / VIRTUAL_NETWORK |Внешний и внутренний |

* **Функции SSL**. Чтобы разрешить создание и проверку цепочки сертификатов SSL, службе управления API требуется исходящее сетевое подключение к узлам ocsp.msocsp.com, mscrl.microsoft.com и crl.microsoft.com. Эта зависимость не является обязательной, если любой сертификат, передаваемый в службу управления API, содержит полную цепочку до корневого ЦС.

* **Доступ к DNS**. Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами. Если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, этот сервер должен быть доступен из подсети, в которой размещена служба управления API.

* **Наблюдение за работоспособностью и метриками**. Исходящее сетевое подключение к конечным точкам мониторинга Azure, которые разрешаются в следующих доменах: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.

* **Настройка ExpressRoute**. В типовой клиентской конфигурации определяется собственный основной маршрут (0.0.0.0/0), который направляет исходящий интернет-трафик в локальную среду. Этот поток трафика неизменно прерывает подключение к службе управления API Azure, так как исходящий трафик или блокируется локально, или преобразуется с помощью NAT в нераспознаваемый набор адресов, которые больше не относятся к различным конечным точкам Azure. Чтобы устранить эту проблему, следует указать один (или несколько) определяемый пользователем маршрут ([UDR][UDRs]) в подсети, которая содержит службу управления API Azure. Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.
  При возможности рекомендуется использовать следующую конфигурацию:
 * Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.
 * Определяемый пользователем маршрут, применяемый к подсети, которая содержит службу управления API Azure, определяет маршрут 0.0.0.0/0 с помощью типа следующего прыжка Интернета.
 В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из службы управления API Azure.

>[!WARNING]  
>Служба управления API Azure не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов неправильно перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра управления API Azure неправильно принудительно туннелируются в локальную сетевую инфраструктуру клиента. Этот сетевой поток нарушает работу службы управления API Azure. Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.


## <a name="troubleshooting"> </a>Устранение неполадок
При внесении изменений в сеть воспользуйтесь [API NetworkStatus](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), чтобы проверить, не утратила ли служба управления API доступ к каким-либо критически важным ресурсам, от которых она зависит. Состояние подключения должно обновляться каждые 15 минут.

## <a name="limitations"> </a>Ограничения
* Подсеть, содержащая экземпляры службы управления API, не может содержать ресурсы Azure каких-либо других типов.
* Эта подсеть и служба управления API должны находиться в одной подписке.
* Невозможно переместить между подписками подсеть, содержащую экземпляры службы управления API.
* При использовании внутренней виртуальной сети будет доступен только внутренний IP-адрес из диапазона, перечисленного в документе [RFC 1918](https://tools.ietf.org/html/rfc1918). Общедоступный IP-адрес предоставить невозможно.
* При развертывании службы управления API с внутренними виртуальными сетями в нескольких регионах пользователи отвечают за управление собственной балансировкой нагрузки, так как им принадлежит служба DNS.


## <a name="related-content"> </a>Связанная информация
* [Подключение типа "сеть — сеть" и многосайтовое подключение (через VPN-туннель IPsec/IKE)](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [Подключение виртуальных сетей из различных моделей развертывания с использованием PowerShell](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [Как использовать инспектор API для трассировки вызовов в службе управления API Azure](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md

