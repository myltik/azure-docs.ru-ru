---
title: Мониторинг опубликованных API-интерфейсов в службе управления API Azure | Документация Майкрософт
description: Следуйте инструкциям из этого руководства, чтобы узнать, как выполнять мониторинг API в службе управления API Azure.
services: api-management
documentationcenter: ''
author: juliako
manager: cfowler
editor: ''
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.custom: mvc
ms.topic: tutorial
ms.date: 11/19/2017
ms.author: apimpm
ms.openlocfilehash: f4b1a6e3ee995fb309577fd6df611a705e613041
ms.sourcegitcommit: 59914a06e1f337399e4db3c6f3bc15c573079832
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2018
---
# <a name="monitor-published-apis"></a>Мониторинг опубликованных API-интерфейсов

С помощью Azure Monitor можно визуализировать, запрашивать, маршрутизировать, архивировать метрики или журналы, полученные от ресурсов Azure, а также реагировать на них.

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Просмотр журналов действий
> * просмотр журналов диагностики;
> * просмотр метрик API; 
> * настройка правила генерации оповещений на случай несанкционированных вызовов API.

В следующем видео показано, как отслеживать управление API с помощью Azure Monitor. 

> [!VIDEO https://channel9.msdn.com/Blogs/AzureApiMgmt/Monitor-API-Management-with-Azure-Monitor/player]
>
>

## <a name="prerequisites"></a>предварительным требованиям

+ Выполните задачи в кратком руководстве по [созданию экземпляра службы управления API Azure](get-started-create-service-instance.md).
+ Также выполните задачи из руководства по [импорту и публикации первого API](import-and-publish.md).

## <a name="view-metrics-of-your-apis"></a>Просмотр метрик API

Служба управления API каждую минуту передает метрики, позволяя отслеживать состояние и работоспособность API-интерфейсов практически в реальном времени. Ниже приведено описание некоторых доступных метрик.

* Емкость (предварительная версия): позволяет принимать решения о необходимости повышения или понижения уровня служб управления API. Метрика отправляется каждую минуту и отражает емкость шлюза в момент создания отчета. Значение метрики колеблется в диапазоне от 0 до 100. Оно вычисляется на основе ресурсов шлюза, таких как загрузка центрального процессора и использование памяти.
* Общее количество запросов к шлюзу. Количество запросов API за период. 
* Успешные запросы к шлюзу. Количество запросов API, которые успешно получили коды ответов HTTP, включая 304, 307 и все, не превышающие 301 (например, 200).
* Неудачные запросы к шлюзу. Количество запросов API, которые получили ошибочные коды ответов HTTP, включая 400 и все, превышающие 500.
* Неавторизованные запросы к шлюзу. Количество запросов API, которые получили коды ответов HTTP, включая 401, 403 и 429.
* Другие запросы к шлюзу. Количество запросов API, которые получили коды ответов HTTP, не принадлежащие ни к одной из указанных выше категорий (например, 418).

Для доступа к метрике сделайте следующее:

1. В меню внизу страницы выберите пункт **Метрика**.
2. В раскрывающемся списке выберите метрики, которые вас интересуют (можно добавить несколько метрик). 

    Например, выберите из списка доступных метрик **Total Gateway Requests** (Общее количество запросов через шлюз) и **Failed Gateway Requests** (Неудачные запросы через шлюз).
3. Просмотрите диаграмму с общим числом вызовов API. Кроме того, на не показано число неудачных вызовов API. 

## <a name="set-up-an-alert-rule-for-unauthorized-request"></a>Настройка правила генерации оповещений на случай несанкционированного запроса

Вы можете настроить получение уведомлений на основе метрик и журналов действий. Azure Monitor позволяет настроить действие, выполняемое при активации оповещения:

* Отправка уведомления по электронной почте.
* Вызов webhook.
* Вызов приложения логики Azure.

Чтобы настроить оповещения, сделайте следующее:

1. В меню внизу страницы выберите пункт **Правила оповещений**.
2. Выберите **Добавить оповещение метрики**.
3. Укажите **имя** для оповещения.
4. Выберите **Unauthorized Gateway Requests** (Несанкционированные запросы через шлюз) в качестве метрики для мониторинга.
5. Выберите **Участники, читатели и владельцы электронной почты**.
6. Нажмите кнопку **ОК**.
7. Попытайтесь вызвать Conference API без ключа API. Как владелец этого экземпляра службы управления API вы получите оповещение по электронной почте. 

    > [!TIP]
    > При срабатывании правило генерации оповещений может также вызывать веб-перехватчик или приложение логики Azure.

    ![set-up-alert](./media/api-management-azure-monitor/set-up-alert.png)

## <a name="activity-logs"></a>Журналы действий

Журналы действий позволяют подробно проанализировать операции, выполненные в службах управления API. С помощью журналов изменений можно ответить на вопросы "что? кто? когда?" о любой операции записи (PUT, POST, DELETE) в службах управления API.

> [!NOTE]
> Журналы действий не содержат операций чтения (GET) и операций, выполненных на портале Azure или с помощью исходных API управления.

Вы можете получить доступ к журналам действий в службе управления API или получить доступ к журналам всех ресурсов Azure в Azure Monitor. 

Чтобы просмотреть журналы действий, сделайте следующее:

1. Выберите свой экземпляр службы управления API.
2. Щелкните **Журнал действий**.

## <a name="diagnostic-logs"></a>Журналы диагностики

Журналы диагностики предоставляют подробные сведения об операциях и ошибках, которые важны для аудита, а также для устранения неполадок. Журналы диагностики отличаются от журналов действий. Журналы действий позволяют подробно проанализировать операции, выполненные с ресурсами Azure. Журналы диагностики дают представление об операциях, выполняемых ресурсом.

Настройка журналов диагностики.

1. Выберите свой экземпляр службы управления API.
2. Щелкните **Журналы диагностики**.
3. Щелкните **Включить диагностику**. Вы можете архивировать журналы диагностики и метрики в учетную запись хранения, передать их потоком в концентратор событий или отправить в Log Analytics. 

Сейчас в службе управления API предоставляются журналы диагностики (выполняемые в пакетном режиме каждый час) отдельных запросов API со следующей схемой каждой записи:

```json
{  
    "isRequestSuccess" : "",
    "time": "",
    "operationName": "",
    "category": "",
    "durationMs": ,
    "callerIpAddress": "",
    "correlationId": "",
    "location": "",
    "httpStatusCodeCategory": "",
    "resourceId": "",
    "properties": {   
        "method": "", 
        "url": "", 
        "clientProtocol": "", 
        "responseCode": , 
        "backendMethod": "", 
        "backendUrl": "", 
        "backendResponseCode": ,
        "backendProtocol": "",  
        "requestSize": , 
        "responseSize": , 
        "cache": "", 
        "cacheTime": "", 
        "backendTime": , 
        "clientTime": , 
        "apiId": "",
        "operationId": "", 
        "productId": "", 
        "userId": "", 
        "apimSubscriptionId": "", 
        "backendId": "",
        "lastError": { 
            "elapsed" : "", 
            "source" : "", 
            "scope" : "", 
            "section" : "" ,
            "reason" : "", 
            "message" : ""
        } 
    }      
}  
```

| Свойство  | type | ОПИСАНИЕ |
| ------------- | ------------- | ------------- |
| isRequestSuccess | Логическое | Значение true, если в ответ на HTTP-запрос получен код состояния ответа в пределах диапазона 2xx или 3xx |
| Twitter в режиме реального | date-time | Метка времени поступления HTTP-запроса в шлюз |
| operationName | строка | Постоянное значение Microsoft.ApiManagement/GatewayLogs |
| category | строка | Постоянное значение GatewayLogs |
| durationMs | целое число | Количество миллисекунд с момента поступления запроса в шлюз до момента полной отправки ответа |
| callerIpAddress | строка | IP-адрес непосредственно вызывающего объекта шлюза (может быть посредником) |
| correlationId | строка | Уникальный идентификатор HTTP-запроса, назначенный службой управления API |
| location | строка | Имя региона Azure, в котором находится шлюз, обработавший запрос |
| httpStatusCodeCategory | строка | Категория кода состояния HTTP-ответа: успешно (301 или меньше, 304 или 307), запрос не авторизован (401, 403, 429), ошибка (400, от 500 до 600), другое |
| ResourceId | строка | Идентификатор ресурса управления API /SUBSCRIPTIONS/<subscription>/RESOURCEGROUPS/<группа_ресурсов>/PROVIDERS/MICROSOFT.APIMANAGEMENT/SERVICE/<name> |
| properties | object | Свойства текущего запроса |
| метод | строка | Метод HTTP входящего запроса |
| URL-адрес | строка | URL-адрес входящего запроса |
| clientProtocol | строка | Версия протокола HTTP входящего запроса |
| responseCode | целое число | Код состояния ответа HTTP, отправленного клиенту |
| backendMethod | строка | Метод HTTP запроса, отправленного в серверную часть |
| backendUrl | строка | URL-адрес запроса, отправленного в серверную часть |
| backendResponseCode | целое число | Код HTTP-ответа, полученного от серверной части |
| backendProtocol | строка | Версия протокола HTTP для запроса, отправленного в серверную часть | 
| requestSize | целое число | Число байтов, полученных от клиента во время обработки запроса | 
| responseSize | целое число | Число байтов, отправленных клиенту во время обработки запроса | 
| cache | строка | Состояние участия кэша управления API в обработке запроса (т. е. попадания, пропуски, ничего) | 
| cacheTime | целое число | Время в миллисекундах, затраченное на все операции ввода-вывода кэша службы управления API (подключение, отправка и получение байтов) | 
| backendTime | целое число | Время в миллисекундах, затраченное на все операции ввода-вывода серверной части (подключение, отправка и получение байтов) | 
| clientTime | целое число | Время в миллисекундах, затраченное на все операции ввода-вывода клиента (подключение, отправка и получение байтов) | 
| apiId | строка | Идентификатор сущности API для текущего запроса | 
| operationId | строка | Идентификатор сущности операции для текущего запроса | 
| productId | строка | Идентификатор сущности продукта для текущего запроса | 
| userId | строка | Идентификатор сущности пользователя для текущего запроса | 
| apimSubscriptionId | строка | Идентификатор сущности подписки для текущего запроса | 
| backendId | строка | Идентификатор сущности серверной части для текущего запроса | 
| LastError | object | Ошибка обработки последнего запроса | 
| elapsed | целое число | Время в миллисекундах, истекшее с момента поступления запроса в шлюз до момента возникновения ошибки | 
| источник | строка | Имя политики или внутреннего обработчика, вызвавшего ошибку | 
| scope | строка | Область действия документа, содержащего политику, которая вызвала ошибку | 
| section | строка | Раздел документа, содержащего политику, которая вызвала ошибку | 
| reason | строка | Причина ошибки | 
| Message | строка | Сообщение об ошибке | 

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * Просмотр журналов действий
> * просмотр журналов диагностики;
> * просмотр метрик API;
> * настройка правила генерации оповещений на случай несанкционированных вызовов API.

Перейдите к следующему руководству:

> [!div class="nextstepaction"]
> [Трассировка вызовов](api-management-howto-api-inspector.md)
