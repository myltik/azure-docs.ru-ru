---
title: Расширенное регулирование запросов с помощью API Management
description: Узнайте, как создавать и применять гибкие квоты и политики ограничения частоты запросов, используя службу управления API Azure.
services: api-management
documentationcenter: ''
author: vladvino
manager: erikre
editor: ''
ms.assetid: fc813a65-7793-4c17-8bb9-e387838193ae
ms.service: api-management
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 02/03/2018
ms.author: apimpm
ms.openlocfilehash: c7fcbd57021134631e9f10dcbb2d40e4c130af02
ms.sourcegitcommit: 168426c3545eae6287febecc8804b1035171c048
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2018
ms.locfileid: "29800029"
---
# <a name="advanced-request-throttling-with-azure-api-management"></a>Расширенное регулирование запросов с помощью API Management
Возможность регулирования входящих запросов — ключевая роль службы управления Azure API. Контролируя частоту запросов или общий объем запросов либо передаваемых данных, служба управления API позволяет поставщикам API предотвращать злоупотребление API и предлагать различные уровни API.

## <a name="product-based-throttling"></a>Регулирование на основе продукта
На сегодняшний день возможности регулирования частоты запросов ограничиваются подпиской конкретного продукта, определенной на портале Azure. Это позволяет поставщику API устанавливать ограничения для разработчиков, зарегистрировавшихся для использования API, но не дает им возможность, например, регулировать отдельных пользователей API. Есть вероятность, что отдельный пользователь приложения израсходует весь лимит, в результате чего остальные клиенты соответствующего разработчика не смогут работать с приложением. Кроме того, несколько клиентов, создающих большое число запросов, могут затруднять доступ для пользователей, которые обращаются к приложению редко.

## <a name="custom-key-based-throttling"></a>Регулирование запросов на основе настраиваемых ключей
Новые политики [rate-limit-by-key](https://msdn.microsoft.com/library/azure/dn894078.aspx#LimitCallRateByKey) и [quota-by-key](https://msdn.microsoft.com/library/azure/dn894078.aspx#SetUsageQuotaByKey) увеличивают гибкость управления трафиком. Они позволяют определять выражения для идентификации ключей, которые используются для контроля за объемом трафика. Принцип работы этих политик лучше всего демонстрирует пример. 

## <a name="ip-address-throttling"></a>Регулирование запросов по IP-адресам
Описанные ниже политики накладывают на каждый IP-адрес клиента следующие ограничения: не более 10 запросов в минуту и не более 1 000 000 вызовов и 10 000 килобайт пропускной способности в месяц. 

```xml
<rate-limit-by-key  calls="10"
          renewal-period="60"
          counter-key="@(context.Request.IpAddress)" />

<quota-by-key calls="1000000"
          bandwidth="10000"
          renewal-period="2629800"
          counter-key="@(context.Request.IpAddress)" />
```

Если все клиенты в Интернете используют уникальный IP-адрес, этот способ позволит эффективно ограничить расход трафика для каждого пользователя. Однако часто случается, что несколько пользователей совместно используют один общедоступный IP-адрес, так как доступ в Интернет им предоставляется через устройство NAT. Но даже в этом случае для API, разрешающих доступ к `IpAddress` без проверки подлинности, этот вариант оптимален.

## <a name="user-identity-throttling"></a>Регулирование запросов по удостоверениям пользователя
Если пользователь прошел аутентификацию, то на основе данных, уникально идентифицирующих этого пользователя, генерируется ключ регулирования.

```xml
<rate-limit-by-key calls="10"
    renewal-period="60"
    counter-key="@(context.Request.Headers.GetValueOrDefault("Authorization","").AsJwt()?.Subject)" />
```

В данном примере показано, как извлечь заголовок Authorization, преобразовать его в объект `JWT`, а затем использовать субъект маркера для идентификации пользователя и в качестве ключа для ограничения частоты запросов. Если удостоверение пользователя хранится в `JWT` вместе с другими утверждениями, вместо него можно использовать соответствующее значение.

## <a name="combined-policies"></a>Объединенные политики
Несмотря на то, что новые политики регулирования дают больше контроля, чем предыдущие, их можно выгодно объединять. Регулирование с использованием ключа подписки продукта (см. разделы [Limit call rate by subscription](https://msdn.microsoft.com/library/azure/dn894078.aspx#LimitCallRate) (Ограничение частоты вызовов по подписке) и [Set usage quota by subscription](https://msdn.microsoft.com/library/azure/dn894078.aspx#SetUsageQuota) (Задание квоты использования по подписке)) — это отличный способ получения прибыли от API, основанный на уровнях использования. Кроме того, появляется возможность более точно регулировать запросы по пользователям, не позволяя одному пользователю мешать другим. 

## <a name="client-driven-throttling"></a>Регулирование со стороны клиента
Если ключ регулирования определяется с использованием [выражения политики](https://msdn.microsoft.com/library/azure/dn910913.aspx), объемы регулирования определяются поставщиком API. При этом разработчик может предпочитать самостоятельный контроль над ограничением частоты запросов для своих пользователей. Для этого поставщик API может ввести настраиваемый заголовок, позволяющий клиентскому приложению разработчика передавать ключ в API.

```xml
<rate-limit-by-key calls="100"
          renewal-period="60"
          counter-key="@(request.Headers.GetValueOrDefault("Rate-Key",""))"/>
```

Это позволит клиентскому приложению разработчика выбирать способ создания ключа, ограничивающего частоту запросов. Разработчики клиента могут создать свои собственные уровни частоты запросов, назначив пользователям наборы ключей и контролируя их использование.

## <a name="summary"></a>Сводка
Служба управления API позволяет регулировать частоту запросов и квоты для защиты и повышения эффективности API. Новые политики регулирования с настраиваемыми правилами масштабирования позволяют контролировать политики более точно и дают вашим клиентам возможность создавать еще более качественные приложения. Примеры в этой статье демонстрируют применение новых политик в виде создания ключей для ограничения частоты запросов по IP-адресам клиентов, удостоверениям пользователей и значениям, формируемым клиентами. В то же время можно использовать и многие другие части сообщений, включая агентов пользователей, фрагменты URL-адресов и размеры сообщений.

## <a name="next-steps"></a>Дополнительная информация
Сообщите нам свое мнение в обсуждении Disqus. Мы будем рады узнать о других возможных значениях ключей, подходящих для вашего случая.

