---
title: "Руководство по расширенной подготовке данных для системы совместного использования велосипедов при помощи Azure Machine Learning Workbench"
description: "Руководство по полной подготовке данных при помощи Azure Machine Learning Workbench"
services: machine-learning
author: ranvijaykumar
ms.author: ranku
manager: mwinkle
ms.reviewer: garyericson, jasonwhowell, mldocs
ms.service: machine-learning
ms.workload: data-services
ms.custom: mvc, tutorial, azure
ms.topic: article
ms.date: 09/21/2017
ms.openlocfilehash: 9e20c606973447e0b01eaf9716fabf47eefd228b
ms.sourcegitcommit: 310748b6d66dc0445e682c8c904ae4c71352fef2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/28/2017
---
# <a name="bike-share-tutorial-advanced-data-preparation-with-azure-machine-learning-workbench"></a>Руководство по расширенной подготовке данных для системы совместного использования велосипедов при помощи Azure Machine Learning Workbench
Служба "Машинное обучение Azure" (предварительная версия) — это полнофункциональное интегрированное аналитическое решение для специалистов по обработке данных. Оно помогает подготавливать данные, разрабатывать эксперименты и развертывать модели в масштабе облака.

В этом руководстве вы будете использовать службу "Машинное обучение Azure" (предварительная версия), чтобы научиться выполнять следующие задачи:
> [!div class="checklist"]
> * Интерактивная подготовка данных с помощью средства подготовки данных в службе "Машинное обучение Azure".
> * Импорт, преобразование и создание тестового набора данных.
> * Создание пакета подготовки данных.
> * Запуск пакета подготовки данных с использованием Python.
> * Создание набора данных для обучения с повторным использованием пакета подготовки данных для дополнительных входных файлов.

> [!IMPORTANT]
> Это руководство относится только к подготовке данных. В нем не описано создание модели прогнозирования.
>
> Подготовленные данные можно использовать для обучения собственных моделей прогнозирования. Например, можно создать модель для прогнозирования спроса на велосипеды в течение 2-часового интервала времени.

## <a name="prerequisites"></a>Предварительные требования
* Приложение Azure Machine Learning Workbench должно быть установлено локально. Дополнительные сведения см. в [кратком руководстве по установке](quickstart-installation.md).
* Навыки создания проектов в Workbench.

## <a name="data-acquisition"></a>Сбор данных
В этом руководстве используются [набор данных Hubway в Бостоне](https://s3.amazonaws.com/hubway-data/index.html) и сведения [NOAA](http://www.noaa.gov/) о погоде в Бостоне.

1. Загрузите файлы данных по ссылкам ниже в локальную среду разработки. 
   * [Сведения о погоде в Бостоне](https://azuremluxcdnprod001.blob.core.windows.net/docs/azureml/bikeshare/BostonWeather.csv). 
   * Сведения о поездках Hubway с веб-сайта Hubway.

      - [201501-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201501-hubway-tripdata.zip)
      - [201504-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201504-hubway-tripdata.zip)
      - [201510-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201510-hubway-tripdata.zip)
      - [201601-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201601-hubway-tripdata.zip)
      - [201604-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201604-hubway-tripdata.zip)
      - [201610-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201610-hubway-tripdata.zip)
      - [201701-hubway-tripdata.zip](https://s3.amazonaws.com/hubway-data/201701-hubway-tripdata.zip)

2. Распакуйте каждый ZIP-файл после загрузки.

## <a name="learn-about-the-datasets"></a>Сведения о наборах данных
1. Файл со сведениями о __погоде в Бостоне__ содержит следующие поля для связанных с погодой данных, которые отображаются каждый час:
   * DATE
   * REPORTTPYE;
   * HOURLYDRYBULBTEMPF;
   * HOURLYRelativeHumidity;
   * HOURLYWindSpeed.

2. Данные __Hubway__ упорядочены в файлах по годам и месяцам. Например, файл с именем `201501-hubway-tripdata.zip` — это CSV-файл с данными за январь 2015 г. Данные помещены в указанные ниже поля. Каждая строка представляет поездку на велосипеде:

   * длительность поездки (в секундах);
   * дата и время начала;
   * дата и время остановки;
   * имя и ИД начальной станции;
   * имя и ИД конечной станции;
   * ИД велосипеда;
   * тип пользователя (случайный — пользователь со временем поездки 24 или 72 часа; участник — пользователь, предпринимающий поездки ежегодно или ежемесячно);
   * почтовый индекс (если пользователь является участником);
   * пол (самостоятельно указывается участником).

## <a name="create-a-new-project"></a>Создание нового проекта
1. Запустите **Azure Machine Learning Workbench** из меню "Пуск" или при помощи средства запуска.

2. Создайте проект службы "Машинное обучение Microsoft Azure".  Нажмите кнопку **+** на странице **Проекты** или последовательно выберите **Файл** > **Создать**.
   - Используйте шаблон **пустого проекта**.
   - Назовите проект **BikeShare**. 

## <a id="newdatasource"></a>Создание источника данных

1. Создайте источник данных. Нажмите кнопку **Данные** (значок цилиндра) на панели слева. Отобразится вкладка **Просмотр данных**.

   ![Изображение вкладки просмотра данных](media/tutorial-bikeshare-dataprep/navigatetodatatab.png)

2. Добавьте источник данных. Щелкните значок **+** и выберите **Добавить источник данных**.

   ![Изображение элемента добавления источника данных](media/tutorial-bikeshare-dataprep/newdatasource.png)

## <a name="add-weather-data"></a>Добавление сведений о погоде

1. **Хранилище данных.** Выберите хранилище, в котором содержатся данные. Так как вы используете файлы, выберите **File(s)/Directory** (Файл(ы) или каталог). Нажмите кнопку **Далее**, чтобы продолжить.

   ![Изображение элемента File(s)/Directory (Файл(ы) или каталог)](media/tutorial-bikeshare-dataprep/datasources.png)

2. **Выбор файла.** Добавьте сведения о погоде. Найдите и выберите загруженный ранее файл `BostonWeather.csv`. Щелкните **Далее**.

   ![Экран выбора с выбранным файлом BostonWeater.csv](media/tutorial-bikeshare-dataprep/pickweatherdatafile.png)

3. **Сведения о файле.** Проверьте схему обнаруженного файла. Azure Machine Learning Workbench анализирует данные в файле и выводит схему для использования.

   ![Экран сведений о файле](media/tutorial-bikeshare-dataprep/fileparameters.png)

   > [!IMPORTANT]
   > В некоторых случаях Workbench может не обнаружить правильную схему. Обязательно проверяйте правильность параметров для набора данных. Убедитесь, что для сведений о погоде установлены следующие значения:
   >
   > * __Тип файла:__ файл с разделителями (csv, tsv, txt и т. д.).
   > * __Разделитель:__ запятая [,].
   > * __Символ в строке комментария:__ значение не задано.
   > * __Режим пропуска строк:__ не пропускать.
   > * __Кодировка файла:__ utf-8.
   > * __Режим повышения уровня для заголовков:__ использовать заголовки из первого файла.

   В режиме предварительного просмотра данных должны отображаться следующие столбцы:
   * **Путь**
   * **DATE**;
   * **REPORTTYPE**;
   * **HOURLYDRYBULBTEMPF**;
   * **HOURLYRelativeHumidity**;
   * **HOURLYWindSpeed**.

   Нажмите кнопку **Далее**, чтобы продолжить.

4. **Типы данных.** Проверьте типы данных, которые определяются автоматически. Azure Machine Learning Workbench анализирует данные в файле и выводит сведения о типах данных для использования.

   Для этих данных измените `DATA TYPE` для всех столбцов на `String`.

   > [!NOTE]
   > `String` используется для описания возможностей Workbench далее в этом руководстве. 

   ![Экран сведений о типах данных](media/tutorial-bikeshare-dataprep/datatypedetection.png)

   Нажмите кнопку __Далее__, чтобы продолжить. 

5. **Выборка.** Чтобы создать схему выборки, нажмите кнопку **+Создать**. Выберите добавленную строку __Top 10000__ (Первые 10 000) и нажмите __Изменить__. Задайте для параметра __Sample Strategy__ (Стратегия выборки) значение **Full File** (Файл полностью), а затем выберите **Применить**.

   ![Экран добавления новой стратегии выборки](media/tutorial-bikeshare-dataprep/weatherdatasampling.png)

   Для использования стратегии __Full File__ (Файл полностью), выберите запись __Full File__ (Файл полностью), а затем нажмите __Установить как активный__. Рядом с записью __Full File__ (Файл полностью) отобразится звездочка, указывающая на то, что стратегия активна.

   ![Экран с активной стратегией Full File (Файл полностью)](media/tutorial-bikeshare-dataprep/fullfileactive.png)

   Нажмите кнопку **Далее**, чтобы продолжить.

6. **Столбец пути.** Раздел __Path Column__ (Столбец пути) позволяет добавить полный путь к файлу как столбец в импортированных данных. Выберите __Do Not Include Path Column__ (Не включать столбец пути).

   > [!TIP]
   > Включение столбца пути полезно в том случае, если вы импортируете папку с множеством файлов с различными именами. Это также полезно, если имена файлов содержат сведения, которые нужно извлечь позже.

   ![Экран с параметром Path Column (Столбец пути), для которого задано значение Do Not Include Path Column (Не включать столбец пути)](media/tutorial-bikeshare-dataprep/pathcolumn.png)

7. **Завершение.** чтобы завершить создание источника данных, нажмите кнопку **Готово**.

    Откроется новая вкладка источника данных с именем __BostonWeather__. Пример данных отображается в представлении сетки. Пример построен на активной схеме выборки, которая рассматривалась ранее.

    Обратите внимание, что в области **Шаги** в правой части экрана отображаются отдельные действия, выполненные при создании этого источника данных.

   ![Экран источника данных, примера и области шагов](media/tutorial-bikeshare-dataprep/weatherdataloaded.png)

### <a name="view-data-source-metrics"></a>Просмотр метрик источника данных

Нажмите кнопку __Метрики__ в верхнем левом углу представления сетки для вкладки. В этом представлении отображаются сведения о распределении и другая статистическая информация для данных выборки.

![Экран с отображением метрик](media/tutorial-bikeshare-dataprep/weathermetrics.png)

> [!NOTE]
> Чтобы настроить режим отображения статистических данных, используйте раскрывающийся список **Choose Metric** (Выбор метрики). Чтобы изменить представление сетки, устанавливайте или снимайте флажки напротив определенных метрик.

Чтобы вернуться к __просмотру данных__, в левом верхнем углу страницы выберите __Данные__.

## <a name="add-data-source-to-data-preparation-package"></a>Добавление источника данных в пакет подготовки данных

1. Чтобы начать подготовку данных, выберите __Подготовить__. 

2. При появлении запроса введите имя пакета для подготовки данных, например `BikeShare Data Prep`. 

3. Чтобы продолжить, нажмите кнопку __ОК__ .

   ![Изображение диалогового окна подготовки](media/tutorial-bikeshare-dataprep/dataprepdialog.png)

4. В разделе __Подготовка данных__ на вкладке __Данные__ отобразится новый пакет с именем **BikeShare Data Prep**. 

   Чтобы открыть пакет, выберите эту запись. 

5. Нажмите кнопку **>>**, чтобы развернуть окно и просмотреть __потоки данных__, содержащиеся в пакете. В этом примере единственным потоком данных является__BostonWeather__.

   > [!IMPORTANT]
   > Пакет может содержать несколько потоков данных.

   ![Экран потоков данных, содержащихся в пакете](media/tutorial-bikeshare-dataprep/weatherdataloadedingrid.png)

## <a name="filter-data-by-value"></a>Фильтрация данных по значению
1. Чтобы отфильтровать данные, щелкните правой кнопкой мыши ячейку с определенным значением, нажмите __Фильтр__ и выберите тип фильтра.

2. Для этого руководства выберите ячейку, которая содержит значение `FM-15`, и установите для фильтра значение **Равно**.  Теперь данные фильтруются и возвращаются только строки, в которых для __REPORTTYPE__ установлено значение `FM-15`.

   ![Изображение диалогового окна фильтра](media/tutorial-bikeshare-dataprep/weatherfilterinfm15.png)

   > [!NOTE]
   > FM-15 — это тип объекта регулярной авиационной сводки погоды в метеорологическом терминале (METAR). Отчеты FM-15 эмпирически отслеживаются, чтобы предоставлялась наиболее исчерпывающая информация.

## <a name="remove-a-column"></a>Удаление столбца

Столбец __REPORTTYPE__ больше не нужен. Щелкните правой кнопкой мыши заголовок столбца и выберите **Удалить столбец**.

   ![Изображение параметра удаления столбца](media/tutorial-bikeshare-dataprep/weatherremovereporttype.png)

## <a name="change-datatypes-and-remove-errors"></a>Изменение типов данных и устранение ошибок
1. Нажав клавишу __CTRL (Command ⌘ на компьютере Mac)__ при выделении заголовков столбцов, можно выбрать несколько столбцов одновременно. Выберите таким образом следующие заголовки столбцов:
   * **HOURLYDRYBULBTEMPF**;
   * **HOURLYRelativeHumidity**;
   * **HOURLYWindSpeed**.

2. **Щелкните правой кнопкой мыши** один из выбранных заголовков столбцов и выберите **Convert Field Type to Numeric** (Преобразовать тип поля в числовой). После этого тип данных столбцов преобразуется в числовой.

   ![Преобразование нескольких столбцов в числовые](media/tutorial-bikeshare-dataprep/weatherconverttonumeric.png)

3. Примените фильтр, чтобы получить значения с ошибками. В некоторых столбцах возникают проблемы с преобразованием данных. На такие проблемы указывает красный цвет __панели качества данных__ для столбца.

   Чтобы удалить строки с ошибками, щелкните правой кнопкой мыши заголовок столбца **HOURLYDRYBULBTEMPF**. Выберите **Фильтровать столбец**. Используйте для параметра **I Want To** (Требуется) значение по умолчанию **Keep Rows** (Сохранить строки). Измените раскрывающийся список **Условия** таким образом, чтобы при выборе условия определялись как **не являющиеся ошибкой**. Нажмите кнопку **ОК**, чтобы применить фильтр.

4. Чтобы устранить ошибки в оставшихся строках в других столбцах, повторите процедуру фильтрации для столбцов **HOURLYRelativeHumidity** и **HOURLYWindSpeed**.

## <a name="use-by-example-transformations"></a>Преобразования с использованием образца

Чтобы использовать данные прогноза для двухчасовых интервалов времени, вычислите для них средние погодные условия. Чтобы сделать это, можно выполнить следующие действия:

* Разделите столбец **DATE** на отдельные столбцы **Date** и **Time**. В следующем разделе представлены более подробные инструкции.

* Получите столбец **Hour_Range** из столбца **Time**. В разделе далее представлены более подробные инструкции.

* Получите столбец **Date\_Hour\_Range** из столбцов **DATE** и **Hour_Range**. В разделе далее представлены более подробные инструкции.

### <a name="split-column-by-example"></a>Разделение столбца по образцу

1. Разделите столбец **DATE** на отдельные столбцы даты и времени. Щелкните правой кнопкой мыши заголовок столбца **DATE** и выберите **Split Column by Example** (Разделить столбец по образцу).

   ![Изображение элемента разделения столбца по образцу](media/tutorial-bikeshare-dataprep/weathersplitcolumnbyexample.png)

2. Azure Machine Learning Workbench автоматически определяет применимый разделитель и создает два столбца, разделив данные на значения даты и времени. 

3. Нажмите __ОК__, чтобы принять результаты разделения.

   ![Экран с разделенными столбцами DATE_1 и DATE_2](media/tutorial-bikeshare-dataprep/weatherdatesplitted.png)

### <a name="derive-column-by-example"></a>Получение столбца по образцу

1. Чтобы получить данные за двухчасовой интервал времени, щелкните правой кнопкой мыши заголовок столбца __DATE\_2__ и выберите **Derive Column by Example** (Получение столбца по образцу).

   ![Изображение элемента получения столбца по образцу](media/tutorial-bikeshare-dataprep/weatherdate2range.png)

   Добавляется пустой столбец со значениями NULL.

2. Щелкните первую пустую ячейку в новом столбце. Укажите образец требуемого интервала времени. Для этого введите `12AM-2AM` в новый столбец и нажмите клавишу ВВОД.

   ![Изображение нового столбца со значением 12AM-2AM](media/tutorial-bikeshare-dataprep/weathertimerangeexample.png)

   > [!NOTE]
   > Azure ML Workbench синтезирует программу, основанную на предоставленных вами образцах, и применяет ее к оставшимся строкам. Все остальные строки автоматически заполняются на основе предоставленного вами образца. Кроме того, Workbench анализирует данные и пытается определить пограничные случаи. 
  
3. Текст **Анализ данных** над сеткой указывает, что Workbench пытается определить пограничные случаи. После этого состояние приобретает значение **Review next suggested row** (Проверка следующей предлагаемой строки) или **No suggestions** (Предложения отсутствуют). В этом примере возвращается значение **Review next suggested row** (Проверка следующей предлагаемой строки).

4. Чтобы просмотреть предлагаемые изменения, выберите **Review next suggested row** (Проверка следующей предлагаемой строки). Ячейка, которую необходимо просмотреть и исправить (при необходимости), выделяется на экране.

   ![Экран просмотра строки](media/tutorial-bikeshare-dataprep/weatherreviewnextsuggested.png)

    Нажмите __ОК__, чтобы принять преобразование.
 
5. Вы вернетесь к представлению сетки данных для __BostonWeather__. Теперь сетка содержит три столбца, добавленных ранее.

   ![Представление сетки с добавленными строками](media/tutorial-bikeshare-dataprep/timerangecomputed.png)

   > [!TIP]
   >  Все внесенные изменения сохраняются в области **Шаги**. Перейдите к действию в области **Шаги**, щелкните стрелку вниз и выберите **Изменить**. Будет развернуто окно **Derive Column by Example** (Получение столбца по образцу). Здесь сохраняются все образцы. Кроме того, можно добавлять образцы вручную, дважды щелкнув строку в сетке ниже. Выберите **Отмена**, чтобы вернуться к основной сетке без применения изменений. Это представление также можно открыть, выбрав **Расширенный режим** при выполнении преобразования **Derive Column by Example** (Получение столбца по образцу).

6. Чтобы переименовать столбец, дважды щелкните его заголовок и введите **Hour Range**. Нажмите клавишу **ВВОД**, чтобы сохранить изменения.

   ![Переименование столбца](media/tutorial-bikeshare-dataprep/weatherhourrangecolumnrename.png)

7. Для получения интервала дат и времени, одновременно выберите столбцы **Date\_1** и **Hour Range**, щелкните правой кнопкой мыши и выберите **Derive column by example** (Получение столбца по образцу).

   ![Получение столбца по образцу](media/tutorial-bikeshare-dataprep/weatherderivedatehourrange.png)

   Введите в первой строке `Jan 01, 2015 12AM-2AM` в качестве образца и нажмите клавишу **ВВОД**.

   Workbench определяет преобразование на основе предоставленного вами образца. В этом примере результатом является изменение формата даты и ее сцепление с двухчасовым интервалом времени.

   ![Изображение образца `Jan 01, 2015 12AM-2AM](media/tutorial-bikeshare-dataprep/wetherdatehourrangeexample.png)


8. Подождите, пока состояние изменится с **Анализ данных** на **Review next suggested row** (Проверка следующей предлагаемой строки). Это может занять несколько секунд. Выберите ссылку состояния, чтобы перейти к предлагаемой строке. 

   ![Изображение строки, предлагаемой для проверки](media/tutorial-bikeshare-dataprep/wetherdatehourrangedisambiguate.png)

   Строка имеет значение NULL, так как исходное значение даты может быть представлено как в формате дд/мм/гггг, так и в формате мм/дд/гггг. Введите правильное значение `Jan 13, 2015 2AM-4AM` и нажмите **ВВОД**. Workbench использует два образца, чтобы расширить возможности извлечения для оставшихся строк.

   ![Экран с данными в надлежащем формате](media/tutorial-bikeshare-dataprep/wetherdatehourrangedisambiguated.png)

9. Нажмите **ОК**, чтобы принять преобразование.

   ![Изображение сетки завершенного преобразования](media/tutorial-bikeshare-dataprep/weatherdatehourrangecomputed.png)

   > [!TIP]
   > Для этого шага можно использовать расширенный режим параметра **Derive column by example** (Получение столбца по образцу), нажав стрелку вниз в области **Шаги**. В сетке данных есть флажки напротив имен столбцов **DATE\_1** и **Hour Range**. Снимите флажок рядом со столбцом **Hour Range**, чтобы узнать, как при этом изменяются выходные данные. При отсутствии столбца **Hour Range** в качестве входных данных **12AM-2AM** обрабатывается как константа и добавляется к производным значениям. Выберите **Отмена**, чтобы вернуться к основной сетке без применения изменений.

10. Чтобы переименовать столбец, дважды щелкните заголовок. Измените имя на **Date Hour Range** и нажмите клавишу **ВВОД**.

11. Одновременно выберите столбцы **DATE**, **DATE\_1**, **DATE\_2** и **Hour Range**. Щелкните правой кнопкой мыши и выберите **Удалить столбец**.

## <a name="summarize-data-mean"></a>Сведение данных (среднее значение)

На следующем этапе нужно вычислить итоговые значения для погодных условий, усреднив их для определенного интервала времени.

1. Выберите столбец **Date Hour Range** и нажмите **Вычисление итоговых значений** в меню **Преобразования**.

    ![Меню преобразований](media/tutorial-bikeshare-dataprep/weathersummarizemenu.png)

2. Для сведения данных перетаскивайте столбцы из сетки в нижней части страницы в области в верхних углах слева и справа. В области слева отображается текст **Drag columns here to group data** (Перетащите сюда столбцы для группирования данных). В области справа отображается текст **Drag columns here to summarize data** (Перетащите сюда столбцы для сведения данных). 

    Перетащите столбец **Date Hour Range** из сетки в нижнюю часть области слева. Перетащите **HOURLYDRYBULBTEMPF**, **HOURLYRelativeHumidity** и **HOURLYWindSpeed** в область справа. 

    В области справа выберите **Среднее** в качестве меры для **статистической обработки** каждого столбца. Щелкните **ОК**, чтобы завершить вычисление итоговых значений.

   ![Экран сводных данных](media/tutorial-bikeshare-dataprep/weathersummarize.png)

## <a name="transform-dataflow-using-script"></a>Преобразование потока данных с использованием скрипта

Изменив данные в числовых столбцах в диапазоне 0–1, можно быстро свести значения некоторых моделей. В настоящее время нет встроенных средств для универсального выполнения этого преобразования, но для этого можно использовать скрипт Python.

1. В меню **Преобразование** выберите **Transform Dataflow** (Преобразование потока данных).

2. В появившемся текстовом поле введите код ниже. Если вы использовали имена столбцов, код должен работать без изменений. Нужно написать простую логику нормализации минимальных и максимальных значений на Python.

    > [!WARNING]
    > Скрипт предполагает использование имен столбцов, которые применялись ранее в этом руководстве. Если у вас другие имена столбцов, измените их в скрипте.

   ```python
   maxVal = max(df["HOURLYDRYBULBTEMPF_Mean"])
   minVal = min(df["HOURLYDRYBULBTEMPF_Mean"])
   df["HOURLYDRYBULBTEMPF_Mean"] = (df["HOURLYDRYBULBTEMPF_Mean"]-minVal)/(maxVal-minVal)
   df.rename(columns={"HOURLYDRYBULBTEMPF_Mean":"N_DryBulbTemp"},inplace=True)

   maxVal = max(df["HOURLYRelativeHumidity_Mean"])
   minVal = min(df["HOURLYRelativeHumidity_Mean"])
   df["HOURLYRelativeHumidity_Mean"] = (df["HOURLYRelativeHumidity_Mean"]-minVal)/(maxVal-minVal)
   df.rename(columns={"HOURLYRelativeHumidity_Mean":"N_RelativeHumidity"},inplace=True)

   maxVal = max(df["HOURLYWindSpeed_Mean"])
   minVal = min(df["HOURLYWindSpeed_Mean"])
   df["HOURLYWindSpeed_Mean"] = (df["HOURLYWindSpeed_Mean"]-minVal)/(maxVal-minVal)
   df.rename(columns={"HOURLYWindSpeed_Mean":"N_WindSpeed"},inplace=True)

   df
   ```

    > [!TIP]
    > В результате скрипт Python должен вернуть `df`. Это значение используется для заполнения сетки.
    
    ![Диалоговое окно скрипта для преобразования потока данных](media/tutorial-bikeshare-dataprep/transformdataflowscript.png)

3. Нажмите кнопку __ОК__, чтобы использовать этот скрипт. Числовые столбцы в сетке теперь содержат значения в диапазоне 0–1.

    ![Сетка со значениями в диапазоне от 0 до 1](media/tutorial-bikeshare-dataprep/datagridwithdecimals.png)

Мы завершили подготовку данных погоды. Теперь подготовим данные поездок.

## <a name="load-trip-data"></a>Загрузка данных поездок

1. Чтобы импортировать файл `201701-hubway-tripdata.csv`, выполните инструкции в разделе [Создание источника данных](#newdatasource). При импорте используйте следующие параметры:

    * __Схема выборки.__ Выберите схему выборки **Full File** (Файл полностью) и активируйте пример. 
    * __Тип данных.__ Примите значения по умолчанию.

2. После импорта данных нажмите кнопку __Подготовка__, чтобы начать подготовку данных. Выберите существующий пакет **BikeShare Data Prep.dprep** и нажмите __ОК__.

    После этого **поток данных** добавляется в существующий файл **подготовки данных**. Новый файл не создается.

    ![Экран выбора существующего пакета](media/tutorial-bikeshare-dataprep/addjandatatodprep.png)

3. После загрузки сетки разверните __DATAFLOWS__. Теперь у вас есть два потока данных: **BostonWeather** и **201701-hubway-tripdata**. Выберите элемент **201701-hubway-tripdata**.

    ![Изображение элемента 201701-hubway-tripdata](media/tutorial-bikeshare-dataprep/twodfsindprep.png)

## <a name="use-map-inspector"></a>Использование инспектора карты

Для подготовки данных предусмотрен ряд полезных визуализаций под названием **Инспекторы** для строковых, числовых и географических данных. Они упрощают анализ данных и определение выбросов. Чтобы использовать инспектор карты, выполните инструкции ниже.

1. Одновременно выберите столбцы **start station latitude** и **start station longitude**. Щелкните правой кнопкой мыши один из столбцов, а затем выберите **Карта**.

    > [!TIP]
    > Для множественного выбора удерживайте нажатой клавишу __CTRL (Command ⌘ на компьютере Mac)__ и выберите заголовок каждого столбца.

    ![Экран визуализации карты](media/tutorial-bikeshare-dataprep/launchMapInspector.png)

2. Чтобы развернуть визуализацию карты, нажмите значок **Развернуть**. Чтобы карта помещалась в окне, выберите значок **E** в верхней левой части экрана визуализации.

    ![Развернутый экран](media/tutorial-bikeshare-dataprep/maximizedmap.png)

3. Нажмите кнопку **Свернуть**, чтобы вернуться к представлению сетки.

## <a name="use-column-statistics-inspector"></a>Использование инспектора статистики столбцов

Чтобы использовать инспектор статистики столбцов, щелкните правой кнопкой мыши столбец __tripduration__ и выберите __Column Statistics__ (Статистика по столбцам).

![Элемент статистики по столбцам](media/tutorial-bikeshare-dataprep/tripdurationcolstats.png)

После этого в область __INSPECTORS__ (Инспекторы) добавляется новая визуализация под названием __tripduration Statistics__.

![Экран инспектора tripduration Statistics](media/tutorial-bikeshare-dataprep/tripdurationcolstatsinwell.png)

> [!IMPORTANT]
> Максимальная длительности поездки — **961 814 минут**, что равняется приблизительно двум годам. Похоже, что в наборе данных присутствуют выбросы.

## <a name="use-histogram-inspector"></a>Использование инспектора гистограммы

Чтобы определить выбросы, щелкните правой кнопкой мыши столбец __tripduration__ и выберите __Гистограмма__.

![Инспектор гистограммы](media/tutorial-bikeshare-dataprep/tripdurationhistogram.png)

Гистограмма не слишком полезна, так как выбросы искажают граф.

## <a name="add-column-using-script"></a>Добавление столбца с помощью скрипта

1. Щелкните правой кнопкой мыши столбец **tripduration** и выберите **Add Column (Script)** (Добавление столбца (скрипт)).

    ![Экран меню Add Column (Script) (Добавление столбца (скрипт))](media/tutorial-bikeshare-dataprep/computecolscript.png)

2. В диалоговом окне __Add Column (Script)__ (Добавление столбца (скрипт)) используйте следующие значения:

    * __Имя нового столбца__: logtripduration.
    * __Insert this New Column After__ (Вставить новый столбец после): tripduration.
    * __New Column Code__ (Код нового столбца): `math.log(row.tripduration)`.
    * __Code Block Type__ (Тип блока кода): Expression (Выражение).

   ![Диалоговое окно Add Column (Script) (Добавление столбца (скрипт))](media/tutorial-bikeshare-dataprep/computecolscriptdialog.png)

3. Нажмите __ОК__, чтобы добавить столбец **logtripduration**.

4. Щелкните столбец правой кнопкой мыши и выберите **Гистограмма**.

    ![Гистограмма столбца logtripduration](media/tutorial-bikeshare-dataprep/logtriphistogram.png)

  Визуально эта гистограмма похожа на график нормального распределения с нестандартным окончанием.

## <a name="use-advanced-filter"></a>Использование расширенного фильтра

Применив к данным фильтр, можно добавить в инспектор новые данные распределения. Щелкните правой кнопкой мыши столбец **tripduration** и выберите **Фильтровать столбец**. В диалоговом окне __Изменить__ используйте следующие значения:

* __Filter this Number Column__ (Фильтрация этого числового столбца): logtripduration.
* __I Want To__ (Требуется): Keep Rows (Сохранить строки).
* __When__ (Условия применения): Any of the Conditions below are True (logical OR) (Любое указанное ниже условие имеет значение True (логическое ИЛИ)).
* __If this Column__ (Если значение в этом столбце): less than (меньше, чем).
* __The Value__ (Значение): 9.

![Параметры фильтра](media/tutorial-bikeshare-dataprep/loftripfilter.png)

Нажмите кнопку __ОК__, чтобы применить фильтр.

![Обновленные гистограммы после применения фильтра](media/tutorial-bikeshare-dataprep/loftripfilteredinspector.png)

### <a name="the-halo-effect"></a>Эффект нимба

1. Разверните гистограмму столбца **logtripduration**. На серую гистограмму накладывается голубая. Такое отображение называется **эффектом нимба**:

    * **Серая гистограмма** представляет распределение перед выполнением операции (в нашем случае фильтрации).
    * **Голубая гистограмма** представляет гистограмму после выполнения операции. 

   Эффект нимба помогает визуализировать воздействие операции на данные.

   ![Изображение гистограммы с эффектом нимба](media/tutorial-bikeshare-dataprep/loftripfilteredinspectormaximized.png)

    > [!NOTE]
    > Обратите внимание, что голубая гистограмма короче предыдущей. Это происходит из-за автоматического повторного группирования данных в новом диапазоне.

2. Чтобы удалить нимб, выберите __Изменить__ и снимите флажок __Show halo__ (Показать нимб).

    ![Параметры гистограммы](media/tutorial-bikeshare-dataprep/uncheckhalo.png)

3. Нажмите **ОК**, чтобы отключить эффект нимба, и сверните гистограмму.

### <a name="remove-columns"></a>Удаление столбцов

В данных поездок каждая строка представляет событие поездки на велосипеде. Для этого руководства требуются только столбцы **starttime** и **start station id**. Удалите другие столбцы.Для этого одновременно выберите эти два столбца, щелкните правой кнопкой мыши заголовок столбца и выберите **Сохранить столбец**. Остальные столбцы будут удалены.

![Изображение параметра сохранения столбца](media/tutorial-bikeshare-dataprep/tripdatakeepcolumn.png)

### <a name="summarize-data-count"></a>Сведение данных (количество)

Чтобы вычислить итоговые значения для спроса на велосипеды в течение 2 часов, используйте производные столбцы.

1. Щелкните правой кнопкой мыши столбец **starttime** и выберите **Derive Column by Example** (Получение столбца по образцу).

    ![Изображение параметра получения по образцу](media/tutorial-bikeshare-dataprep/tripdataderivebyexample.png)

2. Чтобы создать образец, введите в первую строку значение `Jan 01, 2017 12AM-2AM`.

    > [!IMPORTANT]
    > В предыдущем примере получения столбцов выполнялось несколько шагов для получения столбца с датой и интервалом времени. В этом примере видно, что такая операция может быть выполнена как один шаг. Для этого нужно предоставить образец конечного результата.

    > [!NOTE]
    > Можно предоставить образец для любых строк. В этом образце значение `Jan 01, 2017 12AM-2AM` является допустимым для первой строки данных.

    ![Экран данных образца](media/tutorial-bikeshare-dataprep/tripdataderivebyexamplefirstexample.png)
   
3. Подождите, пока приложение вычислит значения для всех строк. Это может занять несколько секунд. По завершении анализа воспользуйтесь ссылкой __Review next suggested row__ (Проверка следующей предлагаемой строки), чтобы проверить данные.

   ![Экран выполненного анализа со ссылкой на просмотр](media/tutorial-bikeshare-dataprep/tripdatabyexanalysiscomplete.png)

    Убедитесь, что рассчитанные значения верны. Если нет, замените значение ожидаемым и нажмите клавишу ВВОД. Дождитесь завершения анализа. Выполняйте процесс **Review next suggested row** (Проверка следующей предлагаемой строки), пока не отобразится запись **No suggestions** (Предложения отсутствуют). Когда отображается запись **No suggestion** (Предложения отсутствуют), это значит, что в приложении проанализированы пограничные случаи и синтезированная программа определена как удовлетворительная. Прежде чем принять преобразование, рекомендуем визуально проверить преобразованные данные. 

4. Нажмите **ОК**, чтобы принять преобразование. Переименуйте созданный столбец в **Date Hour Range**.

    ![Изображение переименованного столбца](media/tutorial-bikeshare-dataprep/tripdatasummarize.png)

5. Щелкните правой кнопкой мыши заголовок столбца **starttime** и выберите **Удалить столбец**.

6. Для сведения данных выберите __Вычисление итоговых значений__ в меню __Преобразование__. Чтобы создать преобразование, выполните следующие действия:

    * Перетащите столбцы __Date Hour Range__ и __start station id__ в область слева (для группирования).
    * Перетащите столбец __start station id__ в область справа (для сведения данных).

   ![Экран с параметрами сведения данных](media/tutorial-bikeshare-dataprep/tripdatacount.png)

7. Нажмите **ОК**, чтобы принять сводный результат.

## <a name="join-dataflows"></a>Соединение потоков данных

Чтобы соединить сведения о погоде с данными поездок, выполните следующие действия:

1. Выберите __Соединить__ в меню __Преобразования__.

2. __Таблицы.__ Выберите **BostonWeather** для потока данных слева и **201701-hubway-tripdata** для потока данных справа. Нажмите кнопку **Далее**, чтобы продолжить.

    ![Экран выбора таблиц](media/tutorial-bikeshare-dataprep/jointableselection.png)

3. __Ключевые столбцы.__ Выберите столбец **Date Hour Range** в обеих таблицах. Затем нажмите __Далее__.

    ![Экран соединения ключевых столбцов](media/tutorial-bikeshare-dataprep/joinkeyselection.png)

4. __Тип соединения.__ Выберите для типа соединения __Matching rows__ (Совпадающие строки) и нажмите __Готово__.

    ![Тип соединения по совпадающим строкам](media/tutorial-bikeshare-dataprep/joinscreen.png)

    После этого создается поток данных с именем __Join Result__.

## <a name="create-additional-features"></a>Создание дополнительных функций

1. Чтобы создать столбец, который содержит дни недели, щелкните правой кнопкой мыши столбец **Date Hour Range** и выберите **Derive column by Example** (Получение столбца по образцу). Используйте значение __Sun__ для даты, которая наступает в воскресенье. Например, **Jan 01, 2017 12AM-2AM**. Нажмите клавишу **ВВОД**, а затем — кнопку **ОК**. Переименуйте этот столбец в __MonthCalendar__.

    ![Экран создания столбца, который содержит день недели](media/tutorial-bikeshare-dataprep/featureweekday.png)

2. Чтобы создать столбец, который содержит интервал времени для строки, щелкните правой кнопкой мыши столбец **Date Hour Range** и выберите **Derive column by Example** (Получение столбца по образцу). Используйте значение **12AM-2AM** для строки, в которой содержится значение **Jan 01, 2017 12AM-2AM**. Нажмите клавишу **ВВОД**, а затем — кнопку **ОК**. Переименуйте этот столбец в **Period**.

    ![Изображение столбца Period](media/tutorial-bikeshare-dataprep/featurehourrange.png)

3. Чтобы удалить столбцы **Date Hour Range** и **rDate Hour Range**, нажмите клавишу **CTRL (Command ⌘ на компьютере Mac)** и выберите заголовок каждого столбца. Щелкните правой кнопкой мыши и выберите **Удалить столбец**.

## <a name="read-data-from-python"></a>Считывание данных из Python

Можно запустить пакет подготовки данных из Python или PySpark и получить результаты в виде **кадра данных**.

Чтобы создать пример скрипта Python, щелкните правой кнопкой мыши __BikeShare Data Prep__ и выберите __Generate Data Access Code File__ (Создать файл с кодом для доступа к данным). Пример файла Python создается в вашей **папке проекта** и загружается на вкладку в Workbench. Следующий скрипт Python является примером создаваемого кода:

```python
# Use the Azure Machine Learning data preparation package
from azureml.dataprep import package

# Use the Azure Machine Learning data collector to log various metrics
from azureml.logging import get_azureml_logger
logger = get_azureml_logger()

# This call will load the referenced package and return a DataFrame.
# If run in a PySpark environment, this call returns a
# Spark DataFrame. If not, it will return a Pandas DataFrame.
df = package.run('BikeShare Data Prep.dprep', dataflow_idx=0)

# Remove this line and add code that uses the DataFrame
df.head(10)
```

В этом руководстве имя файла — `BikeShare Data Prep.py`. Этот файл будет использоваться далее в руководстве.

## <a name="save-test-data-as-a-csv-file"></a>Сохранение тестовых данных в CSV-файл

Чтобы сохранить поток данных **Join Result** в CSV-файл необходимо изменить скрипт `BikeShare Data Prep.py`. Обновите скрипт Python, добавив следующий код:

```python
from azureml.dataprep.package import run

# dataflow_idx=2 sets the dataflow to the 3rd dataflow (the index starts at 0), the Join Result.
df = run('BikeShare Data Prep.dprep', dataflow_idx=2)

# Example file path: C:\\Users\\Jayaram\\BikeDataOut\\BikeShareTest.csv
df.to_csv('Your Test Data File Path here')
```

В верхней части экрана выберите **Выполнить**. Скрипт отправляется на локальный компьютер как **задание**. Когда состояние задания изменяется на __Завершено__, это означает, что файл записан в указанное расположение.

## <a name="substitute-data-sources"></a>Источники данных для замены

В предыдущих шагах для подготовки тестовых данных мы использовали источники данных `201701-hubway-tripdata.csv` и `BostonWeather.csv`. Чтобы использовать пакет с другими файлами данных поездок, выполните описанные ниже действия.

1. Создайте **источник данных**, выполнив инструкции, представленные ранее, со следующими изменениями процесса:

    * __Выбор файла.__ Одновременно выберите шесть оставшихся CSV-файлов с данными поездок.

        ![Загрузите шесть оставшихся файлов](media/tutorial-bikeshare-dataprep/selectsixfiles.png)

        > [!NOTE]
        > Запись __+5__ указывает на наличие пяти дополнительных файлов, кроме того, который указан.

    * __Сведения о файле.__ Задайте для параметра __Promote Headers Mode__ (Режим повышения уровня для заголовков) значение **All Files Have The Same Headers** (Для всех файлов используются одинаковые заголовки). Это значение указывает на то, что все файлы содержат одинаковые заголовки.

        ![Выбор сведений о файле](media/tutorial-bikeshare-dataprep/headerfromeachfile.png) 

   Сохраните имя этого источника данных, так как он будет использоваться в последующих шагах.

2. Выберите значок папки, чтобы просмотреть файлы в проекте. Разверните каталог __aml\_config__ и выберите файл `local.runconfig`.

    ![Расположение файла local.runconfig](media/tutorial-bikeshare-dataprep/localrunconfig.png) 

3. Добавьте строки ниже в конец файла `local.runconfig` и нажмите значок дискеты, чтобы сохранить файл.

    ```yaml
    DataSourceSubstitutions:
      201701-hubway-tripdata.dsource: 201501-hubway-tripdata.dsource
    ```

    При этом изменении исходный источник данных заменяется источником, который содержит шесть файлов с данными поездок.

## <a name="save-training-data-as-a-csv-file"></a>Сохранение данных для обучения в файл CSV

Перейдите к файлу Python `BikeShare Data Prep.py`, который вы изменили ранее, и укажите другой путь к файлу, чтобы сохранить данные для обучения.

```python
from azureml.dataprep.package import run
# dataflow_idx=2 sets the dataflow to the 3rd dataflow (the index starts at 0), the Join Result.
df = run('BikeShare Data Prep.dprep', dataflow_idx=2)

# Example file path: C:\\Users\\Jayaram\\BikeDataOut\\BikeShareTrain.csv
df.to_csv('Your Training Data File Path here')
```

Чтобы отправить новое задание, используйте значок **Выполнить** в верхней части страницы. **Задание** отправляется с новой конфигурацией. Выходные данные этого задания являются данными для обучения. При создании этих данных выполняются шаги по их подготовке, которые были созданы ранее. Выполнение задания может занять несколько минут.

## <a name="next-steps"></a>Дальнейшие действия
Мы завершили работу с руководством по подготовке данных для системы совместного использования велосипедов. В этом руководстве мы использовали службу "Машинное обучение Azure" (предварительная версия), чтобы научиться выполнять следующие задачи:
> [!div class="checklist"]
> * Интерактивная подготовка данных с помощью средства подготовки данных в службе "Машинное обучение Azure".
> * Импорт, преобразование и создание тестового набора данных.
> * Создание пакета подготовки данных.
> * Запуск пакета подготовки данных с использованием Python.
> * Создание набора данных для обучения с повторным использованием пакета подготовки данных для дополнительных входных файлов.

Далее ознакомьтесь с дополнительными сведениями о подготовке данных:
> [!div class="nextstepaction"]
> [Data preparation user guide](data-prep-user-guide.md) (Руководство пользователя по подготовке данных)
