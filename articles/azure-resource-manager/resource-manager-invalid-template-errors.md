---
title: Ошибки, связанные с недопустимым шаблоном Azure | Документация Майкрософт
description: Описывается, как устранить ошибки, связанные с недопустимым шаблоном.
services: azure-resource-manager
documentationcenter: ''
author: tfitzmac
manager: timlt
editor: ''
ms.service: azure-resource-manager
ms.workload: multiple
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: troubleshooting
ms.date: 03/08/2018
ms.author: tomfitz
ms.openlocfilehash: 59f07b9ba8116cb1a4b5ab50382d89d01a78853b
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
ms.locfileid: "34357696"
---
# <a name="resolve-errors-for-invalid-template"></a>Устранение ошибок, связанных с недопустимым шаблоном

В этой статье описывается, как устранить ошибки, связанные с недопустимым шаблоном.

## <a name="symptom"></a>Симптом

При развертывании шаблона появляется следующее сообщение об ошибке:

```
Code=InvalidTemplate
Message=<varies>
```

Сообщение об ошибке зависит от типа ошибки.

## <a name="cause"></a>Причина:

Эта ошибка может появиться в результате ошибок нескольких различных типов. Как правило, это синтаксические или структурные ошибки в шаблоне.

<a id="syntax-error" />

## <a name="solution-1---syntax-error"></a>Решение 1 — синтаксическая ошибка

Если появляется сообщение об ошибке, указывающее, что шаблону не удалось пройти аутентификацию, возможно, в нем есть синтаксическая ошибка.

```
Code=InvalidTemplate
Message=Deployment template validation failed
```

Такую ошибку легко допустить, так как выражения шаблонов могут быть сложными. Например, представленное ниже назначение имени для учетной записи хранения содержит один набор квадратных скобок, три функции, три набора круглых скобок, один набор одинарных кавычек и одно свойство.

```json
"name": "[concat('storage', uniqueString(resourceGroup().id))]",
```

Если вы не укажете соответствующий синтаксис, шаблон создаст значение, которое не будет соответствовать ожидаемому.

При получении сообщения об ошибке такого типа тщательно проверьте синтаксис выражения. Рекомендуется использовать редактор JSON, например [Visual Studio](vs-azure-tools-resource-groups-deployment-projects-create-deploy.md) или [Visual Studio Code](resource-manager-vs-code.md), в котором отображаются предупреждения о синтаксических ошибках.

<a id="incorrect-segment-lengths" />

## <a name="solution-2---incorrect-segment-lengths"></a>Решение 2 — неправильная длина сегментов

Шаблон также считается недопустимым, если имя ресурса указано в неправильном формате.

```
Code=InvalidTemplate
Message=Deployment template validation failed: 'The template resource {resource-name}'
for type {resource-type} has incorrect segment lengths.
```

Имя ресурса на корневом уровне должно содержать на один сегмент меньше, чем тип ресурса. Каждый сегмент разделяется косой чертой. В следующем примере тип содержит два сегмента, а имя — один. Так что это **допустимое имя**.

```json
{
  "type": "Microsoft.Web/serverfarms",
  "name": "myHostingPlanName",
  ...
}
```

В приведенном ниже примере указано **недопустимое имя** , так как оно содержит такое же количество сегментов, что и тип.

```json
{
  "type": "Microsoft.Web/serverfarms",
  "name": "appPlan/myHostingPlanName",
  ...
}
```

В случае дочерних ресурсов тип и имя должны содержать одинаковое количество сегментов. Это целесообразно, так как полное имя и тип дочернего элемента включает имя родительского элемента и его тип. Таким образом в полном имени на один сегмент меньше, чем в полном типе.

```json
"resources": [
    {
        "type": "Microsoft.KeyVault/vaults",
        "name": "contosokeyvault",
        ...
        "resources": [
            {
                "type": "secrets",
                "name": "appPassword",
                ...
            }
        ]
    }
]
```

Разобраться с правильной длиной сегментов сложно при использовании типов Resource Manager, которые применяются для поставщиков ресурсов. Например, для применения блокировки ресурсов на веб-сайте требуется тип с четырьмя сегментами. Поэтому имя содержит три сегмента:

```json
{
    "type": "Microsoft.Web/sites/providers/locks",
    "name": "[concat(variables('siteName'),'/Microsoft.Authorization/MySiteLock')]",
    ...
}
```

<a id="parameter-not-valid" />

## <a name="solution-3---parameter-is-not-valid"></a>Решение 3 — недопустимый параметр

Если указать недопустимое значение, то появится сообщение об ошибке, аналогичное приведенному ниже.

```
Code=InvalidTemplate;
Message=Deployment template validation failed: 'The provided value {parameter value}
for the template parameter {parameter name} is not valid. The parameter value is not
part of the allowed values
```

Внимательно проверьте допустимые значения в шаблоне и укажите одно из них во время развертывания. Дополнительные сведения о допустимых значениях параметров см. в статье [Раздел параметров в шаблонах Azure Resource Manager](resource-manager-templates-parameters.md).

<a id="too-many-resource-groups" />

## <a name="solution-4---too-many-target-resource-groups"></a>Решение 4 — слишком много целевых групп ресурсов

Если вы указали более пяти целевых групп ресурсов в одном развертывании, поступает это сообщение об ошибке. Рекомендуем консолидировать группы ресурсов в развертывании или развернуть некоторые шаблоны как отдельные развертывания. Дополнительные сведения см. в разделе [Развертывание ресурсов Azure в нескольких подписках или группах ресурсов](resource-manager-cross-resource-group-deployment.md).

<a id="circular-dependency" />

## <a name="solution-5---circular-dependency-detected"></a>Решение 5 — обнаружена циклическая зависимость

Эта ошибка возникает, когда ресурсы зависят друг от друга таким образом, что это не позволяет начать развертывание. Сочетание взаимозависимостей вынуждает два или более ресурсов ожидать другие ресурсы, которые также находятся в ожидании. Например, resource1 зависит от resource3, resource2 зависит от resource1, а resource3 зависит от resource2. Как правило, эту проблему можно устранить, удалив ненужные зависимости.

Устранить циклическую зависимость можно следующим образом.

1. Найдите в шаблоне ресурс, указанный в циклической зависимости. 
2. Изучите свойство **dependsOn** и все случаи использования функции **reference** для этого ресурса, чтобы узнать, от каких ресурсов он зависит. 
3. Изучите эти ресурсы, чтобы узнать, от каких ресурсов зависят они. Отслеживайте зависимости, пока не найдете ресурс, который зависит от первоначального ресурса.
5. Для ресурсов, участвующих в циклической зависимости, тщательно изучите все случаи использования свойства **dependsOn**, чтобы выявить все лишние зависимости. Удалите эти зависимости. Если вы не уверены, нужна ли зависимость, попробуйте удалить ее. 
6. Повторно разверните шаблон.

Удаление значений из свойства **dependsOn** может привести к ошибкам при развертывании шаблона. Если возникла ошибка, верните удаленную зависимость в шаблон. 

Если этот подход не помог устранить циклическую зависимость, рекомендуется переместить часть логики развертывания в дочерние ресурсы (например, расширения или параметры конфигурации). Настройте эти дочерние ресурсы для развертывания после ресурсов, участвующих в циклической зависимости. Предположим, что вы развертываете две виртуальные машины, но на каждой из них необходимо задать свойства, которые ссылаются на другую виртуальную машину. Их можно развернуть в следующем порядке.

1. vm1.
2. vm2.
3. Расширение на vm1 зависит от vm1 и vm2. Расширение задает на vm1 значения, получаемые от vm2.
4. Расширение на vm2 зависит от vm1 и vm2. Расширение задает на vm2 значения, получаемые от vm1.

Этот подход пригоден и для приложений службы приложений. Рекомендуется переместить значения конфигурации в дочерний ресурс ресурса приложения. Два веб-приложения можно развернуть в следующем порядке.

1. webapp1.
2. webapp2.
3. Конфигурация webapp1 зависит от webapp1 и webapp2. Она содержит параметры приложения со значениями из webapp2.
4. Конфигурация webapp2 зависит от webapp1 и webapp2. Она содержит параметры приложения со значениями из webapp1.
