---
title: Создание образа виртуальной машины для Azure Marketplace | Документация Майкрософт
description: Подробные инструкции по созданию образа виртуальной машины для Azure Marketplace для приобретения другими пользователями.
services: Azure Marketplace
documentationcenter: ''
author: msmbaldwin
manager: mbaldwin
editor: ''
ms.assetid: 5c937b8e-e28d-4007-9fef-624046bca2ae
ms.service: marketplace
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: Azure
ms.workload: na
ms.date: 01/05/2017
ms.author: mbaldwin
ms.openlocfilehash: ad6d48a03575e8fabd7eed2ebc1f7926ec4559d4
ms.sourcegitcommit: 6cf20e87414dedd0d4f0ae644696151e728633b6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/06/2018
ms.locfileid: "34808746"
---
# <a name="guide-to-create-a-virtual-machine-image-for-the-azure-marketplace"></a>Руководство по созданию образа виртуальной машины для Azure Marketplace
Эта статья ( **шаг 2**) содержит инструкции по подготовке виртуальных жестких дисков (VHD), развертываемых в Azure Marketplace. Виртуальные жесткие диски являются основой номера SKU. Процесс подготовки будет отличаться в зависимости от типа номера SKU (на основе Linux или Windows). В этой статье рассматриваются оба сценария. Описываемую процедуру можно выполнять параллельно с [созданием учетной записи разработчика Майкрософт][link-acct-creation].

## <a name="1-define-offers-and-skus"></a>1. Определение предложений и номеров SKU
В этом разделе вы узнаете, как определять предложения и соответствующие номера SKU.

Предложение является «родительским» по отношению ко всем номерам SKU, из которых оно состоит. Вы можете создать несколько предложений. Вы сами можете решить, как структурировать свои предложения. Когда предложение переходит к стадии промежуточного хранения, вместе с ним переводятся все связанные с ним номера SKU. Тщательно продумайте идентификаторы SKU, так как они будут видимы в URL-адресе.

* Azure.com: http://azure.microsoft.com/marketplace/partners/{PartnerNamespace}/{OfferIdentifier}-{SKUidentifier}
* Портал предварительной версии Azure: https://portal.azure.com/#gallery/{PublisherNamespace}.{OfferIdentifier}{SKUIDdentifier}  

Номер SKU — это коммерческое название для образа виртуальной машины (VM). Образ VM содержит один диск операционной системы и от нуля до нескольких дисков данных. Он представляет собой полный профиль хранения для виртуальной машины. Для одного диска требуется один VHD. VHD необходимо создавать даже для пустых дисков данных.

Вне зависимости от используемой операционной системы добавляйте минимальное количество дисков данных, необходимое для номера SKU. Ваши клиенты не смогут удалить диски, которые являлись частью образа на стадии развертывания, однако при необходимости всегда смогут добавить новые диски во время или после развертывания.

> [!IMPORTANT]
> **Не изменяйте число дисков в новой версии образа.** Если в образе необходимо перенастроить диски с данными, определите новый SKU. Публикация новой версии образа с другим числом дисков может привести к ошибке нового развертывания на основе новой версии образа в случае автоматического масштабирования, автоматического развертывания решений с помощью шаблонов ARM и других сценариев.
>
>

### <a name="11-add-an-offer"></a>1.1. Добавление предложения
1. Войдите на [портал публикации][link-pubportal], используя свою учетную запись продавца.
2. На портале публикации перейдите на вкладку **Виртуальные машины** . В поле для ввода укажите название предложения. Названием предложения обычно является название продукта (или службы), который вы планируете продавать в Azure Marketplace.
3. Нажмите кнопку **Создать**.

### <a name="12-define-a-sku"></a>1.2. Определение номера SKU
Добавив предложение, следует определить (идентифицировать) номера SKU. У вас может быть несколько предложений, и каждое из них может содержать несколько номеров SKU. Когда предложение переходит к стадии промежуточного хранения, вместе с ним переводятся все связанные с ним номера SKU.

1. **Добавьте номер SKU.** Для номера SKU необходим идентификатор, который используется в URL-адресе. Идентификатор должен быть уникальным в вашем профиле публикации. При этом риск совпадения идентификаторов с другими издателями отсутствует.

   > [!NOTE]
   > Предложение и идентификатор SKU будут отображаться в URL-адресе предложения в Marketplace.
   >
   >
2. **Добавьте сводное описание для номера SKU.** Описания предназначены для клиентов, поэтому рекомендуем составить текст так, чтобы он легко читался. Эти сведения не должны блокироваться до стадии «Переход к промежуточному хранению». До этого момента вы сможете их редактировать.
3. Если вы используете номера SKU для Windows, используйте предложенные ссылки, чтобы приобрести утвержденные версии Windows Server.

## <a name="2-create-an-azure-compatible-vhd-linux-based"></a>2. Создание виртуального жесткого диска, совместимого с Azure (для Linux)
В следующем разделе приводятся рекомендации по созданию образа виртуальной машины Linux для Azure Marketplace. Пошаговое руководство см. в статье о [создании настраиваемого образа виртуальной машины Linux](../virtual-machines/linux/create-upload-generic.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

## <a name="3-create-an-azure-compatible-vhd-windows-based"></a>3. Создание виртуального жесткого диска, совместимого с Azure (на основе Windows)
Следующий раздел содержит шаги по созданию номера SKU на основе Windows Server для Azure Marketplace.

### <a name="31-ensure-that-you-are-using-the-correct-base-vhds"></a>3.1. Убедитесь, что вы используете подходящие базовые диски VHD
Виртуальный жесткий диск с ОС для вашего образа виртуальной машины должен быть основан на базовом образе, одобренном для Azure и содержащем Windows Server или SQL Server.

Для начала создайте виртуальную машину из одного из следующих образов, расположенных на [портале Microsoft Azure][link-azure-portal]:

* Windows Server ([2012 R2 Datacenter][link-datactr-2012-r2], [2012 Datacenter][link-datactr-2012], [2008 R2 SP1][link-datactr-2008-r2]);
* SQL Server 2014 ([Enterprise][link-sql-2014-ent], [Standard][link-sql-2014-std], [Web][link-sql-2014-web]);
* SQL Server 2012 SP2 ([Enterprise][link-sql-2012-ent], [Standard][link-sql-2012-std], [Web][link-sql-2012-web]).

Эти ссылки можно найти также на портале для публикаций на странице номера SKU.

> [!TIP]
> Если вы используете текущую версию портала Azure или PowerShell, используйте образы Windows Server, опубликованные 8 сентября 2014 г. или позднее, одобренные для Azure.
>
>

### <a name="32-create-your-windows-based-vm"></a>3.2. Создайте виртуальную машину Windows
Используя портал Microsoft Azure, вы можете создать виртуальную машину на основе одобренного базового образа всего за несколько простых шагов. Ниже приведен обзор этого процесса.

1. На странице базового образа нажмите кнопку **Создать виртуальную машину**, чтобы перейти на новый [портал Microsoft Azure][link-azure-portal].

    ![рисунок][img-acom-1]
2. Войдите на портал, используя учетную запись Майкрософт и пароль подписки Azure, которую вы хотите использовать.
3. Следуйте инструкциям на экране, чтобы создать VM с помощью выбранного базового образа. Вам потребуется указать имя узла (компьютера), имя пользователя (зарегистрированного как администратор), а также пароль для виртуальной машины.

    ![рисунок][img-portal-vm-create]
4. Выберите размер виртуальной машины для развертывания.

    a.    Если вы планируете локальную разработку VHD, размер не имеет значения. Мы рекомендуем использовать виртуальные машины небольшого размера.

    Б.    Если вы планируете разработку образа в среде Azure, лучше использовать один из рекомендуемых размеров виртуальной машины для выбранного образа.

    В.    С ценами можно ознакомиться в разделе **Рекомендуемые ценовые категории** на портале. В этом разделе можно найти три рекомендуемых размера, предоставленных издателем (в данном случае издателем является Майкрософт).

    ![рисунок][img-portal-vm-size]
5. Задайте свойства.

    a.    Для быстроты развертывания можно оставить значения по умолчанию для свойств в разделе **Необязательная конфигурация** и **Группа ресурсов**.

    Б.    Если нужно, в разделе **Учетная запись хранения**можно выбрать учетную запись хранения, в которой будет храниться VHD с операционной системой.

    c.    Если нужно, в разделе **Группа ресурсов**можно выбрать логическую группу, в которой будет размещена виртуальная машина.
6. Выберите **расположение** для развертывания.

    a.    Если вы планируете локальную разработку VHD, расположение не имеет значения, так как вы сможете загрузить образ в Azure позднее.

    Б.    Если вы планируете разработку образа в Azure, рекомендуем с самого начала использовать один из регионов Microsoft Azure в США. Это позволит ускорить копирование VHD, которое выполняет корпорация Майкрософт от вашего имени при отправке образа для сертификации.

    ![рисунок][img-portal-vm-location]
7. Нажмите кнопку **Создать**. Начнется развертывание виртуальной машины. Всего через несколько минут у вас появится успешно развернутая виртуальная машина и вы сможете начать создание образа для номера SKU.

### <a name="33-develop-your-vhd-in-the-cloud"></a>3.3. Разработка VHD в облаке
Мы настоятельно рекомендуем разрабатывать VHD в облаке, используя протокол удаленного рабочего стола (RDP). Подключение к удаленному рабочему столу будет осуществляться по протоколу RDP с именем пользователя и паролем, указанным при подготовке.

> [!IMPORTANT]
> **Не используйте управляемые диски.** Не следует создавать виртуальные машины, используемые для разработки VHD в облаке, на основе управляемых дисков, так как в настоящее время из них невозможно создать образ.
> Для управляемых дисков создание виртуальной машины в дополнительном компоненте изменяет их значение по умолчанию.

> В случае локальной разработки виртуального жесткого диска (мы не рекомендуем) см. статью [Локальная разработка образа виртуальной машины для Azure Marketplace](marketplace-publishing-vm-image-creation-on-premise.md). Загрузка VHD при разработке в облаке не является обязательной.
>
>

**Подключение по протоколу RDP через [портал Microsoft Azure][link-azure-portal]**

1. Выберите **Все службы** > **Виртуальные машины**.
2. Откроется колонка «Виртуальные машины». Убедитесь, что виртуальная машина, к которой вы хотите подключиться, запущена, и выберите ее из списка развернутых виртуальных машин.
3. Откроется колонка с описанием выбранной виртуальной машины. Щелкните **Подключить**в верхней части экрана.
4. Появится запрос на ввод имени пользователя и пароля, которые вы указали при подготовке.

**Подключение по протоколу RDP с помощью PowerShell**

Чтобы скачать файл удаленного рабочего стола на локальный компьютер, используйте [командлет Get-AzureRemoteDesktopFile][link-technet-2]. Чтобы использовать этот командлет, необходимо знать имя службы и имя виртуальной машины. Если вы создали виртуальную машину с помощью [портала Microsoft Azure][link-azure-portal], эти сведения можно найти в свойствах виртуальной машины.

1. На портале Microsoft Azure выберите **Все службы** > **Виртуальные машины**.
2. Откроется колонка «Виртуальные машины». Выберите развернутую виртуальную машину.
3. Откроется колонка с описанием выбранной виртуальной машины.
4. Щелкните **Свойства**.
5. Первая часть доменного имени является именем службы. Имя узла представляет собой имя виртуальной машины.

    ![рисунок][img-portal-vm-rdp]
6. Командлет для скачивания RDP-файла для созданной виртуальной машины на локальный компьютер администратора выглядит так:

        Get‐AzureRemoteDesktopFile ‐ServiceName “baseimagevm‐6820cq00” ‐Name “BaseImageVM” –LocalPath “C:\Users\Administrator\Desktop\BaseImageVM.rdp”

Дополнительные сведения об RDP можно найти на сайте MSDN в статье [Подключение к виртуальной машине Azure с помощью RDP или SSH](http://msdn.microsoft.com/library/azure/dn535788.aspx).

**Настройка виртуальной машины и создание номера SKU**

Скачав VHD с операционной системой, используйте клиент Hyper-V и настройте виртуальную машину, чтобы начать создание номера SKU. Подробные инструкции можно найти по следующей ссылке на сайт TechNet: [Установка Hyper-V и настройка виртуальной машины](http://technet.microsoft.com/library/hh846766.aspx).

### <a name="34-choose-the-correct-vhd-size"></a>3.4. Выбор правильного размера VHD
VHD с операционной системой Windows в образе виртуальной машины должен иметь фиксированный формат и размер 128 ГБ.  

Если физический размер меньше 128 ГБ, VHD необходимо разбить на части. Предоставляемые базовые образы Windows и SQL Server уже соответствуют этим требованиям. Не меняйте формат и размер полученного виртуального жесткого диска.  

Размер дисков данных может достигать 1 ТБ. Выбирая размер диска, помните, что конечные пользователи не смогут изменить размер виртуальных жестких дисков в образе во время развертывания. Виртуальные жесткие диски для дисков данных должны создаваться в фиксированном формате. Тем не менее их также следует разбивать на части. Диски данных могут быть пустыми или содержать данные.

### <a name="35-install-the-latest-windows-patches"></a>3.5. Установка последних исправлений Windows
Базовые образы содержат последние исправления вплоть до даты публикации. Перед публикацией созданного VHD с операционной системой убедитесь, что Центр обновления Windows запущен и установлены последние критические и важные обновления безопасности.

### <a name="36-perform-additional-configuration-and-schedule-tasks-as-necessary"></a>3.6. Выполнение дополнительной настройки и задание расписания для выполнения задач по мере необходимости
Если необходима дополнительная настройка, попробуйте использовать запланированную задачу, которая сработает при запуске и внесет последние изменения в виртуальную машину сразу после ее развертывания.

* Лучше всего настроить самостоятельное удаление задачи после ее успешного выполнения.
* Ни одна из конфигураций не должна использовать диски, отличные от C или D, так как это единственные два диска, наличие которых гарантировано. Диск C служит для размещения операционной системы, а диск D является временным локальным диском.

### <a name="37-generalize-the-image"></a>3.7. Подготовка образа
Все образы в Azure Marketplace должны быть доступны для повторного использования в первоначальном виде. Другими словами, VHD с операционной системой необходимо подготовить.

* Для Windows образ должен быть подготовлен таким образом, чтобы все конфигурации поддерживали команду **sysprep** .
* Вы можете запустить следующую команду из каталога %windir%\System32\Sysprep.

        sysprep.exe /generalize /oobe /shutdown

  Рекомендации по подготовке операционной системы к использованию команды sysprep приведены на шаге 1 статьи MSDN [Создание и передача виртуального жесткого диска Windows Server в Azure](../virtual-machines/windows/classic/createupload-vhd.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).

## <a name="4-deploy-a-vm-from-your-vhds"></a>4. Развертывание виртуальной машины из дисков VHD
Передав виртуальные жесткие диски (подготовленный VHD с ОС и от нуля до нескольких VHD данных) в учетную запись хранения Azure, их можно зарегистрировать как пользовательский образ виртуальной машины. Затем можно приступать к тестированию образа. Обратите внимание: так как VHD с ОС является подготовленным, вы не можете напрямую развертывать виртуальную машину, указав URL-адрес этого VHD.

Дополнительные сведения об образах виртуальных машин см. в следующих публикациях блога.

* [Образ виртуальной машины](https://azure.microsoft.com/blog/vm-image-blog-post/)
* [Способы использования PowerShell при работе с образами виртуальных машин](https://azure.microsoft.com/blog/vm-image-powershell-how-to-blog-post/)
* [Образы виртуальных машин в Azure](https://msdn.microsoft.com/library/azure/dn790290.aspx)

### <a name="set-up-the-necessary-tools-powershell-and-azure-cli"></a>Настройка необходимых средств, PowerShell и Azure CLI
* [Приступая к работе с командлетами Azure PowerShell](/powershell/azure/overview)
* [Установка Azure CLI](../cli-install-nodejs.md)

### <a name="41-create-a-user-vm-image"></a>4.1. Создание пользовательского образа виртуальной машины
#### <a name="capture-vm"></a>Запись виртуальной машины
Рекомендации по записи виртуальной машины с помощью API, PowerShell или Azure CLI см. в следующих источниках.

* [API](https://msdn.microsoft.com/library/mt163560.aspx)
* [PowerShell](../virtual-machines/windows/capture-image.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [интерфейс командной строки Azure](../virtual-machines/linux/capture-image.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

### <a name="generalize-image"></a>Подготовка образа
Рекомендации по записи виртуальной машины с помощью API, PowerShell или Azure CLI см. в следующих источниках.

* [API](https://msdn.microsoft.com/library/mt269439.aspx)
* [PowerShell](../virtual-machines/windows/capture-image.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)
* [интерфейс командной строки Azure](../virtual-machines/linux/capture-image.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

### <a name="42-deploy-a-vm-from-a-user-vm-image"></a>4.2 Развертывание виртуальной машины из пользовательского образа VM
Чтобы развернуть виртуальную машину из пользовательского образа VM, можно использовать текущую версию [портала Azure](https://manage.windowsazure.com) или PowerShell.

**Развертывание виртуальной машины с помощью текущей версии портала Azure**

1. Выберите **Создать** > **Среда выполнения приложений** > **Виртуальная машина** > **Из коллекции**.

2. Перейдите в раздел **Мои образы**и выберите образ виртуальной машины, из которого следует выполнить развертывание виртуальной машины.

   1. Обратите особое внимание на то, какой образ вы выбираете, так как представление **Мои образы** содержит как образы операционных систем, так и образы виртуальных машин.
   2. Указанное количество дисков поможет определить тип развертываемого образа, так как большинство образов виртуальных машин будут иметь более одного диска. Кроме того, возможно использование образа виртуальной машины только с одним диском операционной системы. У такого образа параметр **Количество дисков** будет иметь значение 1.

      ![рисунок][img-manage-vm-select]
3. Следуйте инструкциям мастера создания VM и укажите имя виртуальной машины, ее размер, расположение, имя пользователя и пароль.

**Развертывание виртуальной машины из PowerShell**

Чтобы развернуть большую виртуальную машину из только что созданного подготовленного образа VM, можно использовать следующие командлеты:

    $img = Get-AzureVMImage -ImageName "myVMImage"
    $user = "user123"
    $pass = "adminPassword123"
    $myVM = New-AzureVMConfig -Name "VMImageVM" -InstanceSize "Large" -ImageName $img.ImageName | Add-AzureProvisioningConfig -Windows -AdminUsername $user -Password $pass
    New-AzureVM -ServiceName "VMImageCloudService" -VMs $myVM -Location "West US" -WaitForBoot

> [!IMPORTANT]
> Дополнительные сведения см. в статье [Как устранить распространенные неполадки, возникающие в процессе создания виртуального жесткого диска].
>
>

## <a name="5-obtain-certification-for-your-vm-image"></a>5. Получение сертификата для образа виртуальной машины
Следующий шаг при подготовке образа виртуальной машины для Azure Marketplace — это сертификация.

Этот процесс включает запуск специального средства сертификации, передачу результатов проверки в контейнер Azure с вашими дисками VHD, добавление предложения, определение номера SKU и отправку образа виртуальной машины для сертификации.

### <a name="51-download-and-run-the-certification-test-tool-for-azure-certified"></a>5.1. Загрузка и запуск средства проверки сертификации Azure
Средство сертификации будет работать на запущенной виртуальной машине, подготовленной на основе вашего пользовательского образа виртуальной машины. Оно позволит обеспечить совместимость образа виртуальной машины с Microsoft Azure. Оно позволит обеспечить совместимость образа виртуальной машины с Microsoft Azure. Средство проверит соответствие рекомендациям и требованиям, предъявляемым к подготовке диска VHD, и выдаст отчет о совместимости, который нужно будет передать на портал публикации при запросе сертификации.

Средство сертификации можно использовать с виртуальными машинами Windows и Linux. Оно подключается к виртуальным машинам Windows через PowerShell, а к виртуальным машинам Linux — через SSH.Net.

1. Сначала скачайте средство сертификации из [Центра загрузки Майкрософт][link-msft-download].
2. Откройте средство сертификации и нажмите кнопку **Начать новый тест** .
3. На экране **Сведения о проверке** введите имя для тестового запуска.
4. Выберите операционную систему для вашей виртуальной машины — Linux или Windows. В зависимости от выбранного варианта выберите последующие параметры.

### <a name="connect-the-certification-tool-to-a-linux-vm-image"></a>**Подключение средства сертификации к образу виртуальной машины Linux**
1. Выберите режим проверки подлинности SSH: пароль или файл ключа.
2. При использовании проверки подлинности на основе пароля введите DNS-имя, имя пользователя и пароль.
3. При использовании проверки подлинности с помощью файла ключа введите DNS-имя, имя пользователя и расположение закрытого ключа.

   ![Проверка пароля для образа виртуальной машины Linux][img-cert-vm-pswd-lnx]

   ![Проверка подлинности файла ключа для образа виртуальной машины Linux][img-cert-vm-key-lnx]

### <a name="connect-the-certification-tool-to-a-windows-based-vm-image"></a>**Подключение средства сертификации к образу виртуальной машины Windows**
1. Введите полное доменное имя виртуальной машины (например, MyVMName.ClOudapp.net).
2. Введите имя пользователя и пароль.

   ![Проверка пароля для образа виртуальной машины Windows][img-cert-vm-pswd-win]

Задав нужные параметры для образа виртуальной машины Linux или Windows, нажмите кнопку **Проверить подключение** , чтобы убедиться, что SSH.Net или PowerShell имеет допустимое подключение для тестирования. Когда подключение будет установлено, нажмите кнопку **Далее** , чтобы начать проверку.

После его завершения вы получите результаты («Пройден», «Не пройден» или «Предупреждение») для каждого проверяемого элемента.

![Тестовые случаи для образа виртуальной машины Linux][img-cert-vm-test-lnx]

![Тестовые случаи для образа виртуальной машины Windows][img-cert-vm-test-win]

Если хотя бы один из тестов не будет пройден, образ не будет сертифицирован. В этом случае изучите требования и внесите необходимые изменения.

После автоматической проверки вам будет предложено указать дополнительные входные данные для образа виртуальной машины на экране анкеты.  Ответьте на вопросы и нажмите кнопку **Далее**.

![Анкета средства сертификации][img-cert-vm-questionnaire]

![Анкета средства сертификации][img-cert-vm-questionnaire-2]

Заполнив анкету, можно указать дополнительные сведения, например данные для доступа по протоколу SSH для образа VM Linux, а также разъяснения для непройденных проверок. Вы можете скачать результаты проверки и файлы журналов выполненных проверок, а также свои ответы на вопросы анкеты. Сохраните результаты в том же контейнере, что и диски VHD.

![Сохранение результатов теста для сертификации][img-cert-vm-results]

### <a name="52-get-the-shared-access-signature-uri-for-your-vm-images"></a>5.2. Получение URI подписанного URL-адреса для образов виртуальных машин
Во время публикации необходимо будет указать URI всех виртуальных жестких дисков, созданных для вашего номера SKU. Майкрософт понадобится доступ к этим дискам во время сертификации. Таким образом, вам потребуется создать URI подписанного URL-адреса для каждого виртуального жесткого диска. Этот URI необходимо ввести на вкладке **Образы** портала публикации.

Созданный URI подписанного URL-адреса должен соответствовать следующим требованиям.

Обратите внимание: следующие инструкции применимы только для неуправляемых дисков, которые являются единственным поддерживаемым типом.

* Для создания URI подписанного URL-адреса для виртуальных жестких дисков достаточно разрешений на создание списков и на чтение. Не предоставляйте разрешения на запись или удаление.
* Продолжительность предоставляемого доступа должна составлять минимум три (3) недели с момента создания URI подписанного URL-адреса.
* Чтобы сохранить время в формате UTC, выберите дату начала за день до текущей даты. Например, если сегодня 6 октября 2014 г., выберите 05.10.2014.

Чтобы предоставить общий доступ к виртуальному жесткому диску в Azure Marketplace, URL-адрес SAS можно создать с помощью разных средств.
Рекомендуемые средства перечислены ниже.

1.  обозреватель хранилищ Azure
2.  Обозреватель хранилищ Microsoft Azure
3.  Инфраструктура CLI Azure

**Обозреватель хранилищ Azure (рекомендуется для пользователей Windows)**

Ниже перечислены шаги по созданию URL-адреса SAS с помощью обозревателя хранилищ Azure.

1. Скачайте [обозреватель хранилищ Azure версии 6 (предварительная версия 3)](https://azurestorageexplorer.codeplex.com/) на сайте CodePlex. Найдите [обозреватель хранилищ Azure версии 6 (предварительная версия 3)](https://azurestorageexplorer.codeplex.com/) и нажмите кнопку **скачивания**.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_01.png)

2. Скачайте и распакуйте файл [AzureStorageExplorer6Preview3.zip](https://azurestorageexplorer.codeplex.com/downloads/get/891668), а затем установите его.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_02.png)

3. После установки откройте приложение.
4. Щелкните **Добавить учетную запись**.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_03.png)

5. Укажите имя и ключ учетной записи хранения, а также домен конечных точек хранилища. Это учетная запись хранения в подписке Azure, где на портале Azure хранится виртуальный жесткий диск.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_04.png)

6. Когда обозреватель хранилищ Azure будет подключен к учетной записи хранения, в нем отобразится все содержимое, связанное с этой учетной записью. Выберите контейнер, в который вы скопировали VHD-файл с диском операционной системы (а также диски данных, если они используются в вашем сценарии).

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_05.png)

7. После выбора контейнера BLOB-объектов запустится обозреватель хранилищ Azure, в котором отобразятся файлы, содержащиеся в контейнере. Выберите файл образа (VHD), который необходимо отправить.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_06.png)

8.  Выбрав VHD-файл в контейнере, перейдите на вкладку **Безопасность** .

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_07.png)

9.  В диалоговом окне **Blob Container Security** (Безопасность контейнера больших двоичных объектов) на вкладке **Access Level** (Уровень доступа) оставьте значения по умолчанию и перейдите на вкладку **Shared Access Signatures** (Подписанные URL-адреса).

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_08.png)

10. Выполните следующие действия, чтобы создать URI подписанного URL-адреса для VHD-образа.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_09.png)

    a. **Access permitted from** (Доступ разрешен с). Чтобы сохранить время в формате UTC, выберите дату начала за день до текущей даты. Например, если сегодня 6 октября 2014 г., выберите 05.10.2014.

    Б. **Access permitted to** (Доступ разрешен до). Выберите дату, которая наступит через 3 недели после даты **Access permitted from** (Доступ разрешен с).

    c. **Actions permitted** (Разрешенные действия). Выберите разрешения на **создание списков** и **чтение**.

    d. Если VHD-файл выбран правильно, то ваш файл с расширением VHD отобразится рядом с **именем BLOB-объекта** .

    e. Щелкните **Создать подпись**.

    f. Проверьте содержимое поля **Созданный URI подписанного URL-адреса для контейнера**согласно следующим условиям.

       - URI должен включать имя файла образа и расширение **.vhd**.
       - В конце подписи должны быть символы **=rl**. Это показывает, что права на чтение и создание списков успешно предоставлены.
       - В середине подписи должны быть символы **sr=c**. Это означает, что у вас есть доступ на уровне контейнера.

11. Чтобы проверить работу созданного URI подписанного URL-адреса, щелкните **Проверить в браузере**. Должен начаться процесс загрузки.

12. Скопируйте URI подписанного URL-адреса. Этот код URI необходимо вставить на портал публикации.

13. Повторите шаги 6–10 для каждого виртуального жесткого диска в SKU.

**Обозреватель хранилищ Microsoft Azure (Windows/MAC/Linux)**

Ниже перечислены шаги по созданию URL-адреса SAS с помощью обозревателя хранилищ Microsoft Azure.

1.  Скачайте Обозреватель службы хранилища Azure с веб-сайта [http://storageexplorer.com/](http://storageexplorer.com/). Найдите [обозреватель хранилищ Microsoft Azure](http://storageexplorer.com/releasenotes.html) и нажмите кнопку **скачивания для Windows**.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_10.png)

2.  После установки откройте приложение.

3.  Щелкните **Добавить учетную запись**.

4.  Свяжите обозреватель хранилищ Microsoft Azure с подпиской, войдя в учетную запись.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_11.png)

5.  Перейдите к учетной записи хранения и выберите контейнер.

6.  Выберите **Get Shared Access Signature** (Получить подписанный URL-адрес), щелкнув **контейнер** правой кнопкой мыши.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_12.png)

7.  Обновите время начала, время окончания срока действия и разрешения, как показано ниже.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_13.png)

    a.  **Start Time** (Время начала). Чтобы сохранить время в формате UTC, выберите дату начала за день до текущей даты. Например, если сегодня 6 октября 2014 г., выберите 05.10.2014.

    Б.  **Expiry Time:** (Время окончания срока действия). Выберите дату, которая наступит через 3 недели после даты **Start Time** (Время начала).

    c.  **Permissions** (Разрешения). Выберите разрешения на **создание списков** и **чтение**.

8.  Скопируйте подписанный URL-адрес контейнера.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_14.png)

    URL-адрес SAS создается на уровне контейнера. Теперь нам нужно включить в него имя виртуального жесткого диска.

    Формат URL-адреса SAS на уровне контейнера:`https://testrg009.blob.core.windows.net/vhds?st=2016-04-22T23%3A05%3A00Z&se=2016-04-30T23%3A05%3A00Z&sp=rl&sv=2015-04-05&sr=c&sig=J3twCQZv4L4EurvugRW2klE2l2EFB9XyM6K9FkuVB58%3D`

    Вставьте имя виртуального жесткого диска в URL-адрес SAS после имени контейнера, как показано ниже `https://testrg009.blob.core.windows.net/vhds/<VHD NAME>?st=2016-04-22T23%3A05%3A00Z&se=2016-04-30T23%3A05%3A00Z&sp=rl&sv=2015-04-05&sr=c&sig=J3twCQZv4L4EurvugRW2klE2l2EFB9XyM6K9FkuVB58%3D`

    Пример:

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_15.png)

    TestRGVM201631920152.vhd — это имя VHD, следовательно, URL-адрес SAS для VHD будет таким: `https://testrg009.blob.core.windows.net/vhds/TestRGVM201631920152.vhd?st=2016-04-22T23%3A05%3A00Z&se=2016-04-30T23%3A05%3A00Z&sp=rl&sv=2015-04-05&sr=c&sig=J3twCQZv4L4EurvugRW2klE2l2EFB9XyM6K9FkuVB58%3D`

    - URI должен включать имя файла образа и расширение **.vhd**.
    - В середине подписи должны быть символы **sp=rl**. Это показывает, что права на чтение и создание списков успешно предоставлены.
    - В середине подписи должны быть символы **sr=c**. Это означает, что у вас есть доступ на уровне контейнера.

9.  Проверьте работу созданного URI подписанного URL-адреса в браузере. Должен начаться процесс скачивания.

10. Скопируйте URI подписанного URL-адреса. Этот код URI необходимо вставить на портал публикации.

11. Повторите эти шаги для каждого виртуального жесткого диска в номере SKU.

**Azure CLI (рекомендуется для непрерывной интеграции и интеграции со сторонними решениями)**

Ниже перечислены шаги по созданию URL-адреса SAS с помощью Azure CLI.

1.  Скачайте Microsoft Azure CLI [отсюда](https://azure.microsoft.com/en-in/documentation/articles/xplat-cli-install/). Также можно использовать ссылки для **[Windows](http://aka.ms/webpi-azure-cli)** и **[MAC OS](http://aka.ms/mac-azure-cli)**.

2.  Установите скачанные файлы.

3.  Создайте файл PowerShell (или другой исполняемый скрипт) со следующим кодом и сохраните его на локальном компьютере.

          $conn="DefaultEndpointsProtocol=https;AccountName=<StorageAccountName>;AccountKey=<Storage Account Key>"
          azure storage container list vhds -c $conn
          azure storage container sas create vhds rl <Permission End Date> -c $conn --start <Permission Start Date>  

    Обновите следующие параметры, упомянутые выше.

    a. **`<StorageAccountName>`**: укажите имя учетной записи хранения.

    Б. **`<Storage Account Key>`**: укажите ключ учетной записи хранения.

    c. **`<Permission Start Date>`**: чтобы сохранить время в формате UTC, выберите дату начала за день до текущей даты. Например, если сегодня 25 октября 2016 г., выберите значение 25.10.2016. Если используется Azure CLI версии 2.0 (команда az), укажите дату и время для дат начала и окончания, например 10-25-2016T00:00:00Z.

    d. **`<Permission End Date>`**: выберите дату, которая наступит через 3 недели после даты **Start Time** (Время начала). Нужно использовать значение **11.02.2016**. Если используется Azure CLI версии 2.0 (команда az), укажите дату и время для дат начала и окончания, например 11-02-2016T00:00:00Z.

    Ниже приведен пример кода после обновления нужных параметров.

          $conn="DefaultEndpointsProtocol=https;AccountName=st20151;AccountKey=<account-key>"
          azure storage container list vhds -c $conn
          azure storage container sas create vhds rl 11/02/2016 -c $conn --start 10/25/2016  

4.  Запустите редактор Powershell от имени администратора, а затем откройте файл из шага 3. Можно использовать любой редактор скриптов, доступный в вашей ОС.

5.  Выполните скрипт. Вы получите URL-адрес SAS для доступа на уровне контейнера.

    Ниже представлены выходные данные подписи SAS. Скопируйте выделенную часть в блокнот.

    ![рисунок](media/marketplace-publishing-vm-image-creation/img5.2_16.png)

6.  Теперь, когда вы получили URL-адрес SAS уровня контейнера, нужно включить в него имя виртуального жесткого диска.

    URL-адрес SAS уровня контейнера

    `https://st20151.blob.core.windows.net/vhds?st=2016-10-25T07%3A00%3A00Z&se=2016-11-02T07%3A00%3A00Z&sp=rl&sv=2015-12-11&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

7.  Вставьте имя виртуального жесткого диска в URL-адрес SAS после имени контейнера, как показано ниже `https://st20151.blob.core.windows.net/vhds/<VHDName>?st=2016-10-25T07%3A00%3A00Z&se=2016-11-02T07%3A00%3A00Z&sp=rl&sv=2015-12-11&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

    Пример:

    TestRGVM201631920152.vhd — это имя VHD, следовательно, URL-адрес SAS для VHD будет таким:

    `https://st20151.blob.core.windows.net/vhds/ TestRGVM201631920152.vhd?st=2016-10-25T07%3A00%3A00Z&se=2016-11-02T07%3A00%3A00Z&sp=rl&sv=2015-12-11&sr=c&sig=wnEw9RfVKeSmVgqDfsDvC9IHhis4x0fc9Hu%2FW4yvBxk%3D`

    - URI должен включать имя файла образа и расширение VHD.
    -   В середине подписи должны быть символы sp=rl. Это показывает, что права на чтение и создание списков успешно предоставлены.
    -   В середине подписи должны быть символы sr=c. Это означает, что у вас есть доступ на уровне контейнера.

8.  Проверьте работу созданного URI подписанного URL-адреса в браузере. Должен начаться процесс скачивания.

9.  Скопируйте URI подписанного URL-адреса. Этот код URI необходимо вставить на портал публикации.

10. Повторите эти шаги для каждого виртуального жесткого диска в номере SKU.


### <a name="53-provide-information-about-the-vm-image-and-request-certification-in-the-publishing-portal"></a>5.3. Указание сведений об образе виртуальной машины и запросите сертификацию на портале публикации
Создав предложение и номер SKU, нужно ввести сведения об образе, связанные с этим номером SKU.

1. Перейдите на [портал публикации][link-pubportal] и выполните вход с использованием своей учетной записи продавца.
2. Выберите вкладку **Образы виртуальных машин** .
3. Идентификатор вверху страницы является идентификатором предложения, а не идентификатором номера SKU.
4. Задайте свойства в разделе **номеров SKU** .
5. В разделе **Семейство операционных систем**выберите тип операционной системы, связанный с VHD операционной системы.
6. В поле **Операционная система** введите описание операционной системы. Рекомендуется использовать формат «Семейство ОС, тип, версия, обновления». Например, Windows Server Datacenter 2014 R2.
7. Выберите до шести рекомендуемых размеров виртуальных машин. Эти рекомендации будут отображаться для клиентов в колонке "Ценовая категория" на портале Azure, когда они примут решение приобрести и развернуть ваш образ. **Это всего лишь рекомендации. Клиент может выбрать любой размер виртуальной машины, который соответствует дискам, указанным в образе.**
8. Введите версию. В поле «Версия» указана семантическая версия для идентификации продукта и его обновлений.
   * Формат версии должен иметь вид X.Y.Z, где X, Y и Z являются целыми числами.
   * Образы в разных номерах SKU могут иметь различные основные и дополнительные версии.
   * Версии в номере SKU должны изменяться только пошагово, увеличивая версию исправления (Z из X.Y.Z).
9. В поле **URL-адрес VHD с ОС** введите URI подписанного URL-адреса, созданного для VHD с операционной системой.
10. Если с этим номером SKU связаны диски данных, выберите логический номер устройства (LUN), к которому должен подключаться этот диск при развертывании.
11. В поле **URL-адрес VHD LUN X** введите URI подписанного URL-адреса, созданного для первого VHD с данными.

    ![рисунок](media/marketplace-publishing-vm-image-creation/vm-image-pubportal-skus-3.png)


## <a name="common-sas-url-issues--fixes"></a>Распространенные проблемы с URL-адресом SAS и способы их устранения

|Проблема|Сообщение об ошибке|Исправление|Ссылка на документацию|
|---|---|---|---|
|Сбой при копировании образов: символ "?" не найден в URL-адресе SAS.|Ошибка: копирование образов. Не удалось скачать BLOB-объект с помощью указанного URI SAS.|Обновите URL-адрес SAS с помощью рекомендуемых средств.|[https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)|
|Сбой при копировании образов: параметры st и se отсутствуют в URL-адресе SAS.|Ошибка: копирование образов. Не удалось скачать BLOB-объект с помощью указанного URI SAS.|Обновите URL-адрес SAS, указав правильные даты начала и окончания срока действия.|[https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)|
|Сбой при копировании образов: параметр sp=rl отсутствует в URL-адресе SAS.|Ошибка: копирование образов. Не удалось скачать BLOB-объект с помощью указанного URI SAS.|Обновите URL-адрес SAS, указав разрешения на чтение и создание списка.|[https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)|
|Сбой при копировании образов: URL-адрес SAS в имени VHD-файла содержит пробелы.|Ошибка: копирование образов. Не удалось скачать BLOB-объект с помощью указанного URI SAS.|Обновите URL-адрес, удалив пробелы.|[https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)|
|Сбой при копировании образов: ошибка авторизации URL-адреса SAS.|Ошибка: копирование образов. Не удалось скачать BLOB-объект из-за ошибки авторизации.|Создайте URL-адрес SAS повторно.|[https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)|
|Сбой при копировании изображений означает, что параметры URL-адреса SAS "st" и "se" не имеют полной спецификации даты и времени|Ошибка: копирование образов. Не удалось загрузить большой двоичный объект из-за неправильного URL-адреса SAS |Параметры URL-адреса SAS даты начала и окончания ("st", "se") должны иметь полную спецификацию даты и времени, например 11-02-2017T00:00:00Z, а не только дату или сокращенную версию для времени. Этот сценарий можно встретить, используя Azure CLI версии 2.0 (команда az). Обязательно укажите полную спецификацию даты и времени и повторно создайте URL-адрес SAS.|[https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)|

## <a name="next-step"></a>Дальнейшие действия
Закончив с настройкой данных SKU, перейдите к статье [Завершение создания предложения с маркетинговыми материалами][link-pushstaging]. На этом шаге публикации следует указать маркетинговые сведения, цены и другую информацию, которую необходимо предоставить до **тестирования предложения виртуальной машины в промежуточной среде (шаг 3 )**. На этом шаге вы можете протестировать предложение виртуальной машины при различных сценариях использования, прежде чем развертывать его в Azure Marketplace для общего доступа и приобретения.  

## <a name="see-also"></a>См. также
* [Приступая к работе: как опубликовать предложение в Azure Marketplace](marketplace-publishing-getting-started.md)

[img-acom-1]:media/marketplace-publishing-vm-image-creation/vm-image-acom-datacenter.png
[img-portal-vm-size]:media/marketplace-publishing-vm-image-creation/vm-image-portal-size.png
[img-portal-vm-create]:media/marketplace-publishing-vm-image-creation/vm-image-portal-create-vm.png
[img-portal-vm-location]:media/marketplace-publishing-vm-image-creation/vm-image-portal-location.png
[img-portal-vm-rdp]:media/marketplace-publishing-vm-image-creation/vm-image-portal-rdp.png
[img-azstg-add]:media/marketplace-publishing-vm-image-creation/vm-image-storage-add.png
[img-manage-vm-new]:media/marketplace-publishing-vm-image-creation/vm-image-manage-new.png
[img-manage-vm-select]:media/marketplace-publishing-vm-image-creation/vm-image-manage-select.png
[img-cert-vm-key-lnx]:media/marketplace-publishing-vm-image-creation/vm-image-certification-keyfile-linux.png
[img-cert-vm-pswd-lnx]:media/marketplace-publishing-vm-image-creation/vm-image-certification-password-linux.png
[img-cert-vm-pswd-win]:media/marketplace-publishing-vm-image-creation/vm-image-certification-password-win.png
[img-cert-vm-test-lnx]:media/marketplace-publishing-vm-image-creation/vm-image-certification-test-sample-linux.png
[img-cert-vm-test-win]:media/marketplace-publishing-vm-image-creation/vm-image-certification-test-sample-win.png
[img-cert-vm-results]:media/marketplace-publishing-vm-image-creation/vm-image-certification-results.png
[img-cert-vm-questionnaire]:media/marketplace-publishing-vm-image-creation/vm-image-certification-questionnaire.png
[img-cert-vm-questionnaire-2]:media/marketplace-publishing-vm-image-creation/vm-image-certification-questionnaire-2.png
[img-pubportal-vm-skus]:media/marketplace-publishing-vm-image-creation/vm-image-pubportal-skus.png
[img-pubportal-vm-skus-2]:media/marketplace-publishing-vm-image-creation/vm-image-pubportal-skus-2.png

[link-pushstaging]:marketplace-publishing-push-to-staging.md
[link-github-waagent]:https://github.com/Azure/WALinuxAgent
[link-azure-codeplex]:https://azurestorageexplorer.codeplex.com/
[link-azure-2]:../storage/blobs/storage-dotnet-shared-access-signature-part-2.md
[link-azure-1]:../storage/common/storage-dotnet-shared-access-signature-part-1.md
[link-msft-download]:http://www.microsoft.com/download/details.aspx?id=44299
[link-technet-3]:https://technet.microsoft.com/library/hh846766.aspx
[link-technet-2]:https://msdn.microsoft.com/library/dn495261.aspx
[link-azure-portal]:https://portal.azure.com
[link-pubportal]:https://publish.windowsazure.com
[link-sql-2014-ent]:http://azure.microsoft.com/marketplace/partners/microsoft/sqlserver2014enterprisewindowsserver2012r2/
[link-sql-2014-std]:http://azure.microsoft.com/marketplace/partners/microsoft/sqlserver2014standardwindowsserver2012r2/
[link-sql-2014-web]:http://azure.microsoft.com/marketplace/partners/microsoft/sqlserver2014webwindowsserver2012r2/
[link-sql-2012-ent]:http://azure.microsoft.com/marketplace/partners/microsoft/sqlserver2012sp2enterprisewindowsserver2012/
[link-sql-2012-std]:http://azure.microsoft.com/marketplace/partners/microsoft/sqlserver2012sp2standardwindowsserver2012/
[link-sql-2012-web]:http://azure.microsoft.com/marketplace/partners/microsoft/sqlserver2012sp2webwindowsserver2012/
[link-datactr-2012-r2]:http://azure.microsoft.com/marketplace/partners/microsoft/windowsserver2012r2datacenter/
[link-datactr-2012]:http://azure.microsoft.com/marketplace/partners/microsoft/windowsserver2012datacenter/
[link-datactr-2008-r2]:http://azure.microsoft.com/marketplace/partners/microsoft/windowsserver2008r2sp1/
[link-acct-creation]:marketplace-publishing-accounts-creation-registration.md
[link-technet-1]:https://technet.microsoft.com/library/hh848454.aspx
[link-azure-vm-2]:./virtual-machines-linux-agent-user-guide/
[link-openssl]:https://www.openssl.org/
[link-intsvc]:http://www.microsoft.com/download/details.aspx?id=41554
[link-python]:https://www.python.org/
