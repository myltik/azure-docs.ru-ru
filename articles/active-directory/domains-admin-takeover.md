---
title: Смена неуправляемого каталога или теневого клиента администратором в Azure Active Directory | Документация Майкрософт
description: Узнайте, как выполнить смену доменного имени DNS в неуправляемом каталоге (теневом клиенте) в Azure Active Directory.
services: active-directory
documentationcenter: ''
author: curtand
manager: mtillman
editor: ''
ms.assetid: b9f01876-29d1-4ab8-8b74-04d43d532f4b
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 04/06/2017
ms.author: curtand
ms.reviewer: elkuzmen
ms.custom: it-pro
ms.openlocfilehash: cd11ea68f298395236abf83295b939462ba00964
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="take-over-an-unmanaged-directory-as-administrator-in-azure-active-directory"></a>Смена неуправляемого каталога от имени администратора в Azure Active Directory
В этой статье описывается два способа смены доменного имени DNS в неуправляемом каталоге в Azure Active Directory (Azure AD). Когда пользователь самостоятельно регистрируется в облачной службе, использующей Azure AD, он добавляется в неуправляемый каталог Azure AD на основе домена электронной почты. Дополнительные сведения о самостоятельной (или "вирусной") регистрации в службе см. в разделе [What is self-service signup for Azure Active Directory?]() (Что такое самостоятельная регистрация для Azure Active Directory?).

## <a name="decide-how-you-want-to-take-over-an-unmanaged-directory"></a>Выбор способа смены неуправляемого каталога
В процессе смены администратором можно подтвердить права владельца, как описано в статье [Краткое руководство. Добавление личного домена в Azure Active Directory](add-custom-domain.md). В следующем разделе возможности администрирования описываются более подробно, но если вкратце, то:

* При выполнении ["внутренней" смены администратором](#internal-admin-takeover) неуправляемого каталога Azure вас добавляют как глобального администратора неуправляемого каталога. Ни пользователи, ни домены, ни планы обслуживания не переносятся в другой каталог, где вы являетесь администратором.

* При выполнении ["внешней" смены администратором](#external-admin-takeover) неуправляемого каталога Azure вы добавляете доменное имя DNS неуправляемого каталога в свой управляемый каталог Azure. После добавления доменного имени в управляемом каталоге Azure создается сопоставление пользователей с ресурсами, чтобы пользователи могли продолжать обращаться к службам без прерываний. 

## <a name="internal-admin-takeover"></a>Внутренняя смена администратором

Некоторые продукты, включающие SharePoint и OneDrive, например Office 365, не поддерживают внешнюю смену. Если вы используете именно этот сценарий, или если вы являетесь администратором и хотите сменить неуправляемый или "теневой" клиент, созданный пользователями, которые использовали самостоятельную регистрацию, то можете это сделать с помощью внутренней смены администратором.

1. Создайте пользовательский контекст в неуправляемом клиенте, выполнив регистрацию, например, через Power BI. Для удобства в примере предполагается, что использован именно этот путь.

2. Откройте [сайт Power BI](https://powerbi.com) и выберите **Начать бесплатно**. Введите учетную запись пользователя, которая использует доменное имя организации, например `admin@fourthcoffee.xyz`. После ввода кода проверки на ваш адрес электронной почты должен прийти код подтверждения.

3. В сообщении электронной почты с подтверждением от Power BI выберите **Yes, that's me** (Да, это я).

4. Войдите в [Центр администрирования Office 365](https://portal.office.com/adminportal/Home), используя учетную запись пользователя Power BI. Вы получите сообщение, предлагающее вам **Become the Admin** (Стать администратором) доменного имени, которое уже было проверено в неуправляемом клиенте. Выберите **Yes, I want to be the admin** (Да, я хочу стать администратором).
  
  ![Первый снимок экрана для "Become the Admin" (Стать администратором)](./media/domains-admin-takeover/become-admin-first.png)
  
5. Добавьте запись типа TXT, чтобы подтвердить, что вы являетесь владельцем доменного имени **fourthcoffee.xyz** на сайте регистратора доменных имен. В данном примере это — GoDaddy.com.
  
  ![Добавление записи типа TXT для доменного имени](./media/domains-admin-takeover/become-admin-txt-record.png)

Когда записи типа TXT для DNS будут проверены на сайте регистратора доменных имен, вы сможете управлять клиентом Azure AD.

Если вы выполнили описанные выше шаги, то теперь вы являетесь глобальным администратором клиента Fourth Coffee в Office 365. Чтобы интегрировать доменное имя с другими службами Azure, можно удалить его из Office 365 и добавить в другой управляемый клиент в Azure.

### <a name="adding-the-domain-name-to-a-managed-tenant-in-azure-ad"></a>Добавление доменного имени в управляемый клиент в Azure AD 

1. Откройте [Центр администрирования Office 365](https://portal.office.com/adminportal/Home).
2. Выберите вкладку **Пользователи** и создайте учетную запись пользователя с именем, таким как *user@fourthcoffeexyz.onmicrosoft.com*, где не используется имя личного домена. 
3. Убедитесь, что у этой новой учетной записи пользователя есть права глобального администратора для клиента Azure AD.
4. В Центре администрирования Office 365 откройте вкладку **Домены**, выберите доменное имя и нажмите кнопку **Удалить**. 
  
  ![Удаление доменного имени из Office 365](./media/domains-admin-takeover/remove-domain-from-o365.png)
  
5. Если у вас есть пользователи или группы в Office 365, которые ссылаются на удаленное доменное имя, то их необходимо переименовать, используя домен .onmicrosoft.com. Если принудительно удалить доменное имя, то все пользователи переименовываются автоматически (в этом примере — на *user@fourthcoffeexyz.onmicrosoft.com*).
  
6. Войдите в [Центр администрирования Azure AD](https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview) с помощью учетной записи, которая является глобальным администратором для клиента Azure AD.
  
7. Выберите **Имена пользовательских доменов** и добавьте доменное имя. Вам потребуется ввести записи типа TXT для DNS, чтобы проверить принадлежность доменного имени. 
  
  ![Добавление домена в Azure AD](./media/domains-admin-takeover/add-domain-to-azure-ad.png)
  
> [!NOTE]
> Если доменное имя удаляется, то всем пользователям Power BI или службы Azure Rights Management, у которых есть лицензии, назначенные в клиенте Office 365, необходимо сохранить свои панели мониторинга. Они должны войти с помощью имени пользователя, такого как *user@fourthcoffeexyz.onmicrosoft.com*, а не *user@fourthcoffee.xyz*.

## <a name="external-admin-takeover"></a>Внешняя смена администратором

Если вы уже управляете клиентом с помощью служб Azure или Office 365, то вы не можете добавить имя личного домена, если оно уже проверено в другом клиенте Azure AD. Однако из управляемого клиента в Azure AD можно выполнить смену неуправляемого клиента в рамках внешней смены администратором. Общая процедура соответствует той, которая описана в статье [Краткое руководство. Добавление личного домена в Azure Active Directory](add-custom-domain.md).

Когда выполняется проверка принадлежности доменного имени, Azure AD удаляет доменное имя из неуправляемого клиента и перемещает его в существующий клиент. При внешней смене администратором неуправляемого каталога требуется выполнить тот же процесс проверки DNS с помощью записи TXT, как и при внутренней смене администратором. Разница заключается в том, что с доменным именем также переносятся следующие компоненты:

- Пользователи
- Подписки
- Назначения лицензий

### <a name="support-for-external-admin-takeover"></a>Поддержка внешней смены администратором
Внешняя смена администратором поддерживается следующими веб-службами:

- Power BI
- управление правами Azure;
- Exchange Online

Поддерживаемые планы обслуживания:

- Power BI (бесплатная версия);
- Power BI Pro;
- PowerApps (бесплатная версия);
- PowerFlow (бесплатная версия);
- RMS для частных лиц;
- Microsoft Stream;
- Dynamics 365 (бесплатная пробная версия).

Внешняя смена администратором не поддерживается для служб, которые имеют планы обслуживания, включающие SharePoint, OneDrive или Skype для бизнеса. Например, это может быть бесплатная подписка или SKU "Базовый" для Office. При необходимости можно воспользоваться параметром [**ForceTakeover**](#azure-ad-powershell-cmdlets-for-the-forcetakeover-option) для удаления доменного имени из неуправляемого клиента и его проверки в нужном клиенте. При использовании параметра ForceTakeover пользователи не перемещаются, и их доступ к подписке сохраняется. Перемещается только доменное имя. 

#### <a name="more-information-about-rms-for-individuals"></a>Дополнительные сведения о службе RMS для частных лиц

Что касается [RMS для частных лиц](/information-protection/understand-explore/rms-for-individuals), то для неуправляемого клиента, находящегося в том же регионе, что и принадлежащий вам клиент, автоматически созданный [ключ клиента Azure Information Protection](/information-protection/plan-design/plan-implement-tenant-key) и [шаблоны защиты по умолчанию](/information-protection/deploy-use/configure-usage-rights#rights-included-in-the-default-templates) перемещаются вместе с доменным именем. 

Ключ и шаблоны не перемещаются лишь в том случае, если неуправляемый клиент находится в другом регионе. Например, неуправляемый клиент находится в Европе, а ваш клиент находится в Северной Америке. 

Несмотря на то что RMS для частных лиц поддерживает проверку подлинности в Azure AD для получения доступа к защищенному содержимому, он не запрещает пользователям также защищать содержимое. Если пользователи защитили содержимое с помощью подписки RMS для частных лиц, а ключи и шаблоны не были перемещены, содержимое останется недоступным после получения прав администрирования доменом.    

### <a name="azure-ad-powershell-cmdlets-for-the-forcetakeover-option"></a>Командлеты Azure AD PowerShell для параметра ForceTakeover
Вы можете видеть эти командлеты, используемые в [примере PowerShell](#powershell-example).


Командлет | Использование 
------- | -------
`connect-msolservice` | При появлении запроса выполните вход в управляемый клиент.
`get-msoldomain` | Показывает доменные имена, связанные с текущим клиентом.
`new-msoldomain –name <domainname>` | Добавляет доменное имя в клиент как непроверенное (проверка DNS еще не была выполнена).
`get-msoldomain` | Доменное имя теперь включено в список доменных имен, связанных с управляемым клиентом, но указано как **непроверенное**.
`get-msoldomainverificationdns –Domainname <domainname> –Mode DnsTxtRecord` | Предоставляет сведения, которые можно поместить в новую запись типа TXT DNS для домена (MS=xxxxx). Проверка может выполняться не сразу, так как записи типа TXT требуется некоторое время на распространение. Поэтому подождите несколько минут, прежде чем применять параметр **-ForceTakeover**. 
`confirm-msoldomain –Domainname <domainname> –ForceTakeover Force` | <li>Если доменное имя по-прежнему не проверено, то можно применить параметр **-ForceTakeover**. Он проверяет, была ли создана запись типа TXT, и запускает процесс смены.<li>Параметр **-ForceTakeover** необходимо добавлять в командлет только в том случае, если выполняется принудительная внешняя смена администратором. Например, когда в неуправляемом клиенте есть службы Office 365, блокирующие смену.
`get-msoldomain` | Теперь в списке доменов доменное имя отображается как **проверенное**.

### <a name="powershell-example"></a>Пример PowerShell

1. Подключитесь к Azure AD, используя учетные данные, использованные в ответ на предложение самообслуживания:
  ````
    import-module MSOnline
    $msolcred = get-credential
    
    connect-msolservice -credential $msolcred
  ````
2. Получение списка доменов:
  
  ````
    Get-MsolDomain
  ````
3. Выполните командлет Get-MsolDomainVerificationDns для создания запроса защиты:
  ````
    Get-MsolDomainVerificationDns –DomainName *your_domain_name* –Mode DnsTxtRecord
  
    For example:
  
    Get-MsolDomainVerificationDns –DomainName contoso.com –Mode DnsTxtRecord
  ````

4. Скопируйте значение (запрос защиты), которое возвращает эта команда. Например: 
  ````
    MS=32DD01B82C05D27151EA9AE93C5890787F0E65D9
  ````
5. В пространстве общедоступных имен DNS создайте DNS-запись TXT, содержащую значение, скопированное на предыдущем шаге. Имя для данной записи — это имя родительского домена, поэтому при создании этой записи ресурса с помощью роли DNS из Windows Server оставьте поле "Имя записи" пустым и просто вставьте это значение в текстовое поле.
6. Выполните командлет Confirm-MsolDomain, чтобы подтвердить запрос защиты:
  
  ````
    Confirm-MsolEmailVerifiedDomain -DomainName *your_domain_name*
  ````
  
  Например: 
  
  ````
    Confirm-MsolEmailVerifiedDomain -DomainName contoso.com
  ````

Успешный запрос защиты возвращает строки без ошибок.

## <a name="next-steps"></a>Дополнительная информация
* [Добавление имени личного домена в Azure Active Directory](add-custom-domain.md)
* [Как установить и настроить Azure PowerShell](/powershell/azure/overview)
* [Azure PowerShell](/powershell/azure/overview)
* [Справка по командлетам Azure](/powershell/azure/get-started-azureps)
* [Set-MsolCompanySettings](/powershell/module/msonline/set-msolcompanysettings?view=azureadps-1.0)

<!--Image references-->
[1]: ./media/active-directory-self-service-signup/SelfServiceSignUpControls.png
