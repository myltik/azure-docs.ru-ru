---
title: Сервер Azure MFA со службами AD FS в Windows Server
description: В этой статье описывается, как начать работу с Многофакторной идентификацией Azure и AD FS в Windows Server 2012 R2 и Windows Server 2016.
services: multi-factor-authentication
ms.service: active-directory
ms.component: authentication
ms.topic: get-started-article
ms.date: 08/25/2017
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: richagi
ms.openlocfilehash: 4ed4db6fa2c712c0fd858815d89dd0094dd5cfbd
ms.sourcegitcommit: 870d372785ffa8ca46346f4dfe215f245931dae1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2018
ms.locfileid: "33868234"
---
# <a name="configure-azure-multi-factor-authentication-server-to-work-with-ad-fs-in-windows-server"></a>Настройка сервера Многофакторной идентификации Azure для работы с AD FS на платформе Windows Server

Если вы используете службы федерации Active Directory (AD FS) и хотите защитить облачные или локальные ресурсы, вы можете настроить сервер Многофакторной идентификации Azure для работы с AD FS. Эта конфигурация активирует двухфакторную проверку подлинности для важных конечных точек.

Эта статья содержит сведения об использовании сервера Многофакторной идентификации Azure с AD FS на платформе Windows Server 2012 R2 или Windows Server 2016. Дополнительные сведения см. в статье [Защита облачных и локальных ресурсов с помощью сервера Многофакторной идентификации Azure и AD FS 2.0](howto-mfaserver-adfs-2.md).

## <a name="secure-windows-server-ad-fs-with-azure-multi-factor-authentication-server"></a>Защита AD FS в Windows Server с помощью сервера Многофакторной идентификации Azure

Для установки сервера Многофакторной идентификации Azure вы можете выбрать один из следующих вариантов.

* Установка сервера Многофакторной идентификации Azure локально на том же сервере, на котором находятся службы AD FS.
* Установка адаптера Многофакторной идентификации Azure локально на сервере AD FS и установка сервера Многофакторной идентификации на другом компьютере.

Прежде чем начать, ознакомьтесь с приведенной ниже информацией.

* Вам не нужно устанавливать сервер Многофакторной идентификации Azure на сервере AD FS. Но необходимо установить адаптер Многофакторной идентификации для AD FS на сервере Windows Server 2012 R2 или Windows Server 2016, на котором работают службы федерации AD FS. Вы можете установить сервер на другом компьютере, если адаптер AD FS установлен отдельно на сервере федерации AD FS. Чтобы узнать, как установить адаптер отдельно, см. следующие процедуры.
* Если в вашей организации используется проверка подлинности с помощью текстового сообщения или мобильного приложения, строки, определенные в разделе "Параметры компании", содержат заполнитель <$*application_name*$> (имя приложения). На сервере MFA версии 7.1 вы можете указать имя приложения, которое заменит этот заполнитель. Если вы используете версию 7.0 или более раннюю, заменить автоматически этот заполнитель при использовании адаптера AD FS не получится. Для таких ранних версий при защите AD FS мы рекомендуем удалить этот заполнитель из соответствующих строк.
* Учетная запись, которую вы используете для входа, должна иметь права на создание групп безопасности в службе Active Directory.
* Мастер установки адаптера AD FS Многофакторной идентификации создает группу безопасности с именем PhoneFactor Admins в вашем экземпляре Active Directory, а затем добавляет учетную запись службы AD FS в эту группу. Убедитесь, что в контроллере домена создана группа PhoneFactor Admins и учетная запись службы AD FS является участником этой группы. При необходимости добавьте вручную учетную запись службы AD FS в группу PhoneFactor Admins в контроллере домена.
* Сведения об установке пакета SDK веб-службы с помощью пользовательского портала см. в статье [Развертывание пользовательского портала на сервере Многофакторной идентификации Azure](howto-mfaserver-deploy-userportal.md).

### <a name="install-azure-multi-factor-authentication-server-locally-on-the-ad-fs-server"></a>Установка сервера Многофакторной идентификации Azure локально на сервере, на котором находятся службы AD FS

1. Скачайте и установите сервер Многофакторной идентификации Azure на сервере AD FS. Сведения об установке см. в статье [Приступая к работе с сервером Многофакторной идентификации Azure](howto-mfaserver-deploy.md).
2. В консоли управления сервером Многофакторной идентификации Azure щелкните значок **AD FS**. Установите флажки **Разрешить регистрацию пользователей** и **Разрешить пользователям выбирать метод**.
3. Выберите дополнительные параметры, которые вы хотите указать для своей организации.
4. Щелкните **Установить AD FS-адаптер**.
   
   <center>![Облако](./media/howto-mfaserver-adfs-2012/server.png)</center>

5. Запрос на настройку Active Directory может отобразиться по двум причинам. Компьютер присоединен к домену, и в Active Directory не закончена настройка защиты подключений между адаптером AD FS и службой Многофакторной идентификации. Нажмите кнопку **Далее**, чтобы автоматически завершить настройку, или установите флажок **Пропустить автоматическую настройку Active Directory и настроить параметры вручную**. Нажмите кнопку **Далее**.
6. Запрос на настройку локальной группы может отобразиться по двум причинам. Компьютер не присоединен к домену, и в локальной группе не закончена настройка защиты подключений между адаптером AD FS и службой Многофакторной идентификации. Нажмите кнопку **Далее**, чтобы автоматически завершить настройку, или установите флажок **Пропустить автоматическую настройку локальной группы и настроить параметры вручную**. Нажмите кнопку **Далее**.
7. В мастере установки нажмите кнопку **Далее**. Сервер Многофакторной идентификации Azure создаст группу PhoneFactor Admins и добавит в эту группу учетную запись службы AD FS.
   <center>![Облако](./media/howto-mfaserver-adfs-2012/adapter.png)</center>
8. На странице **Запуск установщика** нажмите кнопку **Далее**.
9. В установщике адаптера Многофакторной идентификации AD FS нажмите кнопку **Далее**.
10. По завершении установки нажмите кнопку **Закрыть** .
11. После установки адаптера необходимо зарегистрировать его в AD FS. Откройте Windows PowerShell и выполните следующую команду:<br>
    `C:\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`
    <center>![Облако](./media/howto-mfaserver-adfs-2012/pshell.png)</center>
12. Чтобы использовать только что зарегистрированный адаптер, измените глобальную политику проверки подлинности в AD FS. В консоли управления AD FS откройте узел **Authentication Policies** (Политики проверки подлинности). В разделе **Многофакторная идентификация** щелкните ссылку **Изменить** рядом с разделом **Глобальные параметры**. В окне **Изменить глобальную политику проверки подлинности** выберите **Многофакторная идентификация** в качестве дополнительного метода проверки подлинности и нажмите кнопку **ОК**. Адаптер регистрируется как WindowsAzureMultiFactorAuthentication. Для завершения регистрации нужно перезапустить службу AD FS.

<center>![Облако](./media/howto-mfaserver-adfs-2012/global.png)</center>

На этом этапе сервер Многофакторной идентификации уже настроен в качестве дополнительного поставщика проверки подлинности, который можно использовать с AD FS.

## <a name="install-a-standalone-instance-of-the-ad-fs-adapter-by-using-the-web-service-sdk"></a>Установка изолированного экземпляра адаптера AD FS с помощью пакета SDK веб-службы

1. Установите пакет SDK веб-службы на сервере, на котором запущен сервер Многофакторной идентификации.
2. Скопируйте следующие файлы из папки \Program Files\Multi-Factor Authentication Server на сервер, на котором вы планируете установить адаптер AD FS:
   * MultiFactorAuthenticationAdfsAdapterSetup64.msi
   * Register-MultiFactorAuthenticationAdfsAdapter.ps1
   * Unregister-MultiFactorAuthenticationAdfsAdapter.ps1
   * MultiFactorAuthenticationAdfsAdapter.config
3. Запустите файл установки MultiFactorAuthenticationAdfsAdapterSetup64.msi.
4. Чтобы начать установку, в установщике адаптера Многофакторной идентификации AD FS нажмите кнопку **Далее**.
5. По завершении установки нажмите кнопку **Закрыть** .

## <a name="edit-the-multifactorauthenticationadfsadapterconfig-file"></a>Изменение файла MultiFactorAuthenticationAdfsAdapter.config
Чтобы изменить файл MultiFactorAuthenticationAdfsAdapter.config, выполните следующие действия.

1. Задайте для узла **UseWebServiceSdk** значение **true**.  
2. В поле **WebServiceSdkUrl** укажите URL-адрес пакета SDK веб-службы многофакторной проверки подлинности. Например, *https://contoso.com/&lt;certificatename&gt;/MultiFactorAuthWebServiceSdk/PfWsSdk.asmx*, где *certificatename* — это имя сертификата.  
3. Измените скрипт Register-MultiFactorAuthenticationAdfsAdapter.ps1. Для этого добавьте `-ConfigurationFilePath &lt;path&gt;` в конец команды `Register-AdfsAuthenticationProvider`, где *&lt;path&gt;*  — это полный путь к файлу MultiFactorAuthenticationAdfsAdapter.config.

### <a name="configure-the-web-service-sdk-with-a-username-and-password"></a>Настройка пакета SDK веб-службы с помощью имени пользователя и пароля

Настройку пакета SDK веб-службы можно выполнить двумя способами. В первом случае используется имя пользователя и пароль, а во втором — сертификат клиента. Выполните следующие действия, чтобы настроить пакет SDK первым способом, или перейдите к инструкции для второго способа.  

1. Для параметра **WebServiceSdkUsername** укажите учетную запись, которая является участником группы безопасности PhoneFactor Admins. Используйте формат &lt;домен&gt;&#92;&lt;имя_пользователя&gt;.  
2. Для параметра **WebServiceSdkPassword** укажите пароль соответствующей учетной записи.

### <a name="configure-the-web-service-sdk-with-a-client-certificate"></a>Настройка пакета SDK веб-службы с помощью сертификата клиента

Если вы не хотите использовать имя пользователя и пароль для настройки пакета SDK веб-службы, выполните следующие действия для настройки с помощью сертификата клиента.

1. Получите в центре сертификации сертификат клиента для сервера, на котором запущен пакет SDK веб-службы. Дополнительные сведения см. в статье [о получении сертификатов клиента](https://technet.microsoft.com/library/cc770328.aspx).  
2. Импортируйте сертификат клиента в хранилище личных сертификатов локального компьютера на сервере, на котором запущен пакет SDK веб-службы. Убедитесь, что открытый сертификат центра сертификации находится в хранилище доверенных корневых сертификатов.  
3. Экспортируйте открытый и закрытый ключи сертификата клиента в PFX-файл.  
4. Экспортируйте открытый ключ в формате Base64 в CER-файл.  
5. Откройте диспетчер серверов и убедитесь, что компонент проверки подлинности с сопоставлением сертификата клиента установлен в папке Web Server (IIS)\Web Server\Security\IIS. Если этот компонент не установлен, добавьте его, щелкнув **Добавить роли и компоненты** .  
6. Откройте диспетчер служб IIS и дважды щелкните **Редактор конфигураций** на веб-сайте, который содержит виртуальный каталог пакета SDK веб-службы. Важно выбрать веб-сайт, а не виртуальный каталог.  
7. Перейдите в раздел **system.webServer/security/authentication/iisClientCertificateMappingAuthentication** .  
8. Присвойте параметру enabled значение **true**.  
9. Задайте для параметра oneToOneCertificateMappingsEnabled значение **true**.  
10. Нажмите кнопку **…** рядом с neToOneMappings, а затем щелкните ссылку **Добавить**.  
11. Откройте предварительно экспортированный CER-файл в формате Base64. Удалите *-----BEGIN CERTIFICATE-----*, *-----END CERTIFICATE-----* и все разрывы строк. Скопируйте получившуюся строку.  
12. Укажите скопированную строку как значение параметра certificate.  
13. Присвойте параметру enabled значение **true**.  
14. Для параметра userName укажите учетную запись, которая входит в группу безопасности PhoneFactor Admins. Используйте формат &lt;домен&gt;&#92;&lt;имя_пользователя&gt;.  
15. Укажите пароль для соответствующей учетной записи, а затем закройте редактор конфигураций.  
16. Щелкните ссылку **Применить** .  
17. В виртуальном каталоге пакета SDK веб-службы дважды щелкните **Проверка подлинности**.  
18. Убедитесь, что параметры "Олицетворение ASP.NET" и "Обычная проверка подлинности" имеют значение **Включено**, а все остальные — **Отключено**.  
19. В виртуальном каталоге пакета SDK веб-службы дважды щелкните **Параметры SSL**.  
20. Чтобы настроить параметр "Сертификаты клиентов" выберите значение **Принять**, а затем щелкните **Применить**.  
21. Скопируйте предварительно экспортированный PFX-файл на сервер, на котором работает адаптер AD FS.  
22. Импортируйте PFX-файл в хранилище личных сертификатов на локальном компьютере.  
23. Щелкните правой кнопкой мыши и выберите **Управление закрытыми ключами**, а затем предоставьте разрешение на чтение учетной записи, используемой для входа в службу AD FS.  
24. Откройте сертификат клиента и скопируйте отпечаток на вкладке **Сведения** .  
25. В файле MultiFactorAuthenticationAdfsAdapter.config для параметра **WebServiceSdkCertificateThumbprint** укажите строку, скопированную на предыдущем этапе.  

Чтобы зарегистрировать адаптер, выполните в PowerShell сценарий \Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1. Адаптер регистрируется как WindowsAzureMultiFactorAuthentication. Для завершения регистрации нужно перезапустить службу AD FS.

## <a name="secure-azure-ad-resources-using-ad-fs"></a>Защита ресурсов Azure AD с помощью AD FS

Чтобы защитить облачный ресурс, настройте правило утверждений, чтобы при выполнении пользователем двухфакторной проверки подлинности службы федерации Active Directory выдавали утверждение multipleauthn. Это утверждение передается в Azure AD. Для этого следуйте такой процедуре:

1. Откройте оснастку управления AD FS.
2. В левой части выберите **Отношения доверия проверяющей стороны**.
3. Щелкните правой кнопкой мыши **Microsoft Office 365 Identity Platform** (Платформа удостоверений Microsoft Office 365) и выберите **Изменить правила утверждений...**.

   ![Облако](./media/howto-mfaserver-adfs-2012/trustedip1.png)

4. На вкладке "Правила преобразования выдачи" выберите **Добавить правило**.

   ![Облако](./media/howto-mfaserver-adfs-2012/trustedip2.png)

5. В мастере добавления правила преобразования утверждения выберите **Проход через входящее утверждение или его фильтрация** в раскрывающемся списке и нажмите кнопку **Далее**.

   ![Облако](./media/howto-mfaserver-adfs-2012/trustedip3.png)

6. Укажите имя правила.
7. Выберите **Ссылки на методы проверки подлинности** в качестве типа входящего утверждения.
8. Щелкните **Пройти по всем значениям утверждений**.
    ![Мастер добавления правила преобразования утверждений](./media/howto-mfaserver-adfs-2012/configurewizard.png)
9. Нажмите кнопку **Готово** Закройте консоль управления AD FS.

## <a name="troubleshooting-logs"></a>Журналы для устранения неполадок

Чтобы включить дополнительное ведение журнала для устранения неполадок с адаптером AD FS сервера MFA, выполните следующие действия.

1. В интерфейсе сервера MFA откройте раздел AD FS и установите флажок **Включить ведение журнала**.
2. На каждом сервере AD FS используйте файл **regedit.exe** для создания строкового раздела реестра `Computer\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Positive Networks\PhoneFactor\InstallPath` в каталоге `C:\Program Files\Multi-Factor Authentication Server\` (или в другом каталоге).  **Обратите внимание, что обратная косая черта обязательна.**
3. Создайте каталог `C:\Program Files\Multi-Factor Authentication Server\Logs` (или другой каталог, указанный на **шаге 2**).
4. Предоставьте учетной записи службы AD FS разрешение на изменение каталога хранения журналов.
5. Перезагрузите службу AD FS.
6. Убедитесь, что в каталоге хранения журналов был создан файл `MultiFactorAuthAdfsAdapter.log`.

## <a name="related-topics"></a>Связанные разделы

Дополнительные сведения по поиску и устранению ошибок см. в статье [Часто задаваемые вопросы о службе Многофакторной идентификации Azure](multi-factor-authentication-faq.md).
