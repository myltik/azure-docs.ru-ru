---
title: Настройка сервера MFA Azure для обеспечения высокой доступности | Документация Майкрософт
description: Разверните несколько экземпляров сервера Многофакторной идентификации Azure в конфигурациях, обеспечивающих высокую доступность.
services: multi-factor-authentication
ms.service: active-directory
ms.component: authentication
ms.topic: article
ms.date: 08/23/2017
ms.author: joflore
author: MicrosoftGuyJFlo
manager: mtillman
ms.reviewer: richagi
ms.openlocfilehash: 75d3906819174a8bc3eeaa247dffa937a02ceab1
ms.sourcegitcommit: 870d372785ffa8ca46346f4dfe215f245931dae1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/08/2018
ms.locfileid: "33882904"
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a>Настройка сервера Многофакторной идентификации Azure для обеспечения высокой доступности

Чтобы обеспечить высокую доступность с развертыванием сервера MFA Azure, необходимо развернуть несколько серверов MFA. В этой статье приведены сведения о структуре с балансировкой нагрузки, позволяющей достичь целевых показателей высокой доступности в развертывании сервера MFA Azure.

## <a name="mfa-server-overview"></a>Обзор сервера MFA

Архитектура сервера MFA Azure состоит из нескольких компонентов, как показано на схеме ниже.

 ![Архитектура сервера MFA](./media/howto-mfaserver-deploy-ha/mfa-ha-architecture.png)

Сервер MFA — это сервер Windows Server, на котором установлено программное обеспечение службы "Многофакторная идентификация Azure". Экземпляр сервера MFA необходимо активировать с помощью службы MFA Azure. В локальной среде можно установить несколько серверов MFA.

Первый сервер MFA — это главный сервер, который устанавливается с помощью службы MFA Azure после активации по умолчанию. Он содержит доступную для записи копию базы данных PhoneFactor.pfdata. Последующие устанавливаемые экземпляры сервера MFA называются ведомыми. Ведомые серверы MFA содержат реплицированную копию базы данных PhoneFactor.pfdata, доступную только для чтения. Серверы MFA выполняют репликацию данных с помощью удаленного вызова процедур (RPC). Для репликации данных все серверы MFA должны быть присоединены к домену или использоваться по отдельности.

Если требуется двухфакторная проверка подлинности, главные и ведомые серверы MFA взаимодействуют со службой MFA. Например, когда пользователь пытается получить доступ к приложению, которому необходима двухфакторная проверка подлинности, он сначала пройдет проверку подлинности с помощью поставщика удостоверений, например Active Directory (AD).

После успешной проверки подлинности в AD сервер MFA будет взаимодействовать со службой MFA. Сервер MFA ожидает уведомление от службы MFA, чтобы разрешить или запретить доступ пользователя к приложению.

Если главный сервер MFA отключится от сети, проверку подлинности по-прежнему можно будет обработать, но операции, при выполнении которых необходимо вносить изменения в базу данных MFA, не удастся обработать. К примерам относится добавление пользователей, изменение ПИН-кода самообслуживания и изменение сведений о пользователе.

## <a name="deployment"></a>Развертывание

Обратите внимание на следующие важные замечания по балансировке нагрузки сервера MFA Azure и связанных с ним компонентов.

* **Обеспечение высокой доступности с помощью стандарта RADIUS.** При использовании серверов MFA Azure в качестве серверов RADIUS потенциально можно настроить один сервер MFA как основной целевой объект проверки подлинности RADIUS, а другие серверы MFA Azure — как дополнительные целевые объекты проверки подлинности. Однако этот метод обеспечения высокой доступности может оказаться непрактичным, так как необходимо дождаться периода ожидания, в течение которого возникает сбой проверки подлинности на основном целевом объекте, прежде чем вы сможете пройти проверку подлинности для дополнительного целевого объекта проверки подлинности. Более эффективно выполнять балансировку нагрузки трафика RADIUS между клиентом RADIUS и серверами RADIUS (в данном случае серверы MFA Azure, выступающие в качестве серверов RADIUS), чтобы можно было настроить клиенты RADIUS с отдельным URL-адресом, на который они могут указывать.
* **Необходимость повышения уровня ведомых серверов MFA вручную.** Если главный сервер MFA Azure отключится от сети, серверы-получатели MFA Azure продолжат обработку запросов MFA. Тем не менее, пока главный сервер MFA недоступен, администраторы не смогут добавлять пользователей или изменять параметры MFA, а пользователи не смогут вносить изменения на пользовательском портале. Повышение уровня ведомого сервера MFA до главного выполняется всегда вручную.
* **Возможность разделения компонентов.** Сервер MFA Azure состоит из нескольких компонентов, которые можно установить на одном или на разных экземплярах Windows Server. К этим компонентам относятся пользовательский портал, веб-служба мобильного приложения и адаптер AD FS (агент). Благодаря возможности разделения можно использовать прокси-сервер веб-приложения для публикации пользовательского портала и веб-сервера мобильного приложения из сети периметра. Такая конфигурация обеспечивает дополнительную защиту структуры, как показано на схеме ниже. Пользовательский портал MFA и веб-сервер мобильного приложения также можно развернуть в конфигурациях высокого уровня доступности с балансировкой нагрузки.

   ![Сервер MFA с сетью периметра](./media/howto-mfaserver-deploy-ha/mfasecurity.png)

* **Если для трафика выполняется балансировка нагрузки, для отправки одноразового пароля (OTP) по SMS (также называемое односторонним SMS) необходимо использовать прикрепленные сеансы**. Одностороннее SMS — это способ проверки подлинности, позволяющий серверу MFA отправлять пользователям текстовое сообщение, содержащее одноразовый пароль. Пользователь вводит OTP в окне командной строки, чтобы выполнить запрос MFA. В случае балансировки нагрузки серверов MFA Azure сервер, обрабатывающий первоначальный запрос проверки подлинности, должен получить сообщение OTP от пользователя. Если ответ OTP получит другой сервер MFA, запрос проверки подлинности завершится сбоем. Дополнительные сведения см. в статье [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server) (Новая возможность сервер MFA Azure: отправка одноразового пароля по SMS).
* **Для развертываний пользовательского портала и веб-службы мобильного приложения с балансировкой нагрузки необходимы прикрепленные сеансы.** В случае балансировки нагрузки пользовательского портала MFA и веб-службы мобильного приложения каждый сеанс должен проходить на одном сервере.

## <a name="high-availability-deployment"></a>Развертывание с высоким уровнем доступности

На схеме ниже показана полная высокодоступная реализация с балансировкой нагрузки MFA Azure и ее компонентов, а также приведено ADFS для справки.

 ![Реализация высокой доступности сервера MFA Azure](./media/howto-mfaserver-deploy-ha/mfa-ha-deployment.png)

Обратите внимание на следующие пронумерованные элементы предыдущей схемы.

1. Для репликации базы данных PhoneFactor.pfdata на двух серверах MFA Azure (MFA1 и MFA2) реализована балансировка нагрузки (mfaapp.contoso.com) и настроено использование статического порта (4443). Чтобы включить обмен данными с серверами ADFS через TCP-порт 443, на каждом сервере MFA установлен пакет SDK веб-службы. Серверы MFA развертываются в конфигурации балансировки нагрузки без отслеживания состояния. Однако, если вы хотите использовать OTP через SMS, необходимо применить балансировку нагрузки с отслеживанием состояния.
   ![Высокая доступность сервера приложений MFA Azure](./media/howto-mfaserver-deploy-ha/mfaapp.png)

   > [!NOTE]
   > Так как RPC использует динамические порты, мы не советуем открывать брандмауэры в диапазоне динамических портов, которые может использовать RPC. Если вы используете брандмауэр **между** серверами приложений MFA, для трафика репликации, который используется для обмена данными между ведомыми и главными серверами через статический порт, необходимо настроить сервер MFA. Вам также следует открыть нужный порт в брандмауэре. Вы можете принудительно использовать статический порт, создав значение реестра типа DWORD в разделе ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` с именем ```Pfsvc_ncan_ip_tcp_port``` и задав в качестве значения доступный статический порт. Подключения всегда инициируются из ведомого сервера MFA к главному, для которого требуется только статический порт, но так как вы в любое время можете повысить уровень ведомого сервера до главного, необходимо задать статический порт на всех серверах MFA.

2. На двух серверах пользовательского портала и мобильного приложения MFA (MFA-UP-MAS1 и MFA-UP-MAS2) реализована балансировка нагрузки в конфигурации **с отслеживанием состояния** (mfa.contoso.com). Обратите внимание, что прикрепленные сеансы являются обязательными для балансировки нагрузки пользовательского портала MFA и службы мобильных приложений.
   ![Сервер MFA Azure. Высокая доступность пользовательского портала и службы мобильных приложений](./media/howto-mfaserver-deploy-ha/mfaportal.png)
3. Ферма серверов ADFS балансируется и публикуется в Интернете через прокси-серверы ADFS с балансировкой нагрузки в сети периметра. На каждом сервере ADFS используется агент ADFS для взаимодействия с серверами MFA Azure, которое осуществляется с помощью отдельного URL-адреса с балансировкой нагрузки (mfaapp.contoso.com) через TCP-порт 443.

## <a name="next-steps"></a>Дополнительная информация

* [Приступая к работе с сервером службы "Многофакторная идентификация Azure"](howto-mfaserver-deploy.md)
