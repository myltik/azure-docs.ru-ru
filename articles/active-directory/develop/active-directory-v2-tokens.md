---
title: Справочник маркерам Azure Active Directory версии 2.0 | Документация Майкрософт
description: Типы маркеров и утверждений, выдаваемых конечной точкой версии 2.0
services: active-directory
documentationcenter: ''
author: hpsin
manager: mtillman
editor: ''
ms.assetid: dc58c282-9684-4b38-b151-f3e079f034fd
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/07/2017
ms.author: hirsin
ms.custom: aaddev
ms.openlocfilehash: 071e0c2b802b1bb6ef68092362c61bf3960fd45a
ms.sourcegitcommit: fa493b66552af11260db48d89e3ddfcdcb5e3152
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2018
---
# <a name="azure-active-directory-v20-tokens-reference"></a>Справочник маркерам Azure Active Directory версии 2.0
При обработке каждого [потока аутентификации](active-directory-v2-flows.md) конечная точка Azure Active Directory (Azure AD) версии 2.0 выдает маркеры безопасности различных типов. В этом справочнике описывается формат, характеристики безопасности и содержимое маркера каждого типа.

> [!NOTE]
> Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, стоит ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).
>
>

## <a name="types-of-tokens"></a>Типы маркеров
Конечная точка версии 2.0 поддерживает [протокол авторизации OAuth 2.0](active-directory-v2-protocols.md), использующий как маркеры доступа, так и маркеры обновления. Конечная точка версии 2.0 также поддерживает аутентификацию и вход с помощью протокола [OpenID Connect](active-directory-v2-protocols.md). В OpenID Connect вводится третий тип маркера — маркер идентификации. Каждый из этих маркеров представлен как токен *носителя*.

Токен носителя — это упрощенный маркер безопасности, который предоставляет носителю доступ к защищенному ресурсу. В этом смысле носителем является любая сторона, которая может предъявить маркер. Несмотря на то, что сторона должна пройти аутентификацию Azure AD, чтобы получить токен носителя, если не приняты меры для защиты токена во время передачи и хранения, он может быть перехвачен и использован несанкционированной стороной. В некоторых маркерах безопасности предусмотрен встроенный механизм для предотвращения использования несанкционированными сторонами, но это не относится к токенам носителя. Токены носителя должны передаваться по защищенному каналу, например по протоколу HTTPS. Если токен носителя передается без подобной защиты, то злоумышленник может использовать атаку "злоумышленник в середине", чтобы получить токен и использовать его для несанкционированного доступа к защищенному ресурсу. Те же принципы безопасности применяются при сохранении или кэшировании маркеров носителя для последующего использования. Всегда следует убедиться, что приложение передает и сохраняет токены носителя, применяя меры безопасности. Дополнительные рекомендации по защите токенов носителя см. в документе [RFC 6750, раздел 5](http://tools.ietf.org/html/rfc6750).

Многие маркеры, выдаваемые конечной точкой версии 2.0, реализованы как маркеры JSON Web Token (JWT). JWT — это компактное и безопасное для URL-адреса средство передачи информации между двумя сторонами. Сведения, содержащиеся в JWT, называются *утверждением*. Это утверждение информации о носителе и субъекте маркера. Утверждения в JWT — это объекты JSON, закодированные и сериализованные для передачи. Так как выдаваемые конечной точкой версии 2.0 маркеры JWT подписываются, но не шифруются, их содержимое можно без труда изучить с целью отладки. Дополнительные сведения о маркерах JWT см. в [спецификациях JWT](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html).

### <a name="id-tokens"></a>Маркеры идентификации
Маркер идентификации — это разновидность маркера безопасности входа, который приложение получает при аутентификации с использованием [OpenID Connect](active-directory-v2-protocols.md). Маркеры идентификации представлены в виде [маркеров JWT](#types-of-tokens) и содержат утверждения, которые можно использовать для входа пользователя в приложение. Утверждения, которые содержит маркер идентификации, можно использовать по-разному. Как правило, администраторы используют маркеры идентификации для отображения сведений об учетной записи или принятия решений о контроле доступа в приложении. Конечная точка версии 2.0 выдает маркер идентификации только одного типа, который содержит согласованный набор утверждений независимо от типа вошедшего пользователя. Формат и содержимое маркеров идентификации одинаковы для пользователей как с личными учетными записями Майкрософт, так и с рабочими или учебными учетными записями.

На текущий момент маркеры идентификации подписываются, но не шифруются. Когда приложение получает маркер идентификации, оно должно [проверить подпись](#validating-tokens), чтобы подтвердить подлинность маркера, и проверить несколько содержащихся в нем утверждений для подтверждения его действительности. Утверждения, которые проверяет приложение, зависят от требований сценария, но некоторые [стандартные проверки утверждений](#validating-tokens) приложение должно выполнять в каждом сценарии.

Мы предоставляем полные сведения об утверждениях в маркерах идентификации и пример такого маркера в следующих разделах. Обратите внимание, что утверждения в маркерах идентификации не возвращаются в определенном порядке. Кроме того, новые утверждения могут появиться в маркерах идентификации в любое время. Ваше приложение не должно прерывать работу при появлении новых утверждений. В следующем списке приведены утверждения, которые приложение гарантированно интерпретирует на текущий момент. Дополнительные сведения можно найти в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html).

#### <a name="sample-id-token"></a>Пример маркера идентификации
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiI2NzMxZGU3Ni0xNGE2LTQ5YWUtOTdiYy02ZWJhNjkxNDM5MWUiLCJpc3MiOiJodHRwczovL2xvZ2luLm1pY3Jvc29mdG9ubGluZS5jb20vYjk0MTk4MTgtMDlhZi00OWMyLWIwYzMtNjUzYWRjMWYzNzZlL3YyLjAiLCJpYXQiOjE0NTIyODUzMzEsIm5iZiI6MTQ1MjI4NTMzMSwiZXhwIjoxNDUyMjg5MjMxLCJuYW1lIjoiQmFiZSBSdXRoIiwibm9uY2UiOiIxMjM0NSIsIm9pZCI6ImExZGJkZGU4LWU0ZjktNDU3MS1hZDkzLTMwNTllMzc1MGQyMyIsInByZWZlcnJlZF91c2VybmFtZSI6InRoZWdyZWF0YmFtYmlub0BueXkub25taWNyb3NvZnQuY29tIiwic3ViIjoiTUY0Zi1nZ1dNRWppMTJLeW5KVU5RWnBoYVVUdkxjUXVnNWpkRjJubDAxUSIsInRpZCI6ImI5NDE5ODE4LTA5YWYtNDljMi1iMGMzLTY1M2FkYzFmMzc2ZSIsInZlciI6IjIuMCJ9.p_rYdrtJ1oCmgDBggNHB9O38KTnLCMGbMDODdirdmZbmJcTHiZDdtTc-hguu3krhbtOsoYM2HJeZM3Wsbp_YcfSKDY--X_NobMNsxbT7bqZHxDnA2jTMyrmt5v2EKUnEeVtSiJXyO3JWUq9R0dO-m4o9_8jGP6zHtR62zLaotTBYHmgeKpZgTFB9WtUq8DVdyMn_HSvQEfz-LWqckbcTwM_9RNKoGRVk38KChVJo4z5LkksYRarDo8QgQ7xEKmYmPvRr_I7gvM2bmlZQds2OeqWLB1NSNbFZqyFOCgYn3bAQ-nEQSKwBaA36jYGPOVG2r2Qv1uKcpSOxzxaQybzYpQ
```

> [!TIP]
> Чтобы в целях обучения изучить утверждения в примере маркера идентификации, вставьте его в файл [calebb.net](http://calebb.net/).
>
>

#### <a name="claims-in-id-tokens"></a>Утверждения в маркерах идентификации
| ИМЯ | Утверждение | Пример значения | ОПИСАНИЕ |
| --- | --- | --- | --- |
| audience |`aud` |`6731de76-14a6-49ae-97bc-6eba6914391e` |Определяет целевого получателя маркера. В маркерах идентификации целевая аудитория обозначена идентификатором приложения, назначенным ему на портале регистрации приложений Майкрософт. Приложение должно проверить это значение и отклонить маркер, если он ему не соответствует. |
| issuer |`iss` |`https://login.microsoftonline.com/b9419818-09af-49c2-b0c3-653adc1f376e/v2.0 ` |Определяет службу маркеров безопасности (STS), которая создает и возвращает маркер, а также клиент Azure AD, в котором пользователь прошел аутентификацию. Приложение должно проверить утверждение издателя и убедиться, что маркер пришел от конечной точки версии 2.0. Ему также следует использовать часть утверждения, содержащую GUID, для ограничения списка клиентов, которым разрешено входить в приложение. GUID, который указывает, что пользователь является потребителем с учетной записью Майкрософт: `9188040d-6c67-4c5b-b112-36a304b66dad`. |
| issued at |`iat` |`1452285331` |Время выдачи маркера в виде времени эпохи. |
| expiration time |`exp` |`1452289231` |Время окончания срока действия маркера в виде времени эпохи. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| not before |`nbf` |`1452285331` |Время начала срока действия маркера в виде времени эпохи. Обычно оно совпадает со временем выдачи. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| версия |`ver` |`2.0` |Версия маркера идентификации, как указано в Azure AD. Для конечной точки версии 2.0 используется значение `2.0`. |
| tenant ID |`tid` |`b9419818-09af-49c2-b0c3-653adc1f376e` |Идентификатор GUID, представляющий клиент Azure AD пользователя. Для рабочих и учебных учетных записей значением GUID является неизменяемый идентификатор клиента организации, к которой принадлежит пользователь. Для личных учетных записей значением является `9188040d-6c67-4c5b-b112-36a304b66dad`. Чтобы получить это утверждение, необходимо указать область `profile` . |
| code hash |`c_hash` |`SGCPtt01wxwfgnYZy2VJtQ` |Хэш-код включается в состав маркеров идентификации, только если маркер идентификации выдается вместе с кодом авторизации OAuth 2.0. Его можно использовать для проверки подлинности кода авторизации. Дополнительные сведения о выполнении этой проверки можно найти в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) . |
| access token hash |`at_hash` |`SGCPtt01wxwfgnYZy2VJtQ` |Хэш маркера доступа включается в состав маркеров идентификации, только если маркер выдается вместе с маркером доступа OAuth 2.0. Его можно использовать для проверки подлинности маркера доступа. Дополнительные сведения о выполнении этой проверки можно найти в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) . |
| nonce |`nonce` |`12345` |Специальные утверждения используются для предотвращения атак с использованием воспроизведения маркера. Приложение может указать специальное утверждение в запросе авторизации с помощью параметра запроса `nonce` . Значение, указанное вами в запросе, будет использовано в утверждении `nonce` маркера идентификации без изменений. Приложение может проверить это значение на соответствие значению, указанному в запросе, которое связывает сеанс приложения с определенным маркером идентификации. Приложение должно выполнять эту проверку во время проверки маркера идентификации. |
| name |`name` |`Babe Ruth` |Утверждение name предоставляет удобное для восприятия значение, определяющее субъект маркера. Это значение не обязательно должно быть уникальным. Оно изменяемое и предназначено только для отображения. Чтобы получить это утверждение, необходимо указать область `profile` . |
| email |`email` |`thegreatbambino@nyy.onmicrosoft.com` |Основной адрес электронной почты, связанный с учетной записью пользователя (если она существует). Его значение не является неизменяемым и может меняться с течением времени. Чтобы получить это утверждение, необходимо указать область `email` . |
| preferred username |`preferred_username` |`thegreatbambino@nyy.onmicrosoft.com` |Основное имя пользователя, представляющее пользователя на конечной точке версии 2.0. Это может быть адрес электронной почты, телефонный номер или универсальное имя пользователя без определенного формата. Его значение не является неизменяемым и может меняться с течением времени. Так как это значение является изменяемым, его нельзя использовать для принятия решений об авторизации. Чтобы получить это утверждение, необходимо указать область `profile` . |
| subject |`sub` |`MF4f-ggWMEji12KynJUNQZphaUTvLcQug5jdF2nl01Q` | Субъект, в отношении которого маркер утверждает сведения, например данные о пользователе приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу, а также в качестве ключа в таблицах базы данных. Так как субъект всегда присутствует в выдаваемых Azure AD маркерах, мы советуем использовать это значение в системе авторизации общего назначения. Тем не менее субъект — это попарный идентификатор, который является уникальным для конкретного приложения.  Если один пользователь войдет в два различных приложения с помощью двух разных идентификаторов клиента, эти приложения получат два разных значения в утверждении субъекта.  Это может быть или не быть необходимым в зависимости от требований архитектуры и конфиденциальности. |
| object ID |`oid` |`a1dbdde8-e4f9-4571-ad93-3059e3750d23` | Неизменяемый идентификатор объекта в системе идентификации Майкрософт. В данном случае это учетная запись пользователя.  Его можно использовать для безопасных проверок авторизации, а также в качестве ключа в таблицах базы данных. Этот идентификатор уникально идентифицирует пользователя в приложениях. Если один пользователь войдет в два различных приложения с помощью двух разных идентификаторов клиента, эти приложения получат одинаковое значение в утверждении `oid`.  Это означает, что он может использоваться при выполнении запросов к Microsoft Online Services, например Microsoft Graph.  Microsoft Graph возвратит этот идентификатор в качестве свойства `id` указанной учетной записи.  Так как `oid` позволяет нескольким приложениям сопоставлять пользователей, для получения этого утверждения необходимо указать область `profile`. Обратите внимание, что если один пользователь существует в нескольких клиентах, его учетная запись в каждом клиенте будет содержать разные идентификаторы объекта. Такие учетные записи считаются разными, даже если пользователь входит в каждую из них с помощью одних учетных данных. |

### <a name="access-tokens"></a>Маркеры доступа

Конечная точка версии 2.0 позволяет приложениям сторонних производителей, которые зарегистрированы в Azure AD, выдавать маркеры доступа для защищенных ресурсов, таких как веб-API. Дополнительные сведения о настройке приложения для выдачи маркеров доступа, см. в статье [о регистрации приложения с использованием конечной точки версии 2.0](active-directory-v2-app-registration.md). После регистрации приложения с использованием конечной точки версии 2.0 разработчик может указать уровни доступа, которые называются **областями** и для которых можно выдавать маркеры доступа. Например, область **calendars.read**, заданная в API Microsoft Graph, предоставляет разрешение на чтение календаря пользователя. Когда приложение получает маркер доступа из конечной точки версии 2.0, необходимо проверить подпись, данные издателя, сведения об аудитории, срок действия и все остальные утверждения маркера в соответствии с вашим сценарием. 

Когда вы запрашиваете маркер доступа у конечной точки версии 2.0, она также возвращает приложению некоторые метаданные о маркере доступа. Эти сведения включают время окончания срока действия маркера доступа и области, для которых он действителен. С помощью этих метаданных приложение может выполнять интеллектуальное кэширование маркеров доступа без необходимости анализа самого маркера.

### <a name="refresh-tokens"></a>Маркеры обновления
Маркеры обновления — это маркеры безопасности, которые приложение может использовать для получения новых маркеров доступа в потоке OAuth 2.0. Используя маркеры обновления, приложение может получить долговременный доступ к ресурсам от имени пользователя без необходимости взаимодействия с этим пользователем.

Маркеры обновления относятся к нескольким ресурсам. Маркер обновления, полученный при запросе маркера для одного ресурса, можно обменять на маркеры доступа к совершенно другому ресурсу.

Чтобы получить маркер обновления в ответе маркера, приложение должно запросить область `offline_acesss` и получить соответствующие разрешения. Дополнительные сведения об области `offline_access` можно найти в [этой статье о предоставлении разрешений и областях](active-directory-v2-scopes.md).

Маркеры обновления абсолютно непрозрачны для приложения и всегда будут таковыми. Они выдаются конечной точкой версии 2.0 Azure AD, и только эта точка может проверять и интерпретировать их. Они действительны в течение продолжительного времени, но при создании приложение не следует ожидать, что срок действия маркера обновления неограничен. Маркеры обновления могут стать недействительными в любое время по разным причинам. Дополнительные сведения см. в разделе об [отзыве маркеров](active-directory-token-and-claims.md#token-revocation). Единственный способ, которым приложение может выяснить, является ли маркер действительным, — попытаться использовать его путем отправки запроса маркера на конечную точку версии 2.0.

При обмене маркера обновления на новый маркер доступа (если при этом приложению предоставлена область `offline_access`) вы получите новый маркер обновления в ответе маркера. Сохраните новый маркер обновления, чтобы заменить им использованный в запросе. Такой подход обеспечит максимальный срок действия маркеров обновления.

## <a name="validating-tokens"></a>Проверка маркеров
В настоящее время приложениям нужно проверять только маркеры идентификации. Для проверки маркера идентификации приложение должно проверить подпись маркера идентификации содержащиеся в нем утверждения.

<!-- TODO: Link -->
Корпорация Майкрософт предоставляет библиотеки и примеры кода, демонстрирующие удобство выполнения проверки маркеров. В следующих разделах описывается базовый процесс. Кроме того, доступно несколько сторонних библиотек с открытым кодом для проверки JWT. Существует по крайней мере одна библиотека практически для каждой платформы и языка.

### <a name="validate-the-signature"></a>проверяют его подпись
Маркер JWT содержит три сегмента, разделенных символом `.` . Первый сегмент называется *заголовком*, второй — *текстом*, а третий — *подписью*. Сегмент подписи можно использовать для проверки подлинности маркера идентификации, чтобы приложение доверяло ему.

Маркеры идентификации подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256. Заголовок маркера идентификации содержит сведения о ключе и методе шифрования, использованных для подписания маркера. Например: 

```
{
  "typ": "JWT",
  "alg": "RS256",
  "kid": "MnC_VZcATfM5pOYiJHMba9goEKY"
}
```

Утверждение `alg` обозначает алгоритм, с помощью которого был подписан маркер. Утверждение `kid` обозначает открытый ключ, с помощью которого был подписан маркер.

В любой момент времени конечная точка версии 2.0 может подписать маркер идентификации с использованием любой пары открытого и закрытого ключей из определенного их набора. Конечная точка версии 2.0 периодически изменяет возможный набор ключей, поэтому при создании приложения необходимо обеспечить автоматическую обработку подобных изменений ключей. Рекомендуется проверять наличие обновлений открытых ключей, используемых конечной точкой версии 2.0, каждые 24 часа.

Данные ключа подписи, необходимые для проверки подписи, можно найти в документе метаданных OpenID Connect по приведенной ниже ссылке.

```
https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
```

> [!TIP]
> Попробуйте ввести этот URL-адрес в браузере.
>
>

Этот документ метаданных представляет собой объект JSON, содержащий несколько ценных блоков информации, таких как расположение различных конечных точек, необходимых для аутентификации OpenID Connect.  Документ также содержит *jwks_uri*, который указывает расположение набора открытых ключей, использованных для подписания маркеров. Документ JSON, указанный в jwks_uri, содержит все сведения об открытом ключе, который используется в настоящий момент. Приложение может использовать утверждение `kid` в заголовке JWT, чтобы выбрать в этом документе открытый ключ, использованный для подписания маркера. Затем оно может проверить подпись с использованием правильного открытого ключа и указанного алгоритма.

Выполнение проверки подписи выходит за рамки этого документа. Для этого можно использовать многие библиотеки с открытым кодом.

### <a name="validate-the-claims"></a>Проверка утверждений
Когда приложение получает маркер идентификации после входа пользователя, ему также требуется выполнить несколько проверок утверждений в этом маркере. Помимо прочего, к ним относятся:

* Утверждение **audience**. Необходимо для подтверждения того, что маркер идентификации действительно должен был быть выдан вашему приложению.
* Утверждения **not before** и **expiration time**. Необходимы для подтверждения того, что срок действия маркера идентификации не истек.
* Утверждение **issuer**. Необходимо для подтверждения того, что маркер был выдан приложению конечной точкой версии 2.0.
* Утверждение **nonce**. Необходимо для предотвращения атак с использованием воспроизведения маркеров.

Полный список проверок утверждений, которые должно выполнять ваше приложение, представлен в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation).

Подробные сведения об ожидаемых значениях этих утверждений можно найти в разделе о [маркерах идентификации](# ID tokens).

## <a name="token-lifetimes"></a>Время существования маркеров
Значения времени существования маркеров приводятся только для ознакомления. Они могут помочь при разработке и отладке приложений. При создании приложений не следует ожидать, что какое-либо из указанных значений времени существования будет постоянным. Время существования маркеров может изменяться в любое время, что и будет происходить.

| по маркеру | Срок действия | ОПИСАНИЕ |
| --- | --- | --- |
| Маркеры идентификации (рабочие или учебные учетные записи) |1 час |Как правило, маркеры идентификации действительны в течение часа. Веб-приложение может использовать то же время существования в рамках собственного сеанса пользователя (рекомендуется) или выбрать совершенно другое время существования сеанса. Если приложению требуется получить новый маркер идентификации, ему потребуется отправить новый запрос на вход к конечной точке авторизации версии 2.0. Если у пользователя запущен действительный сеанс браузера с конечной точкой версии 2.0, возможно, вводить учетные данные повторно не придется. |
| Маркеры идентификации (личные учетные записи) |24 часа |Маркеры идентификации для личных учетных записей обычно действительны в течение 24 часов. Веб-приложение может использовать то же время существования в рамках собственного сеанса пользователя (рекомендуется) или выбрать совершенно другое время существования сеанса. Если приложению требуется получить новый маркер идентификации, ему потребуется отправить новый запрос на вход к конечной точке авторизации версии 2.0. Если у пользователя запущен действительный сеанс браузера с конечной точкой версии 2.0, возможно, вводить учетные данные повторно не придется. |
| Маркеры доступа (рабочие или учебные учетные записи) |1 час |Указывается в ответах маркера как часть метаданных маркера. |
| Маркеры доступа (личные учетные записи) |1 час |Указывается в ответах маркера как часть метаданных маркера. Срок действия маркеров доступа, выданных от имени личных учетных записей, можно изменить, но обычно он составляет один час. |
| Маркеры обновления (рабочая или учебная учетная запись) |До 14 дней |Один маркер обновления действителен до 14 дней. Однако маркер обновления может стать недействительным в любое время по различным причинам, поэтому приложению следует использовать маркер обновления, пока срок его действия не истечет, либо пока приложение не заменит его новым маркером. Маркер обновления также становится недействительным, если последний раз пользователь вводил учетные данные более 90 дней назад. |
| Маркеры обновления (личные учетные записи) |До 1 года |Один маркер обновления действителен до 1 года. Однако маркер обновления может стать недействительным в любое время по различным причинам, поэтому приложению следует использовать маркер обновления, пока срок его действия не истечет. |
| Коды авторизации (рабочие или учебные учетные записи) |10 минут |Срок действия кодов авторизации специально ограничен, поэтому сразу же по получении маркеров их следует обменивать на маркеры доступа и обновления. |
| Коды авторизации (личные учетные записи) |5 мин |Срок действия кодов авторизации специально ограничен, поэтому сразу же по получении маркеров их следует обменивать на маркеры доступа и обновления. Коды авторизации, выданные от имени личных учетных записей, являются одноразовыми. |
