---
title: Области, разрешения и согласие в Azure Active Directory версии 2.0 | Документация Майкрософт
description: Описание авторизации в конечной точке Azure AD версии 2.0, включая области, разрешение и предоставление согласия.
services: active-directory
documentationcenter: ''
author: CelesteDG
manager: mtillman
editor: ''
ms.assetid: 8f98cbf0-a71d-4e34-babf-e644ad9ff423
ms.service: active-directory
ms.component: develop
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/07/2017
ms.author: celested
ms.reviewer: dastrock
ms.custom: aaddev
ms.openlocfilehash: f001751c9401b88d9bfaf35444882d3d5ccbfef3
ms.sourcegitcommit: e14229bb94d61172046335972cfb1a708c8a97a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
ms.locfileid: "34157347"
---
# <a name="scopes-permissions-and-consent-in-the-azure-active-directory-v20-endpoint"></a>Области, разрешения и согласие для конечной точки Azure Active Directory версии 2.0
Приложения, интегрируемые с Azure Active Directory (Azure AD), придерживаются определенной модели авторизации, позволяющей пользователям контролировать способ получения приложением доступа к их данным. Реализация версии 2.0 этой модели авторизации была обновлена, в результате чего изменился механизм взаимодействия приложения с Azure AD. В этой статье рассматриваются основные понятия этой модели авторизации, включая области, разрешения и согласие на их предоставление.

> [!NOTE]
> Не все сценарии и компоненты Azure Active Directory поддерживаются конечной точкой версии 2.0. Чтобы определить, стоит ли вам использовать конечную точку версии 2.0, ознакомьтесь с [ограничениями версии 2.0](active-directory-v2-limitations.md).
>
>

## <a name="scopes-and-permissions"></a>Области и разрешения
Azure AD реализует протокол авторизации [OAuth 2.0](active-directory-v2-protocols.md). OAuth 2.0 — это метод, посредством которого стороннее приложение может обращаться к интернет-ресурсам от имени пользователя. Любой интернет-ресурс, интегрируемый с Azure AD, имеет идентификатор ресурса или *универсальный код ресурса (URI) идентификатора приложения*. К примеру, ниже приведены некоторые из размещенных в Интернете ресурсов Майкрософт:

* Единый API почты Office 365: `https://outlook.office.com`
* API Graph Azure AD: `https://graph.windows.net`
* Microsoft Graph: `https://graph.microsoft.com`

Это касается любых сторонних ресурсов, интегрированных с Azure AD. Любой из этих ресурсов может также определять набор разрешений, с помощью которых можно разделить функции ресурса на меньшие блоки. Например, в [Microsoft Graph](https://graph.microsoft.io) определены разрешения для выполнения таких задач, как:

* чтение календаря пользователя;
* запись в календарь пользователя;
* отправка сообщений в качестве пользователя.

Благодаря определению этих разрешений ресурс получает детализированный контроль над своими данными и предоставлением внешнего доступа к ним. Приложение стороннего производителя может запросить эти разрешения у пользователя приложения. Пользователь приложения должен утвердить разрешения, прежде чем приложение сможет действовать от его имени. Разделяя функции ресурса на меньшие наборы разрешений, приложения сторонних производителей можно настроить таким образом, чтобы они запрашивали только определенные разрешения, необходимые им для выполнения своих задач. Такой подход позволяет пользователям точно знать, как приложение будет использовать их данные, давая им большую уверенность в отсутствии вредоносных целей в работе приложения.

В Azure AD и OAuth разрешения такого типа называются *областями*. Иногда их также называют областью *oAuth2Permissions*. В Azure AD область представляется как строковое значение. Продолжим рассмотрение примера для Microsoft Graph. Значение области для каждого разрешения следующее:

* чтение календаря пользователя с помощью `Calendars.Read`;
* запись в календарь пользователя с помощью `Calendars.ReadWrite`;
* отправка сообщений в качестве пользователя с помощью `Mail.Send`.

Приложение может запросить эти разрешения, указав области в запросах к конечной точке версии 2.0.

## <a name="openid-connect-scopes"></a>Области OpenId Connect
Реализация OpenID Connect на основе версии 2.0 содержит несколько четко определенных областей, которые не применяются к какому-либо конкретному ресурсу: `openid`, `email`, `profile` и `offline_access`.

### <a name="openid"></a>OpenId
Если приложение выполняет вход с помощью протокола [OpenID Connect](active-directory-v2-protocols.md), оно должно запросить область `openid`. В рабочей учетной записи область `openid` отображается на странице согласия в виде разрешения "Вход", а в личной учетной записи Майкрософт — в виде разрешения "View your profile and connect to apps and services using your Microsoft account" (Просмотр профиля и подключение к приложениям и службам с помощью учетной записи Майкрософт). Это разрешение позволяет приложению получить уникальный идентификатор для пользователя в виде утверждения `sub`. Оно также предоставляет приложению доступ к конечной точке сведений о пользователе. Область `openid` можно использовать на конечной точке маркеров версии 2.0 для получения маркеров идентификации, с помощью которых можно защитить HTTP-вызовы между разными компонентами приложения.

### <a name="email"></a>email
Область `email` можно использовать вместе с областью `openid` и любыми другими областями. Она предоставляет приложению доступ к основному электронному адресу пользователя в виде утверждения `email`. Утверждение `email` будет включено в маркер, только если электронный адрес связан с учетной записью пользователя (а это не всегда так). При использовании области `email` приложение должно быть готово обрабатывать случаи, когда утверждение `email` в маркере отсутствует.

### <a name="profile"></a>Профиль
Область `profile` можно использовать вместе с областью `openid` и любыми другими областями. Она предоставляет приложению доступ к существенному объему сведений о пользователе. К этим сведениям, в частности, относятся имя и фамилия пользователя, предпочтительное имя пользователя и идентификатор объекта. Полный список утверждений профиля, доступных в параметре id_tokens для конкретного пользователя, представлен в [справочнике по маркерам версии 2.0](active-directory-v2-tokens.md).

### <a name="offlineaccess"></a>offline_access
[Область `offline_access`](http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess) предоставляет приложению доступ к ресурсам от имени пользователя на длительное время. На странице согласия рабочей учетной записи эта область отображается в виде разрешения "Access your data anytime" (Доступ к вашим данным в любое время). На странице согласия личной учетной записи Майкрософт она отображается в виде разрешения "Доступ к вашим сведениям в любое время". Когда пользователь утвердит область `offline_access`, приложение сможет получать маркеры обновления от конечной точки маркеров версии 2.0. Маркеры обновления имеют большой срок действия. Приложение может получать новые маркеры доступа после того, как срок действия старых истечет.

Если приложение не запросит область `offline_access`, оно не получит маркеры обновления. Это значит, что при использовании кода авторизации в [потоке кода авторизации OAuth 2.0](active-directory-v2-protocols.md) от конечной точки `/token` вы получите только маркер доступа. Маркер доступа действителен недолго. Как правило, его срок действия истекает через один час. В этот момент приложению будет необходимо перенаправить пользователя обратно к конечной точке `/authorize`, чтобы получить новый код авторизации. При этом, в зависимости от типа приложения, пользователю может потребоваться повторно ввести учетные данные или предоставить разрешения.

Дополнительные сведения о том, как получать и использовать маркеры обновления, можно найти в [справочнике по протоколу версии 2.0](active-directory-v2-protocols.md).

## <a name="requesting-individual-user-consent"></a>Запрос на получение согласия одного пользователя
В запросе авторизации [OpenID Connect или OAuth 2.0](active-directory-v2-protocols.md) приложение может запросить необходимые разрешения с помощью параметра запроса `scope`. Например, при входе пользователя в приложение оно отправит запрос следующего вида (разрывы строк добавлены для удобства чтения).

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&response_type=code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
&response_mode=query
&scope=
https%3A%2F%2Fgraph.microsoft.com%2Fcalendars.read%20
https%3A%2F%2Fgraph.microsoft.com%2Fmail.send
&state=12345
```

Параметр `scope` — это запрашиваемый приложением список областей с разделителями-пробелами. Каждая область указывается путем добавления значения области к идентификатору ресурса (универсальному коду ресурса (URI) идентификатора приложения). В приведенном примере запроса приложению требуется разрешение на чтение календаря пользователя и отправку сообщений от его имени.

После того как пользователь введет учетные данные, конечная точка версии 2.0 проверит наличие соответствующей записи *согласия пользователя*. Если пользователь ранее не давал согласие на предоставление какого-либо из запрашиваемых разрешений, конечная точка версии 2.0 предложит пользователю сделать это.

![Предоставление разрешений рабочей учетной записью](../../media/active-directory-v2-flows/work_account_consent.png)

После того как пользователь утвердит разрешение, факт согласия будет записан, чтобы пользователю не пришлось повторно давать его при входе в учетную запись в дальнейшем.

## <a name="requesting-consent-for-an-entire-tenant"></a>Запрос на получение согласия для клиента
Часто, когда организация приобретает лицензию или подписку на приложение, планируется полностью подготовить это приложение для своих сотрудников. В ходе этого процесса администратор может предоставить этому приложению разрешение действовать от имени любого сотрудника. Если администратор предоставляет разрешения для всего клиента, то сотрудники организации не увидят страницу согласия для приложения.

Чтобы запросить согласие для всех пользователей в клиенте, приложение может использовать конечную точку предоставления согласия администратора.

## <a name="admin-restricted-scopes"></a>Области только для администраторов
Некоторые высокопривилегированные разрешения в экосистеме Майкрософт могут быть помечены как *предназначенные только для администраторов*. Ниже приведены примеры разрешений из подобных областей:

* чтение данных из каталога организации с помощью `Directory.Read`;
* запись данных в каталог организации с помощью `Directory.ReadWrite`;
* чтение групп безопасности в каталоге организации с помощью `Groups.Read.All`.

Хотя пользователь, являющийся потребителем, и может предоставить приложению доступ к таким данным, корпоративным пользователям нельзя предоставлять доступ к таким же конфиденциальным данным компании. Если приложение запрашивает доступ к одному из этих разрешений у корпоративного пользователя, появится сообщение об ошибке со сведениями о том, что этот пользователь не может предоставить разрешения приложению.

Если вашему приложению требуется доступ к областям только для администраторов организаций, следует запросить их непосредственно у администратора компании, а также с помощью конечной точки предоставления согласия администратора, как описано ниже.

Когда администратор предоставит эти разрешения через конечную точку предоставления согласия администратора, согласие получат все пользователи в клиенте.

## <a name="using-the-admin-consent-endpoint"></a>Использование конечной точки предоставления согласия администратора
Выполнив приведенные действия, приложение получит возможность получать разрешения для всех пользователей в клиенте, включая области только для администраторов. Пример кода, реализующий эти действия, см. в [примере областей только для администраторов](https://github.com/Azure-Samples/active-directory-dotnet-admin-restricted-scopes-v2).

### <a name="request-the-permissions-in-the-app-registration-portal"></a>Запрос разрешений на портале регистрации приложения
1. Перейдите к приложению на [портале регистрации приложения](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList) или [создайте приложение](active-directory-v2-app-registration.md), если это еще не сделано.
2. Найдите раздел **Разрешения Microsoft Graph** и добавьте разрешения, необходимые для приложения.
3. Обязательно **сохраните** регистрацию приложения.

### <a name="recommended-sign-the-user-in-to-your-app"></a>Выполнение входа пользователя в приложение (рекомендуется)
Как правило, при создании приложения, использующего конечную точку предоставления согласия администратора, для него нужно настроить страницу или представление, в котором администратор может утвердить разрешения приложения. Эта страница может быть частью потока регистрации приложения, параметров приложения или выделенного потока подключения. Во многих случаях разумно отображать это представление подключения в приложении только после того, как пользователь выполнил вход с помощью учебной или рабочей учетной записи Майкрософт.

При входе пользователя в приложение можно определить организацию, к которой принадлежит администратор, прежде чем запрашивать у него утверждение необходимых разрешений. Хотя это не обязательно, таким образом можно сделать пользовательский интерфейс более интуитивно понятным для сотрудников организации. Чтобы выполнить вход пользователя, следуйте нашим [указаниям в учебниках по протоколу версии 2.0](active-directory-v2-protocols.md).

### <a name="request-the-permissions-from-a-directory-admin"></a>Запрос разрешений у администратора каталога
Когда вы будете готовы запросить разрешения у администратора организации, можно будет перенаправить пользователя к *конечной точке предоставления согласия администратора* версии 2.0.

```
// Line breaks are for legibility only.

GET https://login.microsoftonline.com/{tenant}/adminconsent?
client_id=6731de76-14a6-49ae-97bc-6eba6914391e
&state=12345
&redirect_uri=http://localhost/myapp/permissions
```

```
// Pro tip: Try pasting the below request in a browser!
```

```
https://login.microsoftonline.com/common/adminconsent?client_id=6731de76-14a6-49ae-97bc-6eba6914391e&state=12345&redirect_uri=http://localhost/myapp/permissions
```

| Параметр | Условие | ОПИСАНИЕ |
| --- | --- | --- |
| tenant |Обязательно |Клиент каталога, из которого необходимо запросить разрешение. Может быть указан как GUID или в формате понятного имени, а также использоваться в универсальной ссылке с элементом common, как показано в примере. |
| client_id |Обязательно |Идентификатор приложения, присвоенный приложению на [портале регистрации приложений](https://apps.dev.microsoft.com/?referrer=https://azure.microsoft.com/documentation/articles&deeplink=/appList). |
| redirect_uri |Обязательно |Универсальный код ресурса (URI) перенаправления, на который нужно направлять ответ для обработки в приложении. Он должен в точности соответствовать одному из универсальных кодов ресурсов (URI) перенаправления, зарегистрированных на портале регистрации приложений. |
| state |Рекомендуется |Значение, включенное в запрос, которое также возвращается в ответе токена. Это может быть строка любого содержания. Используйте параметр state для кодирования сведений о состоянии пользователя в приложении перед выполнением запроса на аутентификацию. Например, это могут быть сведения об открытой на тот момент странице или представлении. |

На этом этапе Azure AD требует, чтобы администратор клиента вошел в систему, чтобы выполнить запрос. Администратору предлагается утвердить все разрешения, запрошенные для приложения на портале регистрации приложений.

#### <a name="successful-response"></a>Успешный ответ
Если администратор утверждает разрешения для приложения, то успешный ответ будет выглядеть следующим образом.

```
GET http://localhost/myapp/permissions?tenant=a8990e1f-ff32-408a-9f8e-78d3b9139b95&state=state=12345&admin_consent=True
```

| Параметр | ОПИСАНИЕ |
| --- | --- | --- |
| tenant |Клиент каталога, предоставивший приложению запрошенные разрешения, в виде GUID. |
| state |Значение, включенное в запрос, которое также возвращается в ответе маркера. Это может быть строка любого содержания. Параметр state используется для кодирования сведений о состоянии пользователя в приложении перед созданием запроса на аутентификацию, например сведений об открытой на тот момент странице или представлении. |
| admin_consent |Будет присвоено значение **true**. |

#### <a name="error-response"></a>Сообщение об ошибке
Если администратор не утверждает разрешения для приложения, то сообщение о неудачном выполнении будет выглядеть следующим образом.

```
GET http://localhost/myapp/permissions?error=permission_denied&error_description=The+admin+canceled+the+request
```

| Параметр | ОПИСАНИЕ |
| --- | --- | --- |
| error |Строка кода ошибки, которую можно использовать для классификации типов возникающих ошибок и реагирования на них. |
| error_description |Конкретное сообщение об ошибке, с помощью которого разработчик может определить причину возникновения ошибки. |

После получения успешного ответа от конечной точки предоставления согласия администратора приложение получит запрошенные разрешения. Далее вы можете запросить маркер для ресурса, который вам нужен.

## <a name="using-permissions"></a>Использование разрешений
После того как пользователь предоставит разрешения для приложения, оно может получать маркеры доступа, представляющие разрешение приложения на определенный уровень доступа к ресурсу. Маркер доступа можно использовать только для отдельного ресурса, но в этом маркере закодированы все разрешения, предоставленные приложению для данного ресурса. Чтобы получить маркер доступа, приложение может отправить запрос к конечной точке маркеров версии 2.0, как показано ниже.

```
POST common/oauth2/v2.0/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "6731de76-14a6-49ae-97bc-6eba6914391e",
    "scope": "https://outlook.office.com/mail.read https://outlook.office.com/mail.send",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "redirect_uri": "https://localhost/myapp",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

Полученный маркер доступа можно использовать в HTTP-запросах к ресурсу. Он достоверно указывает ресурсу, что у приложения имеется необходимое разрешение для выполнения определенной задачи. 

Дополнительные сведения о протоколе OAuth 2.0 и способах получения маркеров доступа можно найти в [справочнике по протоколу конечной точки версии 2.0](active-directory-v2-protocols.md).
