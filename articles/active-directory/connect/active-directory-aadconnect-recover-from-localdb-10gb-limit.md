---
title: 'Azure AD Connect: восстановление из LocalDB с ограничением в 10 ГБ | Документация Майкрософт'
description: В этой статье описывается восстановление службы синхронизации Azure AD Connect при возникновении проблемы LocalDB, связанной с ограничением в 10 ГБ.
services: active-directory
documentationcenter: ''
author: billmath
manager: mtillman
editor: ''
ms.assetid: 41d081af-ed89-4e17-be34-14f7e80ae358
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/17/2017
ms.component: hybrid
ms.author: billmath
ms.openlocfilehash: 3ba491902444c9c05f997f854353206d78f2957d
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34591278"
---
# <a name="azure-ad-connect-how-to-recover-from-localdb-10-gb-limit"></a>Azure AD Connect: восстановление из LocalDB с ограничением в 10 ГБ
Azure AD Connect требуется база данных SQL Server для хранения учетных данных. Можно использовать выпуск SQL Server 2012 Express LocalDB по умолчанию, установленный с помощью Azure AD Connect, или полную версию SQL Server. SQL Server Express налагает ограничение в размере 10 ГБ. Если при использовании LocalDB достигнут этот предел, служба синхронизации Azure AD Connect больше не сможет запускаться или выполнять синхронизацию должным образом. Эта статья содержит рекомендации по восстановлению.

## <a name="symptoms"></a>Проблемы
Существует два общих признака проблемы:

* Служба синхронизации Azure AD Connect **работает**, но синхронизация завершается сбоем с ошибкой *stopped-database-disk-full*.

* Служба синхронизации Azure AD Connect **не запускается**. Попытка запуска службы завершается сбоем (событие 6323) и сообщением об ошибке *Ошибка сервера в связи с недостатком места на диске для SQL Server*.

## <a name="short-term-recovery-steps"></a>Краткосрочные действия по восстановлению
В этом разделе описаны действия для освобождения места базы данных, необходимого для возобновления работы службы синхронизации Azure AD Connect. Для этого нужно выполнить следующие действия:
1. [Определите состояние службы синхронизации](#determine-the-synchronization-service-status).
2. [Выполните сжатие базы данных](#shrink-the-database).
3. [Удалите данные журнала выполнения](#delete-run-history-data).
4. [Сократите срок хранения данных журнала выполнения](#shorten-retention-period-for-run-history-data).

### <a name="determine-the-synchronization-service-status"></a>Определение состояния службы синхронизации
Во-первых, определите, выполняется ли служба синхронизации:

1. Войдите на сервер Azure AD Connect от имени администратора.

2. Перейдите к **диспетчеру управления службами**.

3. Проверьте состояние **службы синхронизации Microsoft Azure AD**.


4. Если она выполняется, не останавливайте и не перезапускайте службу. Пропустите шаг [сжатия базы данных](#shrink-the-database) и перейдите к шагу [удаления данных журнала выполнения](#delete-run-history-data).

5. Попытайтесь запустить службу, если она не запущена. Если служба запустилась, пропустите шаг [сжатия базы данных](#shrink-the-database) и перейдите к шагу [удаления данных журнала выполнения](#delete-run-history-data). В противном случае перейдите к шагу [сжатия базы данных](#shrink-the-database).

### <a name="shrink-the-database"></a>Сжатие базы данных
Операция сжатия позволяет освободить достаточный объем пространства базы данных, чтобы запустить службу синхронизации. При этом освобождается место в базе данных путем удаления пробелов. Этот наилучшее, но не всегда действующее решение. Дополнительные сведения об операции сжатия см. в статье [Сжатие базы данных](https://msdn.microsoft.com/library/ms189035.aspx).

> [!IMPORTANT]
> Этот шаг можно пропустить, если службу синхронизации удалось запустить. Не рекомендуется сжимать базу данных SQL, так как это может привести к снижению производительности из-за увеличения фрагментации.

Имя базы данных, созданной для Azure AD Connect, — **ADSync**. Чтобы выполнить операцию сжатия, необходимо войти от имени системного администратора или владельца базы данных. Во время установки Azure AD Connect следующим учетным записям предоставляются права системного администратора:
* локальные администраторы;
* учетная запись пользователя, которая использовалась для установки Azure AD Connect;
* учетная запись службы синхронизации, используемая для работы службы синхронизации Azure AD Connect;
* локальная группа ADSyncAdmins, которая была создана во время установки.

1. Выполните резервное копирование базы данных в безопасное расположение, скопировав файлы **ADSync.mdf** и **ADSync_log.ldf**, расположенные в `%ProgramFiles%\Microsoft Azure AD Sync\Data`.

2. Запустите сеанс PowerShell.

3. Перейдите в папку `%ProgramFiles%\Microsoft SQL Server\110\Tools\Binn`.

4. Запустите служебную программу **sqlcmd** с помощью команды `./SQLCMD.EXE -S “(localdb)\.\ADSync” -U <Username> -P <Password>`, используя учетные данные системного администратора или владельца базы данных.

5. Чтобы сжать базу данных, в командной строке sqlcmd (1>) введите `DBCC Shrinkdatabase(ADSync,1);`, а затем `GO` в следующей строке.

6. Если операция выполнена успешно, попробуйте снова запустить службу синхронизации. Если удалось запустить службу синхронизации, перейдите к шагу [удаления данных журнала выполнения](#delete-run-history-data). В противном случае обратитесь в службу поддержки.

### <a name="delete-run-history-data"></a>Удаление данных журнала выполнения
По умолчанию Azure AD Connect сохраняет данные журнала выполнения, накопленные за период до 7 дней. На этом этапе мы удалим данные журнала выполнения, чтобы освободить место в базе данных для повторного запуска службы синхронизации Azure AD Connect.

1.  Запустите **Synchronization Service Manager**, выбрав "Запуск → Служба синхронизации".

2.  Перейдите на вкладку **Операции**.

3.  В разделе **Действия** выберите **Clear Runs** (Очистить выполнения).

4.  Можно выбрать параметр **Clear all runs** (Очистить все выполнения) или **Clear runs before…<date>** (Очистить выполнения до...). Рекомендуется начать с очистки тех данных журнала выполнения, которым больше двух дней. Если вы продолжаете сталкиваться с проблемой размера базы данных, выберите параметр **Clear all runs** (Очистить все выполнения).

### <a name="shorten-retention-period-for-run-history-data"></a>Сокращение срока хранения данных журнала выполнения
Этот шаг необходим для снижения вероятности возникновения проблемы нехватки дискового пространства после нескольких циклов синхронизации.

1. Запустите новый сеанс PowerShell.

2. Запустите `Get-ADSyncScheduler` и обратите внимание на свойство PurgeRunHistoryInterval, которое указывает текущий срок хранения.

3. Выполните `Set-ADSyncScheduler -PurgeRunHistoryInterval 2.00:00:00`, чтобы установить для срока хранения значение 2 дня. Измените срок хранения соответствующим образом.

## <a name="long-term-solution--migrate-to-full-sql"></a>Долгосрочное решение. Переход на полную версию SQL Server
Эта проблема указывает на то, что текущий размер базы данных (10 ГБ) больше не достаточен для синхронизации локальной службы Active Directory с Azure AD. Рекомендуется перейти на использование полной версии SQL Server. Нельзя напрямую заменить LocalDB существующего развертывания Azure AD Connect полной версией SQL Server. Вместо этого необходимо развернуть новый сервер Azure AD Connect с полной версией SQL Server. Рекомендуется выполнить обновление со сменой сервера, при котором новый сервер Azure AD Connect (с базой данных SQL) развертывается в качестве промежуточного сервера рядом с существующим сервером Azure AD Connect (с LocalDB). 
* Инструкции по настройке удаленного экземпляра SQL Server с Azure AD Connect см.в статье [Выборочная установка Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-get-started-custom).
* Инструкции по выполнению обновления со сменой сервера для Azure AD Connect см. в разделе [Обновление со сменой сервера](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-upgrade-previous-version#swing-migration).

## <a name="next-steps"></a>Дополнительная информация
Узнайте больше об [интеграции локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md).
