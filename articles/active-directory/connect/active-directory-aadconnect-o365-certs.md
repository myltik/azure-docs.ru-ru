---
title: Обновление сертификатов для пользователей Office 365 и Azure AD | Документация Майкрософт
description: В этой статье рассматриваются способы устранения проблем с сообщениями электронной почты, уведомляющими пользователей Office 365 о необходимости обновления сертификата.
services: active-directory
documentationcenter: ''
author: billmath
manager: mtillman
editor: curtand
ms.assetid: 543b7dc1-ccc9-407f-85a1-a9944c0ba1be
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/20/2017
ms.component: hybrid
ms.author: billmath
ms.openlocfilehash: e8f6b30bb7cbe82159e86fa48721afce3f9477d8
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34591503"
---
# <a name="renew-federation-certificates-for-office-365-and-azure-active-directory"></a>Обновление сертификатов федерации для Office 365 и Azure AD
## <a name="overview"></a>Обзор
Для успешной федерации между Azure Active Directory (Azure AD) и службами федерации Active Directory (AD FS) сертификаты, используемые службами AD FS для подписывания маркеров безопасности в Azure AD, должны соответствовать параметрам, настроенным в Azure AD. Расхождение может привести к нарушению отношений доверия. Azure AD гарантирует, что эта информация синхронизируется при развертывании AD FS и прокси веб-приложения (для доступа к экстрасети).

В этой статье представлены дополнительные сведения об управлении сертификатами для подписи маркеров и их синхронизации с Azure AD в следующих случаях:

* Вы не развертываете прокси веб-приложения, поэтому метаданные федерации недоступны в экстрасети.
* Вы не применяете стандартную конфигурацию AD FS к сертификатам для подписи маркеров.
* Вы используете сторонний поставщик удостоверений.

## <a name="default-configuration-of-ad-fs-for-token-signing-certificates"></a>Стандартная конфигурация AD FS для сертификатов для подписи маркеров
Сертификаты для подписи маркеров и их расшифровки обычно представляют собой самозаверяющие сертификаты со сроком годности в один год. По умолчанию AD FS предусматривает процесс автоматического возобновления действия, который называется **AutoCertificateRollover**. Если вы используете AD FS 2.0 или более поздней версии, службы Office 365 и Azure AD автоматически обновят ваш сертификат до окончания срока его действия.

### <a name="renewal-notification-from-the-office-365-portal-or-an-email"></a>Уведомление о возобновлении действия на портале Office 365 или по электронной почте
> [!NOTE]
> Если вы получите через портал или по электронной почте уведомление о том, что необходимо возобновить действие сертификата для Office, см. раздел об [управлении изменениями в сертификатах для подписи маркеров](#managecerts). Так вы сможете узнать, нужно ли предпринимать какие-либо действия. Корпорации Майкрософт известно о потенциальной проблеме, в результате которой могут отправляться уведомления о возобновлении действия сертификата, даже если никаких действий не требуется.
>
>

Azure AD пытается отслеживать метаданные федерации и обновлять сертификаты для подписи маркеров, как указано в этих метаданных. За 30 дней до истечения срока действия сертификатов для подписи маркеров Azure AD проверит, доступны ли новые сертификаты, путем опроса метаданных федерации.

* Если метаданные федерации успешно опрошены и получены новые сертификаты, пользователь не будет получать уведомление по электронной почте или предупреждение через портал Office 365.
* Если новые сертификаты для подписи маркеров не удалось получить, потому что метаданные федерации недоступны или автоматическая смена сертификатов не включена, Azure AD отправит соответствующее уведомление по электронной почте, а на портале Office 365 появится предупреждение.

![Уведомление на портале Office 365](./media/active-directory-aadconnect-o365-certs/notification.png)

> [!IMPORTANT]
> Чтобы обеспечить непрерывность бизнес-процессов при использовании AD FS, проверьте, установлены ли на ваших серверах следующие обновления, предотвращающие ошибки проверки подлинности при известных проблемах. Это позволит устранить известные проблемы с прокси-сервером AD FS при текущем и последующем возобновлении действия сертификатов.
>
> Server 2012 R2 — [Накопительный пакет обновления от мая 2014 г. для Windows RT 8.1, Windows 8.1 и Windows Server 2012 R2](http://support.microsoft.com/kb/2955164).
>
> Server 2008 R2 и 2012 — [Authentication through proxy fails in Windows Server 2012 or Windows Server 2008 R2 SP1](http://support.microsoft.com/kb/3094446)
>
>

## Проверка необходимости в обновлении сертификатов <a name="managecerts"></a>
### <a name="step-1-check-the-autocertificaterollover-state"></a>Шаг 1. Проверка состояния свойства AutoCertificateRollover
На сервере AD FS откройте PowerShell. Удостоверьтесь, что для AutoCertificateRollover задано значение True.

    Get-Adfsproperties

![AutoCertificateRollover](./media/active-directory-aadconnect-o365-certs/autocertrollover.png)

>[!NOTE] 
>При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.

### <a name="step-2-confirm-that-ad-fs-and-azure-ad-are-in-sync"></a>Шаг 2. Убедитесь, что службы AD FS и Azure AD синхронизированы
На сервере AD FS откройте командную строку Azure AD PowerShell и подключитесь к Azure AD.

> [!NOTE]
> Вы можете скачать Azure AD PowerShell [здесь](https://technet.microsoft.com/library/jj151815.aspx).
>
>

    Connect-MsolService

Проверьте сертификаты, настроенные в AD FS, и свойства доверия Azure AD для указанного домена.

    Get-MsolFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate

![Get-MsolFederationProperty](./media/active-directory-aadconnect-o365-certs/certsync.png)

Если отпечатки в обоих наборах выходных данных совпадают, значит, сертификаты синхронизируются с Azure AD.

### <a name="step-3-check-if-your-certificate-is-about-to-expire"></a>Шаг 3. Проверьте, не истекает ли срок действия сертификата
В выходных данных Get-MsolFederationProperty или Get-AdfsCertificate проверьте дату, указанную после строки Not After. Если эта дата наступает менее чем через 30 дней, следует принять меры.

| AutoCertificateRollover | Сертификаты синхронизированы с Azure AD | Метаданные федерации общедоступны | Срок действия | Действие |
|:---:|:---:|:---:|:---:|:---:|
| Yes |Yes |Yes |- |Никаких действий не требуется. См. раздел [Автоматическое возобновление действия сертификата для подписи маркера](#autorenew). |
| Yes |Нет  |- |Менее 15 дней |Обновите немедленно. См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew). |
| Нет  |- |- |Менее 30 дней |Обновите немедленно. См. раздел [Возобновление действия сертификата для подписи маркера вручную](#manualrenew). |

\[-] — не имеет значения

## Автоматическое возобновление действия сертификата для подписи маркера (рекомендуется) <a name="autorenew"></a>
Если приведенные ниже условия выполняются, ничего не нужно делать вручную.

* Вы развернули прокси веб-приложения, предоставляющий доступ к метаданным федерации из экстрасети.
* Вы используете стандартную конфигурацию AD FS (свойство AutoCertificateRollover включено).

Проверьте следующие пункты, чтобы удостовериться, что действие сертификата может обновляться автоматически.

**1. Для свойства AutoCertificateRollover служб AD FS должно быть задано значение True.** Это указывает на то, что службы AD FS будут автоматически создавать сертификаты для подписи маркеров и их расшифровки до окончания срока действия старых.

**2. Метаданные федерации AD FS общедоступны.** Убедитесь, что метаданные федерации доступны для общего пользования через Интернет (за пределами корпоративной сети), перейдя со своего компьютера по следующему URL-адресу.

https://(ваше_имя_FS)/federationmetadata/2007-06/federationmetadata.xml

где `(your_FS_name) `заменяется именем узла службы федерации, которое используется в вашей организации (например, fs.contoso.com).  Если проверка двух этих параметров оказалась успешной, вам больше не нужно ничего делать.  

Пример: https://fs.contoso.com/federationmetadata/2007-06/federationmetadata.xml
## Возобновление действия сертификата для подписи маркера вручную <a name="manualrenew"></a>
Сертификаты для подписи маркеров можно обновить вручную. Например, в следующих сценариях лучше выполнять ручное обновление.

* Сертификаты для подписи маркеров не являются самозаверяющими. Вероятнее всего, это происходит потому, что ваша организация использует сертификаты AD FS, зарегистрированные в центре сертификации организации.
* В системе безопасности сети запрещен общий доступ к метаданным федерации.

В этих ситуациях при каждом обновлении сертификатов для подписи маркеров также необходимо обновить домен Office 365 с помощью команды PowerShell Update-MsolFederatedDomain.

### <a name="step-1-ensure-that-ad-fs-has-new-token-signing-certificates"></a>Шаг 1. Убедитесь, что в службах AD FS используются новые сертификаты для подписи маркеров
**Нестандартная конфигурация**

Если применяется нестандартная конфигурация AD FS (где значение свойства **AutoCertificateRollover** равно **False**), вероятно, вы используете настраиваемые (не самозаверяющие) сертификаты. Дополнительные сведения об обновлении сертификатов для подписи маркеров AD FS см. в разделе [Рекомендации для клиентов, не использующих самозаверяющие сертификаты AD FS](https://msdn.microsoft.com/library/azure/JJ933264.aspx#BKMK_NotADFSCert).

**Метаданные федерации не являются общедоступными**

С другой стороны, если значение свойства **AutoCertificateRollover** равно **True**, но метаданные федерации не являются общедоступными, сначала удостоверьтесь, что сертификаты для подписи маркеров созданы службами AD FS. Чтобы убедиться, что у вас есть новые сертификаты для подписи маркеров, сделайте следующее:

1. Удостоверьтесь, что вы вошли на основной сервер AD FS.
2. Проверьте текущие сертификаты подписи в AD FS, открыв командное окно PowerShell и выполнив следующую команду.

    PS C:\>Get-ADFSCertificate –CertificateType token-signing

   > [!NOTE]
   > При использовании AD FS 2.0 необходимо сначала выполнить команду Add-Pssnapin Microsoft.Adfs.Powershell.
   >
   >
3. Просмотрите данные, которые будут выведены для всех сертификатов в списке. Если служба AD FS создала сертификат, вы увидите два сертификата в выходных данных: один, для которого значение **IsPrimary** равно **True**, а дата **NotAfter** равна 5 дней; второй, для которого значение **IsPrimary** равно **False**, а дата **NotAfter** равна приблизительно году.
4. Если вы видите только один сертификат, а дата **NotAfter** равна 5 дням, необходимо создать сертификат.
5. Чтобы создать сертификат, в командной строке PowerShell выполните такую команду: `PS C:\>Update-ADFSCertificate –CertificateType token-signing`.
6. Проверьте обновление, запустив следующую команду еще раз: PS C:\>Get-ADFSCertificate –CertificateType token-signing

Теперь должны появиться два сертификата, один из которых имеет дату **NotAfter**, равную приблизительно году, и у которого значение параметра **IsPrimary** равно **False**.

### <a name="step-2-update-the-new-token-signing-certificates-for-the-office-365-trust"></a>Шаг 2. Обновление новых сертификатов для подписи маркеров для использования в отношениях доверия Office 365
Выполните описанные ниже действия, чтобы добавить в Office 365 новые сертификаты для подписи маркеров, которые будут использоваться в отношениях доверия.

1. Откройте модуль Microsoft Azure Active Directory для Windows PowerShell.
2. Запустите $cred=Get-Credential. Если этот командлет запрашивает учетные данные, введите данные учетной записи администратора облачных служб.
3. Запустите Connect-MsolService –Credential $cred. Этот командлет подключит вас к облачной службе. Перед выполнением любых дополнительных командлетов, установленных с помощью средства, необходимо создать контекст, который подключит вас к облачной службе.
4. Если эти команды выполняются на компьютере, который не является основным сервером федерации AD FS, выполните команду Set-MSOLAdfscontext -Computer &lt;основной сервер AD FS&gt;, где &lt;основной сервер AD FS&gt; — это внутреннее полное доменное имя основного сервера AD FS. Этот командлет создает контекст, подключающий вас к AD FS.
5. Выполните Update-MSOLFederatedDomain –DomainName &lt;домен&gt;. Этот командлет обновляет параметры AD FS в облачной службе и настраивает отношения доверия между ними.

> [!NOTE]
> Если требуется поддержка нескольких доменов верхнего уровня, например contoso.com и fabrikam.com, то необходимо использовать параметр **SupportMultipleDomain** с любыми командлетами. Дополнительные сведения см. в статье [Поддержка нескольких доменов для федерации с Azure AD](active-directory-aadconnect-multiple-domains.md).
>


## Восстановление доверия Azure AD с помощью Azure AD Connect <a name="connectrenew"></a>
Если вы настроили ферму AD FS и доверие Azure AD, используя Azure AD Connect, то с помощью Azure AD Connect можно определить, нужно ли выполнять какие-либо действия с сертификатами для подписи маркеров. Если требуется обновить сертификаты, используйте Azure AD Connect.

Дополнительные сведения см. в разделе [Восстановление доверия](active-directory-aadconnect-federation-management.md).

## <a name="ad-fs-and-azure-ad-certificate-update-steps"></a>Действия по обновлению сертификата в AD FS и Azure AD
Сертификаты для подписи маркеров — это стандартные сертификаты X509, которые используются для безопасного подписания всех маркеров, издаваемых сервером федерации. Сертификаты для расшифровки маркеров — это стандартные сертификаты X509, которые используются для расшифровки любых входящих маркеров. 

По умолчанию в AD FS автоматически создаются сертификаты для подписи и расшифровки маркеров, когда выполняется начальная настройка и приближается дата окончания срока действия.

За 30 дней до истечения срока действия текущего сертификата в Azure AD выполняется попытка получить новый сертификат из метаданных службы федерации. Если новый сертификат в этот момент недоступен, Azure AD будет постоянно отслеживать метаданные с интервалом в сутки. Когда новый сертификат станет доступен в метаданных, параметры федерации домена обновятся с учетом данных нового сертификата. Вы можете воспользоваться командой `Get-MsolDomainFederationSettings`, чтобы проверить наличие нового сертификата в NextSigningCertificate / SigningCertificate.

Дополнительные сведения о сертификатах для подписи маркеров в AD FS см. в статье [Obtain and Configure TS and TD Certificates for AD FS](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/configure-ts-td-certs-ad-fs) (Получение и настройка сертификатов для подписи и расшифровки маркеров для AD FS).
