---
title: Синхронизация Azure Active Directory Connect. Настройка предпочтительного расположения данных для поддержки нескольких регионов в Office 365 | Документация Майкрософт
description: Из этой статьи вы узнаете, как разместить ресурсы Office 365 в удобном для пользователей расположении при помощи синхронизации Azure Active Directory Connect.
services: active-directory
documentationcenter: ''
author: billmath
manager: mtillman
editor: ''
ms.assetid: ''
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/16/2018
ms.component: hybrid
ms.author: billmath
ms.openlocfilehash: 5eae173e02c92bd43faaa9533ce29489d40f1389
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34592931"
---
# <a name="azure-active-directory-connect-sync-configure-preferred-data-location-for-office-365-resources"></a>Синхронизация Azure Active Directory Connect. Настройка предпочтительного расположения данных для ресурсов Office 365
В этой статье предоставлены сведения о настройке атрибута для предпочтительного расположения данных в службах синхронизации Azure Active Directory (Azure AD) Connect. Когда кто-то использует поддержку нескольких регионов в Office 365, этот атрибут используется для обозначения географического расположения данных пользователя в Office 365. (Термины *регион* и *геообъект* являются взаимозаменяемыми.)

## <a name="enable-synchronization-of-preferred-data-location"></a>Включение синхронизации предпочтительного расположения данных
По умолчанию ресурсы Office 365 для пользователей находятся в том же геообъекте, что и ваш клиент Azure AD. Например, если клиент находится в Северной Америке, то почтовые ящики Exchange пользователей также расположены в Северной Америке. Для международной организации это может быть не самым оптимальным решением.

Установив атрибут **preferredDataLocation**, можно задать геообъект пользователя. Вы сможете работать с ресурсами пользователя Office 365, например с почтовым ящиком и OneDrive, в том же геообъекте, что и пользователь, а также использовать один клиент для всей организации.

> [!IMPORTANT]
> Размещение в различных регионах доступно клиентам с не менее 5000 подписками служб Office 365. Обратитесь к представителю корпорации Майкрософт, чтобы получить дополнительные сведения.
>
>

Список всех геообъектов для Office 365 можно найти на странице [Где находятся ваши данные?](https://aka.ms/datamaps)

Доступные геообъекты для поддержки нескольких регионов в Office 365:

| Географические | Значение preferredDataLocation |
| --- | --- |
| Азиатско-Тихоокеанский регион | APC |
| Австралия | AUS |
| Канада | CAN |
| Европейский союз | EUR |
| Индия | IND |
| Япония | JPN |
| Корея | KOR |
| Великобритания | GBR |
| США | NAM |

* Если геообъект отсутствует в этой таблице, как, например, Южная Америка, значит он не используется для поддержки нескольких регионов.
* Геообъект "Индия" доступен только для клиентов с адресами для выставления счетов и лицензиями, приобретенными в этом геообъекте.
* Не все рабочие нагрузки Office 365 поддерживают настройку геообъекта пользователя.

### <a name="azure-ad-connect-support-for-synchronization"></a>Поддержка Azure AD Connect для синхронизации

Azure AD Connect поддерживает синхронизацию атрибута **preferredDataLocation** для объектов **User** в версии 1.1.524.0 и более поздних версиях. В частности:

* Схема типа объекта **User** в соединителе Azure AD расширена для включения атрибута **preferredDataLocation**. Этот атрибут является строкой с одним значением.
* Схема типа объекта **Person** в метавселенной расширена для включения атрибута **preferredDataLocation**. Этот атрибут является строкой с одним значением.

По умолчанию **preferredDataLocation** не включен для синхронизации. Эта функция предназначена для более крупных организаций. Кроме того, необходимо определить атрибут для фиксации геообъекта Office 365 для пользователей, так как **preferredDataLocation** отсутствует в локальном экземпляре Active Directory. Этот атрибут будет индивидуальным для каждой организации.

> [!IMPORTANT]
> Azure AD позволяет непосредственно настроить атрибут **preferredDataLocation** для облачных объектов **User** с помощью Azure AD PowerShell. Возможность непосредственно настроить атрибут **preferredDataLocation** для **синхронизированных объектов User** в Azure AD с помощью Azure AD PowerShell отсутствует. Чтобы настроить этот атрибут для **синхронизированных объектов User**, необходимо использовать Azure AD Connect.

Перед включением синхронизации выполните следующее:

* Определите, какой атрибут локального каталога Active Directory следует использовать в качестве исходного атрибута. Он должен быть **строкой с одним значением**. В следующих инструкциях используется один из атрибутов **extensionAttribute**.
* Если ранее с помощью Azure AD PowerShell в Azure AD вы настроили атрибут **preferredDataLocation** для имеющихся **синхронизированных объектов User**, необходимо перенести значения атрибутов для соответствующих объектов **User** в локальном каталоге Active Directory.

    > [!IMPORTANT]
    > В противном случае после включения синхронизации атрибута **preferredDataLocation** Azure AD Connect удалит существующие значения атрибутов в Azure AD.

* Настройте исходный атрибут по меньшей мере на двух локальных объектах User Active Directory. Позже его можно использовать для проверки.

В следующих разделах описаны шаги по включению синхронизации атрибута **preferredDataLocation**.

> [!NOTE]
> Они описаны в контексте развертывания Azure AD в топологии с отдельным лесом и без пользовательских правил синхронизации. Если используется топология с несколькими лесами, которые настроены при помощи пользовательских правил синхронизации или промежуточного сервера, необходимо соответствующим образом изменить действия.

## <a name="step-1-disable-sync-scheduler-and-verify-there-is-no-synchronization-in-progress"></a>Шаг 1. Отключение планировщика синхронизации и остановка синхронизации
Изменяя правила синхронизации, убедитесь, что синхронизация не выполняется, во избежание экспорта непреднамеренных изменений в Azure AD. Чтобы отключить встроенный планировщик синхронизации, сделайте следующее:

1. Запустите сеанс PowerShell на сервере Azure AD Connect.
2. Отключите плановую синхронизацию, выполнив командлет `Set-ADSyncScheduler -SyncCycleEnabled $false`.
3. Запустите **Synchronization Service Manager**, выбрав **Пуск** > **Служба синхронизации**.
4. Перейдите на вкладку **Операции** и убедитесь, что на ней не отображаются операции в состоянии *Выполняется*.

![Снимок экрана Synchronization Service Manager](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step1.png)

## <a name="step-2-add-the-source-attribute-to-the-on-premises-active-directory-connector-schema"></a>Шаг 2. Добавление исходного атрибута в схему локального соединителя Active Directory
Не все атрибуты Azure AD импортируются в пространство локального соединителя Active Directory. Если вы решили использовать атрибут, не синхронизируемый по умолчанию, то его необходимо импортировать. Чтобы добавить исходный атрибут в список импортируемых атрибутов, сделайте следующее.

1. Откройте вкладку **Соединители** в Synchronization Service Manager.
2. Щелкните правой кнопкой мыши локальный соединитель Active Directory и выберите **Свойства**.
3. Во всплывающем диалоговом окне перейдите на вкладку **Выбор атрибутов**.
4. Убедитесь, что нужный исходный атрибут выбран из списка атрибутов. Если атрибут не отображается, щелкните флажок **Show All** (Показать все).
5. Чтобы сохранить, нажмите кнопку **ОК**.

![Снимок экрана Synchronization Service Manager и диалоговое окно свойств](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step2.png)

## <a name="step-3-add-preferreddatalocation-to-the-azure-ad-connector-schema"></a>Шаг 3. Добавление **preferredDataLocation** в схему соединителя Azure AD
По умолчанию атрибут **preferredDataLocation** не импортируется в пространство Azure AD Connect. Чтобы добавить его в список импортированных атрибутов, выполните следующее:

1. Откройте вкладку **Соединители** в Synchronization Service Manager.
2. Щелкните правой кнопкой мыши соединитель Azure AD и выберите **Свойства**.
3. Во всплывающем диалоговом окне перейдите на вкладку **Выбор атрибутов**.
4. Выберите атрибут **preferredDataLocation** в списке.
5. Чтобы сохранить, нажмите кнопку **ОК**.

![Снимок экрана Synchronization Service Manager и диалоговое окно свойств](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step3.png)

## <a name="step-4-create-an-inbound-synchronization-rule"></a>Шаг 4. Создание правила входящей синхронизации
Правило входящей синхронизации позволяет передавать значение исходного атрибута из локального каталога Active Directory в метавселенную.

1. Запустите **редактор правил синхронизации**, выбрав **Пуск** > **Synchronization Rules Editor** (Редактор правил синхронизации).
2. В фильтре поиска для параметра **Направление** задайте значение **Входящие**.
3. Чтобы создать правило входящей синхронизации, нажмите кнопку **Добавить правило**.
4. На вкладке **Описание** укажите следующую конфигурацию.

    | Атрибут | Значение | Сведения |
    | --- | --- | --- |
    | ИМЯ | *Укажите имя* | Например, In from AD – User PreferredDataLocation. |
    | ОПИСАНИЕ | *Введите пользовательское описание* |  |
    | Подключенная система | *Выберите локальный соединитель Active Directory* |  |
    | Тип объекта подключенной системы | **User** |  |
    | Тип объекта метавселенной | **Person** |  |
    | Тип связи | **Join** |  |
    | Приоритет | *Выберите число от 1 до 99* | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Оставьте значение **Scoping filter** (Фильтр области) пустым, чтобы включить все объекты. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.
6. Перейдите на вкладку **Преобразование** и реализуйте следующее правило преобразования.

    | Flow type (Тип потока) | Целевой атрибут | Источник | Применить однократно | Merge Type (Тип объединения) |
    | --- | --- | --- | --- | --- |
    |Напрямую | preferredDataLocation | Выберите исходный атрибут. | Флажок снят. | Блокировка изменений |

7. Чтобы создать правило входящей синхронизации, нажмите кнопку **Добавить**.

![Снимок экрана Create inbound synchronization rule (Создание правила входящей синхронизации)](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step4.png)

## <a name="step-5-create-an-outbound-synchronization-rule"></a>Шаг 5. Создание правила исходящей синхронизации
Правило исходящей синхронизации позволяет передать значение атрибута из метавселенной в атрибут **preferredDataLocation** в Azure AD.

1. Перейдите в **редактор правил синхронизации**.
2. В фильтре поиска для параметра **Направление** задайте значение **Исходящие**.
3. Нажмите кнопку **Добавить правило**.
4. На вкладке **Описание** укажите следующую конфигурацию.

    | Атрибут | Значение | Сведения |
    | ----- | ------ | --- |
    | ИМЯ | *Укажите имя* | Например, Out to AAD – User PreferredDataLocation. |
    | ОПИСАНИЕ | *Укажите описание* ||
    | Подключенная система | *Выберите соединитель Azure AD* ||
    | Тип объекта подключенной системы | **User** ||
    | Тип объекта метавселенной | **Person** ||
    | Тип связи | **Join** ||
    | Приоритет | *Выберите число от 1 до 99* | Значения 1–99 зарезервированы для настраиваемых правил синхронизации. Не выбирайте значение, которое используется в другом правиле синхронизации. |

5. Перейдите на вкладку **Scoping filter** (Фильтр области) и добавьте отдельную группу фильтра области с двумя предложениями.

    | Атрибут | Оператор | Значение |
    | --- | --- | --- |
    | sourceObjectType | EQUAL | Пользователь |
    | cloudMastered | NOTEQUAL | Истина |

    Фильтр области определяет объекты Azure AD, к которым применяется данное правило исходящей синхронизации. В этом примере мы используем фильтр области из стандартного правила синхронизации OOB — Out to AD – User Identity. Он предотвращает применение правила синхронизации к объектам **User** в локальном каталоге Active Directory, которые не синхронизируются. Возможно, вам необходимо настроить фильтр области в соответствии с развертыванием Azure AD Connect.

6. Перейдите на вкладку **Преобразование** и реализуйте следующее правило преобразования.

    | Flow type (Тип потока) | Целевой атрибут | Источник | Применить однократно | Merge Type (Тип объединения) |
    | --- | --- | --- | --- | --- |
    | Напрямую | preferredDataLocation | preferredDataLocation | Флажок снят. | Блокировка изменений |

7. Щелкните **Добавить**, чтобы создать правило исходящей синхронизации.

![Снимок экрана Create outbound synchronization rule (Создание правила исходящей синхронизации)](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-step5.png)

## <a name="step-6-run-full-synchronization-cycle"></a>Шаг 6. Запуск полного цикла синхронизации
Как правило, полный цикл синхронизации обязателен, так как вы добавили новые атрибуты в схемы Active Directory и соединителя Azure AD, а также ввели настраиваемые правила синхронизации. Проверьте изменения перед их экспортом в Azure AD. Проверить изменения во время ручного выполнения действий, составляющих полный цикл синхронизации, можно с помощью следующих инструкций.

1. Выполните **полный импорт** для локального соединителя Active Directory.

   1. Откройте вкладку **Operations** (Операции) в Synchronization Service Manager.
   2. Щелкните правой кнопкой мыши **локальный соединитель Active Directory** и выберите **Запустить**.
   3. В диалоговом окне выберите **Full Import** (Полный импорт), а затем нажмите кнопку **ОК**.
   4. Дождитесь завершения операции.

    > [!NOTE]
    > Полный импорт локального соединителя Active Directory можно пропустить, если исходный атрибут уже включен в список импортируемых атрибутов. Другими словами, можно было не вносить изменения во время выполнения шага 2 в этой статье.

2. Выполните **полный импорт** для соединителя Azure AD.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Запустить**.
   2. В диалоговом окне выберите **Full Import** (Полный импорт), а затем нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

3. Проверьте изменения правила синхронизации на имеющемся объекте **User**.

   Исходный атрибут из локального каталога Active Directory и атрибут **preferredDataLocation** из Azure AD были импортированы в каждое соответствующее пространство соединителя. Перед выполнением шага полной синхронизации выполните предварительный просмотр имеющегося объекта **User** в пространстве локального соединителя Active Directory. У выбранного объекта должен быть заполнен исходный атрибут. Если при предварительном просмотре атрибут **preferredDataLocation** успешно заполнен в метавселенной, то это хороший показатель того, что вы верно настроили правила синхронизации. Сведения о том, как выполнить предварительный просмотр, см. в разделе [Проверка изменений](active-directory-aadconnectsync-change-the-configuration.md#verify-the-change).

4. Выполните **полную синхронизацию** для локального соединителя Active Directory.

   1. Щелкните правой кнопкой мыши **локальный соединитель Active Directory** и выберите **Запустить**.
   2. В диалоговом окне выберите **Full Synchronization** (Полная синхронизация), а затем нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

5. Проверьте **ожидающие операции экспорта** в Azure AD.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Search Connector Space** (Поиск пространства соединителя).
   2. В диалоговом окне **Search Connector Space** (Поиск пространства соединителя) сделайте следующее.

        a. Для параметра **Scope** (Область) укажите значение **Pending Export** (Ожидающая операция экспорта).<br>
        Б. Установите все три флажка: **"Добавить", "Изменить" и "Удалить"**.<br>
        c. Чтобы получить список объектов с изменениями для экспорта, нажмите кнопку **Поиск**. Чтобы проверить изменения указанного объекта, дважды щелкните его.<br>
        d. Убедитесь, что изменения являются ожидаемыми.

6. Выполните **экспорт** в **соединителе Azure AD**.

   1. Щелкните правой кнопкой мыши **соединитель Azure AD** и выберите **Запустить**.
   2. В диалоговом окне **Run Connector** (Запуск соединителя) выберите **Экспорт**, а затем нажмите кнопку **ОК**.
   3. Дождитесь завершения операции.

> [!NOTE]
> Вы можете заметить, что инструкции для соединителя Azure AD не содержат шагов полной синхронизации и экспорта для соединителя Azure AD. Они и не требуются, так как значения атрибутов передаются только из локального каталога Active Directory в Azure AD.

## <a name="step-7-re-enable-sync-scheduler"></a>Шаг 7. Повторное включение планировщика синхронизации
Повторно включите встроенный планировщик синхронизации.

1. Запустите сеанс PowerShell.
2. Повторно включите плановую синхронизацию, выполнив командлет `Set-ADSyncScheduler -SyncCycleEnabled $true`.

## <a name="step-8-verify-the-result"></a>Шаг 8. Проверка результата
Теперь можно проверить конфигурацию и активировать ее для пользователей.

1. Добавьте геообъект в выбранный атрибут для пользователя. Список доступных геообъектов можно найти в [этой таблице](#enable-synchronization-of-preferreddatalocation).  
![Снимок экрана с атрибутом AD, добавленным для пользователя](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-adattribute.png)
2. Дождитесь, пока атрибут будет синхронизирован с Azure AD.
3. При помощи Exchange Online PowerShell проверьте, правильно ли установлен регион почтового ящика.  
![Снимок экрана Exchange Online PowerShell](./media/active-directory-aadconnectsync-feature-preferreddatalocation/preferreddatalocation-mailboxregion.png)  
Учитывая, что клиент отмечен для использования этой функции, почтовый ящик перемещен в правильный геообъект. В этом можно убедиться, просмотрев имя сервера, на котором размещен почтовый ящик.
4. Чтобы проверить, работает ли этот параметр для нескольких почтовых ящиков, используйте скрипт из [коллекции TechNet](https://gallery.technet.microsoft.com/office/PowerShell-Script-to-a6bbfc2e). Этот скрипт также содержит список всех префиксов серверов в центрах обработки данных Office 365 с указанием геообъектов, в которых размещены серверы. С его помощью можно проверить расположение почтового ящика на предыдущем шаге.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о поддержке нескольких регионов в Office 365:

* [Сеансы с несколькими регионами в Ignite](https://aka.ms/MultiGeoIgnite)
* [Сеансы с несколькими регионами в OneDrive](https://aka.ms/OneDriveMultiGeo)
* [Сеансы с несколькими регионами в SharePoint Online](https://aka.ms/SharePointMultiGeo)

Дополнительные сведения о модели конфигурации в модуле синхронизации:

* Дополнительные сведения о модели конфигурации, см. в статье о [принципах декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning.md).
* Дополнительные сведения о языке выражений см. в статье [Служба синхронизации Azure AD Connect: общие сведения о выражениях декларативной подготовки](active-directory-aadconnectsync-understanding-declarative-provisioning-expressions.md).

Обзорные статьи:

* [Службы синхронизации Azure AD Connect: общие сведений о синхронизации и ее настройка](active-directory-aadconnectsync-whatis.md)
* [Интеграция локальных удостоверений с Azure Active Directory](active-directory-aadconnect.md)
