---
title: Настройка времени жизни маркеров в Azure Active Directory | Документация Майкрософт
description: Сведения о настройке времени жизни маркеров, выданных Azure AD.
services: active-directory
documentationcenter: ''
author: hpsin
manager: mtillman
editor: ''
ms.assetid: 06f5b317-053e-44c3-aaaa-cf07d8692735
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/19/2018
ms.author: hirsin
ms.custom: aaddev
ms.reviewer: anchitn
ms.openlocfilehash: a62d7a36eeb84b06baa4f2968d48f4a7afcaa05d
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32140088"
---
# <a name="configurable-token-lifetimes-in-azure-active-directory-public-preview"></a>Настройка времени жизни маркеров в Azure Active Directory (общедоступная предварительная версия)
Вы можете указать время жизни маркера, выданного Azure Active Directory (Azure AD). Время жизни маркеров можно настроить для всех приложений в организации, для многопользовательского приложения (приложения для нескольких организаций) или для определенного субъекта-службы в организации.

> [!IMPORTANT]
> Получив мнение клиентов на этапе предварительной версии, мы планируем заменить эту функцию новой функцией условного доступа Azure Active Directory.  Когда новая функция будет готова, данная функция будет считаться нерекомендуемой по истечении периода уведомления.  При использовании политики настраиваемого времени существования маркеров будьте готовы перейти на новую функцию условного доступа, когда она станет доступна. 
>
>

В Azure AD объект политики представлен набором правил, которые применяются к отдельным приложениям или ко всем приложениям в организации. Каждый тип политики имеет уникальную структуру и набор свойств, которые применяются к объектам, для которых назначена эта политика.

Для организации можно назначить политику по умолчанию. Она будет применяться ко всем приложениям в организации, если только не будет переопределена политикой с более высоким приоритетом. Политику можно также назначить и для отдельных приложений. Приоритетность политики определяется ее типом.

> [!NOTE]
> Настраиваемые политики времени существования токенов не поддерживается в SharePoint Online.  Хотя имеется возможность создать такую политику с помощью PowerShell, SharePoint Online не признает ее. Ознакомьтесь с [блогом о SharePoint Online](https://techcommunity.microsoft.com/t5/SharePoint-Blog/Introducing-Idle-Session-Timeout-in-SharePoint-and-OneDrive/ba-p/119208), чтобы получить дополнительные сведения о настройке времени ожидания бездействующих сеансов.
>* Время существования по умолчанию для маркера доступа SharePoint Online составляет 1 час. 
>* Максимальный период бездействия по умолчанию для маркера обновления SharePoint Online составляет 90 дней.
>

## <a name="token-types"></a>Типы маркеров

Политики времени жизни маркера можно настроить для маркеров обновления, маркеров доступа, маркеров сеансов и маркеров идентификации.

### <a name="access-tokens"></a>Маркеры доступа
Чтобы получить доступ к защищенному ресурсу, клиенты используют маркеры доступа. Маркер доступа можно использовать только для конкретного сочетания пользователя, клиентского приложения и ресурса. Маркеры доступа не могут быть отозваны. Они действуют до истечения срока своего действия. Вредоносный субъект, получивший маркер доступа, сможет использовать его на протяжении всего времени жизни. Настройка времени жизни маркера доступа — это компромисс между производительностью системы и временем, в течение которого клиентское приложение сохраняет доступ после отключения учетной записи пользователя. Чтобы повысить производительность системы, нужно минимизировать частоту обращений клиентского приложения за обновленным маркером доступа.  Значение по умолчанию — 1 час. По прошествии этого времени клиент должен использовать маркер обновления, чтобы (обычно это происходит автоматически) получить новый маркер обновления и маркер доступа. 

### <a name="refresh-tokens"></a>Маркеры обновления
Когда клиентское приложение обращается за маркером доступа для доступа к защищенному ресурсу, клиент также получает маркер обновления. Маркер обновления используется для получения новой пары маркеров доступа и обновления, когда истечет срок действия маркера доступа. Маркер обновления привязан одновременно и к пользователю, и клиентскому приложению. Маркер обновления можно [отменить в любой момент](develop/active-directory-token-and-claims.md#token-revocation), и при каждом использовании проверяется его действительность.  

Важно различать конфиденциальные и общедоступные клиентские приложения. Это влияет на продолжительность использования маркеров обновления. Дополнительные сведения о различных типах клиентов см. в разделе [RFC 6749](https://tools.ietf.org/html/rfc6749#section-2.1).

#### <a name="token-lifetimes-with-confidential-client-refresh-tokens"></a>Время жизни маркера для маркеров обновления конфиденциального клиента
Конфиденциальные клиенты — это такие клиентские приложения, которые могут безопасно хранить клиентский пароль (секрет), с помощью которого можно подтвердить, что запросы поступают от защищенного клиентского приложения, а не от вредоносного субъекта. Например, веб-приложение является конфиденциальным клиентом, так как оно может хранить секрет клиента на веб-сервере, и потому он остается невидимым. Так как такие последовательности достаточно безопасные, для них по умолчанию устанавливается время жизни выпускаемых маркеров обновления `until-revoked`, и этот срок нельзя изменить с помощью политики или отменить при необязательном сбросе пароля.

#### <a name="token-lifetimes-with-public-client-refresh-tokens"></a>Время жизни маркеров для маркеров обновления общедоступного клиента

Общедоступные клиенты не могут обеспечить безопасное хранение клиентского пароля (секрета). Например, приложение iOS или Android не может замаскировать секрет от владельца ресурса, и поэтому считается общедоступным клиентом. Для ресурсов можно определить политики, которые запрещают маркерам обновления из общедоступных клиентских приложений, которые старше указанного периода, получать новую пару маркеров доступа и обновления. (Для этого воспользуйтесь свойством максимального времени неактивности для маркеров обновления (`MaxInactiveTime`).) Кроме того, с помощью политик можно задать период времени, по истечении которого маркеры обновления больше не принимаются. (Для этого воспользуйтесь свойством максимального возраста маркеров обновления.) Настроив время жизни маркера обновления, вы можете управлять частотой, с которой пользователь должен повторно вводить учетные данные при использовании общедоступного клиентского приложения.

### <a name="id-tokens"></a>Маркеры идентификации
Маркеры идентификации передаются веб-сайтам и собственным клиентам. Они содержат сведения о профиле пользователя. Маркер идентификации привязан одновременно и к пользователю, и клиентскому приложению. Маркеры идентификации считаются действительными до истечения срока действия. Как правило, в веб-приложениях длительность пользовательского сеанса согласовывается со временем жизни маркера идентификации, выданного этому пользователю. Изменяя время жизни маркера идентификации, вы можете управлять частотой завершения пользовательского сеанса в веб-приложении, а также частотой, с которой пользователю нужно выполнять проверку подлинности в Azure AD (в автоматическом или интерактивном режиме).

### <a name="single-sign-on-session-tokens"></a>Маркеры сеанса единого входа
Когда пользователь выполняет аутентификацию в Azure AD, для пользовательского браузера и Azure AD создается сеанс единого входа. Этот сеанс представлен маркером сеанса единого входа — в виде файла cookie. Обратите внимание, что маркер сеанса единого входа не привязан к определенному ресурсу или клиентскому приложению. Маркеры сеанса единого входа могут быть отозваны, а при каждом использовании проверяется их действительность.

В Azure AD используется два вида маркеров сеанса единого входа: постоянные и временные. Постоянные маркеры сеанса хранятся в постоянных файлах cookie, а временные — хранятся в виде файлов cookie сеанса. (Файлы cookie сеанса удаляются при закрытии браузера.) Как правило, сохраняется временный маркер сеанса. Но когда пользователь при аутентификации устанавливает флажок **Оставаться в системе**, сохраняется постоянный маркер сеанса.

Срок действия временных маркеров сеанса составляет 24 часа, а постоянных маркеров — 180 дней. Каждый раз, когда используется действующий маркер сеанса единого входа, срок его действия продлевается еще на 24 часа или 180 дней в зависимости от типа маркера. Если маркер сеанса единого входа не используется в течение срока его действия, он считается истекшим и не будет приниматься.

С помощью политик можно задать период времени после выдачи первого маркера сеанса, по прошествии которого такой маркер не будет приниматься. (Для этого воспользуйтесь свойством максимального возраста маркера сеанса.) Настройка времени жизни действия маркера сеанса позволяет управлять частотой, с которой пользователь должен повторно вводить учетные данные при использовании веб-приложения.

### <a name="token-lifetime-policy-properties"></a>Свойства политики времени жизни маркера
Политика времени жизни маркера — это объект политики, который содержит правила времени жизни маркера. Свойства этой политики и определяют срок действия соответствующих маркеров. Если политика не задана, система использует стандартное значение для времени жизни.

### <a name="configurable-token-lifetime-properties"></a>Свойства для настройки времени жизни маркера
| Свойство | Строка свойства политики | Область применения | значение по умолчанию | Минимальная | Максимальная |
| --- | --- | --- | --- | --- | --- |
| Время жизни маркера доступа |AccessTokenLifetime |Маркеры доступа, маркеры безопасности, маркеры SAML2 |1 час |10 минут |1 день |
| Максимальное время неактивности для маркеров обновления |MaxInactiveTime |Маркеры обновления |90 дней |10 минут |90 дней |
| Максимальный возраст однофакторного маркера обновления |MaxAgeSingleFactor |Маркеры обновления (для всех пользователей) |Пока не будет отозван |10 минут |Пока не будет отозван<sup>1</sup> |
| Максимальный возраст многофакторного маркера обновления |MaxAgeMultiFactor |Маркеры обновления (для всех пользователей) |Пока не будет отозван |10 минут |Пока не будет отозван<sup>1</sup> |
| Максимальный возраст однофакторного маркера сеанса |MaxAgeSessionSingleFactor<sup>2</sup> |Маркеры сеанса (постоянные и временные) |Пока не будет отозван |10 минут |Пока не будет отозван<sup>1</sup> |
| Максимальный возраст многофакторного маркера сеанса |MaxAgeSessionMultiFactor<sup>3</sup> |Маркеры сеанса (постоянные и временные) |Пока не будет отозван |10 минут |Пока не будет отозван<sup>1</sup> |

* <sup>1</sup>Максимальная длительность, которую можно явно задать для этих атрибутов, — 365 дней.
* <sup>2</sup>Если не задано значение для **MaxAgeSessionSingleFactor**, этот параметр принимает значение **MaxAgeSingleFactor**. Если оба параметра не заданы, свойство принимает значение по умолчанию (until-revoked).
* <sup>3</sup>Если не задано значение для **MaxAgeSessionMultiFactor**, этот параметр принимает значение **MaxAgeMultiFactor**. Если оба параметра не заданы, свойство принимает значение по умолчанию (until-revoked).

### <a name="exceptions"></a>Исключения
| Свойство | Область применения | значение по умолчанию |
| --- | --- | --- |
| Обновление максимального возраста маркеров (выданные для федеративных пользователей с недостаточной информацией об отзыве <sup>1</sup>) |Маркеры обновления (выданные для федеративных пользователей с недостаточной информацией об отзыве <sup>1</sup>) |12 часов |
| Максимальное время неактивности для маркера обновления (выданного для конфиденциальных клиентов) |Маркеры обновления (выданные для конфиденциальных клиентов) |90 дней |
| Максимальный возраст маркеров обновления (выданных для конфиденциальных клиентов) |Маркеры обновления (выданные для конфиденциальных клиентов) |Пока не будет отозван |

* <sup>1</sup> Федеративные пользователи с недостаточной информацией об отзыве включают любых пользователей, не имеющих синхронизированного атрибута LastPasswordChangeTimestamp. Этим пользователям предоставляется короткий максимальный возраст, так как служба AAD не может проверить, когда отменять маркеры, привязанные к старым учетным данным (например, пароль, который был изменен), и должна проверять его чаще, чтобы гарантировать, что пользователь и связанные с ним маркеры все еще находятся в хорошем состоянии. Для улучшения взаимодействия с пользователем администраторам клиента необходимо убедиться, что они синхронизировали атрибут LastPasswordChangeTimestamp (это можно задать в объекте пользователя, используя PowerShell или AADSync).

### <a name="policy-evaluation-and-prioritization"></a>Оценка политики и ее приоритеты
Политики времени жизни маркера можно создать и назначить для конкретного приложения, организации и субъектов-служб. К одному приложению могут применяться сразу несколько политик. Политики определяют время жизни маркеров в соответствии со следующими правилами:

* если политика явно назначена субъекту-службе, применяется именно она;
* если нет политики, явно назначенной субъекту-службе, применяется политика, явно назначенная родительской организации субъекта-службы;
* если нет политики, явно назначенной субъекту-службе или организации, применяется политика, назначенная приложению;
* если нет политики, явно назначенной субъекту-службе, организации или объекту приложения, применяются значения по умолчанию. (См. таблицу в разделе [Свойства для настройки времени жизни маркера](#configurable-token-lifetime-properties).)

Дополнительные сведения о связях между объектами приложения и объектами субъекта-службы см. в статье [Объекты приложения и субъекта-службы в Azure Active Directory](active-directory-application-objects.md).

Срок действия маркера оценивается при его использовании. Используется политика с самым высоким приоритетом, установленная для оцениваемого приложения.

Все интервалы времени указаны в формате объекта C# [TimeSpan](https://msdn.microsoft.com/library/system.timespan): Д.ЧЧ:ММ:СС.  Поэтому 80 дней и 30 минут указываются как `80.00:30:00`.  Начальное значение Д можно опустить, если оно равно нулю, поэтому 90 минут будет указываться как `00:90:00`.  

> [!NOTE]
> Ниже приведен пример сценария.
>
> Пользователь хочет получить доступ к двум веб-приложениям, условно именуемым веб-приложение A и веб-приложение Б.
> 
> Факторы:
> * Оба веб-приложения находятся в одной родительской организации.
> * Для родительской организации в качестве политики по умолчанию установлена политика времени жизни маркеров 1, в соответствии с которой максимальный возраст маркера сеанса составляет 8 часов.
> * Веб-приложение A — это обычное веб-приложение без настроенных политик.
> * Веб-приложение Б используется для процессов с высоким уровнем конфиденциальности, и его субъект-служба связана с политикой времени жизни маркеров 2, в которой максимальный возраст маркера сеанса составляет 30 минут.
>
> В 12:00 пользователь запускает новый сеанс браузера и пытается получить доступ к веб-приложению A. Он перенаправляется в Azure AD, где отображается запрос на вход. При этом в браузере создается файл cookie с маркером сеанса. После этого пользователь перенаправляется в веб-приложение A с маркером идентификатора, который предоставляет права доступа к приложению.
>
> В 12:15 этот же пользователь пытается получить доступ к веб-приложению Б. Браузер перенаправляется на платформу Azure AD, которая находит файл cookie сеанса. Субъект-служба веб-приложения Б связан с политикой времени жизни маркеров 2, но также входит в родительскую организацию, для которой по умолчанию используется политика 1. Здесь применяется политика времени жизни маркеров 2, так как политики для субъекта-службы имеют более высокий приоритет, чем политики по умолчанию для организации. Исходный маркер сеанса был выпущен в течение последних 30 минут, поэтому считается допустимым. Пользователь перенаправляется в веб-приложение Б с маркером идентификатора, предоставляющим права доступа.
>
> В 13:00 пользователь пытается получить доступ к веб-приложению A и снова перенаправляется в Azure AD. Веб-приложение A не имеет связанных политик, но входит в организацию, для которой в качестве политики по умолчанию установлена политика времени жизни маркеров 1, поэтому применяется именно эта политика. Система обнаруживает файл cookie сеанса, выпущенный в пределах последних 8 часов. Пользователь автоматически перенаправляется обратно в веб-приложение A с новым маркером идентификатора. Проверка подлинности в таком случае не требуется.
>
> После выполнения этих действий пользователь сразу переходит к веб-приложению Б и снова перенаправляется в Azure AD. Как и прошлый раз, применяется политика времени жизни маркеров 2. Так как маркер был выдан более 30 минут назад, пользователю предлагается повторно ввести учетные данные для входа, чтобы получить новые маркер сеанса и маркер идентификатора. Пользователь получает доступ к веб-приложению Б.
>
>

## <a name="configurable-policy-property-details"></a>Подробные сведения о настройке свойств политики
### <a name="access-token-lifetime"></a>Время жизни маркера доступа
**Строка:** AccessTokenLifetime

**Область применения:** маркеры доступа, маркеры безопасности

**Описание:** эта политика определяет, как долго продолжают действовать маркеры доступа и маркеры идентификации для определенного ресурса. Чем меньше значение свойства времени жизни маркера доступа, тем ниже риск использования маркера доступа или маркера идентификатора вредоносным субъектом в течение длительного времени. (Эти маркеры не могут быть отозваны.) Очевидным недостатком является то, что это влияет на производительность системы в связи с частой заменой маркеров.

### <a name="refresh-token-max-inactive-time"></a>Максимальное время неактивности для маркеров обновления
**Строка:** MaxInactiveTime

**Область применения:** маркеры обновления

**Описание:** эта политика определяет, насколько старым должен быть маркер обновления, чтобы клиент больше не мог использовать его для получения новой пары маркеров доступа и обновления при попытке доступа к определенному ресурсу. При использовании маркера обновления обычно возвращается новый маркер обновления. Следовательно, политика запретит доступ после того, как клиент в течение указанного времени будет пытаться получить доступ к каким-либо ресурсам, используя текущий маркер обновления.

Эта политика вынуждает пользователей, не выполнявших активных действий в клиентских приложениях, повторно проходить проверку подлинности для получения нового маркера обновления.

Свойство максимального времени неактивности маркера обновления должно быть меньше, чем свойства максимального возраста однофакторного маркера или многофакторного маркера обновления.

### <a name="single-factor-refresh-token-max-age"></a>Максимальный возраст однофакторного маркера обновления
**Строка:** MaxAgeSingleFactor

**Область применения:** маркеры обновления

**Описание:** эта политика определяет, как долго пользователь может применять маркер обновления для получения новых пар маркеров доступа и обновления после последней успешной проверки подлинности с использованием однофакторных методов. Когда пользователь выполнит проверку подлинности и получит новый маркер обновления, он сможет и дальше использовать маркер обновления в течение указанного периода времени. (До того момента, пока текущий маркер обновления не будет отозван или не будет превышено максимальное время неактивности.) После этого пользователь должен повторно выполнить проверку подлинности, чтобы получить новый маркер обновления.

Сокращение максимального возраста вынуждает пользователей чаще выполнять проверку подлинности. Так как однофакторная идентификация подлинности считается менее безопасной, чем многофакторная, мы советуем указать значение этого свойства, не превышающее максимальный возраст многофакторного маркера обновления.

### <a name="multi-factor-refresh-token-max-age"></a>Максимальный возраст многофакторного маркера обновления
**Строка:** MaxAgeMultiFactor

**Область применения:** маркеры обновления

**Описание:** эта политика определяет, как долго пользователь может применять маркер обновления для получения новых пар маркеров доступа и обновления после последней успешной проверки подлинности с использованием многофакторных методов. Когда пользователь выполнит проверку подлинности и получит новый маркер обновления, он сможет и дальше использовать маркер обновления в течение указанного периода времени. (До того момента, пока текущий маркер обновления не будет отозван или не будет превышено максимальное время неактивности.) После этого пользователи должны повторно выполнить проверку подлинности, чтобы получить новый маркер обновления.

Сокращение максимального возраста вынуждает пользователей чаще выполнять проверку подлинности. Так как однофакторная идентификация подлинности считается менее безопасной, чем многофакторная, мы советуем указать значение этого свойства, не превышающее максимальный возраст однофакторного маркера обновления.

### <a name="single-factor-session-token-max-age"></a>Максимальный возраст однофакторного маркера сеанса
**Строка:** MaxAgeSessionSingleFactor

**Область применения:** маркеры сеанса (постоянные и временные)

**Описание:** эта политика определяет, как долго пользователь может применять маркер сеанса для получения новых маркеров сеанса и идентификатора после последней успешной проверки подлинности с использованием однофакторных методов. Когда пользователь выполнит проверку подлинности и получит новый маркер сеанса, он сможет и дальше использовать последовательность маркеров сеанса в течение указанного периода времени. (До того момента, пока маркер текущего сеанса не будет отозван или не истечет его срок действия.) После указанного периода времени пользователь должен повторно выполнить проверку подлинности, чтобы получить новый маркер сеанса.

Сокращение максимального возраста вынуждает пользователей чаще выполнять проверку подлинности. Так как однофакторная идентификация подлинности считается менее безопасной, чем многофакторная, мы советуем указать значение этого свойства, не превышающее максимальный возраст многофакторного маркера сеанса.

### <a name="multi-factor-session-token-max-age"></a>Максимальный возраст многофакторного маркера сеанса
**Строка:** MaxAgeSessionMultiFactor

**Область применения:** маркеры сеанса (постоянные и временные)

**Описание:** эта политика определяет, как долго пользователь может применять маркер сеанса для получения новых маркеров сеанса и идентификатора после последней успешной проверки подлинности с использованием многофакторных методов. Когда пользователь выполнит проверку подлинности и получит новый маркер сеанса, он сможет и дальше использовать последовательность маркеров сеанса в течение указанного периода времени. (До того момента, пока маркер текущего сеанса не будет отозван или не истечет его срок действия.) После указанного периода времени пользователь должен повторно выполнить проверку подлинности, чтобы получить новый маркер сеанса.

Сокращение максимального возраста вынуждает пользователей чаще выполнять проверку подлинности. Так как однофакторная идентификация подлинности считается менее безопасной, чем многофакторная, мы рекомендуем указать значение этого свойства, не превышающее максимальный возраст однофакторного маркера сеанса.

## <a name="example-token-lifetime-policies"></a>Пример использования политик срока действия маркеров
Указывая и изменяя время жизни маркеров для приложений, субъектов-служб и организации в целом, вы сможете реализовать в Azure AD много новых сценариев. В этом разделе мы рассмотрим несколько распространенных вариантов использования политик, которые помогут вам правильно применять новые правила для следующих параметров:

* Token Lifetime
* максимальное время неактивности для маркеров;
* Максимальный возраст маркеров

На основе этих примеров можно узнать:

* как управлять политикой организации по умолчанию;
* как создать политику для входа в веб-службы;
* как создать политику для собственного приложения, которое вызывает веб-API;
* как управлять расширенной политикой.

### <a name="prerequisites"></a>предварительным требованиям
В следующих примерах мы будем создавать, обновлять, связывать и удалять политики для приложений, субъектов-служб и организации в целом. Если вы еще не работали с Azure AD, прежде чем продолжить работу с этими примерами, советуем ознакомиться со статьей [Как получить клиент Azure Active Directory](active-directory-howto-tenant.md).  

Чтобы начать работу, сделайте следующее:

1. Cкачайте последнюю [общедоступную предварительную версию модуля Azure AD PowerShell](https://www.powershellgallery.com/packages/AzureADPreview).
2. Чтобы войти в учетную запись администратора Azure AD, выполните команду `Connect`. Эту команду следует выполнять при каждом запуске сеанса.

    ```PowerShell
    Connect-AzureAD -Confirm
    ```

3. Чтобы просмотреть все политики, которые созданы в организации, выполните следующую команду. Эту команду следует выполнять после большинства операций в наших примерах. Также она позволит получить ** ** для политик.

    ```PowerShell
    Get-AzureADPolicy
    ```

### <a name="example-manage-an-organizations-default-policy"></a>Пример управления политикой организации по умолчанию
В этом примере мы создадим для всей организации политику, которая позволяет пользователям реже вводить учетные данные. Для этого создайте политику времени жизни для однофакторных маркеров обновления и примените ее к организации. Эта политика будет распространяться на все приложения в организации и на все субъекты-службы, для которых не установлены отдельные политики.

1. Создайте политику времени жизни маркеров.

    1.  Если для параметра срока действия однофакторного маркера обновления установить значение until-revoked, маркер будет действовать неограниченно долго — пока не будет отозван. Создайте следующее определение политики:

        ```PowerShell
        @('{
            "TokenLifetimePolicy":
            {
                "Version":1,
                "MaxAgeSingleFactor":"until-revoked"
            }
        }')
        ```

    2.  Чтобы создать политику, выполните следующую команду:

        ```PowerShell
        New-AzureADPolicy -Definition @('{"TokenLifetimePolicy":{"Version":1, "MaxAgeSingleFactor":"until-revoked"}}') -DisplayName "OrganizationDefaultPolicyScenario" -IsOrganizationDefault $true -Type "TokenLifetimePolicy"
        ```

    3.  Чтобы просмотреть созданную политику и получить ее **идентификатор объекта**, выполните следующую команду:

        ```PowerShell
        Get-AzureADPolicy
        ```

2. Обновите политику.

    Если вы решили, что созданная в этом примере политика для службы недостаточно строгая, и хотите, чтобы срок действия однофакторных маркеров обновления истекал через 2 дня, выполните следующую команду:

    ```PowerShell
    Set-AzureADPolicy -Id <ObjectId FROM GET COMMAND> -DisplayName "OrganizationDefaultPolicyUpdatedScenario" -Definition @('{"TokenLifetimePolicy":{"Version":1,"MaxAgeSingleFactor":"2.00:00:00"}}')
    ```

### <a name="example-create-a-policy-for-web-sign-in"></a>Пример создания политики для входа в веб-службы

В этом примере мы создадим политику, в соответствии с которой пользователи должны будут чаще выполнять проверку подлинности в веб-приложении. Эта политика определит время жизни для маркеров доступа и идентификатора, а также максимальный возраст многофакторного маркера сеанса для субъекта-службы веб-приложения.

1. Создайте политику времени жизни маркеров.

    Эта политика для входа в веб-службы определит время жизни для маркеров доступа и идентификатора, а также максимальный возраст однофакторного маркера сеанса (2 часа).

    1.  Чтобы создать политику, выполните следующую команду:

        ```PowerShell
        New-AzureADPolicy -Definition @('{"TokenLifetimePolicy":{"Version":1,"AccessTokenLifetime":"02:00:00","MaxAgeSessionSingleFactor":"02:00:00"}}') -DisplayName "WebPolicyScenario" -IsOrganizationDefault $false -Type "TokenLifetimePolicy"
        ```

    2.  Чтобы просмотреть созданную политику и получить ее **идентификатор объекта**, выполните следующую команду:

        ```PowerShell
        Get-AzureADPolicy
        ```

2.  Назначьте политику для субъекта-службы. Вам потребуется также получить **идентификатор объекта** субъекта-службы. 

    1.  Чтобы просмотреть все субъекты-службы в организации, запросите [Microsoft Graph](https://developer.microsoft.com/graph/docs/api-reference/beta/resources/serviceprincipal#properties) или [Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity). Также это можно проверить в [обозревателе Azure AD Graph](https://graphexplorer.cloudapp.net/)и [Microsoft Graph Explorer](https://developer.microsoft.com/graph/graph-explorer) с помощью учетной записи Azure AD.

    2.  Получив **идентификатор объекта** субъекта-службы, выполните следующую команду:

        ```PowerShell
        Add-AzureADServicePrincipalPolicy -Id <ObjectId of the ServicePrincipal> -RefObjectId <ObjectId of the Policy>
        ```


### <a name="example-create-a-policy-for-a-native-app-that-calls-a-web-api"></a>Пример создания политики для собственного приложения, вызывающего веб-API
В этом примере мы создадим политику, в соответствии с которой пользователи должны будут реже выполнять проверку подлинности. Она также увеличивает длительность периода, в течение которого пользователи могут оставаться неактивными, прежде чем им понадобится выполнить повторную проверку подлинности. Политика применяется к веб-API каждый раз, когда собственные приложения обращаются к этому интерфейсу как к ресурсу.

1. Создайте политику времени жизни маркеров.

    1.  Чтобы создать строгую политику для веб-API, выполните следующую команду:

        ```PowerShell
        New-AzureADPolicy -Definition @('{"TokenLifetimePolicy":{"Version":1,"MaxInactiveTime":"30.00:00:00","MaxAgeMultiFactor":"until-revoked","MaxAgeSingleFactor":"180.00:00:00"}}') -DisplayName "WebApiDefaultPolicyScenario" -IsOrganizationDefault $false -Type "TokenLifetimePolicy"
        ```

    2.  Чтобы просмотреть созданную политику и получить ее **идентификатор объекта**, выполните следующую команду:

        ```PowerShell
        Get-AzureADPolicy
        ```

2. Назначьте политику для веб-API. Вам потребуется также получить **идентификатор объекта** приложения. Получить **идентификатор объекта** для приложения проще всего на [портале Azure](https://portal.azure.com/).

   Получив **идентификатор объекта** приложения, выполните следующую команду:

        ```PowerShell
        Add-AzureADApplicationPolicy -Id <ObjectId of the Application> -RefObjectId <ObjectId of the Policy>
        ```


### <a name="example-manage-an-advanced-policy"></a>Пример управления расширенной политикой
В этом примере мы создадим несколько политик для демонстрации работы системы приоритетов. Вы также узнаете о методах управления несколькими политиками, применяемыми к нескольким объектам.

1. Создайте политику времени жизни маркеров.

    1.  Чтобы создать для организации политику по умолчанию, которая определяет для однофакторного маркера обновления время жизни в 30 дней, выполните следующую команду:

        ```PowerShell
        New-AzureADPolicy -Definition @('{"TokenLifetimePolicy":{"Version":1,"MaxAgeSingleFactor":"30.00:00:00"}}') -DisplayName "ComplexPolicyScenario" -IsOrganizationDefault $true -Type "TokenLifetimePolicy"
        ```

    2.  Чтобы просмотреть созданную политику и получить ее **идентификатор объекта**, выполните следующую команду:

        ```PowerShell
        Get-AzureADPolicy
        ```

2. Назначьте политику для субъекта-службы.

    Теперь у нас есть политика, которая применяется ко всей организации. Предположим, мы хотим сохранить эту политику со сроком действия 30 дней для определенного субъекта-службы, но изменить максимальное ограничение стандартной политики для организации, указав значение until-revoked (пока не будет отозван).

    1.  Чтобы просмотреть все субъекты-службы в организации, запросите [Microsoft Graph](https://developer.microsoft.com/graph/docs/api-reference/beta/resources/serviceprincipal#properties) или [Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity). Также это можно проверить в [обозревателе Azure AD Graph](https://graphexplorer.cloudapp.net/)и [Microsoft Graph Explorer](https://developer.microsoft.com/graph/graph-explorer) с помощью учетной записи Azure AD.

    2.  Получив **идентификатор объекта** субъекта-службы, выполните следующую команду:

            ```PowerShell
            Add-AzureADServicePrincipalPolicy -Id <ObjectId of the ServicePrincipal> -RefObjectId <ObjectId of the Policy>
            ```
        
3. Задайте значение false для флага `IsOrganizationDefault`:

    ```PowerShell
    Set-AzureADPolicy -Id <ObjectId of Policy> -DisplayName "ComplexPolicyScenario" -IsOrganizationDefault $false
    ```

4. Создайте новую политику организации по умолчанию:

    ```PowerShell
    New-AzureADPolicy -Definition @('{"TokenLifetimePolicy":{"Version":1,"MaxAgeSingleFactor":"until-revoked"}}') -DisplayName "ComplexPolicyScenarioTwo" -IsOrganizationDefault $true -Type "TokenLifetimePolicy"
    ```

    Теперь ваша исходная политика связана с субъектом-службой, а организации назначена новая политика по умолчанию. Важно помнить, что политики, примененные к субъектам-службам, имеют более высокий приоритет, чем политики по умолчанию для организации.

## <a name="cmdlet-reference"></a>Справочник по командлетам

### <a name="manage-policies"></a>Управление политиками

Управлять политиками можно с помощью следующих командлетов.

#### <a name="new-azureadpolicy"></a>New-AzureADPolicy

Создает новую политику.

```PowerShell
New-AzureADPolicy -Definition <Array of Rules> -DisplayName <Name of Policy> -IsOrganizationDefault <boolean> -Type <Policy Type>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Definition</code> |Переведенный в строку массив JSON, который содержит все правила политики. | `-Definition @('{"TokenLifetimePolicy":{"Version":1,"MaxInactiveTime":"20:00:00"}}')` |
| <code>&#8209;DisplayName</code> |Строка c именем политики. |`-DisplayName "MyTokenPolicy"` |
| <code>&#8209;IsOrganizationDefault</code> |Если присвоено значение true, политика устанавливается как политика по умолчанию для организации. Если присвоено значение false — параметр игнорируется. |`-IsOrganizationDefault $true` |
| <code>&#8209;Type</code> |Тип политики. Для политик времени жизни маркеров всегда используйте значение TokenLifetimePolicy. | `-Type "TokenLifetimePolicy"` |
| <code>&#8209;AlternativeIdentifier</code> (необязательный параметр) |Задает альтернативный идентификатор политики. |`-AlternativeIdentifier "myAltId"` |

</br></br>

#### <a name="get-azureadpolicy"></a>Get-AzureADPolicy
Возвращает полный список политик Azure AD или одну указанную политику.

```PowerShell
Get-AzureADPolicy
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> (необязательный параметр) |**Идентификатор объекта (ИД)** для нужной политики. |`-Id <ObjectId of Policy>` |

</br></br>

#### <a name="get-azureadpolicyappliedobject"></a>Get-AzureADPolicyAppliedObject
Возвращает список приложений и субъектов-служб, связанных с политикой.

```PowerShell
Get-AzureADPolicyAppliedObject -Id <ObjectId of Policy>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для нужной политики. |`-Id <ObjectId of Policy>` |

</br></br>

#### <a name="set-azureadpolicy"></a>Set-AzureADPolicy
Обновляет существующую политику.

```PowerShell
Set-AzureADPolicy -Id <ObjectId of Policy> -DisplayName <string>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для нужной политики. |`-Id <ObjectId of Policy>` |
| <code>&#8209;DisplayName</code> |Строка c именем политики. |`-DisplayName "MyTokenPolicy"` |
| <code>&#8209;Definition</code> (необязательный параметр) |Переведенный в строку массив JSON, который содержит все правила политики. |`-Definition @('{"TokenLifetimePolicy":{"Version":1,"MaxInactiveTime":"20:00:00"}}')` |
| <code>&#8209;IsOrganizationDefault</code> (необязательный параметр) |Если присвоено значение true, политика устанавливается как политика по умолчанию для организации. Если присвоено значение false — параметр игнорируется. |`-IsOrganizationDefault $true` |
| <code>&#8209;Type</code> (необязательный параметр) |Тип политики. Для политик времени жизни маркеров всегда используйте значение TokenLifetimePolicy. |`-Type "TokenLifetimePolicy"` |
| <code>&#8209;AlternativeIdentifier</code> (необязательный параметр) |Задает альтернативный идентификатор политики. |`-AlternativeIdentifier "myAltId"` |

</br></br>

#### <a name="remove-azureadpolicy"></a>Remove-AzureADPolicy
Удаляет указанную политику.

```PowerShell
 Remove-AzureADPolicy -Id <ObjectId of Policy>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для нужной политики. | `-Id <ObjectId of Policy>` |

</br></br>

### <a name="application-policies"></a>Политики приложений
Управлять политиками приложений можно с помощью следующих командлетов.</br></br>

#### <a name="add-azureadapplicationpolicy"></a>Add-AzureADApplicationPolicy
Связывает указанную политику с приложением.

```PowerShell
Add-AzureADApplicationPolicy -Id <ObjectId of Application> -RefObjectId <ObjectId of Policy>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для приложения. | `-Id <ObjectId of Application>` |
| <code>&#8209;RefObjectId</code> |**Идентификатор объекта** для политики. | `-RefObjectId <ObjectId of Policy>` |

</br></br>

#### <a name="get-azureadapplicationpolicy"></a>Get-AzureADApplicationPolicy
Возвращает политику, назначенную для приложения.

```PowerShell
Get-AzureADApplicationPolicy -Id <ObjectId of Application>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для приложения. | `-Id <ObjectId of Application>` |

</br></br>

#### <a name="remove-azureadapplicationpolicy"></a>Remove-AzureADApplicationPolicy
Удаляет политику из приложения.

```PowerShell
Remove-AzureADApplicationPolicy -Id <ObjectId of Application> -PolicyId <ObjectId of Policy>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для приложения. | `-Id <ObjectId of Application>` |
| <code>&#8209;PolicyId</code> |**Идентификатор объекта** для политики. | `-PolicyId <ObjectId of Policy>` |

</br></br>

### <a name="service-principal-policies"></a>Политики субъекта-службы
Управлять политиками субъектов-служб можно с помощью следующих командлетов.

#### <a name="add-azureadserviceprincipalpolicy"></a>Add-AzureADServicePrincipalPolicy
Связывает указанную политику с субъектом-службой.

```PowerShell
Add-AzureADServicePrincipalPolicy -Id <ObjectId of ServicePrincipal> -RefObjectId <ObjectId of Policy>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для приложения. | `-Id <ObjectId of Application>` |
| <code>&#8209;RefObjectId</code> |**Идентификатор объекта** для политики. | `-RefObjectId <ObjectId of Policy>` |

</br></br>

#### <a name="get-azureadserviceprincipalpolicy"></a>Get-AzureADServicePrincipalPolicy
Возвращает все политики, связанные с указанным субъектом-службой.

```PowerShell
Get-AzureADServicePrincipalPolicy -Id <ObjectId of ServicePrincipal>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для приложения. | `-Id <ObjectId of Application>` |

</br></br>

#### <a name="remove-azureadserviceprincipalpolicy"></a>Remove-AzureADServicePrincipalPolicy
Удаляет политику из указанного субъекта-службы.

```PowerShell
Remove-AzureADServicePrincipalPolicy -Id <ObjectId of ServicePrincipal>  -PolicyId <ObjectId of Policy>
```

| Параметры | ОПИСАНИЕ | Пример |
| --- | --- | --- |
| <code>&#8209;Id</code> |**Идентификатор объекта (ИД)** для приложения. | `-Id <ObjectId of Application>` |
| <code>&#8209;PolicyId</code> |**Идентификатор объекта** для политики. | `-PolicyId <ObjectId of Policy>` |
