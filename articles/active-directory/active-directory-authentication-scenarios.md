
<properties
   pageTitle="Сценарии аутентификации в Azure Active Directory| Microsoft Azure"
   description="Обзор пяти наиболее распространенных сценариев проверки подлинности для Azure Active Directory (AAD)"
   services="active-directory"
   documentationCenter="dev-center-name"
   authors="msmbaldwin"
   manager="mbaldwin"
   editor=""/>

<tags
   ms.service="active-directory"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="identity"
   ms.date="09/16/2016"
   ms.author="mbaldwin"/>

# Сценарии аутентификации в Azure Active Directory

Azure Active Directory (Azure AD) упрощает процесс проверки подлинности для разработчиков, предоставляя удостоверение как услугу, благодаря поддержке стандартных протоколов, например OAuth 2.0 и OpenID Connect, а также библиотекам с открытым исходным кодом для различных платформ, которые позволяют оперативно приступать к программированию. В данном документе будут рассмотрены различные сценарии, которые поддерживает Azure AD, и показано, как приступить к работе. Он состоит из следующих разделов:

- [Основы проверки подлинности в Azure AD](#basics-of-authentication-in-azure-ad)

- [Утверждения в маркерах безопасности Azure AD](#claims-in-azure-ad-security-tokens)

- [Основные сведения о регистрации приложения в Azure AD](#basics-of-registering-an-application-in-azure-ad)

- [Типы приложений и сценарии](#application-types-and-scenarios)

  - [Из веб-браузера в веб-приложение](#web-browser-to-web-application)

  - [Одностраничное приложение (SPA)](#single-page-application-spa)

  - [Из нативного приложения к веб-интерфейсу API](#native-application-to-web-api)

  - [Из веб-приложения в веб-интерфейс API](#web-application-to-web-api)

  - [Из управляющей программы или серверного приложения в веб-интерфейс API](#daemon-or-server-application-to-web-api)



## Основы проверки подлинности в Azure AD

Если вы не знакомы с основными концепциями процесса проверки подлинности в Azure AD, прочтите этот раздел. В противном случае вы можете сразу перейти к разделу [Типы приложений и сценарии](#application-types-and-scenarios).

Рассмотрим наиболее простой сценарий, где требуется удостоверение: в веб-браузере пользователю нужно проверить подлинность веб-приложения. Данный сценарий описывается более подробно в разделе [Из веб-браузера в веб-приложение](#web-browser-to-web-application), но и текущий раздел представляет собой удобную отправную точку для показа возможностей Azure AD и рассмотрения, как работает сценарий. Рассмотрим следующую схему для этого сценария:

![Обзор входа в веб-приложение](./media/active-directory-authentication-scenarios/basics_of_auth_in_aad.png)

Данная схема помогает понять, что нужно знать о компонентах сценария.

- Azure AD — это поставщик удостоверений, обеспечивающий проверку подлинности удостоверений пользователей и приложений, которые существуют в каталоге организации, и в конечном счете выдает маркеры безопасности после успешной проверки подлинности этих пользователей и приложений.


- Приложение, желающее передать проверку подлинности системе Azure AD, должно быть зарегистрировано в Azure AD, которая регистрирует и уникально идентифицирует данное приложение в каталоге.


- Использование разработчиками библиотек проверки подлинности Azure AD с открытым кодом позволяет упростить выполнение проверки подлинности, благодаря обработке библиотеками данных протокола. Дополнительные сведения см. в разделе [Библиотеки проверки подлинности в Azure Active Directory](active-directory-authentication-libraries.md) .


• Как только пользователь прошел проверку подлинности, приложение должно проверить маркер безопасности пользователя, чтобы убедиться в успешности проверки подлинности для предполагаемых сторон. Разработчики могут использовать предоставленные библиотеки проверки подлинности для проверки любого маркера из Azure AD, включая веб-маркеры JSON (JWT) или SAML 2.0. Сведения об обработке маркеров вручную см. в разделе [Обработчик токенов JWT](https://msdn.microsoft.com/library/dn205065.aspx).


> [AZURE.IMPORTANT] В Azure AD для подписи маркеров и проверки их правильности используется шифрование с открытым ключом. Дополнительные сведения о необходимой логике, которую нужно иметь в приложении, чтобы оно всегда гарантированно обновляло ключи, см. в разделе [Важные сведения о смене ключей подписи в Azure AD](active-directory-signing-key-rollover.md).


• Поток запросов и ответов для процесса проверки подлинности определяется применяемым протоколом проверки подлинности, например OAuth 2.0, OpenID Connect, WS-Federation или SAML 2.0. Подробные сведения об этих протоколах см. в статье [Протоколы проверки подлинности Active Directory Azure](active-directory-authentication-protocols.md), а также в разделах ниже.

> [AZURE.NOTE] Azure AD поддерживает стандарты OAuth 2.0 и OpenID Connect, в которых широко используются маркеры носителя, включая маркеры носителя в виде JWT. Токен носителя — это упрощенный маркер безопасности, предоставляющий его носителя (предъявителю) доступ к защищенному ресурсу. В этом смысле предъявителем является любая сторона, которая может предъявить маркер. Несмотря на то, что для получения токена носителя сторона должны сначала пройти проверку подлинности в Azure AD, если действия, необходимые для защиты маркера при его передаче и хранении не выполняются, его может перехватить и использовать несанкционированная сторона. Хотя в некоторых маркерах безопасности для предотвращения несанкционированного использования применяется специальный встроенный механизм, в токенах носителя такого механизма нет, и они должны передаваться по защищенному каналу, например с использованием стандарта безопасности транспортного уровня (HTTPS). Если токен носителя передается в незашифрованном виде, злоумышленник может использовать атаку "злоумышленник в середине", чтобы получить токен и использовать его для несанкционированного доступа к защищенному ресурсу. Те же принципы безопасности применяются при сохранении или кэшировании маркеров носителя для последующего использования. Необходимо всегда проверять, что приложение передает и сохраняет маркеры носителя безопасным образом. Дополнительные сведения о безопасности в случае применения маркеров носителя см. в [RFC 6750, раздел 5](http://tools.ietf.org/html/rfc6750).


Теперь, после рассмотрения общей информации, ознакомьтесь с разделами ниже, описывающими, как в Azure AD выполняется процесс подготовки, и какие типичные сценарии поддерживаются в Azure AD.


## Утверждения в маркерах безопасности Azure AD

Маркеры безопасности, которые выдает система Azure AD, содержат информационные утверждения о субъекте, для которого была выполнена проверка подлинности. Эти утверждения могут применяться приложением для различных задач. Например, они могут использоваться для проверки маркера, идентификации клиента каталога субъекта, отображения сведений о пользователе, определения авторизации субъекта и т. д. Утверждения, имеющиеся в любом заданном маркере безопасности, зависят от типа маркера, типа учетных данных, используемых для проверки подлинности пользователя, и конфигурации приложения. В таблице ниже приведено краткое описание каждого типа утверждений, которые создает Azure AD. Дополнительные сведения см. в разделе [Поддерживаемые типы маркеров и утверждений](active-directory-token-and-claims.md).


| Утверждение | Описание |
|-------|-------------|
| Идентификатор приложения | Идентифицирует приложение, которое использует маркер.
| Аудитория | Идентифицирует ресурс получателя, для которого предназначен маркер. |
| Ссылка на класс контекста проверки подлинности приложения | Показывает, как клиент прошел проверку подлинности (открытый клиент или конфиденциальный клиент). |
| Время выполнения проверки подлинности | Фиксирует дату и время выполнения сеанса проверки подлинности. |
| Метод проверки подлинности | Указывает способ проверки подлинности субъекта маркера (с помощью пароля, сертификата и т. д.). |
| Имя | Предоставляет имя пользователя, как задано в Azure AD. |
| Группы | Содержит идентификаторы объектов для групп Azure AD, членом которых является пользователь. |
| Поставщик удостоверений | Фиксирует поставщика удостоверений, который проверил подлинность субъекта маркера. |
| Выдано в | Фиксирует время, когда был выдан маркер, часто используется для определения "степени свежести" маркера. |
| Издатель | Идентифицирует STS, который выдал маркер, а также клиента Azure AD. |
| Фамилия | Предоставляет фамилию пользователя, как задано в Azure AD. |
| Имя | Предоставляет удобное для восприятия значение, которое идентифицирует субъект маркера. |
| Идентификатор объекта | Содержит неизменяемый, уникальный идентификатор субъекта в Azure AD. |
| Роли | Содержит простые имена ролей приложения в Azure AD, которые предоставлены пользователю. |
| Область | Указывает разрешения, предоставленные клиентскому приложению. |
| Субъект | Указывает участника, сведения о котором утверждает маркер. |
| Идентификатор клиента | Содержит неизменяемый, уникальный идентификатор клиента каталога, который выдал маркер. |
| Время существования маркера | Определяет интервал времени, в течение которого маркер является действительным. |
| Имя участника-пользователя | Содержит имя участника-пользователя субъекта. |
| Версия | Содержит номер версии маркера. |


## Основные сведения о регистрации приложения в Azure AD

Любое приложение, передающее функцию проверку подлинности системе Azure AD, должно быть зарегистрировано в каталоге. Этот шаг подразумевает предоставление системе Azure AD информации об этом приложении, включая URL-адрес доступа к приложению, URL-адрес для отправки ответов после проверки подлинности, URI для идентификации приложения и многое другое. Эта информация необходима по нескольким основным причинам:

- Системе Azure AD требуются координаты для взаимодействия с приложением при выполнении входа в систему или при обмене маркерами. К ним относятся:

  - URI идентификатора приложения — идентификатор приложения. Это значение отправляется в Azure AD во время проверки подлинности и указывает, для какого приложения вызывающая сторона желает получить маркер. Кроме того, это значение включается в маркер, чтобы приложение знало, что именно это значение запрашивалось.


  - URL-адрес ответа и URI перенаправления — в случае веб-интерфейса API или веб-приложения, URL-адрес ответа указывает то место, куда Azure AD будет отправлять ответ после проверки подлинности, включая маркер при успешной проверке подлинности. В случае нативного приложения код URI перенаправления — это уникальный идентификатор, на который Azure AD будет перенаправлять агента пользователя при запросе OAuth 2.0.


  - Идентификатор клиента — идентификатор приложения, который создается при регистрации приложения системой Azure AD. При запросе кода авторизации или маркера идентификатор клиента и ключ отправляются в Azure AD во время проверки подлинности.


  - Ключ — ключ, который отправляется вместе с идентификатором клиента при проверке подлинности в Azure AD для вызова веб-интерфейса API.


- Системе Azure AD необходимо убедиться, что приложение имеет необходимые разрешения для доступа к вашим данным каталога, другим приложениям в вашей организации и т. д.

Процесс подготовки станет яснее, когда вы поймете, что существует две категории приложений, которые можно разрабатывать и интегрировать с Azure AD:

- Однотенантное приложение. Однотенантное приложение (для одного клиента) предназначено для использования в одной организации. Обычно это бизнес-приложения (LoB), которые создает разработчик компании. Однотенантное приложение предоставляет пользователям доступ только в одном каталоге. В результате, его достаточно подготовить в одном каталоге. Такие приложения обычно регистрируются разработчиком в организации.


- Мультитенантное приложение. Мультитенантное приложение (для нескольких клиентов) предназначено для использования во многих организациях, а не только в одной. Как правило, это приложения категории "программное обеспечение как услуга" (SaaS), которые создают независимые поставщики программных продуктов (ISV). Мультитенантные приложения необходимо подготавливать в каждом каталоге, где они будут использоваться. Следовательно, для их регистрации требуется предоставление разрешений пользователем или администратором. Процесс предоставление разрешений начинается, когда приложение регистрируется в каталоге и получает доступ к API-интерфейсу Graph или, возможно, к другому веб-интерфейсу API. Когда пользователь или администратор из другой организации регистрируется для использования приложения, для них появляется диалоговое окно, в котором отображаются разрешения, необходимые для приложения. Пользователь или администратор может предоставить приложению требуемые разрешения, что дает приложению доступ к необходимым данным и регистрирует приложение в их каталоге. Дополнительные сведения см. в разделе [Общие сведения о процедуре предоставления разрешений](active-directory-integrating-applications.md#overview-of-the-consent-framework).

При разработке мультитенантного приложения вместо однотенантного необходимо учесть некоторые дополнительные соображения. Например, если вы делаете свое приложение доступным для пользователей в нескольких каталогах, требуется механизм, чтобы определять, членами какого клиента (тенанта) они являются. Однотенантное приложение должно присутствовать только в собственном каталоге для данного пользователя, тогда как мультитенантное приложение должно идентифицировать конкретного пользователя из любого каталога в Azure AD. Для выполнения этой задачи система Azure AD предоставляет общую конечную точку проверки подлинности, в которую мультитенантное приложение может направлять запросы на вход, вместо конечной точки для конкретного клиента. Эта конечная точка является https://login.microsoftonline.com/common для всех каталогов в Azure AD, тогда как конечной точкой для конкретного клиента может быть https://login.microsoftonline.com/contoso.onmicrosoft.com. Общую конечную точку особенно важно учитывать при разработке своего приложения, так как вам будет нужна специальная логика для обработки нескольких клиентов во время входа, выхода и проверки маркеров.

Если вы разрабатываете однотенантное приложение, но хотите сделать его доступным для многих организаций, вы можете легко внести изменения в само приложение и его конфигурацию в системе Azure AD и переделать его на мультитенантное. Кроме того, Azure AD использует один и тот же ключ подписи для всех маркеров во всех каталогах, независимо от того, выполняется ли проверка подлинности в однотенантном или мультитенантном приложении.

Каждый сценарий, рассматриваемый в этом документе, содержит подраздел, где описываются соответствующие требования по подготовке. Больше о подготовке приложения в Azure AD, а также о различиях между однотенантными и мультитенантными приложениями можно узнать в статье [Интеграция приложений с Azure Active Directory](active-directory-integrating-applications.md). Продолжим рассмотрение типичных сценариев работы приложений в Azure AD.

## Типы приложений и сценарии

Каждый сценарий, описанный в этом документе, можно разрабатывать с использованием различных языков и платформ. Все сценарии дополнены примерами кода, которые доступны в нашем [Руководстве по примерам кода](active-directory-code-samples.md) или в соответствующих [репозиториях примеров Github](https://github.com/Azure-Samples?utf8=%E2%9C%93&query=active-directory). Кроме того, если вашему приложению требуется конкретная часть или сегмент комплексного сценария, то в большинстве случаев эти функции можно добавлять независимым образом. Например, если имеется нативное приложение, которое вызывает веб-интерфейс API, можно легко добавить веб-приложение, которое также будет вызывать такой интерфейс. На следующей схеме показаны эти сценарии и типы приложений. Кроме того, показано, как можно добавлять различные компоненты:

![Типы приложений и сценарии](./media/active-directory-authentication-scenarios/application_types_and_scenarios.png)

Ниже приведены пять основных сценариев приложений, которые поддерживает система Azure AD:

- [Из веб-браузера в веб-приложение](#web-browser-to-web-application): пользователю нужно войте в веб-приложение, защиту которого выполняет Azure AD.

- [Одностраничное приложение (SPA)](#single-page-application-spa): пользователю нужно войте в одностраничное приложение, защиту которого выполняет Azure AD.

- [Из нативного приложения в веб-интерфейс API](#native-application-to-web-api): нативному приложению, которое выполняется на телефоне, планшете или ПК, требуется проверить подлинность пользователя для получения ресурсов из веб-интерфейса API, защиту которого обеспечивает Azure AD.

- [Из веб-приложения в веб-интерфейс API](#web-application-to-web-api): веб-приложению требуется получать ресурсы из веб-интерфейса API, защиту которого обеспечивает Azure AD.

- [Из управляющей программы или серверного приложения в веб-интерфейс API](#daemon-or-server-application-to-web-api): управляющей программе (демону) или серверному приложению, в котором нет веб-интерфейса пользователя, требуется получить ресурсы из веб-интерфейса API, защиту которого обеспечивает Azure AD.

### Из веб-браузера в веб-приложение

В этом разделе описывается приложение, которое проверяет подлинность пользователя в веб-браузере для веб-приложения. В этом сценарии веб-приложение направляет браузер пользователя для выполнения входа в Azure AD. Azure AD возвращает ответ входа через браузер пользователя, который содержит утверждения о пользователе в маркере безопасности. Этот сценарий поддерживает вход с использованием протоколов WS-Federation, SAML 2.0 и OpenID Connect.


#### Схема
![Поток проверки подлинности для сценария "из браузера в веб-приложение"](./media/active-directory-authentication-scenarios/web_browser_to_web_api.png)


#### Описание потока протокола


1. Если пользователь открывает приложение и собирается выполнить вход, он перенаправляется через запрос входа в конечную точку проверки подлинности в Azure AD.


2. Пользователь выполняет вход на странице входа.


3. При успешном выполнении проверки Azure AD создает маркер проверки подлинности и возвращает ответ входа в виде URL-адреса приложения, который был указан на портале управления Azure. В рабочем приложении для этого URL-адреса ответа должен использоваться протокол HTTPS. Возвращаемый маркер содержит утверждения о пользователе и системе Azure AD, которые требуются приложению для проверки маркера.


4. Приложение проверяет маркер с помощью открытого ключа подписи и сведений об издателе, которые имеются в документе с метаданными федерации для Azure AD. После проверки приложением маркера Azure AD запускает новый сеанс с пользователем. Этот сеанс позволяет пользователю работать с приложением до истечения срока его действия.


#### Примеры кода


Просмотрите примеры кода для сценариев "из веб-браузера в веб-приложение". Регулярно возвращайтесь к этому разделу — мы постоянно добавляем новые примеры. [Из веб-браузера в веб-приложение](active-directory-code-samples.md#web-browser-to-web-application).


#### Регистрация


- Однотенантный: при создании приложения только для своей организации его необходимо зарегистрировать в каталоге вашей организации с помощью портала управления Azure.


- Мультитенантный: при создании приложения, которое может использоваться пользователями за пределами вашей организации, его необходимо зарегистрировать в каталоге вашей компании, а также в каталоге каждой организации, пользователи из которой будут использовать данное приложение. Чтобы ваше приложение сделать доступным в чужом каталоге, можно реализовать процесс входа для клиентов, с помощью которого они смогут предоставлять вашему приложению требуемые разрешения. При входе клиентов в приложение для них будет отображаться диалоговое окно с разрешениями, которые требуются приложению. В этом окне также можно будет предоставить требуемые разрешения. В зависимости от необходимых разрешений может потребоваться, чтобы их предоставил администратор из другой организации. Если пользователь или администратор предоставляет требуемые разрешения, приложение регистрируется в их каталоге. Дополнительные сведения см. в статье [Интеграция приложений с Azure Active Directory](active-directory-integrating-applications.md).


#### Срок действия маркера

Срок действия пользовательского сеанса истекает по окончании времени жизни маркера, выданного системой Azure AD. При необходимости приложение может сократить этот период времени, например, обеспечивая выход пользователей на основании некоторого периода бездействия. По окончании сеанса пользователю будет предложено войти в систему снова.





### Одностраничное приложение (SPA)

В этом разделе описывается процедура проверки подлинности для одностраничного приложения, которое использует Azure AD и неявное предоставление авторизации OAuth 2.0 для защиты его серверной части веб-API. Обычно одностраничные приложения структурированы как уровень (интерфейсная часть) представления данных JavaScript, выполняемый в браузере, и серверная часть веб-API, которая выполняется на сервере и реализует бизнес-логику приложения. Дополнительные сведения о процессе неявного предоставления авторизации и его совместимости с вашим приложением см. в статье [Общие сведения о неявном потоке предоставления OAuth2 в Azure Active Directory (AD)](active-directory-dev-understanding-oauth2-implicit-grant.md).

В этом сценарии при входе пользователя в систему интерфейсная часть JavaScript использует [библиотеку проверки подлинности Active Directory для JavaScript (ADAL.JS)](https://github.com/AzureAD/azure-activedirectory-library-for-js/tree/dev) и неявное предоставление авторизации для получения маркера идентификатора (id\_token) из Azure AD. Маркер кэшируется, а клиент присоединяет его к запросу как маркер носителя при отправке вызовов в свою серверную часть веб-API, для защиты которого применяется ПО промежуточного слоя OWIN.
#### Схема

![Схема одностраничного приложения](./media/active-directory-authentication-scenarios/single_page_app.png)

#### Описание потока протокола

1. Пользователь переходит в веб-приложение.


2. Приложение возвращает браузеру интерфейс (уровень представления данных) JavaScript.


3. Пользователь выполняет вход, например щелкает ссылку входа. Браузер отправляет инструкцию GET в конечную точку авторизации Azure AD для запроса идентификатора маркера. Этот запрос содержит идентификатор клиента и URL-адрес ответа.


4. Azure AD проверяет достоверность URL-адреса ответа путем его сравнения с зарегистрированным URL-адресом ответа, который указан на портале управления Azure.


5. Пользователь выполняет вход на странице входа.


6. В случае успешной проверки подлинности Azure AD создает маркер идентификатора и возвращает его в виде фрагмента URL-адреса (#) по URL-адресу ответа приложения. В рабочем приложении для этого URL-адреса ответа должен использоваться протокол HTTPS. Возвращаемый маркер содержит утверждения о пользователе и системе Azure AD, которые требуются приложению для проверки маркера.


7. Клиентский код JavaScript, выполняемый в браузере, извлекает маркер из ответа для использования при защите вызовов, отправляемых в серверную часть веб-интерфейса API приложения.


8. Браузер вызывает серверную часть веб-интерфейса API приложения с помощью маркера доступа в заголовке авторизации.

#### Примеры кода


Просмотрите примеры кода для сценариев одностраничного приложения (SPA). Регулярно возвращайтесь к этому разделу — мы постоянно добавляем новые примеры. [Одностраничное приложение (SPA)](active-directory-code-samples.md#single-page-application-spa).


#### Регистрация


- Однотенантный: при создании приложения только для своей организации его необходимо зарегистрировать в каталоге вашей организации с помощью портала управления Azure.


- Мультитенантный: при создании приложения, которое может использоваться пользователями за пределами вашей организации, его необходимо зарегистрировать в каталоге вашей компании, а также в каталоге каждой организации, пользователи из которой будут использовать данное приложение. Чтобы ваше приложение сделать доступным в чужом каталоге, можно реализовать процесс входа для клиентов, с помощью которого они смогут предоставлять вашему приложению требуемые разрешения. При входе клиентов в приложение для них будет отображаться диалоговое окно с разрешениями, которые требуются приложению. В этом окне также можно будет предоставить требуемые разрешения. В зависимости от необходимых разрешений может потребоваться, чтобы их предоставил администратор из другой организации. Если пользователь или администратор предоставляет требуемые разрешения, приложение регистрируется в их каталоге. Подробнее: [Интеграция приложений с Azure Active Directory](active-directory-integrating-applications.md).

После регистрации приложения его необходимо настроить для использования протокола OAuth 2.0 Implicit Grant. По умолчанию для приложений этот протокол отключен. Чтобы включить протокол OAuth2 Implicit Grant для приложения, загрузите его манифест с портала управления Azure, установите для параметра oauth2AllowImplicitFlow значение true, а затем обратно загрузите манифест на портал. Подробные инструкции см. в разделе [Включение протокола OAuth 2.0 Implicit Grant для одностраничных приложений](active-directory-integrating-applications.md).


#### Срок действия маркера

При использовании ADAL.js для управления проверкой подлинности с помощью Azure AD, можно применять несколько удобных функций, которые позволяют упрощать процедуру обновления просроченных маркеров, а также получать маркеры для дополнительных ресурсов веб-интерфейса API, которые может вызывать приложение. Если пользователь успешно проходит проверку подлинности с помощью Azure AD, между браузером и Azure AD для пользователя устанавливается сеанс, для защиты которого используется файл cookie. Важно отметить, что сеанс устанавливается между пользователем и Azure AD, а не между пользователем и веб-приложением, выполняемым на сервере. По истечении срока действия маркера файл ADAL.js использует этот сеанс для автоматического получения другого маркера. Это делается с помощью скрытого фрейма iFrame, отправляющего и получающего запросы по протоколу OAuth Implicit Grant. ADAL.js может использовать такой же механизм для автоматического получения маркеров доступа из Azure AD для других ресурсов веб-интерфейса API, которые приложение может вызывать до тех пор, пока эти ресурсы поддерживают функцию общего доступа к ресурсам независимо от источника (CORS), зарегистрированы в каталоге пользователя, и все необходимые разрешения (согласие) даны пользователем при входе в систему.


### Из нативного приложения к веб-интерфейсу API


В этом разделе описывается нативное приложение, которое вызывает веб-интерфейс API от имени пользователя. Этот сценарий построен на основе типа предоставления кода авторизации OAuth 2.0 с общедоступным клиентом, как описано в разделе 4.1 в документе [Спецификация OAuth 2.0](http://tools.ietf.org/html/rfc6749). Нативное приложение получает маркер доступа для пользователя с помощью протокола OAuth 2.0. Затем этот маркер передается в запросе к веб-интерфейсу API, который авторизует пользователя и возвращает нужный ресурс.

#### Схема

![Схема "из нативного приложения в веб-интерфейс API"](./media/active-directory-authentication-scenarios/native_app_to_web_api.png)

#### Поток проверки подлинности между нативным приложением и API

#### Описание потока протокола


В случае использования библиотек проверки подлинности AD они обрабатывают большинство описанных ниже операций протокола, например всплывающее окно браузера, кэширование маркера и обработка маркеров обновления.

1. С помощью всплывающего окна браузера нативное приложение отправляет запрос в конечную точку авторизации в Azure AD. Данный запрос включает идентификатор клиента и URI перенаправления нативного приложения, как показано на портале управления, а также URI идентификатора приложения для веб-интерфейса API. Если пользователь еще не вошел в систему, ему будет предложено войти снова.


2. Azure AD выполняет проверку подлинности пользователя. Если это мультитенантное приложение, и для использования приложения требуется получение от пользователя разрешений, пользователю будет нужно дать предоставить их, если он еще этого не сделал. После предоставления разрешений и успешной проверки подлинности Azure AD отправляет обратно ответ с кодом авторизации на URI перенаправления клиентского приложения.


3. Когда Azure AD отправляет обратно ответ с кодом авторизации на URI перенаправления, клиентское приложение прекращает взаимодействие с браузером и извлекает код авторизации из ответа. Используя этот код авторизации, клиентское приложение отправляет запрос в конечную точку маркера системы Azure AD, который содержит код авторизации, сведения о клиентском приложении (идентификатор клиента и URI перенаправления) и требуемый ресурс (URI идентификатора приложения для веб-интерфейса API).


4. Azure AD проверяет код авторизации, сведения о клиентских приложениях и веб-интерфейс API. После успешной проверки Azure AD возвращает два маркера: маркер доступа JWT и маркер обновления JWT. Кроме того, Azure AD возвращает основные сведения о пользователе, например его отображаемое имя и идентификатор клиента.


5. Клиентское приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.


6. По истечении срока действия маркера доступа клиентское приложение получит сообщение об ошибке с информацией о том, что пользователь должен снова пройти проверку подлинности. Если приложение имеет действительный маркер обновления, он может использоваться для получения нового маркера доступа (при этом пользователю не будет предлагаться снова выполнить вход). По истечении срока действия маркера обновления приложение должно выполнить еще раз интерактивную проверку подлинности пользователя.


> [AZURE.NOTE] Маркер обновления, выданный системой Azure AD, может применяться для доступа к нескольким ресурсам. Например, если у вас есть клиентское приложение, которое имеет разрешение на вызов двух веб-интерфейсов API, маркер обновления может также использоваться для получения маркера доступа к другому веб-интерфейсу API.


#### Примеры кода


Просмотрите примеры кода для сценариев "из нативного приложения в веб-интерфейс API". Регулярно возвращайтесь к этому разделу — мы постоянно добавляем новые примеры. [Из нативного приложения в веб-интерфейс API](active-directory-code-samples.md#native-application-to-web-api)


#### Регистрация


- Однотенантное. Нативное приложение и веб-интерфейс API должны быть зарегистрированы в одном и том же каталоге в Azure AD. Веб-интерфейс API можно настроить для предоставления набора разрешений, которые используются для ограничения доступа нативного приложения к его ресурсам. Затем клиентское приложение выбирает нужные разрешения, указанные в раскрывающемся меню "Разрешения для других приложений" на портале управления Azure.


- Мультитенантное. Во-первых, это нативное приложение, но зарегистрированное в каталоге разработчика или издателя. Во-вторых, нативное приложение настраивается, чтобы пользователь мог указать разрешения, необходимые для его функционирования. Список необходимых разрешений отображается в диалоговом окне, и когда пользователь или администратор в каталоге назначения предоставляет эти разрешения, это делает приложение доступным для его организации. Некоторым приложениям требуются только разрешения на уровне пользователя, предоставить которые может любой пользователь в организации. Другим приложениям требуются разрешения на уровне администратора, предоставить которые не может обычный пользователь в организации. Предоставить такие разрешения может только администратор каталога. Когда пользователь или администратор предоставляет разрешения, в его каталоге регистрируется только веб-интерфейс API. Дополнительные сведения см. в статье [Интеграция приложений с Azure Active Directory](active-directory-integrating-applications.md).


#### Срок действия маркера


Если нативное приложение использует свой код авторизации для получения маркера доступа JWT, оно также получает маркер обновления JWT. По истечении срока действия маркера доступа маркер обновления может быть использован для повторной проверки подлинности пользователя без необходимости повторного входа. Затем этот маркер обновления используется для проверки подлинности пользователя, в результате чего появляется новый маркер доступа и маркер обновления.





### Из веб-приложения к веб-интерфейсу API


В этом разделе описывается веб-приложение, которому нужно получить ресурсы из веб-интерфейса API. В данном сценарии имеются идентификаторы двух типов, которые веб-приложение может использовать для проверки подлинности и вызова веб-интерфейса API: удостоверение приложения и делегированное удостоверение пользователя.

*Удостоверение приложения*. Для удостоверения приложения в этом сценарии используется предоставление учетных данных клиента OAuth 2.0 — как для аутентификации приложения, так и для доступа к веб-API. При использовании удостоверения приложения веб-интерфейс API может только обнаружить, что его вызывает веб-приложение, так как веб-интерфейс API не получает каких-либо сведений о пользователе. Если приложение получает сведения о пользователе, они будут отправляться посредством протокола приложения и не будут подписываться системой Azure AD. Веб-интерфейс API доверяет веб-приложению проверку подлинности пользователя. По этой причине данная схема называется доверенной (надежной) подсистемой.

*Делегированное удостоверение пользователя*. Этот сценарий можно реализовать двумя способами: использовать OpenID Connect и предоставить код авторизации OAuth 2.0 с помощью конфиденциального клиента. Веб-приложение получает маркер доступа для пользователя, который подтверждает веб-интерфейсу API, что пользователь успешно прошел проверку подлинности для веб-приложения, и что веб-приложение смогло получить делегированное удостоверение пользователя для вызова веб-интерфейса API. Этот маркер передается в запросе к веб-интерфейсу API, который авторизует пользователя и возвращает нужный ресурс.

#### Схема

![Схема "из веб-приложения в веб-интерфейс API"](./media/active-directory-authentication-scenarios/web_app_to_web_api.png)



#### Описание потока протокола

Ниже рассматриваются удостоверение приложения и делегированное удостоверение пользователя. Основное различие между ними заключается в том, что делегированное удостоверение пользователя сначала должно получить код авторизации, прежде чем пользователь сможет выполнить вход и получить доступ к веб-интерфейсу API.

##### Удостоверение приложения с предоставлением учетных данных клиента OAuth 2.0

1. Пользователь входит в систему Azure AD в веб-приложении (см. раздел [Из веб-браузера в веб-приложение](#web-browser-to-web-application) выше).


2. Чтобы веб-приложение могло выполнить проверку подлинности для веб-интерфейса API и получить нужный ресурс, это приложение должно получить маркер доступа. Оно отправляет запрос в конечную точку маркера Azure AD, предоставляя учетные данные, идентификатор клиента и URI идентификатора приложения веб-интерфейса API.


3. Azure AD проверяет подлинность приложения и возвращает маркер доступа JWT, который используется для вызова веб-интерфейса API.


4. Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.

##### Делегированное удостоверение пользователя с OpenID Connect

1. Пользователь входит в веб-приложение с помощью Azure AD (см. раздел [Из веб-браузера в веб-приложение](#web-browser-to-web-application) выше). Если пользователь веб-приложения еще не дал согласие на то, чтобы разрешить веб-приложению вызывать веб-интерфейс API от своего имени, пользователь должен дать такое согласие. Приложение отобразит разрешения, предоставление которых от него требуется, и, если любое из этих разрешений относится к уровню администратора, обычный пользователь в каталоге не сможет дать такое разрешение. Процесс предоставления разрешений применяется только к мультитенантным, но не к однотенантным приложениям, так как приложение уже будет иметь необходимые разрешения. После того как пользователь выполнит вход, веб-приложение получит маркер идентификатора со сведениями о пользователе, а также код авторизации.


2. Используя код авторизации, выданный системой Azure AD, веб-приложение отправляет запрос в конечную точку маркера Azure AD, которая содержит код авторизации, сведения о клиентском приложении (идентификатор клиента и URI перенаправления) и требуемый ресурс (URI идентификатора приложения для веб-интерфейса API).


3. Код авторизации, а также сведения о веб-приложении и веб-интерфейсе API проверяются системой Azure AD. После успешной проверки Azure AD возвращает два маркера: маркер доступа JWT и маркер обновления JWT.


4. Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.

##### Делегированное удостоверение пользователя с предоставлением кода авторизации OAuth 2.0

1. Пользователь уже вошел в веб-приложение, механизм проверки подлинности которого не зависит от Azure AD.


2. Веб-приложению требуется код авторизации, чтобы получить маркер доступа. Поэтому оно отправляет запрос через браузер в конечную точку авторизации Azure AD, предоставляя идентификатор клиента и URI перенаправления для веб-приложения после успешной проверки подлинности. Пользователь выполняет вход в Azure AD.


3. Если пользователь веб-приложения еще не дал согласие на то, чтобы разрешить веб-приложению вызывать веб-интерфейс API от своего имени, пользователь должен дать такое согласие. Приложение отобразит разрешения, предоставление которых от него требуется, и, если любое из этих разрешений относится к уровню администратора, обычный пользователь в каталоге не сможет дать такое разрешение. Процесс предоставления разрешений применяется только к мультитенантным, но не к однотенантным приложениям, так как приложение уже будет иметь необходимые разрешения.


4. После того как пользователь предоставит разрешения, веб-приложение получает код авторизации, необходимый для получения маркера доступа.


5. Используя код авторизации, выданный системой Azure AD, веб-приложение отправляет запрос в конечную точку маркера Azure AD, которая содержит код авторизации, сведения о клиентском приложении (идентификатор клиента и URI перенаправления) и требуемый ресурс (URI идентификатора приложения для веб-интерфейса API).


6. Код авторизации, а также сведения о веб-приложении и веб-интерфейсе API проверяются системой Azure AD. После успешной проверки Azure AD возвращает два маркера: маркер доступа JWT и маркер обновления JWT.


7. Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.

#### Примеры кода

Просмотрите примеры кода для сценариев "из веб-приложения в веб-интерфейс API". Регулярно возвращайтесь к этому разделу — мы постоянно добавляем новые примеры. Из [веб-приложения к веб-интерфейсу API](active-directory-code-samples.md#web-application-to-web-api)


#### Регистрация

- Однотенантный: как для удостоверения приложения, так и для делегированного удостоверения пользователя, веб-приложение и веб-интерфейс API должны быть зарегистрированы в одном и том же каталоге в Azure AD. Веб-интерфейс API можно настроить для предоставления набора разрешений, которые используются для ограничения доступа веб-приложения к его ресурсам. Если используется тип делегированного удостоверения пользователя, веб-приложению необходимо выбрать нужные разрешения, указанные в раскрывающемся меню "Разрешения для других приложений" на портале управления Azure. Этот шаг не является обязательным, если используется тип удостоверения приложения.


- Мультитенантный: во-первых, веб-приложение настраивается, чтобы пользователь мог указать разрешения, необходимые для его функционирования. Список необходимых разрешений отображается в диалоговом окне, и когда пользователь или администратор в каталоге назначения предоставляет эти разрешения, это делает приложение доступным для его организации. Некоторым приложениям требуются только разрешения на уровне пользователя, предоставить которые может любой пользователь в организации. Другим приложениям требуются разрешения на уровне администратора, предоставить которые не может обычный пользователь в организации. Предоставить такие разрешения может только администратор каталога. Если пользователь или администратор предоставляет требуемые разрешения, веб-приложение и веб-интерфейс API регистрируются в их каталоге.

#### Срок действия маркера

Если веб-приложение использует свой код авторизации для получения маркера доступа JWT, оно также получает маркер обновления JWT. По истечении срока действия маркера доступа маркер обновления может быть использован для повторной проверки подлинности пользователя без необходимости повторного входа. Затем этот маркер обновления используется для проверки подлинности пользователя, в результате чего появляется новый маркер доступа и маркер обновления.


### Из управляющей программы или серверного приложения в веб-интерфейс API


В этом разделе описывается управляющая программа или серверное приложение, которому требуется получить ресурсы из веб-интерфейса API. Существуют два подсценария, которые относятся к этому разделу: управляющая программа (демон), которая должна вызывать веб-интерфейс API, встроенный в тип предоставления учетных данных клиента OAuth 2.0; и серверное приложение (например, веб-интерфейс API), который должен вызывать веб-интерфейс API, встроенный в проект спецификации OAuth 2.0 On-Behalf-Of.

Для сценария, в котором управляющая программа должна вызывать веб-интерфейс API, важно понять следующие моменты. Во-первых, пользователь не может взаимодействовать с управляющей программой, которой требуется собственное удостоверение приложения. Примером управляющей программы является пакетное задание или служба операционной системы, которая выполняется в фоновом режиме. Приложение данного типа запрашивает маркер доступа с помощью своего удостоверения и предоставляет в Azure AD свои идентификатор клиента, учетные данные (пароль или сертификат), а также идентификатор URI приложения. После успешной проверки подлинности управляющая программа получает маркер доступа из Azure AD, который затем используется для вызова веб-интерфейса API.

Для сценария, при котором серверное приложение должно вызывать веб-интерфейс API, полезно рассмотреть следующий пример. Предположим, что пользователь прошел проверку подлинности для нативного приложения, и этому приложению требуется вызвать веб-интерфейс API. Azure AD выдает маркер доступа JWT для вызова веб-интерфейса API. Если веб-интерфейсу API требуется вызвать другой подчиненный веб-интерфейс API, он позволяет использовать поток "от имени", чтобы делегировать удостоверение пользователя и пройти проверку подлинности для веб-интерфейса API второго уровня.

#### Схема

![Схема "из управляющей программы или серверного приложения в веб-интерфейс API"](./media/active-directory-authentication-scenarios/daemon_server_app_to_web_api.png)

#### Описание потока протокола

##### Удостоверение приложения с предоставлением учетных данных клиента OAuth 2.0

1. Сначала серверное приложение должно пройти проверку подлинности в Azure AD от своего имени, без участия пользователя (то есть без интерактивного диалогового окна входа). Оно отправляет запрос в конечную точку маркера Azure AD, предоставляя учетные данные, идентификатор клиента и URI идентификатора приложения.


2. Azure AD проверяет подлинность приложения и возвращает маркер доступа JWT, который используется для вызова веб-интерфейса API.


3. Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-интерфейс API проверяет этот маркер JWT, и, если проверка будет выполнена успешно, возвращает требуемый ресурс.


##### Делегированное удостоверение пользователя с проектом спецификации OAuth 2.0 On-Behalf-Of (от имени)

Поток, описанный ниже, предполагает, что пользователь прошел проверку подлинности в другом приложении (например, в нативном приложении), и его учетные данные были использован для получения маркера доступа к веб-интерфейсу API первого уровня.

1. Нативное приложение отправляет маркер доступа в веб-интерфейс API первого уровня.


2. Данный интерфейс отправляет запрос в конечную точку маркера Azure AD, предоставляя свои идентификатор клиента, учетные данные, а также маркер доступа пользователя. Кроме того, запрос отправляется с параметром on\_behalf\_of, указывающим, что веб-интерфейс API запрашивает новые маркеры для вызова нисходящего (подчиненного) веб-интерфейса API от имени исходного пользователя.


3. Azure AD проверяет, что веб-интерфейс API первого уровня имеет разрешения на доступ к веб-интерфейсу API второго уровня, и проверяет запрос, возвращая маркер доступа JWT и маркер обновления JWT в веб-интерфейс API первого уровня.


4. Затем по протоколу HTTPS веб-интерфейс API первого уровня вызывает веб-интерфейс API второго уровня, добавляя строку маркера в заголовок авторизации в запросе. Веб-интерфейс API первого уровня может продолжать вызывать веб-интерфейс API второго уровня до тех пор, пока маркеры доступа и обновления остаются действительными.

#### Примеры кода

Просмотрите примеры кода для сценариев "из управляющей программы или серверного решения в веб-интерфейс API". Регулярно возвращайтесь к этому разделу — мы постоянно добавляем новые примеры. [Из серверного приложения или управляющей программы в веб-интерфейс API](active-directory-code-samples.md#server-or-daemon-application-to-web-api)

#### Регистрация

- Однотенантный: как для удостоверения приложения, так и делегированного удостоверения пользователя, управляющая программа или серверное приложение должны быть зарегистрированы в одном и том же каталоге в Azure AD. Веб-интерфейс API можно настроить для предоставления набора разрешений, которые используются для ограничения доступа управляющей программы или сервера к его ресурсам. Если используется тип делегированного удостоверения пользователя, серверному приложению необходимо выбрать нужные разрешения, указанные в раскрывающемся меню "Разрешения для других приложений" на портале управления Azure. Этот шаг не является обязательным, если используется тип удостоверения приложения.


- Мультитенантный: сначала настраивается управляющая программа или серверное приложение, чтобы пользователь мог указать разрешения, необходимые для его функционирования. Список необходимых разрешений отображается в диалоговом окне, и когда пользователь или администратор в каталоге назначения предоставляет эти разрешения, это делает приложение доступным для его организации. Некоторым приложениям требуются только разрешения на уровне пользователя, предоставить которые может любой пользователь в организации. Другим приложениям требуются разрешения на уровне администратора, предоставить которые не может обычный пользователь в организации. Предоставить такие разрешения может только администратор каталога. Если пользователь или администратор предоставляет требуемые разрешения, в его каталоге регистрируются оба веб-интерфейса API.

#### Срок действия маркера

Если первое приложение использует свой код авторизации для получения маркера доступа JWT, оно также получает маркер обновления JWT. По истечении срока действия маркера доступа маркер обновления может использоваться для повторной проверки подлинности пользователя без запроса учетных данных. Затем этот маркер обновления используется для проверки подлинности пользователя, в результате чего появляется новый маркер доступа и маркер обновления.

## См. также

[Руководство разработчика по Azure Active Directory](active-directory-developers-guide.md)

[Примеры кода Azure Active Directory](active-directory-code-samples.md)

[Важные сведения о смене ключей подписи в Azure AD](active-directory-signing-key-rollover.md)

[OAuth 2.0 в Azure AD](https://msdn.microsoft.com/library/azure/dn645545.aspx)

<!---HONumber=AcomDC_0921_2016-->