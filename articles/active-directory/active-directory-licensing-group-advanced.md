---
title: Дополнительные сценарии лицензирования на основе группы в Azure Active Directory | Документация Майкрософт
description: Дополнительные сценарии лицензирования на основе группы в Azure Active Directory
services: active-directory
keywords: Лицензирование Azure AD
documentationcenter: ''
author: curtand
manager: mtillman
editor: piotrci
ms.service: active-directory
ms.topic: article
ms.workload: identity
ms.component: users-groups-roles
ms.date: 06/02/2017
ms.author: curtand
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: bb8bd727618eda2a887cc9e1b739889204eb87fa
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
ms.locfileid: "33764389"
---
# <a name="scenarios-limitations-and-known-issues-using-groups-to-manage-licensing-in-azure-active-directory"></a>Сценарии, ограничения и известные проблемы при использовании групп для управления лицензированием в Azure Active Directory

Следующие сведения и примеры помогут вам расширить свои знания о лицензировании на основе группы Azure Active Directory (Azure AD).

## <a name="usage-location"></a>Расположение использования

Некоторые службы Майкрософт недоступны во всех расположениях. Прежде чем назначать лицензию, администратор должен указать для пользователя свойство **Место использования**. Это свойство можно задать в разделе **Пользователь** &gt; **Профиль** &gt; **Параметры** на [портале Azure](https://portal.azure.com).

Если лицензии назначаются группам, все пользователи, для которых не указано место использования, наследуют расположение каталога. Если пользователи находятся в нескольких местах, это должно быть правильно обозначено в объектах пользователей до добавления пользователей в группы с лицензиями.

> [!NOTE]
> Назначение лицензии группе никогда не изменит существующее значение места использования для пользователя. Мы рекомендуем всегда указывать место использования в процессе создания пользователей в Azure AD (например, при настройке AAD Connect). Это позволяет гарантировать, что результат назначения лицензий будет всегда правильным и пользователи не получат службы в недопустимых местах.

## <a name="use-group-based-licensing-with-dynamic-groups"></a>Лицензирование на основе группы с использованием динамических групп

Лицензирование на основе группы можно использовать с любой группой безопасности, а это значит, что ее можно использовать с динамическими группами Azure AD. Динамические группы выполняют правила для атрибутов объекта пользователя, чтобы автоматически добавлять пользователей в группы и удалять их из них.

Например, можно создать динамическую группу для некоторого набора продуктов, которые необходимо назначить пользователям. Каждая группа содержит правило добавления пользователей, просматривающее определенные атрибуты пользователя и описывающее набор лицензий, которые он должен получить. Атрибут можно назначить локально и синхронизировать с Azure AD либо управлять им непосредственно в облаке.

Вскоре после добавления пользователя в группу ему назначаются лицензии. При изменении атрибута пользователь покидает группу, и лицензии удаляются.

### <a name="example"></a>Пример

Рассмотрим пример локального решения по управлению удостоверениями, определяющего, какие пользователи должны иметь доступ к определенным веб-службам Майкрософт. Для хранения строкового значения, представляющего лицензии, которые должен иметь пользователь, это решение использует атрибут **extensionAttribute1**. Azure AD Connect синхронизирует его с Azure AD.

Пользователям может потребоваться лишь одна лицензия из двух, либо могут потребоваться обе лицензии. Ниже приведен пример распространения лицензий на Office 365 Корпоративный E5 и Enterprise Mobility + Security (EMS) среди пользователей в группах:

#### <a name="office-365-enterprise-e5-base-services"></a>Базовые службы Office 365 корпоративный E5

![Снимок экрана базовых служб Office 365 корпоративный E5](media/active-directory-licensing-group-advanced/o365-e5-base-services.png)

#### <a name="enterprise-mobility--security-licensed-users"></a>Лицензированные пользователи Enterprise Mobility + Security

![Снимок экрана лицензированных пользователей Enterprise Mobility + Security](media/active-directory-licensing-group-advanced/o365-e5-licensed-users.png)

В этом примере измените одного пользователя локально, а его атрибуту extensionAttribute1 задайте значение `EMS;E5_baseservices;`, если пользователю требуется предоставить обе лицензии. Эти изменения можно внести в локальной среде. После синхронизации изменений с облаком пользователь автоматически добавляется в обе группы, и ему назначаются лицензии.

![Снимок экрана, показывающий, как задать атрибут extensionAttribute1 пользователя](media/active-directory-licensing-group-advanced/user-set-extensionAttribute1.png)

> [!WARNING]
> При изменении правила членства в имеющейся группе следует соблюдать осторожность. После изменения правила для участия в группе применяются новые условия, и пользователи, которые больше не удовлетворяют условиям нового правила, будут удалены из группы (пользователи, которые по-прежнему соответствуют условиям нового правила, не будут затронуты во время этого процесса). Лицензии таких пользователей удаляются во время этого процесса, что может привести к прекращению обслуживания или, в некоторых случаях, к потере данных.

> Если имеется крупная динамическая группа, от которой зависит назначение лицензии, рекомендуется проверить возможные значительные изменения на тестовой группе меньшего размера, прежде чем применять их к основной группе.

## <a name="multiple-groups-and-multiple-licenses"></a>Несколько групп и несколько лицензий

Пользователь может быть участником нескольких групп с лицензиями. При этом нужно помнить о следующем:

- При наличии нескольких лицензий на один продукт они могут перекрываться, что приведет к тому, что все включенные службы будут применены к пользователю. В следующем примере показано две группы лицензирования: группа *E3 — базовые службы* содержит основные службы, которые необходимо развернуть в первую очередь для всех пользователей, а группа *E3 — расширенные службы* — дополнительные службы (Sway и планировщик), развертываемые только определенным пользователям. В этом примере пользователь добавлен в обе группы:

  ![Снимок экрана включенных служб](media/active-directory-licensing-group-advanced/view-enabled-services.png)

  В результате этому пользователю доступно 7 служб из 12 в продукте при использовании только одной лицензии на этот продукт.

- Если выбрать лицензию *E3*, отобразятся дополнительные сведения, включая данные о том, какие службы доступны пользователю при членстве в определенных группах.

  ![Снимок экрана включенных служб по группе](media/active-directory-licensing-group-advanced/view-enabled-service-by-group.png)

## <a name="direct-licenses-coexist-with-group-licenses"></a>Совместное использование прямых лицензий с лицензиями группы

Если пользователь наследует лицензию от группы, удалить или изменить назначение лицензий непосредственно в свойствах пользователя невозможно. Все изменения необходимо внести в группе, а затем распространить их для всех пользователей.

Тем не менее в дополнение к унаследованной лицензии пользователю можно присвоить лицензию продукта. Можно включить дополнительные службы из продукта только для одного пользователя, не затрагивая остальных пользователей.

Непосредственно назначенные лицензии можно удалить. Кроме того, это не повлияет на наследуемые лицензии. Рассмотрим пример, в котором пользователь наследует лицензию на план Office 365 Корпоративный E3 от группы.

1. Изначально пользователь наследует лицензию только от группы *E3 — базовые службы*, в рамках которой предлагается четыре плана обслуживания, как показано ниже.

  ![Снимок экрана служб, включенных в группе E3](media/active-directory-licensing-group-advanced/e3-group-enabled-services.png)

2. Можно выбрать **Назначить**, чтобы напрямую назначить пользователю лицензию E3. В этом случае вы собираетесь отключить все планы службы, за исключением Yammer Корпоративный.

  ![Снимок экрана назначения лицензии непосредственно пользователю](media/active-directory-licensing-group-advanced/assign-license-to-user.png)

3. В результате пользователь по-прежнему использует только одну лицензию на продукт E3, но при прямом назначении служба Yammer корпоративный активируется только для этого пользователя. Можно увидеть, какие службы активируются при членстве в группе и прямом назначении.

  ![Снимок экрана унаследованного и прямого назначения](media/active-directory-licensing-group-advanced/direct-vs-inherited-assignment.png)

4. При использовании прямого назначения разрешены следующие операции:

  - Yammer корпоративный можно отключить непосредственно в объекте пользователя. В отличие от других переключателей службы переключатель **Вкл./Выкл.** активирован, так как эта служба включена непосредственно для пользователя, и поэтому ее можно изменить.
  - Можно также включить дополнительные службы как часть напрямую назначенной лицензии.
  - Кнопку **Удалить** можно использовать для удаления прямой лицензии пользователя. Вы увидите, что после этого у пользователя будет только унаследованная лицензия группы и только исходные службы останутся включенными.

    ![Снимок экрана, показывающий, как удалить прямое назначение](media/active-directory-licensing-group-advanced/remove-direct-license.png)

## <a name="managing-new-services-added-to-products"></a>Управление новыми службами, добавляемыми в продукты
Когда Майкрософт добавляет новую службу в продукт, она будет по умолчанию разрешена во всех группах, которым были назначены лицензии на продукт. Пользователи в клиенте, которые подписаны на уведомления об изменениях продукта, заранее получат сообщения электронной почты с уведомлением о предстоящих дополнениях.

Администратор может просмотреть все группы, затронутые изменением, и принять соответствующие меры, например отключить новую службу в каждой группе. Например, при создании групп, предназначенных для развертывания только определенных служб, можно проверить эти группы и убедиться в том, что новые добавленные службы отключены.

Ниже приведен пример того, как этот процесс может выглядеть.

1. Первоначально продукт *Office 365 Корпоративный E5* назначен нескольким группам. Одна из этих групп, которая называется *O365 E5 - Exchange only*, была предназначена для того, чтобы ее участникам была доступна только служба *Exchange Online (план 2)*.

2. Вы получили уведомление от корпорации Майкрософт, в котором сообщается, что продукт E5 будет дополнен новой службой — *Microsoft Stream*. Когда служба становится доступной в клиенте, можно сделать следующее:

3. Последовательно выберите пункты [ **Azure Active Directory > Лицензий > Все продукты** ](https://portal.azure.com/#blade/Microsoft_AAD_IAM/LicensesMenuBlade/Products) и выберите *Office 365 Корпоративный E5*, а затем **Лицензированные группы** для просмотра списка всех групп, которым назначен этот продукт.

4. Щелкните группу, чтобы просмотреть ее (в этом случае *O365 E5 - Exchange only*). После этого откроется вкладка **Лицензии**. Щелкните лицензию E5, чтобы открыть колонку со списком всех активированных служб.
> [!NOTE]
> Служба *Microsoft Stream* автоматически добавлена и включена в этой группе, помимо службы *Exchange Online*:

  ![Снимок экрана новой службы, добавленной в лицензию для группы](media/active-directory-licensing-group-advanced/manage-new-services.png)

5. Чтобы отключить новую службу в этой группе, щелкните переключатель **Вкл./Выкл.** рядом с новой службой и нажмите кнопку **Сохранить**, чтобы подтвердить изменение. Azure AD теперь обработает всех пользователей в группе, чтобы применить изменение. Для каждого нового пользователя, добавляемого в группу, служба *Microsoft Stream* будет отключена.

  > [!NOTE]
  > Пользователи по-прежнему могут активировать службу с помощью других назначений лицензий (посредством других групп, в которые они входят, или путем прямого назначения лицензий).

6. При необходимости повторите эти действия для других групп, которым назначен этот продукт.

## <a name="use-powershell-to-see-who-has-inherited-and-direct-licenses"></a>Использование PowerShell для просмотра пользователей с унаследованными и прямыми лицензиями
Чтобы проверить, назначена ли лицензия напрямую или унаследована от группы, можно использовать сценарий PowerShell.

1. Запустите командлет `connect-msolservice`, чтобы выполнить проверку подлинности и подключиться к клиенту.

2. `Get-MsolAccountSku` можно использовать для обнаружения всех подготовленных лицензий продукта в клиенте.

  ![Снимок экрана использования командлета Get-Msolaccountsku](media/active-directory-licensing-group-advanced/get-msolaccountsku-cmdlet.png)

3. Используйте значение *AccountSkuId* для интересующей вас лицензии в [этом сценарии PowerShell](./active-directory-licensing-ps-examples.md#check-if-user-license-is-assigned-directly-or-inherited-from-a-group). В результате будет представлен список пользователей, имеющих лицензии с информацией о назначении лицензии.

## <a name="use-audit-logs-to-monitor-group-based-licensing-activity"></a>Использование журналов аудита для наблюдения за активностью лицензирования на основе групп

Можно использовать [журналы аудита Azure AD](./active-directory-reporting-activity-audit-logs.md#audit-logs) для просмотра всех операций, связанных с лицензированием на основе группы, включая следующие сведения:
- кто изменил лицензии для групп;
- когда система приступила к обработке изменения в лицензии для группы и когда она завершила обработку;
- какие изменения были внесены в лицензию в результате назначения лицензии группе.

>[!NOTE]
> Журналы аудита доступны в большинстве колонок в разделе Azure Active Directory на портале. В зависимости от того, где вы просматриваете их, можно предварительно применить фильтры для отображения только тех действий, которые связаны с контекстом колонки. Если ожидаемые результаты не отображаются, проверьте [параметры фильтрации](./active-directory-reporting-activity-audit-logs.md#filtering-audit-logs) или перейдите к неотфильтрованным журналам аудита в разделе [ **Azure Active Directory > Действия > Журналы аудита**](https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Audit).

### <a name="find-out-who-modified-a-group-license"></a>Определение автора изменения лицензии для группы

1. Установите для фильтра **Действие** значение *Set group license* (Настройка лицензии для группы) и нажмите кнопку **Применить**.
2. Результаты включают все варианты лицензий, настроенных или измененных в группах.
>[!TIP]
> Можно также ввести имя группы в фильтре *Целевой объект*, чтобы определить область результатов.

3. Щелкните элемент в представлении списка, чтобы просмотреть сведения о том, что изменилось. В разделе *Измененные свойства* отображаются старые и новые значения для назначения лицензии.

Ниже приведен пример недавних изменений в лицензии для группы с подробными сведениями:

![Снимок экрана изменений в лицензии для группы](media/active-directory-licensing-group-advanced/audit-group-license-change.png)

### <a name="find-out-when-group-changes-started-and-finished-processing"></a>Определение того, когда началась и завершилась обработка изменений

При изменении лицензии для группы Azure AD начинает применять эти изменения ко всем пользователям.

1. Чтобы просмотреть, когда началась обработка группы, укажите для фильтра **Действие** значение *Start applying group based license to user* (Начать назначать пользователям лицензию, назначенную группе). Обратите внимание, что субъектом для операции является *Лицензирование Microsoft Azure AD на основе группы* — системной учетной записи, используемой для выполнения всех изменений лицензий для группы.
>[!TIP]
> Щелкните элемент в списке, чтобы отобразить поле *Измененные свойства*, в котором показаны изменения лицензии, которые были выбраны для обработки. Это полезно в том случае, если в группу внесены несколько изменений, и вы не уверены, какое из них было обработано.

2. Аналогичным образом, чтобы узнать, когда была завершена обработка групп, используйте значение фильтра *Finish Applying Group Based License To Users* (Завершить назначать пользователям лицензию, назначенную группе).
>[!TIP]
> В этом случае в поле *Измененные свойства* содержится сводка по результатам — это позволяет быстро проверить, возникали ли ошибки при обработке. Пример выходных данных:
> ```
Modified Properties
...
Name : Result
Old Value : []
New Value : [Users successfully assigned licenses: 6, Users for whom license assignment failed: 0.];
> ```

3. Чтобы просмотреть полный журнал и узнать, как выполнялась обработка группы, включая все изменения пользователей, задайте следующие фильтры:
  - **Инициатор (субъект)**: "Лицензирование Microsoft Azure AD на основе группы"
  - **Диапазон дат** (необязательно): пользовательский диапазон, если известно, что для определенной группы была запущена и завершена обработка

В этом примере выходных данных показаны дата и время запуска обработки, все результирующие изменения пользователей, а также дата и время завершения обработки.

![Снимок экрана изменений в лицензии для группы](media/active-directory-licensing-group-advanced/audit-group-processing-log.png)

>[!TIP]
> При выборе элементов, относящихся к параметру *Change User License* (Изменение лицензии пользователя), отображаются сведения об изменениях лицензии, примененных к каждому пользователю.

## <a name="deleting-a-group-with-an-assigned-license"></a>Удаление группы с назначенной лицензией

Удалить группу с активной назначенной лицензией невозможно. Администратор может удалить группу, не понимая, что это приведет к удалению лицензий пользователей. По этой причине мы требуем, чтобы все лицензии сначала были удалены из группы.

При попытке удалить группу на портале Azure может появиться уведомление об ошибке. Например, ![Снимок экрана. Не удалось удалить группу](media/active-directory-licensing-group-advanced/groupdeletionfailed.png)

Перейдите на вкладку **Лицензии** в группе и проверьте, нет ли назначенных лицензий. Если есть, удалите их и попытайтесь снова удалить группу.

Такая же ошибка может появиться при попытке удалить группу с помощью PowerShell или API Graph. Если вы используете группу, синхронизированную из локальной среды, Azure AD Connect также может сообщать об ошибках в случае сбоя при удалении группы в Azure AD. В таких случаях проверьте наличие лицензий, назначенных группе, и удалите их.

## <a name="limitations-and-known-issues"></a>Ограничения и известные проблемы

При использовании лицензирования на основе группы мы рекомендуем ознакомиться со следующим списком ограничений и известных проблем.

- Лицензирование на основе группы в настоящее время не поддерживает группы, содержащие другие группы (вложенные группы). Если применить лицензию к вложенной группе, она применяется только к участникам группы первого уровня.

- Данную функцию можно использовать только для групп безопасности. Группы Office в настоящее время не поддерживаются, и вы не сможете использовать их в процессе назначения лицензии.

- [Портал администрирования Office 365](https://portal.office.com ) сейчас не поддерживает лицензирование на основе группы. Если пользователь наследует лицензию от группы, эта лицензия отображается на портале администрирования Office как обычная лицензия пользователя. При попытке изменить или удалить эту лицензию на портале появится сообщение об ошибке. Наследуемые от группы лицензии невозможно изменить непосредственно для пользователя.

- Если пользователь удаляется из группы и теряет лицензии, для планов службы этой лицензии (например, SharePoint Online) устанавливается состояние **Приостановлено**. Окончательное отключенное состояния для планов службы не устанавливается. Это осуществляется в качестве меры предосторожности во избежание непреднамеренного удаления данных пользователя, если администратор совершит ошибку при управлении членством в группе.

- При назначении или изменении лицензий для большой группы пользователей (например, 100 000 пользователей) это может отрицательно повлиять на производительность. В частности, все изменения, внесенные службой автоматизации Azure AD, могут отрицательно повлиять на производительность синхронизации каталогов между Azure AD и локальными системами.

- В определенных ситуациях высокой нагрузки обработка лицензий может выполняться с задержкой, и на обработку таких изменений, как добавление или удаление лицензии группы либо добавление или удаление пользователей группы, может потребоваться много времени. Если обработка изменений занимает более 24 часов, отправьте [запрос в службу поддержки](https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/supportRequest), чтобы мы могли изучить эту проблему. Мы улучшим характеристики производительности этого компонента, прежде чем он станет *общедоступным*.

- Служба автоматизации управления лицензиями не реагирует автоматически на все типы изменений в среде. Например, у вас может быть недостаточно лицензий и некоторые пользователи будут находиться в состоянии ошибки. Чтобы освободить число доступных мест, вы можете удалить некоторые напрямую назначенные лицензии у других пользователей. Тем не менее система не будет автоматически реагировать на это изменение, и пользователи все еще будут находиться в этом состоянии ошибки.

  Чтобы обойти эту проблему, связанную с такого рода ограничениями, перейдите в колонку **Группа** в Azure AD и нажмите кнопку **Повторно обработать**. После этого все пользователи в этой группе будут обработаны, и состояние ошибки будет устранено, если это возможно.

- Лицензирование на основе группы не регистрирует ошибки, когда лицензию невозможно назначить пользователю из-за дублирующейся конфигурации прокси-адреса в Exchange Online; во время назначения лицензии такие пользователи пропускаются. Дополнительные сведения о выявлении и устранении этой проблемы см. в [ этом разделе](./active-directory-licensing-group-problem-resolution-azure-portal.md#license-assignment-fails-silently-for-a-user-due-to-duplicate-proxy-addresses-in-exchange-online).

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения о других сценариях управления лицензиями на основе группы см. в следующих статьях:

* [Group-based licensing basics in Azure Active Directory](active-directory-licensing-whatis-azure-portal.md) (Основы группового лицензирования в Azure Active Directory)
* [Назначение лицензий группе в Azure Active Directory](active-directory-licensing-group-assignment-azure-portal.md)
* [Поиск и устранение проблем лицензирования группы в Azure Active Directory](active-directory-licensing-group-problem-resolution-azure-portal.md)
* [Как перевести отдельных лицензированных пользователей на групповое лицензирование в Azure Active Directory](active-directory-licensing-group-migration-azure-portal.md)
