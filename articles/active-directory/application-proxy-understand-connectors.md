---
title: Сведения о соединителях прокси приложения Azure AD | Документация Майкрософт
description: Основные сведения о соединителях прокси приложения Azure AD.
services: active-directory
documentationcenter: ''
author: billmath
manager: mtillman
ms.assetid: ''
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/12/2017
ms.author: billmath
ms.reviewer: harshja
ms.custom: it-pro
ms.openlocfilehash: fe8d5c40249431be60dc8844adf7efa1b8e87c5f
ms.sourcegitcommit: 6fcd9e220b9cd4cb2d4365de0299bf48fbb18c17
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2018
---
# <a name="understand-azure-ad-application-proxy-connectors"></a>Сведения о соединителях прокси приложения Azure AD

Соединители являются основой для работы прокси приложения Azure AD. Они просты в использовании, развертывании и обслуживании. К тому же они очень производительны. В этой статье объясняется, что такое соединители, как они работают, и приводится несколько рекомендаций по оптимизации развертывания. 

## <a name="what-is-an-application-proxy-connector"></a>Что такое соединитель прокси приложения

Соединители — это упрощенные агенты, которые размещены в локальной среде. Они помогают устанавливать исходящие подключения к прокси приложения службы. Соединители необходимо установить на сервере Windows с доступом ко внутреннему приложению. Соединители можно организовать в группы соединителей, каждая из которых обрабатывает трафик определенных приложений. Соединители распределяют нагрузку автоматически и могут помочь оптимизировать структуру сети. 

## <a name="requirements-and-deployment"></a>Требования и развертывание

Чтобы успешно развернуть прокси приложения, необходим по крайней мере один соединитель, но мы рекомендуем использовать не меньше двух, чтобы повысить гибкость. Установите соединитель на компьютер Windows Server 2012 R2 или Windows Server 2016. Соединителю нужен доступ к службе прокси приложения, а также к локальным приложениям, которые вы публикуете. 

Дополнительные сведения о требованиях к сети для сервера соединителя см. в разделе [Начало работы с прокси приложения и установка соединителя](active-directory-application-proxy-enable.md).

## <a name="maintenance"></a>Обслуживание, 
Соединители и служба отвечают за выполнение задач, связанных с высоким уровнем доступности. Их можно добавлять или удалять динамически. Когда поступает новый запрос, он перенаправляется на один из доступных соединителей. Если соединитель временно недоступен, он перестает реагировать на трафик.

Соединители не поддерживают отслеживание состояния и не хранят данные конфигурации на компьютере. Единственные данные, которые они хранят, — это параметры подключения к службе и ее сертификат аутентификации. При подключении к службе соединители извлекают все необходимые данные конфигурации и обновляют их каждые несколько минут.

Они также опрашивают сервер, чтобы узнать, появилась ли более новая версия соединителя. Если такая версия будет найдена, соединители обновятся.

Соединители можно отслеживать с компьютера, на котором они выполняются, с помощью журнала событий и счетчиков производительности. Их состояние можно также просмотреть на портале Azure, на странице прокси приложения.

 ![Соединители прокси приложения Azure AD](./media/application-proxy-understand-connectors/app-proxy-connectors.png)

Вам не требуется вручную удалять неиспользуемые соединители. Выполняясь, соединитель остается активным, так как подключается к службе. Неиспользуемые соединители помечаются как _неактивные_ и удаляются спустя 10 дней бездействия. Если вы хотите удалить соединитель, то удалите с сервера службу соединителя и службу средства обновления. Перезагрузите компьютер, чтобы полностью удалить службу.

## <a name="automatic-updates"></a>Автоматическое обновление

Azure AD обеспечивает автоматическое обновление всех развертываемых соединителей. Пока служба средства обновления соединителей прокси приложения работает, соединители будут обновляться автоматически. Если служба обновления соединителей не отображается на сервере, для получения обновлений необходимо [переустановить соединитель](active-directory-application-proxy-enable.md). 

Если вы не хотите дожидаться, когда очередь дойдет до вашего соединителя, вы можете выполнить обновление вручную. Перейдите на [страницу скачивания соединителя](https://download.msappproxy.net/subscription/d3c8b69d-6bf7-42be-a529-3fe9c2e70c90/connector/download) на сервере, где находится соединитель, и выберите команду **Скачать**. Запустится обновление локального соединителя. 

Если клиент имеет несколько соединителей, автоматическое обновление производится для каждого соединителя поочередно в каждой группе, что позволяет избежать простоев в среде. 

При обновлении соединителя могут возникать простои в следующих случаях.  
- У вас только один соединитель. Чтобы избежать такого простоя и обеспечить высокий уровень доступности, установите второй соединитель и [создайте группу соединителей](active-directory-application-proxy-connectors-azure-portal.md).  
- Соединитель выполнял транзакцию в момент начала обновления. Хотя исходная транзакция утеряна, браузер должен автоматически повторить операцию. Вы также можете обновить страницу. При повторном запросе трафик направляется на резервный соединитель.

## <a name="creating-connector-groups"></a>Создание групп соединителей

Группы соединителей позволяют назначить определенные соединители для конкретных приложений. Несколько соединителей можно сгруппировать и назначить каждое приложение группе. 

Группы соединителей упрощают управление крупными развертываниями. Они также сокращают задержку для клиентов, приложения которых размещены в различных регионах, так как можно создать группы соединителей на основе расположения только для локальных приложений. 

Дополнительные сведения о группах соединителей см. в статье [Публикация приложений в отдельных сетях и расположениях с помощью групп соединителей](active-directory-application-proxy-connectors-azure-portal.md).

## <a name="capacity-planning"></a>Планирование емкости 

В то время как соединители автоматически сбалансируют нагрузку в пределах группы соединителей, важно также убедиться, что запланировано достаточно емкости между соединителями для обработки ожидаемого объема трафика. В целом, чем больше пользователей, тем большая машина потребуется. Ниже приведена таблица с описанием объема, который могут обработать разные компьютеры. Обратите внимание, что все данные основаны на ожидаемом числе транзакций в секунду (TPS), а не на числе пользователей. Причина в том, что шаблоны использования различаются, и на их основании нельзя спрогнозировать нагрузку.  Также следует отметить, что в зависимости от размера ответов и времени отклика серверного приложения будут наблюдаться некоторые различия. Больший размер ответов и большее время отклика приведут к снижению максимального числа транзакций в секунду (макс. TPS).

|Ядра|ОЗУ|Ожидаемая задержка (мс)-P99|Макс. TPS|
| ----- | ----- | ----- | ----- |
|2|8|325|586|
|4.|16|320|1150|
|8|32|270|1190|
|16|64|245|1200*|
\* Для этого компьютера установлено ограничение в 800 подключений. Для всех остальных компьютеров мы использовали предельное число подключений по умолчанию — 200.
 
>[!NOTE]
>В максимальном показателе TPS между компьютерами с 4, 8 и 16 ядрами нет существенных различий. Основное различие между ними — в ожидаемой задержке.  

## <a name="security-and-networking"></a>Безопасность и сеть

Соединители можно устанавливать в любом месте в сети. Поэтому они могут отправлять запросы к службе прокси приложения. Вам достаточно лишь обеспечить доступ к вашим приложениям с компьютера, на котором выполняется соединитель. Можно установить соединители в корпоративной сети или на виртуальной машине, работающей в облаке. Соединители могут работать в сети периметра, но это необязательно, так как весь трафик является исходящим, поэтому сеть защищена.

Соединители отправляют только исходящие запросы. Исходящий трафик отправляется в службу прокси приложения и в опубликованные приложения. Нет необходимости открывать входящие порты, так как после установления сеанса трафик передается в обе стороны. Нет необходимости настраивать распределение нагрузки между соединителями или прохождение входящего трафика через брандмауэры. 

Дополнительные сведения о настройке правил брандмауэра для исходящего трафика см. в статье [Работа с имеющимися локальными прокси-серверами](application-proxy-working-with-proxy-servers.md).

Воспользуйтесь [средством проверки портов соединителей прокси-службы приложения Azure AD](https://aadap-portcheck.connectorporttest.msappproxy.net/), чтобы проверить, сможет ли ваш соединитель подключиться к прокси-службе приложения. Как минимум следует убедиться, что для региона Central US (Центральная часть США) и ближайшего к вам региона отображаются все зеленые флажки. Учитывайте также, что большее число зеленых флажков означает большую устойчивость. 

## <a name="performance-and-scalability"></a>Производительность и масштабирование

Для службы прокси приложения масштабирование выполняется прозрачно, но масштабирование соединителей может стать важным фактором. Для обработки пикового трафика необходимо иметь достаточное количество соединителей. Настройка балансировки нагрузки не требуется, так как все соединители внутри группы соединителей автоматически распределяют нагрузку.

Соединители не поддерживают отслеживание состояния, поэтому для них не имеет значения количество пользователей или сеансов. Но они зависят от количества запросов и объема полезных данных в этих запросах. Обычный компьютер может обработать несколько тысяч запросов стандартного веб-трафика в секунду. Этот показатель зависит от точных характеристик компьютера. 

Производительность соединителя связана с ЦП и сетью. Производительность ЦП важна при шифровании и расшифровке SSL, а сеть нужна, чтобы быстро подключаться к приложениям и веб-службе в Azure.

Память, напротив, меньше всего важна для соединителей. Веб-служба выполняет большую часть операций обработки и отвечает за весь трафик, не прошедший аутентификацию. Все, что можно сделать в облаке, осуществляется в облаке. 

Балансировка нагрузки выполняется между соединителями заданной группы соединителей. Для определения соединителя, который обслуживает определенный запрос в группе, мы реализуем своего рода циклический перебор. После выбора соединителя мы поддерживаем сходство сеансов между определенным пользователем и приложением в течение всего сеанса. Если по какой-либо причине этот соединитель или компьютер станут недоступны, трафик перейдет к другому соединителю в группе. Такая устойчивость — еще одна причина, по которой мы рекомендуем использовать несколько соединителей.

На производительность также влияет качество сетевого подключения между соединителями, которое определяется следующими факторами. 

* **Веб-служба**. Медленные подключения или подключения с высокой задержкой к службе прокси приложения в Azure влияют производительность соединителя. Чтобы обеспечить максимальную производительность, подключите свою организацию к Azure с помощью ExpressRoute. Для других подключений вашей команде сетевых инженеров нужно отдельно обеспечивать эффективность подключений к Azure. 
* **Внутренние приложения.** В некоторых случаях между соединителем и внутренними приложениями установлены дополнительные прокси-серверы, которые могут замедлять или нарушать подключения. Чтобы устранить неполадки в этом случае, откройте браузер на сервере соединителя и повторите попытку получить доступ к приложению. Если соединители выполняются в Azure, а приложения расположены в локальной среде, качество работы может оказаться ниже, чем ожидают пользователи.
* **Контроллеры домена.** Если соединители выполняют единый вход на основе ограниченного делегирования Kerberos, то сначала они обращаются к контроллерам домена, а затем отправляют запрос к серверной части. Соединители содержат кэш билетов Kerberos, но в среде с высокой нагрузкой скорость реагирования контроллеров домена может снизить производительность. Такая проблема наиболее характерна для ситуации, когда соединители выполняются в Azure, но взаимодействуют с контроллерами домена в локальной среде. 

Дополнительные сведения об оптимизации сети см. в разделе [Аспекты топологии сети при использовании прокси приложения Azure Active Directory](application-proxy-network-topology-considerations.md).

## <a name="domain-joining"></a>Присоединение к домену

Соединители могут выполняться на компьютере, не присоединенном к домену. Но если вам нужен единый вход (SSO) в приложения, использующих встроенную проверку подлинности Windows (IWA), компьютер должен быть присоединен к домену. В этом случае компьютеры соединителя должны быть присоединены к домену, который может выполнить ограниченное делегирование [Kerberos](https://web.mit.edu/kerberos) от имени пользователей для опубликованных приложений.

Соединители можно также присоединять к доменам или лесам с частичным доверием либо к контроллерам домена только для чтения.

## <a name="connector-deployments-on-hardened-environments"></a>Развертывание соединителей в средах с усиленной защитой

Развертывание соединителей обычно не вызывает сложностей и не требует дополнительной настройки. Но для некоторых редких сценариев есть определенные условия.

* Если в организации используются ограничения на исходящий трафик, [откройте необходимые порты](active-directory-application-proxy-enable.md#open-your-ports).
* На FIPS-совместимых компьютерах может потребоваться изменить конфигурацию таким образом, чтобы процессы соединителя могли создать и сохранить сертификат.
* Если в организации используется блокировка среды на основе процессов, создающих сетевые запросы, то для обеих служб соединителей нужно разрешить доступ ко всем требуемым портам и IP-адресам.
* В некоторых случаях исходящие перенаправляющие прокси-серверы могут прервать двустороннюю проверку подлинности на основе сертификата и привести к сбою связи.

## <a name="connector-authentication"></a>Проверка подлинности соединителя

Чтобы предоставить доступ к защищенной службе, соединители должны пройти проверку подлинности в службе, а служба должна пройти проверку подлинности в соединителе. Такая аутентификация выполняется с использованием сертификатов клиента и сервера, когда соединители инициируют подключение. Таким образом имя пользователя и пароль администратора не хранятся на компьютере соединителя.

Используемые сертификаты уникальны для службы прокси приложения. Они создаются во время первоначальной регистрации, а затем соединители автоматически обновляют их каждые несколько месяцев. 

Если соединитель несколько месяцев не подключается к службе, возможно, его сертификаты устарели. В этом случае следует удалить соединитель и установить его заново, чтобы запустить процесс регистрации. Вы можете выполнить следующие команды PowerShell:

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

## <a name="under-the-hood"></a>Как все устроено

Соединители основаны на прокси веб-приложения Windows Server, поэтому для них доступны почти такие же средства управления, включая журналы событий Windows

 ![Управление журналами событий с помощью средства просмотра событий](./media/application-proxy-understand-connectors/event-view-window.png)

и счетчики производительности Windows. 

 ![Добавление счетчиков в соединитель с помощью системного монитора](./media/application-proxy-understand-connectors/performance-monitor.png)

Для соединителей настроены журнал администратора и журнал сеансов. В журналах администратора регистрируются основные события и соответствующие ошибки. В журналах сеансов содержатся все транзакции и подробные сведения об их обработке. 

Чтобы увидеть журналы, откройте средство просмотра событий и включите в нем параметр **Отобразить аналитический и отладочный журналы** в меню **Вид**. Затем включите в журналах сбор событий. Эти журналы не отображаются в прокси-службе веб-приложения в Windows Server 2012 R2, так как соединители созданы на основе более поздней версии.

Состояние службы можно проверить в окне "Служба". Соединитель состоит из двух служб Windows: собственно соединитель и служба обновления. Они должны работать постоянно.

 ![Окно "Службы (локальные)" Azure AD](./media/application-proxy-understand-connectors/aad-connector-services.png)

## <a name="next-steps"></a>Дополнительная информация


* [Публикация приложений в отдельных сетях и расположениях с помощью групп соединителей](active-directory-application-proxy-connectors-azure-portal.md)
* [Работа с имеющимися локальными прокси-серверами](application-proxy-working-with-proxy-servers.md)
* [Устранение неполадок и сообщения об ошибках прокси приложения](active-directory-application-proxy-troubleshoot.md)
* [Автоматическая установка соединителя прокси приложения Azure AD](active-directory-application-proxy-silent-installation.md)

