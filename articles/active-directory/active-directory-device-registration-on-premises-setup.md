---
title: Настройка локального условного доступа в Azure Active Directory | Документация Майкрософт
description: Пошаговое руководство по включению условного доступа к локальным приложениям с помощью служб федерации Active Directory (AD FS) в Windows Server 2012 R2.
services: active-directory
documentationcenter: ''
author: MarkusVi
manager: mtillman
editor: ''
ms.assetid: 6ae9df8b-31fe-4d72-9181-cf50cfebbf05
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/14/2017
ms.author: markvi
ms.reviewer: jairoc
ms.custom: seohack1
ms.openlocfilehash: 0ce4497a8bebf9078363509c1f962728ab4189f8
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
ms.locfileid: "33764212"
---
# <a name="setting-up-on-premises-conditional-access-by-using-azure-active-directory-device-registration"></a>Настройка локального условного доступа с помощью регистрации устройств в Azure Active Directory
Когда требуется, чтобы пользователи присоединяли свои личные устройства к рабочей области в службе регистрации устройств Azure Active Directory (Azure AD), эти устройства можно помечать как известные организации. Ниже приведено пошаговое руководство по включению условного доступа к локальным приложениям с помощью служб федерации Active Directory (AD FS) в Windows Server 2012 R2.

> [!NOTE]
> При использовании устройств, зарегистрированных в политиках условного доступа службы регистрации устройств Azure Active Directory, требуется лицензия Office 365 или Azure AD Premium. К ним относятся политики, применяемые службами AD FS к локальным ресурсам.
> 
> Чтоб узнать больше о сценариях условного доступа к локальным ресурсам, ознакомьтесь с [присоединением к рабочей области с любого устройства для единого входа и прозрачной двухфакторной проверкой подлинности между приложениями организации](https://technet.microsoft.com/library/dn280945.aspx).

Эти возможности доступны клиентам, купившим лицензию Azure Active Directory Premium.

## <a name="supported-devices"></a>Поддерживаемые устройства
* Присоединенные к домену устройства Windows 7.
* Личные и присоединенные к домену устройства Windows 8.1.
* Устройства iOS 6 или более поздней версии для браузера Safari.
* Устройства Android 4.0 или более поздней версии, Samsung GS3 или телефоны более поздней версии, Samsung Galaxy Note 2 или планшеты более поздней версии.

## <a name="scenario-prerequisites"></a>Предварительные условия для сценария
* Подписка на Office 365 или Azure Active Directory Premium
* Клиент Azure Active Directory.
* Windows Server Active Directory (Windows Server 2008 или более поздней версии).
* Обновленная схема в Windows Server 2012 R2.
* Лицензия на Azure Active Directory Premium.
* Службы федерации Windows Server 2012 R2, настроенные для единого входа в Azure AD.
* Прокси-служба веб-приложения Windows Server 2012 R2. 
* Microsoft Azure Active Directory Connect [(Скачать Azure AD Connect)](http://www.microsoft.com/en-us/download/details.aspx?id=47594).
* Проверенный домен.

## <a name="known-issues-in-this-release"></a>Известные проблемы в этом выпуске
* Для политик условного доступа на основе устройств требуется обратная запись объектов устройств в Active Directory из Azure Active Directory. Обратная запись объектов устройств в Active Directory может занять до трех часов.
* Устройства iOS7 всегда помогут пользователю выбрать сертификат во время аутентификации сертификата клиента.
* Некоторые версии iOS 8, предшествующие iOS 8.3, не работают.

## <a name="scenario-assumptions"></a>Принятые в сценарии допущения
Данный сценарий предполагает, что у вас есть гибридная среда, состоящая из клиента Azure AD и локальной службы Active Directory. Эти клиенты должны быть подключены с использованием Azure AD Connect, а также проверенного домена и AD FS для единого входа. Используйте следующий контрольный список, чтобы настроить среду в соответствии с требованиями.

## <a name="checklist-prerequisites-for-conditional-access-scenario"></a>Контрольный список: предварительные условия для сценария условного доступа
Подключите клиент Azure AD к экземпляру локальной службы Active Directory.

## <a name="configure-azure-active-directory-device-registration-service"></a>Настройка службы регистрации устройств Azure Active Directory
Используйте это руководство для развертывания и настройки службы регистрации устройств Azure Active Directory для своей организации.

В этом руководстве предполагается, что вы уже настроили Windows Server Active Directory и получили подписку Microsoft Azure Active Directory. Ознакомьтесь с предварительными условиями, описанными выше.

Чтобы развернуть службу регистрации устройств Azure Active Directory со своим именем клиента Azure Active Directory, по порядку выполните задачи из приведенного ниже контрольного списка. Если ссылка приведет вас к концептуальной статье, вернитесь к этому контрольному списку после ее просмотра, чтобы вы могли продолжить выполнять оставшиеся в нем задачи. В некоторые задачи входит проверка сценария, которая поможет подтвердить успешность выполнения шага.

## <a name="part-1-enable-azure-active-directory-device-registration"></a>Часть 1. Включение регистрации устройств в Azure Active Directory
Чтобы включить и настроить службу регистрации устройств Azure Active Directory, следуйте приведенным ниже действиям в контрольном списке.

| Задача | Справочные материалы | 
| --- | --- |
| Чтобы позволить устройствам присоединяться к рабочей области, включите регистрацию устройств в своем клиенте Azure Active Directory. По умолчанию Многофакторная идентификация Azure для службы не включена. Тем не менее мы рекомендуем использовать многофакторную проверку подлинности при регистрации устройства. Перед включением Многофакторной идентификации в службе регистрации Active Directory убедитесь в том, что для AD FS настроен поставщик Многофакторной идентификации. |[Включение регистрации устройств в Azure Active Directory](active-directory-device-registration-get-started.md)| 
|Устройства будут обнаруживать вашу службу регистрации устройств в Azure Active Directory, просматривая хорошо известные записи DNS. Настройте DNS своей организации таким образом, чтобы устройства могли обнаруживать вашу службу регистрации устройств Azure Active Directory. |[Настройка обнаружения службы регистрации устройств Azure Active Directory](active-directory-device-registration-get-started.md)| 


## <a name="part-2-deploy-and-configure-windows-server-2012-r2-active-directory-federation-services-and-set-up-a-federation-relationship-with-azure-ad"></a>Часть 2. Развертывание и настройка служб федерации Windows Server 2012 R2 Active Directory и настройка отношений федерации с Azure AD

| Задача | Справочные материалы |
| --- | --- |
| Разверните доменные службы Active Directory с помощью расширений схемы Windows Server 2012 R2. Обновлять контроллеры домена до Windows Server 2012 R2 не требуется. Единственное требование — это обновление схемы. |[Обновление схемы доменных служб Active Directory](#upgrade-your-active-directory-domain-services-schema) |
| Устройства будут обнаруживать вашу службу регистрации устройств в Azure Active Directory, просматривая хорошо известные записи DNS. Настройте DNS своей организации таким образом, чтобы устройства могли обнаруживать вашу службу регистрации устройств Azure Active Directory. |[Подготовка Active Directory к поддержке устройств](#prepare-your-active-directory-to-support-devices) |

## <a name="part-3-enable-device-writeback-in-azure-ad"></a>Часть 3. Включение обратной записи устройств в Azure AD
| Задача | Справочные материалы |
| --- | --- |
| Выполните часть 2 включения обратной записи устройств в службе Azure AD Connect. Выполнив это, вернитесь к данному руководству. |[Включение обратной записи устройств в службе Azure AD Connect](./connect/active-directory-aadconnect-feature-device-writeback.md) |

## <a name="optional-part-4-enable-multi-factor-authentication"></a>[Необязательно.] Часть 4. Включение Многофакторной идентификации
Мы настоятельно рекомендуем настроить один из нескольких вариантов Многофакторной идентификации. Если вы хотите требовать прохождение многофакторной проверки подлинности, ознакомьтесь с разделом [Выберите для себя решение "Многофакторная идентификация Azure](authentication/concept-mfa-whichversion.md). Она содержит описание каждого решения, а также ссылки, которые помогут вам настроить выбранное решение.

## <a name="part-5-verification"></a>Часть 5. Проверка
Развертывание уже выполнено, и можно опробовать некоторые сценарии. Воспользуйтесь приведенными ниже ссылками, чтобы поэкспериментировать со службой и ознакомиться с ее возможностями.

| Задача | Справочные материалы |
| --- | --- |
| Присоединение нескольких устройств к рабочей области путем их регистрации в службе регистрации устройств Active Directory Azure. Присоединять можно устройства iOS, Windows и Android. |[Присоединение устройств к рабочей области с помощью службы регистрации устройств Active Directory Azure](#join-devices-to-your-workplace-using-azure-active-directory-device-registration) |
| Просмотр, а также включение и отключение зарегистрированных устройств с помощью портала администрирования. В этой задаче вы просмотрите несколько зарегистрированных устройств на портале администрирования. |[Обзор службы регистрации устройств Azure Active Directory](active-directory-device-registration-get-started.md) |
| Убедитесь, что объекты-устройства подвергаются обратной записи из Azure Active Directory в Windows Server Active Directory. |[Проверка обратной записи зарегистрированных устройств в Active Directory](#verify-registered-devices-are-written-back-to-active-directory) |
| Теперь, когда у пользователей появилась возможность регистрировать устройства, можно создать политики доступа к приложениям в AD FS, позволяющие использовать только зарегистрированные устройства. В этой задаче вы создадите правило доступа к приложениям и пользовательское сообщение об отказе в доступе. |[Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе](#create-an-application-access-policy-and-custom-access-denied-message) |

## <a name="integrate-azure-active-directory-with-on-premises-active-directory"></a>Интеграция Azure Active Directory с локальной службой Active Directory

**См. следующие документы.**

- Статья [Интеграция локальных каталогов с Azure Active Directory](./connect/active-directory-aadconnect.md) содержит дополнительные понятийные сведения.

- Статья [Выборочная установка Azure AD Connect](./connect/active-directory-aadconnect-get-started-custom.md) содержит инструкции по установке.


## <a name="upgrade-your-active-directory-domain-services-schema"></a>Обновление схемы доменных служб Active Directory
> [!NOTE]
> После обновления схемы Active Directory процесс невозможно будет обратить. Рекомендуется сначала выполнить обновление в тестовой среде.
> 

1. Войдите на свой контроллер домена, используя учетную запись, которая имеет права и администратора предприятия, и администратора схемы.
2. Скопируйте каталог **[носитель]\support\adprep** с подкаталогами на один из контроллеров домена Active Directory (где **[носитель]** — это путь к установочному носителю Windows Server 2012 R2).
4. Из командной строки перейдите в каталог **adprep** и выполните команду **adprep.exe /forestprep**. Следуйте указаниям на экране, чтобы завершить обновление схемы.

## <a name="prepare-your-active-directory-to-support-devices"></a>Подготовка Active Directory к поддержке устройств
> [!NOTE]
> Это — одноразовая операция, которую следует провести, чтобы подготовить лес Active Directory к поддержке устройств. Чтобы выполнить эту процедуру, вы должны войти в систему с правами администратора предприятия и ваш лес Active Directory должен иметь схему Windows Server 2012 R2.
> 


### <a name="prepare-your-active-directory-forest"></a>Подготовка леса Active Directory
1. На своем сервере федерации откройте командное окно Windows PowerShell и введите следующую команду: **Initialize-ADDeviceRegistration**. 
2. После появления запроса на **ServiceAccountName**(имя учетной записи службы) введите имя учетной записи службы, которую вы выбрали в качестве учетной записи службы для AD FS. Если это групповая управляемая учетная запись службы (gMSA), то введите учетную запись в формате **домен\имя_учетной_записи$**. Для доменной учетной записи используйте формат **домен\имя_учетной_записи**.

### <a name="enable-device-authentication-in-ad-fs"></a>Включение аутентификации устройств в AD FS
1. На своем сервере федерации откройте консоль управления AD FS и последовательно выберите **AD FS** > **Политики проверки подлинности**.
2. В области **Действия** выберите **Изменить глобальную основную проверку подлинности**.
3. Установите флажок **Включить аутентификацию устройства** и нажмите кнопку **ОК**.
4. По умолчанию AD FS периодически удаляет неиспользуемые устройства из Active Directory. Отключите эту задачу во время использования службы регистрации устройств Azure Active Directory, чтобы устройствами можно было управлять в Azure.

### <a name="disable-unused-device-cleanup"></a>Отключение удаления неиспользуемых устройств
На своем сервере федерации откройте командное окно Windows PowerShell и введите следующую команду: **Set-AdfsDeviceRegistration -MaximumInactiveDays 0**.

### <a name="prepare-azure-ad-connect-for-device-writeback"></a>Подготовка Azure AD Connect к обратной записи устройства
Завершите часть 1 — подготовьте Azure AD Connect.

## <a name="join-devices-to-your-workplace-by-using-azure-active-directory-device-registration-service"></a>Присоединение устройств к рабочей области с помощью службы регистрации устройств Active Directory Azure

### <a name="join-an-ios-device-by-using-azure-active-directory-device-registration"></a>Присоединение устройства iOS с помощью службы регистрации устройств Active Directory Azure
Для устройств iOS служба регистрации устройств Azure Active Directory использует беспроводную регистрацию. Этот процесс начинается, когда пользователь подключается по URL-адресу профиля регистрации с помощью Safari. Используется следующий формат URL-адреса:

    https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/"yourdomainname"

В этом случае `yourdomainname` — доменное имя, которое вы настроили в Azure Active Directory. Например, если ваше доменное имя — contoso.com, URL-адрес будет следующим:

    https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/contoso.com

Есть много различных способов сообщить этот URL-адрес своим пользователям. Например, один из рекомендуемых способов — опубликовать этот URL-адрес в пользовательском сообщении об отказе в доступе в AD FS. Об этом говорится в следующем разделе: [Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе](#create-an-application-access-policy-and-custom-access-denied-message).

### <a name="join-a-windows-81-device-by-using-azure-active-directory-device-registration"></a>Присоединение устройства Windows 8.1 с помощью службы регистрации устройств Active Directory Azure
1. На устройстве Windows 8.1 последовательно выберите **Параметры компьютера** > **Сеть** > **Рабочая область**.
2. Введите свое имя пользователя в формате имени участника-пользователя. Пример: **dan@contoso.com**.
3. Выберите **Присоединиться**.
4. При появлении запроса введите свои учетные данные и выполните вход. Теперь устройство присоединено.

### <a name="join-a-windows-7-device-by-using-azure-active-directory-device-registration"></a>Присоединение устройства Windows 7 с помощью службы регистрации устройств Active Directory Azure
Чтобы зарегистрировать устройства Windows 7, присоединенные к домену, разверните [программный пакет регистрации устройств](https://www.microsoft.com/download/details.aspx?id=53554).

Инструкции о том, как использовать этот пакет, приведены в разделе [Пакеты установщика Windows для компьютеров, не работающих на базе Windows 10](device-management-hybrid-azuread-joined-devices-setup.md#windows-installer-packages-for-non-windows-10-computers).

## <a name="verify-that-registered-devices-are-written-back-to-active-directory"></a>Проверка обратной записи зарегистрированных устройств в Active Directory
Просмотреть и убедиться, что объекты устройств были записаны в Active Directory посредством обратной записи, можно с помощью LDP.exe и ADSI Edit. Оба приложения доступны в инструментах администратора Active Directory.

По умолчанию объекты устройств, которые были записаны из Azure Active Directory посредством обратной записи, будут размещаться том же домене, что и ваша ферма AD FS.

    CN=RegisteredDevices,defaultNamingContext

## <a name="create-an-application-access-policy-and-custom-access-denied-message"></a>Создание политики доступа к приложениям и пользовательского сообщения об отказе в доступе
Рассмотрим следующий сценарий. Вы создаете в AD FS отношение доверия с проверяющей стороной для приложения и настраиваете правило авторизации выпуска, которое будет разрешать доступ только для зарегистрированных устройств. Теперь только зарегистрированные устройства могут иметь доступ к приложению. 

Чтобы облегчить пользователям доступ к приложению, настройте пользовательское сообщения об отказе в доступе, которое содержит указания по присоединению устройства. Теперь у ваших пользователей есть удобный способ зарегистрировать свои устройства, чтобы получить доступ к приложению.

Следующие действия демонстрируют, как реализовать такой сценарий.

> [!NOTE]
> В этом разделе предполагается, что вы уже настроили отношение доверия с проверяющей стороной для приложения в AD FS.
> 

1. Откройте инструмент MMC в AD FS и выберите **AD FS** > **Отношения доверия** > **Отношения доверия с проверяющей стороной**.
2. Найдите приложение, к которому будет применяться это новое правило доступа. Щелкните правой кнопкой мыши это приложение и выберите **Изменить правила утверждения**.
3. Выберите вкладку **Правила авторизации выдачи**, а затем щелкните **Добавить правило**.
4. Из раскрывающегося списка шаблонов **Правило для утверждений** выберите **Разрешить или запретить доступ пользователям на основании входящего утверждения**. Затем нажмите кнопку **Далее**.
5. В поле **Имя правила для утверждений** введите **Разрешение доступа с зарегистрированных устройств**.
6. Из раскрывающегося списка **Тип входящего утверждения** выберите **Зарегистрированный пользователь**.
7. В поле **Тип входящего утверждения** введите **true**.
8. Установите переключатель **Разрешить доступ пользователям с этим входящим утверждением** .
9. Нажмите кнопку **Готово**, а затем **Применить**.
10. Удалите все правила, которые разрешают больше, чем правило, которое вы создали. Например, удалите правило по умолчанию **Разрешить доступ всем пользователям**.

Ваше приложение сейчас настроено разрешать доступ, только если пользователь заходит с устройства, которое зарегистрировано и присоединено к рабочей области. Более сложные политики доступа описаны в разделе об [управлении рисками с помощью дополнительной многофакторной проверке подлинности для критически важных приложений](https://technet.microsoft.com/library/dn280949.aspx).

Далее вы настроите пользовательское сообщение об ошибке для своего приложения. Сообщение об ошибке дает пользователям понять, что они должны присоединить свое устройство к рабочей области, прежде чем получат доступ к приложению. Вы можете создать пользовательское сообщение об отказе в доступе с помощью пользовательского кода HTML и PowerShell.

На своем сервере федерации откройте командное окно PowerShell и введите следующую команду. Замените части команды элементами, относящимися к вашей системе.

    Set-AdfsRelyingPartyWebContent -Name "relying party trust name" -ErrorPageAuthorizationErrorMessage
Для доступа к этому приложению необходимо зарегистрировать устройство.

**Если вы используете устройство iOS, выберите эту ссылку для присоединения устройства**:

    a href='https://enterpriseregistration.windows.net/enrollmentserver/otaprofile/yourdomain.com

Присоединить это устройство iOS к рабочей области.

Если вы используете устройство Windows 8.1, то для присоединения устройства выберите **Параметры компьютера**> **Сеть** > **Рабочая область**.

В предыдущих командах **relying party trust name**— это имя объекта отношений доверия с проверяющей стороной вашего приложения в AD FS.
А **yourdomain.com** — это доменное имя, которое вы настроили в Azure Active Directory (например, contoso.com).
Удостоверьтесь, что удалили все разрывы строк (если они были) из содержимого HTML, которое передаете в командлет **Set-AdfsRelyingPartyWebContent**.

Теперь после обращения к приложению с устройства, не зарегистрированного в службе регистрации устройств Azure Active Directory, будет отображаться сообщение об ошибке.

