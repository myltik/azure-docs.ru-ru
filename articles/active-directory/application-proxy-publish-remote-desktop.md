---
title: Публикация удаленного рабочего стола с помощью прокси приложения Azure AD | Документация Майкрософт
description: Основные сведения о соединителях прокси приложения Azure AD.
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 11/03/2017
ms.author: barbkess
ms.custom: it-pro
ms.reviewer: harshja
ms.openlocfilehash: c24781ad432a4682ebb0afcb95390bdcf8962d90
ms.sourcegitcommit: c52123364e2ba086722bc860f2972642115316ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2018
---
# <a name="publish-remote-desktop-with-azure-ad-application-proxy"></a>Публикация удаленного рабочего стола с помощью прокси приложения Azure AD

Служба удаленных рабочих столов и прокси приложения Azure AD работают вместе для улучшения продуктивности рабочих ролей, находящихся за пределами корпоративной сети. 

Предполагаемая аудитория этой статьи:
- Текущие клиенты, использующие прокси приложения, которые хотят предложить больше приложений пользователям за счет публикации локальных приложений с помощью служб удаленных рабочих столов.
- Текущие клиенты, использующие службы удаленных рабочих столов, которые хотят сократить поверхность атаки своего развертывания с помощью прокси приложения Azure AD. Этот сценарий обеспечивает ограниченный набор из двухфакторной проверки подлинности и элементов управления условным доступом к RDS.

## <a name="how-application-proxy-fits-in-the-standard-rds-deployment"></a>Как прокси приложения встраивается в стандартное развертывание RDS

Стандартное развертывание RDS включает в себя различные службы ролей удаленного рабочего стола, выполняемые в Windows Server. Если взглянуть на [архитектуру служб удаленных рабочих столов](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/desktop-hosting-logical-architecture), можно выделить несколько вариантов развертывания. В отличие от других вариантов развертывания RDS, [развертывание RDS с прокси приложения Azure AD](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/desktop-hosting-logical-architecture) (как показано на следующей схеме) имеет постоянное исходящее подключение с сервера, на котором запущена служба соединителя. Другие развертывания оставляют открытыми входящие подключения через подсистему балансировки нагрузки.

![Прокси приложения располагается между виртуальной машиной RDS и общедоступным Интернетом](./media/application-proxy-publish-remote-desktop/rds-with-app-proxy.png)

В развертывании RDS роль веб-сайта удаленных рабочих столов и роль шлюза удаленных рабочих столов выполняют компьютеры с подключением к Интернету. Эти конечные точки предоставляются по следующим причинам:
- Веб-сайт удаленных рабочих столов предоставляет пользователю общедоступную конечную точку для входа и просмотра различных локальных приложений и компьютеров, к которым у него есть доступ. После выбора ресурса создается подключение к удаленному рабочему столу с помощью собственного приложения в операционной системе.
- Когда пользователь открывает подключение к удаленному рабочему столу, на сцену выходит шлюз удаленных рабочих столов. Он обрабатывает зашифрованный трафик RDP, проходящий через Интернет, и транслирует его на локальный сервер, к которому подключается пользователь. В этом сценарии трафик, который получает шлюз удаленных рабочих столов, поступает от прокси приложения Azure AD.

>[!TIP]
>Если вы еще не разворачивали RDS или хотите получить дополнительные сведения, прежде чем начать, узнайте, как [незаметно для пользователя развернуть RDS с помощью Azure Resource Manager и Azure Marketplace](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/rds-in-azure).

## <a name="requirements"></a>Требования

- Конечные точки веб-сайта удаленных рабочих столов и шлюза удаленных рабочих столов должны располагаться на одном компьютере и в общем корне. Веб-сайт удаленных рабочих столов и шлюз удаленных рабочих столов публикуется как отдельные приложения с помощью прокси приложения, поэтому возможен единый вход в эти два приложения.

- Необходимо, чтобы [были развернуты службы удаленных рабочих столов (RDS)](https://technet.microsoft.com/windows-server-docs/compute/remote-desktop-services/rds-in-azure) и [включен прокси приложения](manage-apps/application-proxy-enable.md).

- В этом сценарии предполагается, что пользователи подключаются через Internet Explorer на компьютерах под управлением Windows 7 или Windows 10, которые подключаются через страницу веб-сайта удаленных рабочих столов. Если требуется поддержка других операционных систем, то см. раздел [Поддержка других конфигураций клиента](#support-for-other-client-configurations).

- В Internet Explorer включите надстройку RDS ActiveX.

## <a name="deploy-the-joint-rds-and-application-proxy-scenario"></a>Сценарий совместного развертывания RDS и прокси приложения

Настроив RDS и прокси приложения Azure AD для своей среды, выполните приведенные инструкции, чтобы объединить эти два решения. В них описывается, как опубликовать две конечные точки RDS с подключением к Интернету (для веб-сайта удаленных рабочих столов и шлюза удаленных рабочих столов) в качестве приложений, а затем направить трафик RDS через прокси приложения.

### <a name="publish-the-rd-host-endpoint"></a>Публикация конечной точки узла удаленных рабочих столов

1. [Опубликуйте новое приложение прокси приложения](manage-apps/application-proxy-publish-azure-portal.md) с приведенными ниже значениями.
   - Внутренний URL-адрес: https://\<rdhost\>.com/, где \<rdhost\> — общий корень, совместно используемый веб-сайтом удаленных рабочих столов и шлюзом удаленных рабочих столов.
   - Внешний URL-адрес: это поле заполняется автоматически на основе имени приложения, но его можно изменить. Ваши пользователи будут переходить по этому URL-адресу при обращении к RDS.
   - Метод предварительной аутентификации: выберите Azure Active Directory.
   - Преобразование URL-адреса в заголовок: выберите значение "Нет".
2. Назначьте пользователей опубликованному приложению удаленных рабочих столов. Убедитесь также, что все они имеют доступ к RDS.
3. Для параметра единого входа для приложения оставьте значение **Единый вход Azure AD отключен**. Пользователи будут один раз проходить аутентификацию в Azure AD и еще один раз — на веб-сайте удаленных рабочих столов, но смогут использовать единый вход на шлюз удаленных рабочих столов.
4. Выберите **Azure Active Directory** > **Регистрация приложений** > *Приложения* > **Параметры**.
5. Выберите **Свойства** и обновите значение поля **URL-адрес домашней страницы**, указав конечную точку веб-сайта удаленных рабочих столов (например, https://\<rdhost\>.com/RDWeb).

### <a name="direct-rds-traffic-to-application-proxy"></a>Направление трафика RDS в прокси приложения

Подключитесь к развертыванию RDS как администратор и измените имя сервера шлюза удаленных рабочих столов для развертывания. Эта конфигурация обеспечивает прохождение подключений через прокси приложения Azure AD.

1. Подключитесь серверу RDS, выполняющему роль посредника подключений к удаленному рабочему столу.
2. Запустите **диспетчер сервера**.
3. В левой области выберите **Службы удаленных рабочих столов**.
4. Щелкните **Обзор**.
5. В разделе "Обзор развертывания" щелкните раскрывающееся меню и выберите **Изменить свойства развертывания**.
6. На вкладке "Шлюз удаленных рабочих столов" в поле **Имя сервера** укажите внешний URL-адрес, заданный для конечной точки узла удаленных рабочих столов в прокси приложения.
7. В поле **Метод входа** укажите **Проверка подлинности с помощью пароля**.

  ![Экран свойств развертывания RDS](./media/application-proxy-publish-remote-desktop/rds-deployment-properties.png)

8. Выполните эту команду для каждой коллекции. Замените параметры *\<yourcollectionname\>* и *\<proxyfrontendurl\>* собственными значениями. Эта команда включает единый вход между веб-сайтом удаленных рабочих столов и шлюзом удаленных рабочих столов и оптимизирует производительность.

   ```
   Set-RDSessionCollectionConfiguration -CollectionName "<yourcollectionname>" -CustomRdpProperty "pre-authentication server address:s:<proxyfrontendurl>`nrequire pre-authentication:i:1"
   ```

   **Например:**
   ```
   Set-RDSessionCollectionConfiguration -CollectionName "QuickSessionCollection" -CustomRdpProperty "pre-authentication server address:s:https://remotedesktoptest-aadapdemo.msappproxy.net/`nrequire pre-authentication:i:1"
   ```

9. Чтобы проверить изменение настраиваемых свойств протокола удаленного рабочего стола, а также просмотреть оглавление RDP-файла, которое будет скачано с веб-сайта удаленных рабочих столов для этой коллекции, выполните следующую команду:
    ```
    (get-wmiobject -Namespace root\cimv2\terminalservices -Class Win32_RDCentralPublishedRemoteDesktop).RDPFileContents
    ```

Теперь, после настройки удаленного рабочего стола, прокси приложения Azure AD взял на себя роль компонента для Интернета RDS. Можно удалить другие общедоступные конечные точки для Интернета на компьютерах веб-сайта удаленных рабочих столов и шлюза удаленных рабочих столов.

## <a name="test-the-scenario"></a>Тестирование сценария

Протестируйте сценарий в Internet Explorer на компьютере Windows 7 или Windows 10.

1. Перейдите по настроенному внешнему URL-адресу или найдите свое приложение на [панели MyApps](https://myapps.microsoft.com).
2. Вам будет предложено пройти аутентификацию в Azure Active Directory. Используйте учетную запись, назначенную приложению.
3. Вам будет предложено пройти аутентификацию на веб-сайте удаленных рабочих столов.
4. После успешной аутентификации в RDS вы сможете выбрать рабочий стол или приложение и начать работу.

## <a name="support-for-other-client-configurations"></a>Поддержка других конфигураций клиента

Конфигурация, описанная в этой статье, предназначена для пользователей Windows 7 или 10, использующих Internet Explorer и надстройку RDS ActiveX. Однако, если требуется, можно использовать и другие операционные системы или браузеры. Разница заключается в используемом методе проверки подлинности.

| Метод проверки подлинности | Поддерживаемая конфигурация клиента |
| --------------------- | ------------------------------ |
| Предварительная аутентификация    | Windows 7 или 10 с Internet Explorer и надстройкой RDS ActiveX |
| Сквозной режим | Любая другая операционная система, поддерживающая приложение "Удаленный рабочий стол (Майкрософт)" |

Поток предварительной аутентификации предлагает больше преимуществ с точки зрения безопасности, чем сквозной режим. Предварительная аутентификация позволяет использовать такие функции проверки подлинности Azure AD, как единый вход, условный доступ и двухфакторная проверка подлинности для локальных ресурсов. Также гарантируется, что сети достигает только прошедший аутентификацию трафик.

Чтобы использовать аутентификацию в сквозном режиме, необходимо внести только два изменения в действия, описанные в этой статье:
1. В разделе [Публикация конечной точки узла удаленных рабочих столов](#publish-the-rd-host-endpoint) (шаг 1) в качестве метода предварительной аутентификации выберите **Сквозной режим**.
2. В разделе [Направление трафика RDS в прокси приложения](#direct-rds-traffic-to-application-proxy) полностью пропустите шаг 8.

## <a name="next-steps"></a>Дополнительная информация

[Настройка удаленного доступа к SharePoint с помощью прокси приложения Azure AD](application-proxy-enable-remote-access-sharepoint.md)  
[Вопросы безопасности при удаленном доступе к приложениям через прокси приложения Azure AD](application-proxy-security-considerations.md)
