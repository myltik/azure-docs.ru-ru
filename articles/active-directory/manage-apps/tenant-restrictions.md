---
title: Управление доступом к облачным приложениям в Azure путем ограничения клиентов | Документация Майкрософт
description: Как использовать ограничение клиентов для управления доступом пользователей к приложениям на основе их клиента Azure AD.
services: active-directory
documentationcenter: ''
author: barbkess
manager: mtillman
editor: yossib
ms.service: active-directory
ms.component: app-mgmt
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/15/2018
ms.author: barbkess
ms.reviewer: richagi
ms.openlocfilehash: dd86ad6b9a60c8a44dd73b31d908838d9c213fd1
ms.sourcegitcommit: 6f6d073930203ec977f5c283358a19a2f39872af
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/11/2018
ms.locfileid: "35303019"
---
# <a name="use-tenant-restrictions-to-manage-access-to-saas-cloud-applications"></a>Использование ограничения клиентов для управления доступом к облачным приложениям SaaS

Крупные организации, уделяющие безопасности особое внимание, стремятся перейти в облачные службы, такие как Office 365, но им нужны гарантии, что их пользователи смогут получить доступ только к утвержденным ресурсам. В большинстве случаев для управления доступом компании ограничивают доменные имена или IP-адреса. Такой подход не работает в мире, в котором приложения SaaS размещены в общедоступном облаке, выполняющемся на общих доменных именах, таких как outlook.office.com и login.microsoftonline.com. Блокирование этих адресов полностью запретит пользователям интернет-доступ к Outlook, а не просто ограничит его в соответствии с утвержденными удостоверениями и ресурсами.

Решением, которое Azure Active Directory предлагает для этой задачи, является функция, называемая ограничением клиентов. Ограничение клиентов позволяет организациям управлять доступом к облачным приложениям SaaS на основе клиента Azure AD, используемого приложениями для единого входа. Например, можно разрешить доступ к приложениям Office 365 в своей организации, но запретить доступ к экземплярам тех же приложений в других организациях.  

Ограничение клиентов дает организациям возможность указать список клиентов, доступ к которым разрешен пользователям. После этого Azure AD только предоставляет доступ к этим разрешенным клиентам.

В этой статье рассматривается ограничение клиентов для Office 365, но данный компонент должен работать с любым облачным приложением SaaS, использующим современные протоколы аутентификации и Azure AD для единого входа. При использовании приложений SaaS с клиентом Azure AD, отличным от клиента для Office 365, убедитесь, что все необходимые клиенты разрешены. Дополнительные сведения об облачных приложениях SaaS см. на сайте [Active Directory Marketplace](https://azure.microsoft.com/marketplace/active-directory/).

## <a name="how-it-works"></a>Принцип работы

В общих чертах решение состоит из следующих компонентов. 

1. **Azure AD**. Если используется `Restrict-Access-To-Tenants: <permitted tenant list>`, то Azure AD только выдает маркеры безопасности разрешенным клиентам. 

2. **Локальная инфраструктура прокси-сервера**. Это устройство прокси-сервера с возможностью проверки SSL, настроенное для вставки заголовка, содержащего список разрешенных клиентов, в трафик, предназначенный для Azure AD. 

3. **Клиентское программное обеспечение**. Для поддержки ограничения клиентов клиентское программное обеспечение должно запрашивать маркеры непосредственно из Azure AD, чтобы трафик мог быть перехвачен инфраструктурой прокси-сервера. Ограничение клиентов в настоящее время поддерживается браузерными приложениями Office 365 и клиентами Office при использовании современной аутентификации (например, OAuth 2.0). 

4. **Современная аутентификация**. Облачные службы должны применять современные протоколы аутентификации, чтобы использовать ограничение клиентов и блокировать доступ для всех запрещенных клиентов. Облачные службы Office 365 необходимо настроить для использования протоколов современной аутентификации по умолчанию. Последние сведения о поддержке современной аутентификации в Office 365 доступны в статье [Updated Office 365 modern authentication](https://blogs.office.com/2015/11/19/updated-office-365-modern-authentication-public-preview/) (Обновление поддержи современной аутентификации в Office 365).

На следующей схеме показан общий маршрут прохождения трафика. Проверка SSL требуется только для трафика, поступающего в Azure AD, а не в облачные службы Office 365. Это различие очень важно, так как объем трафика для аутентификации в Azure AD обычно гораздо меньше, чем объем трафика к приложениям SaaS, например Exchange Online и SharePoint Online.

![Схема движения трафика при использовании ограничения клиентов](./media/tenant-restrictions/traffic-flow.png)

## <a name="set-up-tenant-restrictions"></a>Настройка ограничения клиентов

Чтобы приступить к работе с ограничением клиентов, нужно выполнить два шага. Первый — убедиться, что ваши клиенты могут подключиться к соответствующим адресам. Второй — настроить инфраструктуру прокси-сервера.

### <a name="urls-and-ip-addresses"></a>URL-адреса и IP-адреса

Чтобы использовать ограничение клиентов, ваши клиенты должны иметь возможность подключаться к следующим URL-адресам Azure AD для прохождения аутентификации: login.microsoftonline.com, login.microsoft.com и login.windows.net. Кроме того, для доступа к Office 365 клиенты также должны подключаться к полным доменным именам или URL-адресам и IP-адресам, определенным в разделе [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2). 

### <a name="proxy-configuration-and-requirements"></a>Конфигурация и требования прокси-сервера

Для применения ограничения клиентов с помощью инфраструктуры прокси-сервера требуется следующая конфигурация. Данное руководство является универсальным, поэтому за определенными инструкциями по реализации следует обратиться к документации поставщика вашего прокси-сервера.

#### <a name="prerequisites"></a>предварительным требованиям

- Прокси-сервер должен поддерживать перехват SSL, вставку заголовка HTTP и фильтрацию назначения с использованием полных доменных имен или URL-адресов. 

- Клиенты должны доверять цепочке сертификатов, представляемой прокси-сервером для взаимодействия по протоколу SSL. Например, если используются сертификаты из внутренней инфраструктуры PKI, то сертификаты, выдаваемые внутренним корневым центром сертификации, должны быть доверенными.

- Эта функция включена в подписках Office 365, но если вы хотите использовать ограничение клиентов для управления доступом к другим приложениям SaaS, то потребуются лицензии Azure AD Premium 1.

#### <a name="configuration"></a>Параметр Configuration

Для каждого входящего запроса к login.microsoftonline.com login.microsoft.com и login.windows.net следует вставлять два заголовка HTTP: *Restrict-Access-To-Tenants* и *Restrict-Access-Context*.

Эти заголовки должен содержать следующие элементы. 
- Для *Restrict-Access-To-Tenants* — значение \<permitted tenant list\>, которое представляет собой разделенный запятыми список клиентов, доступ к которым нужно разрешить пользователям. Для идентификации клиента в этом списке может использоваться любой домен, зарегистрированный в клиенте. Например, чтобы разрешить доступ к клиентам Contoso и Fabrikam, используются пары "имя-значение" следующего вида: `Restrict-Access-To-Tenants: contoso.onmicrosoft.com,fabrikam.onmicrosoft.com` 
- Для *Restrict-Access-Context* — значение отдельного идентификатора каталога, объявляющего, какой клиент устанавливает ограничение клиентов. Например, чтобы объявить Contoso в качестве клиента, устанавливающего политику ограничения клиентов, используются пары "имя-значение" следующего вида: `Restrict-Access-Context: 456ff232-35l2-5h23-b3b3-3236w0826f3d`  

> [!TIP]
> Идентификатор каталога вы можете найти на [портале Azure](https://portal.azure.com). Войдите в качестве администратора, выберите **Azure Active Directory** слева, затем выберите **Свойства**.

Чтобы запретить пользователям вставлять собственный заголовок HTTP с помощью неутвержденных клиентов, прокси-сервер должен заменять заголовок Restrict-Access-To-Tenants, если он уже существует во входящем запросе. 

Клиенты должны принудительно использовать прокси-сервер для всех запросов к login.microsoftonline.com, login.microsoft.com и login.windows.net. Например, если для указания клиентам использовать прокси-сервер применяются PAC-файлы, то пользователи не должны иметь возможность изменить или отключить эти файлы.

## <a name="the-user-experience"></a>Взаимодействие с пользователями

В этом разделе показано взаимодействие с пользователями и администраторами.

### <a name="end-user-experience"></a>Возможности для пользователей

Например, пользователь находится в сети компании Contoso, но пытается получить доступ к экземпляру Fabrikam такого общего приложения SaaS, как Outlook в Интернете. Если Contoso не является разрешенным клиентом для этого экземпляра, то пользователь увидит приведенную ниже страницу.

![Страница "Доступ запрещен" для пользователей запрещенных клиентов](./media/tenant-restrictions/end-user-denied.png)

### <a name="admin-experience"></a>Возможности для администраторов

Хотя настройка ограничения клиентов выполняется в корпоративной инфраструктуре прокси-сервера, администраторы могут просмотреть отчеты по ограничению клиентов непосредственно на портале Azure. Чтобы просмотреть эти отчеты, перейдите на страницу "Azure Active Directory Overview" (Обзор Azure Active Directory) и изучите раздел "Другие возможности".

Администратор клиента, для которого задан контекст Restricted-Access-Context, может использовать этот отчет, чтобы просмотреть все попытки входа, заблокированные из-за политики ограничения клиентов, включая использованное удостоверение и целевой идентификатор каталога.

![Использование портала Azure для просмотра заблокированных попыток входа](./media/tenant-restrictions/portal-report.png)

Как и в других отчетах на портале Azure, можно использовать фильтры, чтобы задать определенную область. Можно настроить фильтр по конкретному пользователю, приложению, клиенту или интервалу времени.

## <a name="office-365-support"></a>Поддержка Office 365

Приложения Office 365 должны соответствовать двум условиям для полной поддержки ограничения клиентов.

1. Используемый клиент должен поддерживать современную аутентификацию.
2. Современная аутентификация должна использоваться по умолчанию для облачной службы.

Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://blogs.office.com/2015/11/19/updated-office-365-modern-authentication-public-preview/) (Обновление поддержи современной аутентификации в Office 365), чтобы получить последние сведения о том, какие клиенты Office сейчас поддерживают современную аутентификацию. На этой странице также указаны ссылки на инструкции по включению современной аутентификации для конкретных клиентов Exchange Online и Skype для бизнеса Online. Современная аутентификация уже включена по умолчанию в SharePoint Online.

Ограничение клиентов в настоящее время поддерживается браузерными приложениями Office 365 (портал Office, Yammer, сайты SharePoint, Outlook в Интернете и т. д.). Для толстых клиентов (Outlook, Skype для бизнеса, Word, Excel, PowerPoint и т. д.) ограничение клиентов может применяться только при использовании современной аутентификации.  

Клиенты Outlook и Skype для бизнеса, которые поддерживают современную аутентификацию, по-прежнему могут использовать устаревшие протоколы для клиентов, не поддерживающих современную аутентификацию, эффективно обходя политику ограничения клиентов. Приложения, использующие устаревшие протоколы, могут быть заблокированы из-за ограничения клиентов, если при аутентификации приложения подключаются к URL-адресам login.microsoftonline.com, login.microsoft.com или login.windows.net.

Для Outlook в Windows клиенты могут добавить ограничения, запрещающие пользователям добавлять неутвержденые учетные записи почты в свои профили. Вы можете ознакомиться с примером настройки групповой политики, который [запрещает добавление нестандартных учетных записей Exchange](http://gpsearch.azurewebsites.net/default.aspx?ref=1). Для Outlook на платформах, отличных от Windows, и Skype для бизнеса на всех платформах полная поддержка ограничений клиентов на данный момент недоступна.

## <a name="testing"></a>Тестирование

Если вы хотите опробовать политику ограничения клиентов перед ее внедрением во всей организации, существует два варианта: подход на основе узлов с использованием такого инструмента, как Fiddler, или поэтапное развертывание параметров прокси-сервера.

### <a name="fiddler-for-a-host-based-approach"></a>Использование Fiddler для подхода на основе узлов

Fiddler — бесплатный прокси-сервер веб-отладки, который может использоваться для записи и изменения трафика HTTP и HTTPS, включая вставку заголовков HTTP. Чтобы настроить Fiddler для проверки ограничения клиентов, выполните следующие действия.

1.  [Скачайте и установите Fiddler](http://www.telerik.com/fiddler).
2.  Настройте Fiddler для расшифровки трафика HTTPS, как описано в [справочной документации Fiddler](http://docs.telerik.com/fiddler/Configure-Fiddler/Tasks/DecryptHTTPS).
3.  Настройте Fiddler для вставки заголовков *Restrict-Access-To-Tenants* и *Restrict-Access-Context* с помощью настраиваемых правил.
  1. В инструменте Fiddler Web Debugger выберите меню **Rules** (Правила) и щелкните **Customize Rules…** (Настройка правил…), чтобы открыть файл CustomRules.
  2. Добавьте следующие строки в начало функции *OnBeforeRequest*. Замените \<tenant domain\> доменом, зарегистрированным в вашем клиенте (например, contoso.onmicrosoft.com). Замените \<directory ID\> идентификатором GUID Azure AD своего клиента.

  ```
  if (oSession.HostnameIs("login.microsoftonline.com") || oSession.HostnameIs("login.microsoft.com") || oSession.HostnameIs("login.windows.net")){      oSession.oRequest["Restrict-Access-To-Tenants"] = "<tenant domain>";      oSession.oRequest["Restrict-Access-Context"] = "<directory ID>";}
  ```

  Если необходимо разрешить несколько клиентов, используйте запятые для разделения их имен. Например: 

  ```
  oSession.oRequest["Restrict-Access-To-Tenants"] = "contoso.onmicrosoft.com,fabrikam.onmicrosoft.com";
  ```

4. Сохраните и закройте файл CustomRules.

После настройки Fiddler можно начать записывать трафик, перейдя в меню **File** (Файл) и выбрав **Capture Traffic** (Запись трафика).

### <a name="staged-rollout-of-proxy-settings"></a>Поэтапное развертывание параметров прокси-сервера

В зависимости от возможностей инфраструктуры прокси-сервера можно выполнить поэтапное развертывание параметров для пользователей. Ниже приведено несколько общих способов, которые вы можете рассмотреть.

1.  Используйте PAC-файлы, чтобы направить тестовых пользователей в тестовую инфраструктуру прокси-сервера, а обычные пользователи пусть продолжат использовать рабочую инфраструктуру прокси-сервера.
2.  Некоторые прокси-серверы могут поддерживать различные конфигурации с использованием групп.

Обратитесь к документации по вашему прокси-серверу, чтобы получить подробную информацию.

## <a name="next-steps"></a>Дополнительная информация

- Ознакомьтесь со статьей [Updated Office 365 modern authentication](https://blogs.office.com/2015/11/19/updated-office-365-modern-authentication-public-preview/) (Обновление поддержи современной аутентификации в Office 365).

- Прочтите статью [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2).
