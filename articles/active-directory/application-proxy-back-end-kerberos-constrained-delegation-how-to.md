---
title: Устранение неполадок конфигураций ограниченного делегирования Kerberos для прокси приложения | Документация Майкрософт
description: Устранение неполадок конфигураций ограниченного делегирования Kerberos для прокси приложения.
services: active-directory
documentationcenter: ''
author: MarkusVi
manager: mtillman
ms.assetid: ''
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/09/2018
ms.author: markvi
ms.reviewer: harshja
ms.openlocfilehash: 3ba089123198631c443a759ad62cb0ae5ca40ad3
ms.sourcegitcommit: c52123364e2ba086722bc860f2972642115316ef
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2018
ms.locfileid: "34068274"
---
# <a name="troubleshoot-kerberos-constrained-delegation-configurations-for-application-proxy"></a>Устранение неполадок конфигураций ограниченного делегирования Kerberos для прокси приложения

Доступные методы для обеспечения единого входа в опубликованные приложения могут немного различаться в зависимости от приложения. Один из вариантов, которые предлагает по умолчанию прокси приложения Azure, — ограниченное делегирование Kerberos (KCD). Можно настроить соединитель для проверки подлинности на базе ограниченного делегирования Kerberos для серверных приложений от имени пользователей.

Процедура включения этой функции относительно проста, и обычно для нее достаточно общих знаний о разных компонентах и потоке проверки подлинности, на основе которого реализуется единый вход. Доступно довольно мало хороших источников информации по устранению неполадок в случаях, когда единый вход с ограниченным делегированием Kerberos работает неправильно, и они довольно разрозненны.

Эта статья была задумана как сводный справочник, который поможет вам самостоятельно диагностировать и устранить некоторые из наиболее распространенных проблем. Кроме того, в ней приводятся дополнительные рекомендации по диагностике более сложных проблем реализации.

Для работы с этой статьей предполагается следующее:

-   Развертывание прокси приложения Azure выполнено согласно нашей [документации](manage-apps/application-proxy-enable.md), а общий доступ к приложениям без ограниченного делегирования Kerberos работает как ожидалось.

-   Опубликованное целевое приложение основано на службах IIS и реализации Kerberos от корпорации Майкрософт.

-   Узлы сервера и приложения находятся в одном домене Active Directory. Подробные сведения для нескольких доменов и лесов см. в [техническом документе об ограниченном делегировании Kerberos](https://aka.ms/KCDPaper).

-   Целевое приложение публикуется в клиенте Azure с включенной предварительной проверкой подлинности, а пользователи должны входить в Azure с помощью проверки подлинности на основе форм. Расширенные сценарии проверки подлинности клиента не рассматриваются в этой статье, но будут добавлены в будущем.

## <a name="prerequisites"></a>предварительным требованиям

Прокси приложения Azure можно развернуть в инфраструктуре или среде любого из множества типов, и конкретная архитектура наверняка будет зависеть от потребностей соответствующей организации. Одной из наиболее распространенных причин возникновения проблем, связанных с ограниченным делегированием Kerberos, являются не столько сами среды, сколько неправильная настройка или общий контроль.

Поэтому до начала работы по устранению неполадок всегда рекомендуется проверить, выполнены ли все предварительные требования, изложенные в [статье об использовании единого входа с ограниченным делегированием Kerberos вместе с прокси приложения](manage-apps/application-proxy-configure-single-sign-on-with-kcd.md).

Особое внимание нужно уделить разделу о настройке ограниченного делегирования Kerberos в 2012 R2, так как там описан кардинально иной подход к настройке ограниченного делегирования Kerberos для предыдущих версий Windows. При этом не следует забывать о нескольких других аспектах:

-   Рядовой сервер домена довольно часто изменяет диалоговый сеанс, открытый по безопасному каналу с определенным контроллером домена. Смена диалогового сеанса может произойти в любое время, поэтому не следует ограничивать взаимодействие узлов соединителя лишь контроллерами домена определенного локального сайта.

-   Аналогичным образом, междоменные сценарии основываются на ссылках, ведущих к контроллерам домена, которые могут находиться за пределами периметра локальной сети. В данном случае не менее важно обеспечить прохождение трафика к контроллерам, представляющим другие соответствующие домены, иначе произойдет сбой делегирования.

-   По возможности не следует располагать активные устройства IPS/IDS между узлами соединителя и контроллерами домена, так как иногда это нарушает правильную работу и мешает прохождению основного трафика RPC.

Рекомендуется протестировать делегирование в самых простых сценариях. Чем больше переменных вы вводите, тем с большими трудностями можете столкнуться. Например, ограничив тестирование одним соединителем, вы можете сэкономить время и добавить другие соединители уже после устранения проблем.

Некоторые факторы среды также могут быть причиной проблемы. Во время тестирования следует свести архитектуру к абсолютному минимуму, чтобы избежать влияния факторов среды. Например, довольно часто встречаются неправильно настроенные внутренние списки ACL брандмауэра, поэтому по возможности организуйте прохождение трафика напрямую от соединителя к контроллерам домена и серверному приложению. 

Соединители лучше всего располагать как можно ближе к их целям. Использование встроенного брандмауэра при тестировании лишь чрезмерно усложняет процесс и может приводить к затягиванию работы.

Так в чем именно состоит проблема ограниченного делегирования Kerberos? Существует несколько распространенных признаков, указывающих на сбой единого входа с ограниченным делегированием Kerberos, и первые признаки проблемы обычно проявляются в браузере.

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Сбой авторизации из-за отсутствующих разрешений](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

Все это указывает на неработоспособность единого входа, в результате чего пользователь не может получить доступ к приложению.

## <a name="troubleshooting"></a>Устранение неполадок

Диагностика зависит от характера проблемы и наблюдаемых симптомов. Прежде чем продолжить, изучите материалы по следующим ссылкам, так как в них приведены полезные сведения, которые могут быть вам неизвестны:

-   [Устранение неполадок и сообщения об ошибках прокси приложения](active-directory-application-proxy-troubleshoot.md)

-   [Ошибки и симптомы Kerberos](active-directory-application-proxy-troubleshoot.md#kerberos-errors)

-   [Работа с единым входом при несовпадении локальных и облачных удостоверений](manage-apps/application-proxy-configure-single-sign-on-with-kcd.md#working-with-different-on-premises-and-cloud-identities)

Если вы добрались до этого места, наверняка у вас возникла серьезная проблема. Начните с разделения всей процедуры на три части, в рамках которых можно устранять неполадки.

**Предварительная проверка подлинности клиента** — внешний пользователь проходит проверку подлинности в Azure через браузер.

Возможность прохождения предварительной проверки подлинности в Azure является обязательным условием для правильной работы единого входа с ограниченным делегированием Kerberos. Следует протестировать эту возможность и исправить проблемы, если они возникнут. Этап предварительной проверки подлинности не имеет отношения к ограниченному делегированию Kerberos или опубликованному приложению. Любые неполадки легко исправить, просто убедившись, что учетная запись существует в Azure и она не отключена и не заблокирована. Сообщение об ошибке в браузере обычно достаточно информативно, чтобы понять причину. Если вы не уверены, можете обратиться к другим нашим документам по устранению неполадок.

**Служба делегирования** — соединитель прокси Azure, получающий билет службы Kerberos из KDC (центр распространения Kerberos) от имени пользователей.

Внешнее взаимодействие между клиентом и интерфейсной частью Azure должно осуществляться без привлечения ограниченного делегирования Kerberos. Эта функция используется лишь при проверке работоспособности такого взаимодействия. Таким образом, прокси-службе Azure можно предоставить допустимый идентификатор пользователя, используемый для получения билета Kerberos. Без этого ограниченное делегирование Kerberos невозможно и приведет к сбою.

Как упоминалось ранее, сообщения об ошибках в браузере обычно довольно точно описывают характер проблемы. Обязательно запишите идентификатор действия и метку времени из сообщения. Эти сведения помогут вам связать работу системы с событиями в журнале событий прокси Azure.

   ![Ошибка из-за неправильной конфигурации ограниченного делегирования Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

Соответствующие записи в журнале событий имеют номер 13019 или 12027. Журналы событий соединителя доступны в разделе **Журналы приложений и служб** &gt; **Майкрософт** &gt; **AadApplicationProxy** &gt; **Соединитель**&gt;**Администрирование**.

   ![Событие 13019 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Событие 12027 из журнала событий прокси приложения](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   Используйте запись A во внутренней DNS для адреса приложения, а не запись CName.

-   Перепроверьте, что узлу соединителя предоставлены права на делегирование для имени субъекта-службы назначенной учетной записи и выбран параметр **Использовать любой протокол проверки подлинности**. Дополнительные сведения по этой теме см. в [статье о настройке единого входа](manage-apps/application-proxy-configure-single-sign-on-with-kcd.md).

-   Убедитесь, что в AD существует всего один экземпляр имени субъекта-службы, выполнив команду `setspn -x` из командной строки на любом узле члена домена.

-   Проверьте, применяется ли политика домена для ограничения [максимального размера выдаваемых маркеров Kerberos](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), так как она помешает соединителю получить маркер, если он будет признан избыточным.

После этого для более глубокого понимания проблемы можно захватить данные, которыми обмениваются узел соединителя и домен ограниченного делегирования Kerberos, с помощью сетевой трассировки. Дополнительные сведения см. в [подробном документе по устранению неполадок](https://aka.ms/proxytshootpaper).

Если билеты обрабатываются правильно, в журналах должно присутствовать событие, указывающее на сбой проверки подлинности в связи с тем, что приложение возвращает ошибку 401. Обычно это означает, что целевое приложение отклоняет ваш билет, поэтому перейдите к следующему этапу.

**Целевое приложение** — потребитель билета Kerberos, предоставляемого соединителем.

На этом этапе ожидается, что соединитель отправил билет службы Kerberos в серверную часть в виде заголовка внутри первого запроса приложения.

-   Используя определенный на портале внутренний URL-адрес приложения, убедитесь, что приложение доступно прямо из браузера на узле соединителя. После этого можно выполнить вход. Соответствующие сведения см. на странице об устранении неполадок соединителя.

-   Находясь на узле соединителя, убедитесь, что для проверки подлинности между браузером и приложением используется Kerberos. Для этого выполните одно из следующих действий:

1.  Запустите средства разработчика (**F12**) в Internet Explorer или используйте [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) на узле соединителя. Перейдите в приложение по внутреннему URL-адресу и проверьте предложенные заголовки авторизации WWW, возвращенные в ответе приложения, чтобы убедиться в наличии согласования или Kerberos. BLOB-объект Kerberos, который затем возвращается в ответе из браузера в приложение, обычно начинается с **YII**, что указывает на использование Kerberos. С другой стороны, NTLM всегда начинается с **TlRMTVNTUAAB**, что после расшифровки из Base64 читается как NTLMSSP. Если в начале BLOB-объекта стоит **TlRMTVNTUAAB**, значит протокол Kerberos **недоступен**. В противном случае он, вероятнее всего, доступен.
    > [!NOTE]
    > При использовании Fiddler такой метод потребует временно отключить расширенную защиту в конфигурации приложения в службах IIS.

     ![Окно проверки сети в браузере](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    *Рисунок.* Так как в начале стоит не TIRMTVNTUAAB, значит протокол Kerberos доступен. Это пример BLOB-объекта Kerberos, который начинается не с YII.

2.  Временно удалите NTLM из списка поставщиков на сайте IIS и обратитесь к приложению непосредственно из Internet Explorer на узле соединителя. Удалив NTLM из списка поставщиков, вы сможете обратиться к приложению с помощью одного только Kerberos. Если сделать это не удается, вероятно, возникла проблема с конфигурацией приложения и проверка подлинности Kerberos не работает.

Если протокол Kerberos недоступен, проверьте параметры проверки подлинности приложения в службах IIS, где в самом начале должно быть указано согласование, а сразу после него — NTLM (без согласования — Kerberos, согласование — PKU2U). Продолжайте работу, только если Kerberos работает.

   ![Поставщики проверки подлинности Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   Наладив работу Kerberos и NTLM, давайте временно отключим предварительную проверку подлинности для приложения на портале. Проверьте, можно ли обратиться к приложению из Интернета по внешнему URL-адресу. Вы должны получить запрос на проверку подлинности и быть в состоянии пройти ее с помощью той же учетной записи, которая использовалась на предыдущем этапе. Если эти условия не выполняются, значит проблема связана с серверным приложением, а не с ограниченным делегированием Kerberos.

-   Теперь снова включите предварительную проверку подлинности на портале и пройдите проверку подлинности в Azure, попытавшись подключиться к приложению по внешнему URL-адресу. Если произошел сбой единого входа, должно появиться сообщение о запрете доступа в браузере, а также событие 13022 в журнале:

    *Соединителю прокси приложения Microsoft AAD не удается проверить подлинность пользователя, так как внутренний сервер отвечает на попытки проверки подлинности Kerberos ошибкой HTTP 401.*

    ![Ошибка запрета доступа 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   В приложении IIS убедитесь, что пул приложений настроен для использования той же учетной записи, для которой было задано имя субъекта-службы в AD. Для этого перейдите в IIS, как показано на следующем рисунке:

    ![Окно конфигурации приложения IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    Зная удостоверение, выполните приведенную ниже команду из командной строки, чтобы убедиться, что эта учетная запись действительно настроена с использованием соответствующего имени субъекта-службы. Например, `setspn –q http/spn.wacketywack.com`

    ![Командное окно SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   Убедитесь, что имя субъекта-службы, определенное в параметрах приложения на портале, совпадает с именем, настроенным для целевой учетной записи AD, которая используется в пуле приложений этого приложения.

   ![Настройка имени субъекта-службы на портале Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   Перейдите в службы IIS и выберите для приложения параметр **Редактор конфигураций**, а затем перейдите в расположение **system.webServer/security/authentication/windowsAuthentication** и убедитесь, что для **UseAppPoolCredentials** задано значение **True**.

   ![Параметр учетных данные для пулов приложений в конфигурации IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

Когда это значение изменится на **True**, все кэшированные билеты Kerberos необходимо удалить с внутреннего сервера. Для этого выполните следующую команду:

```powershell
Get-WmiObject Win32_LogonSession | Where-Object {$_.AuthenticationPackage -ne 'NTLM'} | ForEach-Object {klist.exe purge -li ([Convert]::ToString($_.LogonId, 16))}
``` 

Дополнительные сведения см. в разделе [Purge the Kerberos client ticket cache for all sessions (Powershell one-liner)](https://gallery.technet.microsoft.com/scriptcenter/Purge-the-Kerberos-client-b56987bf) (Очистка клиентского кэша с билетами Kerberos для всех сеансов (с помощью Powershell)).



Хотя это бывает полезно для повышения производительности операций Kerberos, при включенном режиме ядра расшифровка билета для запрашиваемой службы выполняется с помощью учетной записи компьютера. Это также называется локальной системой, поэтому установка значения true может нарушать работу ограниченного делегирования Kerberos, когда приложение размещается сразу на нескольких серверах фермы.

-   В качестве дополнительной проверки вам также может потребоваться отключить **расширенную** защиту. Случались ситуации, в которых эта функция нарушала работу ограниченного делегирования Kerberos, когда приложение публиковалось в качестве вложенной папки веб-сайта по умолчанию. Она сама настроена только для анонимного доступа, в результате чего целые диалоговые окна выделяются серым, и можно сделать вывод, что дочерние объекты не наследуют никакие активные параметры. Однако мы рекомендуем всегда включать эту функцию, когда это возможно. Поэтому не забудьте сделать это после тестирования.

После этих дополнительных проверок вы можете начинать работу с опубликованным приложением. Теперь можно добавить дополнительные соединители, также настроенные для делегирования. Если же устранить проблему не удалось, предлагаем обратиться к полному техническому [руководству по устранению неполадок в прокси приложения Azure AD](https://aka.ms/proxytshootpaper).

Если и после этого остаются неполадки, с которыми вам не удалось справиться, обратитесь в службу поддержки. Создайте запрос в службу поддержки прямо на портале, и наш инженер свяжется с вами.

## <a name="other-scenarios"></a>Другие сценарии

-   Прокси приложения Azure запрашивает билет Kerberos перед отправкой запроса к приложению. Некоторые приложения сторонних разработчиков, например Tableau Server, не полностью поддерживают этот метод проверки подлинности, ожидая более традиционных согласований. Первый запрос выполняется анонимно, позволяя приложению отправить ответ с поддерживаемыми типами проверки подлинности через 401.

-   Проверка подлинности с двумя прыжками — обычно используется в сценариях с многоуровневым приложением, где проверка подлинности требуется как для серверной, так и для интерфейсной части (например, SQL Reporting Services).

## <a name="next-steps"></a>Дополнительная информация
[Настройка ограниченного делегирования Kerberos в управляемом домене](../active-directory-domain-services/active-directory-ds-enable-kcd.md)
