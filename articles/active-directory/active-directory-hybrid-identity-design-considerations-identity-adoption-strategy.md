---
title: 'Проектирование гибридных удостоверений: стратегия внедрения в Azure | Документация Майкрософт'
description: С условным контролем доступа при проверке подлинности пользователя и перед предоставлением ему доступа к приложению Azure Active Directory проверяет определенные условия, которые вы можете выбрать. Если эти условия выполняются, пользователь проходит проверку подлинности, и ему дается доступ к приложению.
documentationcenter: ''
services: active-directory
author: billmath
manager: mtillman
editor: ''
ms.assetid: b92fa5a9-c04c-4692-b495-ff64d023792c
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 07/18/2017
ms.author: billmath
ms.custom: seohack1
ms.openlocfilehash: 290c41e62080edcd9a2fad1b5045bac4328cc4cd
ms.sourcegitcommit: 59914a06e1f337399e4db3c6f3bc15c573079832
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2018
---
# <a name="define-a-hybrid-identity-adoption-strategy"></a>Определение стратегии внедрения гибридной идентификации
В этой статье вы определяете стратегию внедрения гибридной идентификации для гибридных решений идентификации, которая соответствует бизнес-требованиям, выработанным вами с помощью таких статей:

* [Определение потребностей бизнеса](active-directory-hybrid-identity-design-considerations-business-needs.md)
* [Определение требований к синхронизации каталога](active-directory-hybrid-identity-design-considerations-directory-sync-requirements.md)
* [Определение требований к многофакторной проверке подлинности](active-directory-hybrid-identity-design-considerations-multifactor-auth-requirements.md)

## <a name="define-business-needs-strategy"></a>Определение стратегии потребностей бизнеса
Первой задачей является определение бизнес-потребностей организации.  Сюда входит очень широкий круг вопросов, и вы можете выйти за границы, если будете недостаточно осторожны.  Старайтесь не усложнять процесс в начале, но обязательно помните, что проект должен допускать изменения в будущем и способствовать им.  Независимо от того, будет ваша система простой или сверхсложной, Azure Active Directory дает возможность пользоваться платформой Microsoft Identity, которая поддерживает Office 365, Microsoft Online Services и облачные приложения.

## <a name="define-an-integration-strategy"></a>Определение стратегии интеграции
Корпорация Майкрософт поддерживает три основных сценария интеграции: облачная идентификация, синхронизированная идентификация и федеративная идентификация.  Вам нужно выбрать одну из этих трех стратегий интеграции.  Стратегии могут быть разными. Выбор зависит, например, от требуемого типа взаимодействия с пользователем, от наличия уже существующей инфраструктуры, а также от стоимости реализации стратегий.  

![](./media/hybrid-id-design-considerations/integration-scenarios.png)

На рисунке выше указаны такие сценарии:

* **Облачная идентификация**: удостоверения пользователей существуют только в облаке.  При использовании Azure AD они будут размещаться в вашем каталоге Azure AD.
* **Синхронизированная идентификация**: удостоверения пользователей существуют как локально, так и в облаке.  При использовании Azure AD Connect пользователи создаются на основе существующих учетных записей Azure AD или объединяются с ними.  Хэш пароля пользователя передается из локальной среды в облако в виде хэша пароля.  Синхронизация имеет один недостаток: если отключить пользователя в локальной среде, изменение состояния этой учетной записи в Azure AD может произойти с задержкой до трех часов.  Это связано с наличием интервала синхронизации.
* **Федеративная идентификация**: удостоверения пользователей существуют как локально, так и в облаке.  При использовании Azure AD Connect пользователи создаются на основе существующих учетных записей Azure AD или объединяются с ними.  

> [!NOTE]
> Дополнительные сведения о вариантах синхронизации см. в статье [Интеграция локальных каталогов с Azure Active Directory](connect/active-directory-aadconnect.md).
> 
> 

Следующая таблица помогает определить преимущества и недостатки каждой стратегии.

| Стратегия | Преимущества | Недостатки |
| --- | --- | --- |
| **Облачная идентификация** |Проще управлять в небольшой организации. <br> Не нужно ничего устанавливать локально. Не требуется дополнительное оборудование.<br>Легко отключить пользователя, когда он покидает компанию. |Пользователи должны вводить учетные данные при обращении к рабочей нагрузке в облаке. <br> Пароли для облака и для локальных удостоверений могут совпадать или различаться. |
| **Синхронизированные** |Локальный пароль используется для аутентификации как локальных, так и облачных каталогов. <br>Проще управлять в небольших, средних и крупных организациях. <br>Пользователи могут применять единый вход (SSO) к некоторым ресурсам. <br> Является предпочтительным методом синхронизации, рекомендуемым корпорацией Майкрософт. <br> Упрощает управление. |Некоторые клиенты настороженно относятся к синхронизации своих каталогов с облаком в силу корпоративных политик. |
| **Федеративные** |Пользователи могут применять единый вход (SSO). <br>Когда пользователь прекращает работу в организации, его учетную запись и доступ к ресурсам можно отключить немедленно.<br> Возможны расширенные сценарии, которые не поддерживает стратегия синхронизации. |Для установки и настройки требуется больше шагов. <br> Более высокие требования к обслуживанию. <br> Может потребоваться дополнительное оборудование для инфраструктуры службы маркеров безопасности (STS). <br> Для установки сервера федерации может потребоваться дополнительное оборудование. При использовании AD FS требуется дополнительное программное обеспечение. <br> Для реализации единого входа (SSO) требуется расширенная настройка. <br> Критическая точка отказа: если сервер федерации выйдет из строя, пользователи не смогут выполнять аутентификацию. |

### <a name="client-experience"></a>Взаимодействие с клиентом
Выбранная стратегия влияет на режим взаимодействия с клиентом при выполнении входа.  В следующих таблицах представлена информация о том, какие процессы и действия ожидают пользователей.  Не все поставщики федеративных удостоверений поддерживают единый вход для любых сценариев.

**Приложения, объединенные в домен, и приложения частной сети**:

|  | Синхронизированная идентификация | Федеративная идентификация |
| --- | --- | --- |
| Веб-браузеры |Проверка подлинности с помощью форм |Единый вход, иногда требуется указывать идентификатор организации |
| Outlook |Запрос учетных данных |Запрос учетных данных |
| Skype для бизнеса (Lync) |Запрос учетных данных |Единый вход для Lync, запрос учетных данных для Exchange |
| OneDrive для бизнеса |Запрос учетных данных |Единый вход |
| Подписка Office Pro Plus |Запрос учетных данных |Единый вход |

**Внешние или ненадежные источники**:

|  | Синхронизированная идентификация | Федеративная идентификация |
| --- | --- | --- |
| Веб-браузеры |Проверка подлинности с помощью форм |Проверка подлинности с помощью форм |
| Outlook, Skype для бизнеса (Lync), OneDrive для бизнеса, подписка Office |Запрос учетных данных |Запрос учетных данных |
| Exchange ActiveSync |Запрос учетных данных |Единый вход для Lync, запрос учетных данных для Exchange |
| Мобильные приложения |Запрос учетных данных |Запрос учетных данных |

Если в задаче 1 вы установили, что организация использует сторонних поставщиков удостоверений или намерена их использовать в будущем для создания федерации с Azure AD, не забывайте о следующих возможностях.

* Во-первых, любой поставщик SAML 2.0, который соблюдает условия для профилей SP-Lite, может поддерживать проверку подлинности в Azure AD и связанных приложениях.
* Во-вторых, поддерживается пассивная проверка подлинности, которая упрощает проверку подлинности в службах Outlook Web Access, SPO и т. д.
* Клиенты Exchange Online могут поддерживаться с использованием расширенных клиентских профилей (ECP) SAML 2.0.

Кроме того, следует учитывать, какие возможности будут недоступны:

* Все активные клиенты не могут работать без поддержки WS-Trust/Federation.
  * В их число входят Lync, клиент OneDrive, подписка Office и Office Mobile версий, вышедших раньше версии Office 2016.
* Переход с Office на пассивную проверку подлинности обеспечивает совместимость с поставщиками удостоверений SAML 2.0, но только отдельно для каждого клиента.

> [!NOTE]
> Самый последний список можно найти в статье https://aka.ms/ssoproviders.
> 
> 

## <a name="define-synchronization-strategy"></a>Стратегия управления синхронизацией
В этой задаче вы определите, какую топологию и какие средства будете использовать для синхронизации локальных данных организации с облаком.  Большинство организаций используют Active Directory, поэтому мы предоставим некоторые сведения о том, как использовать Azure AD Connect для решения описанных выше задач.  Для планирования стратегии в средах, которые не используют Active Directory, приводим сведения об использовании FIM 2010 R2 и MIM 2016.  Но следующие версии Azure AD Connect будут поддерживать каталоги LDAP, поэтому, в зависимости от того, когда вы читаете эту статью, эта информация может оказаться полезной для вас.

### <a name="synchronization-tools"></a>Средства синхронизации
За последние годы создано несколько средств синхронизации, которые использовались для различных сценариев.  В настоящее время лучшим инструментом для всех поддерживаемых сценариев является Azure AD Connect.  Параллельно с ним еще эксплуатируются AAD Sync и DirSync. Возможно, они есть и в вашей среде. 

> [!NOTE]
> Последние сведения о поддерживаемых возможностях каждого из этих средств вы найдете в статье [Сравнение инструментов интеграции каталогов](active-directory-hybrid-identity-design-considerations-tools-comparison.md) .  
> 
> 

### <a name="supported-topologies"></a>Поддерживаемые топологии
Когда вы выбираете стратегию синхронизации, нужно сначала определить используемую топологию. Вы можете определить оптимальную топологию на основании выводов, которые были сделаны на шаге 2. Самой распространенной является топология «один лес, один экземпляр Azure AD». В нее входят один лес Active Directory и один экземпляр Azure AD.  Она будет использоваться в большинстве случаев и именно она нужна в процессе установки Azure AD Connect Express, как показано на рисунке ниже.

![](./media/hybrid-id-design-considerations/single-forest.png) Сценарии с одним лесом. Многие крупные, а иногда и небольшие организации используют несколько лесов, как показано на рисунке 5.

> [!NOTE]
> Дополнительные сведения о синхронизации с применением Azure AD Connect в различных топологиях локальной среды и Azure AD вы найдете в статье [Топологии Azure AD Connect](connect/active-directory-aadconnect-topologies.md).
> 
> 

![](./media/hybrid-id-design-considerations/multi-forest.png) 

Сценарий с несколькими лесами

Топологию «несколько лесов, один экземпляр Azure AD» можно рассматривать, если выполняются следующие условия:

* Каждый пользователь имеет только 1 удостоверение для всех лесов. Этот аспект подробнее описан ниже в разделе уникальной идентификации пользователей.
* Пользователь проходит аутентификацию в том лесу, в котором расположено его удостоверение.
* Этот лес предоставляет имя участника-пользователя и привязку к источнику (неизменяемый идентификатор).
* Все леса доступны для Azure AD Connect — то есть служба не должна быть привязана к домену и может размещаться в сети периметра, если это применимо.
* У каждого пользователя есть только один почтовый ящик.
* Лес, в котором размещаются почтовые ящики пользователей, характеризуется наилучшим качеством данных для атрибутов, отображаемых в глобальном списке адресов Exchange (GAL).
* Если у пользователя нет почтового ящика, для передачи этих значений можно использовать любой лес.
* Если у пользователя есть связанный почтовый ящик, то есть и другая учетная запись в другом лесу, которая используется для входа.

> [!NOTE]
> Объекты, которые существуют как локально, так и в облаке, «связаны» по уникальному идентификатору. В контексте синхронизации каталогов такой уникальный идентификатор называется привязкой к источнику (SourceAnchor). В контексте единого входа он имеет имя ImmutableId. [Концепции разработки для Azure AD Connect](connect/active-directory-aadconnect-design-concepts.md#sourceanchor) содержит дополнительные сведения об использовании SourceAnchor.
> 
> 

Если указанные выше условия не соблюдаются, то есть существует более одной активной учетной записи или более одного почтового ящика, Azure AD Connect выберет один из этих параметров и отбросит другой.  Если у пользователя есть связанные почтовые ящики, но нет других учетных записей, Azure AD не будет экспортировать такую учетную запись и этот пользователь не будет членом ни одной группы.  DirSync ранее использовал другой алгоритм. Такие изменения внесены намеренно для лучшего соответствия сценарию с несколькими лесами. На рисунке ниже показан сценарий с несколькими лесами.

![](./media/hybrid-id-design-considerations/multiforest-multipleAzureAD.png) 

**Сценарий «несколько лесов, несколько экземпляров Azure AD»**

Мы рекомендуем, чтобы для одной организации существовал только один каталог в Azure AD. Но система поддерживает соотношение 1:1 между серверами синхронизации Azure AD Connect и каталогами Azure AD.  Для каждого экземпляра Azure AD требуется одна установка службы Azure AD Connect.  Кроме того, служба Azure AD намеренно создана изолированной: пользователи в одном экземпляре Azure AD не будут видеть пользователей из другого экземпляра.

Система поддерживает такой сценарий, когда один локальный экземпляр Active Directory связан с несколькими каталогами Azure AD, как показано на рисунке ниже.

![](./media/hybrid-id-design-considerations/single-forest-flitering.png) 

**Сценарий фильтрации с одним лесом**

Для этого сценария должны выполняться следующие условия:

* На серверах синхронизации Azure AD Connect необходимо настроить правила фильтрации. Каждый сервер должен обрабатывать взаимоисключающие наборы объектов.  Например, каждый сервер может обслуживать определенный домен или подразделение.
* DNS-домен может быть зарегистрирован только в одном каталоге Azure AD. При этом имена участников-пользователей в локальном каталоге AD должны использовать отдельные пространства имен.
* Пользователи в каждом экземпляре Azure AD будут видеть только других пользователей этого же экземпляра.  Они не смогут видеть пользователей в других экземплярах.
* Вы можете включить гибридное развертывание Exchange с локальным каталогом Active Directory только для одного каталога Azure AD.
* Взаимная исключительность применяется также к обратной записи.  В результате эта топология не будет поддерживать некоторые функции обратной записи, так как они предполагают наличие одной локальной конфигурации.  А именно:
  * групповая обратная запись в конфигурации по умолчанию;
  * обратная запись для устройств.

Следующие функции не поддерживаются. Не включайте их в свое решение.

* Нельзя иметь несколько серверов синхронизации Azure AD Connect, подключенных к одному каталогу Azure AD, даже если они настроены на синхронизацию взаимоисключающего набора объектов.
* Синхронизация одного пользователя с несколькими каталогами Azure AD не поддерживается. 
* Также нельзя изменить конфигурацию таким образом, чтобы пользователи одного каталога Azure AD отображались в другом каталоге Azure AD как контакты. 
* Точно так же нельзя изменить настройки службы синхронизации Azure AD Connect для подключения к различным каталогам Azure AD.
* Каталоги Azure AD являются изолированными по своей природе. Нельзя настроить службу синхронизации Azure AD Connect для чтения данных из другого каталога Azure AD, чтобы создать общий и единый глобальный список адресов между каталогами. Также служба синхронизации Azure AD не может экспортировать пользователей в виде контактов в другой локальный каталог AD.

> [!NOTE]
> Если ваша организация запрещает подключение к Интернету компьютеров в сети, используйте список конечных точек (он содержит полные доменные имена и диапазоны адресов IPv4 и IPv6) из этой статьи. Включите их в списки разрешения исходящих соединений и в зону надежных сайтов Internet Explorer на клиентских компьютерах, чтобы эти компьютеры могли использовать Office 365. Дополнительные сведения см. в статье [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/Office-365-URLs-and-IP-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2?ui=en-US&rs=en-US&ad=US).
> 
> 

## <a name="define-multi-factor-authentication-strategy"></a>Определение стратегии многофакторной проверки подлинности
В этой задаче вы определите стратегию использования многофакторной проверки подлинности.  Многофакторная идентификация Azure доступна в двух различных версиях.  Одна из них реализована на основе облака, а вторая — локально с использованием сервера Azure MFA.  На основе оценки, которую вы выполняли выше, можно выбрать правильное решение для вашей стратегии.  Воспользуйтесь следующей таблицей, чтобы определить вариант, который лучше всего соответствует потребностям вашей компании.

Варианты многофакторной структуры:

| Защищаемый ресурс | MFA в облаке | Локальная Многофакторная идентификация (MFA) |
| --- | --- | --- |
| Приложения Майкрософт |Да |Да |
| Приложения SaaS в коллекции приложений |Да |Да |
| Приложения IIS, опубликованные через прокси приложения Azure AD |Да |Да |
| Приложения IIS, опубликованные не через прокси приложения Azure AD |Нет |Да |
| Удаленный доступ, например VPN или RDG |Нет |Да |

Даже если вы уже выбрали нужное решение для вашей стратегии, вам пригодится приведенная выше оценка местонахождения ваших пользователей.  Она может стать основанием для изменения решения.  Чтобы принять это решение, воспользуйтесь приведенной ниже таблицей:

| Местонахождение пользователей | Предпочтительный вариант |
| --- | --- |
| Azure Active Directory |Multi-Factor Authentication в облаке |
| Azure AD и локальная служба AD с использованием федерации в AD FS |Оба |
| Azure AD и локальная служба AD с использованием Azure AD Connect без синхронизации паролей |Оба |
| Azure AD и локальная служба AD с использованием Azure AD Connect с синхронизацией паролей |Оба |
| Локальная служба AD |Сервер Многофакторной идентификации |

> [!NOTE]
> Следует убедиться, что выбранный вариант многофакторной проверки подлинности поддерживает функции, которые вы считаете обязательными для вашей сети.  Подробнее об этом см. в статье [Выбор решения многофакторной безопасности](authentication/concept-mfa-whichversion.md#what-am-i-trying-to-secure).
> 
> 

## <a name="multi-factor-auth-provider"></a>поставщик Multi-Factor Authentication.
Многофакторная проверка подлинности доступна по умолчанию для глобальных администраторов, у которых есть клиент Azure Active Directory. Однако если вы хотите распространить многофакторную проверку подлинности на всех пользователей и (или) вам нужно, чтобы глобальные администраторы могли использовать такие функции, как отчеты, портал управления и настраиваемые приветствия, то необходимо приобрести и настроить поставщик Многофакторной идентификации.

> [!NOTE]
> Следует убедиться, что выбранный вариант многофакторной проверки подлинности поддерживает функции, которые вы считаете обязательными для вашей сети. 
> 
> 

## <a name="next-steps"></a>Дополнительная информация
[Определение требований к защите данных](active-directory-hybrid-identity-design-considerations-dataprotection-requirements.md)

## <a name="see-also"></a>См. также
[Обзор рекомендаций по проектированию](active-directory-hybrid-identity-design-considerations-overview.md)

