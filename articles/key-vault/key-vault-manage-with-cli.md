<properties
	pageTitle="Управление хранилищем ключей с помощью CLI | Microsoft Azure"
	description="Из этого учебника вы узнаете об автоматизации основных задач в хранилище ключей с использованием CLI"
	services="key-vault"
	documentationCenter=""
	authors="BrucePerlerMS"
	manager="mbaldwin"
	tags="azure-resource-manager"/>

<tags
	ms.service="key-vault"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="09/22/2015"
	ms.author="bruceper"/>

# Управление хранилищем ключей с помощью CLI #
Хранилище ключей Azure доступно в большинстве регионов. Дополнительные сведения см. на странице [Цены на хранилище ключей](../../../../pricing/details/key-vault/).

## Введение  
Этот учебник поможет вам начать работу с хранилищем ключей Azure. В нем содержится информация о создании зафиксированного контейнера (хранилища), хранении криптографических ключей и секретов, а также об управлении ими в Azure. Он представляет собой пошаговое руководство по использованию межплатформенного интерфейса командной строки Azure для создания хранилища, содержащего ключ или пароль, который вы сможете использовать с приложением Azure. В нем также показано, как приложение может использовать этот ключ или пароль в дальнейшем.

**Предполагаемое время выполнения:** 20 минут

>[AZURE.NOTE]В этом учебнике нет указаний по написанию приложения Azure, что предусматривает один из шагов, но показано, как авторизовать приложение для использования ключей или секретов в хранилище ключей.
>
>В настоящее время нельзя настроить хранилище ключей Azure на портале Azure. Вместо этого воспользуйтесь данными инструкциями по межплатформенному интерфейсу командной строки Azure. Инструкции по Azure PowerShell см. в разделе [этом учебнике](key-vault-get-started.md).

Общую информацию о хранилище ключей Azure см. в статье [Что такое хранилище ключей Azure?](key-vault-whatis.md)

## Предварительные требования

Для работы с этим учебником требуется:

- подписка на Microsoft Azure. Если у вас нет подписки, вы можете зарегистрироваться для использования [бесплатной пробной версии](../../../pricing/free-trial);
- Интерфейс командной строки версии 0.9.1 или более поздней. Сведения об установке последней версии и связывании ее с подпиской Azure см. в разделе [Установка и настройка межплатформенного интерфейса командной строки Azure](xplat-cli.md).
- приложение, для которого вы будете настраивать использование ключа или пароля, созданного по этому учебнику. Пример приложения доступен в [Центре загрузки Майкрософт](http://www.microsoft.com/download/details.aspx?id=45343). Указания см. в сопутствующем файле Readme.

## Справка по межплатформенному интерфейсу командной строки Azure

В этом учебнике предполагается, что вы знакомы с интерфейсом командной строки (Bash, терминал, командная строка)

Параметр --help или -h может использоваться для просмотра справки по определенным командам. Также для получения справки можно использовать команду azure help [команда] [параметры]. Например, все следующие команды возвращают одинаковые сведения:

    azure account set --help

    azure account set -h

    azure help account set

Если вы сомневаетесь в том, какие параметры необходимы команде, обратитесь к справке, используя ключ --help, -h или команду azure help [команда].

Чтобы узнать, как работать с диспетчером ресурсов Azure в межплатформенном интерфейсе командной строки Azure, также прочитайте следующие руководства:

- [Установка и настройка межплатформенного интерфейса командной строки Azure](xplat-cli.md)
- [Использование межплатформенного интерфейса командной строки Azure совместно с диспетчером ресурсов](xplat-cli-azure-resource-manager.md)


## Подключение к своим подпискам

Чтобы войти с использованием учетной записи организации, выполните следующую команду:

    azure login -u username -p password

Или, чтобы войти при помощи ввода данных в интерактивном режиме:

    azure login

>[AZURE.NOTE]Метод входа работает только с учетной записью организации. Учетная запись организации — это пользователь, который управляется вашей организацией и определен в клиенте Azure Active Directory организации.


Если вы используете для входа в подписку Azure учетную запись Microsoft, вы можете создать учетную запись организации, выполнив следующие действия.

1.	Войдите на [портал управления Azure](https://manage.windowsazure.com/) и щелкните "Active Directory".
2.	Если каталог не существует, выберите Создание каталога и укажите нужные данные.
3.	Выберите каталог и добавьте нового пользователя. Этот пользователь будет представлять учетную запись организации. При создании пользователя вам будут предоставлены электронной адрес и временный пароль. Эти данные используются на следующем шаге. Сохраните их.
4.	На портале Azure выберите "Параметры", а затем "Администраторы". Щелкните Добавить, чтобы добавить нового пользователя в качестве соадминистратора. Это позволит использовать вашу учетную запись организации для управления подпиской Azure.
5.	Выйдите из портала Azure и затем войдите снова с использованием новой рабочей учетной записи. При первом входе в учетную запись появится запрос на изменение пароля.

Дополнительную информацию об использовании рабочей учетной записи в Microsoft Azure см. в разделе [Регистрация организации в Microsoft Azure](sign-up-organization.md).

Если у вас есть несколько подписок и нужно указать лишь одну из них, которая будет использоваться для хранилища ключей Azure, введите следующую команду, чтобы увидеть подписки своей учетной записи:

    azure account list

Далее, чтобы указать подписку, которую нужно использовать, введите:

    azure account set <subscription name>

Дополнительные сведения о настройке межплатформенного интерфейса командной строки Azure см. в разделе [Установка и настройка межплатформенного интерфейса командной строки Azure](xplat-cli.md).


## Переключение в режим использования диспетчера ресурсов Azure

Для хранилища ключей Azure требуется диспетчер ресурсов Azure, поэтому введите следующую команду, чтобы переключиться в режим этого диспетчера:

    azure config mode arm

## Создание новой группы ресурсов

При использовании диспетчера ресурсов Azure все связанные ресурсы создаются внутри группы ресурсов. Для примера мы создадим новую группу ресурсов с именем ContosoResourceGroup:

    azure group create 'ContosoResourceGroup' 'East Asia'

Первый параметр — имя группы ресурсов, а второй параметр — его расположение. Для параметра расположения используйте команду `azure location list`, чтобы указать альтернативное расположение группы. Если вам необходима дополнительная информация, введите `azure help location`.



## Создайте хранилище ключей.

Для создания хранилища ключей используйте команду `azure keyvault create`. Этот сценарий предусматривает три обязательных параметра: имя группы ресурсов, имя хранилища ключей и географическое расположение.

Например, если вы используете хранилище с именем ContosoKeyVault, группу ресурсов с именем ContosoResourceGroup и расположение "Восточная Азия", введите:

    azure keyvault create --vault-name 'ContosoKeyVault' --resource-group 'ContosoResourceGroup' --location 'East Asia'

В выходных данных команды будут показаны свойства хранилища ключей, которое вы только что создали. Среди всех свойств есть два самых важных:

- **имя**. В этом примере — ContosoKeyVault. Вы будете использовать это имя для выполнения других командлетов хранилища ключей;
- **vaultUri**. В этом примере — https://contosokeyvault.vault.azure.net. Необходимо, чтобы приложения, использующие ваше хранилище через REST API, использовали этот URI.

Теперь ваша учетная запись Azure авторизована, и вы можете выполнять любые операции в этом хранилище ключей. Пока что это недоступно для других учетных записей.


## Добавьте ключ или секретный код в хранилище ключей.

Если вам необходимо создать ключ с программной защитой для собственного использования с помощью хранилища ключей Azure, используйте команду `azure key create` и введите следующее:

    azure keyvault key create --vault-name 'ContosoKeyVault' --key-name 'ContosoFirstKey' --destination software

Однако если у вас уже есть ключ, сохраненный в виде локального PEM-файла с именем softkey.pem, который требуется загрузить в хранилище ключей Azure, воспользуйтесь следующей командой импорта ключа из PEM-файла, которая позволяет программным образом защитить ключ в службе хранилища ключей:

    azure keyvault key import --vaultName 'ContosoKeyVault' --key-name 'ContosoFirstKey' --pem-file './softkey.pem' –-password 'PaSSWORD' --destination software

Теперь для доступа к ключу, созданному или загруженному в хранилище ключей Azure, вы сможете использовать его URI. Чтобы постоянно получать текущую версию, используйте адрес ****https://ContosoKeyVault.vault.azure.net/keys/ContosoFirstKey**, а для получения данной конкретной версии используйте адрес ****https://ContosoKeyVault.vault.azure.net/keys/ContosoFirstKey/cgacf4f763ar42ffb0a1gca546aygd87**.

Чтобы добавить секрет в хранилище ключей Azure, который представляет собой пароль с именем SQLPassword и значением Pa$$w0rd, введите следующее:

    azure keyvault secret set --vault-name 'ContosoKeyVault' --secret-name 'SQLPassword' --value 'Pa$$w0rd'

Теперь пароль, добавленный в хранилище ключей Azure, можно вызвать, используя его URI. Чтобы постоянно получать текущую версию, используйте адрес ****https://ContosoVault.vault.azure.net/secrets/SQLPassword**, а для получения данной конкретной версии используйте адрес ****https://ContosoVault.vault.azure.net/secrets/SQLPassword/90018dbb96a84117a0d2847ef8e7189d**.

Давайте просмотрим только что созданный ключ или секрет.

- Чтобы просмотреть свой ключ, введите `azure keyvault key list --vault-name 'ContosoKeyVault'`.
- Чтобы просмотреть свой секрет, введите `azure keyvault secret list -–vault-name 'ContosoKeyVault'`.


## Зарегистрируйте приложение с Azure Active Directory.

Обычно этот шаг выполняет разработчик на отдельном компьютере. Он не относится к хранилищу ключей Azure, но включен в этот учебник для полноты картины.


>[AZURE.IMPORTANT]Чтобы завершить прохождение этого учебника, учетная запись, хранилище и приложение, которое вы будете регистрировать на этом шаге, должны находиться в одном каталоге Azure.

Приложения, которые используют хранилища ключей, должны пройти аутентификацию с использованием маркера Azure Active Directory. Для этого владельцу приложения необходимо сначала зарегистрировать приложение в Azure Active Directory. В конце регистрации владелец приложения получает следующие значения.


- **Идентификатор приложения** (также известный как идентификатор клиента) и **ключ аутентификации** (также известный как общий секрет). Для получения маркера приложение должно предоставить Azure Active Directory оба этих значения. Настроенный способ предоставления зависит от приложения. В примере приложения, использующего хранилище ключей, владелец задает эти значения в файле app.config.



Чтобы зарегистрировать приложение в Azure Active Directory:

1. Войдите на портал Azure.
2. Слева щелкните **Active Directory**, а затем выберите каталог, в котором вам необходимо зарегистрировать приложение. <br> <br> Примечание. Вам необходимо выбрать каталог, содержащий подписку Azure, которую вы использовали для создания хранилища ключей. Если вам не известно, какой это каталог, щелкните **Параметры**, найдите подписку, использованную для создания хранилища ключей, и запишите имя каталога, отображающегося в последнем столбце.

3. Щелкните **ПРИЛОЖЕНИЯ**. Если в каталоге нет добавленных приложений, на этой странице отобразится только ссылка **Добавить приложение**. Щелкните ссылку или, как вариант, можно щелкнуть **ДОБАВИТЬ** на панели команд.
4.	В мастере **ДОБАВЛЕНИЕ ПРИЛОЖЕНИЯ** на странице **Что необходимо сделать?** щелкните **Добавить приложение, разрабатываемое моей организацией**.
5.	На странице **Расскажите о своем приложении** укажите имя своего приложения и выберите **ВЕБ-ПРИЛОЖЕНИЕ И/ИЛИ ВЕБ-API** (по умолчанию). Щелкните значок "Далее".
6.	На странице **Свойства приложения** укажите данные в полях **URL-АДРЕС ВХОДА** и **URI КОДА ПРИЛОЖЕНИЯ** для своего веб-приложения. Если в вашем приложении нет этих значений, можно придумать их для этого шага (например, можно указать http://test1.contoso.com в обоих полях). Не важно, существуют ли эти сайты. Важно то, что URI кода приложения отличается для каждого приложения в каталоге. Каталог использует эту строку для идентификации приложения.
7.	Щелкните значок "Готово", чтобы сохранить изменения в мастере.
8.	На странице "Быстрый запуск" щелкните **НАСТРОИТЬ**.
9.	Прокрутите страницу до раздела **ключей**, выберите длительность и щелкните **СОХРАНИТЬ**. Страница обновится и отобразится значение ключа. Необходимо настроить приложение, указав это значение ключа и значение **ИДЕНТИФИКАТОР КЛИЕНТА** (указания по этой конфигурации зависят от конкретного приложения).
10.	Скопируйте значение идентификатора клиента на этой странице. Вы будете использовать его на следующем шаге, чтобы задать разрешения в своем хранилище.




## Разрешите приложению использовать ключ или секретный код.

Чтобы авторизовать приложение для получения доступа к ключу или секрету в хранилище, используйте команду `azure keyvault set-policy`.

Например, если имя хранилища — ContosoKeyVault, а идентификатор клиента приложения — 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed, и нужно авторизовать это приложение для расшифровки и подписи с использованием ключей в вашем хранилище, выполните следующее:

    azure keyvault set-policy --vault-name 'ContosoKeyVault' --spn 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed --perm-to-keys '[“decrypt”,”sign”]'

Если этому же приложению необходимо разрешить читать секретные данные в хранилище, выполните следующую команду:

	azure keyvault set-policy --vault-name 'ContosoKeyVault' --spn 8f8c4bbd-485b-45fd-98f7-ec6300b7b4ed --perm-to-secrets '["Get"]'

## Использование аппаратного модуля безопасности ##

Чтобы обеспечить более высокий уровень защиты, можно импортировать ключи или создать их в аппаратных модулях безопасности (ключи никогда не покидают их пределов). В качестве аппаратных модулей безопасности используются модули FIPS 140-2 с проверкой уровня 2. Если это требование вас не касается, пропустите этот подраздел и перейдите к подразделу [Удаление хранилища ключей, а также связанных ключей и секретов](#delete-the-key-vault-and-associated-keys-and-secrets).

Чтобы создать ключи, защищенные аппаратным модулем безопасности, у вас должна быть подписка на хранилище, которая поддерживает ключи, защищенные аппаратным модулем безопасности.

При создании хранилища добавьте параметр sku:

    azure azure keyvault create --vault-name 'ContosoKeyVaultHSM' --resource-group 'ContosoResourceGroup' --location 'East Asia' --sku 'Premium'

В это хранилище можно добавлять ключи с программной защитой (как показано выше) и ключи, защищенные аппаратным модулем безопасности. Чтобы создать ключ, защищенный аппаратным модулем безопасности, задайте значение HSM для параметра Destination:

    azure keyvault key create --vault-name 'ContosoKeyVaultHSM' --key-name 'ContosoFirstHSMKey' --destination 'HSM'

Вы можете использовать следующую команду для импорта ключа из PEM-файла на своем компьютере. Эта команда импортирует ключ в аппаратные модули безопасности в службе хранилища ключей:

    azure keyvault key import --vault-name 'ContosoKeyVaultHSM' --key-name 'ContosoFirstHSMKey' --pem-file '/.softkey.pem' --destination 'HSM' –-password 'PaSSWORD'

Следующая команда импортирует пакет собственного ключа клиента (BYOK). Это дает возможность создать ключ в своем локальном аппаратном модуле безопасности и передать его в аппаратные модули безопасности в службе хранилища ключей так, чтобы ключ не покидал их пределы:

    azure keyvault key import --vault-name 'ContosoKeyVaultHSM' --key-name 'ContosoFirstHSMKey' --byok-file './ITByok.byok' --destination 'HSM'

Более подробные указания по созданию пакета BYOK см. в разделе [Как использовать ключи, защищенные аппаратным модулем безопасности, с помощью хранилища ключей Azure](key-vault-hsm-protected-keys.md).


## Удаление хранилища ключей, а также связанных ключей и секретов

Если больше нет необходимости в хранилище ключей и содержащемся в нем ключе или секрете, можно удалить его, используя команду azure keyvault delete:

    azure keyvault delete --vault-name 'ContosoKeyVault'

Как вариант, можно удалить всю группу ресурсов Azure, которая включает в себя хранилище ключей и другие ресурсы, которые вы добавили в эту группу:

    azure group delete --name 'ContosoResourceGroup'


## Другие команды в межплатформенном интерфейсе командной строки Azure

Вот другие команды, которые могут быть полезны при управлении хранилищем ключей Azure.

Эта команда перечисляет все ключи и выбранные свойства в виде таблицы:

    azure keyvault key list --vault-name 'ContosoKeyVault'

Эта команда отображает полный список свойств для указанного ключа:

    azure keyvault key show --vault-name 'ContosoKeyVault' –-key-name 'ContosoFirstKey'

Эта команда перечисляет все имена секретов и выбранные свойства в виде таблицы:

    azure keyvault secret list --vault-name 'ContosoKeyVault'

Пример удаления конкретного ключа:

    azure keyvault key delete --vault-name 'ContosoKeyVault' --key-name 'ContosoFirstKey'

Пример удаления конкретного секрета:

    azure keyvault secret delete --vault-name 'ContosoKeyVault' --secret-name 'SQLPassword'


## Дальнейшие действия

Справочные материалы по программированию см. в [руководстве разработчика для хранилища ключей Azure](key-vault-developers-guide.md).

<!---HONumber=Sept15_HO4-->