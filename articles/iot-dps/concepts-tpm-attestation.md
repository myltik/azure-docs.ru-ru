---
title: Служба подготовки устройств к добавлению в Центр Интернета вещей. Аттестация TPM
description: В этой статье описаны принципы аттестации TPM с использованием Службы подготовки устройств к добавлению в Центр Интернета вещей.
author: nberdy
ms.author: nberdy
ms.date: 04/23/2018
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
manager: briz
ms.openlocfilehash: 90f41e56f8e95584959576d3e5ad837f4774048a
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34629088"
---
# <a name="tpm-attestation"></a>Аттестация доверенного платформенного модуля

Служба подготовки устройств для Центра Интернета вещей — это вспомогательная служба, позволяющая настроить полностью автоматическую подготовку устройства в указанном Центре Интернета вещей. Она дает возможность подготавливать миллионы устройств с высоким уровнем безопасности и масштабируемости.

В этой статье описан процесс аттестации удостоверений при использовании [TPM](./concepts-device.md). TPM расшифровывается как доверенный платформенный модуль (Trusted Platform Module). Это тип аппаратного модуля безопасности (HSM). В этой статье предполагается, что используется дискретный, микропрограммный или интегрированный модуль TPM. Эмулированные программными средствами модули TPM хорошо подходят для прототипирования или тестирования. Но они не обеспечивают такой же уровень безопасности, как дискретные, микропрограммные или интегрированные TPM. Мы не рекомендуем использовать программные модули TPM в рабочей среде. [Узнайте больше](http://trustedcomputinggroup.org/wp-content/uploads/TPM-2.0-A-Brief-Introduction.pdf) о типах модулей TPM.

Эта статья относится только к устройствам, в которых используется TPM 2.0 с поддержкой ключа HMAC, и их ключам подтверждения. Она не предназначена для устройств, в которых используются сертификаты X.509 для аутентификации. TPM — это общеотраслевой стандарт ISO от организации TCG. Дополнительные сведения о нем можно найти в [полной спецификации TPM 2.0](https://trustedcomputinggroup.org/tpm-library-specification/) или [спецификации ISO/IEC 11889](https://www.iso.org/standard/66510.html). В этой статье также предполагается, что вы имеете представление о парах открытых и закрытых ключей и о том, как они используются для шифрования.

Пакеты SDK службы подготовки устройств, связанные с теми или иными устройствами, выполняют всю описанную в данной статье обработку вместо вас. При использовании пакетов SDK на устройствах нет необходимости внедрять что-либо еще. Эта статья поможет вам составить представление о принципе действия микросхемы безопасности TPM при подготовке устройства и о факторах, обеспечивающих высокий уровень защиты.

## <a name="overview"></a>Обзор

В модулях TPM в качестве корня доверия используется так называемый ключ подтверждения (EK). EK уникален для модуля TPM. Если изменить EK, устройство фактически преобразуется в новое.

В модулях TPM есть еще один тип ключа, называемый корневым ключом хранилища (SRK). Ключ SRK может сформировать владелец модуля TPM после получения права владения. В терминологии TPM получение права владения модулем TPM — это ситуация, когда "кто-либо устанавливает пароль на HSM". Если устройство TPM продано новому владельцу, он может получить право владения модулем TPM, чтобы создать новый SRK. Создание нового SRK гарантирует, что предыдущий владелец не сможет использовать этот модуль TPM. Так как SRK уникален для владельца TPM, с помощью SRK можно запечатать данные в самом модуле TPM соответствующего владельца. SRK предоставляет владельцу песочницу для хранения ключей и позволяет отозвать доступ при продаже устройства или модуля TPM. Это напоминает переезд в новый дом: при смене владельца меняются дверные замки и убирается вся мебель, оставленная предыдущими владельцами (SRK), но адрес дома (EK) изменить нельзя.

Как только устройство будет настроено и готово к использованию, на нем будут доступны оба ключа — EK и SRK.

![Получение права владения TPM](./media/concepts-tpm-attestation/tpm-ownership.png)

Примечание о получении права владения TPM. Получение этого права зависит от многих факторов, включая производителя TPM, набор используемых средств TPM и ОС устройства. Чтобы получить право владения, следуйте инструкциям для своей системы.

Служба подготовки устройства использует открытую часть EK (EK_pub) для идентификации и регистрации устройств. Поставщик устройства может считать часть EK_pub во время изготовления или заключительного тестирования и передать ее в службу подготовки, чтобы устройство распознавалось при подключении для подготовки. Служба подготовки устройств не проверяет SRK или владельца. Поэтому при очистке TPM удаляются данные клиента, но EK (и другие данные поставщика) сохраняются. После этого устройство по-прежнему распознается службой подготовки устройств при подключении для подготовки.

## <a name="detailed-attestation-process"></a>Подробный процесс аттестации

При первом подключении устройства с модулем TPM к службе подготовки устройств эта служба сначала проверяет указанную часть EK_pub относительно части EK_pub, сохраненной в списке регистрации. Если EK_pub не совпадают, устройство не допускается к подготовке. Если EK_pub совпадают, служба подает устройству запрос на подтверждение владения закрытой частью EK. Для этого используется задача nonce — защищенная операция для аутентификации. Служба подготовки устройств формирует значение nonce, шифрует его с помощью SRK и EK_pub, которые предоставляются устройством при начальном вызове регистрации. В модуле TPM закрытая часть EK всегда хранится с поддержкой надлежащего уровня безопасности. Это позволяет предотвратить подделку и гарантирует защищенную подготовку маркеров SAS для разрешенных устройств.

Рассмотрим процесс аттестации в подробностях.

### <a name="device-requests-an-iot-hub-assignment"></a>Запрос устройства на назначение Центра Интернета вещей

Сначала устройство подключается к службе подготовки устройств и запрашивает подготовку. При этом устройство предоставляет службе свой идентификатор регистрации, сведения об области идентификатора, а также EK_pub и SRK_pub модуля TPM. Служба передает зашифрованное значение nonce обратно на устройство и запрашивает у устройства расшифровку nonce. Результат используется для подписания маркера SAS с целью повторного подключения и завершения подготовки.

![Устройство запрашивает подготовку](./media/concepts-tpm-attestation/step-one-request-provisioning.png)

### <a name="nonce-challenge"></a>Задача nonce

Устройство принимает значение nonce и использует закрытые части EK и SRK для расшифровки nonce в TPM. При шифровании nonce доверие делегируется от EK, который является неизменяемым, к SRK, который может измениться, если право владения модулем TPM получит новый владелец.

![Расшифровка nonce](./media/concepts-tpm-attestation/step-two-nonce.png)

### <a name="validate-the-nonce-and-receive-credentials"></a>Проверка nonce и получение учетных данных

Устройство затем может подписать маркер SAS с помощью расшифрованного значения nonce и повторно установить подключение к службе подготовки устройств, используя подписанный маркер SAS. По завершении задачи nonce служба разрешает подготовку устройства.

![Устройство восстанавливает подключение к DPS для проверки владения EK](./media/concepts-tpm-attestation/step-three-validation.png)

## <a name="next-steps"></a>Дополнительная информация

Теперь устройство подключается к Центру Интернета вещей и вы можете быть уверены в безопасности хранения ключей ваших устройств. Теперь, когда вы знаете, как служба подготовки устройств проверяет удостоверение устройства с помощью модуля TPM с поддержкой надлежащего уровня безопасности, можно приступать к следующим материалам:

* [сведения о принципах автоматической подготовки](./concepts-auto-provisioning.md);
* [сведения о начале работы с использованием автоматической подготовки](./quick-setup-auto-provision.md), которая выполняется с помощью пакетов SDK.
