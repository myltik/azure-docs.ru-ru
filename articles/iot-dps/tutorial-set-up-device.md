---
title: Настройка устройства для службы "Подготовка устройств к добавлению в Центр Интернета вещей"
description: Настройка устройства для подготовки через службу подготовки устройств для Центра Интернета вещей во время производства устройства.
author: dsk-2015
ms.author: dkshir
ms.date: 04/02/2018
ms.topic: tutorial
ms.service: iot-dps
services: iot-dps
manager: timlt
ms.custom: mvc
ms.openlocfilehash: 1e4e93c276fe62caae17c85bf9ac92282dfdfb88
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34631274"
---
# <a name="set-up-a-device-to-provision-using-the-azure-iot-hub-device-provisioning-service"></a>Настройка устройства для подготовки с помощью службы подготовки устройств для Центра Интернета вещей

В предыдущем руководстве вы узнали, как настроить службу подготовки устройств для Центра Интернета вещей, чтобы автоматически подготавливать устройства в Центре Интернета вещей. В этом руководстве объясняется, как настроить устройство во время производства для автоматической подготовки в Центре Интернета вещей. Устройство подготавливается на основе [механизма аттестации](concepts-device.md#attestation-mechanism) после первой загрузки и подключения к службе подготовки. В этом руководстве рассматриваются такие процессы:

> [!div class="checklist"]
> * создание клиентского пакета SDK служб подготовки устройств для определенной платформы;
> * извлечение артефактов безопасности;
> * создать программный пакет регистрации устройств.

## <a name="prerequisites"></a>предварительным требованиям

Прежде чем продолжить, создайте экземпляр службы подготовки устройств и Центр Интернета вещей с помощью инструкций, приведенных в предыдущем руководстве [Настройка облачных ресурсов для подготовки устройств с помощью службы подготовки устройств для Центра Интернета вещей](./tutorial-set-up-cloud.md).

В этом руководстве используется [репозиторий пакетов SDK для Azure IoT и библиотек для C](https://github.com/Azure/azure-iot-sdk-c), который содержит клиентский пакет SDK службы подготовки устройств для C. Пакет SDK сейчас обеспечивает поддержку доверенного платформенного модуля (TPM) и сертификата X.509 для устройств под управлением Windows или Ubuntu. Для этого руководства используется клиент разработки Windows. Также предполагается, что у вас есть навыки работы с Visual Studio 2017. 

Если вы не знакомы с процессом автоматической подготовки, обязательно ознакомьтесь со статьей [Принципы автоматической подготовки устройств](concepts-auto-provisioning.md), прежде чем продолжить. 

## <a name="build-a-platform-specific-version-of-the-sdk"></a>Создание версии пакета SDK для определенной платформы

Клиентский пакет SDK для службы подготовки устройств позволяет реализовать программный пакет регистрации устройств. Но до этого нужно создать версию пакета SDK для определенной клиентской платформы разработки и механизма аттестации. С помощью этого руководства вы создадите пакет SDK, который использует Visual Studio 2017 на платформе разработки Windows для поддерживаемого типа аттестации:

1. Установите необходимые средства и клонируйте репозиторий GitHub, который содержит пакет SDK службы подготовки для C:

   a. Установите на компьютер Visual Studio 2015 или [Visual Studio 2017](https://www.visualstudio.com/vs/). Для установки Visual Studio требуется включить рабочую нагрузку [Разработка классических приложений с помощью C++](https://www.visualstudio.com/vs/support/selecting-workloads-visual-studio-2017/).

   Б. Скачайте и установите [систему сборки CMake](https://cmake.org/download/). **Перед** установкой CMake обязательно установите на компьютер Visual Studio с рабочей нагрузкой "Разработка классических приложений на C++".

   c. Установите на компьютер систему `git` и добавьте ее в переменные среды, доступные в командном окне. Последние версии средств `git`, включая оболочку Bash командной строки **Git Bash**, для взаимодействия с локальным репозиторием Git доступны на странице [со средствами клиента Git от Software Freedom Conservancy](https://git-scm.com/download/). 

   d. Откройте Git Bash и клонируйте репозиторий пакетов SDK для Azure IoT и библиотек для C. Для выполнения команды clone может потребоваться несколько минут, так как она скачивает несколько зависимых подмодулей.
    
   ```cmd/sh
   git clone https://github.com/Azure/azure-iot-sdk-c.git --recursive
   ```

   д. Создайте подкаталог `cmake` в созданном подкаталоге репозитория:

   ```cmd/sh
   mkdir azure-iot-sdk-c/cmake
   ``` 

2. Из командной строки Git Bash перейдите к подкаталогу `cmake` репозитория azure-iot-sdk-c.

   ```cmd/sh
   cd azure-iot-sdk-c/cmake
   ```

3. Создайте пакет SDK для вашей платформы разработки и одного из поддерживаемых механизмов аттестации с помощью одной из следующих команд (обратите внимание на две точки в конце строки). По завершении CMake создает подкаталог `/cmake` с содержимым для вашего устройства.
    - Для устройств, использующих физические модули TPM или HSM или имитированный сертификат X.509 для аттестации, выполните следующую команду:
        ```cmd/sh
        cmake -Duse_prov_client:BOOL=ON ..
        ```

    - Для устройств, использующих симулятор TPM для аттестации, выполните следующую команду:
        ```cmd/sh
        cmake -Duse_prov_client:BOOL=ON -Duse_tpm_simulator:BOOL=ON ..
        ```

Теперь вы можете использовать пакет SDK для создания кода регистрации устройства. 
 
<a id="extractsecurity"></a> 

## <a name="extract-the-security-artifacts"></a>извлечение артефактов безопасности; 

Следующий шаг заключается в извлечении артефактов безопасности для механизма аттестации, который используется устройством. 

### <a name="physical-device"></a>Физическое устройство 

Если пакет SDK создан для аттестации на основе физического модуля TPM или HSM, сделайте следующее:

- Для устройства с доверенным платформенным модулем необходимо определить связанный **ключ подтверждения** у производителя микросхемы доверенного платформенного модуля. Можно получить уникальный **ИД регистрации** для устройства TPM с помощью хэширования ключа подтверждения.  

- Для устройства X.509 необходимо получить сертификаты, выпущенные для устройства — сертификаты конечных субъектов для отдельных регистраций устройств и корневые сертификаты для групповых регистраций устройств. 

### <a name="simulated-device"></a>Виртуальное устройство

Если пакет SDK создан для аттестации на основе имитированного TPM или сертификата X.509, сделайте следующее.

- Для имитированного устройства с TPM
   1. В отдельной или новой командной строке перейдите к подкаталогу `azure-iot-sdk-c` и запустите симулятор TPM. Он ожидает передачи данных через сокет на портах 2321 и 2322. Не закрывайте это командное окно. Симулятор должен работать, пока вы не выполните все инструкции из этого руководства. 

      В подкаталоге `azure-iot-sdk-c` выполните следующую команду, чтобы запустить симулятор:

      ```cmd/sh
      .\provisioning_client\deps\utpm\tools\tpm_simulator\Simulator.exe
      ```

   2. С помощью Visual Studio откройте решение `azure_iot_sdks.sln`, созданное в папке *cmake*, и скомпилируйте его с помощью команды "Собрать решение" в меню "Сборка".

   3. На панели *обозревателя решений* в Visual Studio перейдите в папку **Provision\_Tools**. Щелкните проект **tpm_device_provision** правой кнопкой мыши и выберите параметр **Назначить запускаемым проектом**. 

   4. Запустите решение с помощью одной из команд запуска в меню "Отладка". В окне выходных данных отображается **_идентификатор регистрации_** и **_ключ подтверждения_** симулятора TPM, необходимые для регистрации устройства. Скопируйте эти значения для дальнейшего использования. Можете закрыть окно с идентификатором регистрации и ключом подтверждения, но не закрывайте окно симулятора TPM, который вы запустили в шаге 1.

- Для имитированного устройства с сертификатом X.509
  1. С помощью Visual Studio откройте решение `azure_iot_sdks.sln`, созданное в папке *cmake*, и скомпилируйте его с помощью команды "Собрать решение" в меню "Сборка".

  2. На панели *обозревателя решений* в Visual Studio перейдите в папку **Provision\_Tools**. Щелкните проект **dice\_device\_enrollment** правой кнопкой мыши и выберите параметр **Назначить запускаемым проектом**. 
  
  3. Запустите решение с помощью одной из команд запуска в меню "Отладка". При появлении запроса введите **i** в окне вывода для индивидуальной регистрации. В окне вывода отобразится локально созданный сертификат X.509 для имитированного устройства. Скопируйте в буфер обмена выходные данные, начиная со строки *-----BEGIN CERTIFICATE-----* и заканчивая строкой *-----END CERTIFICATE-----*. Не забудьте скопировать и эти две строки. Обратите внимание, что вам нужен только первый сертификат из окна выходных данных.
 
  4. Создайте файл **_X509testcert.pem_**, откройте его в любом текстовом редакторе и скопируйте в файл содержимое из буфера обмена. Сохраните файл, так как он понадобится позже для регистрации устройства. При запуске программного обеспечения для регистрации используется тот же сертификат, что и для автоматической подготовки.    

Такие артефакты безопасности необходимы при регистрации устройств в службе подготовки устройств. Служба подготовки ожидает загрузки этих устройств и подключается к ним в любой момент времени в будущем. При первой загрузке устройства клиентский пакет SDK взаимодействует с микросхемой (или симулятором), извлекая артефакты безопасности с устройства, и проверяет регистрацию в службе подготовки устройств. 

## <a name="create-the-device-registration-software"></a>Создание программного пакета регистрации устройств

Последний шаг заключается в написании приложения, использующего клиентский пакет SDK службы подготовки устройств для регистрации устройства в службе Центра Интернета вещей. 

> [!NOTE]
> Для этого шага предполагается использование имитированного устройства с запущенным примером приложения для регистрации, которое использует SDK, на рабочей станции. Этот же подход используется и при создании приложения для регистрации для развертывания на физическом устройстве. 

1. На портале Azure выберите колонку **Обзор** службы подготовки устройств и скопируйте значение **_области идентификатора_**. *Область идентификаторов* создается службой и гарантирует уникальность. Она неизменяемая и используется для уникальной идентификации идентификаторов регистрации.

    ![Извлечение информации о конечной точке диагностики DPS из колонки портала](./media/tutorial-set-up-device/extract-dps-endpoints.png) 

2. В *обозревателе решений* Visual Studio перейдите в папку **Provision\_Samples**. Выберите пример проекта с именем **prov\_dev\_client\_sample** и откройте исходный файл **prov\_dev\_client\_sample.c**.

3. Присвойте значение _идентификатора области_, полученное на шаге 1, переменной `id_scope` (удалите квадратные скобки справа /`[` и слева /`]`). 

    ```c
    static const char* global_prov_uri = "global.azure-devices-provisioning.net";
    static const char* id_scope = "[ID Scope]";
    ```

    Также приведена переменная `global_prov_uri`, которая позволяет API регистрации клиента в Центре Интернета вещей `IoTHubClient_LL_CreateFromDeviceAuth` подключаться к указанному экземпляру службы подготовки устройств.

4. В функции **main()** этого же файла закомментируйте или раскомментируйте переменную `hsm_type`. Она определяет механизм аттестации, используемый программным пакетом регистрации устройства (TPM или X.509): 

    ```c
    hsm_type = SECURE_DEVICE_TYPE_TPM;
    //hsm_type = SECURE_DEVICE_TYPE_X509;
    ```

5. Сохраните изменения и повторно создайте пример проекта **prov\_dev\_client\_sample**, выбрав "Собрать решение" в меню "Сборка". 

6. В папке **Provision\_Samples** щелкните правой кнопкой мыши проект **prov\_dev\_client\_sample** и выберите пункт **Назначить запускаемым проектом**. Не запускайте пример приложения.

> [!IMPORTANT]
> И не запускайте устройство. Сначала необходимо завершить процесс, зарегистрировав устройство в службе подготовки устройств. Ссылка на следующую статью приводится в разделе с дополнительными сведениями ниже.

### <a name="sdk-apis-used-during-registration-for-reference-only"></a>API пакета SDK, используемые при регистрации (только для справки)

Ниже для справки приводятся предоставляемые в пакете SDK интерфейсы API для приложения, которые используются при регистрации. Эти API помогают устройству подключиться и зарегистрироваться в службе подготовки устройств во время загрузки. В свою очередь устройство получает сведения, необходимые для подключения к экземпляру Центра Интернета вещей.

```C
// Creates a Provisioning Client for communications with the Device Provisioning Client Service.  
PROV_DEVICE_LL_HANDLE Prov_Device_LL_Create(const char* uri, const char* scope_id, PROV_DEVICE_TRANSPORT_PROVIDER_FUNCTION protocol)

// Disposes of resources allocated by the provisioning Client.
void Prov_Device_LL_Destroy(PROV_DEVICE_LL_HANDLE handle)

// Asynchronous call initiates the registration of a device.
PROV_DEVICE_RESULT Prov_Device_LL_Register_Device(PROV_DEVICE_LL_HANDLE handle, PROV_DEVICE_CLIENT_REGISTER_DEVICE_CALLBACK register_callback, void* user_context, PROV_DEVICE_CLIENT_REGISTER_STATUS_CALLBACK reg_status_cb, void* status_user_ctext)

// Api to be called by user when work (registering device) can be done
void Prov_Device_LL_DoWork(PROV_DEVICE_LL_HANDLE handle)

// API sets a runtime option identified by parameter optionName to a value pointed to by value
PROV_DEVICE_RESULT Prov_Device_LL_SetOption(PROV_DEVICE_LL_HANDLE handle, const char* optionName, const void* value)
```

Возможно, вам потребуется более точно определить клиентское приложение для регистрации службы подготовки устройств сначала с помощью имитированного устройства, а затем — в ходе настройки службы тестирования. Когда приложение будет работать в тестовой среде, его можно создать для конкретного устройства и скопировать исполняемый файл в образ устройства. 

## <a name="clean-up-resources"></a>Очистка ресурсов

Возможно, на этом этапе вам понадобится запустить службу подготовки устройств и Центр Интернета вещей на портале. Если вы хотите прервать настройку подготовки устройств и (или) приостановить прохождение этой серии руководств, рекомендуется завершить работу служб, чтобы избежать лишних затрат.

1. В меню слева на портале Azure щелкните **Все ресурсы** и откройте службу подготовки устройств. В верхней части колонки **Все ресурсы** щелкните **Удалить**.  
2. В меню слева на портале Azure нажмите кнопку **Все ресурсы** и выберите свой Центр Интернета вещей. В верхней части колонки **Все ресурсы** щелкните **Удалить**.  

## <a name="next-steps"></a>Дополнительная информация
Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> * создать клиентский пакет SDK службы подготовки устройств для определенной платформы;
> * извлечение артефактов безопасности;
> * создать программный пакет регистрации устройств.

Перейдите к следующему руководству, чтобы узнать, как подготовить свое устройство в Центре Интернета вещей, зарегистрировав его в службе подготовки устройств для Центра Интернета вещей Azure, позволяющей выполнить автоматическую подготовку.

> [!div class="nextstepaction"]
> [Provision the device to an IoT hub using the Azure IoT Hub Device Provisioning Service](tutorial-provision-device-to-hub.md) (Подготовка устройства в Центре Интернета вещей с помощью службы подготовки устройств для Центра Интернета вещей).

