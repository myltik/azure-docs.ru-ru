---
title: Асимметричная маршрутизация | Документация Майкрософт
description: В этой статье рассматриваются проблемы, которые могут возникнуть у клиента при асимметричной маршрутизации в сети, когда есть несколько подключений к целевому расположению.
documentationcenter: na
services: expressroute
author: osamazia
manager: carmonm
editor: ''
ms.assetid: a754bff9-95c9-44b5-9796-377fc21e8322
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/10/2016
ms.author: osamam
ms.openlocfilehash: 8568c13d2834a0643e15ab1814a35c92123837d1
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
ms.locfileid: "22710020"
---
# <a name="asymmetric-routing-with-multiple-network-paths"></a>Асимметричная маршрутизация с использованием нескольких сетевых путей
В этой статье объясняется, как прямой и обратный сетевой трафик может проходить по разным маршрутам, если между исходным и целевым сетевыми расположениями есть несколько путей.

Чтобы понять, что такое асимметричная маршрутизация, необходимо рассмотреть два фактора. Первый — влияние нескольких сетевых путей. Второй — как устройства, такие как брандмауэр, сохраняют состояние. Устройства такого типа называются устройствами с отслеживанием состояния. Сочетание этих двух факторов создает ситуации, когда устройства с отслеживанием состояния не пропускают сетевой трафик, обнаружив, что он не поступал от них.

## <a name="multiple-network-paths"></a>Несколько сетевых путей
Когда в корпоративной сети есть только одно подключение к Интернету через поставщика интернет-услуг, весь трафик, поступающий из Интернета и обратно, проходит по одному и тому же пути. Часто компании приобретают несколько каналов в качестве избыточных путей, чтобы повысить работоспособность сети. В таких случаях бывает, что трафик из сети в Интернет проходит через одно подключение, а обратный трафик — через другое. Это явление называется асимметричной маршрутизацией. При асимметричной маршрутизации обратный сетевой трафик проходит по пути, отличающемуся от исходного.

![Сеть с несколькими путями](./media/expressroute-asymmetric-routing/AsymmetricRouting3.png)

В основном это происходит в Интернете, но асимметричная маршрутизация возможна и при другом сочетании путей. Например, она применяется при наличии интернет-пути и частного пути к одному и тому же целевому расположению, а также нескольких частных путей к одному и тому же целевому расположению.

Каждый маршрутизатор вычисляет оптимальный путь от исходного расположения к целевому. Определение лучшего возможного пути маршрутизатором основывается на двух основных факторах.

* Маршрутизация между внешними сетями реализуется с помощью протокола маршрутизации BGP. BGP принимает объявления от соседей и запускает их в несколько этапов, чтобы определить оптимальный путь к целевому расположению. Оптимальный путь сохраняется в таблице маршрутизации.
* На пути маршрутизации влияет длина маски подсети, связанной с маршрутом. Если маршрутизатор получает несколько объявлений для одного IP-адреса, но с разными масками подсети, предпочтительным является объявление с более длинной маской подсети, ведь такой маршрут считается более определенным.

## <a name="stateful-devices"></a>Устройства с отслеживанием состояния
Маршрутизаторы анализируют IP-заголовок пакета в рамках задач маршрутизации. Некоторые устройства анализируют пакет более подробно. Как правило, эти устройства рассматривают заголовки на уровне 4 (протокол TCP либо UDP) или даже на уровне 7 (слой приложения). Это либо устройства для обеспечения безопасности, либо устройства для оптимизации пропускной способности. 

Распространенным примером устройства с отслеживанием состояния является брандмауэр. Брандмауэр разрешает или запрещает прохождение пакетов через свои интерфейсы в зависимости от различных факторов, включая протокол, порт TCP/UDP и URL-заголовки. Такой уровень проверки пакетов многократно увеличивает нагрузку на устройство. Для повышения производительности брандмауэр проверяет первый пакет из потока. Если пакет разрешен, брандмауэр сохраняет информацию о потоке в своей таблице состояний. Разрешение для всех последующих пакетов, связанных с этим потоком, зависит от первоначального решения. Если в брандмауэр поступает пакет, который является частью существующего потока, но в брандмауэре отсутствует информация о предыдущем состоянии этого пакета, брандмауэр удаляет этот пакет.

## <a name="asymmetric-routing-with-expressroute"></a>Асимметричная маршрутизация с помощью ExpressRoute
При подключении к Майкрософт через Azure ExpressRoute в сеть вносятся следующие изменения.

* Существует несколько подключений к Майкрософт. Одно из них — существующее подключение к Интернету, а другое — подключение через ExpressRoute. Часть трафика, направляемого в Майкрософт, может проходить через Интернет, но возвращаться через ExpressRoute, и наоборот.
* Вам присваиваются более конкретные IP-адреса через ExpressRoute. Поэтому для трафика из вашей сети в Microsoft, предназначенного для служб, которые предоставляются через ExpressRoute, маршрутизаторы всегда будут выбирать ExpressRoute.

Чтобы понять влияние этих двух изменений на сеть, давайте рассмотрим несколько сценариев. Например, у вас есть только один канал для Интернета и вы используете все службы Майкрософт через Интернет. Трафик из вашей сети в Майкрософт и обратно проходит через одно и то же интернет-подключение, а также через брандмауэр. Брандмауэр фиксирует поток при обнаружении первого пакета и разрешает обратные пакеты, если поток записан в таблице состояний.

![Асимметричная маршрутизация с помощью ExpressRoute](./media/expressroute-asymmetric-routing/AsymmetricRouting1.png)

Затем включите ExpressRoute для использования служб, предлагаемых корпорацией Майкрософт, через ExpressRoute. Все остальные службы Майкрософт будут и дальше использоваться через Интернет. Разверните отдельный брандмауэр на границе, подключенной к ExpressRoute. Корпорация Майкрософт объявит вашей сети более конкретные префиксы для определенных служб, используемых через ExpressRoute. Инфраструктура маршрутизации выберет ExpressRoute в качестве предпочтительного пути для этих префиксов. Если вы не объявите Майкрософт общедоступные IP-адреса через ExpressRoute, Майкрософт будет взаимодействовать с вашими общедоступными IP-адресами через Интернет. Прямой трафик из вашей сети в Майкрософт будет проходить через ExpressRoute, а обратный трафик из Майкрософт — через Интернет. Когда брандмауэр на границе обнаружит обратный пакет для потока, который отсутствует в таблице состояний, он не пропустит такой обратный трафик.

Если вы решили использовать один и тот же пул преобразования сетевых адресов (NAT) для ExpressRoute и Интернета, вы увидите аналогичные проблемы у клиентов с частными IP-адресами в вашей сети. Запросы для таких служб, как Центр обновления Windows, будут проходить через Интернет, так как IP-адреса для этих служб не объявляются через ExpressRoute. Тем не менее обратный трафик будет проходить через ExpressRoute. Если корпорация Майкрософт получает IP-адрес с одной и той же маской подсети из Интернета и ExpressRoute, предпочтение отдается ExpressRoute. Если брандмауэр или другое устройство с отслеживанием состояния на границе между сетью и ExpressRoute не находит предыдущих сведений о потоке, пакеты из этого потока удаляются.

## <a name="asymmetric-routing-solutions"></a>Решения при асимметричной маршрутизации
Существует два основных способа для решения проблемы асимметричной маршрутизации. Один — с помощью маршрутизации, другой — с помощью преобразования сетевых адресов на основе источника (SNAT).

### <a name="routing"></a>Маршрутизация
Убедитесь, что общедоступные IP-адреса объявляются для соответствующих подключений к глобальной сети (WAN). Например, если вы хотите использовать Интернет для трафика проверки подлинности, а ExpressRoute — для трафика электронной почты, не следует объявлять общедоступные IP-адреса служб федерации Active Directory (AD FS) через ExpressRoute. Точно так же локальный сервер AD FS не должен быть доступным для IP-адресов, которые маршрутизатор получает через ExpressRoute. Маршруты, полученные через ExpressRoute, являются более определенными, поэтому ExpressRoute будет предпочтительным путем для трафика проверки подлинности, направляемого в Майкрософт. Это приведет к асимметричной маршрутизации.

Если вы хотите использовать ExpressRoute для проверки подлинности, убедитесь в том, что общедоступные IP-адреса AD FS объявляются через ExpressRoute без NAT. Таким образом, трафик от Майкрософт к локальному серверу AD FS будет проходить через ExpressRoute. Обратный трафик от клиента к Майкрософт также будет проходить через ExpressRoute, так как этот путь предпочтительнее в сравнении с Интернетом.

### <a name="source-based-nat"></a>NAT на основе источника
Еще один способ решения проблемы асимметричной маршрутизации — SNAT. Например, вы не объявили общедоступный IP-адрес локального SMTP-сервера через ExpressRoute, намереваясь использовать для этого подключения Интернет. Запрос от Майкрософт на ваш локальный SMTP-сервер проходит через Интернет. С помощью SNAT входящий запрос перенаправляется на внутренний IP-адрес. Обратный трафик с SMTP-сервера направляется на пограничный межсетевой экран (используется для выполнения NAT) вместо ExpressRoute. Обратный трафик возвращается через Интернет.

![Конфигурация сети во время SNAT](./media/expressroute-asymmetric-routing/AsymmetricRouting2.png)

## <a name="asymmetric-routing-detection"></a>Обнаружение асимметричной маршрутизации
Лучшим подтверждением того, что сетевой трафик проходит по ожидаемому пути, является трассировка маршрута. Если вы ожидаете, что трафик от вашего локального SMTP-сервера в Майкрософт будет проходить через Интернет, ожидаемым маршрутом при трассировке будет маршрут от SMTP-сервера к Office 365. Ее результат подтвердит, что трафик из вашей сети действительно направляется к Интернету, а не к ExpressRoute.

