---
title: Настройка решения "Монитор производительности сети" каналов ExpressRoute Azure | Документация Майкрософт
description: Настройка сетевого решения мониторинга на основе облака для каналов Azure ExpressRoute.
documentationcenter: na
services: expressroute
author: ajaycode
manager: timlt
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: expressroute
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/14/2018
ms.author: agummadi
ms.openlocfilehash: 0d8bee936717a5668e16fbd66d416fcc4e738814
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32179475"
---
# <a name="configure-network-performance-monitor-for-expressroute"></a>Настройка решения "Монитор производительности сети" для ExpressRoute

"Монитор производительности сети" (NPM) представляет собой сетевое решение мониторинга на основе облака, с помощью которого можно отслеживать подключение между облачными развертываниями Azure и локальными расположениями (филиалами и т. д.). NPM является частью службы Log Analytics. На сегодняшний день NPM предлагает расширение для ExpressRoute, которое позволяет отслеживать производительность сети через каналы ExpressRoute, настроенные для использования частного пиринга. При настройке NPM для ExpressRoute вы можете обнаружить проблемы сети, определить их и устранить.

Вы можете:

* отслеживать потери и задержки в различных виртуальных сетях и настроить оповещения;

* отслеживать все пути (включая избыточные) в сети;

* устранить временные неполадки в сети и неполадки в сети до точки во времени, которые усложняют репликацию;

* определить конкретный сегмент в сети, с которым связана низкая производительность;

* получить пропускную способность для каждой виртуальной сети (при установке агентов в каждой виртуальной сети);

* просмотреть состояние системы ExpressRoute из предыдущей точки во времени.

## <a name="regions"></a>Поддерживаемые регионы

Каналы ExpressRoute в любой части мира можно отслеживать с помощью рабочей области, размещенной в одном из следующих регионов:

* Западная Европа
* Западно-центральная часть США
* Восток США 
* Юго-Восточная Азия 
* Юго-Восточная Австралия

>[!NOTE]
>Поддержку мониторинга каналов ExpressRoute, подключенных к виртуальным сетям в облаке Azure для государственных организаций, планируется добавить во втором квартале 2018 г.   
>

## <a name="workflow"></a>Рабочий процесс

Агенты мониторинга устанавливаются на нескольких серверах, как локально, так и в среде Azure. Они взаимодействуют друг с другом, но отправляют не данные, а пакеты подтверждения TCP. Такое взаимодействие позволяет Azure сопоставить топологию сети и путь передачи трафика.

1. Создайте рабочую область NPM в одном из [поддерживаемых регионов](#regions).
2. Установите и настройте агенты программного обеспечения: 
    * Установите агенты мониторинга на локальных серверах и виртуальных машинах Azure.
    * Настройте параметры на серверах, на которых расположены агенты мониторинга, чтобы разрешить их взаимодействие. (Откройте порты брандмауэра и т. д.).
3. Настройте правила группы безопасности сети (NSG), чтобы разрешить агентам мониторинга, установленным на виртуальных машинах Azure, взаимодействовать с локальными агентами.
4. Настройте мониторинг. Выполните автоматическое обнаружение и определите видимые сети в NPM.

Если вы уже используете решение "Монитор производительности сети" для отслеживания других объектов или служб и у вас есть рабочая область в одном из поддерживаемых регионов, вы можете пропустить шаги 1 и 2 и сразу же приступить к выполнению шага 3.

## <a name="configure"></a>Шаг 1. Создание рабочей области

Создайте рабочую область (в подписке с виртуальной сетью, связанной с каналами ExpressRoute).

1. На [портале Azure](https://portal.azure.com) выберите подписку, которая включает виртуальные сети, подключенные с помощью пиринговой связи к каналу ExpressRoute. Затем найдите в списке служб в **Marketplace** решение "Монитор производительности сети". Щелкните возвращенный результат, чтобы открылась страница **Монитор производительности сети**.

   >[!NOTE]
   >Вы можете создать новую рабочую область или использовать имеющуюся.  Если вы выбрали имеющуюся рабочую область, используйте для нее новый язык запросов. [Дополнительные сведения...](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-search-upgrade)
   >

   ![портал](.\media\how-to-npm\3.png)<br><br>
2. В нижней области главной страницы **Монитор производительности сети** щелкните **Создать**, чтобы открыть страницу **Монитор производительности сети — Создание решения**. Щелкните **Рабочая область OMS — Выберите рабочую область**, чтобы открыть страницу рабочих областей. Щелкните **+ Create New Workspace** (+ Создать рабочую область), чтобы открыть страницу рабочей области.
3. На странице **Рабочая область OMS** выберите **Создание**, а затем настройте параметры ниже:

  * Рабочая область OMS. Введите имя рабочей области.
  * Подписка. Если у вас есть несколько подписок, выберите ту, которую нужно привязать к новой рабочей области.
  * Группа ресурсов. Создайте группу ресурсов или используйте имеющуюся.
  * Расположение — необходимо выбрать [поддерживаемый регион](#regions).
  * Ценовая категория. Выберите "Бесплатный".
  
    >[!NOTE]
    >Канал ExpressRoute может находиться в любой точке мира, не обязательно в том же регионе, что и рабочая область.
    >
  
    ![Рабочая область](.\media\how-to-npm\4.png)<br><br>
4. Нажмите кнопку **ОК**, чтобы сохранить и развернуть шаблон параметров. После проверки шаблона щелкните **Создать**, чтобы развернуть рабочую область.
5. После развертывания рабочей области перейдите в созданный ресурс **NetworkMonitoring(name)**. Проверьте значения параметров, а затем щелкните **Для решения требуется дополнительная настройка**.

   ![дополнительная настройка](.\media\how-to-npm\5.png)

## <a name="agents"></a>Шаг 2. Установка и настройка агентов

### <a name="download"></a>2.1. Скачивание файла установки агента

1. На странице для ресурса **Конфигурация монитора производительности сети** перейдите на вкладку **Общие параметры**. В разделе **Установка агентов OMS** выберите агент, который соответствует процессору сервера, и загрузите файл установки.

 
2. Затем скопируйте **идентификатор рабочего пространства** и **первичный ключ** в Блокнот.
3. В разделе **Настройка агентов OMS для мониторинга по протоколу TCP** загрузите скрипт Powershell. С его помощью вы сможете открыть соответствующий порт брандмауэра для транзакций TCP.

  ![Сценарий PowerShell](.\media\how-to-npm\7.png)

### <a name="installagent"></a>2.2. Установка агента мониторинга на каждом сервере мониторинга (в каждой виртуальной сети, которую нужно отслеживать)

Рекомендуется установить по крайней мере два агента на каждой стороне подключения ExpressRoute (т. е. в локальной среде, виртуальных сетях Azure), чтобы обеспечить избыточность. Чтобы установить агенты, выполните следующие действия.
  
  >[!NOTE]
  >Агент должен быть установлен на компьютере Windows Server 2008 с пакетом обновления 1 (SP1) или более поздней версии. Мониторинг каналов ExpressRoute с помощью ОС Windows Desktop и Linux не поддерживается. 
  >
  >
  
  >[!NOTE]
  >Агенты, отправленные SCOM (включает в себя [MMA](https://technet.microsoft.com/library/dn465154(v=sc.12).aspx)), возможно, не смогут согласованно определить свое расположение, если они размещены в Azure.  Рекомендуется не использовать эти агенты в виртуальных сетях Azure для мониторинга ExpressRoute.
  >
  >

1. Запустите **установку**, чтобы установить агент на каждом сервере, который вы хотите использовать для отслеживания ExpressRoute. Сервером, используемым для мониторинга, может быть виртуальная машина или локальный компьютер с доступом к Интернету. Вам необходимо установить по крайней мере один агент локально, а также по одному агенту для каждого сегмента сети, которые вы хотите отслеживать в Azure.
2. На странице **приветствия** нажмите кнопку **Далее**.
3. На странице **Условия лицензии** прочтите лицензию и нажмите кнопку **Принимаю**.
4. На странице **Destination Folder** (Папка назначения) измените или оставьте папку установки по умолчанию и нажмите кнопку **Далее**.
5. На странице **Параметры установки агента** вы можете выбрать подключение агента к Azure Log Analytics или Operations Manager. Или можете не выбирать эти варианты, если хотите настроить агент позже. Выбрав нужный вариант, нажмите кнопку **Далее**.

  * Если выбрано подключение к **Azure Log Analytics**, вставьте **идентификатор рабочей области** и **ключ рабочей области** (первичный ключ), скопированные в Блокнот на предыдущих шагах. Затем щелкните **Далее**.

    ![Идентификатор и ключ](.\media\how-to-npm\8.png)
  * Если выбрано подключение к **Operations Manager**, на странице **Management Group Configuration** (Конфигурация группы управления) введите **имя группы управления**, **сервер управления** и **порт сервера управления**. Затем щелкните **Далее**.

    ![Operations Manager](.\media\how-to-npm\9.png)
  * На странице **Учетная запись действия агента** выберите **локальную системную** учетную запись или **учетную запись доменного или локального компьютера**. Затем щелкните **Далее**.

    ![Учетная запись.](.\media\how-to-npm\10.png)
6. На странице **Все готово для установки** просмотрите выбранные параметры, а затем щелкните **Установить**.
7. На странице **Настройка успешно завершена** нажмите кнопку **Готово**.
8. После завершения установки на панели управления появится Microsoft Monitoring Agent. Здесь можно просмотреть конфигурацию и проверить, подключен ли агент к Azure Log Analytics (OMS). При подключении агент выдает следующее сообщение: **The Microsoft Monitoring Agent has successfully connected to the Microsoft Operations Management Suite service** (Microsoft Monitoring Agent успешно подключен к службе Microsoft Operations Management Suite).

9. Повторите эти действия для каждой виртуальной сети, которую нужно отслеживать.

### <a name="proxy"></a>2.3. Настройка параметров прокси-сервера (необязательно)

Если вы используете веб-прокси для доступа к Интернету, выполните шаги ниже, чтобы настроить параметры прокси-сервера для Microsoft Monitoring Agent. Эти действия необходимо выполнить для каждого сервера. Если вам нужно настроить несколько серверов, возможно, проще использовать скрипт для автоматизации этого процесса. В таком случае мы рекомендуем ознакомиться с разделом [Как настроить параметры прокси-сервера для Microsoft Monitoring Agent с помощью скрипта](../log-analytics/log-analytics-windows-agent.md).

Чтобы настроить параметры прокси-сервера для Microsoft Monitoring Agent с помощью панели управления, сделайте следующее:

1. Откройте **Панель управления**.
2. Откройте **Microsoft Monitoring Agent**.
3. Перейдите на вкладку **Параметры прокси-сервера**.
4. Установите флажок **Использовать прокси-сервер** и введите URL-адрес и номер порта (если они нужны). Если для доступа к прокси-серверу требуется проверка подлинности, введите имя пользователя и пароль.

  ![proxy](.\media\how-to-npm\11.png)

### <a name="verifyagent"></a>2.4. Проверка подключения к агенту

Вы можете легко проверить, могут ли агенты обмениваться данными.

1. На сервере, на котором установлен агент мониторинга, откройте **панель управления**.
2. Откройте **Microsoft Monitoring Agent**.
3. Откройте вкладку **Azure Log Analytics**.
4. В столбце **Состояние** вы увидите, что агент успешно подключен к Log Analytics.

  ![status](.\media\how-to-npm\12.png)

### <a name="firewall"></a>2.5. Открытие портов брандмауэра на серверах агента мониторинга

Чтобы использовать протокол TCP, необходимо открыть порты брандмауэра, чтобы агенты мониторинга могли обмениваться данными.

Вы можете запустить сценарий PowerShell, который создает разделы реестра, необходимые для решения "Монитор производительности сети", а также создать правила брандмауэра Windows, чтобы разрешить агентам мониторинга создавать TCP-подключения друг к другу. В разделах реестра, созданных сценарием, также нужно указать, следует ли записывать журналы отладки и путь к файлу журнала. Он также определяет TCP-порт агента, используемый для обмена данными. Значения этих реестров автоматически устанавливаются с помощью скрипта, поэтому вам не нужно изменять их вручную.

Открытый порт по умолчанию — 8084. Вы можете использовать пользовательский порт, задав в сценарии параметр portNumber. Тем не менее, если это сделать, необходимо указать один порт для всех серверов, на которых вы запускаете сценарий.

>[!NOTE]
>Сценарий PowerShell "EnableRules" настраивает правила брандмауэра Windows только на том сервере, где он выполняется. При наличии брандмауэра сети он должен разрешать пропуск трафика к TCP-порту, который используется монитором производительности сети.
>
>

На серверах агента откройте окно PowerShell от имени администратора. Запустите загруженный ранее сценарий PowerShell [EnableRules](https://aka.ms/npmpowershellscript). Больше никакие параметры не нужны.

  ![PowerShell_Script](.\media\how-to-npm\script.png)

## <a name="opennsg"></a>Шаг 3. Настройка правил группы безопасности сети

Для серверов агента мониторинга, размещенных в среде Azure, необходимо настроить правила группы безопасности сети (NSG), чтобы разрешить TCP-трафик для порта, используемого NPM для синтетических транзакций. Используемый порт по умолчанию — 8084. Он позволяет агенту мониторинга, установленному на виртуальной машине Azure, обмениваться данными с локальным агентом мониторинга.

Дополнительные сведения о группах безопасности сети см. в статье [Создание групп безопасности сети с помощью портала Azure](../virtual-network/virtual-networks-create-nsg-arm-portal.md).

>[!NOTE]
>Установите агенты (агент на локальном сервере и сервере Azure) и запустите сценарий PowerShell, чтобы продолжить выполнение этого шага.
>
>


## <a name="setupmonitor"></a>Шаг 4. Настройка NPM мониторинга ExpressRoute

После завершения действий из предыдущих разделов можно настроить мониторинг.

1. Перейдите на плитку обзора монитора производительности сети, используя страницу **Все ресурсы**, а затем щелкните рабочую область NPM, добавленную в список разрешений.

  ![рабочая область npm](.\media\how-to-npm\npm.png)
2. Щелкните плитку обзора **Монитор производительности сети**, чтобы открыть панель мониторинга. Она будет содержать страницу ExpressRoute, на которой будет указано состояние ExpressRoute "Не настроено". Щелкните **Настройка функций**, чтобы открыть страницу конфигурации монитора производительности сети.

  ![настройка функций](.\media\how-to-npm\npm2.png)
3. На странице конфигурации перейдите на вкладку "Пиринги ExpressRoute", расположенную на панели слева. Нажмите кнопку **Провести обнаружение**.

  ![обнаружение](.\media\how-to-npm\13.png)
4. После обнаружения появятся правила для уникального имени канала и виртуальной сети. Изначально эти правила отключены. Включите их, затем выберите агенты мониторинга и пороговые значения.

  ![правила](.\media\how-to-npm\14.png)
5. После включения правил и выбора значений и агентов мониторинга необходимо подождать около 30–60 минут до заполнения значений. В течение этого времени также станут доступны плитки **мониторинга ExpressRoute**. Как только вы увидите плитки мониторинга, NPM начнет отслеживать каналы ExpressRoute и ресурсы подключения.

  ![плитки мониторинга](.\media\how-to-npm\15.png)

## <a name="explore"></a>Шаг 5. Просмотр плиток мониторинга

### <a name="dashboard"></a>Страница решения "Монитор производительности сети"

Страница NPM содержит страницу для ExpressRoute, на которой отображаются общие данные по работоспособности каналов ExpressRoute и пирингов.

  ![панель мониторинга](.\media\how-to-npm\dashboard.png)

### <a name="circuits"></a>Список каналов

Чтобы просмотреть список всех отслеживаемых каналов ExpressRoute, щелкните плитку **Цепи ExpressRoute**. Вы можете выбрать канал и просмотреть его состояние работоспособности, диаграммы тенденций потери пакетов, данные об использовании пропускной способности и задержке. Диаграммы интерактивны. Вы можете выбрать настраиваемое временное окно для построения диаграмм. Вы можете перетащить указатель мыши по области диаграммы, чтобы увеличить масштаб и увидеть мелкие фрагменты данных.

  ![circuit_list](.\media\how-to-npm\circuits.png)

#### <a name="trend"></a>Тенденции потерь, задержка и пропускная способность

Диаграммы потерь, задержки и пропускной способности интерактивны. С помощью мыши вы можете увеличить любой фрагмент этих диаграмм. Вы также можете просмотреть данные о потерях, задержке и пропускной способности для других интервалов. Для этого щелкните параметр **Дата и время**, расположенный под кнопкой "Действия" в левом верхнем углу.

![тенденции](.\media\how-to-npm\16.png)

### <a name="peerings"></a>Список пирингов

Если вы щелкните плитку **Частные пиринги** на панели мониторинга, откроется список всех подключений к виртуальным сетям через частный пиринг. Здесь вы можете выбрать подключение виртуальной сети и просмотреть его состояние работоспособности, диаграммы тенденций потери пакетов, данные об использовании пропускной способности и задержке.

  ![список каналов](.\media\how-to-npm\peerings.png)

### <a name="topology"></a>Топология канала

Чтобы просмотреть топологию канала, щелкните плитку **Топология**. Откроется представление топологии выбранного канала или пиринга. На схеме топологии будет отображаться задержка для каждого сегмента сети, а с помощью узла схемы можно увидеть число скачков для каждого уровня. Чтобы увидеть дополнительные сведения о скачке, необходимо его щелкнуть.
Вы можете увеличить уровень видимости, чтобы включить локальные скачки. Для этого необходимо переместить ползунок ниже параметра **Фильтры**. Перемещая ползунок влево или вправо, вы соответственно увеличиваете или уменьшаете количество скачков на схеме топологии. Видна задержка для каждого сегмента, что позволяет быстро изолировать соответствующие сегменты.

![filters](.\media\how-to-npm\topology.png)

#### <a name="detailed-topology-view-of-a-circuit"></a>Подробное представление топологии канала

В этом представлении отображаются подключения виртуальных сетей.
![подробная топология](.\media\how-to-npm\17.png)
