---
title: "Настройка решения \"Монитор производительности сети\" каналов ExpressRoute Azure (предварительная версия) | Документация Майкрософт"
description: "Настройка NPM каналов Azure ExpressRoute. (предварительная версия)"
documentationcenter: na
services: expressroute
author: cherylmc
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 
ms.service: expressroute
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/01/2017
ms.author: cherylmc
ms.openlocfilehash: aff54b86da6a8a062a3f1c76aa69e32c60008274
ms.sourcegitcommit: d41d9049625a7c9fc186ef721b8df4feeb28215f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/02/2017
---
# <a name="configure-network-performance-monitor-for-expressroute-preview"></a>Настройка решения "Монитор производительности сети" для ExpressRoute (предварительная версия)

"Монитор производительности сети" (NPM) представляет собой сетевое решение мониторинга на основе облака, с помощью которого можно отслеживать подключение между облачными развертываниями Azure и локальными расположениями (филиалами и т. д.). NPM является частью Microsoft Operations Management Suite (OMS). На сегодняшний день NPM предлагает расширение для ExpressRoute, которое позволяет отслеживать производительность сети через каналы ExpressRoute, настроенные для использования частного пиринга. При настройке NPM для ExpressRoute вы можете обнаружить проблемы сети, определить их и устранить.

Вы можете:

* отслеживать потери и задержки в различных виртуальных сетях и настроить оповещения;

* отслеживать все пути (включая избыточные) в сети;

* устранить временные неполадки в сети и неполадки в сети до точки во времени, которые усложняют репликацию;

* определить конкретный сегмент в сети, с которым связана низкая производительность;

* получить пропускную способность для каждой виртуальной сети (при установке агентов в каждой виртуальной сети);

* просмотреть состояние системы ExpressRoute из предыдущей точки во времени.

**Как это работает?**

Агенты мониторинга устанавливаются на нескольких серверах, как локально, так и в среде Azure. Они взаимодействуют друг с другом, но отправляют не данные, а пакеты подтверждения TCP. Такое взаимодействие позволяет Azure сопоставить топологию сети и путь передачи трафика.

**Workflow**

1. Создайте рабочую область NPM в регионе "Западно-центральная часть США". В настоящее время это единственный регион, где поддерживается эта предварительная версия.
2. Установите и настройте агенты программного обеспечения: 
    * Установите агенты мониторинга на локальных серверах и виртуальных машинах Azure.
    * Настройте параметры на серверах, на которых расположены агенты мониторинга, чтобы разрешить их взаимодействие. (Откройте порты брандмауэра и т. д.).
3. Настройте правила группы безопасности сети (NSG), чтобы разрешить агентам мониторинга, установленным на виртуальных машинах Azure, взаимодействовать с локальными агентами.
4. Отправьте запрос, чтобы включить рабочую область NPM в список разрешений.
5. Настройте мониторинг. Выполните автоматическое обнаружение и определите видимые сети в NPM.

Если вы уже используете решения "Монитор производительности сети" для отслеживания других объектов или служб и у вас имеется рабочая область в регионе "Западно-центральная часть США", вы можете пропустить шаги 1 и 2 и сразу же приступить к выполнению шага 3.

## <a name="configure"></a>Шаг 1. Создание рабочей области

1. На [портале Azure](https://portal.azure.com) найдите в списке служб в **Marketplace** решения "Монитор производительности сети". Щелкните возвращенный результат, чтобы открылась страница **Монитор производительности сети**.

  ![портал](.\media\how-to-npm\3.png)<br><br>
2. В нижней области главной страницы **Монитор производительности сети** щелкните **Создать**, чтобы открыть страницу **Монитор производительности сети — Создание решения**. Щелкните **Рабочая область OMS — Выберите рабочую область**, чтобы открыть страницу рабочих областей. Щелкните **+ Create New Workspace** (+ Создать рабочую область), чтобы открыть страницу рабочей области.
3. На странице **Рабочая область OMS** выберите **Создание**, а затем настройте параметры ниже:

  * Рабочая область OMS. Введите имя рабочей области.
  * Подписка. Если у вас есть несколько подписок, выберите ту, которую нужно привязать к новой рабочей области.
  * Группа ресурсов. Создайте группу ресурсов или используйте имеющуюся.
  * Расположение. Для этой предварительной версии выберите "Западно-центральная часть США".
  * Ценовая категория. Выберите "Бесплатный".

  ![Рабочая область](.\media\how-to-npm\4.png)<br><br>
4. Нажмите кнопку **ОК**, чтобы сохранить и развернуть шаблон параметров. После проверки шаблона щелкните **Создать**, чтобы развернуть рабочую область.
5. После развертывания рабочей области перейдите в созданный ресурс **NetworkMonitoring(name)**. Проверьте значения параметров, а затем щелкните **Для решения требуется дополнительная настройка**.

  ![дополнительная настройка](.\media\how-to-npm\5.png)
6. На странице **Вас приветствует монитор производительности сети** выберите **Use TCP for synthetic transactions** (Использовать TCP для синтетических транзакций), а затем нажмите кнопку **Отправить**. Транзакции TCP используются только для установки подключения и отключения. Данные через эти TCP-подключения не отправляются.

  ![TCP для синтетических транзакций](.\media\how-to-npm\6.png)

## <a name="agents"></a>Шаг 2. Установка и настройка агентов

### <a name="download"></a>2.1. Скачивание файла установки агента

1. На странице **Конфигурация монитора производительности сети — Настройка TCP** для ресурса в разделе **установки агентов OMS** щелкните агент, который соответствует процессору сервера, и скачайте файл установки.

  >[!NOTE]
  >Агент для Linux в настоящее время не поддерживается для мониторинга ExpressRoute.
  >
  >
2. Затем скопируйте и вставьте **идентификатор рабочего пространства** и **первичный ключ** в Блокнот.
3. Скачайте сценарий Powershell в разделе **Настроить агенты**. С его помощью вы сможете открыть соответствующий порт брандмауэра для транзакций TCP.

  ![Сценарий PowerShell](.\media\how-to-npm\7.png)

### <a name="installagent"></a>2.2. Установка агента мониторинга на каждом сервере мониторинга

1. Запустите **установку**, чтобы установить агент на каждом сервере, который вы хотите использовать для отслеживания ExpressRoute. Сервером, используемым для мониторинга, может быть виртуальная машина или локальный компьютер с доступом к Интернету. Вам необходимо установить по крайней мере один агент локально, а также по одному агенту для каждого сегмента сети, которые вы хотите отслеживать в Azure.
2. На странице **приветствия** нажмите кнопку **Далее**.
3. На странице **Условия лицензии** прочтите лицензию и нажмите кнопку **Принимаю**.
4. На странице **Destination Folder** (Папка назначения) измените или оставьте папку установки по умолчанию и нажмите кнопку **Далее**.
5. На странице **Agent Setup Options** (Параметры установки агента) вы можете выбрать подключение агента к Azure Log Analytics (OMS) или Operations Manager. Или можете не выбирать эти варианты, если хотите настроить агент позже. Выбрав нужный вариант, нажмите кнопку **Далее**.

  * Если выбрано подключение к **Azure Log Analytics (OMS)**, вставьте **идентификатор рабочей области** и **ключ рабочей области** (первичный ключ), скопированные в Блокнот на предыдущих шагах. Затем щелкните **Далее**.

    ![Идентификатор и ключ](.\media\how-to-npm\8.png)
  * Если выбрано подключение к **Operations Manager**, на странице **Management Group Configuration** (Конфигурация группы управления) введите **имя группы управления**, **сервер управления** и **порт сервера управления**. Затем щелкните **Далее**.

    ![Operations Manager](.\media\how-to-npm\9.png)
  * На странице **Учетная запись действия агента** выберите **локальную системную** учетную запись или **учетную запись доменного или локального компьютера**. Затем щелкните **Далее**.

    ![Учетная запись.](.\media\how-to-npm\10.png)
6. На странице **Все готово для установки** просмотрите выбранные параметры, а затем щелкните **Установить**.
7. На странице **Настройка успешно завершена** нажмите кнопку **Готово**.
8. После завершения установки на панели управления появится Microsoft Monitoring Agent. Здесь можно просмотреть конфигурацию и проверить, подключен ли агент к Operational Insights (OMS). При подключении к OMS агент выдает следующее сообщение: **Microsoft Monitoring Agent успешно подключен к службе Microsoft Operations Management Suite.**

### <a name="proxy"></a>2.3. Настройка параметров прокси-сервера (необязательно)

Если вы используете веб-прокси для доступа к Интернету, выполните шаги ниже, чтобы настроить параметры прокси-сервера для Microsoft Monitoring Agent. Эти действия необходимо выполнить для каждого сервера. Если вам нужно настроить несколько серверов, возможно, проще использовать скрипт для автоматизации этого процесса. В таком случае мы рекомендуем ознакомиться с разделом [Как настроить параметры прокси-сервера для Microsoft Monitoring Agent с помощью скрипта](../log-analytics/log-analytics-windows-agents.md#to-configure-proxy-settings-for-the-microsoft-monitoring-agent-using-a-script).

Чтобы настроить параметры прокси-сервера для Microsoft Monitoring Agent с помощью панели управления, сделайте следующее:

1. Откройте **Панель управления**.
2. Откройте **Microsoft Monitoring Agent**.
3. Перейдите на вкладку **Параметры прокси-сервера**.
4. Установите флажок **Использовать прокси-сервер** и введите URL-адрес и номер порта (если они нужны). Если для доступа к прокси-серверу требуется проверка подлинности, введите имя пользователя и пароль.

  ![proxy](.\media\how-to-npm\11.png)

### <a name="verifyagent"></a>2.4. Проверка подключения к агенту

Вы можете легко проверить, могут ли агенты обмениваться данными.

1. На сервере, на котором установлен агент мониторинга, откройте **панель управления**.
2. Откройте **Microsoft Monitoring Agent**.
3. Перейдите на вкладку **Azure Log Analytics (OMS)**.
4. В столбце **Состояние** вы увидите, что агент успешно подключен к службе Operations Management Suite.

  ![status](.\media\how-to-npm\12.png)

### <a name="firewall"></a>2.5. Открытие портов брандмауэра на серверах агента мониторинга

Чтобы использовать протокол TCP, необходимо открыть порты брандмауэра, чтобы агенты мониторинга могли обмениваться данными.

Вы можете запустить сценарий PowerShell, который создает разделы реестра, необходимые для решения "Монитор производительности сети", а также создать правила брандмауэра Windows, чтобы разрешить агентам мониторинга создавать TCP-подключения друг к другу. В разделах реестра, созданных сценарием, также нужно указать, следует ли записывать журналы отладки и путь к файлу журнала. Он также определяет TCP-порт агента, используемый для обмена данными. Значения этих реестров автоматически устанавливаются с помощью скрипта, поэтому вам не нужно изменять их вручную.

Открытый порт по умолчанию — 8084. Вы можете использовать пользовательский порт, задав в сценарии параметр portNumber. Тем не менее, если это сделать, необходимо указать один порт для всех серверов, на которых вы запускаете сценарий.

>[!NOTE]
>Сценарий PowerShell "EnableRules" настраивает правила брандмауэра Windows только на том сервере, где он выполняется. При наличии брандмауэра сети он должен разрешать пропуск трафика к TCP-порту, который используется монитором производительности сети.
>
>

На серверах агента откройте окно PowerShell от имени администратора. Запустите загруженный ранее сценарий PowerShell [EnableRules](https://gallery.technet.microsoft.com/OMS-Network-Performance-04a66634). Больше никакие параметры не нужны.

  ![PowerShell_Script](.\media\how-to-npm\script.png)

## <a name="opennsg"></a>Шаг 3. Настройка правил группы безопасности сети

Для серверов агента мониторинга, размещенных в среде Azure, необходимо настроить правила группы безопасности сети (NSG), чтобы разрешить TCP-трафик для порта, используемого NPM для синтетических транзакций. Используемый порт по умолчанию — 8084. Он позволяет агенту мониторинга, установленному на виртуальной машине Azure, обмениваться данными с локальным агентом мониторинга.

Дополнительные сведения о группах безопасности сети см. в статье [Создание групп безопасности сети с помощью портала Azure](../virtual-network/virtual-networks-create-nsg-arm-portal.md).

## <a name="whitelist"></a>Шаг 4. Запрос для включения рабочей области в список разрешений

>[!NOTE]
>Установите агенты (агент на локальном сервере и сервере Azure) и запустите сценарий PowerShell, чтобы продолжить выполнение этого шага.
>
>

Перед тем, как начать использовать функцию мониторинга ExpressRoute NPM, отправьте запрос, чтобы включить рабочую область в список разрешений. [Щелкните здесь, чтобы перейти на страницу заполнения формы запроса](https://go.microsoft.com/fwlink/?linkid=862263). (Совет. Вы можете открыть эту ссылку в новом окне или вкладке). Процесс добавления в список разрешений может занять не менее одного рабочего дня. После включения рабочей области в список разрешений мы отправим вам уведомление на электронную почту.


## <a name="setupmonitor"></a>Шаг 5. Настройка NPM мониторинга ExpressRoute

>[!WARNING]
>Приступите к выполнению этого шага только после того, как ваша рабочая область будет добавлена в список разрешений и вы получите подтверждение по электронной почте.
>
>

Выполнив шаги, описанные в разделах выше, и добавив рабочие области в список разрешений, вы можете приступить к настройке мониторинга.

1. Перейдите на плитку обзора монитора производительности сети, используя страницу **Все ресурсы**, а затем щелкните рабочую область NPM, добавленную в список разрешений.

  ![рабочая область npm](.\media\how-to-npm\npm.png)
2. Щелкните плитку обзора **Монитор производительности сети**, чтобы открыть панель мониторинга. Она будет содержать страницу ExpressRoute, на которой будет указано состояние ExpressRoute "Не настроено". Щелкните **Настройка функций**, чтобы открыть страницу конфигурации монитора производительности сети.

  ![настройка функций](.\media\how-to-npm\npm2.png)
3. На странице конфигурации перейдите на вкладку "Пиринги ExpressRoute", расположенную на панели слева. Нажмите кнопку **Провести обнаружение**.

  ![обнаружение](.\media\how-to-npm\13.png)
4. После обнаружения появятся правила для уникального имени канала и виртуальной сети. Изначально эти правила отключены. Вам необходимо их включить, затем выбрать агенты мониторинга и пороговые значения.

  ![правила](.\media\how-to-npm\14.png)
5. После включения правил и выбора значений и агентов мониторинга необходимо подождать около 30–60 минут до заполнения значений. В течение этого времени также станут доступны плитки **мониторинга ExpressRoute**. Как только вы увидите плитки мониторинга, NPM начнет отслеживать каналы ExpressRoute и ресурсы подключения.

  ![плитки мониторинга](.\media\how-to-npm\15.png)

## <a name="explore"></a>Шаг 6. Просмотр плиток мониторинга

### <a name="dashboard"></a>Страница решения "Монитор производительности сети"

Страница NPM содержит страницу для ExpressRoute, на которой отображаются общие данные по работоспособности каналов ExpressRoute и пирингов.

  ![Панель мониторинга](.\media\how-to-npm\dashboard.png)

### <a name="circuits"></a>Список каналов

Чтобы просмотреть список всех отслеживаемых каналов ExpressRoute, щелкните плитку **Цепи ExpressRoute**. Вы можете выбрать канал и просмотреть его состояние работоспособности, диаграммы тенденций потери пакетов, данные об использовании пропускной способности и задержке. Диаграммы интерактивны. Вы можете выбрать настраиваемое временное окно для построения диаграмм. Вы можете перетащить указатель мыши по области диаграммы, чтобы увеличить масштаб и увидеть мелкие фрагменты данных.

  ![circuit_list](.\media\how-to-npm\circuits.png)

#### <a name="trend"></a>Тенденции потерь, задержка и пропускная способность

Диаграммы потерь, задержки и пропускной способности интерактивны. С помощью мыши вы можете увеличить любой фрагмент этих диаграмм. Вы также можете просмотреть данные о потерях, задержке и пропускной способности для других интервалов. Для этого щелкните параметр **Дата и время**, расположенный под кнопкой "Действия" в левом верхнем углу.

![тенденции](.\media\how-to-npm\16.png)

### <a name="peerings"></a>Список пирингов

Если вы щелкните плитку **Частные пиринги** на панели мониторинга, откроется список всех подключений к виртуальным сетям через частный пиринг. Здесь вы можете выбрать подключение виртуальной сети и просмотреть его состояние работоспособности, диаграммы тенденций потери пакетов, данные об использовании пропускной способности и задержке.

  ![список каналов](.\media\how-to-npm\peerings.png)

### <a name="topology"></a>Топология канала

Чтобы просмотреть топологию канала, щелкните плитку **Топология**. Откроется представление топологии выбранного канала или пиринга. На схеме топологии будет отображаться задержка для каждого сегмента сети, а с помощью узла схемы можно увидеть число скачков для каждого уровня. Чтобы увидеть дополнительные сведения о скачке, необходимо его щелкнуть.
Вы можете увеличить уровень видимости, чтобы включить локальные скачки. Для этого необходимо переместить ползунок ниже параметра **Фильтры**. Перемещая ползунок влево или вправо, вы соответственно увеличиваете или уменьшаете количество скачков на схеме топологии. Видна задержка для каждого сегмента, что позволяет быстро изолировать соответствующие сегменты.

![filters](.\media\how-to-npm\topology.png)

#### <a name="detailed-topology-view-of-a-particular-expressroute-circuit---with-vnet-connections"></a>Представление подробной топологии определенного канала ExpressRoute с подключениями к виртуальной сети

![подробная топология](.\media\how-to-npm\17.png)
