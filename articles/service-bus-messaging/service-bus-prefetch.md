---
title: Предварительная выборка сообщений служебной шины Azure | Документация Майкрософт
description: Повышение производительности с помощью предварительной выборки сообщений служебной шины Azure.
services: service-bus-messaging
documentationcenter: ''
author: clemensv
manager: timlt
editor: ''
ms.service: service-bus-messaging
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/30/2018
ms.author: sethm
ms.openlocfilehash: 0a61918108a48f4a9fa3d1c07cc8d41525f1f2a0
ms.sourcegitcommit: 9d317dabf4a5cca13308c50a10349af0e72e1b7e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2018
ms.locfileid: "28928167"
---
# <a name="prefetch-azure-service-bus-messages"></a>Предварительная выборка сообщений служебной шины Azure

Когда *предварительная выборка* включена в каком-либо из официальных клиентов служебной шины, получатель автоматически получает поступающие сообщений, пока не достигает ограничения [PrefetchCount](/dotnet/api/microsoft.azure.servicebus.queueclient.prefetchcount#Microsoft_Azure_ServiceBus_QueueClient_PrefetchCount) и не превышает объем, изначально запрошенный приложением.

Поэтому отдельный вызов [Receive](/dotnet/api/microsoft.servicebus.messaging.queueclient.receive) или [ReceiveAsync](/dotnet/api/microsoft.azure.servicebus.core.messagereceiver.receiveasync) получает сообщение для немедленного использования, которое возвращается как можно быстрее в качестве доступного сообщения. Затем клиент получает последующие сообщения в фоновом режиме, чтобы заполнить буфер предварительной выборки.

## <a name="enable-prefetch"></a>Включение предварительной выборки

Чтобы включить функцию предварительной выборки в .NET, необходимо для свойства [PrefetchCount](/dotnet/api/microsoft.azure.servicebus.queueclient.prefetchcount#Microsoft_Azure_ServiceBus_QueueClient_PrefetchCount) объекта **MessageReceiver**, **QueueClient** или **SubscriptionClient** задать число больше нуля. Если задать для этого свойства ноль, то предварительная выборка будет отключена.

Этот параметр можно легко добавить в параметры принимающей стороны примеров [QueuesGettingStarted](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/QueuesGettingStarted) или [ReceiveLoop](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/ReceiveLoop), чтобы увидеть результат в этих контекстах.

Пока сообщения находятся в буфере предварительной выборки, любые последующие вызовы **Receive**/**ReceiveAsync** выполняются немедленно из буфера, и буфер пополняется в фоновом режиме, как только в нем освобождается место. Если нет доступных для доставки сообщений, операция получения очищает буфер, после чего ожидает сообщения или блокируется, в соответствии с заданной логикой.

Предварительная выборка точно так же работает с интерфейсами API [OnMessage](/dotnet/api/microsoft.servicebus.messaging.queueclient.onmessage) и [OnMessageAsync](/dotnet/api/microsoft.servicebus.messaging.queueclient.onmessageasync).

## <a name="if-it-is-faster-why-is-prefetch-not-the-default-option"></a>Если предварительная выборка повышает производительность, почему она не используется по умолчанию?

Предварительная выборка ускоряет поток обработки сообщений, подготавливая сообщения для локального получения до того, как приложение их запросит. Это повышение пропускной способности является результатом компромисса, который на разработчик приложения должен пойти явным образом.

В режиме получения [ReceiveAndDelete](/dotnet/api/microsoft.azure.servicebus.receivemode.receiveanddelete) все сообщения, полученные в буфер предварительной выборки, уже недоступны в очереди. Они хранятся только в буфере предварительной выборки в памяти, пока не будут получены приложением с помощью интерфейса API **Receive**/**ReceiveAsync** или **OnMessage**/**OnMessageAsync**. Если приложение завершает работу до получения сообщений, эти сообщения безвозвратно теряются.

В режиме получения [PeekLock](/dotnet/api/microsoft.azure.servicebus.receivemode.peeklock) сообщения, переданные в буфер предварительной выборки, поступают в него в заблокированном состоянии с заданным временем ожидания блокировки. Если буфер предварительной выборки большой и обработка занимает так много времени, что срок блокировки сообщения истекает, пока оно находится в буфере предварительной выборки, или даже во время обработки сообщения приложением, то возможно возникновение событий, обработать которые приложению будет затруднительно.

Приложение может получить сообщение с просроченной или практически просроченной блокировкой. В этом случае приложение может обработать сообщение, но затем обнаружить, что обработку невозможно завершить из-за истечения срока блокировки. Приложение может проверить свойство [LockedUntilUtc](/dotnet/api/microsoft.azure.servicebus.core.messagereceiver.lockeduntilutc#Microsoft_Azure_ServiceBus_Core_MessageReceiver_LockedUntilUtc) (которое учитывает рассинхронизацию часов между брокером и локальным компьютером). Если срок блокировки сообщения истек, то приложение должно игнорировать это сообщение, и вызов API для сообщения или с его участием не выполняется. Если срок действия сообщения не истек, но приближается к этому, блокировку можно продлить еще на один период блокировки по умолчанию, вызвав [message.RenewLock()](/dotnet/api/microsoft.azure.servicebus.core.messagereceiver.renewlockasync#Microsoft_Azure_ServiceBus_Core_MessageReceiver_RenewLockAsync_System_String_).

Если срок блокировки автоматически истекает в буфере предварительной выборки, то сообщение считается отброшенным и снова становится доступным для получения из очереди. Это может привести к его извлечению в самый конец буфера предварительной выборки. Если буфер предварительной выборки не позволяет обрабатывать просроченные сообщения, это может привести к тому, что сообщения будут многократно извлекаться в предварительной выборки буфер, но никогда не будут доставлены в пригодном к использованию (надлежащим образом заблокированном) состоянии. В итоге, как только будет превышено максимальное число доставок, они будут перемещены в очередь недоставленных сообщений.

Если необходимо обеспечить высокий уровень надежности при обработке сообщений, и обработка требует значительного объема работы и времени, рекомендуется умеренно использовать функцию предварительной выборки или вообще ее не использовать.

Если требуется большая пропускная способность, а обработка сообщений не требует больших затрат, то предварительная выборка позволяет значительно повысить пропускную способность.

Максимальное число сообщений и длительность блокировки при предварительной выборке, настроенные для очереди или подписки, необходимо сбалансировать таким образом, чтобы время ожидания блокировки по крайней мере превышало общее ожидаемое время обработки сообщений при максимальном заполнении буфера предварительной выборки плюс одно сообщение. Вместе с тем время ожидания блокировки сообщений вовсе не должно превышать их максимальное значение [TimeToLive](/dotnet/api/microsoft.azure.servicebus.message.timetolive#Microsoft_Azure_ServiceBus_Message_TimeToLive) в случае, если они случайно удаляются, так как иначе перед их повторной доставкой придется ожидать истечения срока их блокировки.

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Базовая информация о служебной шине](service-bus-fundamentals-hybrid-solutions.md)
* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)
