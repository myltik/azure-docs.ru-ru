---
title: Срок действия сообщений служебной шины Azure | Документация Майкрософт
description: Истечение срока действия и срок жизни сообщений служебной шины Azure.
services: service-bus-messaging
documentationcenter: ''
author: clemensv
manager: timlt
editor: ''
ms.service: service-bus-messaging
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/26/2018
ms.author: sethm
ms.openlocfilehash: 6e1f6177ccacf24955763982189bcdb1ef69c788
ms.sourcegitcommit: ded74961ef7d1df2ef8ffbcd13eeea0f4aaa3219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2018
ms.locfileid: "28196774"
---
# <a name="message-expiration-time-to-live"></a>Срок действия сообщения (срок жизни)

Полезные данные в сообщении, команда или запрос, который сообщение передает получателю, почти всегда обусловлены какого-либо вида сроком действия на уровне приложения. По прошествии данного крайнего срока содержимое уже не доставляется или не выполняется запрошенная операция.

Для среды разработки и тестовой среды, в которых очереди и разделы часто используются в контексте частичного запуска приложений или частей приложений, желательно также выполнять автоматическую сборку мусора для удаления потерянных тестовых сообщений, чтобы следующий тест можно было выполнить "с чистого листа".

Истечением срока действия любого отдельного сообщения можно управлять, задав системное свойство [TimeToLive](/dotnet/api/microsoft.azure.servicebus.message.timetolive#Microsoft_Azure_ServiceBus_Message_TimeToLive), которое указывает относительный срок. Срок действия истекает мгновенно, когда сообщение помещается в очередь в сущности. В этот момент свойство [ExpiresAtUtc](/dotnet/api/microsoft.azure.servicebus.message.expiresatutc) принимает значение [**(EnqueuedTimeUtc**](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedtimeutc#Microsoft_ServiceBus_Messaging_BrokeredMessage_EnqueuedTimeUtc) + [**TimeToLive**)](/dotnet/api/microsoft.azure.servicebus.message.timetolive#Microsoft_Azure_ServiceBus_Message_TimeToLive).

После того, как момент **ExpiresAtUtc** пройдет, сообщения станут недоступными для получения. Срок действия не влияет на сообщения, доставка которых в настоящий момент заблокирована. Эти сообщения по-прежнему обрабатываются обычным образом. Если срок действия блокировки истекает или сообщение отбрасывается, его срок действия вступает в силу немедленно.

Во время блокировки сообщения приложение может посчитать, что его срок действия истек. Будет ли приложение обрабатывать это сообщение или отбросит его, определяется разработчиком.

## <a name="entity-level-expiration"></a>Срок действия уровня сущности

Для всех сообщений, отправленных в очередь или раздел, применяется срок действия по умолчанию, который задается на уровне сущности с помощью свойства [defaultMessageTimeToLive](/azure/templates/microsoft.servicebus/namespaces/queues). Его можно также указать на портале во время создания и затем изменить. Срок действия по умолчанию используется для всех сообщений, отправленных в сущность, для которой значение [TimeToLive](/dotnet/api/microsoft.azure.servicebus.message.timetolive#Microsoft_Azure_ServiceBus_Message_TimeToLive) не задано явным образом. Срок действия по умолчанию задает максимальное значение для **TimeToLive**. Для сообщений, значение **TimeToLive** которых превышает срок действия по умолчанию, автоматически применяется значение **defaultMessageTimeToLive**, прежде чем они попадают в очередь.

Просроченные сообщения при необходимости можно переместить в [очередь недоставленных сообщений](service-bus-dead-letter-queues.md), задав свойство [EnableDeadLetteringOnMessageExpiration](/dotnet/api/microsoft.servicebus.messaging.queuedescription.enabledeadletteringonmessageexpiration#Microsoft_ServiceBus_Messaging_QueueDescription_EnableDeadLetteringOnMessageExpiration) или установив соответствующий флажок на портале. Если этот параметр оставить отключенным, то просроченные сообщения будут удаляться. Просроченные сообщения, перемещенные в очередь недоставленных сообщений, можно отличить от других недоставленных сообщений, оценивая свойство [DeadletterReason](service-bus-dead-letter-queues.md#moving-messages-to-the-dlq), которое брокер сохраняет в разделе свойств пользователя. В данном случае оно имеет значение [TTLExpiredException](service-bus-dead-letter-queues.md#moving-messages-to-the-dlq).

В упомянутом выше случае, в котором сообщение защищено от истечения срока действия благодаря блокировке, если для сущности установлен соответствующий флаг, то это сообщение автоматически перемещается в очередь недоставленных сообщений после того, как блокировка будет снята или истечет срок ее действия. Однако оно не перемещается в эту очередь, если сообщение успешно согласовано, после чего предполагается, что приложение успешно его обработало, несмотря на то, что номинально его срок действия истек.

Сочетание [TimeToLive](/dotnet/api/microsoft.azure.servicebus.message.timetolive#Microsoft_Azure_ServiceBus_Message_TimeToLive) и автоматического (и транзакционного) перемещения в очередь недоставленных сообщений по истечении срока действия — ценный инструмент, позволяющий гарантировать, что задание с крайним сроком, переданное обработчику или группе обработчиков, будет получено для обработки к этому крайнему сроку.

Для примера рассмотрим веб-сайт, который должен надежно выполнять задания в серверной части с ограниченными возможностями масштабирования и который иногда подвержен скачкам трафика или должен быть независимым от доступности этой серверной части. В обычном случае обработчик на стороне сервера, предназначенный для отправленных данных пользователя, передает информацию в очередь и затем получает ответ, подтверждающий успешную обработку транзакций в очереди ответов. Если происходит скачок трафика и внутренний обработчик не может обработать свои элементы невыполненной работы вовремя, то просроченные задания возвращаются в очередь недоставленных сообщений. Текущий пользователь может быть оповещен о том, что запрошенная операция займет немного больше времени, чем обычно, и что затем запрос можно будет поместить в другую очередь для обработки. В итоге результат обработки отправляется пользователю по электронной почте. 

## <a name="temporary-entities"></a>Временные сущности

Очереди, разделы и подписки служебной шины могут создаваться как временные сущности, которые автоматически удаляются, если не используются в течение указанного периода времени.
 
Автоматическая очистка удобна в сценариях разработки и тестирования, в которых создаются динамически сущности, которые не очищаются после использования из-за прерывания цикла тестирования или отладки. Ее также удобно использовать, когда приложение создает динамические сущности, такие как очередь ответов, для получения ответов процессом веб-сервера или в другим объектом с относительно небольшим временем существования. После того, как экземпляр объекта исчезает, надежно очищать эти сущности сложно.

Эта функция включается с помощью свойства [autoDeleteOnIdle](/azure/templates/microsoft.servicebus/namespaces/queues), в котором задается длительность простоя сущности (время, в течение которого она не используется), прежде чем она автоматически удаляется. Минимальная длительность составляет 5 минут.
 
Свойство **autoDeleteOnIdle** должно быть установлено посредством операции Azure Resource Manager или с помощью интерфейсов API [NamespaceManager](/dotnet/api/microsoft.servicebus.namespacemanager) клиента .NET Framework. Его нельзя установить на портале.


## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Базовая информация о служебной шине](service-bus-fundamentals-hybrid-solutions.md)
* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)