---
title: Использование управляемого удостоверения службы со служебной шиной Azure (предварительная версия) | Документация Майкрософт
description: Использование удостоверений управляемой службы со служебной шиной Azure
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: ''
ms.assetid: ''
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 12/19/2017
ms.author: sethm
ms.openlocfilehash: 7b9901ee3478cb193c808b65d2dbbcf8b596a3c1
ms.sourcegitcommit: a0be2dc237d30b7f79914e8adfb85299571374ec
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2018
ms.locfileid: "29874658"
---
# <a name="managed-service-identity-preview"></a>Управляемые удостоверения службы (предварительная версия)

Управляемые удостоверения службы (MSI) — это функция Azure, которая позволяет создавать удостоверения безопасности, связанные с развертыванием, в рамках которого выполняется код приложения. Затем можно связать этот идентификатор с ролями управления доступом, предоставляющими настраиваемые разрешения для доступа к определенным ресурсам Azure, необходимым приложению.

С помощью MSI платформа Azure управляет этим идентификатором среды выполнения. Ключи доступа не нужно хранить и защищать в коде приложений или конфигурации ни для удостоверения, ни для ресурсов, к которым необходимо получить доступ. Клиентскому приложению служебной шины, которое выполняется в приложении службы приложений Azure или на виртуальной машине с включенной поддержкой MSI, не нужно обрабатывать правила и ключи SAS или любые другие маркеры доступа. Клиентскому приложению достаточно только адреса конечной точки пространства имен служебной шины для обмена сообщениями. При подключении приложения служебная шина привязывает контекст MSI к клиенту в операции, показанной в примере далее в этой статье. 

Как только она будет связана с управляемым удостоверением службы, клиент служебной шины сможет выполнять все авторизованные операции. Авторизация выполняется путем привязывания MSI к ролям служебной шины. 

## <a name="service-bus-roles-and-permissions"></a>Роли и разрешения служебной шины

В начальном общедоступном выпуске (предварительная версия) можно привязать управляемые удостоверения служб только к ролям "Владелец" и "Участник" из пространства имен служебной шины, которые предоставляют удостоверению полный доступ ко всем сущностям в пространстве имен. Однако операции управления, изменяющие топологию пространства имен, изначально поддерживаются только через Azure Resource Manager, а не через собственный интерфейс управления REST служебной шины. Эта поддержка также означает, что нельзя использовать объект [NamespaceManager](/dotnet/api/microsoft.servicebus.namespacemanager) клиента .NET Framework в управляемом удостоверении службы.

## <a name="use-service-bus-with-a-managed-service-identity"></a>Использование служебной шины с управляемым удостоверением службы

В следующем разделе описано, как создать и развернуть пример приложения, выполняющегося с использованием управляемого удостоверения службы, предоставить удостоверению доступ к пространству имен служебной шины для обмена сообщениями и как приложение взаимодействует с сущностями служебной шины через этот идентификатор.

В этом обзоре описано веб-приложение, размещенное в [службе приложений Azure](https://azure.microsoft.com/services/app-service/). Шаги для приложения, размещенного на виртуальной машине, аналогичны.

### <a name="create-an-app-service-web-application"></a>Создание веб-приложения службы приложений

Первым шагом является создание приложения ASP.NET службы приложения. Если вы не знаете, как это сделать в Azure, ознакомьтесь с [этим руководством](../app-service/app-service-web-get-started-dotnet-framework.md). Однако вместо того, чтобы создавать приложение MVC, как показано в этом руководстве, создайте приложение веб-форм.

### <a name="set-up-the-managed-service-identity"></a>Настройка управляемого удостоверения службы

После создания приложения перейдите к только что созданному веб-приложению на портале Azure (также отображается в практическом руководстве), а затем перейдите на страницу **Управляемое удостоверение службы** и включите возможность: 

![](./media/service-bus-managed-service-identity/msi1.png)

После включения возможности в Azure Active Directory будет создано удостоверение службы и настроено в узле службы приложений.

### <a name="create-a-new-service-bus-messaging-namespace"></a>Создание пространства имен служебной шины, предназначенного для обмена сообщениями

Далее [создайте пространство имен служебной шины, предназначенное для обмена сообщениями](service-bus-create-namespace-portal.md), в одном из регионов Azure с поддержкой предварительной версии для RBAC (**восточная часть США**, **восточная часть США 2** или **Западная Европа**). 

Перейдите к пространству имен на странице **Управление доступом (IAM)** на портале и щелкните **Добавить**, чтобы добавить управляемое удостоверение службы к роли **Владелец**. Для этого найдите название веб-приложения на панели **Добавление разрешений** в поле **Select** (Выбор), а затем щелкните запись. Нажмите кнопку **Сохранить**.

![](./media/service-bus-managed-service-identity/msi2.png)
 
Теперь управляемое удостоверение службы веб-приложения имеет доступ к пространству имен служебной шины и к ранее созданной очереди. 

### <a name="run-the-app"></a>Запуск приложения

Теперь можно изменить страницу по умолчанию созданного вами приложения ASP.NET. Вы также можете использовать код веб-приложения из этого [репозитория GitHub](https://github.com/Azure/azure-service-bus/tree/master/samples/DotNet/Microsoft.ServiceBus.Messaging/ManagedServiceIdentity).

Страница Default.aspx является целевой. Код можно найти в файле Default.aspx.cs. В результате вы получите самое простое веб-приложение с несколькими полями для ввода и кнопками **отправки** и **получения**, которые позволяют отправить сообщения в служебную шину или получить их оттуда.

Обратите внимание, как инициализируется объект [MessagingFactory](/dotnet/api/microsoft.servicebus.messaging.messagingfactory). Вместо того чтобы использовать поставщик общих маркеров доступа, код создает поставщик маркеров для управляемого удостоверения службы с помощью вызова `TokenProvider.CreateManagedServiceIdentityTokenProvider(ServiceAudience.ServiceBusAudience)`. Таким образом, нет никаких секретов для хранения и использования. Поток контекста управляемого удостоверения службы в служебную шину и подтверждение авторизации автоматически обрабатываются поставщиком маркеров, что является более простой моделью, чем использование SAS.

После внесения этих изменений опубликуйте и запустите приложение. Простой способ получить правильные данные публикации — скачать, а затем импортировать профиль публикации в Visual Studio:

![](./media/service-bus-managed-service-identity/msi3.png)
 
Чтобы отправлять или получать сообщения, введите имя пространства имен и имя созданной сущности, а затем нажмите кнопки **отправки** или **получения**.
 
Обратите внимание, что управляемое удостоверение службы работает только в среде Azure и только в развертывании службы приложения, в котором оно было настроено. Кроме того, эти удостоверения сейчас не работают со слотами развертывания службы приложений.

## <a name="next-steps"></a>Дополнительная информация

Дополнительную информацию об обмене сообщениями через служебную шину см. в следующих разделах.

* [Базовая информация о Service Bus](service-bus-fundamentals-hybrid-solutions.md)
* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)