---
title: "Поиск повторяющихся сообщений служебной шины Azure | Документация Майкрософт"
description: "Обнаружение повторяющихся сообщений служебной шины"
services: service-bus-messaging
documentationcenter: 
author: clemensv
manager: timlt
editor: 
ms.service: service-bus-messaging
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/27/2017
ms.author: sethm
ms.openlocfilehash: 470246469297d5fa95eba2b147d5304e74c0003f
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="duplicate-detection"></a>Обнаружение дубликатов

Если в приложении возникает неустранимая ошибка сразу отправки сообщения, из-за чего перезапущенный экземпляр приложения ошибочно полагает, что доставка предыдущего сообщения не выполнена, то последующая его отправка приводит к тому, что сообщение отображается в системе дважды.

Возможно также, что ошибка на уровне клиента или сети возникнет немного раньше, и отправленное сообщение будет зафиксировано в очереди, но подтверждение не будет успешно возвращено клиенту. В этом сценарии клиенту не известен однозначный результат операции отправки.

Поиск повторяющихся сообщений устраняет эту неизвестность, позволяя отправителю повторно отправить то же самое сообщение, после чего очередь или раздел отклонит его дубликаты.

Включение поиска повторяющихся сообщений помогает отслеживать управляемое приложением значение *MessageId* всех сообщений, отправленных в очередь или раздел в течение указанного интервала времени. Если отправляется какое-либо новое сообщение со значением *MessageId*, которое уже занесено в журнал за текущий период времени, то сообщается, что сообщение принято (операция отправки завершена успешно), а вновь отправленное сообщение мгновенно пропускается и удаляется. Другие части сообщения, кроме значения *MessageId*, не учитываются.

Управление приложением этим идентификатором очень важно, так как только это позволяет приложению связать *MessageId* с контекстом бизнес-процесса, из которого его можно прогнозируемым образом восстановить в случае сбоя.

Для бизнес-процесса, в котором сообщения отправляются при обработке какого-либо контекста приложения, значение *MessageId* может быть частью идентификатора контекста уровня приложения, например номера заказа на покупку, и темы сообщения, например **12345.2017/payment**.

Значение *MessageId* всегда может быть какого-либо рода идентификатором GUID, но привязка идентификатора к бизнес-процессу приводит к прогнозируемой повторяемости, что требуется для эффективного использования функции поиска повторяющихся сообщений.

## <a name="enable-duplicate-detection"></a>Включение поиска повторяющихся сообщений

На портале эта функция включается во время создания сущности с помощью флажка **Включить обнаружение повторений**, который снят по умолчанию. Аналогичный параметр доступен при создании разделов.

![][1]

Можно программно установить флаг с помощью свойства [QueueDescription.requiresDuplicateDetection](/dotnet/api/microsoft.servicebus.messaging.queuedescription.requiresduplicatedetection#Microsoft_ServiceBus_Messaging_QueueDescription_RequiresDuplicateDetection), воспользовавшись API полнофункциональной платформы .NET Framework. При использовании API Azure Resource Manager это значение задается с помощью свойства [queueProperties.requiresDuplicateDetection](/azure/templates/microsoft.servicebus/namespaces/queues#property-values).

По умолчанию интервал, на котором осуществляется поиск повторяющихся сообщений для очередей и разделов, составляет 30 секунд. Максимальное значение составляет 40 минут. Можно изменить этот параметр в окне свойств очереди или раздела на портале Azure.

![][2]

Можно программно настроить размер интервала поиска повторяющихся сообщений, в течение которого сохраняются идентификаторы сообщений, задав свойство [QueueDescription.DuplicateDetectionHistoryTimeWindow](/dotnet/api/microsoft.servicebus.messaging.queuedescription.duplicatedetectionhistorytimewindow#Microsoft_ServiceBus_Messaging_QueueDescription_DuplicateDetectionHistoryTimeWindow) с помощью API полнофункциональной платформы .NET Framework. При использовании API Azure Resource Manager это значение задается с помощью свойства [queueProperties.duplicateDetectionHistoryTimeWindow](/azure/templates/microsoft.servicebus/namespaces/queues#property-values).

Обратите внимание на то, что включение поиска повторяющихся сообщений и размер интервала непосредственно повлияют на пропускную способность очереди (и раздела), так как все записанные идентификаторы сообщений должны сопоставляться с идентификатором каждого нового отправленного сообщения.

Чем меньше этот интервал, тем меньше идентификаторов сообщений нужно хранить и сопоставлять, и тем меньше используется пропускной способности. Для сущностей с высоким потреблением пропускной способности, для которых требуется поиск повторяющихся сообщений, следует задавать как можно меньшее значение этого интервала.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения об обмене сообщениями через служебную шину см. в следующих статьях:

* [Базовая информация о служебной шине](service-bus-fundamentals-hybrid-solutions.md)
* [Очереди, разделы и подписки служебной шины](service-bus-queues-topics-subscriptions.md)
* [Начало работы с очередями служебной шины](service-bus-dotnet-get-started-with-queues.md)
* [Как использовать разделы и подписки служебной шины](service-bus-dotnet-how-to-use-topics-subscriptions.md)

[1]: ./media/duplicate-detection/create-queue.png
[2]: ./media/duplicate-detection/queue-prop.png