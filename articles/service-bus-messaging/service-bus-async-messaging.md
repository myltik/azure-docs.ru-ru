---
title: Асинхронный обмен сообщениями в служебной шине | Документация Майкрософт
description: Описание асинхронного обмена сообщениями в служебной шине Azure.
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: ''
ms.assetid: f1435549-e1f2-40cb-a280-64ea07b39fc7
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 01/30/2018
ms.author: sethm
ms.openlocfilehash: e48e95d99847e68bdb218b341ad2fbcd44eb31f4
ms.sourcegitcommit: 9d317dabf4a5cca13308c50a10349af0e72e1b7e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/01/2018
ms.locfileid: "28929992"
---
# <a name="asynchronous-messaging-patterns-and-high-availability"></a>Шаблоны асинхронного обмена сообщениями и высокий уровень доступности

Асинхронный обмен сообщениями может осуществляться различными способами. Служебная шина Azure поддерживает асинхронность за счет механизма сохранения и пересылки. Этот механизм оперирует очередями, разделами и подписками. В обычном (синхронном) режиме сообщения отправляются в очереди и разделы, а поступают из очередей и подписок. Для создаваемых приложений важно, чтобы эти сущности всегда были доступны. На случай, если работоспособность сущности изменится по какой-либо причине, нужно иметь возможность предоставить доступ к сущности, которая будет работать в ограниченном режиме, но все же удовлетворять большинство потребностей.

Для реализации различных сценариев связи в приложениях обычно используются шаблоны асинхронного обмена сообщениями. Вы можете создавать приложения, в которых клиенты смогут отправлять сообщения в службы, даже если они не запущены. В приложениях, для которых характерны скачки нагрузки, сбалансировать нагрузку можно с помощью очередей, которые используются для буферизации передаваемых данных. Наконец, для распределения сообщений между несколькими компьютерами вы можете воспользоваться простым, но эффективным балансировщиком нагрузки.

Чтобы обеспечить доступность всех этих сущностей, следует предусмотреть ситуации, в которых эти сущности могут стать недоступными для устойчивой системы обмена сообщениями. Существуют такие виды ограниченной доступности сущностей для приложений:

* невозможность отправки сообщений;
* невозможность получения сообщений;
* невозможность управления сущностями (создание, извлечение, обновление или удаление);
* невозможность связи со службой.

Для каждого из указанных типов ошибок существуют режимы, которые обеспечат дальнейшую работу приложения с определенным уровнем ограничений. Например, если система может отправлять сообщения, но не может их получать, вы по-прежнему будете получать заказы от клиентов, но не сможете их обрабатывать. В этой статье рассматриваются возможные проблемы и способы их устранения. В служебной шине реализовано несколько способов устранения рисков, которые мы рекомендуем использовать. В этой статье также рассматриваются правила использования этих способов.

## <a name="reliability-in-service-bus"></a>Надежность служебной шины
Существует несколько способов решения проблем с сообщениями и сущностями, а также рекомендации по надлежащему использованию этих способов. Для понимания этих рекомендаций необходимо сначала определить участки служебной шины, которые потенциально подвержены сбоям. Благодаря архитектуре систем Azure все эти проблемы обычно имеют краткосрочный характер. В общих чертах можно выделить следующие причины недоступности.

* Регулирование из внешней системы, от которой зависит служебная шина. Регулирование возникает вследствие взаимодействия с ресурсами хранилища и вычислительными ресурсами.
* Проблема в системе, от которой зависит служебная шина. Например, могут возникнуть ошибки в определенной части хранилища.
* Сбой служебной шины в единой подсистеме. В этом случае вычислительный узел может оказаться в несогласованном состоянии и потребовать перезапуска. В результате нагрузка сущностей, обслуживаемых этим узлом, будет перераспределена на другие узлы. Это, в свою очередь, может стать причиной кратковременного замедления обработки сообщений.
* Сбой служебной шины в центре обработки данных Azure. Это пример "разрушительного сбоя", в результате которого система может быть недоступна в течение длительного времени — от нескольких минут до нескольких часов.

> [!NOTE]
> Термин **хранилище** может относиться как к службе хранилища Azure, так и к базе данных SQL Azure.
> 
> 

В служебной шине предусмотрен ряд способов устранения рисков, связанных с этими проблемами. В следующих разделах рассматривается каждая из этих проблем и способы их устранения.

### <a name="throttling"></a>Регулирование
Регулирование в служебной шине позволяет управлять скоростью обмена сообщениями "кооперативным" способом. Каждый отдельный узел служебной шины хранит множество сущностей. Для каждой из этих сущностей требуются ресурсы центрального процессора, памяти, хранилища и др. Если использование какого-либо из ресурсов превысит установленные ограничения, служебная шина может отклонить запрос. Вызывающий объект получит [ServerBusyException][ServerBusyException] и повторит попытку через 10 секунд.

Для устранения этой проблемы код должен прочитать ошибку и не допустить повторной отправки сообщения по крайней мере в течение 10 секунд. Так как эта ошибка может возникать в различных частях клиентского приложения, логику повторной отправки рекомендуется реализовать отдельно в каждой части. Такой код предотвращает выполнение регулирования благодаря секционированию очереди или раздела.

### <a name="issue-for-an-azure-dependency"></a>Проблема с зависимостью в Azure
В любом из компонентов Azure время от времени могут возникать проблемы, связанные с работой службы. Например, обновление системы, которая используется служебной шиной, может привести к временному снижению производительности этой системы. Чтобы избежать таких проблем, служебная шина регулярно проверяет и реализует способы устранения рисков. Однако при применении этих способов возможны побочные эффекты. Например, для устранения временных проблем с хранилищем в служебной шине реализована система, которая обеспечивает согласованное выполнение операций отправки сообщений. При устранении рисков отправленное сообщение может появиться в соответствующей очереди или подписке через 15 минут, после чего оно станет доступным для получения. Вообще говоря, эта проблема не затронет большинство сущностей. Тем не менее, в зависимости от количества сущностей в служебной шине Azure, такое устранение рисков иногда необходимо для некоторых клиентов служебной шины.

### <a name="service-bus-failure-on-a-single-subsystem"></a>Сбой служебной шины в единой подсистеме
В любом приложении возможны обстоятельства, которые могут привести к несогласованности внутреннего компонента служебной шины. Когда служебная шина обнаруживает это, она собирает из приложения данные, которые помогут диагностировать проблему. После сбора данных приложение перезапускается, чтобы вернуться в согласованное состояние. Этот происходит довольно быстро, но сущность может стать недоступной. Обычно простой длится недолго, но иногда может достигать нескольких минут.

В таких случаях клиентское приложение создает исключение [System.TimeoutException][System.TimeoutException] или исключение [MessagingException][MessagingException]. Служебная шина содержит средство для устранения этой проблемы, которое реализовано в виде автоматизированной логики повтора для клиента. Если период повторных попыток исчерпан, а сообщение все еще не доставлено, можно использовать другие возможности, такие как [сопряженные пространства имен][paired namespaces]. С сопряженными пространствами имен связаны другие особенности, которые рассматриваются в этой статье.

### <a name="failure-of-service-bus-within-an-azure-datacenter"></a>Сбой служебной шины в центре обработки данных Azure
Наиболее вероятной причиной сбоя в центре обработки данных Azure является сбой развертывания обновления для служебной шины или зависимой системы. Благодаря усовершенствованию платформы вероятность подобных сбоев снизилась. Сбой в центре обработки данных может также произойти по таким причинам:

* перебои с электропитанием (сбой источника питания или генераторов);
* сбой подключения (обрыв интернет-подключения между клиентами и Azure).

Обе проблемы могут возникать вследствие стихийных бедствий или технических неполадок. Чтобы обойти эту проблему и обеспечить возможность отправки сообщений, можно использовать [сопряженные пространства имен][paired namespaces]. Они позволят отправлять сообщения в дополнительное расположение до восстановления работоспособности основного расположения. Дополнительные сведения см. в статье [Рекомендации по изолированию приложений от простоев и аварий служебной шины][Best practices for insulating applications against Service Bus outages and disasters].

## <a name="paired-namespaces"></a>Сопряженные пространства имен
Функция [сопряженных пространств имен][paired namespaces] поддерживает сценарии, при которых сущность или развертывание служебной шины в центре обработки данных становятся недоступными. Хотя такое происходит редко, распределенные системы должны быть готовы к самым худшим сценариям. Как правило, это связано с краткосрочными проблемами в элементах, от которых зависит служебная шина. Чтобы обеспечить доступность приложения во время сбоя, пользователи служебной шины могут задействовать два отдельных пространства имен, в которых будут размещаться сущности обмена сообщениями. Желательно, чтобы эти пространства имен располагались в разных центрах обработки данных. В оставшейся части этого раздела используется следующая терминология.

* Основное пространство имен — пространство имен, с которым взаимодействует ваше приложение во время операций отправки и получения.
* Дополнительное пространство имен — пространство имен, которое выступает в роли резервного для основного пространства имен. Логика приложения не взаимодействует с этим пространством имен.
* Интервал отработки отказа — промежуток времени для принятия обычного сбоя до перехода приложения из основного пространства имен в дополнительное.

Сопряженные пространства имен поддерживают *доступность отправки*. Доступность отправки подразумевает сохранение возможности отправки сообщений. Чтобы использовать доступность отправки, приложение должно соответствовать следующим требованиям:

1. Сообщения могут поступать только из основного пространства имен.
2. Сообщения, отправленные в определенную очередь или раздел, могут поступать не по порядку.
3. Сообщения в рамках сеанса могут поступать не по порядку. Такой подход не соответствует стандартному порядку работы сеансов. Это означает, что ваше приложение будет использовать сеансы для логической группировки сообщений.
4. Состояние сеанса сохраняется только в основном пространстве имен.
5. Основная очередь может вернуться в рабочее состояние и начать принимать сообщения до того, как дополнительная очередь доставит все сообщения в основную очередь.

В следующих разделах рассматриваются API-интерфейсы и их реализация, а также приводится пример кода, в котором реализована такая возможность. Обратите внимание, что использование этой возможности может быть сопряжено с дополнительными расходами.

### <a name="the-messagingfactorypairnamespaceasync-api"></a>API-интерфейс MessagingFactory.PairNamespaceAsync
Функция сопряженных пространств имен включает метод [PairNamespaceAsync][PairNamespaceAsync] в класс [Microsoft.ServiceBus.Messaging.MessagingFactory][Microsoft.ServiceBus.Messaging.MessagingFactory].

```csharp
public Task PairNamespaceAsync(PairedNamespaceOptions options);
```

Когда задача будет завершена, сопряжение пространства имен также завершается. После этого оно готово обрабатывать любые объекты [MessageReceiver][MessageReceiver], [QueueClient][QueueClient] или [TopicClient][TopicClient], созданные с помощью экземпляра [MessagingFactory][MessagingFactory]. Класс [Microsoft.ServiceBus.Messaging.PairedNamespaceOptions][Microsoft.ServiceBus.Messaging.PairedNamespaceOptions] является базовым классом для разных типов сопряжения, доступных в объекте [MessagingFactory][MessagingFactory]. В настоящее время существует только один производный класс с именем [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions], реализующий требования к доступности отправки. Класс [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions] имеет набор взаимозависимых конструкторов. Изучив конструктор с наибольшим количеством параметров, вы поймете поведение и других конструкторов.

```csharp
public SendAvailabilityPairedNamespaceOptions(
    NamespaceManager secondaryNamespaceManager,
    MessagingFactory messagingFactory,
    int backlogQueueCount,
    TimeSpan failoverInterval,
    bool enableSyphon)
```

Эти параметры имеют следующее предназначение.

* *secondaryNamespaceManager* — это инициализированный экземпляр класса [NamespaceManager][NamespaceManager] для дополнительного пространства имен, который может использоваться методом [PairNamespaceAsync][PairNamespaceAsync] для настройки дополнительного пространства имен. Диспетчер пространств имен используется для получения списка очередей в пространстве имен и обеспечивает наличие очередей невыполненной работы. Если очереди отсутствуют, они будут созданы. Для класса [NamespaceManager][NamespaceManager] требуется возможность создания токена с утверждением **Управление**.
* *messagingFactory* — это экземпляр [MessagingFactory][MessagingFactory] для дополнительного пространства имен. Объект [MessagingFactory][MessagingFactory] используется для отправки сообщений в очередь невыполненной работы, а если свойство [EnableSyphon][EnableSyphon] имеет значение **true**, то и для их получения.
* *backlogQueueCount* — количество создаваемых очередей невыполненной работы. Минимальное значение — 1. При отправке сообщений в очередь невыполненной работы произвольно выбирается одна из этих очередей. Если значение равно 1, используется только одна очередь. В таком случае, если в очереди невыполненной работы возникнут ошибки, клиент не сможет использовать другую очередь невыполненной работы, в результате чего сообщение не будет отправлено. Рекомендуем выбирать для этого параметра большее значение. Значение по умолчанию равно 10. Вы можете увеличить или уменьшить его в зависимости от объема данных, ежедневно отправляемых приложением. Каждая очередь невыполненной работы вмещает до 5 ГБ сообщений.
* *failoverInterval* — промежуток времени для принятия сбоев в основном пространстве имен перед переводом сущности в дополнительное пространство имен. При отработке отказов сущности обрабатываются поочередно. Сущности в одном пространстве имен зачастую размещаются на разных узлах служебной шины. Сбой в одной сущности не подразумевает сбой в другой. Этому свойству можно присвоить значение [System.TimeSpan.Zero][System.TimeSpan.Zero]. В этом случае отработка отказа на дополнительное пространство имен будет выполняться сразу же после первого повторяющегося сбоя. К сбоям, активирующим таймер отработки отказа, относятся все исключения [MessagingException][MessagingException] со свойством [IsTransient][IsTransient], значение которого — false, а также исключение [System.TimeoutException][System.TimeoutException]. Другие исключения, такие как [UnauthorizedAccessException][UnauthorizedAccessException], не приводят к отработке отказа, так как указывают на неправильную настройку клиента. Исключение [ServerBusyException][ServerBusyException] не приводит к отработке отказа, так как в данном случае после 10-секундного ожидания выполняется повторная попытка отправить сообщение.
* *enableSyphon* — указывает, что сопряжение также должно выкачивать сообщения из дополнительного пространства имен обратно в основное пространство имен. Как правило, в приложениях, отправляющих сообщения, это значение должно быть равно **false**. В приложениях, принимающих сообщения, этому свойству следует присвоить значение **true**. Это связано с тем, что получателей сообщений зачастую меньше, чем отправителей. В зависимости от количества получателей вы можете иметь один экземпляр приложения для обработки задач выкачивания. Увеличение количества получателей отразится на стоимости каждой очереди невыполненной работы.

Чтобы использовать этот код, создайте основной экземпляр [MessagingFactory][MessagingFactory], дополнительный экземпляр [MessagingFactory][MessagingFactory], дополнительный экземпляр [NamespaceManager][NamespaceManager] и экземпляр [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions]. Вызов выполняется просто:

```csharp
SendAvailabilityPairedNamespaceOptions sendAvailabilityOptions = new SendAvailabilityPairedNamespaceOptions(secondaryNamespaceManager, secondary);
primary.PairNamespaceAsync(sendAvailabilityOptions).Wait();
```

После завершения задачи, возвращенной методом [PairNamespaceAsync][PairNamespaceAsync], все будет настроено и готово к использованию. Возможна ситуация, когда к моменту возврата задачи завершаются не все фоновые задания, необходимые для сопряжения. Поэтому не следует начинать отправку сообщений до возвращения задачи. Если возникнут ошибки, такие как ввод неправильных учетных данных или ошибки создания очередей невыполненной работы, после завершения задачи будут созданы соответствующие исключения. Как только задача будет возвращена, убедитесь в наличии очередей, просмотрев свойство [BacklogQueueCount][BacklogQueueCount] своего экземпляра [SendAvailabilityPairedNamespaceOptions][SendAvailabilityPairedNamespaceOptions]. Для приведенного выше примера код этой операции будет выглядеть следующим образом.

```csharp
if (sendAvailabilityOptions.BacklogQueueCount < 1)
{
    // Handle case where no queues were created.
}
```

## <a name="next-steps"></a>Дополнительная информация
Вы ознакомились с основами асинхронного обмена сообщениями в служебной шине. Дополнительные сведения см. в статье, посвященной [сопряженным пространствам имен][paired namespaces].

[ServerBusyException]: /dotnet/api/microsoft.servicebus.messaging.serverbusyexception
[System.TimeoutException]: https://msdn.microsoft.com/library/system.timeoutexception.aspx
[MessagingException]: /dotnet/api/microsoft.servicebus.messaging.messagingexception
[Best practices for insulating applications against Service Bus outages and disasters]: service-bus-outages-disasters.md
[Microsoft.ServiceBus.Messaging.MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[MessageReceiver]: /dotnet/api/microsoft.servicebus.messaging.messagereceiver
[QueueClient]: /dotnet/api/microsoft.servicebus.messaging.queueclient
[TopicClient]: /dotnet/api/microsoft.servicebus.messaging.topicclient
[Microsoft.ServiceBus.Messaging.PairedNamespaceOptions]: /dotnet/api/microsoft.servicebus.messaging.pairednamespaceoptions
[MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[SendAvailabilityPairedNamespaceOptions]: /dotnet/api/microsoft.servicebus.messaging.sendavailabilitypairednamespaceoptions
[NamespaceManager]: /dotnet/api/microsoft.servicebus.namespacemanager
[PairNamespaceAsync]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory#Microsoft_ServiceBus_Messaging_MessagingFactory_PairNamespaceAsync_Microsoft_ServiceBus_Messaging_PairedNamespaceOptions_
[EnableSyphon]: /dotnet/api/microsoft.servicebus.messaging.sendavailabilitypairednamespaceoptions#Microsoft_ServiceBus_Messaging_SendAvailabilityPairedNamespaceOptions_EnableSyphon
[System.TimeSpan.Zero]: https://msdn.microsoft.com/library/system.timespan.zero.aspx
[IsTransient]: /dotnet/api/microsoft.servicebus.messaging.messagingexception#Microsoft_ServiceBus_Messaging_MessagingException_IsTransient
[UnauthorizedAccessException]: https://msdn.microsoft.com/library/system.unauthorizedaccessexception.aspx
[BacklogQueueCount]: /dotnet/api/microsoft.servicebus.messaging.sendavailabilitypairednamespaceoptions?redirectedfrom=MSDN#Microsoft_ServiceBus_Messaging_SendAvailabilityPairedNamespaceOptions_BacklogQueueCount
[paired namespaces]: service-bus-paired-namespaces.md
