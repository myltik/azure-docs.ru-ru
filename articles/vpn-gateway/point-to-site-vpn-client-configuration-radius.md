---
title: "Создание и установка файлов конфигурации VPN-клиента для подключений типа \"точка — сеть\" с использованием Azure PowerShell и аутентификации RADIUS | Документация Майкрософт"
description: "В этой статье описано, как создать файл конфигурации VPN-клиента для подключений типа \"точка — сеть\" с использованием аутентификации RADIUS."
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 
ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 01/24/2018
ms.author: cherylmc
ms.openlocfilehash: 838065287279f1c17e7f294bc919c4a0421e2a58
ms.sourcegitcommit: ded74961ef7d1df2ef8ffbcd13eeea0f4aaa3219
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/29/2018
---
# <a name="create-and-install-vpn-client-configuration-files-for-p2s-radius-authentication"></a>Создание и установка файлов конфигурации VPN-клиента для аутентификации при подключениях типа "точка — сеть" с использованием RADIUS

Файлы конфигурации VPN-клиента содержатся в ZIP-файле. Эти файлы содержат параметры, требуемые при подключениях типа "точка — сеть" между собственным VPN-клиентом IKEv2 Windows или Mac и виртуальной сетью. Сервер RADIUS предоставляет разные способы аутентификации. Конфигурация VPN-клиента зависит от выбранного варианта.

### <a name="workflow"></a>Рабочий процесс

  1. [Настройте VPN-шлюз Azure для подключения "точка — сеть"](point-to-site-how-to-radius-ps.md).
  2. [Настройте сервер RADIUS для аутентификации](point-to-site-how-to-radius-ps.md#radius). 
  3. (В этой статье.) Получите конфигурацию VPN-клиента для выбранного варианта аутентификации и используйте ее для настройки VPN-клиента на устройстве Windows. Это позволит установить подключение типа "точка — сеть" к виртуальным сетям Azure.
  4. [Настройте и установите подключение "точка — сеть"](point-to-site-how-to-radius-ps.md).

>[!IMPORTANT]
>Если вы создали профиль конфигурации VPN-клиента, а затем внесли изменения в конфигурацию VPN-подключения типа "точка — сеть" (например, изменили тип VPN-протокола или аутентификации), создайте и установите новую конфигурацию VPN-клиента на устройствах пользователей.
>
>

## <a name="adeap"></a>Сведения об аутентификации имени пользователя и пароля

* **Аутентификация AD.** Распространенный вариант — аутентификация домена AD. В этом сценарии для подключения к виртуальным сетям Azure используются учетные данные домена. Вы можете создать файлы конфигурации VPN-клиента для аутентификации RADIUS AD.

* **Аутентификация без AD.** Вы также можете настроить сценарий аутентификации RADIUS на основе имени пользователя и пароля без AD.

Перед подключением убедитесь, что у всех пользователей есть учетные данные (имя пользователя и пароль), которые могут использоваться при аутентификации RADIUS. Вы можете создать только конфигурацию для протокола аутентификации на основе имени пользователя и пароля EAP-MSCHAPv2. Для параметра -AuthenticationMethod указано значение EapMSChapv2.

## <a name="usernamefiles"></a> 1. Создание файлов конфигурации VPN-клиента

Создайте файлы конфигурации VPN-клиента для аутентификации имени пользователя и пароля. Вы можете создать файлы конфигурации VPN-клиента с помощью следующей команды:

```powershell 
New-AzureRmVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW" -AuthenticationMethod "EapMSChapv2"
```
 
Выполненная команда возвращает ссылку. Скопируйте и вставьте ссылку в веб-браузер, чтобы скачать файл VpnClientConfiguration.zip. Распакуйте файл. Отобразятся следующие папки: 
 
* **WindowsAmd64** и **WindowsX86**. Эти папки содержат пакеты установщика 64- и 32-разрядной версий Windows. 
* **Generic**. Эта папка содержит общие сведения для создания конфигурации VPN-клиента. Эта папка не требуется, чтобы настроить аутентификацию имени пользователя и пароля.
* **Mac**. Если при создании шлюза виртуальной сети настроен протокол IKEv2, отобразится папка с именем Mac, которая содержит файл **mobileconfig**. Этот файл используется для настройки клиентов Mac.

Если вы уже создали файлы конфигурации клиента, получить их можно с помощью командлета Get-AzureRmVpnClientConfiguration. Но если вы измените конфигурацию VPN-подключения "точка — сеть", например тип VPN-протокола или аутентификации, конфигурация не обновится автоматически. Необходимо выполнить командлет New-AzureRmVpnClientConfiguration для создания скачиваемого файла конфигурации.

Чтобы получить созданные файлы конфигурации, используйте следующую команду:

```powershell
Get-AzureRmVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW"
```

## <a name="setupusername"></a> 2. Настройка VPN-клиентов Windows и Mac
 
### <a name="adwincli"></a>Настройка VPN-клиента Windows

На каждом клиентском компьютере Windows можно использовать один и тот же пакет конфигурации VPN-клиента, если его версия соответствует архитектуре клиента. Список поддерживаемых клиентских операционных систем см. в разделе с описанием подключений типа "точка — сеть" в статье [VPN-шлюз: вопросы и ответы](vpn-gateway-vpn-faq.md#P2S).

Чтобы настроить в Windows собственный VPN-клиент для аутентификации на основе сертификата, сделайте следующее:

1. Выберите файлы конфигурации VPN-клиента, которые соответствуют архитектуре компьютера Windows. Для 64-разрядной архитектуры процессора выберите пакет установщика VpnClientSetupAmd64. Для 32-разрядной архитектуры процессора выберите пакет установщика VpnClientSetupX86. 
2. Дважды щелкните пакет, чтобы установить его. При появлении всплывающего окна SmartScreen щелкните **Дополнительно**, а затем выберите **Выполнить в любом случае**.
3. На клиентском компьютере перейдите в раздел **Параметры сети** и щелкните **VPN**. Для VPN-подключения отображается имя виртуальной сети, к которой оно устанавливается. 

### <a name="admaccli"></a>Настройка VPN-клиента Mac (OSX)

1. Выберите файл **VpnClientSetup mobileconfig** и отправьте его всем пользователям. Для этого можно использовать электронную почту или другой способ.

2. Найдите файл **mobileconfig** на компьютере Mac.

  ![Расположение файла mobilconfig](./media/point-to-site-vpn-client-configuration-radius/admobileconfigfile.png)
3. Дважды щелкните профиль, чтобы установить его, и нажмите кнопку **Continue** (Продолжить). Имя профиля совпадает с именем виртуальной сети.

  ![Установка](./media/point-to-site-vpn-client-configuration-radius/adinstall.png)
4. Нажмите кнопку **Continue** (Продолжить), чтобы определить отправителя как надежного и продолжить установку.

  ![Продолжение](./media/point-to-site-vpn-client-configuration-radius/adcontinue.png)
5. При установке профиля вы можете указать имя пользователя и пароль, которые используются для аутентификации VPN. Эти сведения вводить не обязательно, но если вы их укажете, они сохранятся и будут автоматически подставляться при установке подключения. Щелкните **Install** (Установить), чтобы продолжить.

  ![Параметры](./media/point-to-site-vpn-client-configuration-radius/adsettings.png)
6. Введите имя пользователя и пароль, чтобы получить необходимые разрешения для установки профиля на компьютере. Последовательно выберите **ОК**.

  ![Имя пользователя и пароль](./media/point-to-site-vpn-client-configuration-radius/adusername.png)
7. Установленный профиль отображается в диалоговом окне **Profiles** (Профили). Это диалоговое окно также можно открыть позже в разделе **System Preferences** (Системные настройки).

  ![Системные настройки](./media/point-to-site-vpn-client-configuration-radius/adsystempref.png)
8. Чтобы получить доступ к VPN-подключению, откройте в разделе **System Preferences** (Системные настройки) диалоговое окно **Network** (Сеть).

  ![Сеть](./media/point-to-site-vpn-client-configuration-radius/adnetwork.png)
9. VPN-подключение отображается как **IkeV2-VPN**. Имя можно изменить, обновив файл **mobileconfig**.

  ![connection;](./media/point-to-site-vpn-client-configuration-radius/adconnection.png)
10. Щелкните **Authentication Settings**(Параметра аутентификации). В раскрывающемся списке выберите **Username** (Имя пользователя) и введите свои учетные данные. Если учетные данные введены ранее, **имя пользователя** будет выбрано автоматически. Имя пользователя и пароль подставляются предварительно. Нажмите кнопку **ОК**, чтобы сохранить настройки. Затем вы вернетесь в диалоговое окно "Network" (Сеть).

  ![authenticate](./media/point-to-site-vpn-client-configuration-radius/adauthentication.png)
11. Щелкните **Apply** (Применить), чтобы сохранить изменения. Чтобы инициировать подключение, нажмите кнопку **Connect** (Подключиться).

## <a name="certeap"></a>Сведения об аутентификации на основе сертификата
 
Вы можете создать файлы конфигурации VPN-клиента для аутентификации RADIUS на основе сертификата с использованием протокола EAP-TLS. Как правило, для аутентификации пользователя при VPN-подключениях используется сертификат, который выпущен предприятием. Убедитесь, что на устройствах всех пользователей, для которых инициируется подключение, установлен сертификат, который может быть проверен сервером RADIUS:
 
* Для параметра -AuthenticationMethod укажите значение EapTls.
* При аутентификации на основе сертификата клиент проверяет сервер RADIUS, оценивая его сертификат. Параметр -RadiusRootCert определяет CER-файл с корневым сертификатом, который используется для проверки сервера RADIUS.  
* Иногда у устройства Windows может быть несколько сертификатов клиента. В таком случае при аутентификации может отобразиться всплывающее диалоговое окно со списком всех сертификатов. Пользователь должен выбрать в списке нужный сертификат. Сертификат можно найти с помощью фильтра, указав корневой сертификат, к которому должен привязываться сертификат клиента. Параметр -ClientRootCert определяет CER-файл с корневым сертификатом. Это необязательный параметр. Если у устройства, для которого вам нужно установить подключение, есть один сертификат клиента, этот параметр указывать не требуется.

## <a name="certfiles"></a>1. Создание файлов конфигурации VPN-клиента

Вы можете создать файлы конфигурации VPN-клиента для аутентификации на основе сертификата. Вы можете создать файлы конфигурации VPN-клиента с помощью следующей команды:
 
```powershell
New-AzureRmVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW" -AuthenticationMethod "EapTls" -RadiusRootCert <full path name of .cer file containing the RADIUS root> -ClientRootCert <full path name of .cer file containing the client root> | fl
```

Выполненная команда возвращает ссылку. Скопируйте и вставьте ссылку в веб-браузер, чтобы скачать файл VpnClientConfiguration.zip. Распакуйте файл. Отобразятся следующие папки:

* **WindowsAmd64** и **WindowsX86**. Эти папки содержат пакеты установщика 64- и 32-разрядной версий Windows. 
* **GenericDevice**. Эта папка содержит общие сведения для создания конфигурации VPN-клиента.

Если вы уже создали файлы конфигурации клиента, получить их можно с помощью командлета Get-AzureRmVpnClientConfiguration. Но если вы измените конфигурацию VPN-подключения "точка — сеть", например тип VPN-протокола или аутентификации, конфигурация не обновится автоматически. Необходимо выполнить командлет New-AzureRmVpnClientConfiguration для создания скачиваемого файла конфигурации.

Чтобы получить созданные файлы конфигурации, используйте следующую команду:

```powershell
Get-AzureRmVpnClientConfiguration -ResourceGroupName "TestRG" -Name "VNet1GW" | fl
```
 
## <a name="setupusername"></a> 2. Настройка VPN-клиентов Windows и Mac

### <a name="certwincli"></a>Настройка VPN-клиента Windows

1. Выберите пакет конфигурации и установите его на клиентском устройстве. Для 64-разрядной архитектуры процессора выберите пакет установщика VpnClientSetupAmd64. Для 32-разрядной архитектуры процессора выберите пакет установщика VpnClientSetupX86. При появлении всплывающего окна SmartScreen щелкните **Дополнительно**, а затем выберите **Выполнить в любом случае**. Вы также можете сохранить пакет для установки на других клиентских компьютерах.
2. На клиентском компьютере перейдите в раздел **Параметры сети** и щелкните **VPN**. Для VPN-подключения отображается имя виртуальной сети, к которой оно устанавливается.

### <a name="certmaccli"></a>Настройка VPN-клиента Mac (OSX)

Для каждого устройства Mac, которое подключается к виртуальной сети Azure, нужно создать отдельный профиль, так как для аутентификации таких устройств в профиле необходимо указать сертификат пользователя. В папке **Generic** содержатся все сведения, требуемые для создания профиля.

  * Файл **VpnSettings.xml** содержит такие важные параметры, как адрес сервера и тип туннеля.
  * Файл **VpnServerRoot.cer** содержит корневой сертификат, который требуется для проверки VPN-шлюза при установке подключения типа "точка — сеть".
  * Файл **RadiusServerRoot.cer** содержит корневой сертификат, который требуется для проверки сервера RADIUS при аутентификации.

Чтобы настроить на устройстве Mac собственный VPN-клиент для аутентификации на основе сертификата, сделайте следующее:

1. Импортируйте корневые сертификаты **VpnServerRoot** и **RadiusServerRoot** на устройство Mac. Для этого скопируйте файл на устройство Mac и дважды щелкните его.  
Чтобы выполнить импорт, щелкните **Add** (Добавить).

  **Добавление VpnServerRoot**

  ![Добавление сертификата](./media/point-to-site-vpn-client-configuration-radius/addcert.png)

  **Добавление RadiusServerRoot**

  ![Добавление сертификата](./media/point-to-site-vpn-client-configuration-radius/radiusrootcert.png)
2. Откройте диалоговое окно **Network** (Сеть) и в разделе **Network Preferences** (Параметры сети) щелкните **+**, чтобы создать профиль подключения типа "точка — сеть" между VPN-клиентом и виртуальной сетью Azure.

  Установите следующие значения: для параметра **Interface** (Интерфейс) — VPN, для **VPN Type** (Тип VPN) — IKEv2. Укажите имя профиля в поле **Service Name** (Имя службы), а затем нажмите кнопку **Create** (Создать), чтобы создать профиль подключения VPN-клиента.

  ![Сеть](./media/point-to-site-vpn-client-configuration-radius/network.png)
3. В папке **Generic** из файла **VpnSettings.xml** скопируйте значение тега **VpnServer**. Вставьте это значение в поля профиля **Server Address** (Адрес сервера) и **Remote ID** (Удаленный ИД). Не заполняйте поле **Local ID** (Локальный ИД).

  ![Сведения о сервере](./media/point-to-site-vpn-client-configuration-radius/servertag.png)
4. Щелкните **Authentication Settings** (Параметры аутентификации) и выберите **Certificate** (Сертификат). 

  ![Параметры аутентификации](./media/point-to-site-vpn-client-configuration-radius/certoption.png)
5. Щелкните **Select…** (Выбрать), чтобы выбрать сертификат, который будет использоваться для аутентификации.

  ![на основе сертификата.](./media/point-to-site-vpn-client-configuration-radius/certificate.png)
6. В окне **Choose An Identity** (Выбор удостоверения) отобразится список доступных сертификатов. Выберите нужный сертификат, а затем щелкните **Continue** (Продолжить).

  ![identity](./media/point-to-site-vpn-client-configuration-radius/identity.png)
7. В поле **Local ID** (Локальный ИД) укажите имя сертификата (из шага 5). В нашем примере это ikev2Client.com. Щелкните **Apply** (Применить), чтобы сохранить изменения.

  ![apply](./media/point-to-site-vpn-client-configuration-radius/applyconnect.png)
8. В диалоговом окне **Network** (Сеть) щелкните **Apply** (Применить), чтобы сохранить все изменения. Затем щелкните **Connect** (Подключиться), чтобы установить подключение типа "точка — сеть" к виртуальной сети Azure.

## <a name="otherauth"></a>Работа с другими протоколами или типами аутентификации

Чтобы использовать другой тип аутентификации (например, OTP), отличный от аутентификации на основе имени пользователя и пароля или сертификата, либо же другой протокол аутентификации (например, протокол PEAP-MSCHAPv2, а не EAP-MSCHAPv2), создайте собственный профиль конфигурации VPN-клиента. Чтобы создать профиль, требуются следующие данные: IP-адрес шлюза виртуальной сети, тип туннеля и сведения о маршрутах с разделенный туннелем. Эти данные можно получить, сделав следующее:

1. Используйте командлет Get-AzureRmVpnClientConfiguration, чтобы создать конфигурацию VPN-клиента для EapMSChapv2. Инструкции см. в [этом разделе](#ccradius) статьи.

2. Распакуйте архив VpnClientConfiguration.zip и найдите папку GenenericDevice. Не используйте папки с установщиками Windows для 64- и 32-разрядной архитектур.
 
3. Папка GenenericDevice содержит XML-файл с именем VpnSettings. В этом файле находится вся необходимая информация.

  * VpnServer — полное доменное имя VPN-шлюза Azure. Это адрес, по которому подключается клиент.
  * VpnType — тип туннеля, который вы используете для подключения.
  * Routes — маршруты, которые нужно настроить в профиле, чтобы через P2S-туннель отправлялся только трафик виртуальной сети Azure.
  * Кроме того, папка GenenericDevice содержит CER-файл с именем VpnServerRoot. В этом файле содержится корневой сертификат, который требуется для проверки VPN-шлюза Azure при установке подключения типа "точка — сеть". Установите сертификат на всех устройствах, которые будут подключаться к виртуальной сети Azure. 
 
## <a name="next-steps"></a>Дополнительная информация

Вернитесь к статье, чтобы [завершить настройку подключения типа "точка — сеть"](point-to-site-how-to-radius-ps.md).
