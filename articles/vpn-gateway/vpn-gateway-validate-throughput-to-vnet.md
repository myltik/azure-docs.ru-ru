---
title: Проверка пропускной способности VPN для виртуальной сети Microsoft Azure | Документы Майкрософт
description: Этот документ помогает пользователю проверить пропускную способность сети от своих локальных ресурсов до виртуальной машины Azure.
services: vpn-gateway
documentationcenter: na
author: chadmath
manager: jasmc
editor: ''
tags: azure-resource-manager,azure-service-management
ms.assetid: ''
ms.service: vpn-gateway
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/08/2017
ms.author: radwiv;chadmat;genli
ms.openlocfilehash: cad7719eb077d7aca9c1db5741a5fe1e0ca910a2
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
---
# <a name="how-to-validate-vpn-throughput-to-a-virtual-network"></a>Порядок проверки пропускной способности VPN для виртуальной сети

Подключение к VPN-шлюзу позволяет установить защищенное распределенное соединение между виртуальной сетью в Azure и локальной ИТ-инфраструктурой.

В этой статье описано, как проверить пропускную способность сети от локальных ресурсов до виртуальной машины Azure. Кроме того, в ней приведены рекомендации по устранению неполадок.

>[!NOTE]
>Эта статья помогает диагностировать и устранить распространенные проблемы. Если вам не удается решить проблему с помощью приведенных ниже сведений, [обратитесь в службу поддержки](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade).
>
>

## <a name="overview"></a>Обзор

Подключение к VPN-шлюзу состоит из следующих компонентов:

- Локальное VPN-устройство (см. список [проверенных VPN-устройств](vpn-gateway-about-vpn-devices.md#devicetable)).
- Общедоступный Интернет
- VPN-шлюз Azure
- Azure

На следующей схеме показано логическое подключение между локальной сетью и виртуальной сетью Azure через VPN.

![Логическое подключение сети клиента к сети MSFT с помощью VPN](./media/vpn-gateway-validate-throughput-to-vnet/VPNPerf.png)

## <a name="calculate-the-maximum-expected-ingressegress"></a>Расчет максимального ожидаемого исходящего и входящего трафика

1.  Определите базовые требования приложения к пропускной способности.
2.  Определите предел пропускной способности для VPN-шлюза Azure. Дополнительные сведения см. в разделе "Суммарная пропускная способность в зависимости от SKU и типа VPN" статьи [Планирование и проектирование VPN-шлюза](vpn-gateway-plan-design.md).
3.  Определите [рекомендованную пропускную способность](../virtual-machines/virtual-machines-windows-sizes.md) для используемого размера виртуальной машины Azure.
4.  Определите пропускную способность поставщика услуг Интернета (ISP).
5.  Вычислите ожидаемую пропускную способность — наименьшая пропускная способность (виртуальной машины, шлюза, поставщика услуг Интернета) * 0,8.

Если расчетная пропускная способность не удовлетворяет базовым потребностям приложения, нужно увеличить пропускную способность ресурса, определенного как узкое место. Чтобы изменить размер VPN-шлюза Azure, см. статью [Изменение SKU шлюза](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings.md#gwsku). Чтобы изменить размер виртуальной машины, см. статью [Изменение размера виртуальной машины](../virtual-machines/virtual-machines-windows-resize-vm.md). Если ожидаемая пропускная способность Интернета не обеспечивается, рекомендуем обратиться к поставщику услуг Интернета.

## <a name="validate-network-throughput-by-using-performance-tools"></a>Проверка пропускной способности сети с помощью средств повышения производительности

Эту проверку следует выполнять в часы пониженной нагрузки, так как насыщенность пропускной способности туннеля VPN при тестировании не позволяет получить точные результаты.

Для этого теста мы используем средство iPerf, которое работает в Windows и Linux, а также имеет режимы клиента и сервера. Для виртуальных машин Windows его пропускная способность ограничена значением 3 Гбит/с.

Это средство не выполняет операции чтения и записи на диск. Оно лишь создает самостоятельно сформированный TCP-трафик с одного конца на другой. По результатам эксперимента, измеряющего пропускную способность между узлами клиента и сервера, средство формирует статистику. При тестировании между двумя узлами один выступает в качестве сервера, а другой — клиента. После завершения теста рекомендуется поменять роли местами, чтобы проверить пропускную способность как при отправке, так и при скачивании на обоих узлах.

### <a name="download-iperf"></a>Скачивание iPerf
Скачайте [iPerf](https://iperf.fr/download/iperf_3.1/iperf-3.1.2-win64.zip). Дополнительные сведения см. в [документации по iPerf](https://iperf.fr/iperf-doc.php).

 >[!NOTE]
 >Продукты сторонних производителей, обсуждаемые в этой статье, разрабатываются компаниями, независимыми от корпорации Майкрософт. Корпорация Майкрософт не дает никаких гарантий, явных или подразумеваемых, относительно производительности или надежности таких продуктов.
 >
 >

### <a name="run-iperf-iperf3exe"></a>Запуск iPerf (iperf3.exe)
1. Включите правило NSG/ACL, разрешающее такой трафик (для тестирования общедоступного IP-адреса на виртуальной машине Azure).

2. На обоих узлах включите исключение брандмауэра для порта 5001.

    **Windows.** Выполните следующую команду от имени администратора:

    ```CMD
    netsh advfirewall firewall add rule name="Open Port 5001" dir=in action=allow protocol=TCP localport=5001
    ```

    Чтобы удалить правило после окончания тестирования, выполните следующую команду:

    ```CMD
    netsh advfirewall firewall delete rule name="Open Port 5001" protocol=TCP localport=5001
    ```
    </br>
    **Linux в Azure.** Образы Linux в Azure имеют нестрогие брандмауэры. Когда приложение прослушивает порт, прохождение трафика разрешается. Для защищенных пользовательских образов может потребоваться явно открыть нужные порты. В число распространенных брандмауэров уровня ОС для Linux входят `iptables`, `ufw` и `firewalld`.

3. На узле сервера перейдите в каталог, куда извлекается iperf3.exe. Затем запустите iPerf в режиме сервера и настройте его для прослушивания порта 5001, как показано в следующих командах:

     ```CMD
     cd c:\iperf-3.1.2-win65

     iperf3.exe -s -p 5001
     ```

4. На узле клиента перейдите в каталог, куда извлекается средство iperf, и выполните следующую команду:

    ```CMD
    iperf3.exe -c <IP of the iperf Server> -t 30 -p 5001 -P 32
    ```

    Клиент передает трафик на сервер через порт 5001 в течение на 30 секунд. Флаг "-P", указывающий, что мы используем 32 одновременных подключения к узлу сервера.

    Ниже представлены выходные данные для этого примера:

    ![Выходные данные](./media/vpn-gateway-validate-throughput-to-vnet/06theoutput.png)

5. (НЕОБЯЗАТЕЛЬНО) Чтобы сохранить результаты тестирования, выполните следующую команду:

    ```CMD
    iperf3.exe -c IPofTheServerToReach -t 30 -p 5001 -P 32  >> output.txt
    ```

6. После завершения предыдущих шагов выполните те же действия, изменив роли на противоположные, чтобы узел сервера стал клиентом, и наоборот.

## <a name="address-slow-file-copy-issues"></a>Решение проблем с низкой скоростью при копировании файлов
При использовании проводника или перетаскивании объектов во время сеанса RDP может наблюдаться снижение скорости копирования файлов. Обычно эта проблема вызвана одним или обоими следующими факторами:

- Приложения для копирования файлов, такие как проводник и RDP, не используют несколько потоков при копировании. Для повышения производительности используйте многопоточное приложение, например [Richcopy](https://technet.microsoft.com/magazine/2009.04.utilityspotlight.aspx), которое копирует файлы с помощью 16 или 32 потоков. Чтобы изменить число используемых потоков в Richcopy, выберите **Action** (Действие) > **Copy options** (Параметры копирования) > **File copy** (Копирование файлов).<br><br>
![Проблемы с низкой скоростью при копировании файлов](./media/vpn-gateway-validate-throughput-to-vnet/Richcopy.png)<br>
- Недостаточная скорость чтения и записи виртуальной машины. Дополнительные сведения см. в статье [Устранение неполадок службы хранилища Azure](../storage/common/storage-e2e-troubleshooting.md).

## <a name="on-premises-device-external-facing-interface"></a>Внешний интерфейс для локального устройства
Если IP-адрес для Интернета локального VPN-устройства включен в определение [локальной сети](vpn-gateway-howto-site-to-site-resource-manager-portal.md#LocalNetworkGateway) в Azure, вы можете столкнуться с невозможностью запуска VPN, нерегулярными отключениями либо снижением производительности.

## <a name="checking-latency"></a>Проверка задержки
Используйте команду tracert для трассировки до устройства Microsoft Azure, чтобы определить наличие задержки более 100 мс между прыжками.

Из локальной сети запустите *tracert* для виртуального IP-адреса шлюза или виртуальной машины Azure. Если возвращается лишь знак *, значит вы достигли края Azure. Когда возвращаются DNS-имена, содержащие "MSN", значит вы достигли магистрали Майкрософт.<br><br>
![Проверка задержки](./media/vpn-gateway-validate-throughput-to-vnet/08checkinglatency.png)

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения доступны в следующих источниках:

- [Оптимизации пропускной способности сети для виртуальной машины Azure](../virtual-network/virtual-network-optimize-network-bandwidth.md)
- [Служба технической поддержки Майкрософт](https://portal.azure.com/?#blade/Microsoft_Azure_Support/HelpAndSupportBlade)
