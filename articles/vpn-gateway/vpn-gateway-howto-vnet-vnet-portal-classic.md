---
title: Создание подключения между виртуальными сетями. Классический портал Azure | Документация Майкрософт
description: Подключение виртуальных сетей Azure между собой с помощью PowerShell и портала Azure.
services: vpn-gateway
documentationcenter: na
author: cherylmc
manager: jpconnock
editor: ''
tags: azure-service-management
ms.assetid: ''
ms.service: vpn-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/14/2018
ms.author: cherylmc
ms.openlocfilehash: d9766afefa793baf66ea5218843f06031b1b364c
ms.sourcegitcommit: 59914a06e1f337399e4db3c6f3bc15c573079832
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2018
ms.locfileid: "31601062"
---
# <a name="configure-a-vnet-to-vnet-connection-classic"></a>Настройка подключения между виртуальными сетями (классическая модель)

[!INCLUDE [deployment models](../../includes/vpn-gateway-classic-deployment-model-include.md)]

В этой статье описывается, как создать подключение VPN-шлюза между виртуальными сетями. Виртуальные сети могут относиться к одному или разным регионам и к одной или разным подпискам. Приведенные в этой статье инструкции относятся к классической модели развертывания и порталу Azure. Эту конфигурацию также можно создать с помощью разных средств или моделей развертывания, выбрав вариант из следующего списка:

> [!div class="op_single_selector"]
> * [портал Azure](vpn-gateway-howto-vnet-vnet-resource-manager-portal.md)
> * [PowerShell](vpn-gateway-vnet-vnet-rm-ps.md)
> * [интерфейс командной строки Azure](vpn-gateway-howto-vnet-vnet-cli.md)
> * [Портал Azure (классический)](vpn-gateway-howto-vnet-vnet-portal-classic.md)
> * [Подключение с использованием разных моделей развертывания — портал Azure](vpn-gateway-connect-different-deployment-models-portal.md)
> * [Подключение с использованием разных моделей развертывания — PowerShell](vpn-gateway-connect-different-deployment-models-powershell.md)
>
>

![Схема подключения между виртуальными сетями](./media/vpn-gateway-howto-vnet-vnet-portal-classic/v2vclassic.png)

## <a name="about-vnet-to-vnet-connections"></a>О подключениях "виртуальная сеть — виртуальная сеть"

Подключение типа "виртуальная сеть — виртуальная сеть" в классической модели развертывания через VPN-шлюз похоже на подключение виртуальной сети к локальному сайту. В обоих типах подключений используется VPN-шлюз для создания защищенного туннеля, использующего IPsec/IKE.

Подключаемые виртуальные сети могут иметь разные подписки в разных регионах. Можно комбинировать подключение "виртуальная сеть — виртуальная сеть" с многосайтовыми конфигурациями. Это позволяет настраивать топологии сети, совмещающие распределенные подключения с подключениями между виртуальными сетями.

![Подключения типа "виртуальная сеть — виртуальная сеть"](./media/vpn-gateway-howto-vnet-vnet-portal-classic/aboutconnections.png)

### <a name="why"></a>Зачем нужна связь между виртуальными сетями?

Вам может потребоваться подключить виртуальные сети по следующим причинам.

* **Межрегиональная географическая избыточность и географическое присутствие**

  * Вы можете настроить собственную георепликацию или синхронизацию с безопасной связью без прохождения трафика через конечные точки с выходом в Интернет.
  * С помощью Azure Load Balancer и технологий кластеризации корпорации Майкрософт или сторонних производителей можно настроить высокодоступную рабочую нагрузку с геоизбыточностью в нескольких регионах Azure. Одним из важных примеров является настройка SQL Always On с группами доступности, распределенными между несколькими регионами Azure.
* **Региональные многоуровневые приложения с четкой границей изоляции**

  * В одном регионе можно настроить многоуровневые приложения с использованием нескольких связанных друг с другом виртуальных сетей с сильной изоляцией и защищенной связью между уровнями.
* **Обмен данными между подписками и организациями в Azure**

  * Если у вас есть несколько подписок Azure, то вы можете безопасно связывать рабочие нагрузки из разных подписок между виртуальными сетями.
  * Благодаря технологии защищенных сетей VPN в Azure для предприятий или поставщиков услуг возможен обмен данными между организациями.

См. дополнительные сведения в разделе с [часто задаваемыми вопросами о подключениях типа "виртуальная сеть — виртуальная сеть"](#faq) в конце этой статьи.

### <a name="before-you-begin"></a>Перед началом работы

Перед началом упражнения скачайте и установите последнюю версию командлетов PowerShell для управления службами Azure. Подробнее: [Установка и настройка Azure PowerShell](/powershell/azure/overview). Мы используем портал для большинства операций, но для создания подключений между виртуальными сетями нужно использовать PowerShell. Создать соединения с помощью портала Azure невозможно.

## <a name="plan"></a>Шаг 1. Планирование диапазонов IP-адресов

Важно определить диапазоны адресов, которые будут использоваться при настройке виртуальных сетей. При настройке необходимо убедиться в том, что никакие из диапазонов виртуальных сетей или диапазонов локальных сетей, к которым они подключены, никак не перекрываются между собой.

В таблице ниже показан пример определения виртуальных сетей. Используйте указанные диапазоны только в качестве примера. Запишите диапазоны для своих виртуальных сетей. Эти сведения будут необходимы для выполнения последующих действий.

**Пример**

| Виртуальная сеть | Пространство адресов | Регион | Подключается к сайту локальной сети |
|:--- |:--- |:--- |:--- |
| TestVNet1 |TestVNet1<br>(10.11.0.0/16)<br>(10.12.0.0/16) |Восток США |VNet4Local<br>(10.41.0.0/16)<br>(10.42.0.0/16) |
| TestVNet4 |TestVNet4<br>(10.41.0.0/16)<br>(10.42.0.0/16) |Запад США |VNet1Local<br>(10.11.0.0/16)<br>(10.12.0.0/16) |

## <a name="vnetvalues"></a>Шаг 2. Создание виртуальных сетей

Создайте две виртуальные сети на [портале Azure](https://portal.azure.com). Инструкции по созданию классических виртуальных сетей см. в [этой статье](../virtual-network/virtual-networks-create-vnet-classic-pportal.md). 

Если вы создаете классическую виртуальную сеть с помощью портала, открывайте страницу виртуальной сети с помощью приведенных ниже инструкций. В противном случае команда создания классической виртуальной сети не отобразится.

1. Нажмите кнопку "+", чтобы открыть страницу "Создать".
2. В поле "Поиск по Marketplace" введите запрос "Виртуальная сеть". Если вместо этого вы выберете "Сети" -> "Виртуальная сеть", команда создания классической виртуальной сети не отобразится.
3. Найдите в результатах поиска запись "Виртуальная сеть" и щелкните ее. Откроется страница "Виртуальная сеть". 
4. На странице виртуальной сети выберите "Классическая", чтобы создать классическую виртуальную сеть. 

Если вы используете эту статью в качестве упражнения, можно воспользоваться следующими примерами значений.

**Значения для TestVNet1**

Имя: TestVNet1<br>
Адресное пространство: 10.11.0.0/16, 10.12.0.0/16 (необязательно)<br>
Имя подсети: по умолчанию<br>
Диапазон адресов подсети: 10.11.0.1/24<br>
Группа ресурсов: ClassicRG<br>
Расположение: восточная часть США<br>
Подсеть шлюза: 10.11.1.0/27

**Значения для TestVNet4**

Имя: TestVNet4<br>
Адресное пространство: 10.41.0.0/16, 10.42.0.0/16 (необязательно)<br>
Имя подсети: по умолчанию<br>
Диапазон адресов подсети: 10.41.0.1/24<br>
Группа ресурсов: ClassicRG<br>
Расположение: Запад США<br>
Подсеть шлюза: 10.41.1.0/27

**При создании виртуальных сетей необходимо учитывать следующие параметры:**

* **Адресное пространство виртуальной сети.** На странице "Адресное пространство виртуальной сети" укажите диапазон адресов, который вы хотите использовать для виртуальной сети. Это динамические IP-адреса, которые будут назначаться виртуальным машинам и другим экземплярам ролей, развертываемым в этой виртуальной сети.<br>Выбранные адресные пространства не должны пересекаться с адресными пространствами других виртуальных сетей или локальных расположений, к которым будет подключена виртуальная сеть.

* **Расположение** — при создании виртуальную сеть можно связать с расположением Azure (регионом). Например, если вы хотите, чтобы ваши виртуальные машины разворачивались в виртуальной сети, которая физически расположена в западной части США, выберите это расположение. Нельзя изменить расположение, связанное с виртуальной сетью, после ее создания.

**После создания виртуальных сетей можно добавить следующие параметры:**

* **Адресное пространство.** Дополнительное адресное пространство не является обязательным для этой конфигурации, но его можно добавить после создания виртуальной сети.

* **Подсети.** Дополнительные подсети не требуются для этой конфигурации, но вам может понадобиться разместить виртуальные машины в подсети отдельно от других экземпляров ролей.

* **DNS-серверы.** Введите имя и IP-адрес DNS-сервера. Этот параметр не приводит к созданию DNS-сервера. Он позволяет указать DNS-сервер, который вы хотите использовать для разрешения имен в этой виртуальной сети.

В этом разделе рассматривается настройка типа соединения и локального сайта, а также создание шлюза.

## <a name="localsite"></a>Шаг 3. Настройка локального сайта

С помощью параметров, заданных в каждом сайте локальной сети, Azure определяет способ маршрутизации трафика между виртуальными сетями. Каждая виртуальная сеть должна указывать на соответствующую локальную сеть, в которую будет выполняться маршрутизация трафика. Укажите имена, которые будут использоваться для ссылки на каждый из сайтов локальной сети. Лучше всего использовать описательные имена.

Например, сеть TestVNet1 подключается к созданному вами сайту локальной сети с именем VNet4Local. Параметры VNet4Local содержат префиксы адресов TestVNet4.

Локальным сайтом каждой виртуальной сети является другая виртуальная сеть. Для этой конфигурации используются следующие примеры значений:

| Виртуальная сеть | Пространство адресов | Регион | Подключается к сайту локальной сети |
|:--- |:--- |:--- |:--- |
| TestVNet1 |TestVNet1<br>(10.11.0.0/16)<br>(10.12.0.0/16) |Восток США |VNet4Local<br>(10.41.0.0/16)<br>(10.42.0.0/16) |
| TestVNet4 |TestVNet4<br>(10.41.0.0/16)<br>(10.42.0.0/16) |Запад США |VNet1Local<br>(10.11.0.0/16)<br>(10.12.0.0/16) |

1. Найдите TestVNet1 на портале Azure. В разделе **VPN-подключения** щелкните **Шлюз**.

    ![Нет шлюза](./media/vpn-gateway-howto-vnet-vnet-portal-classic/nogateway.png)
2. На странице **Новое VPN-подключение** выберите **Сеть — сеть**.
3. Щелкните **Локальный сайт**, чтобы открыть страницу "Локальный сайт" и настроить параметры.
4. На странице **Локальный сайт** укажите имя локального сайта. В нашем примере имя локального сайта VNet4Local.
5. Для **IP-адреса VPN-шлюза** можно использовать любой необходимый вам IP-адрес, при условии, что он введен в правильном формате. Как правило, для VPN-устройства используется фактический внешний IP-адрес. Но для конфигурации "виртуальная сеть — виртуальная сеть" используется общедоступный IP-адрес, назначенный шлюзу для вашей виртуальной сети. Так как вы еще не создали шлюз виртуальной сети, укажите любой допустимый общедоступный IP-адрес в качестве заполнителя.<br>Не оставляйте это поле пустым, так как оно является обязательным для данной конфигурации. Позже вы вернетесь к этим параметрам и введете соответствующий IP-адрес шлюза виртуальной сети, после того, как Azure создаст его.
6. Для **адресного пространства клиента** используйте пространство адресов другой виртуальной сети. Просмотрите пример планирования. Щелкните **ОК**, чтобы сохранить параметры и вернуться на страницу **Новое VPN-подключение**.

    ![локальный сайт](./media/vpn-gateway-howto-vnet-vnet-portal-classic/localsite.png)

## <a name="gw"></a>Шаг 4. Создание шлюза виртуальной сети

В каждой виртуальной сети должен использоваться шлюз. Шлюз виртуальной сети направляет и шифрует трафик.

1. На странице **Новое VPN-подключение** установите флажок **Немедленно создать шлюз**.
2. Щелкните **Подсеть, размер, маршрут**. На странице **Настройка шлюза** щелкните **Подсеть**.
3. Имя подсети шлюза будет заполнено автоматически с требуемым именем GatewaySubnet. **Диапазон адресов** содержит IP-адреса, выделенные для служб VPN-шлюза. Некоторые конфигурации разрешают подсеть шлюза размера /29, но мы рекомендуем использовать /28 или /27 с учетом будущих конфигураций, которые могут потребовать дополнительных IP-адресов для служб шлюза. В нашем примере параметров используется подсеть шлюза 10.11.1.0/27. Настройте адресное пространство, а затем щелкните **ОК**.
4. Настройте **размер шлюза**. Этот параметр относится к [SKU шлюза](vpn-gateway-about-vpn-gateway-settings.md#gwsku).
5. Настройте **тип маршрутизации**. Тип маршрутизации для этой конфигурации должен содержать значение **Динамическая**. Вы не сможете изменить тип маршрутизации позже, пока шлюз не будет удален и создан.
6. Последовательно выберите **ОК**.
7. На странице **Новое VPN-подключение** щелкните **ОК**, чтобы создать шлюз виртуальной сети. Создание шлюза часто занимает 45 минут и более, в зависимости от выбранного SKU шлюза.

## <a name="vnet4settings"></a>Шаг 5. Настройка параметров TestVNet4

Повторите шаги, чтобы [создать локальный сайт](#localsite) и [шлюз виртуальной сети](#gw) для настройки TestVNet4, при необходимости заменив значения. При выполнении этих шагов в качестве упражнения используйте [примеры значений](#vnetvalues).

## <a name="updatelocal"></a>Шаг 6. Обновление локальных сайтов

После создания шлюзов виртуальной сети для обеих виртуальных сетей следует настроить локальные сайты для значений **IP-адреса VPN-шлюза**.

|Имя виртуальной сети|Подключенный сайт|IP-адрес шлюза|
|:--- |:--- |:--- |
|TestVNet1|VNet4Local|IP-адрес VPN-шлюза для TestVNet4|
|TestVNet4|VNet1Local|IP-адрес VPN-шлюза для TestVNet1|

### <a name="part-1---get-the-virtual-network-gateway-public-ip-address"></a>Часть 1. Получение общедоступного IP-адреса шлюза виртуальной сети

1. Найдите виртуальную сеть на портале Azure.
2. Щелкните, чтобы открыть страницу виртуальной сети **Обзор**. На странице **VPN-подключения** можно просмотреть IP-адрес шлюза виртуальной сети.

  ![Общедоступный IP-адрес](./media/vpn-gateway-howto-vnet-vnet-portal-classic/publicIP.png)
3. Скопируйте IP-адрес. Он понадобится в следующем разделе.
4. Повторите эти шаги для TestVNet4.

### <a name="part-2---modify-the-local-sites"></a>Часть 2. Изменение локальных сайтов

1. Найдите виртуальную сеть на портале Azure.
2. На странице виртуальной сети **Обзор** щелкните локальный сайт.

  ![Созданный локальный сайт](./media/vpn-gateway-howto-vnet-vnet-portal-classic/local.png)
3. На странице **VPN-подключения "сеть —сеть"** щелкните имя локального сайта, который требуется изменить.

  ![Открытие локального сайта](./media/vpn-gateway-howto-vnet-vnet-portal-classic/openlocal.png)
4. Щелкните **локальный сайт**, который необходимо изменить.

  ![изменение сайта](./media/vpn-gateway-howto-vnet-vnet-portal-classic/connections.png)
5. Обновите **IP-адрес VPN-шлюза** и щелкните **ОК** для сохранения настроек.

  ![IP-адрес шлюза](./media/vpn-gateway-howto-vnet-vnet-portal-classic/gwupdate.png)
6. Закройте другие страницы.
7. Повторите эти шаги для TestVNet4.

## <a name="getvalues"></a>Шаг 7. Получение значений из файла конфигурации сети

При создании классических виртуальных сетей на портале Azure имя, которое вы просматриваете, не является полным именем, используемым для PowerShell. Например, если виртуальная сеть отображается на портале с именем **TestVNet1**, то в файле конфигурации сети ее имя может быть гораздо длиннее. Это имя может выглядеть примерно следующим образом: **Group ClassicRG TestVNet1**. При создании подключений важно использовать значения, приведенные в файле конфигурации сети.

Выполняя следующие действия, вы подключитесь к учетной записи Azure, а также скачаете и просмотрите файл конфигурации сети для получения значений, необходимых для подключений.

1. Скачайте и установите последнюю версию командлетов PowerShell для управления службами Azure. Подробнее: [Установка и настройка Azure PowerShell](/powershell/azure/overview).

2. Откройте консоль PowerShell с повышенными правами и подключитесь к своей учетной записи. Для подключения используйте следующий пример кода:

  ```powershell
  Connect-AzureRmAccount
  ```

  Просмотрите подписки учетной записи.

  ```powershell
  Get-AzureRmSubscription
  ```

  При наличии нескольких подписок выберите подписку, которую вы хотите использовать.

  ```powershell
  Select-AzureRmSubscription -SubscriptionName "Replace_with_your_subscription_name"
  ```

  Затем воспользуйтесь следующим командлетом, чтобы добавить подписку Azure в PowerShell для классической модели развертывания.

  ```powershell
  Add-AzureAccount
  ```
3. Экспортируйте и просмотрите файл конфигурации сети. Создайте каталог на компьютере, а затем экспортируйте в него файл конфигурации сети. В этом примере файл конфигурации сети экспортируется в каталог **C:\AzureNet**.

  ```powershell
  Get-AzureVNetConfig -ExportToFile C:\AzureNet\NetworkConfig.xml
  ```
4. Откройте файл в текстовом редакторе и просмотрите имена для виртуальных сетей и сайтов. Это будут имена, использующиеся при создании подключений.<br>Имена виртуальных сетей перечислены как **VirtualNetworkSite name =**.<br>Имена сайтов перечислены как **LocalNetworkSiteRef name =**.

## <a name="createconnections"></a>Шаг 8. Создание подключений VPN-шлюза

После завершения всех предыдущих шагов можно задать общие ключи IPsec/IKE и создать подключение. Для этого набора действий используется только PowerShell. Подключения типа "виртуальная сеть — виртуальная сеть" для классической модели развертывания невозможно настроить на портале Azure.

Обратите внимание, что в приведенных ниже примерах общий ключ совпадает. Общий ключ всегда должен совпадать. Обязательно замените значения в этих примерах на точные имена для виртуальных сетей и сайтов локальной сети.

1. Создайте подключение между TestVNet1 и TestVNet4.

  ```powershell
  Set-AzureVNetGatewayKey -VNetName 'Group ClassicRG TestVNet1' `
  -LocalNetworkSiteName '17BE5E2C_VNet4Local' -SharedKey A1b2C3D4
  ```
2. Создайте подключение между TestVNet4 и TestVNet1.

  ```powershell
  Set-AzureVNetGatewayKey -VNetName 'Group ClassicRG TestVNet4' `
  -LocalNetworkSiteName 'F7F7BFC7_VNet1Local' -SharedKey A1b2C3D4
  ```
3. Ожидание подключений для инициализации. После инициализации шлюза для состояния будет установлено значение "Успешно".

  ```
  Error          :
  HttpStatusCode : OK
  Id             :
  Status         : Successful
  RequestId      :
  StatusCode     : OK
  ```

## <a name="faq"></a>Рекомендации по работе с подключением типа "виртуальная сеть — виртуальная сеть" для классических виртуальных сетей
* Виртуальные сети могут быть в одной или разных подписках.
* Виртуальные сети могут быть в одном или разных регионах (расположениях) Azure.
* Облачная служба или конечная точка балансировки нагрузки не может распространяться на виртуальные сети, даже если они соединены друг с другом.
* Для подключения нескольких виртуальных сетей друг к другу не требуются VPN-устройства.
* Подключения между виртуальными сетями поддерживает подключение виртуальных сетей Azure. Не поддерживается подключение виртуальных машин или облачных служб, не развернутых в виртуальной сети.
* Для подключения "виртуальная сеть — виртуальная сеть" требуются шлюзы с динамической маршрутизацией. Шлюзы Azure со статической маршрутизацией не поддерживаются.
* Подключение к виртуальной сети можно использовать одновременно с многосайтовыми VPN-подключениями. Можно использовать до 10 туннелей VPN для подключения VPN-шлюза виртуальной сети к другим виртуальным сетям или локальным сайтам.
* Адресные пространства виртуальных сетей и местных сайтов локальных сетей не должны перекрываться. Перекрытие адресных пространств приведет к сбою при создании виртуальных сетей или отправке файлов конфигурации netcfg.
* Избыточные туннели между парой виртуальных сетей не поддерживаются.
* Все туннели VPN виртуальной сети, включая VPN-подключения типа "точка — сеть", совместно используют доступную пропускную способность VPN-шлюза Azure и регулируются одним соглашением об уровне обслуживания, определяющим время работы VPN-шлюзов в Azure.
* Трафик между виртуальными сетями проходит через магистральную сеть Azure.

## <a name="next-steps"></a>Дополнительная информация
Проверьте подключения. Дополнительные сведения см. в статье [Проверка подключения VPN-шлюза](vpn-gateway-verify-connection-resource-manager.md).
