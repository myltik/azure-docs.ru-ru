---
title: Подробное руководство по устранению неполадок с удаленным рабочим столом в Azure | Документация Майкрософт
description: Подробное руководство по устранению неполадок с удаленным рабочим столом, не позволяющих подключиться к виртуальным машинам Windows в Azure
services: virtual-machines-windows
documentationcenter: ''
author: genlin
manager: jeconnoc
editor: ''
tags: top-support-issue,azure-service-management,azure-resource-manager
keywords: не удается подключиться к удаленному рабочему столу, устранение неполадок удаленного рабочего стола, удаленному рабочему столу не удается подключиться, ошибки удаленного рабочего стола, устранение неполадок удаленного рабочего стола, проблемы удаленного рабочего стола
ms.assetid: 9da36f3d-30dd-44af-824b-8ce5ef07e5e0
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: troubleshooting
ms.date: 05/11/2018
ms.author: genli
ms.openlocfilehash: ab101d78320819b9fb48f2c431fb0f6afdb895ec
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34657831"
---
# <a name="detailed-troubleshooting-steps-for-remote-desktop-connection-issues-to-windows-vms-in-azure"></a>Подробное руководство по устранению неполадок с подключением к удаленному рабочему столу на виртуальной машине Windows в Azure
В этой статье приводятся подробные инструкции по диагностике и устранению сложных ошибок удаленного рабочего стола для виртуальных машин Azure на базе Windows.

> [!IMPORTANT]
> Чтобы устранить более распространенные ошибки удаленного рабочего стола, обязательно ознакомьтесь с [основными способами устранения неполадок удаленного рабочего стола](troubleshoot-rdp-connection.md), прежде чем продолжить.

Вам может встретиться сообщение об ошибке удаленного рабочего стола, не похожее ни на одно из сообщений, описанных в статье [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md). Выполните следующие действия, чтобы определить, почему клиент удаленного рабочего стола (RDP) не может подключиться к службе удаленного рабочего стола на виртуальной машине Azure.

[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

Если вам потребуется дополнительная помощь по любому из вопросов, рассматриваемых в статье, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](https://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [веб-сайт поддержки Azure](https://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**. Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](https://azure.microsoft.com/support/faq/).

## <a name="components-of-a-remote-desktop-connection"></a>Компоненты подключения к удаленному рабочему столу
В подключении к удаленному рабочему столу участвуют следующие компоненты:

![](./media/detailed-troubleshoot-rdp/tshootrdp_0.png)

Прежде чем продолжить, проанализируйте, что изменилось с последнего успешного подключения удаленного рабочего стола к виртуальной машине. Например: 

* Изменен общедоступный IP-адрес виртуальной машины или облачной службы, в которой находится виртуальная машина (также называется [виртуальным IP-адресом](https://en.wikipedia.org/wiki/Virtual_IP_address)). Сбой подключения к удаленному рабочему столу может быть связан с тем, что в кэше DNS-клиента сохранился *старый IP-адрес* . Очистите кэш DNS-клиента и попробуйте подключиться к виртуальной машине еще раз. Либо попробуйте подключиться напрямую по новому виртуальному IP-адресу.
* Вы используете стороннее приложение для управления подключениями к удаленному рабочему столу вместо стандартного подключения, созданного на портале Azure. Убедитесь, что конфигурация приложения содержит правильный TCP-порт для трафика удаленного рабочего стола. Чтобы узнать номер порта для классической виртуальной машины на [портале Azure](https://portal.azure.com), на виртуальной машине щелкните "Параметры" и выберите пункт "Конечные точки".

## <a name="preliminary-steps"></a>Предварительные действия
Прежде чем перейти к подробной диагностике, выполните следующие действия:

* Проверьте состояние виртуальной машины на портале Azure на наличие очевидных проблем.
* Выполните [процедуры быстрого устранения ошибок протокола удаленного рабочего стола, описанные в руководстве по устранению неполадок](troubleshoot-rdp-connection.md#quick-troubleshooting-steps).
* Для пользовательских образов виртуальный диск VHD следует правильно подготовить перед отправкой. Дополнительные сведения см. в руководстве по [подготовке диска VHD или VHDX для Windows к отправке в Azure](prepare-for-upload-vhd-image.md).


Выполнив эти действия, попробуйте заново подключиться к виртуальной машине через удаленный рабочий стол.

## <a name="detailed-troubleshooting-steps"></a>Подробное описание устранения неполадок
Возможно, клиенту удаленного рабочего стола не удалось подключиться к службе удаленных рабочих столов на виртуальной машине Azure из-за проблем в перечисленных ниже источниках:

* [Компьютер с клиентом удаленного рабочего стола](#source-1-remote-desktop-client-computer)
* [Пограничное устройство интрасети организации](#source-2-organization-intranet-edge-device)
* [Конечная точка облачной службы и список управления доступом (ACL)](#source-3-cloud-service-endpoint-and-acl)
* [Группы безопасности сети](#source-4-network-security-groups)
* [Виртуальная машина Azure под управлением Windows](#source-5-windows-based-azure-vm)

## <a name="source-1-remote-desktop-client-computer"></a>Источник 1: компьютер с клиентом удаленного рабочего стола
Убедитесь, что ваш компьютер способен устанавливать подключения к удаленному рабочему столу на другом локальном компьютере под управлением Windows.

![](./media/detailed-troubleshoot-rdp/tshootrdp_1.png)

Если это не так, проверьте следующие настройки на компьютере.

* Настройки локального брандмауэра, которые могут блокировать обмен данными с удаленным рабочим столом.
* Наличие локального программного обеспечения с функциями прокси-сервера, которое не позволяет установить подключение к удаленному рабочему столу.
* Наличие локального программного обеспечения для мониторинга сети, которое не позволяет установить подключение к удаленному рабочему столу.
* Наличие других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов, поэтому могут блокировать подключение к удаленному рабочему столу.

В любом из перечисленных выше случаев временно отключите соответствующее программное обеспечение и попробуйте установить соединение с локальным компьютером через удаленный рабочий стол. Если это не помогло вам найти причину, обратитесь к администратору сети и измените параметры программного обеспечения таким образом, чтобы оно не блокировало подключения к удаленным рабочим столам.

## <a name="source-2-organization-intranet-edge-device"></a>Источник 2: пограничное устройство интрасети организации
Убедитесь, что компьютер, подключенный непосредственно к Интернету, способен устанавливать подключения удаленного рабочего стола к виртуальной машине Azure.

![](./media/detailed-troubleshoot-rdp/tshootrdp_2.png)

Если у вас нет такого компьютера, создайте и протестируйте новую виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе. Дополнительные сведения см. в статье [Создание виртуальной машины Windows в среде Azure](../virtual-machines-windows-hero-tutorial.md). По завершении проверки удалите виртуальную машину и группу ресурсов или облачную службу.

Если вам удается установить соединение с удаленным рабочим столом с компьютера, непосредственно подключенного к Интернету, проверьте, нет ли на пограничном устройстве интрасети вашей организации:

* интернет-брандмауэра, который блокирует подключения к Интернету по протоколу HTTPS;
* прокси-сервера, который не позволяет установить подключение к удаленному рабочему столу;
* программного обеспечения для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует подключения к удаленным рабочим столам.

При помощи администратора сети измените параметры пограничного устройства интрасети вашей организации таким образом, чтобы оно не блокировало HTTPS-подключения к удаленным рабочим столам через Интернет.

## <a name="source-3-cloud-service-endpoint-and-acl"></a>Источник 3: конечная точка облачной службы и список управления доступом (ACL)
Если виртуальная машина создана с помощью классической модели развертывания, убедитесь, что другая виртуальная машина Azure, которая находится в той же облачной службе или виртуальной сети, может устанавливать подключения к удаленному рабочему столу на вашей виртуальной машине Azure.

![](./media/detailed-troubleshoot-rdp/tshootrdp_3.png)

> [!NOTE]
> Для виртуальных машин, созданных в Resource Manager, см. раздел [Источник 4: группы безопасности сети](#source-4-network-security-groups).

Если у вас нет другой виртуальной машины в той же облачной службе или виртуальной сети, создайте ее. Для этого выполните действия, описанные в статье [Создание первой виртуальной машины Windows на портале Azure](../virtual-machines-windows-hero-tutorial.md). По завершении теста удалите тестовую виртуальную машину.

Если вам удается подключиться к удаленному рабочему столу на виртуальной машине в той же облачной службе или виртуальной сети, проверьте перечисленные ниже компоненты.

* Конфигурация конечной точки для трафика удаленного рабочего стола на целевой виртуальной машине: частный TCP-порт конечной точки должен совпадать с TCP-портом, который используется для прослушивания службы удаленных рабочих столов для виртуальных машин (по умолчанию — 3389).
* Список управления доступом на конечной точке для обмена данными с удаленным рабочим столом на целевой виртуальной машине: позволяет разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если он неправильно настроен, входящие данные с удаленного рабочего стола на эту конечную точку могут блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в статье [Список управления доступом (ACL) конечной точки](../../virtual-network/virtual-networks-acl.md).

Чтобы устранить конечную точку из числа потенциальных источников проблемы, удалите ее и создайте новую, выбрав в качестве номера внешнего порта любой порт в диапазоне от 49152 до 65535. Дополнительные сведения см. в статье [Настройка конечных точек виртуальной машины](classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).

## <a name="source-4-network-security-groups"></a>Источник 4: группы безопасности сети
Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure.

Используйте [проверку потока для IP-адреса](../../network-watcher/network-watcher-check-ip-flow-verify-portal.md), чтобы определить, блокирует ли правило в группе безопасности сети входящий или исходящий трафик виртуальной машины. Вы можете также просмотреть действующие правила группы безопасности и убедиться, что для порта RDP (3389 по умолчанию) существует и является приоритетным правило NSG, разрешающее входящий трафик. См. дополнительные сведения об [использовании действующих правил безопасности для устранения проблем с потоком трафика в виртуальной машине](../../virtual-network/diagnose-network-traffic-filter-problem.md).

## <a name="source-5-windows-based-azure-vm"></a>Источник 5: виртуальная машина Azure под управлением Windows
![](./media/detailed-troubleshoot-rdp/tshootrdp_5.png)

Следуйте инструкциям в [этой статье](reset-rdp.md). В ней объясняется, как вернуть службу удаленного рабочего стола на виртуальной машине в исходное состояние.

* будет включено правило по умолчанию «Удаленный рабочий стол» в брандмауэре Windows (TCP-порт 3389);
* будут разрешены подключения к удаленным рабочим столам в реестре (для параметра HKLM\System\CurrentControlSet\Control\Terminal Server\fDenyTSConnections будет установлено значение 0).

Попытайтесь снова установить подключение со своего компьютера. Если установить подключение через виртуальный рабочий стол по-прежнему не удается, проверьте наличие следующих проблем:

* На целевой виртуальной машине не запущена служба удаленных рабочих столов.
* Служба удаленных рабочих столов не прослушивается через TCP-порт 3389.
* В брандмауэре Windows или другом локальном брандмауэре есть правило для исходящего трафика, блокирующее трафик удаленных рабочих столов.
* Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует подключения к удаленным рабочим столам.

Для виртуальных машин, созданных по классической модели развертывания, можно использовать удаленный сеанс Azure PowerShell на виртуальной машине Azure. Сначала нужно установить сертификат для доступа к облачной службе, в которой размещена виртуальная машина. Откройте страницу [Configure Secure Remote PowerShell Access to Windows Azure Virtual Machines](http://gallery.technet.microsoft.com/scriptcenter/Configures-Secure-Remote-b137f2fe) (Настройка защищенного удаленного доступа PowerShell к виртуальным машинам Azure) и скачайте файл сценария **InstallWinRMCertAzureVM.ps1** на локальный компьютер.

Затем установите Azure PowerShell, если еще не сделали этого. Ознакомьтесь со статьей [Установка и настройка Azure PowerShell](/powershell/azure/overview).

Затем откройте командную строку Azure PowerShell и перейдите из текущей папки в папку с файлом сценария **InstallWinRMCertAzureVM.ps1**. Для запуска сценария Azure PowerShell необходимо задать правильную политику выполнения. Выполните команду **Get-ExecutionPolicy**, чтобы определить текущий уровень политики. Инструкции по выбору подходящего уровня см. в описании команды [Set-ExecutionPolicy](https://technet.microsoft.com/library/hh849812.aspx).

Затем введите имя своей подписки Azure, имя облачной службы и имя виртуальной машины (удалив знаки "<" и ">"). После этого выполните следующие команды.

```powershell
$subscr="<Name of your Azure subscription>"
$serviceName="<Name of the cloud service that contains the target virtual machine>"
$vmName="<Name of the target virtual machine>"
.\InstallWinRMCertAzureVM.ps1 -SubscriptionName $subscr -ServiceName $serviceName -Name $vmName
```

Правильное имя подписки можно получить из свойства *SubscriptionName* в выходных данных команды **Get-AzureSubscription**. Имя облачной службы для виртуальной машины можно получить из столбца *ServiceName* в выходных данных команды **Get-AzureVM**.

Убедитесь, что используется новый сертификат. Для этого откройте оснастку "Сертификаты" для текущего пользователя и просмотрите папку **Доверенные корневые центры сертификации\Сертификаты**. Там должен быть сертификат с DNS-именем вашей облачной службы в столбце получателя (пример: cloudservice4testing.cloudapp.net).

Затем инициируйте удаленный сеанс Azure PowerShell с помощью следующих команд.

```powershell
$uri = Get-AzureWinRMUri -ServiceName $serviceName -Name $vmName
$creds = Get-Credential
Enter-PSSession -ConnectionUri $uri -Credential $creds
```

Указав действительные учетные данные администратора, вы должны увидеть в командной строке Azure PowerShell примерно следующее:

```powershell
[cloudservice4testing.cloudapp.net]: PS C:\Users\User1\Documents>
```

Первая часть строки — это имя облачной службы, в которой находится целевая виртуальная машина (может отличаться от "cloudservice4testing.cloudapp.net"). Теперь можно выполнить команды Azure PowerShell для этой облачной службы, чтобы проанализировать перечисленные выше проблемы и исправить конфигурацию.

### <a name="to-manually-correct-the-remote-desktop-services-listening-tcp-port"></a>Изменение вручную TCP-порта прослушивания служб удаленных рабочих столов
Выполните приведенную команду в командной строке удаленного сеанса Azure PowerShell.

```powershell
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"
```

Свойство PortNumber содержит текущий номер порта. При необходимости вы можете восстановить номер порта удаленного рабочего стола по умолчанию (3389) с помощью следующей команды:

```powershell
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber" -Value 3389
```

Убедитесь в том, что номер порта изменен на 3389, с помощью следующей команды:

```powershell
Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "PortNumber"
```

Закройте удаленный сеанс Azure PowerShell с помощью этой команды:

```powershell
Exit-PSSession
```

Также убедитесь в том, что на конечной точке удаленного рабочего стола для виртуальной машины Azure в качестве внутреннего порта задан TCP-порт 3398. Перезапустите виртуальную машину Azure и попробуйте установить подключение к удаленному рабочему столу еще раз.

## <a name="additional-resources"></a>Дополнительные ресурсы
[Сброс пароля или службы удаленных рабочих столов для виртуальных машин Windows](reset-rdp.md)

[Как установить и настроить Azure PowerShell](/powershell/azure/overview)

[Устранение неполадок с подключением Secure Shell (SSH) к виртуальной машине Azure под управлением Linux](../linux/troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

[Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](../linux/troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json)

