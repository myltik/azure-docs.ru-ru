---
title: Устранение проблем на виртуальной машине Azure с помощью вложенной виртуализации в Azure | Документация Майкрософт
description: Узнайте, как устранить проблемы на виртуальной машине Azure с помощью вложенной виртуализации в Azure
services: virtual-machines-windows
documentationcenter: ''
author: glimoli
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 04/06/2018
ms.author: genli
ms.openlocfilehash: 9026b702e6e0d27817955c70c733bf372005dd4b
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
ms.locfileid: "31422820"
---
# <a name="troubleshoot-a-problem-azure-vm-by-using-nested-virtualization-in-azure"></a>Устранение проблем на виртуальной машине Azure с помощью вложенной виртуализации в Azure

В этой статье описывается, как создать среду вложенной виртуализации в Microsoft Azure, чтобы можно было подключить диск виртуальной машины с неполадками на узле Hyper-V (виртуальная машина спасение) для устранения неполадок.

## <a name="prerequisites"></a>предварительным требованиям

Чтобы подключить виртуальную машину, на которой имеются неполадки, виртуальная машина спасения должна отвечать следующим требованиям:

-   виртуальная машина спасения должна находиться в том же расположении, что и виртуальная машина, на которой нужно устранить проблемы;

-   виртуальная машина спасения должна находиться в той же группе ресурсов, что и виртуальная машина, на которой нужно устранить проблемы;

-   для виртуальной машины спасения должен использоваться тот же тип учетной записи хранения (уровня "Стандартный" или "Премиум"), что и для виртуальной машины, на которой нужно устранить проблемы.

## <a name="step-1-create-a-rescue-vm-and-install-hyper-v-role"></a>Шаг 1. Создание виртуальной машины спасения и настройка роли Hyper-V

1.  Создайте новую виртуальную машину спасения:

    -  С операционной системой Windows Server 2016 Datacenter.

    -  Любого размера из серии V3 как минимум с двумя ядрами, поддерживающими вложенную виртуализацию. Дополнительные сведения см. в записи блога, посвященной [обзору новых размеров виртуальных машин Dv3 и Ev3](https://azure.microsoft.com/blog/introducing-the-new-dv3-and-ev3-vm-sizes/).

    -  В том же расположении, что и виртуальная машина, на которой нужно устранить проблемы, а также в той же учетной записи хранения и группе ресурсов.

    -  Выберите тот же тип хранилища, что и у виртуальной машины, на которой нужно устранить проблемы (хранилище класса Standard или Premium).

2.  После создания виртуальной машины спасения установите к ней подключение удаленного рабочего стола.

3.  В диспетчере сервера выберите **Управление** > **Добавить роли и компоненты**.

4.  В разделе **Тип установки** выберите **Установка ролей или компонентов**.

5.  В разделе **Выбор целевого сервера** выберите виртуальную машину спасения.

6.  Выберите **Роль Hyper-V** > **Добавить компоненты**.

7.  Нажмите кнопку **Далее** в разделе **Компоненты**.

8.  Если доступен виртуальный коммутатор, выберите его. В противном случае нажмите кнопку **Далее**.

9.  В разделе **Миграция** нажмите кнопку **Далее**.

10. В разделе **Хранилища по умолчанию** нажмите кнопку **Далее**.

11. Установите флажок, чтобы при необходимости автоматически перезапустить сервер.

12. Щелкните **Установить**.

13. Сервер установит роль Hyper-V. Это займет несколько минут, после чего он автоматически перезагрузится.

## <a name="step-2-create-the-problem-vm-on-the-rescue-vms-hyper-v-server"></a>Шаг 2. Создание виртуальной машины, на которой имеются проблемы, на сервере Hyper-V виртуальной машины спасения

1.  Запишите имя диска на проблемной виртуальной машине, а затем удалите ее. Проверьте наличие всех подключенных дисков. 

2.  Подключите диск операционной системы проблемной виртуальной машины как диск данных виртуальной машины спасения.

    1.  После удаления проблемной виртуальной машины перейдите к виртуальной машине спасения.

    2.  Щелкните **Диски**, а затем выберите **Добавить диск данных**.

    3.  Выберите диск проблемной виртуальной машины, а затем нажмите кнопку **Сохранить**.

3.  После успешного подключения диска установите подключение удаленного рабочего стола к виртуальной машине спасения.

4.  Откройте управление дисками (diskmgmt.msc). Задайте для диска проблемной виртуальной машины значение **Отключен**.

5.  Откройте диспетчер Hyper-V. В **диспетчере сервера** выберите **роль Hyper-V**. Щелкните сервер правой кнопкой мыши, а затем выберите **Диспетчер Hyper-V**.

6.  В диспетчере Hyper-V щелкните правой кнопкой мыши виртуальную машину спасения, а затем выберите **Создать** > **Виртуальная машина** > **Далее**.

7.  Введите имя виртуальной машины, а затем нажмите кнопку **Далее**.

8.  Выберите **Поколение 1**.

9.  Для параметра "Память при запуске" задайте значение от 1024 МБ.

10. Выберите созданный сетевой коммутатор Hyper-V, если это возможно. В противном случае перейдите к следующей странице.

11. Выберите **Подключить виртуальный жесткий диск позднее**.

    ![рисунок выбора параметра "Подключить виртуальный жесткий диск позднее"](./media/troubleshoot-vm-by-use-nested-virtualization/attach-disk-later.png)

12. После создания виртуальной машины нажмите кнопку **Готово**.

13. Щелкните правой кнопкой мыши созданную виртуальную машину, а затем выберите **Параметры**.

14. Выберите **Контроллер 0 IDE**, **Жесткий диск**, а затем нажмите кнопку **Добавить**.

    ![рисунок добавления нового жесткого диска](./media/troubleshoot-vm-by-use-nested-virtualization/create-new-drive.png)    

15. В разделе **Физический жесткий диск** выберите диск проблемной виртуальной машины, подключенный к виртуальной машине Azure. Если диски в списке отсутствуют, с помощью параметра "Управление дисками" проверьте заданное состояние для диска ("Отключен").

    ![рисунок с параметрами подключения диска](./media/troubleshoot-vm-by-use-nested-virtualization/mount-disk.png)  


17. Нажмите кнопку **Apply** (Применить), а затем нажмите кнопку **ОК**.

18. Дважды щелкните виртуальную машину, а затем запустите ее.

19. Теперь вы можете работать на этой виртуальной машине как на локальной и выполнить необходимые действия по устранению неполадок.

## <a name="step-3-re-create-your-azure-vm-in-azure"></a>Шаг 3. Повторное создание виртуальной машины Azure в Azure

1.  После возвращения виртуальной машины в оперативный режим завершите ее работу в диспетчере Hyper-V.

2.  Перейдите на [портал Azure](https://portal.azure.com), выберите виртуальную машину спасения, щелкните "Диски", а затем скопируйте имя диска. Вы используете его на следующем шаге. Отсоедините диск фиксированного размера на виртуальной машине спасения.

3.  Выберите **Все ресурсы**, выполните запрос по имени диска, а затем выберите его.

     ![изображение поиска диска](./media/troubleshoot-vm-by-use-nested-virtualization/search-disk.png)     

4. Нажмите кнопку **Создать виртуальную машину**.

     ![изображение создания виртуальной машины с диска](./media/troubleshoot-vm-by-use-nested-virtualization/create-vm-from-vhd.png) 

Чтобы создать виртуальную машину с диска, вы можете также использовать Azure PowerShell. Дополнительные сведения см. в разделе [Создание виртуальной машины](create-vm-specialized.md#create-the-new-vm). 

## <a name="next-steps"></a>Дополнительная информация

При возникновении проблем с подключением к виртуальной машине ознакомьтесь со статьей [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md). Для устранения проблем с доступом к приложениям, выполняющимся на виртуальной машине, прочитайте статью [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](troubleshoot-app-connection.md).
