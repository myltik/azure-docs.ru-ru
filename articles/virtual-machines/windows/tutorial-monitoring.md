---
title: Руководство. Мониторинг и обновление виртуальных машин Windows в Azure | Документация Майкрософт
description: В этом руководство описано, как выполнять мониторинг и диагностических данных загрузки, метрик производительности и администрирование пакетных обновлений на виртуальных машинах Windows.
services: virtual-machines-windows
documentationcenter: virtual-machines
author: iainfoulds
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 05/04/2017
ms.author: iainfou
ms.custom: mvc
ms.openlocfilehash: 9181d79e6eb0443a4607824cfde95068b509a917
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
---
# <a name="tutorial-monitor-and-update-a-windows-virtual-machine-in-azure"></a>Руководство. Мониторинг и обновление виртуальных машин Windows в Azure

Служба мониторинга Azure использует агенты для сбора данных о производительности и загрузке с виртуальных машин Azure, сохраняет эти данные в хранилище Azure и предоставляет к ним доступ через портал, модуль Azure PowerShell и Azure CLI. Управление обновлениями позволяет управлять обновлениями и исправлениями виртуальных машин Azure под управлением Windows.

Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Включение диагностики загрузки на виртуальной машине
> * Просмотр диагностики загрузки
> * Просмотр метрик узла виртуальной машины
> * Установка расширения системы диагностики
> * Просмотр метрик виртуальной машины
> * Создание оповещения
> * Управление обновлениями Windows
> * Мониторинг изменений и инвентаризация
> * Настройка расширенного мониторинга

Для работы с этим руководством требуется модуль Azure PowerShell версии 5.7.0 и выше. Чтобы узнать версию, выполните команду `Get-Module -ListAvailable AzureRM`. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке модуля Azure PowerShell](/powershell/azure/install-azurerm-ps).

## <a name="create-virtual-machine"></a>Создание виртуальной машины

Чтобы настроить мониторинг Azure и администрировать обновления для работы с этим руководством, вам понадобится виртуальная машина Windows в Azure. Сначала укажите имя и пароль администратора для виртуальной машины с помощью командлета [Get-Credential](https://msdn.microsoft.com/powershell/reference/5.1/microsoft.powershell.security/Get-Credential):

```azurepowershell-interactive
$cred = Get-Credential
```

Создайте виртуальную машину с помощью командлета [New-AzureRmVM](/powershell/module/azurerm.compute/new-azurermvm). В следующем примере создается виртуальная машина с именем *myVM* в расположении *EastUS*. При необходимости будут созданы поддерживающие сетевые ресурсы и группа доступности *myResourceGroupMonitorMonitor*.

```azurepowershell-interactive
New-AzureRmVm `
    -ResourceGroupName "myResourceGroupMonitor" `
    -Name "myVM" `
    -Location "East US" `
    -Credential $cred
```

Создание этих ресурсов и виртуальной машины может занять несколько минут.

## <a name="view-boot-diagnostics"></a>Просмотр диагностики загрузки

При загрузке виртуальных машин Windows агент диагностики загрузки записывает выходные данные на экране, которые можно использовать в целях устранения неполадок. Эта возможность включена по умолчанию. Записанные снимки экрана сохраняются в учетной записи хранения Azure, которая также создается по умолчанию.

Данные диагностики загрузки можно получить с помощью команды [Get AzureRmVMBootDiagnosticsData](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmbootdiagnosticsdata). В следующем примере данные диагностики загрузки загружаются в корень диска *c:\*.

```powershell
Get-AzureRmVMBootDiagnosticsData -ResourceGroupName "myResourceGroupMonitor" -Name "myVM" -Windows -LocalPath "c:\"
```

## <a name="view-host-metrics"></a>Просмотр метрик узла.

Виртуальная машина Windows имеет выделенный узел виртуальной машины в Azure, с которым она взаимодействует. Метрики узла собираются автоматически, и их можно просмотреть на портале Azure.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
2. Чтобы просмотреть данные о производительности узла виртуальной машины, в колонке виртуальной машины щелкните **Метрики**, а затем выберите любую метрику узла в группе **Доступные метрики**.

    ![Просмотр метрик узла.](./media/tutorial-monitoring/tutorial-monitor-host-metrics.png)

## <a name="install-diagnostics-extension"></a>Установка расширения диагностики

По умолчанию доступны основные метрики узла. Чтобы просмотреть более детальные метрики определенной виртуальной машины, требуется установить расширение системы диагностики Azure, позволяющее получать дополнительные данные мониторинга и диагностики виртуальной машины. С помощью этих метрик производительности можно создать уведомления с учетом работы виртуальной машины. Расширение системы диагностики устанавливается на портале Azure следующим образом:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
2. Щелкните **Параметры диагностики**. В списке будет указано, что *диагностика загрузки* уже включена в предыдущем разделе. Установите флажок для параметра *Базовые метрики*.
3. Нажмите кнопку **Включить мониторинг на гостевом уровне**.

    ![Просмотр метрик диагностики](./media/tutorial-monitoring/enable-diagnostics-extension.png)

## <a name="view-vm-metrics"></a>Просмотр метрик виртуальной машины.

Метрики виртуальной машины можно просмотреть аналогично метрикам узла виртуальной машины:

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
2. Чтобы увидеть, как работает виртуальная машина, в колонке виртуальной машины щелкните **Метрики**, затем выберите любую метрику диагностики в группе **Доступные метрики**.

    ![Просмотр метрик виртуальной машины.](./media/tutorial-monitoring/monitor-vm-metrics.png)

## <a name="create-alerts"></a>Создание оповещений

На основе метрик производительности можно создавать оповещения. Например, оповещения можно использовать для уведомления о том, что средняя загрузка ЦП превышает пороговое значение или свободное место на диске ниже определенного значения. Оповещения отображаются на портале Azure или могут быть отправлены по электронной почте. Вы также можете активировать модули Runbook службы автоматизации Azure или Azure Logic Apps в ответ на создаваемые оповещения.

В следующем примере создается предупреждение на основе среднего показателя использования ЦП.

1. На портале Azure щелкните **Группы ресурсов**, выберите **myResourceGroupMonitor**, а затем в списке ресурсов выберите **myVM**.
2. В колонке виртуальной машины щелкните **Правила оповещения**, а затем выберите **Добавить оповещение метрики**.
3. Укажите **имя** оповещения, например *myAlertRule*.
4. Для активации оповещения о превышении процента использования ЦП на 1.0 в течение пяти минут оставьте все настройки по умолчанию.
5. При необходимости установите флажок возле параметра *Участники, читатели и владельцы электронной почты* для отправки уведомлений по электронной почте. Действие по умолчанию — предоставлять уведомления на портале.
6. Нажмите кнопку **ОК**.

## <a name="manage-windows-updates"></a>Управление обновлениями Windows

Управление обновлениями позволяет управлять обновлениями и исправлениями виртуальных машин Azure под управлением Windows.
Напрямую из виртуальной машины можно быстро оценить состояние доступных обновлений, назначить время установки необходимых обновлений и проверить результаты развертывания, чтобы убедиться, что обновления на виртуальной машине были успешно применены.

Сведения о ценах см. на странице [цены на службу автоматизации](https://azure.microsoft.com/pricing/details/automation/).

### <a name="enable-update-management"></a>Включение управления обновлениями

Включение управления обновлениями для виртуальной машины:

1. В левой части экрана выберите **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На экране виртуальной машины в разделе **Операции** щелкните **Управление обновлениями**. Откроется экран **Enable Update management** (Включение управления обновлениями).

Проверка выполняется, чтобы определить, включено ли управление обновлениями для этой виртуальной машины.
При этом проверяется рабочее пространство Log Analytics и связанная учетная запись службы автоматизации, а также наличие решения в рабочей области.

Рабочая область [Log Analytics](../../log-analytics/log-analytics-overview.md) используется для сбора данных, созданных компонентами и службами, такими как "Управление обновлениями".
Рабочая область предоставляет единое расположение для проверки и анализа данных из нескольких источников.
Для выполнения дополнительных действий на виртуальных машинах, требующих обновления, служба автоматизации Azure позволяет выполнять runbook на виртуальных машинах, например для скачивания и применения обновлений.

В процессе проверки также определяется, была ли виртуальная машина подготовлена с помощью Microsoft Monitoring Agent (MMA) и гибридной рабочей роли службы автоматизации.
Агент позволяет взаимодействовать с виртуальной машиной и получать сведения о состоянии обновления.

Чтобы включить решение, выберите рабочую область Log Analytics и учетную запись службы автоматизации, а затем щелкните **Включить**. Процесс включения решения может занять до 15 минут.

Если во время подключения обнаружится, что отсутствует один из следующих компонентов, он будет автоматически добавлен.

* [Рабочая область Log Analytics](../../log-analytics/log-analytics-overview.md).
* [Автоматизация](../../automation/automation-offering-get-started.md)
* [Гибридная рабочая роль runbook](../../automation/automation-hybrid-runbook-worker.md) включена на виртуальной машине.

Откроется экран **Управление обновлениями**. Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем нажмите кнопку **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации.

![Включение решения по управлению обновлениями](./media/tutorial-monitoring/manageupdates-update-enable.png)

Включение решения может занять до 15 минут. В это время не закрывайте окно браузера. После включения решения сведения об отсутствующих обновлениях на виртуальной машине передаются в Log Analytics. На получение данных для анализа может уйти от 30 минут до 6 часов.

### <a name="view-update-assessment"></a>Просмотр оценок обновления

После включения решения **Управление обновлениями** отобразится экран **Управление обновлениями**. После оценки обновлений вы увидите список отсутствующих обновлений на вкладке **Отсутствующие обновления**.

 ![Просмотр состояния обновления](./media/tutorial-monitoring/manageupdates-view-status-win.png)

### <a name="schedule-an-update-deployment"></a>Планирование развертывания обновлений

Чтобы установить обновления, составьте план развертывания в рамках графика выпуска и периода обслуживания. Вы можете выбрать типы обновлений, которые будут включены в развертывание. Например, можно включить только критические обновления или обновления для системы безопасности и исключить накопительные пакеты обновления.

Новое развертывание обновления для виртуальной машины можно запланировать, щелкнув **Schedule update deployment** (Планирование развертывания обновления) в верхней части экрана **Update management** (Управление обновлениями). На экране **New update deployment** (Новое развертывание обновлений) укажите следующие сведения:

* **Имя.** Введите уникальное имя для идентификации развертывания обновлений.
* **Update classification** (Классификация обновлений). Выберите типы программного обеспечения, которые были включены в развертывание обновления. Ниже приведены типы классификации:
  * критические обновления;
  * обновления для системы безопасности;
  * накопительные пакеты обновления;
  * пакеты дополнительных компонентов;
  * пакеты обновления;
  * обновления определений;
  * Средства
  * Обновления

* **Параметры расписания.** Вы можете принять дату и время по умолчанию (на 30 минут больше текущего времени) либо указать другое время.
  Кроме того, можно указать, происходит ли развертывание один раз, или настроить расписание повторяющегося развертывания. Щелкните параметр Recurring (Повторяющееся) в разделе "Повторение", чтобы настроить повторяющееся расписание.

  ![Экран параметров обновления расписания](./media/tutorial-monitoring/manageupdates-schedule-win.png)

* **Maintenance window (minutes)** (Период обслуживания (в минутах)). Укажите временной период, в течение которого произойдет обновление развертывания.  Это гарантирует, что изменения выполняются в рамках заданного периода обслуживания.

Завершив настройку расписания, нажмите кнопку **Создать** и вернитесь к панели мониторинга состояния.
Обратите внимание, что таблица **Запланирован** показывает созданное расписание развертываний.

> [!WARNING]
> Если обновления требуют перезагрузки, виртуальная машина перезагрузится автоматически.

### <a name="view-results-of-an-update-deployment"></a>Просмотр результатов развертывания обновлений

После запуска запланированного развертывания вы можете контролировать его состояние на вкладке **Развертывания обновлений** раздела **Управление обновлениями**.
Если оно выполняется в данный момент, отображается состояние **Выполнение**. При успешном завершении появится состояние **Выполнено**.
В случае сбоя одного или нескольких обновлений в развертывании для состояния будет установлено значение **Частичный сбой**.
Щелкните завершенное развертывание обновлений, чтобы просмотреть панель мониторинга этого развертывания обновлений.

![Панель мониторинга состояния развертывания обновлений конкретного развертывания](./media/tutorial-monitoring/manageupdates-view-results.png)

Плитка **Update results** (Результаты обновления) является сводкой общего количества обновлений и результатов развертывания на виртуальной машине.
В таблице справа представлен подробный разбор каждого обновления и результатов установки, которые могут принимать одно из следующих значений:

* **Not attempted** (Попытка не предпринималась). Обновление не установлено из-за недостатка времени в связи с заданной длительностью окна обслуживания.
* **Выполнено.** Обновление было успешно выполнено.
* **Сбой.** Обновление не удалось выполнить.

Щелкните **Все журналы** для просмотра всех записей журнала, созданных при развертывании.

Щелкните плитку **Вывод** для просмотра потока заданий runbook, отвечающих за управление развертыванием обновления на целевой виртуальной машине.

Щелкните **Ошибки**, чтобы просмотреть подробные сведения о любых ошибках развертывания.

## <a name="monitor-changes-and-inventory"></a>Мониторинг изменений и инвентаризация

Вы можете собирать и просматривать сведения об установленных на компьютерах программном обеспечении, файлах, управляющих программах, службах и разделах реестра Windows. Отслеживание конфигураций поможет вам локализовать операционные проблемы в любом сегменте среды и получить сведения о текущем состоянии компьютеров.

### <a name="enable-change-and-inventory-management"></a>Включение управления изменениями и инвентаризацией

Включите управление изменениями и инвентаризацией для виртуальной машины следующим образом:

1. В левой части экрана выберите **Виртуальные машины**.
2. Выберите виртуальную машину из списка.
3. На экране виртуальной машины в разделе **Операции** выберите **Инвентаризация** или **Отслеживание изменений**. Откроется экран **Отслеживание изменений и инвентаризация**.

Настройте расположение, рабочую область Log Analytics и учетную запись службы автоматизации, затем нажмите кнопку **Включить**. Если эти поля неактивны и выделены серым цветом, то для этой виртуальной машины настроено другое решение автоматизации, а значит необходимо использовать ту же рабочую область и ту же учетную запись службы автоматизации. Эти решения представлены в меню отдельно, но по сути являются одним решением. Включение любого из них активирует для виртуальной машины оба решения.

![Включение отслеживания для изменений и инвентаризации](./media/tutorial-monitoring/manage-inventory-enable.png)

После включения потребуется некоторое время, пока будут собраны и отображены данные инвентаризации для виртуальной машины.

### <a name="track-changes"></a>Отслеживание изменений

На виртуальной машине выберите **Отслеживание изменений** в разделе **Операции**. Щелкните **Изменение параметров**, чтобы открыть страницу **Отслеживание изменений**. Выберите тип настроек, которые вы намерены отслеживать, и щелкните **+ Добавить** для настройки параметров. Доступные параметры для Windows:

* реестр Windows;
* файлы Windows.

Подробные сведения об отслеживании изменений см. в статье [Устранение неполадок при изменениях в среде](../../automation/automation-tutorial-troubleshoot-changes.md).

### <a name="view-inventory"></a>Просмотр данных инвентаризации

На виртуальной машине выберите **Инвентаризация** в разделе **Операции**. На вкладке **Программное обеспечение** вы найдете таблицу со списком обнаруженного программного обеспечения. В таблице предоставляются обобщенные сведения о каждой строке с информацией о программном обеспечении. Здесь для программного обеспечения указываются: имя, версия, издатель, время последнего обновления.

![Просмотр данных инвентаризации](./media/tutorial-monitoring/inventory-view-results.png)

### <a name="monitor-activity-logs-and-changes"></a>Мониторинг журналов действий и изменений

На странице **Отслеживание изменений** на виртуальной машине выберите **Управление подключением журнала действий**. Эта операция открывает страницу **Журнал действий Azure**. Выберите **Подключить**, чтобы подключить журнал действий Azure для виртуальной машины к службе отслеживания изменений.

Включив этот параметр, перейдите к странице **Обзор** для виртуальной машины и выберите действие **Остановить**, чтобы остановить виртуальную машину. Подтвердите остановку, выбрав **Да** при появлении соответствующего запроса. Когда освобождение виртуальной машины завершится, выберите **Запустить**, чтобы снова запустить ее.

Остановка и запуск виртуальной машины регистрируются как события в журнале действий. Вернитесь к странице **Отслеживание изменений**. Выберите вкладку **События** в нижней части страницы. Через некоторое время события отобразятся на диаграмме и в таблице. Вы можете выбрать любое из этих событий, чтобы просмотреть подробные сведения о нем.

![Просмотр изменений в журнале действий](./media/tutorial-monitoring/manage-activitylog-view-results.png)

Здесь отображаются изменения, произошедшие за определенное время. Когда вы добавите соединение с журналом действий, график в верхней части отобразит события из журнала действий Azure. Каждая строка гистограммы соответствует определенному типу отслеживаемых изменений. К этим типам относятся управляющие программы Linux, файлы, разделы реестра Windows, программное обеспечение и службы Windows. Вкладка "Изменения" отображает сведения об изменениях, отсортированные по времени в обратном порядке (первыми показаны самые последние).

## <a name="advanced-monitoring"></a>Расширенный мониторинг

Вы можете применить более развернутый мониторинг для виртуальной машины с помощью специальных решений, таких как "Управление обновлениями" и Change and Inventory (Изменения и инвентаризация), которые предоставляет [служба автоматизации Azure](../../automation/automation-intro.md).

Если у вас есть доступ к рабочей области Log Analytics, идентификатор и ключ рабочей области вы можете получить, выбрав **Дополнительные параметры** в разделе **Параметры**. Используйте команду [Set-AzureRmVMExtension](/powershell/module/azurerm.compute/set-azurermvmextension), чтобы добавить расширение Microsoft Monitoring Agent на виртуальную машину. Измените значения переменных в примере ниже, задав идентификатор и ключ вашей рабочей области Log Analytics.

```powershell
$workspaceId = "<Replace with your workspace Id>"
$key = "<Replace with your primary key>"

Set-AzureRmVMExtension -ResourceGroupName "myResourceGroupMonitor" `
  -ExtensionName "Microsoft.EnterpriseCloud.Monitoring" `
  -VMName "myVM" `
  -Publisher "Microsoft.EnterpriseCloud.Monitoring" `
  -ExtensionType "MicrosoftMonitoringAgent" `
  -TypeHandlerVersion 1.0 `
  -Settings @{"workspaceId" = $workspaceId} `
  -ProtectedSettings @{"workspaceKey" = $key} `
  -Location "East US"
```

Через несколько минут вы увидите новую виртуальную машину в рабочей области Log Analytics.

![Колонка OMS](./media/tutorial-monitoring/tutorial-monitor-oms.png)

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы выполнили настройку и проверку виртуальных машин с помощью центра безопасности Azure. Вы научились выполнять следующие задачи:

> [!div class="checklist"]
> * Создать виртуальную сеть
> * Создание группы ресурсов и виртуальной машины
> * Включение диагностики загрузки на виртуальной машине
> * Просмотр диагностики загрузки
> * Просмотр метрик узла.
> * Установка расширения системы диагностики
> * Просмотр метрик виртуальной машины
> * Создание оповещения
> * Управление обновлениями Windows
> * Мониторинг изменений и инвентаризация
> * Настройка расширенного мониторинга

Перейдите к следующему руководству, чтобы узнать о центре безопасности Azure.

> [!div class="nextstepaction"]
> [Мониторинг защиты виртуальных машин с помощью центра безопасности Azure](./tutorial-azure-security.md)