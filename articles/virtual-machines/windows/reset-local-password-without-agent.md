---
title: Сброс пароля локальной среды Windows без агента Azure | Документация Майкрософт
description: Описывается, как сбросить пароль локальной учетной записи пользователя Windows, если гостевой агент Azure не установлен или работает на виртуальной машине.
services: virtual-machines-windows
documentationcenter: ''
author: iainfoulds
manager: jeconnoc
editor: ''
ms.assetid: cf353dd3-89c9-47f6-a449-f874f0957013
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure-services
ms.date: 01/25/2018
ms.author: iainfou
ms.openlocfilehash: ad892aee646b1a5f8c96d5bdeca24b7a0d88f38e
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30915611"
---
# <a name="reset-local-windows-password-for-azure-vm-offline"></a>Сброс локального пароля Windows для виртуальной машины Azure вне сети
Локальный пароль Windows для виртуальной машины Azure можно сбросить с помощью [портала Azure или Azure PowerShell](reset-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (если установлен гостевой агент Azure). Этот метод является основным способом сброса пароля для виртуальной машины Azure. Если в работе гостевого агента Azure возникают неполадки (агент не отвечает или не устанавливается после передачи пользовательского образа), то можно сбросить пароль Windows вручную. В этой статье описывается, как сбросить пароль локальной учетной записи, подключив исходный виртуальный диск операционной системы к другой виртуальной машине. Действия, описанные в этой статье, не применяются к контроллерам домена Windows. 

> [!WARNING]
> Этот метод следует использовать только в крайнем случае. Всегда рекомендуется сначала попытаться сбросить пароль с помощью [портала Azure или Azure PowerShell](reset-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
> 
> 

## <a name="overview-of-the-process"></a>Описание процесса
Ниже приводятся основные шаги, выполнив которые можно сбросить локальный пароль для виртуальной машины Windows в Azure, если нет доступа к гостевому агенту Azure.

* Удалите исходную виртуальную машину. При этом виртуальные диски сохраняются.
* Подключите диск операционной системы исходной виртуальной машины к другой виртуальной машине, размещенной в том же расположении в вашей подписке Azure. Эта виртуальная машина будет выполнять функции машины для устранения неполадок.
* С помощью виртуальной машины для устранения неполадок создайте несколько файлов конфигурации на диске операционной системы исходной виртуальной машины.
* Отключите диск операционной системы виртуальной машины от машины для устранения неполадок.
* Используйте шаблон Resource Manager для создания виртуальной машины с помощью исходного виртуального диска.
* При загрузке новой виртуальной машины созданные вами файлы конфигурации обновят пароль требуемого пользователя.

## <a name="detailed-steps"></a>Подробные инструкции

> [!NOTE]
> Приведенные действия не применяются к контроллерам домена Windows. Они подходят только для отдельного сервера или сервера, который является членом домена.
> 
> 

Всегда рекомендуется сначала попытаться сбросить пароль с помощью [портала Azure или Azure PowerShell](reset-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json), прежде чем выполнять следующие шаги. Прежде чем начать, обязательно сохраните резервную копию виртуальной машины. 

1. Удалите затронутую виртуальную машину на портале Azure. При удалении виртуальной машины удаляются только метаданные, на которые ссылается виртуальная машина в Azure. Когда виртуальная машина удаляется, виртуальные диски остаются.
   
   * На портале Azure выберите виртуальную машину и нажмите кнопку *Удалить*:
     
     ![Удаление существующей виртуальной машины](./media/reset-local-password-without-agent/delete_vm.png)
2. Подключите диск операционной системы исходной виртуальной машины к машине для устранения неполадок. Виртуальная машина для устранения неполадок должна находиться в том же регионе, что и диск операционной системы исходной виртуальной машины (например `West US`).
   
   * Выберите виртуальную машину для устранения неполадок на портале Azure. Щелкните *Диски* | *Подключить существующий*:
     
     ![Подключение существующего диска](./media/reset-local-password-without-agent/disks_attach_existing.png)
     
     Выберите *VHD-файл*, а затем выберите учетную запись хранения, которая содержит вашу исходную виртуальную машину:
     
     ![Выбор учетной записи хранения](./media/reset-local-password-without-agent/disks_select_storageaccount.PNG)
     
     Выберите исходный контейнер. Как правило, исходный контейнер — *vhds*:
     
     ![Выбор контейнера хранилища](./media/reset-local-password-without-agent/disks_select_container.png)
     
     Выберите виртуальный жесткий диск операционной системы для подключения. Для завершения процесса нажмите кнопку *Выбрать*:
     
     ![Выбор исходного виртуального диска](./media/reset-local-password-without-agent/disks_select_source_vhd.png)
3. Подключитесь к виртуальной машине для устранения неполадок, используя удаленный рабочий стол, и убедитесь, что диск операционной системы исходной виртуальной машины отображается.
   
   * Выберите виртуальную машину для устранения неполадок на портале Azure и нажмите кнопку *Подключить*.
   * Откройте RDP-файл, который скачается. Введите имя пользователя и пароль виртуальной машины для устранения неполадок.
   * В проводнике найдите подключенный диск данных. Если виртуальный жесткий диск исходной виртуальной машины является единственным диском данных, подключенным к машине для устранения неполадок, то это должен быть диск F:
     
     ![Просмотр подключенного диска данных](./media/reset-local-password-without-agent/troubleshooting_vm_fileexplorer.png)
4. На диске исходной виртуальной машины создайте `gpt.ini` в `\Windows\System32\GroupPolicy` (если файл gpt.ini уже существует, то переименуйте его в gpt.ini.bak).
   
   > [!WARNING]
   > Убедитесь, что эти файлы случайно не созданы в расположении C:\Windows, на диске операционной системы виртуальной машины для устранения неполадок. Создайте файлы на диске операционной системы исходной виртуальной машины, который подключен в качестве диска данных.
   > 
   > 
   
   * В созданный файл `gpt.ini` добавьте следующие строки:
     
     ```
     [General]
     gPCFunctionalityVersion=2
     gPCMachineExtensionNames=[{42B5FAAE-6536-11D2-AE5A-0000F87571E3}{40B6664F-4972-11D1-A7CA-0000F87571E3}]
     Version=1
     ```
     
     ![Создание файла gpt.ini](./media/reset-local-password-without-agent/create_gpt_ini.png)
5. Создайте файл `scripts.ini` в расположении `\Windows\System32\GroupPolicy\Machine\Scripts`. Убедитесь, что отображаются скрытые папки. При необходимости создайте папку `Machine` или `Scripts`.
   
   * В созданный файл `scripts.ini` добавьте следующие строки:
     
     ```
     [Startup]
     0CmdLine=C:\Windows\System32\FixAzureVM.cmd
     0Parameters=
     ```
     
     ![Создание файла scripts.ini](./media/reset-local-password-without-agent/create_scripts_ini.png)
6. В расположении `\Windows\System32` создайте файл `FixAzureVM.cmd` со следующим содержимым, заменив `<username>` и `<newpassword>` своими значениями:
   
    ```
    net user <username> <newpassword> /add
    net localgroup administrators <username> /add
    net localgroup "remote desktop users" <username> /add
    ```

    ![Создание файла FixAzureVM.cmd](./media/reset-local-password-without-agent/create_fixazure_cmd.png)
   
    Создаваемый пароль должен удовлетворять настроенным требованиям к сложности пароля для виртуальной машины.
7. На портале Azure отключите диск от машины для устранения неполадок.
   
   * На портале Azure выберите виртуальную машину для устранения неполадок и щелкните *Диски*.
   * Выберите диск данных, подключенный на шаге 2, и нажмите кнопку *Отключить*:
     
     ![Отключение диска](./media/reset-local-password-without-agent/detach_disk.png)
8. Прежде чем создавать виртуальную машину, получите универсальный код ресурса (URI) для своего исходного диска операционной системы.
   
   * На портале Azure выберите учетную запись хранения и щелкните *BLOB-объекты*.
   * Выберите контейнер. Как правило, исходный контейнер — *vhds*:
     
     ![Выбор большого двоичного объекта учетной записи хранения](./media/reset-local-password-without-agent/select_storage_details.png)
     
     Выберите VHD-файл операционной системы исходной виртуальной машины и нажмите кнопку *Копировать* рядом с *URL-адресом*:
     
     ![Копирование URI диска](./media/reset-local-password-without-agent/copy_source_vhd_uri.png)
9. Создайте виртуальную машину на основе диска операционной системы исходной виртуальной машины.
   
   * Воспользуйтесь [этим шаблоном Azure Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-specialized-vhd) для создания виртуальной машины на основе специализированного VHD-файла. Нажмите кнопку `Deploy to Azure`, чтобы открыть портал Azure и выполнить заполнение данными шаблона.
   * Если вы хотите сохранить все предыдущие параметры для виртуальной машины, выберите *Изменить шаблон* и введите свои данные: виртуальная сеть, подсеть, сетевой адаптер или общедоступный IP-адрес.
   * В текстовом поле параметра `OSDISKVHDURI` вставьте универсальный код ресурса (URI) своего исходного виртуального жесткого диска, который вы скопировали на предыдущем шаге:
     
     ![Создание виртуальной машины на основе шаблона](./media/reset-local-password-without-agent/create_new_vm_from_template.png)
10. Когда новая виртуальная машина запущена, подключитесь к ней с помощью удаленного рабочего стола. Используйте при этом новый пароль, указанный в сценарии `FixAzureVM.cmd`.
11. В режиме удаленного сеанса на новой виртуальной машине удалите следующие файлы, чтобы очистить среду:
    
    * Из расположения %windir%\System32
      * удалите файл FixAzureVM.cmd.
    * Из расположения %windir%\System32\GroupPolicy\Machine\
      * удалите файл scripts.ini.
    * Из расположения %windir%\System32\GroupPolicy
      * удалите файл gpt.ini (если файл gpt.ini уже существовал и был переименован в gpt.ini.bak, то переименуйте BAK-файл обратно в gpt.ini).

## <a name="next-steps"></a>Дополнительная информация
Если все еще не удается подключиться с помощью удаленного рабочего стола, то см. статью [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). [Подробное руководство по устранению неполадок с подключением к удаленному рабочему столу на виртуальной машине Windows в Azure](detailed-troubleshoot-rdp.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) скорее посвящено методам устранения неполадок, чем конкретным действиям. Вы также можете [отправить запрос в службу поддержки Azure](https://azure.microsoft.com/support/options/) и получить практическую помощь.

