---
title: Как использовать PerfInsights в Microsoft Azure | Документация Майкрософт
description: Использование PerfInsights для устранения проблем производительности на виртуальных машинах Windows.
services: virtual-machines-windows'
documentationcenter: ''
author: genlin
manager: cshepard
editor: na
tags: ''
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: troubleshooting
ms.date: 05/11/2018
ms.author: genli
ms.openlocfilehash: cac17b5f3ee730bf1f56dbfd05b6c6d3b02c891f
ms.sourcegitcommit: e14229bb94d61172046335972cfb1a708c8a97a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
ms.locfileid: "34160664"
---
# <a name="how-to-use-perfinsights"></a>Как использовать PerfInsights 

[PerfInsights](http://aka.ms/perfinsightsdownload) — это автоматизированный инструмент диагностики, который собирает и анализирует полезные диагностические данные.Он также предоставляет отчеты для устранения проблем производительности на виртуальных машинах Windows в Azure. Его можно запускать на виртуальных машинах в качестве автономного средства или непосредственно из портала, установив [расширение виртуальной машины для диагностики производительности Azure](performance-diagnostics-vm-extension.md).

При возникновении проблем производительности на виртуальных машинах перед обращением в службу поддержки запустите это средство.

## <a name="supported-troubleshooting-scenarios"></a>Поддерживаемые сценарии устранения неисправностей

PerfInsights может собирать и анализировать несколько типов данных. В следующих разделах описываются типовые сценарии.

### <a name="collect-basic-configuration"></a>Сбор базовой конфигурации 

Этот сценарий собирает данные конфигурации дисков и другие важные сведения, в том числе:

-   Журналы событий

-   состояние всех входящих и исходящих сетевых подключений;

-   параметры конфигурации сети и брандмауэра;

-   список задач всех приложений, запущенных в системе;

-   параметры конфигурации базы данных Microsoft SQL Server (если виртуальная машина определяется как сервер, на котором выполняется SQL Server);

-   счетчики надежности хранилища;

-   важные исправления Windows;

-   установленные драйверы фильтра.

Это пассивный сбор данных, который не должен повлиять на систему. 

>[!Note]
>Этот сценарий автоматически включен в каждый из следующих сценариев.

### <a name="benchmarking"></a>Тестирование производительности

Этот сценарий запускает тест производительности [Diskspd](https://github.com/Microsoft/diskspd) (операции ввода-вывода в Мбит/с) всех дисков, подключенных к виртуальной машине. 

> [!Note]
> Этот сценарий не рекомендуется запускать в рабочей системе, так как он может повлиять на нее. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное тестом производительности или трассировкой, может негативно повлиять на производительность виртуальной машины.
>

### <a name="slow-vm-analysis"></a>Анализ медленной виртуальной машины 

Этот сценарий запускает трассировку [счетчиков производительности](https://msdn.microsoft.com/library/windows/desktop/aa373083(v=vs.85).aspx), которые указаны в файле RuleEngineConfig.json. Если виртуальная машина определяется как сервер, на котором работает SQL Server, выполняется трассировка счетчиков производительности. Это делается с помощью счетчиков, которые находятся в файле RuleEngineConfig.json. Этот сценарий также содержит данные диагностики производительности.

### <a name="azure-files-analysis"></a>Анализ файлов Azure 

Этот сценарий запускает специальную запись счетчиков производительности вместе с функцией сетевой трассировки. Запись включает в себя все счетчики общих ресурсов SMB-клиента. Ниже приведены некоторые ключевые счетчики производительности общих ресурсов SMB-клиента, которые являются частью записи.

| **Тип**     | **Общие ресурсы SMB-клиента** |
|--------------|-------------------------------|
| ОПЕРАЦИЙ ВВОДА-ВЫВОДА         | Запросов данных в секунду             |
|              | Запросов на чтение в секунду             |
|              | Запросов на запись в секунду            |
| Latency      | Среднее число секунд на запрос данных         |
|              | Среднее число секунд на запрос на чтение                 |
|              | Среднее число секунд на запрос на запись                |
| Размер ввода-вывода      | Среднее число байтов в запросе       |
|              | Среднее число байтов в запросе на чтение               |
|              | Среднее число байтов в запросе на запись              |
| Throughput   | Байтов в секунду                |
|              | Прочитано байтов в секунду                |
|              | Записано байтов в секунду               |
| Длина очереди | Среднее Длина очереди чтения        |
|              | Среднее Длина очереди записи       |
|              | Среднее Длина очереди данных        |

### <a name="custom-slow-vm-analysis"></a>Пользовательский анализ медленной виртуальной машины 

Когда вы запускаете пользовательский анализ медленной виртуальной машины, необходимо выбрать параллельные трассировки. При необходимости вы можете запустить их все (счетчик производительности, Xperf, сеть и StorPort).  

> [!Note]
> Этот сценарий не рекомендуется запускать в рабочей системе, так как он может повлиять на нее. При необходимости запустите этот сценарий во время выделенного периода обслуживания, чтобы избежать проблем. Увеличение рабочей нагрузки, вызванное тестом производительности или трассировкой, может негативно повлиять на производительность виртуальной машины.
>

## <a name="what-kind-of-information-is-collected-by-perfinsights"></a>Сведения, которые собираются с помощью PerfInsights

Собираются сведения о виртуальных машинах Windows, конфигурация дисков или пулов хранения, счетчики производительности, журналы и различные трассировки. Тип сведений зависит от используемого сценария тестирования производительности. В следующей таблице приведено несколько примеров.

|Собираемые данные                              |  |  | Сценарии тестирования производительности |  |  | |
|----------------------------------|----------------------------|------------------------------------|--------------------------|--------------------------------|----------------------|----------------------|
|                               | Сбор базовой конфигурации | Тестирование производительности | Анализ медленной виртуальной машины | Анализ файлов Azure | Пользовательский анализ медленной виртуальной машины |
| Сведения из журналов событий       | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Сведения о системе                | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Сопоставление томов                        | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Сопоставление дисков                          | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Выполняемые задачи                     | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| счетчики надежности хранилища;      | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Сведения о хранилище               | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Выходные данные fsutil                     | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Сведения о драйвере фильтра                | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Выходные данные netstat                    | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Конфигурация сети             | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Настройка брандмауэра            | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Конфигурация SQL Server          | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Трассировки диагностики производительности*  | Yes                        | Yes                                | Yes                      | Yes                  | Yes                  |
| Трассировка счетчиков производительности**      |                            |                                    | Yes                      |                      | Yes                  |
| Трассировка счетчиков SMB**              |                            |                                    |                          | Yes                  |                      |
| Трассировка счетчиков SQL Server**       |                            |                                    | Yes                      |                      | Yes                  |
| Трассировка XPerf                       |                            |                                    |                          |                      | Yes                  |
| Трассировка StorPort                    |                            |                                    |                          |                      | Yes                  |
| Трассировка сети                     |                            |                                    |                          | Yes                  | Yes                  |
| Трассировка теста производительности Diskspd***       |                            | Yes                                |                          |                      |                      |
|       |                            |                         |                                                   |                      |                      |

### <a name="performance-diagnostics-trace-"></a>Трассировка диагностики производительности (*)

Запускает в фоновом режиме модуль на основе правила для сбора данных и диагностики проблем с производительностью системы. В настоящее время поддерживаются следующие правила:

- Правило HighCpuUsage. Определяет периоды высокой загрузки ЦП и показывает основных потребителей ресурсов ЦП в эти периоды.
- Правило HighDiskUsage. Определяет периоды высокой загрузки физического диска и показывает основных потребителей диска в эти периоды.
- Правило HighResolutionDiskMetric. Показывает метрики операций ввода-вывода, пропускной способности и задержки операций ввода-вывода за 50 мс для каждого физического диска. Это позволяет быстро найти периоды регулирования диска.
- Правило HighMemoryUsage. Определяет периоды высокой загрузки памяти и показывает основных потребителей памяти в эти периоды.

> [!NOTE] 
> В настоящее время поддерживаются версии Windows, которые содержат .NET Framework 3.5 или более поздней версии.

### <a name="performance-counter-trace-"></a>Трассировка счетчиков производительности (\*\*)

Собирает следующие счетчики производительности.

- \Процесс, \Процессор, \Память, \Поток, \Физический диск и\Логический диск.
- \Кэш\"Грязные" страницы, \Кэш\Сбросов ленивой записи/с, \Сервер\Невыгружаемый пул, ошибки и\Сервер\Отказов выгружаемого страничного пула.
- Выбранные счетчики в категориях \Сетевой интерфейс, \IPv4\Датаграммы, \IPv6\Датаграммы, \TCPv4\Сегменты, \TCPv6\Сегменты, \Сетевой адаптер, \WFPv4\Пакеты, \WFPv6\Пакеты, \UDPv4\Датаграммы, \UDPv6\Датаграммы, \TCPv4\Подключение, \TCPv6\Подключение, \Политика качества обслуживания сети\Пакеты, \Активность сетевой карты для каждого процессора и\Microsoft Winsock BSP.

#### <a name="for-sql-server-instances"></a>Для экземпляров SQL Server
- \SQL Server: диспетчер буфера, \SQLServer: статистика пула ресурсов и \SQLServer: статистика SQL\.
- \SQLServer: блокировки, \SQLServer: общая статистика
- \SQLServer: способы доступа

#### <a name="for-azure-files"></a>Для файлов Azure
\Общие ресурсы SMB-клиента

### <a name="diskspd-benchmark-trace-"></a>Трассировка теста производительности Diskspd (***)
Тестирование рабочей нагрузки операций ввода-вывода Diskspd (диск операционной системы [запись] и диски пула [чтение и запись])

## <a name="run-the-perfinsights-tool-on-your-vm"></a>Запуск инструмента PerfInsights на виртуальной машине

### <a name="what-do-i-have-to-know-before-i-run-the-tool"></a>Что нужно знать, прежде чем запускать инструмент 

#### <a name="tool-requirements"></a>Требования инструмента

-  Этот инструмент следует запускать на виртуальных машинах с проблемами производительности. 

-  Шифрование дисков Azure доступно для следующих операционных систем: Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2, Windows Server 2016, Windows 8.1 и Windows 10.

#### <a name="possible-problems-when-you-run-the-tool-on-production-vms"></a>Возможные проблемы при запуске инструмента на рабочих виртуальных машинах

-  В сценариях "Тест производительности" или "Пользовательский анализ медленной виртуальной машины", для которых настроено использование XPerf или DiskSpd, инструмент может неблагоприятно повлиять на производительность виртуальной машины. Эти сценарии не следует запускать в рабочей среде.

-  При использовании сценариев "Тест производительности" или "Пользовательский анализ медленной виртуальной машины", в которых настроено использование DiskSpd, убедитесь, что фоновые действия не мешают рабочей нагрузке ввода-вывода.

-  По умолчанию для сбора данных инструмент использует диск временного хранилища. Если трассировка остается включенной длительное время, объем собираемых данных может увеличится соответственно. Это может сократить доступное пространство на временном диске, что повлияет на все приложения, которые используют этот диск.

### <a name="how-do-i-run-perfinsights"></a>Способ запуска PerfInsights 

Вы можете запустить PerfInsights на виртуальной машине, установив [расширение виртуальной машины для диагностики производительности Azure](performance-diagnostics-vm-extension.md). Кроме того, вы можете запустить его в качестве автономного инструмента. 

**Установка и запуск PerfInsights на портале Azure**

Дополнительные сведения см. в разделе [Установка расширения](performance-diagnostics-vm-extension.md#install-the-extension).  

**Запуск PerfInsights в автономном режиме**

Чтобы запустить инструмент PerfInsights, сделайте следующее.


1. Скачайте [PerfInsights.zip](http://aka.ms/perfinsightsdownload).

2. Разблокируйте файл PerfInsights.zip. Для этого щелкните файл PerfInsights.zip правой кнопкой мыши и выберите **Свойства**. На вкладке **Общие** выберите **Разблокировать** и нажмите кнопку **ОК**. После этого инструмент запустится без дополнительных запросов безопасности.  

    ![Снимок экрана свойства PerfInsights с выделенным элементом Unblock](media/how-to-use-perfInsights/unlock-file.png)

3.  Разверните сжатый файл PerfInsights.zip на временный диск (по умолчанию обычно это диск D). 

4.  Откройте командную строку Windows с правами администратора, а затем запустите PerfInsights.exe, чтобы просмотреть доступные параметры командной строки.

    ```
    cd <the path of PerfInsights folder>
    PerfInsights
    ```
    ![Снимок экрана выходных данных командной строки PerfInsights](media/how-to-use-perfInsights/PerfInsightsCommandline.png)
    
    Ниже приведен пример базового синтаксиса для запуска сценариев PerfInsights:
    
    ```
    PerfInsights /run <ScenarioName> [AdditionalOptions]
    ```

    Вы можете использовать приведенный ниже пример для запуска сценария медленной виртуальной машины в течение 5 минут.
    
    ```
    PerfInsights /run vmslow /d 300 /AcceptDisclaimerAndShareDiagnostics
    ```

    Для запуска пользовательского сценария с трассировками счетчика производительности и Xperf в течение 5 минут можно использовать следующий пример.
    
    ```
    PerfInsights /run custom xp /d 300 /AcceptDisclaimerAndShareDiagnostics
    ```

    Вы можете просмотреть все доступные сценарии и параметры с помощью команды **/list**.
    
    ```
    PerfInsights /list
    ```

    >[!Note]
    >Перед запуском сценария PerfInsights запрашивает у пользователя согласие на обмен диагностическими данными и согласие с условиями лицензии. Используйте параметр **/AcceptDisclaimerAndShareDiagnostics**, чтобы пропустить эти запросы. 
    >
    >Если вы сделали запрос в службу поддержки Майкрософт и запустили PerfInsights по запросу сотрудника службы поддержки, с которым вы работаете, обязательно укажите номер запроса на поддержку с помощью параметра **/sr**.
    >
    >По умолчанию PerfInsights попытается обновиться до последней версии (если таковая имеется). Чтобы пропустить автоматическое обновление, используйте параметр **/SkipAutoUpdate** или **/sau**.  
    >
    >Если параметр продолжительности **/d** не указан, PerfInsights предложит вам повторно обработать проблему во время выполнения сценариев vmslow и azurefiles, а также настраиваемых сценариев. 

По завершении трассировки или операции в папке с PerfInsights появится новый файл. Имя файла — **CollectedData\_гггг-ММ-дд\_чч-мм-сс-ммм.zip.** Вы можете отправить этот файл агенту поддержки для анализа или открыть отчет внутри ZIP-файла, чтобы просмотреть результаты и рекомендации.

## <a name="review-the-diagnostics-report"></a>Просмотр отчета о диагностике

В файле **CollectedData\_гггг-ММ-дд\_чч-мм-сс-ммм.zip** находится отчет в формате HTML с подробными сведениями о результате проверки PerfInsights. Чтобы просмотреть отчет, разверните файл **CollectedData\_гггг-ММ-дд\_чч-мм-сс-ммм.zip**, а затем откройте файл **PerfInsights Report.html**.

Выберите вкладку **Результаты**.

![Снимок экрана отчета PerfInsights](media/how-to-use-perfInsights/findingtab.png)
![Screenshot of PerfInsights Report](media/how-to-use-perfInsights/findings.PNG)

> [!NOTE] 
> В категорию критически важных результатов попадают известные проблемы, которые могут вызвать проблемы с производительностью. В категорию важных попадают результаты, указывающие на неоптимальную конфигурацию, которая может не приводить к проблемам с производительностью. Результаты из категории информационных содержат сообщения, которые полезно принять к сведению.

Просмотрите рекомендации и ссылки на все важные результаты. Узнайте, как они могут повлиять на производительность, и ознакомьтесь с рекомендациями по оптимизации производительности конфигураций.

### <a name="storage-tab"></a>Вкладка хранилища

В разделе **Результаты** отображаются разные результаты и рекомендации, которые относятся к хранилищу.

В разделах **DiskMap** и **VolumeMap** описана связь между логическими томами и физическими дисками.

В перспективе физического диска (DiskMap) в таблице показаны все логические тома, которые размещены на диске. В следующем примере на **PhysicalDrive2** размещены два логических тома, созданные в нескольких разделах (J и H):

![Снимок экрана вкладки диска](media/how-to-use-perfInsights/disktab.png)

В перспективе тома (VolumeMap) в таблицах показаны все физические диски в каждом логическом томе. Обратите внимание, что для RAID-массивов и динамических дисков можно разместить логический том на нескольких физических дисках. В следующем примере *C:\\mount* является точкой подключения, которая настроена в качестве *SpannedDisk* на физических дисках 2 и 3.

![Снимок экрана вкладки тома](media/how-to-use-perfInsights/volumetab.png)

### <a name="sql-tab"></a>Вкладка SQL

Если на целевой виртуальной машине размещаются экземпляры SQL Server, в отчете отображается дополнительная вкладка с именем **SQL**.

![Снимок экрана вкладки SQL](media/how-to-use-perfInsights/sqltab.png)

Этот раздел содержит вкладку **Результаты** и дополнительные вкладки для каждого экземпляра SQL Server, размещенного на виртуальной машине.

Вкладка **Результаты** содержит список всех найденных проблем с производительностью службы SQL и рекомендации по ним.

В следующем примере отображается **PhysicalDrive0** (на диске C), так как файлы **modeldev** и **modellog** находятся на диске C и относятся к различным типам (файл данных и журнал транзакций, соответственно).

![Снимок экрана сведений в журнале](media/how-to-use-perfInsights/loginfo.png)

Вкладки для определенных экземпляров SQL Server содержат общий раздел, в котором отображаются основные сведения о выбранном экземпляре, а также содержат разделы дополнительных сведений, включая настройки, конфигурации и пользовательские параметры.

### <a name="diagnostic-tab"></a>Вкладка диагностики
Вкладка **Диагностики** содержит сведения об основных потребителях ЦП, дисков и памяти за период, в течение которого на компьютере выполнялся сценарий PerfInsights. Здесь есть и другие сведения, например отсутствующие критически важные исправления, список задач и важные системные события. 

## <a name="references-to-the-external-tools-used"></a>Ссылки на внешние используемые средства

### <a name="diskspd"></a>Diskspd

Diskspd — это генератор нагрузки хранилища и инструмент проверки производительности корпорации Майкрософт. Дополнительные сведения можно найти по [этой ссылке](https://github.com/Microsoft/diskspd).

### <a name="xperf"></a>XPerf

XPerf является средством командной строки для записи сведений трассировок из набора средств оценки производительности Windows. Дополнительные сведения см. в записи блога [Windows Performance Toolkit - Xperf](https://blogs.msdn.microsoft.com/ntdebugging/2008/04/03/windows-performance-toolkit-xperf/) (Набор средств оценки производительности Windows — XPerf).

## <a name="next-steps"></a>Дополнительная информация

Вы можете отправить журналы диагностики и отчетов в службу поддержки Майкрософт для дальнейшего анализа Службе поддержки Майкрософт может потребоваться передать выходные данные, созданные PerfInsights, чтобы упростить процесс устранения неполадок.

На следующем снимке экрана отображается сообщение, которое вы можете получить:

![Снимок экрана примера сообщения от службы поддержки Майкрософт](media/how-to-use-perfInsights/supportemail.png)

Следуйте инструкциям в сообщении, чтобы получить доступ к рабочему пространству передачи файлов. Для обеспечения дополнительной безопасности необходимо изменить пароль при первом использовании.

После входа появится диалоговое окно для отправки файла **CollectedData\_гггг-ММ-дд\_чч-мм-сс-ммм.zip**, собранного PerfInsights.
