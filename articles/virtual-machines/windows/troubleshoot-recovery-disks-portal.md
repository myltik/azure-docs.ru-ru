---
title: Использование виртуальной машины Windows для устранения неполадок с помощью портала Azure | Документация Майкрософт
description: Узнайте, как устранять неполадки с виртуальными машинами Windows в Azure, подключив диск операционной системы к виртуальной машине восстановления с помощью портала Azure.
services: virtual-machines-windows
documentationCenter: ''
authors: genlin
manager: jeconnoc
editor: ''
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 05/07/2018
ms.author: genli
ms.openlocfilehash: 818e4ca5c4985d1740c477bf4a5aa198e64b506d
ms.sourcegitcommit: d98d99567d0383bb8d7cbe2d767ec15ebf2daeb2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
---
# <a name="troubleshoot-a-windows-vm-by-attaching-the-os-disk-to-a-recovery-vm-using-the-azure-portal"></a>Устранение неполадок с виртуальной машиной Windows при подключении диска операционной системы к виртуальной машине восстановления с помощью портала Azure
Если возникает проблема с загрузкой или диском на виртуальной машине Windows в Azure, возможно, вам нужно устранить неполадки, связанные с самим виртуальным жестким диском. Например, такая ситуация может возникнуть из-за сбоя обновления приложения, который мешает успешно загрузить виртуальную машину. В этой статье подробно описано, как с помощью портала Azure подключить виртуальный жесткий диск к другой виртуальной машине Windows для устранения ошибок, а затем восстановить исходную виртуальную машину.

## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Удалите виртуальную машину, на которой возникли проблемы, сохранив ее виртуальные жесткие диски.
2. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине Windows для устранения неполадок.
3. Подключитесь к этой виртуальной машине. Измените файлы или запустите средства, которые нужны для устранения неполадок на исходном виртуальном жестком диске.
4. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
5. Создайте другую виртуальную машину, используя исходный виртуальный жесткий диск.


## <a name="determine-boot-issues"></a>Выявление проблем при загрузке
Изучите диагностические сведения о загрузке и снимки экрана виртуальной машины, чтобы определить, почему виртуальная машина не может правильно загрузиться. Например, причиной может быть сбой обновления приложения, удаление или перемещение базового виртуального жесткого диска и т. п.

Выберите на портале эту виртуальную машину и прокрутите экран вниз до раздела **Поддержка и устранение неполадок**. Щелкните **Boot diagnostics** (Диагностика загрузки), чтобы просмотреть снимок экрана. Обратите внимание на сообщения об ошибках или коды ошибок, чтобы определить причины проблемы с виртуальной машиной. В следующем примере показана виртуальная машина, ожидающая остановленные службы.

![Просмотр журналов консоли для диагностики загрузки виртуальной машины](./media/troubleshoot-recovery-disks-portal/screenshot-error.png)

Можно также щелкнуть **Screenshot** (Снимок экрана), чтобы скачать снимок экрана виртуальной машины.


## <a name="view-existing-virtual-hard-disk-details"></a>Просмотр сведений для существующего виртуального жесткого диска
Прежде чем присоединить виртуальный жесткий диск к другой виртуальной машине, следует определить имя этого виртуального жесткого диска. 

Выберите на портале группу ресурсов и учетную запись хранения. Щелкните **Большие двоичные объекты**, как показано в следующем примере.

![Выбор больших двоичных объектов для хранения](./media/troubleshoot-recovery-disks-portal/storage-account-overview.png)

Обычно виртуальные жесткие диски хранятся в отдельном контейнере с именем **vhds**. Выберите этот контейнер, чтобы просмотреть список виртуальных жестких дисков. Запишите имя нужного виртуального жесткого диска (обычно используется префикс, совпадающий с именем виртуальной машины).

![Поиск виртуального жесткого диска в контейнере хранилища](./media/troubleshoot-recovery-disks-portal/storage-container.png)

Выберите из списка существующий виртуальный жесткий диск и скопируйте его URL-адрес для использования на следующих этапах.

![Копирование URL-адреса существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/copy-vhd-url.png)


## <a name="delete-existing-vm"></a>Удаление существующей виртуальной машины
Виртуальные жесткие диски и виртуальные машины — это разные ресурсы в Azure. Виртуальный жесткий диск является местом хранения операционной системы, приложений и конфигурации. Виртуальная машина — это просто метаданные, которые определяют размер или расположение объекта, а также ссылки на ресурсы, такие как виртуальные жесткие диски или виртуальные сетевые адаптеры. При присоединении виртуального жесткого диска к виртуальной машине для него регистрируется аренда. Диски данных можно присоединять и отсоединять во время работы виртуальной машины, но диск операционной системы отсоединить невозможно, пока ресурс виртуальной машины не будет удален. Аренда сохраняет привязку диска операционной системы к виртуальной машине, даже когда эта виртуальная машина остановлена или отменено ее распределение.

Поэтому для восстановления виртуальной машины нужно прежде всего удалить ресурс виртуальной машины. Удаление виртуальной машины не повлияет на виртуальные жесткие диски, размещенные в учетной записи хранения. После удаления виртуальной машины присоедините виртуальный жесткий диск к другой виртуальной машине, чтобы устранить неполадки.

Выберите на портале нужную виртуальную машину и щелкните **Удалить**.

![Снимок экрана диагностики загрузки виртуальной машины с сообщением об ошибке загрузки](./media/troubleshoot-recovery-disks-portal/stop-delete-vm.png)

Дождитесь, пока удаление завершится, прежде чем присоединять виртуальный жесткий диск к другой виртуальной машине. Чтобы присоединить виртуальный жесткий диск к другой виртуальной машине, необходимо снять аренду, которая привязывает диск к виртуальной машине.


## <a name="attach-existing-virtual-hard-disk-to-another-vm"></a>Присоединение существующего виртуального жесткого диска к другой виртуальной машине
В следующих нескольких шагах описывается использование другой виртуальной машины для устранения неполадок. Присоедините существующий виртуальный жесткий диск к виртуальной машине для устранения неполадок, чтобы можно было просматривать и изменять содержимое диска. Этот процесс позволяет, например, исправить ошибки конфигурации или изучить дополнительные журналы протоколов или системы. Выберите или создайте другую виртуальную машину, которая будет использоваться для устранения неполадок.

1. Выберите на портале группу ресурсов и виртуальную машину для устранения неполадок. Выберите **Диски** и нажмите кнопку **Подключить существующий**.

    ![Присоединение существующего диска на портале](./media/troubleshoot-recovery-disks-portal/attach-existing-disk.png)

2. Чтобы выбрать существующий виртуальный жесткий диск, щелкните его **VHD-файл**.

    ![Поиск существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/select-vhd-location.png)

3. Выберите учетную запись хранения и контейнер, затем щелкните существующий виртуальный жесткий диск. Нажмите кнопку **Выбрать**, чтобы подтвердить выбор.

    ![Выбор существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/select-vhd.png)

4. Выбрав существующий виртуальный жесткий диск, щелкните **ОК**, чтобы присоединить его.

    ![Подтверждение присоединения существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/attach-disk-confirm.png)

5. Через несколько секунд на панели **Диски** для виртуальной машины отобразится подключение существующего виртуального жесткого диска в качестве диска данных.

    ![Существующий виртуальный жесткий диск присоединен как диск данных](./media/troubleshoot-recovery-disks-portal/attached-disk.png)


## <a name="mount-the-attached-data-disk"></a>Подключение присоединенного диска данных

1. Откройте подключение к удаленному рабочему столу своей виртуальной машины. Выберите на портале свою виртуальную машину и щелкните **Подключиться**. Скачайте и откройте RDP-файл подключения. Введите учетные данные для входа в виртуальную машину, как показано ниже.

    ![Вход в виртуальную машину с помощью удаленного рабочего стола](./media/troubleshoot-recovery-disks-portal/open-remote-desktop.png)

2. Откройте **диспетчер сервера** и выберите **Файловые службы и службы хранилища**. 

    ![Выбор параметра "Файловые службы и службы хранилища" в диспетчере сервера](./media/troubleshoot-recovery-disks-portal/server-manager-select-storage.png)

3. Диск данных будет автоматически обнаружен и подключен. Для просмотра списка подключенных дисков выберите **Диски**. Можно выбрать диск данных, чтобы просмотреть сведения о томах, включая букву диска. В следующем примере показан подключенный диск данных **F**.

    ![Подключенный диск и сведения о томах в диспетчере сервера](./media/troubleshoot-recovery-disks-portal/server-manager-disk-attached.png)


## <a name="fix-issues-on-original-virtual-hard-disk"></a>Устранение неполадок на исходном виртуальном жестком диске
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по обслуживанию и (или) устранению неполадок. После устранения проблем выполните следующие действия.


## <a name="unmount-and-detach-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
После устранения ошибок отсоедините существующий виртуальный жесткий диск от виртуальной машины, которую использовали для устранения неполадок. Виртуальный жесткий диск нельзя использовать с другой виртуальной машиной, пока вы не отмените аренду, присоединяющую виртуальный жесткий диск к виртуальной машине для устранения неполадок.

1. В сеансе подключения к удаленному рабочему столу своей виртуальной машины откройте **диспетчер сервера** и выберите **Файловые службы и службы хранилища**.

    ![Выбор параметра "Файловые службы и службы хранилища" в диспетчере сервера](./media/troubleshoot-recovery-disks-portal/server-manager-select-storage.png)

2. Щелкните **Диски** и выберите свой диск данных. Щелкните его правой кнопкой мыши и выберите **Отключить**.

    ![Отключение диска данных в диспетчере сервера](./media/troubleshoot-recovery-disks-portal/server-manager-set-disk-offline.png)

3. Теперь отсоедините виртуальный жесткий диск от виртуальной машины. Выберите на портале Azure виртуальную машину и щелкните **Диски**. Выберите существующий виртуальный жесткий диск и щелкните **Отсоединить**.

    ![Отсоединение существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/detach-disk.png)

    Подождите, пока виртуальная машина успешно отсоединит диск данных, прежде чем продолжать процесс.

## <a name="create-vm-from-original-hard-disk"></a>Создание виртуальной машины из исходного жесткого диска
Чтобы создать виртуальную машину из исходного виртуального жесткого диска, используйте [этот шаблон Azure Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-specialized-vhd-existing-vnet). Этот шаблон развертывает виртуальную машину в существующую виртуальную сеть, используя URL-адрес виртуального жесткого диска из использованной выше команды. Нажмите кнопку **Развернуть в Azure**.

![Развертывание виртуальной машины из шаблона Github](./media/troubleshoot-recovery-disks-portal/deploy-template-from-github.png)

Шаблон загружается на портал Azure для развертывания. Введите имя для новой виртуальной машины и укажите существующие ресурсы Azure, а затем вставьте URL-адрес исходного виртуального жесткого диска. Чтобы начать развертывание, щелкните **Приобрести**.

![Развертывание виртуальной машины на основе шаблона](./media/troubleshoot-recovery-disks-portal/deploy-from-image.png)


## <a name="re-enable-boot-diagnostics"></a>Восстановление диагностики загрузки
При создании виртуальной машины на основе существующего виртуального жесткого диска диагностика загрузки не всегда автоматически включена. Выберите эту виртуальную машину на портале, чтобы проверить состояние диагностики загрузки и включить ее, если потребуется. В разделе **Мониторинг** щелкните **Параметры диагностики**. Убедитесь, что выбрано состояние **Включено** и установлен флажок **Диагностика загрузки**. Если вы внесете здесь изменения, нажмите кнопку **Сохранить**.

![Обновление параметров диагностики загрузки](./media/troubleshoot-recovery-disks-portal/reenable-boot-diagnostics.png)

## <a name="next-steps"></a>Дополнительная информация
При возникновении проблем с подключением к виртуальной машине ознакомьтесь со статьей [Устранение неполадок с подключением к удаленному рабочему столу на виртуальной машине Azure под управлением Windows](troubleshoot-rdp-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Для устранения проблем с доступом к приложениям, выполняющимся на виртуальной машине, прочитайте статью [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Дополнительные сведения об использовании Resource Manager вы найдете в статье [Общие сведения об Azure Resource Manager](../../azure-resource-manager/resource-group-overview.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
