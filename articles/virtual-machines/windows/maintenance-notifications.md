---
title: "Обработка уведомлений по обслуживанию для виртуальных машин Windows в Azure | Документация Майкрософт"
description: "Просмотрите уведомления по обслуживанию для виртуальных машин Windows, запущенных в Azure, и запустите самостоятельное обслуживание."
services: virtual-machines-windows
documentationcenter: 
author: zivraf
manager: timlt
editor: 
tags: azure-service-management,azure-resource-manager
ms.assetid: 
ms.service: virtual-machines-windows
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 12/15/2017
ms.author: zivr
ms.openlocfilehash: b0103acf1e407a6a198159fad227b7ccc25052d2
ms.sourcegitcommit: 821b6306aab244d2feacbd722f60d99881e9d2a4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/16/2017
---
# <a name="handling-planned-maintenance-notifications-for-windows-virtual-machines"></a>Обработка плановых уведомлений по обслуживанию для виртуальных машин Windows

Azure периодически выполняет обновления, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов, в которой работают виртуальные машины. Обновления — это изменения, такие как исправление среды размещения или модернизация оборудования и вывод его из эксплуатации. Большинство этих обновлений не влияют на работу размещенных виртуальных машин. Но в некоторых случаях они все же оказывают определенное воздействие:

- Если обслуживание не требует перезагрузки, Azure с помощью миграции на месте приостанавливает работу виртуальной машины во время обновления узла.

- Если для обслуживания требуется перезагрузка, вы получите уведомление во время планирования обслуживания. В этих случаях вам предоставляется временное окно, в котором вы можете начать обслуживание самостоятельно в удобное для вас время.


Плановое обслуживание, требующее перезагрузки, запланировано в волнах. Каждая волна имеет разную область (регионы).

- Волна начинается с уведомления клиентов. По умолчанию уведомление отправляется владельцу и совладельцам подписки. Можно добавить дополнительные параметры обмена сообщениями электронной почты, SMS и веб-привязок и получателей уведомлений, с использованием Azure [оповещения журнала действий](../../monitoring-and-diagnostics/monitoring-overview-activity-logs.md).  
- Во время уведомления *самообслуживания окна* станет доступна. Во время этого периода можно найти, которые ваши виртуальные машины включены в этой и заранее запуска обслуживания в соответствии с собственными требованиями планирования.
- После окна самообслуживания *запланированного окна обслуживания* начинается. На некотором этапе этого окна Azure планирует и применяет необходимые обслуживания к виртуальной машине. 

Два периода нужны, чтобы у вас было достаточно времени для запуска обслуживания и перезагрузки виртуальной машины до того, как Azure начнет обслуживание автоматически.


Для запроса окон обслуживания для виртуальных машин и запуска самообслуживания можно использовать портал Azure, PowerShell, REST API и CLI.

 > [!NOTE]
 > Если запрос завершается ошибкой при попытке запустить обслуживание, Azure отмечает виртуальную Машину в качестве **пропущен**. Вы больше не сможете использовать параметр запуска обслуживания клиентов. ВМ будет перезагружен в Azure во время фазы запланированного обслуживания.


 
## <a name="should-you-start-maintenance-using-during-the-self-service-window"></a>Нужно начать с помощью обслуживания во время окна самообслуживания?  

Следующие рекомендации помогут вам решить, следует ли использовать эту возможность и запустить в режиме обслуживания.

> [!NOTE] 
> Самостоятельного обслуживания могут оказаться недоступными для всех виртуальных машин. Чтобы определить, доступна ли упреждающее повторного развертывания ВМ, найдите **начать сейчас** в состоянии обслуживания. Самостоятельное обслуживание сейчас недоступно для облачных служб (рабочих и веб-роль), Service Fabric и наборы масштабирования виртуальных машин.


Самостоятельного обслуживания не рекомендуется для развертываний с помощью **наборов доступности** поскольку они настройки высокой доступности, где это повлияет на обновления только один домен в любой момент времени. 
    - Возможность Azure триггер обслуживания, но имейте в виду, что порядок понижает домены обновления не произойдет обязательно последовательно наличие и 30-минутным паузу между доменами обновления.
    - Если временная потеря некоторых возможностей (количество доменов 1 или обновление) является серьезной проблемой, его можно легко скомпенсировать путем выделения добавление экземпляров в период обслуживания. 

**Не** использовать самостоятельного обслуживания в следующих сценариях: 
    - При завершении работы виртуальных машин, как правило, либо вручную, с помощью DevTest labs, с помощью автоматического завершения работы или согласно установленному расписанию, он может вернуть состояние обслуживания, что вызовет дополнительные время простоя.
    - Кратковременных виртуальные машины, которых вы знаете, будут удалены перед концом wave обслуживания. 
    - Для рабочих нагрузок с большой состояние, сохраненное на локальном диске (эфемерных), необходимые для сохраняться после обновления. 
    - Для случаев, где можно изменить размер виртуальной Машины часто как оно может вернуть состояние обслуживания. 
    - Если были приняты запланированные события, которые позволяют упреждающую отработку отказа или корректное завершение работы рабочей нагрузки 15 минут до начала обслуживания завершения работы

**Используйте** самостоятельного обслуживания, если предполагается использовать без перерыва во время фазы запланированного обслуживания ВМ и неприменимы счетчиков указывают, упомянутых выше. 

Лучше всего использовать самостоятельного обслуживания в следующих случаях:
    - Необходимо взаимодействовать периода обслуживания точное управление или конечный пользователь. 
    - Необходимые для выполнения обслуживания по заданной даты. 
    - Необходимо управлять последовательностью обслуживания, например, многоуровневого приложения для обеспечения безопасного восстановления.
    - Требуется более 30 минут времени восстановления виртуальной Машины между двумя доменами обновления (доменам обновления). Чтобы задать время между доменами обновления, должен инициировать обслуживания на вашей ВМ в одном домене обновления (UD) одновременно.

 

[!INCLUDE [virtual-machines-common-maintenance-notifications](../../../includes/virtual-machines-common-maintenance-notifications.md)]

## <a name="check-maintenance-status-using-powershell"></a>Проверка состояния обслуживания с помощью PowerShell

Чтобы узнать, когда для виртуальных машин запланировано обслуживание, можно также использовать Azure PowerShell. Информацию о плановом обслуживании можно получить с помощью командлета [Get AzureRmVM](/powershell/module/azurerm.compute/get-azurermvm), используя параметр `-status`.
 
Сведения об обслуживании возвращаются, только если имеется запланированное обслуживание. Если нет запланированного обслуживания, влияющего на виртуальную машину, командлет не возвращает информацию об обслуживании. 

```powershell
Get-AzureRmVM -ResourceGroupName rgName -Name vmName -Status
```

В разделе MaintenanceRedeployStatus возвращаются следующие свойства: 
| Значение | Описание   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на виртуальной машине ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| PreMaintenanceWindowEndTime           | Завершение периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowEndTime              | Завершение периода запланированного обслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| LastOperationResultCode               | Результат последней попытки инициирования обслуживания на виртуальной машине ||



Вы также можете получить информацию о состоянии обслуживания для всех виртуальных машин в группе ресурсов с помощью командлета [Get AzureRmVM](/powershell/module/azurerm.compute/get-azurermvm), не указывая виртуальную машину.
 
```powershell
Get-AzureRmVM -ResourceGroupName rgName -Status
```

Следующая функция PowerShell принимает идентификатор подписки и выводит список виртуальных машин, запланированных для обслуживания.

```powershell

function MaintenanceIterator
{
    Select-AzureRmSubscription -SubscriptionId $args[0]

    $rgList= Get-AzureRmResourceGroup 

    for ($rgIdx=0; $rgIdx -lt $rgList.Length ; $rgIdx++)
    {
        $rg = $rgList[$rgIdx]        $vmList = Get-AzureRMVM -ResourceGroupName $rg.ResourceGroupName 
        for ($vmIdx=0; $vmIdx -lt $vmList.Length ; $vmIdx++)
        {
            $vm = $vmList[$vmIdx]
            $vmDetails = Get-AzureRMVM -ResourceGroupName $rg.ResourceGroupName -Name $vm.Name -Status
              if ($vmDetails.MaintenanceRedeployStatus )
            {
                Write-Output "VM: $($vmDetails.Name)  IsCustomerInitiatedMaintenanceAllowed: $($vmDetails.MaintenanceRedeployStatus.IsCustomerInitiatedMaintenanceAllowed) $($vmDetails.MaintenanceRedeployStatus.LastOperationMessage)"               
            }
          }
    }
}

```

### <a name="start-maintenance-on-your-vm-using-powershell"></a>Запуск обслуживания вашей виртуальной машины с помощью PowerShell

Используя информацию из функции в предыдущем разделе, следующая команда запускает обслуживание на виртуальной машине, если для свойства **IsCustomerInitiatedMaintenanceAllowed** задано значение true.

```powershell
Restart-AzureRmVM -PerformMaintenance -name $vm.Name -ResourceGroupName $rg.ResourceGroupName 
```

## <a name="classic-deployments"></a>Классические развертывания

Если у вас все еще есть устаревшие виртуальные машины, развернутые с использованием классической модели развертывания, вы можете сделать запрос к ним и запустить их обслуживание с помощью PowerShell.

Чтобы узнать состояние обслуживания виртуальной машины, введите:

```
Get-AzureVM -ServiceName <Service name> -Name <VM name>
```

Чтобы начать обслуживания классической виртуальной Машины, введите следующую команду:

```
Restart-AzureVM -InitiateMaintenance -ServiceName <service name> -Name <VM name>
```


## <a name="faq"></a>Часто задаваемые вопросы


**Вопрос. Зачем вам нужно перезагружать сейчас мою виртуальную машину?**

**Ответ.** Хотя обновления платформы Azure преимущественно не оказывают влияния на доступность виртуальных машин, иногда мы не можем избежать перезагрузки виртуальных машин, размещенных в Azure. Мы хотим внести несколько изменений, и для этого нам нужно перезапустить наши серверы. Это, в свою очередь, приведет к перезагрузке виртуальных машин.

**Вопрос. Безопасно ли выполнять рекомендации по обеспечению высокой доступности с помощью группы доступности?**

**Ответ** виртуальных машин, развернутых в группе доступности набор или наборы масштабирования виртуальных машин имеют понятие доменов обновления (UD). Во время обслуживания Azure учитывает ограничения доменов обновления и не выполняет перезагрузку виртуальных машин из разных доменов обновления (в пределах одной и той же группы доступности).  Azure также ожидает минимум 30 минут, прежде чем переходить к следующей группе виртуальных машин. 

Дополнительные сведения о высокой доступности см. в разделе [области и доступности для виртуальных машин в Azure](regions-and-availability.MD).

**Вопрос. Как происходит информирование о плановом обслуживании?**

**Ответ.** Процедура планового обслуживания начинается с настройки расписания для одного или нескольких регионов Azure. Вскоре после этого владельцам подписки отправляется уведомление по электронной почте (одно сообщение для каждой подписки). Дополнительные каналы и получатели для этого уведомления можно настроить с помощью оповещений журнала действий. При развертывании виртуальной машины в регионе, в котором плановое обслуживание назначено по расписанию, вы не получите уведомление. Вам нужно будет проверить состояние обслуживания виртуальной машины.

**Вопрос. Почему информация о плановом обслуживании не отображается на портале, в PowerShell или интерфейсе командной строки?**

**Ответ.** Сведения о плановом обслуживании доступны в ходе этой процедуры только для виртуальных машин, которые включены в плановое обслуживание. Другими словами, если данные не отображаются, это значит, что процедура обслуживания уже завершена (или не начата) или виртуальная машина уже размещена на обновленном сервере.

**Вопрос. Можно ли точно узнать, когда моя виртуальная машина будет затронута?**

**Ответ.** При планировании расписания мы определяем временное окно в несколько дней. Но точная последовательность серверов (и связанных виртуальных машин) в рамках этого окна неизвестна. Клиентов, которые хотели бы узнать точное время для их виртуальных машин можно использовать [назначенные задания](scheduled-events.md) запроса из виртуальной машины и получать уведомления о 15 минут до перезагрузки виртуальной Машины.

**Вопрос. Как долго моя виртуальная машина будет перезагружаться?**

**Ответ.** В зависимости от размера виртуальной машины перезагрузка может занять несколько минут. Обратите внимание, что в случае, если вы используете облачных служб (рабочих и веб-роль), задает масштабирования виртуальной машины или группы доступности, вам будет предоставлена 30 минут между каждой группой из виртуальных машин (UD). 

**Вопрос. что такое взаимодействие в случае облачных служб (рабочих и веб-роль), Service Fabric и наборы масштабирования виртуальных машин?**

**Ответ.** Так как эти платформы будут затронуты плановым обслуживанием, клиенты смогут их безопасно использовать, если в указанный момент времени будут затронуты только виртуальные машины в одном домене обновления. Самостоятельное обслуживание сейчас недоступно для облачных служб (рабочих и веб-роль), Service Fabric и наборы масштабирования виртуальных машин.

**Вопрос. Мне пришло сообщение электронной почты о выводе оборудования из эксплуатации. Это и есть плановое обслуживание?**

**Ответ.** Хотя вывод оборудования из эксплуатации является частью планового обслуживания, мы еще не реализовали этот сценарий.  

**Вопрос. Информация об обслуживании не отображается в виртуальных машинах. В чем может быть проблема?**

**Ответ.** Есть несколько причин, по которым вы можете не видеть информацию об обслуживании в виртуальных машинах:
1.  Вы используете подписку, отмеченную в Майкрософт как внутренняя.
2.  Для виртуальных машин не запланировано обслуживание. Процедура обслуживания завершена, отменена или изменена так, чтобы не влиять на виртуальные машины.
3.  Не нужно **обслуживания** столбец, добавленный в представлении списка виртуальных Машин. Хотя мы добавили этот столбец в представление по умолчанию, клиенты, которые настроили отображение пользовательских столбцов, должны вручную добавить столбец **Обслуживание** в представление списка виртуальных машин.

**Вопрос. Для моей виртуальной машины запланировано обслуживание во второй раз. Почему?**

**Ответ.** Есть несколько ситуаций, когда для виртуальной машины может быть запланирована еще одна процедура после обслуживания с повторным развертыванием:
1.  Мы отменили процедуру обслуживания и перезапустили ее с другими полезными данными. Мы обнаружили неисправные полезные данные, и нам просто нужно развернуть дополнительные полезные данные.
2.  Виртуальная машина *восстановлена* на другой узел из-за сбоя оборудования.
3.  Вы решили остановить (отменить распределение) и перезапустить виртуальную машину.
4.  Вы настроили **автоматическое завершение работы** для виртуальной машины.


**Вопрос обслуживание my набора доступности занимает много времени и «пропустить» для некоторых my доступности значение статуса экземпляров появиться. Почему?** 

**Ответ** после щелчка для обновления нескольких экземпляров в группу доступности в течение короткого промежутка времени Azure эти запросы в очередь и запускает обновление только виртуальные машины в домене один обновления (UD) одновременно. Тем не менее поскольку может быть пауза между доменами обновления, обновления могут оказаться дольше. Если очередь обновления занимает больше времени, чем 60 минут, будет отображаться некоторые экземпляры **пропущен** состояние, даже если они успешно обновлены. Во избежание этого неверное состояние, обновление, которое задает доступность, щелкнув в пределах одного доступности задать и дождитесь обновления для этой виртуальной Машины для выполнения перед нажатием кнопки на виртуальной Машине, далее в домене другое обновление.


## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как зарегистрироваться для событий обслуживания прямо из виртуальной машины с помощью функции [запланированных событий](scheduled-events.md).
