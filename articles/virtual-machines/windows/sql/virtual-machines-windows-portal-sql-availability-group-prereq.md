---
title: Необходимые компоненты для использования групп доступности SQL Server в Виртуальных машинах Azure | Документация Майкрософт
description: В этом руководстве показано, как настроить необходимые компоненты для создания группы доступности AlwaysOn для SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
authors: MikeRayMSFT
manager: craigg
editor: monicar
tags: azure-service-management
ms.assetid: c492db4c-3faa-4645-849f-5a1a663be55a
ms.service: virtual-machines-sql
ms.devlang: na
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/29/2018
ms.author: mikeray
ms.openlocfilehash: f2a0af65af068f3a78a08e46e0e42caefd87d7b1
ms.sourcegitcommit: 20d103fb8658b29b48115782fe01f76239b240aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2018
ms.locfileid: "30322902"
---
# <a name="complete-the-prerequisites-for-creating-always-on-availability-groups-on-azure-virtual-machines"></a>Настройка необходимых компонентов для создания групп доступности AlwaysOn на виртуальных машинах Azure

В этом руководстве показано, как настроить необходимые компоненты для создания [группы доступности AlwaysOn для SQL Server на виртуальных машинах Azure](virtual-machines-windows-portal-sql-availability-group-tutorial.md). Когда необходимые компоненты будут настроены, у вас будут подготовлены контроллер домена, две виртуальные машины SQL Server и следящий сервер в одной группе ресурсов.

**Оценка времени.** Чтобы завершить настройку необходимых компонентов, может потребоваться несколько часов. Большая часть времени уходит на создание виртуальных машин.

На схеме ниже показаны шаги, которые описываются в этом руководстве.

![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/00-EndstateSampleNoELB.png)

## <a name="review-availability-group-documentation"></a>Обзор документации по группам доступности

В этом руководстве предполагается, что у вас имеется базовое представление о группах доступности AlwaysOn SQL Server. Если же данная технология вам незнакома, изучите статью [Обзор групп доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/ff877884.aspx).


## <a name="create-an-azure-account"></a>Создание учетной записи Azure
Вам понадобится учетная запись Azure. Вы можете [создать бесплатную учетную запись Azure](/pricing/free-trial/?WT.mc_id=A261C142F) или [активировать преимущества для подписчиков Visual Studio](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=A261C142F).

## <a name="create-a-resource-group"></a>Создание группы ресурсов
1. Войдите на [портале Azure](http://portal.azure.com).
2. Щелкните **+**, чтобы создать объект на портале.

   ![Новый объект](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-portalplus.png)

3. В окне поиска **Marketplace** введите **группа ресурсов**.

   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-resourcegroupsymbol.png)
4. Щелкните **Группа ресурсов**.
5. Нажмите кнопку **Создать**.
6. В разделе **Имя группы ресурсов** введите имя для группы ресурсов. Например, введите **sql-ha-rg**.
7. При наличии нескольких подписок Azure выберите ту, в которой необходимо создать группу доступности.
8. Выберите расположение. Расположение — это регион Azure, где необходимо создать группу доступности. В этой статье все ресурсы созданы в одном расположении Azure.
9. Убедитесь, что флажок **Закрепить на панели мониторинга** установлен. Этот необязательный параметр позволяет разместить ярлык для группы ресурсов на панели мониторинга портала Azure.

   ![Группа ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/01-resourcegroup.png)

10. Щелкните **Создать** , чтобы создать группу ресурсов.

В среде Azure будет создана группа ресурсов, а ее ярлык закреплен на портале.

## <a name="create-the-network-and-subnets"></a>Создание сети и подсетей
Следующий шаг — создание сетей и подсетей в группе ресурсов Azure.

В решении используется виртуальная сеть с двумя подсетями. Дополнительные сведения о сетях в Azure см. в разделе [Обзор виртуальной сети](../../../virtual-network/virtual-networks-overview.md).

Создание виртуальной сети

1. На портале Azure в своей группе ресурсов щелкните **+ Добавить**. 

   ![Новый элемент](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/02-newiteminrg.png)
2. Введите в поле поиска **виртуальная сеть**.

     ![Поиск виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/04-findvirtualnetwork.png)
3. Щелкните **Виртуальная сеть**.
4. В колонке **Виртуальная сеть** выберите модель развертывания **Resource Manager** и щелкните **Создать**.

    В таблице ниже приведены параметры для виртуальной сети.

   | **Поле** | Значение |
   | --- | --- |
   | **Имя** |autoHAVNET |
   | **Пространство адресов** |10.33.0.0/24 |
   | **Имя подсети** |Администратор |
   | **Диапазон адресов подсети** |10.33.0.0/29 |
   | **Подписка** |Укажите подписку, которую нужно использовать. **Подписка.** Если есть только одна подписка, то этот параметр может быть пустым. |
   | **Группа ресурсов** |Выберите **Использовать существующую** и выберите имя группы ресурсов. |
   | **Местоположение.** |Укажите расположение Azure. |

   Адресное пространство и диапазон адресов подсети могут отличаться от указанных в таблице. В зависимости от подписки портал подскажет доступное адресное пространство и соответствующий диапазон адресов подсети. Если достаточное пространство адресов недоступно, используйте другую подписку.

   В примере используется имя подсети **admin**. Эта подсеть для контроллеров домена.

5. Нажмите кнопку **Создать**.

   ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/06-configurevirtualnetwork.png)

Вы вернетесь к панели мониторинга портала Azure и получите уведомление о создании сети.

### <a name="create-a-second-subnet"></a>Создание второй подсети
Новая виртуальная сеть имеет одну подсеть с именем **admin**. Ее используют контроллеры домена. Виртуальные машины SQL Server используют вторую подсеть, **SQL**. Чтобы настроить эту подсеть, сделайте следующее:

1. На панели мониторинга щелкните созданную группу ресурсов **SQL-HA-RG**. Найдите сеть в группе ресурсов в разделе **Ресурсы**.

    Если группа ресурсов **SQL-HA-RG** не отображается, ее можно найти, выбрав **Группы ресурсов** и установив фильтрацию по имени группы ресурсов.
2. Щелкните **autoHAVNET** в списке ресурсов. 
3. В виртуальной сети **autoHAVNET** выберите **Параметры**, а затем — **Подсети**.

    Обратите внимание на созданную подсеть.

   ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/07-addsubnet.png)
5. Создайте вторую подсеть. Щелкните **+ Subnet**(+Подсеть).
6. В колонке **Добавление подсети** настройте подсеть, указав в поле **Имя** значение **sqlsubnet**. Azure автоматически укажет допустимое значение в поле **Диапазон адресов**. Убедитесь, что этот диапазон адресов содержит по крайней мере 10 адресов. Для рабочей среды может потребоваться больше адресов.
7. Последовательно выберите **ОК**.

    ![Настройка виртуальной сети](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/08-configuresubnet.png)

В следующей таблице описаны параметры конфигурации сети.

| **Поле** | Значение |
| --- | --- |
| **Имя** |**autoHAVNET** |
| **Пространство адресов** |Это значение зависит от доступных адресных пространств в подписке. Стандартное значение — 10.0.0.0/16. |
| **Имя подсети** |**admin** |
| **Диапазон адресов подсети** |Это значение зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.0.0/24. |
| **Имя подсети** |**sqlsubnet** |
| **Диапазон адресов подсети** |Это значение зависит от доступных диапазонов адресов в подписке. Стандартное значение — 10.0.1.0/24. |
| **Подписка** |Укажите подписку, которую нужно использовать. |
| **Группа ресурсов** |**SQL-HA-RG** |
| **Местоположение.** |Укажите расположение, выбранное для группы ресурсов. |

## <a name="create-availability-sets"></a>Создание групп доступности

Прежде чем создавать виртуальные машины, необходимо создать группы доступности. Такие группы позволяют сократить простой при плановых и внеплановых событиях обслуживания. Группа доступности Azure представляет собой логическую группу ресурсов, которую Azure помещает в физические домены сбоя и домены обновления. Домен сбоя обеспечивает разделение ресурсов питания и сетевых ресурсов для элементов группы доступности. Домен обновления гарантирует, что элементы группы доступности не отключаются для обслуживания одновременно. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин Windows в Azure](../manage-availability.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

Вам потребуется две группы доступности: одна для контроллеров домена, а вторая для виртуальных машин SQL Server.

Чтобы создать группу доступности, перейдите в колонку группы ресурсов и щелкните **Добавить**. Отфильтруйте результаты по запросу **Группа доступности**. В результатах выберите **Группа доступности**, затем щелкните **Создать**.

Настройте две группы доступности в соответствии с параметрами в таблице ниже.

| **Поле** | Группа доступности контроллера домена | Группа доступности SQL Server |
| --- | --- | --- |
| **Имя** |adavailabilityset |sqlavailabilityset |
| **Группа ресурсов** |SQL-HA-RG |SQL-HA-RG |
| **Домены сбоя** |3 |3 |
| **Домены обновления** |5 |3 |

Создав группы доступности, вернитесь в колонку группы ресурсов на портале Azure.

## <a name="create-domain-controllers"></a>Создание контроллеров домена
После создания сети, подсетей, групп доступности и подсистемы балансировки нагрузки с доступом к Интернету все готово к созданию виртуальных машин для контроллеров домена.

### <a name="create-virtual-machines-for-the-domain-controllers"></a>Создание виртуальных машин для контроллеров домена
Чтобы создать и настроить контроллеры домена, вернитесь к группе ресурсов **SQL-HA-RG** .

1. Щелкните **Добавить**. 
2. Введите **Windows Server 2016 Datacenter**.
3. Щелкните **Windows Server 2016 Datacenter**. Убедитесь, что в колонке **Windows Server 2016 Datacenter** в качестве модели развертывания выбран параметр **Resource Manager**, а затем щелкните **Создать**. 

Повторите действия выше, чтобы создать две виртуальные машины. Присвойте этим виртуальным машинам следующие имена:

* ad-primary-dc
* ad-secondary-dc.

  > [!NOTE]
  > **ad-secondary-dc** — дополнительная виртуальная машина, служащая для обеспечения высокого уровня доступности доменных служб Active Directory.
  >
  >

В таблице ниже приведены параметры для этих двух машин.

| **Поле** | Значение |
| --- | --- |
| **Имя** |Первый контроллер домена: *ad-primary-dc*.</br>Второй контроллер домена *ad-secondary-dc*. |
| **Тип диска виртуальной машины** |SSD |
| **Имя пользователя** |DomainAdmin |
| **Пароль** |Contoso!0000 |
| **Подписка** |*Ваша подписка* |
| **Группа ресурсов** |SQL-HA-RG |
| **Местоположение.** |*Ваше расположение* |
| **Размер** |DS1_V2 |
| **Хранилище** | **Использование управляемых дисков** - **Да** |
| **Виртуальная сеть** |autoHAVNET |
| **Подсеть** |admin |
| **Общедоступный IP-адрес** |*Совпадает с именем виртуальной машины* |
| **группа безопасности сети**. |*Совпадает с именем виртуальной машины* |
| **группа доступности;** |adavailabilityset </br>**Домены сбоя**: 2</br>**Домены обновления**: 2|
| **Диагностика** |Включено |
| **Учетная запись хранения для диагностики** |*Создается автоматически* |

   >[!IMPORTANT]
   >Виртуальную машину можно разместить в группе доступности только при ее создании. После создания виртуальной машины группу доступности изменить невозможно. Дополнительные сведения см. в статье [Управление доступностью виртуальных машин](../manage-availability.md).

Azure создаст виртуальные машины.

После создания виртуальных машин следует настроить контроллер домена.

### <a name="configure-the-domain-controller"></a>Настройка контроллера домена
На следующих этапах необходимо настроить машину **ad-primary-dc** в качестве контроллера домена для corp.contoso.com.

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-primary-dc**. В колонке **ad-primary-dc** нажмите **Подключиться**, чтобы открыть RDP-файл для подключения к удаленному рабочему столу.

    ![Подключение к виртуальной машине](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/20-connectrdp.png)
2. Войдите в систему, используя настроенную учетную запись администратора (**\DomainAdmin**) и ее пароль (**Contoso!0000**).
3. По умолчанию отображается панель мониторинга **Диспетчер серверов** .
4. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.

    ![Диспетчер сервера. Добавление ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
5. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
6. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.

   > [!NOTE]
   > Windows предупреждает о том, что статического IP-адреса не существует. Если вы тестируете конфигурацию, нажмите кнопку **Продолжить**. Для рабочих сценариев на портале Azure установите статический IP-адрес или [используйте PowerShell для установки статического IP-адреса компьютера контроллера домена](../../../virtual-network/virtual-networks-reserved-private-ip.md).
   >
   >

    ![Диалоговое окно добавления ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/23-addroles.png)
7. Нажимайте **Далее**, пока не откроется раздел **Подтверждение**. Установите флажок **Автоматически перезапускать конечный сервер, если это потребуется**.
8. Щелкните **Install**(Установить).
9. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
10. Выберите новый вариант **AD DS** на левой панели.
11. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.

    ![Диалоговое окно службы каталогов Active Directory на виртуальной машине DNS-сервера](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/24-addsmore.png)
12. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
13. В **мастере настройки доменных служб Active Directory**используйте следующие значения:

    | **Страница** | Параметр |
    | --- | --- |
    | **Конфигурация развертывания** |**Добавить новый лес**<br/> **Имя корневого домена** = corp.contoso.com |
    | **Параметры контроллера домена** |**Пароль DSRM** = Contoso!0000<br/>**Подтверждение пароля** = Contoso!0000 |
14. Нажимайте кнопку **Далее** , чтобы пройти остальные страницы мастера. Убедитесь, что на странице **Проверка готовности** отображается следующее сообщение: **Все проверки готовности успешно завершены**. Можно просмотреть все применимые предупреждающие сообщения, хотя для продолжения установки это и не обязательно.
15. Щелкните **Install**(Установить). Виртуальная машина **ad-primary-dc** перезагружается автоматически.

### <a name="note-the-ip-address-of-the-primary-domain-controller"></a>Запишите IP-адрес основного контроллера домена.

Используйте основной контроллер домена для DNS. Запишите IP-адрес основного контроллера домена.

Получить IP-адрес основного контроллера домена можно только через портал Azure.

1. На портале Azure откройте группу ресурсов.

2. Щелкните основной контроллер домена.

3. В основном контроллере домена щелкните **Сетевые интерфейсы**.

![Сетевые интерфейсы](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/25-primarydcip.png)

Сохраните частный IP-адрес для этого сервера.

### <a name="configure-the-virtual-network-dns"></a>Настройка DNS виртуальной сети
После создания первого контроллера домена и включения DNS на первом сервере, настройте виртуальную сеть для использования этого сервера для DNS.

1. На портале Azure выберите виртуальную сеть.

2. В разделе **Параметры** выберите **DNS-сервер**.

3. Щелкните **Настраиваемый** и введите частный IP-адрес основного контроллера домена.

4. Выберите команду **Сохранить**.

### <a name="configure-the-second-domain-controller"></a>Настройка второго контроллера домена
После перезагрузки основного контроллера домена можно настроить второй контроллер домена. Этот необязательный шаг выполняется для обеспечения высокой доступности. Чтобы настроить второй контроллер домена, сделайте следующее:

1. На портале откройте группу ресурсов **SQL-HA-RG** и выберите машину **ad-secondary-dc**. В колонке **ad-secondary-dc** нажмите **Подключиться**, чтобы открыть RDP-файл для подключения к удаленному рабочему столу.
2. Войдите в виртуальную машину, используя настроенную учетную запись администратора (**BUILTIN\DomainAdmin**) и ее пароль (**Contoso!0000**).
3. Измените предпочтительный адрес DNS-сервера на адрес контроллера домена.
4. В **Центре управления сетями и общим доступом** щелкните сетевой интерфейс.
   ![Сетевой интерфейс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/26-networkinterface.png)

5. Щелкните **Свойства**.
6. Выберите **Протокол IP версии 4 (TCP/IPv4)** и нажмите кнопку **Свойства**.
7. Установите переключатель **Использовать следующие адреса DNS-серверов** и укажите адрес основного контроллера домена в поле **Предпочитаемый DNS-сервер**.
8. Нажмите кнопку **ОК**, а затем — **Закрыть**, чтобы сохранить изменения. Теперь вы можете присоединить виртуальную машину к домену **corp.contoso.com**.

   >[!IMPORTANT]
   >Если вы потеряете подключение к удаленному рабочему столу после изменения параметров DNS-сервера, перейдите на портал Azure и перезапустите виртуальную машину.

9. С удаленного рабочего стола на втором контроллере домена откройте **панель мониторинга диспетчера сервера**.
10. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.

    ![Диспетчер сервера. Добавление ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
11. Нажимайте **Далее**, пока не откроется раздел **Роли сервера**.
12. Выберите роли **Доменные службы Active Directory** и **DNS-сервер**. При появлении запроса добавьте требуемые для этих ролей дополнительные компоненты.
13. После установки компонентов вернитесь к панели мониторинга **Диспетчер серверов** .
14. Выберите новый вариант **AD DS** на левой панели.
15. Щелкните ссылку **Дополнительно** на желтой панели предупреждения.
16. В столбце **Действие** диалогового окна **Сведения обо всех задачах сервера** нажмите **Повысить роль этого сервера до уровня контроллера домена**.
17. На вкладке **Конфигурация развертывания** установите переключатель **Добавить контроллер домена в существующий домен**.
   ![Конфигурация развертывания](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/28-deploymentconfig.png)
18. Нажмите кнопку **Выбрать**.
19. Подключитесь, используя учетную запись администратора (**CORP.CONTOSO.COM\domainadmin**) и ее пароль (**Contoso!0000**).
20. В разделе **Выберите домен в лесу** щелкните свой домен, а затем щелкните **ОК**.
21. В разделе **Параметры контроллера домена** используйте значения по умолчанию и задайте пароль DSRM.

   >[!NOTE]
   >На странице **Параметры DNS** может отобразиться предупреждение о том, что делегирование для этого DNS-сервера создать невозможно. В нерабочей среде это предупреждение можно игнорировать.
22. Нажимайте кнопку **Далее** до тех пор, пока не откроется вкладка **Предварительные требования**. Нажмите **Install**(Установить).

После завершения изменений конфигурации перезапустите сервер.

### <a name="add-the-private-ip-address-to-the-second-domain-controller-to-the-vpn-dns-server"></a>Добавление частного IP-адреса для второго контроллера домена на DNS-сервер VPN

На портале Azure в колонке виртуальной сети измените параметры DNS-сервера, добавив IP-адрес дополнительного контроллера домена. Этот параметр обеспечивает избыточность службы DNS.

### <a name=DomainAccounts></a>Настройка доменных учетных записей

На следующих шагах настраиваются учетные записи Active Directory. Учетные записи показаны в следующей таблице.

| |Учетная запись установки<br/> |sqlserver-0 <br/>Учетная запись SQL Server и службы агента SQL |sqlserver-1<br/>Учетная запись SQL Server и службы агента SQL
| --- | --- | --- | ---
|**Имя** |Install |SQLSvc1 | SQLSvc2
|**User SamAccountName** |Install |SQLSvc1 | SQLSvc2

Чтобы создать каждую учетную запись, сделайте следующее:

1. Войдите в виртуальную машину **ad-primary-dc**.
2. На панели **Диспетчер серверов** выберите **Средства**, а затем щелкните **Центр администрирования Active Directory**.   
3. Выберите **corp (local)** в левой области.
4. В правой области **Задачи** выберите **Создать** и щелкните **Пользователь**.
   ![Центр администрирования Active Directory](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/29-addcnewuser.png)

   >[!TIP]
   >Задайте сложный пароль для каждой учетной записи.<br/> Для нерабочей среды задайте неограниченный срок действия учетной записи пользователя.

5. Нажмите кнопку **ОК**, чтобы создать пользователя.
6. Повторите предыдущие действия для каждой из трех учетных записей.

### <a name="grant-the-required-permissions-to-the-installation-account"></a>Предоставление требуемых разрешений учетной записи установки
1. В **центре администрирования Active Directory** выберите **corp (локальный)** на левой панели. Затем на правой панели **Задачи** нажмите кнопку **Свойства**.

    ![Свойства пользователя CORP](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/31-addcproperties.png)
2. Выберите **Расширения**, затем нажмите кнопку **Дополнительно** на вкладке **Безопасность**.
3. В диалоговом окне **Дополнительные параметры безопасности для corp** нажмите кнопку **Добавить**.
4. Щелкните **Выберите субъект**, найдите **CORP\Install** и нажмите кнопку **ОК**.
5. Установите флажок **Чтение всех свойств**.

6. Установите флажок **Create Computer objects** (Создание объектов-компьютеров).

     ![Разрешения пользователя CORP](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/33-addpermissions.png)
7. Нажмите кнопку **ОК**, а затем снова кнопку **ОК**. Закройте окно свойств **corp**.

После завершения настройки Active Directory и объектов-пользователей нужно создать две виртуальные машины SQL Server и виртуальную машину следящего сервера. Затем присоедините их к этому домену.

## <a name="create-sql-server-vms"></a>Создание виртуальных машин SQL Server

Создайте три дополнительные виртуальные машины. Для решения требуются две виртуальные машины с экземплярами SQL Server. Третья виртуальная машина будет выполнять роль свидетеля. Windows Server 2016 может использовать [облако-свидетель](http://docs.microsoft.com/windows-server/failover-clustering/deploy-cloud-witness), но для обеспечения согласованности с предыдущими операционными системами в этом документе в качестве свидетеля используется виртуальная машина.  

Перед продолжением рассмотрите следующие решения разработки.

* **Хранилище — управляемые диски Azure**

   Для хранилища виртуальных машин используйте управляемые диски Azure. Корпорация Майкрософт рекомендует управляемые диски для виртуальных машин SQL Server. Управляемые диски управляют хранилищем в фоновом режиме. Кроме того, когда виртуальные машины с управляемыми дисками находятся в одной группе доступности, Azure распределяет ресурсы хранения, чтобы обеспечить соответствующую избыточность. Дополнительные сведения см. в [обзоре управляемых дисков Azure](../managed-disks-overview.md). Подробные сведения об управляемых дисках в группе доступности см. в разделе [Использование управляемых дисков для виртуальных машин в группе доступности](../manage-availability.md#use-managed-disks-for-vms-in-an-availability-set).

* **Сеть — частные IP-адреса в рабочей среде**

   В этом руководстве для виртуальных машин используются общедоступные IP-адреса. Общедоступный IP-адрес позволяет удаленно подключаться через Интернет непосредственно к виртуальной машине, что облегчает настройку. Корпорация Майкрософт рекомендует использовать в рабочих средах только частные IP-адреса для снижения уязвимости ресурса виртуальной машины с экземпляром SQL Server.

### <a name="create-and-configure-the-sql-server-vms"></a>Создание и настройка виртуальных машин SQL Server
Далее создайте три виртуальные машины: две виртуальные машины SQL Server и виртуальную машину для дополнительного узла кластера. Чтобы создать виртуальные машины, вернитесь к группе ресурсов **SQL-HA-RG**, нажмите кнопку **Добавить**, найдите соответствующий элемент коллекции, щелкните **Виртуальная машина**, а затем — **Из коллекции**. Используйте информацию из следующей таблицы, чтобы упростить создание виртуальных машин.


| Страница | VM1 | VM2 | VM3 |
| --- | --- | --- | --- |
| Выбор соответствующего элемента коллекции |**Windows Server 2016 Datacenter** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |**SQL Server 2016 SP1 Enterprise на базе Windows Server 2016** |
| Конфигурация виртуальной машины **Базовый** |**Имя** = cluster-fsw<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-0<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |**Имя** = sqlserver-1<br/>**Имя пользователя** = DomainAdmin<br/>**Пароль** = Contoso!0000<br/>**Подписка** = ваша подписка<br/>**Группа ресурсов** = SQL-HA-RG<br/>**Расположение** = ваше расположение Azure |
| Конфигурация виртуальной машины **Размер** |**РАЗМЕР** = DS1\_V2 (1 виртуальный ЦП, 3,5 ГБ) |**РАЗМЕР** = DS2\_V2 (2 виртуальных ЦП, 7 ГБ)</br>Размер должен поддерживать SSD-хранилище (поддержка дисков "Премиум" ) |**РАЗМЕР** = DS2\_V2 (2 виртуальных ЦП, 7 ГБ) |
| Конфигурация виртуальной машины **Параметры** |**Хранилище**: используйте управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |**Хранилище**: используйте управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |**Хранилище**: используйте управляемые диски.<br/>**Виртуальная сеть** = autoHAVNET<br/>**Подсеть** = sqlsubnet(10.1.1.0/24)<br/>**Общедоступный IP-адрес** создается автоматически.<br/>**Группа безопасности сети** = нет<br/>**Диагностика мониторинга** = включено<br/>**Учетная запись хранения для диагностики** = используйте автоматически созданную учетную запись хранения<br/>**Группа доступности** = sqlAvailabilitySet<br/> |
| Конфигурация виртуальной машины **Параметры SQL Server** |Не применяется |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |**Подключение к SQL** = закрытое (в виртуальной сети)<br/>**Порт** = 1433<br/>**Проверка подлинности SQL** = отключено<br/>**Конфигурация хранилища** = общая<br/>**Автоматическое исправление** = воскресенье в 2:00<br/>**Автоматическая архивация** = отключено</br>**Интеграция хранилища ключей Azure** = отключено |

<br/>

> [!NOTE]
> Предлагаемые здесь размеры компьютеров предназначены для тестирования групп доступности в виртуальных машинах Azure. Для обеспечения оптимальной производительности рабочих нагрузок изучите рекомендации по размерам машин SQL Server и их настройке в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
>
>

После завершения подготовки трех виртуальных машин вам потребуется присоединить их к домену **corp.contoso.com** и предоставить пользователю CORP\Install права администратора виртуальных машин.

### <a name="joinDomain"></a>Присоединение серверов к домену

Теперь вы можете присоединить виртуальные машины к домену **corp.contoso.com**. Выполните следующие действия для виртуальных машин SQL Server и сервера файловых ресурсов-свидетелей.

1. Удаленно подключитесь к виртуальной машине в качестве пользователя **BUILTIN\DomainAdmin**.
2. В **диспетчере сервера** щелкните **Локальный сервер**.
3. Щелкните ссылку **Рабочая группа**.
4. В разделе **Имя компьютера** нажмите кнопку **Изменить**.
5. Установить флажок **Домен** и введите в текстовом поле **corp.contoso.com**. Последовательно выберите **ОК**.
6. Во всплывающем диалоговом окне **Безопасность Windows** укажите имя (**CORP\DomainAdmin**) и пароль (**Contoso!0000**) учетной записи администратора домена по умолчанию.
7. При появлении сообщения "Добро пожаловать на домен corp.contoso.com" нажмите кнопку **ОК**.
8. Нажмите кнопку **Закрыть**, а затем **Перезагрузить сейчас** во всплывающем диалоговом окне.

### <a name="add-the-corpinstall-user-as-an-administrator-on-each-cluster-vm"></a>Добавление пользователя Corp\Install в качестве администратора на каждой виртуальной машине кластера

После того как каждая виртуальная машина будет перезапущена и войдет в состав домена, добавьте **CORP\Install** как участника группы локальных администраторов.

1. Дождитесь перезапуска виртуальной машины, а затем запустите RDP-файл еще раз на основном контроллере домена, чтобы войти на **sqlserver-0**, используя учетную запись **CORP\DomainAdmin**.
   >[!TIP]
   >Обязательно выполните вход с использованием учетной записи администратора домена. Ранее вы использовали учетную запись администратора BUILTIN. Теперь, когда сервер находится в домене, используйте учетную запись домена. В сеансе RDP укажите *Домен*\\*имя пользователя*.

2. На панели **Диспетчер серверов** выберите **Инструменты**, а затем щелкните **Управление компьютером**.
3. В окне **Управление компьютерами** разверните пункт **Локальные пользователи и группы**, а затем выберите **Группы**.
4. Дважды щелкните группу **Администраторы** .
5. В диалоговом окне **Свойства администратора** нажмите кнопку **Добавить**.
6. Введите имя пользователя **CORP\Install**, а затем нажмите кнопку **ОК**.
7. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно **Свойства администратора**.
8. Повторите описанные выше шаги для **sqlserver-1** и **cluster-fsw**.

### <a name="setServiceAccount"></a>Настройка учетных записей службы SQL Server

На каждой виртуальной машине SQL Server настройте учетную запись службы SQL Server. Используйте учетные записи, созданные при [настройке учетных записей домена](#DomainAccounts).

1. Откройте **диспетчер конфигурации SQL Server**.
2. Щелкните правой кнопкой мыши службу SQL Server, а затем выберите **Свойства**.
3. Настройте учетную запись и задайте пароль.
4. Повторите эти действия на другой виртуальной машине SQL Server.  

Для групп доступности SQL Server каждая виртуальная машине SQL Server должна запускаться как учетная запись домена.

### <a name="create-a-sign-in-on-each-sql-server-vm-for-the-installation-account"></a>Создание на каждой виртуальной машине SQL Server имени для входа для учетной записи установки

Используйте учетную запись установки (CORP\install), чтобы настроить группу доступности. Эта учетная запись должна быть участником фиксированной роли сервера **sysadmin** на каждой виртуальной машине SQL Server. Чтобы создать имя для входа для учетной записи установки, сделайте следующее.

1. Подключитесь к серверу по протоколу удаленного рабочего стола (RDP) с помощью учетной записи *\<MachineName\>\DomainAdmin*.

1. Откройте SQL Server Management Studio и подключитесь к локальному экземпляру сервера SQL Server.

1. В **обозревателе объектов** щелкните **Безопасность**.

1. Щелкните правой кнопкой мыши **Имена входа**. Выберите **Создать имя входа**.

1. В разделе **Создание имени входа** щелкните **Поиск**.

1. Щелкните **Расположения**.

1. Введите сетевые учетные данные администратора домена.

1. Используйте учетную запись установки.

1. Сделайте имя для входа участником фиксированной роли сервера **sysadmin**.

1. Последовательно выберите **ОК**.

Повторите эти действия на другой виртуальной машине SQL Server.

## <a name="add-failover-clustering-features-to-both-sql-server-vms"></a>Добавление функций отказоустойчивого кластера на обеих виртуальных машинах SQL Server

Чтобы добавить функции отказоустойчивого кластера, на обеих виртуальных машинах SQL Server сделайте следующее.

1. Подключитесь к виртуальной машине SQL Server по протоколу удаленного рабочего стола (RDP) с помощью учетной записи *CORP\install*. Откройте **панель мониторинга диспетчера сервера**.
2. Щелкните ссылку **Добавление ролей и компонентов** на панели мониторинга.

    ![Диспетчер сервера. Добавление ролей](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/22-addfeatures.png)
3. Нажимайте кнопку **Далее**, пока не откроется раздел **Server Features** (Функции сервера).
4. В разделе **функций** выберите **Отказоустойчивость кластеров**.
5. Добавьте другие необходимые функции.
6. Щелкните **Установить**, чтобы добавить функции.

Повторите эти действия на другой виртуальной машине SQL Server.

## <a name="a-nameendpoint-firewall-configure-the-firewall-on-each-sql-server-vm"></a><a name="endpoint-firewall"> Настройка брандмауэра на каждой виртуальной машине SQL Server

Это решение требует, чтобы в брандмауэре были открыты следующие TCP-порты:

- **Виртуальная машина SQL Server**.<br/>
   Порт 1433 для экземпляра сервера SQL Server по умолчанию.
- **Проба Azure Load Balancer**.<br/>
   Любой доступный порт. В примерах часто используется 59999.
- **Конечная точка зеркального отображения базы данных**. <br/>
   Любой доступный порт. В примерах часто используется 5022.

Порты брандмауэра должны быть открыты на обеих виртуальных машинах SQL Server.

Метод открытия портов зависит от используемого решения брандмауэра. В следующем разделе показано, как открыть порты в брандмауэре Windows. Откройте необходимые порты на каждой из виртуальных машин SQL Server.

### <a name="open-a-tcp-port-in-the-firewall"></a>Открытие TCP-порта в брандмауэре

1. На первом сервере SQL Server на **начальном экране** запустите **Брандмауэр Windows в режиме повышенной безопасности**.
2. В левой области выберите **Правила для входящих подключений**. На правой панели нажмите кнопку **Новое правило**.
3. Для параметра **Тип правила** выберите **Порт**.
4. Для порта выберите тип **TCP** и введите соответствующие номера портов. Как в этом примере:

   ![Брандмауэр SQL](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/35-tcpports.png)

5. Нажмите кнопку **Далее**.
6. На странице **Действие** оставьте установленным флажок **Разрешить подключение** и нажмите кнопку **Далее**.
7. На странице **Профиль** примите параметры по умолчанию и нажмите кнопку **Далее**.
8. На странице **Имя** в текстовом поле **Имя** укажите имя правила, например **Проба Azure LB**, и нажмите кнопку **Готово**.

Повторите эти действия на второй виртуальной машине SQL Server.

## <a name="configure-system-account-permissions"></a>Настройка разрешений системной учетной записи

Чтобы создать учетную запись для системной учетной записи и предоставить соответствующие разрешения, выполните указанные ниже действия в каждом экземпляре SQL Server.

1. Создайте учетную запись для `[NT AUTHORITY\SYSTEM]` в каждом экземпляре SQL Server. Для этого используйте следующий сценарий.

   ```sql
   USE [master]
   GO
   CREATE LOGIN [NT AUTHORITY\SYSTEM] FROM WINDOWS WITH DEFAULT_DATABASE=[master]
   GO 
   ```

1. Предоставьте указанные ниже разрешения для `[NT AUTHORITY\SYSTEM]` в каждом экземпляре SQL Server.

   - `ALTER ANY AVAILABILITY GROUP`
   - `CONNECT SQL`
   - `VIEW SERVER STATE`

   Для этого используйте следующий сценарий.

   ```sql
   GRANT ALTER ANY AVAILABILITY GROUP TO [NT AUTHORITY\SYSTEM]
   GO
   GRANT CONNECT SQL TO [NT AUTHORITY\SYSTEM]
   GO
   GRANT VIEW SERVER STATE TO [NT AUTHORITY\SYSTEM]
   GO 
   ```

## <a name="next-steps"></a>Дополнительная информация

* [Настройка группы доступности AlwaysOn на виртуальной машине Azure вручную](virtual-machines-windows-portal-sql-availability-group-tutorial.md)
