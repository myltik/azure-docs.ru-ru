---
title: Настройка высокого уровня доступности виртуальных машин Azure Resource Manager | Документация Майкрософт
description: В этом руководстве показано, как создать группу доступности AlwaysOn на виртуальных машинах Azure в режиме Azure Resource Manager.
services: virtual-machines-windows
documentationcenter: na
author: MikeRayMSFT
manager: craigg
editor: ''
tags: azure-resource-manager
ms.assetid: 64e85527-d5c8-40d9-bbe2-13045d25fc68
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 03/17/2017
ms.author: mikeray
ms.openlocfilehash: a612ffd5a68e34cb0a367a6a883495ef26aeb4bc
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2018
ms.locfileid: "29401027"
---
# <a name="configure-always-on-availability-groups-in-azure-virtual-machines-automatically-resource-manager"></a>Автоматическая настройка групп доступности AlwaysOn на виртуальных машинах Azure с использованием Resource Manager

В этом руководстве показано, как создать группу доступности SQL Server, в которую входят виртуальные машины Azure Resource Manager. Для настройки шаблона мы воспользуемся колонками на портале Azure. В ходе работы в сможете проверить параметры по умолчанию, ввести необходимые параметры, а затем обновить колонки на портале.

Полное руководство позволяет создать группу доступности SQL Server на виртуальных машинах Azure, включая создание следующих элементов:

* виртуальная сеть с несколькими подсетями, в том числе для интерфейса и внутренних серверов;
* два контроллера домена, поддерживающих домен Active Directory (AD);
* две виртуальные машины, на которых работает SQL Server, развернутые во внутренней подсети и присоединенные к домену Active Directory;
* отказоустойчивый кластер из трех узлов с моделью кворума "Большинство узлов";
* группа доступности с двумя репликами базы данных доступности с синхронной фиксацией.

На следующем рисунке представлено полное решение.

![Тестовая архитектура для групп доступности в Azure](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/0-EndstateSample.png)

Все ресурсы в этом решении принадлежат к одной группе ресурсов.

Прежде чем начать работу с руководством, проверьте следующее.

* У вас уже есть учетная запись Azure. Если у вас ее нет, [зарегистрируйтесь, чтобы воспользоваться пробной учетной записью](http://azure.microsoft.com/pricing/free-trial/).
* Вы уже умеете подготавливать виртуальную машину SQL Server из коллекции виртуальных машин через графический интерфейс пользователя. Дополнительные сведения см. в разделе [Подготовка виртуальной машины SQL Server на портале Azure](virtual-machines-windows-portal-sql-server-provision.md).
* Теперь вы хорошо понимаете принцип работы групп доступности. Дополнительные сведения см. в разделе [Группы доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/hh510230.aspx).

> [!NOTE]
> Если вы планируете использовать группы доступности с SharePoint, ознакомьтесь со статьей [Configure SQL Server 2012 Always On availability groups for SharePoint 2013](http://technet.microsoft.com/library/jj715261.aspx)(Настройка групп доступности AlwaysOn SQL Server 2012 для SharePoint 2013).
>
>

В этом руководстве портал Azure используется для таких целей:

* выбор шаблона AlwaysOn на портале;
* проверка настроек шаблона и обновление некоторых параметров конфигурации с учетом используемой среды;
* контроль действий Azure по созданию тестовой среды;
* подключение к контроллеру домена и к серверу, на котором выполняется SQL Server.

[!INCLUDE [availability-group-template](../../../../includes/virtual-machines-windows-portal-sql-alwayson-ag-template.md)]

## <a name="provision-the-cluster-from-the-gallery"></a>Подготовка кластера из коллекции
В Azure есть коллекция образов для всего решения. Найти шаблон можно так:

1. Войдите на портал Azure, используя свои учетные данные.
2. На портале Azure щелкните **Создать ресурс**, чтобы открыть область **Создать**.
3. В области **Создать** выполните поиск **AlwaysOn**.
   ![Поиск шаблона AlwaysOn](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/16-findalwayson.png)
4. В результатах поиска найдите **SQL Server AlwaysOn Cluster**.
   ![Шаблон AlwaysOn](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/17-alwaysontemplate.png)
5. В разделе **Выберите модель развертывания** щелкните **Resource Manager**.

### <a name="basics"></a>Основы
Щелкните **Базовые** и настройте указанные ниже параметры.

* **Имя администратора.** Укажите здесь учетную запись пользователя с правами администратора домена, входящую в предопределенную роль системного администратора (sysadmin) для сервера SQL Server на обоих экземплярах SQL Server. В этом руководстве мы будем использовать имя **DomainAdmin**.
* **Пароль** — пароль к учетной записи администратора домена. Следует использовать сложный пароль. Подтвердите пароль.
* **Подписка.** Это подписка Azure, через которую оплачивается использование всех ресурсов, развернутых для нашей группы доступности. Если в вашей учетной записи есть несколько подписок, можно указать любую из них.
* **Группа ресурсов**. Это имя группы, в которую входят все ресурсы Azure, созданные нашим шаблоном. В этом руководстве мы будем использовать имя **SQL-HA-RG**. Дополнительные сведения см. в [обзоре Azure Resource Manager](../../../azure-resource-manager/resource-group-overview.md#resource-groups).
* **Расположение** — регион Azure, где будут созданы ресурсы для этого руководства. Выберите регион Azure.

На следующем снимке экрана показана заполненная колонка **Базовые**.

![Основы](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/1-basics.png)

Последовательно выберите **ОК**.

### <a name="domain-and-network-settings"></a>Параметры домена и сети
Этот шаблон из коллекции Azure создает домен и контроллеры домена. Он также создает сеть c двумя подсетями. Шаблон не может создавать серверы в существующем домене или виртуальной сети. На следующем шаге мы настроим параметры домена и сети.

В колонке **Параметры домена и сети** просмотрите предлагаемые значения для параметров домена и сети.

* **Доменное имя корня леса**. Это имя домена Active Directory, в котором будет размещаться наш кластер. Мы будем использовать имя **contoso.com**.
* **Имя виртуальной сети** — сетевое имя виртуальной сети Azure. Мы будем использовать имя **autohaVNET**.
* **Domain Controller subnet name** (Имя подсети контроллера домена) — имя части виртуальной сети, в которой размещен контроллер домена. Используйте **subnet-1**. Эта подсеть использует префикс адреса **10.0.0.0/24**.
* **Имя подсети SQL Server.** Это имя того сегмента виртуальной сети, в котором размещаются серверы SQL Server и файловый ресурс-свидетель. Используйте **subnet-2**. Эта подсеть использует префикс адреса **10.0.1.0/26**.

Дополнительные сведения о виртуальных сетях Azure см. в статье [Виртуальная сеть Azure](../../../virtual-network/virtual-networks-overview.md).  

В итоге раздел **Параметры домена и сети** должен выглядеть так, как показано на следующем снимке экрана.

![Параметры домена и сети](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/2-domain.png)

При необходимости эти значения можно изменить. В этом руководстве используются предустановленные значения.

Проверьте значения параметров и щелкните **ОК**.

### <a name="availability-group-settings"></a>Параметры группы доступности
В разделе **Availability group settings** (Параметры группы доступности) просмотрите предустановленные значения для группы доступности и прослушивателя.

* **Имя группы доступности** — имя кластеризованного ресурса для группы доступности. Мы будем использовать имя **Contoso-ag**.
* **Имя прослушивателя группы доступности** используется кластером и внутренней подсистемой балансировки нагрузки. Клиенты, которые подключаются к серверу SQL Server, могут использовать это имя для подключения к нужной реплике базы данных. Мы будем использовать имя **Contoso-listener**.
* **Порт прослушивателя группы доступности.** Это TCP-порт, на котором работает прослушиватель SQL Server. В этом руководстве мы используем порт по умолчанию (**1433**).

При необходимости эти значения можно изменить. В этом руководстве используются предустановленные значения.  

![Параметры группы доступности](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/3-availabilitygroup.png)

Последовательно выберите **ОК**.

### <a name="virtual-machine-size-storage-settings"></a>Размер виртуальной машины и параметры хранилища
В разделе **Размер виртуальной машины и параметры хранилища** выберите размер виртуальной машины SQL Server и проверьте другие параметры.

* **Размер виртуальной машины SQL Server.** Это размер обеих виртуальных машин, на которых выполняется SQL Server. Выберите такой размер, который соответствует вашей рабочей нагрузке. Если вы создаете среду, описанную в этом руководстве, используйте размер **DS2**. Для производственных рабочих нагрузок следует выбрать такой размер виртуальной машины, который сможет поддерживать рабочую нагрузку. Для многих производственных рабочих нагрузок нужна виртуальная машина **DS4** или большего размера. Шаблон создает две виртуальные машины такого размера и устанавливает SQL Server на каждую из них. Дополнительные сведения см. в разделе [Размеры виртуальных машин](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

> [!NOTE]
> Azure устанавливает выпуск SQL Server Enterprise Edition. Стоимость ПО зависит от выпуска и размера виртуальной машины. Подробные сведения о текущих ценах см. на странице [цен на виртуальные машины](http://azure.microsoft.com/pricing/details/virtual-machines/#Sql).
>
>

* **Domain controller virtual machine size** (Размер виртуальной машины контроллера домена) — размер виртуальной машины для контроллеров домена. Мы будем использовать размер **D2**.
* **File Share Witness virtual machine size** (Размер виртуальной машины файлового ресурса-свидетеля) — размер виртуальной машины для файлового ресурса-свидетеля. Мы будем использовать размер **A1**.
* **SQL Storage account** (Учетная запись хранения SQL) — имя учетной записи хранения для данных SQL Server и дисков операционной системы. Мы будем использовать имя **alwaysonsql01**.
* **DC Storage account** (Учетная запись хранения контроллера домена) — имя учетной записи хранения для контроллеров домена. Мы будем использовать имя **alwaysondc01**.
* **SQL Server data disk size** (Размер диска данных SQL Server) — размер диска данных SQL Server в ТБ. Введите число от 1 до 4. Мы будем использовать размер **1**.
* **Оптимизация хранилища** — параметры конфигурации хранилища для виртуальных машин SQL Server на основе типа рабочей нагрузки. В нашем примере все виртуальные машины с SQL Server используют хранилище класса Premium, а для диска Azure задан режим кэширования узла "Только для чтения". Кроме того, параметры SQL Server для рабочей нагрузки можно оптимизировать, выбрав один из трех таких параметров:

  * **General workload** (Общая рабочая нагрузка) — без особых параметров конфигурации.
  * **Обработка транзакций** — устанавливаются флаги трассировки 1117 и 1118.
  * **Хранилище данных** — устанавливаются флаги трассировки 1117 и 610.

Мы будем использовать параметр **General workload**(Общая рабочая нагрузка).

![Размер виртуальной машины и параметры хранилища](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/4-vm.png)

Проверьте значения параметров и щелкните **ОК**.

#### <a name="a-note-about-storage"></a>Примечание о хранилище
Дополнительная оптимизация зависит от размера дисков данных SQL Server. Azure добавляет дополнительное хранилище класса Premium размером 1 ТБ для каждого терабайта данных на диске. Если для сервера требуется 2 ТБ или больше, шаблон создает пул носителей для каждой виртуальной машины SQL Server. Пул носителей — это виртуализация хранилища, при которой настраиваются несколько дисков для обеспечения большей емкости, гибкости и производительности.  Шаблон создает в пуле носителей дисковое пространство и предоставляет операционной системе как отдельный диск данных, а затем назначает его как диск данных для SQL Server. Шаблон настраивает пул носителей для SQL Server со следующими параметрами:

* Размер полосы — это настройка блока чередования для виртуального диска. Для транзакционных рабочих нагрузок используйте размер в 64 КБ. Для рабочих нагрузок хранилища данных используйте размер в 256 КБ.
* Для типа устойчивости выбирается параметр "Простой (без устойчивости)".

> [!NOTE]
> Хранилище Azure класса Premium является локально избыточным хранилищем, которое хранит три копии данных в одном регионе. Поэтому для пула носителей дополнительная устойчивость не требуется.
>
>

* Количество столбцов равно количеству дисков в пуле носителей.

Дополнительные сведения о дисковом пространстве и пулах носителей:

* [Обзор дисковых пространств](http://technet.microsoft.com/library/hh831739.aspx);
* [Windows Server Backup and Storage Pools (Резервное копирование данных Windows Server и пулы носителей)](http://technet.microsoft.com/library/dn390929.aspx)

Дополнительные рекомендации по настройке SQL Server см. в статье [Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure](virtual-machines-windows-sql-performance.md).

### <a name="sql-server-settings"></a>Параметры SQL Server
В разделе **Настройки SQL Server** проверьте и при необходимости измените префикс имени виртуальной машины SQL Server, версию SQL Server, учетную запись и пароль для службы SQL Server, а также расписание автоматической установки исправлений на серверы SQL Server.

* **SQL Server Name Prefix** (Префикс имени SQL Server) — используется для создания имен виртуальных машин SQL Server. Мы будем использовать префикс **sqlserver**. Имена шаблонов для виртуальных машин SQL Server: *sqlserver-0* и *sqlserver-1*.
* **Версия SQL Server** — используемая версия SQL Server. Мы будем использовать версию **SQL Server 2014**. Можно также выбрать **SQL Server 2012** или **SQL Server 2016**.
* **SQL Server service account user name** (Имя пользователя учетной записи службы SQL Server) — имя учетной записи домена для службы SQL Server. Мы будем использовать **sqlservice**.
* **Пароль** — пароль к учетной записи службы SQL Server.  Следует использовать сложный пароль. Подтвердите пароль.
* **SQL Auto Patching maintenance schedule** (Расписание автоматической установки исправлений на серверы SQL Server) — здесь указывается день недели, в который Azure будет автоматически устанавливать исправления на серверы SQL Server. Мы будем использовать значение **воскресенье**.
* **SQL Auto Patching maintenance start hour** (Время запуска автоматической установки исправлений на серверы SQL) — время суток в соответствующем регионе Azure, в которое будет запущена автоматическая установка исправлений.

> [!NOTE]
> Операции по установке исправлений для каждой виртуальной машины выполняются поочередно, со сдвигом в один час. Чтобы избежать перебоев в работе служб, исправления устанавливаются только на одну виртуальную машину в любой момент времени.
>
>

![Параметры SQL Server](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/5-sql.png)

Проверьте значения параметров и щелкните **ОК**.

### <a name="summary"></a>Сводка
На странице сводных данных можно просмотреть параметры Azure, а также загрузить шаблон. Проверьте сводные данные. Последовательно выберите **ОК**.

### <a name="buy"></a>Купить
Эта последняя колонка содержит **условия использования** и **политику конфиденциальности**. Просмотрите эту информацию. Когда вы подготовите все необходимое для создания виртуальных машин в Azure, в том числе ресурсы для группы доступности, щелкните **Создать**.

На портале Azure будет создана группа ресурсов и все необходимые ресурсы.

## <a name="monitor-deployment"></a>Мониторинг развертывания
На портале Azure можно следить за ходом развертывания. Значок, представляющий развертывание, автоматически закрепляется на панели мониторинга портала Azure.

![Панель мониторинга Azure](./media/virtual-machines-windows-portal-sql-alwayson-availability-groups/11-deploydashboard.png)

## <a name="connect-to-sql-server"></a>Подключение к SQL Server
Новые экземпляры SQL Server выполняются на виртуальных машинах с IP-адресами, подключенных к Интернету. Вы можете напрямую подключиться к каждой виртуальной машине SQL Server по протоколу удаленного рабочего стола (RDP).

Подключиться к SQL Server по протоколу RDP можно следующим образом.

1. На панели мониторинга портала Azure убедитесь, что развертывание выполнено успешно.
2. Щелкните **Ресурсы**.
3. В колонке **Ресурсы** щелкните **sqlserver-0**. Это имя одной из виртуальных машин, на которых выполняется SQL Server.
4. В колонке **sqlserver-0** щелкните **Подключиться**. В браузере отобразится сообщение с предложением открыть или сохранить объект удаленного подключения. Щелкните **Открыть**.
5. В окне **Подключение к удаленному рабочему столу** может появиться предупреждение о том, что издателя этого удаленного подключения невозможно определить. Щелкните **Подключить**.
6. Служба безопасности Windows предложит вам ввести учетные данные для подключения к IP-адресу основного контроллера домена. Щелкните **Использовать другую учетную запись**. В поле **Имя пользователя** введите **contoso\DomainAdmin**. Эта учетная запись была настроена при указании имени администратора в шаблоне. Используйте сложный пароль, введенный во время настройки шаблона.
7. В окне **удаленного рабочего стола** может появиться предупреждение о том, что проверка подлинности удаленного компьютера не может быть выполнена из-за проблем с сертификатом безопасности. В нем будет отображено имя сертификата безопасности. Если вы следовали инструкциям в руководстве, здесь указано значение **sqlserver-0.contoso.com**. Щелкните **Да**.

Теперь вы подключены к виртуальной машине SQL Server по протоколу RDP. Откройте SQL Server Management Studio, подключитесь к экземпляру SQL Server по умолчанию и убедитесь, что группа доступности настроена.
