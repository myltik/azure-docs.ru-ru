---
title: Группы доступности SQL Server, виртуальные машины Azure и аварийное восстановление | Документация Майкрософт
description: В этой статье описывается, как настроить группу доступности SQL Server на виртуальных машинах Azure с репликой, расположенной в другом регионе.
services: virtual-machines
documentationCenter: na
authors: MikeRayMSFT
manager: craigg
editor: monicar
tags: azure-service-management
ms.assetid: 388c464e-a16e-4c9d-a0d5-bb7cf5974689
ms.service: virtual-machines-sql
ms.devlang: na
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 05/02/2017
ms.author: mikeray
ms.openlocfilehash: 84fa2e051c46e178e3e72709886babc8c3db7b9d
ms.sourcegitcommit: 8c3267c34fc46c681ea476fee87f5fb0bf858f9e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2018
ms.locfileid: "29852835"
---
# <a name="configure-an-always-on-availability-group-on-azure-virtual-machines-in-different-regions"></a>Настройка группы доступности AlwaysOn на виртуальных машинах Azure в разных регионах

В этой статье описывается, как настроить группу доступности AlwaysOn SQL Server на виртуальных машинах Azure в удаленном регионе Azure. Эту конфигурацию можно использовать для поддержки аварийного восстановления.

Данная статья относится к виртуальным машинам Azure в режиме Resource Manager.

На следующем рисунке показано типичное развертывание группы доступности на виртуальных машинах Azure.

   ![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-dr/00-availability-group-basic.png)

В таком развертывании все виртуальные машины находятся в одном регионе Azure. Реплики группы доступности могут использовать синхронную фиксацию с автоматической отработкой отказа на SQL-1 и SQL-2. Для создания этой архитектуры ознакомьтесь с [шаблоном группы доступности или соответствующим руководством](virtual-machines-windows-portal-sql-availability-group-overview.md).

Данная архитектура подвержена простоям в случаях, когда регион Azure становится недоступным. Чтобы устранить эту уязвимость, добавьте реплику в другой регион Azure. На следующей схеме показано, как будет выглядеть новая архитектура.

   ![Аварийное восстановление группы доступности](./media/virtual-machines-windows-portal-sql-availability-group-dr/00-availability-group-basic-dr.png)

На предыдущей схеме показана новая виртуальная машина с именем SQL-3. SQL-3 находится в другом регионе Azure. Она добавлена в отказоустойчивый кластер Windows Server. На SQL-3 можно разместить реплику группы доступности. Наконец, обратите внимание, что для региона Azure виртуальной машины SQL-3 используется новая подсистема Azure Load Balancer.

>[!NOTE]
> Группа доступности Azure нужна, если в одном регионе размещено более одной виртуальной машины. Если в регионе находится только одна виртуальная машина, то использовать группу доступности не обязательно. Поместить виртуальную машину в группу доступности можно только во время создания виртуальной машины. Если в группе доступности уже есть виртуальная машина, то позже в нее можно будет добавить виртуальную машину для размещения дополнительной реплики.

В данной архитектуре для реплики в удаленном регионе обычно настраивается режим доступности с асинхронной фиксацией и режим ручной отработки отказа.

Если реплики группы доступности находятся на виртуальных машинах Azure в разных регионах Azure, то для каждого региона требуется:

* шлюз виртуальной сети;
* подключение к шлюзу виртуальной сети.

На следующей схеме показано взаимодействие сетей между центрами обработки данных.

   ![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-dr/01-vpngateway-example.png)

>[!IMPORTANT]
>Эта архитектура влечет за собой оплату исходящего трафика для данных, реплицируемых между регионами Azure. Ознакомьтесь с разделом [Сведения о стоимости пропускной способности](http://azure.microsoft.com/pricing/details/bandwidth/).  

## <a name="create-remote-replica"></a>Создание удаленной реплики

Чтобы создать реплику в удаленном центре обработки данных, выполните следующие действия.

1. [Создайте виртуальную сеть в новом регионе](../../../virtual-network/manage-virtual-network.md#create-a-virtual-network).

1. [Настройте подключение между виртуальными сетями на портале Azure](../../../vpn-gateway/vpn-gateway-howto-vnet-vnet-resource-manager-portal.md).

   >[!NOTE]
   >В некоторых случаях для создания подключения между виртуальными сетями может потребоваться использовать PowerShell. Например, при использовании разных учетных записей Azure подключение невозможно настроить на портале. В этом случае ознакомьтесь с разделом [Настройка подключения между виртуальными сетями на портале Azure](../../../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md).

1. [Создайте контроллер домена в новом регионе](../../../active-directory/active-directory-new-forest-virtual-machine.md).

   Этот контроллер домена обеспечивает аутентификацию в случае, если контроллер домена на первичном сайте недоступен.

1. [Создайте виртуальную машину SQL Server в новом регионе](virtual-machines-windows-portal-sql-server-provision.md).

1. [Создайте Azure Load Balancer в сети в новом регионе](virtual-machines-windows-portal-sql-availability-group-tutorial.md#configure-internal-load-balancer).

   Эта подсистема балансировки нагрузки должна:

   - находиться в той же сети и подсети, что и новая виртуальная машина;
   - использовать статический IP-адрес для прослушивателя группы доступности;
   - включать в себя внутренний пул, состоящий только из виртуальных машин, размещенных в том же регионе, что и подсистема балансировки нагрузки;
   - использовать пробу TCP-порта для IP-адреса;
   - использовать правило балансировки нагрузки для SQL Server в том же регионе.  

1. [Добавьте компонент отказоустойчивой кластеризации на новый сервер SQL Server](virtual-machines-windows-portal-sql-availability-group-prereq.md#add-failover-clustering-features-to-both-sql-server-vms).

1. [Присоедините новый сервер SQL Server к домену](virtual-machines-windows-portal-sql-availability-group-prereq.md#joinDomain).

1. [Настройте новую учетную запись службы SQL Server для использования доменной учетной записи](virtual-machines-windows-portal-sql-availability-group-prereq.md#setServiceAccount).

1. [Добавьте новый сервер SQL Server в отказоустойчивый кластер Windows Server](virtual-machines-windows-portal-sql-availability-group-tutorial.md#addNode).

1. Создайте ресурс IP-адреса в кластере.

   Для этого можно использовать диспетчер отказоустойчивости кластеров. Щелкните правой кнопкой мыши роль группы доступности и выберите **Добавить ресурс**, **Дополнительные ресурсы**, затем щелкните **IP-адрес**.

   ![Создание IP-адреса](./media/virtual-machines-windows-portal-sql-availability-group-dr/20-add-ip-resource.png)

   Настройте этот IP-адрес следующим образом.

   - Используйте сеть удаленного центра обработки данных.
   - Назначьте IP-адрес из новой подсистемы Azure Load Balancer. 

1. [Включите группы доступности AlwaysOn](http://msdn.microsoft.com/library/ff878259.aspx) на новом сервере SQL Server с помощью диспетчера конфигурации SQL Server.

1. [Откройте порты брандмауэра на новом сервере SQL Server](virtual-machines-windows-portal-sql-availability-group-prereq.md#endpoint-firewall).

   Номера портов, которые необходимо открыть, зависят от вашей среды. Откройте порты для конечной точки зеркального отображения и пробы работоспособности Azure Load Balancer.

1. [Добавьте реплику в группу доступности на новом сервере SQL Server](http://msdn.microsoft.com/library/hh213239.aspx).

   Для реплики в удаленном регионе Azure настройте асинхронную репликацию с ручной отработкой отказа.  

1. Добавьте ресурс IP-адреса в качестве зависимости для кластера (сетевое имя) точки доступа клиента прослушивателя.

   На следующем рисунке показан правильно настроенного ресурс IP-адреса кластера.

   ![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-dr/50-configure-dependency-multiple-ip.png)

   >[!IMPORTANT]
   >Группа ресурсов кластера включает в себя оба IP-адреса. Оба IP-адреса являются зависимостями для точки доступа клиента прослушивателя. Используйте оператор **OR** в конфигурации зависимостей кластера.

1. [Настройте параметры кластера в PowerShell](virtual-machines-windows-portal-sql-availability-group-tutorial.md#setparam).

Выполните сценарий PowerShell с сетевым именем кластера, IP-адресом и портом пробы, настроенными для подсистемы балансировки нагрузки в новом регионе.

   ```PowerShell
   $ClusterNetworkName = "<MyClusterNetworkName>" # The cluster name for the network in the new region (Use Get-ClusterNetwork on Windows Server 2012 of higher to find the name).
   $IPResourceName = "<IPResourceName>" # The cluster name for the new IP Address resource.
   $ILBIP = “<n.n.n.n>” # The IP Address of the Internal Load Balancer (ILB) in the new region. This is the static IP address for the load balancer you configured in the Azure portal.
   [int]$ProbePort = <nnnnn> # The probe port you set on the ILB.

   Import-Module FailoverClusters

   Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"=$ProbePort;"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}
   ```

## <a name="set-connection-for-multiple-subnets"></a>Настройка подключения для нескольких подсетей

Реплика в удаленном центре обработки данных входит в группу доступности, но находится в другой подсети. Если это реплика станет первичной, то возможно превышение времени ожидания подключения к приложению. Точно так же работает локальная группа доступности в развертывании с несколькими подсетями. Чтобы разрешить подключения из клиентских приложений, либо измените подключение клиента, либо настройте кэширование разрешения имен для ресурса сетевого имени кластера.

Желательно изменить строки подключения клиента, чтобы задать `MultiSubnetFailover=Yes`. Ознакомьтесь с разделом [Соединение с помощью MultiSubnetFailover](http://msdn.microsoft.com/library/gg471494#Anchor_0).

Если вам не удается изменить строки подключения, можно настроить кэширование разрешения имен. Ознакомьтесь с разделом [Connection Timeouts in Multi-subnet Availability Group](http://blogs.msdn.microsoft.com/alwaysonpro/2014/06/03/connection-timeouts-in-multi-subnet-availability-group/) (Время ожидания подключения в группе доступности с несколькими подсетями).

## <a name="fail-over-to-remote-region"></a>Отработка отказа в удаленный регион

Чтобы проверить возможность подключения прослушивателя к удаленному региону, можно отработать отказ реплики в удаленный регион. Если реплика является асинхронной, то отработка отказа может привести к потере данных. Чтобы отработать отказ без потери данных, измените режим доступности на синхронный и задайте автоматический режим отработки отказа. Выполните следующие действия.

1. В **обозревателе объектов** подключитесь к экземпляру SQL Server, на котором размещена первичная реплика.
1. Выберите **Группы доступности AlwaysOn** > **Группы доступности**, щелкните правой кнопкой мыши группу доступности и выберите **Свойства**.
1. На странице **Общие** в разделе **Реплики доступности** задайте для вторичной реплики на узле аварийного восстановления режим доступности **Синхронная фиксация** и **автоматический** режим отработки отказа.
1. Если вторичная реплика находится на том же узле, что и первичная реплика, для обеспечения высокого уровня доступности, то задайте для нее режимы **Асинхронная фиксация** и **Ручной**.
1. Нажмите кнопку ОК.
1. В **обозревателе объектов** щелкните правой кнопкой мыши группу доступности и выберите **Show Dashboard** (Показать панель мониторинга).
1. На панели мониторинга убедитесь, что реплика на сайте аварийного восстановления синхронизирована.
1. В **обозревателе объектов** щелкните правой кнопкой мыши группу доступности и выберите **Отработка отказа…**. В SQL Server Management Studio откроется мастер для отработки отказа SQL Server.  
1. Щелкните **Далее** и выберите экземпляр SQL Server на сайте аварийного восстановления. Нажмите **Далее** еще раз.
1. Подключитесь к экземпляру SQL Server на сайте аварийного восстановления и нажмите кнопку **Далее**.
1. Проверьте параметры на странице **Сводка**, а затем нажмите кнопку **Готово**.

После проверки подключения верните первичную реплику в основной центр обработки данных и восстановите обычные рабочие параметры режима доступности. В таблице ниже приведены обычные рабочие параметры для архитектуры, описанной в этом документе.

| Расположение | Экземпляр сервера | Роль | Режим доступности | Режим отработки отказа
| ----- | ----- | ----- | ----- | -----
| Основной центр обработки данных | SQL-1 | Первичная | Синхронный | Автоматический
| Основной центр обработки данных | SQL-2 | Вторичная | Синхронный | Автоматический
| Дополнительный или удаленный центр обработки данных | SQL-3 | Вторичная | Асинхронный | Руководство


### <a name="more-information-about-planned-and-forced-manual-failover"></a>Дополнительные сведения о плановой и принудительной отработке отказа вручную

Дополнительные сведения см. в следующих статьях:

- [Выполнение запланированного перехода на другой ресурс вручную для группы доступности (SQL Server)](http://msdn.microsoft.com/library/hh231018.aspx)
- [Выполнение принудительного перехода на другой ресурс вручную для группы доступности (SQL Server)](http://msdn.microsoft.com/library/ff877957.aspx)

## <a name="additional-links"></a>Ссылки на дополнительные материалы

* [Группы доступности Always On](http://msdn.microsoft.com/library/hh510230.aspx)
* [Виртуальные машины Azure](http://docs.microsoft.com/azure/virtual-machines/windows/)
* [Подсистемы Azure Load Balancer](virtual-machines-windows-portal-sql-availability-group-tutorial.md#configure-internal-load-balancer)
* [Группы доступности Azure](../manage-availability.md)
