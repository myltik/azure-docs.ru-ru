---
title: Рекомендации по производительности для SQL Server в Azure | Документы Майкрософт
description: Содержит рекомендации по оптимизации производительности SQL Server в виртуальных машинах Microsoft Azure.
services: virtual-machines-windows
documentationcenter: na
author: rothja
manager: craigg
editor: ''
tags: azure-service-management
ms.assetid: a0c85092-2113-4982-b73a-4e80160bac36
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 04/19/2018
ms.author: jroth
ms.openlocfilehash: 9d3fbbab76f16a8546c431d5acf913bf419edeb4
ms.sourcegitcommit: fa493b66552af11260db48d89e3ddfcdcb5e3152
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2018
ms.locfileid: "31798161"
---
# <a name="performance-best-practices-for-sql-server-in-azure-virtual-machines"></a>Рекомендации по оптимизации производительности SQL Server в виртуальных машинах Azure

## <a name="overview"></a>Обзор

В этой статье приведены советы по оптимизации производительности SQL Server на виртуальной машине Microsoft Azure. При выполнении SQL Server в виртуальных машинах Azure рекомендуется продолжать использование тех же средств настройки производительности базы данных, которые применяются для SQL Server в локальной серверной среде. Однако производительность реляционной базы данных в общедоступном облаке зависит от многих факторов, таких как размер виртуальной машины и конфигурации дисков с данными.

[Образы SQL Server, подготовленные на портале Azure](quickstart-sql-vm-create-portal.md), соответствуют рекомендациям по конфигурации хранилища. Дополнительные сведения о настройке хранилища см. в статье [Настройка хранилища для виртуальных машин SQL Server](virtual-machines-windows-sql-server-storage-configuration.md). Завершив подготовку обдумайте, нужно ли применить другие виды оптимизации, описанные в этой статье. При принятии решений учитывайте характер рабочих нагрузок, а затем проверьте выбор путем тестирования.

> [!TIP]
> Этот документ содержит инструкции по достижению *оптимальной* производительности SQL Server на виртуальных машинах Azure. Если рабочая нагрузка не так велика, могут потребоваться не все перечисленные ниже оптимизации. При оценке этих рекомендаций учитывайте актуальные потребности в производительности и характер рабочих нагрузок.

## <a name="quick-check-list"></a>Краткий контрольный список

Ниже приведен краткий контрольный список по обеспечению оптимальной производительности SQL Server на виртуальных машинах Azure.

| Область | Оптимизация |
| --- | --- |
| [Размер виртуальной машины](#vm-size-guidance) |[DS3](../sizes-general.md) или выше для выпуска SQL Enterprise.<br/><br/>[DS2](../sizes-general.md) или выше для выпусков SQL Standard и Web Edition. |
| [Хранилище](#storage-guidance) |Используйте [хранилище класса Premium](../premium-storage.md). Стандартное хранилище рекомендуется использовать только для разработки и тестирования.<br/><br/>Храните [учетную запись хранения](../../../storage/common/storage-create-storage-account.md) и виртуальную машину SQL Server в одном и том же регионе.<br/><br/>Отключите [геоизбыточное хранилище](../../../storage/common/storage-redundancy.md) (георепликацию) Azure в учетной записи хранения. |
| [диски;](#disks-guidance) |Используйте не менее двух [дисков P30](../premium-storage.md#scalability-and-performance-targets) (1 для файлов журнала и 1 для файлов данных и TempDB) или настройте общий том для всех файлов с чередованием на двух или более дисках.<br/><br/>Избегайте использования дисков операционной системы или временных дисков для хранения базы данных или журналов.<br/><br/>Включите кэширование операций чтения на дисках, где размещаются файлы данных и файлы данных базы данных TempDB.<br/><br/>Не включайте кэширование на дисках, где находится файл журнала.<br/><br/>Важно! Остановите службу SQL Server при изменении параметров кэша для диска виртуальной машины Azure.<br/><br/>Обеспечьте чередование нескольких дисков данных Azure для увеличения пропускной способности ввода-вывода.<br/><br/>Выполняйте форматирование с использованием задокументированных размеров кластеров. |
| [ВВОД-ВЫВОД](#io-guidance) |Включите сжатие страниц базы данных.<br/><br/>Включите быструю инициализацию для файлов данных.<br/><br/>Ограничьте автоувеличение базы данных.<br/><br/>Отключите автосжатие базы данных.<br/><br/>Переместите все базы данных на диски с данными, включая системные базы данных.<br/><br/>Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными.<br/><br/>Настройка расположений по умолчанию для файлов резервных копий и базы данных.<br/><br/>Включите заблокированные страницы.<br/><br/>Примените исправления производительности SQL Server. |
| [Характерные особенности компонента](#feature-specific-guidance) |Осуществите архивацию напрямую в хранилище BLOB-объектов. |

Дополнительные сведения о том, *как* выполнить эти оптимизации и *для чего* они необходимы, см. в следующих разделах.

## <a name="vm-size-guidance"></a>Рекомендации по выбору размеров виртуальных машин

Для приложений, чувствительных к уровню производительности, рекомендуется использовать следующие [размеры виртуальных машин](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json):

* **Выпуск SQL Server Enterprise**: DS3 или выше
* **Выпуски SQL Server Standard и Web**: DS2 или выше

## <a name="storage-guidance"></a>Рекомендации по выбору хранилища

Виртуальные машины серий DS, DSv2 и GS поддерживают [хранилище класса Premium](../premium-storage.md). Для всех производственных рабочих нагрузок рекомендуется хранилище класса Premium.

> [!WARNING]
> Стандартное хранилище характеризуется различными задержками и пропускной способностью и рекомендуется только для рабочих нагрузок по разработке и тестированию. Для производственных рабочих нагрузок необходимо использовать хранилище класса Premium.

Кроме того, рекомендуется создать свою учетную запись хранения Azure в одном центре обработки данных с виртуальными машинами SQL Server для уменьшения задержек при передаче данных. При создании учетной записи хранения отключите георепликацию, поскольку согласованный порядок записи на несколько дисков не гарантируется. Вместо этого рекомендуется реализовать средства аварийного восстановления SQL Server между двумя центрами обработки данных Azure. Дополнительные сведения см. в статье [Высокий уровень доступности и аварийное восстановление для SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-high-availability-dr.md).

## <a name="disks-guidance"></a>Рекомендации по использованию дисков

Виртуальная машина Azure поддерживает три основных типа дисков:

* **Диск ОС**: при создании виртуальной машины Azure платформа подключает к ней по меньшей мере один диск (обозначенный буквой **C**), используемый в качестве диска операционной системы. Этот диск представляет собой VHD-файл, сохраненный как страничный BLOB-объект в хранилище.
* **Временный диск**: виртуальные машины Azure содержат еще один диск (обозначенный буквой **D**), который называется временным диском. Это диск на узле, который может использоваться для области временных файлов.
* **Диски данных**: к виртуальной машине можно подключить дополнительные диски данных, которые будут сохранены в хранилище как страничные BLOB-объекты.

В следующих разделах приводятся рекомендации по использованию этих дисков.

### <a name="operating-system-disk"></a>Диск операционной системы

Диск операционной системы — это виртуальный жесткий диск, который можно установить и использовать как диск с установленной операционной системой, данный диск имеет метку **C:** .

По умолчанию для диска операционной системы применяется политика кэширования **Чтение и запись**. Для приложений, чувствительных к уровню производительности, рекомендуется использовать диски данных вместо диска операционной системы. См. подраздел "Диски данных" ниже.

### <a name="temporary-disk"></a>Временный диск

Диск временного хранилища с меткой **D:** не сохраняется в хранилище больших двоичных объектов. Не храните файлы пользовательской базы данных или файлы журнала транзакций пользователя на диске **D**.

В виртуальных машинах серий D, Dv2 и G роль временного диска выполняет диск на основе SSD. Если рабочая нагрузка усложняет использование базы данных TempDB (например, для временных объектов или сложных соединений), то хранение базы данных TempDB на диске **D** может повысить пропускную способность и уменьшить задержку базы данных TempDB.

Для виртуальных машин (серии D, Dv2 и G), которые поддерживают хранилище класса Premium, рекомендуется хранить базу данных TempDB на диске, поддерживающем хранилище класса Premium, с включенным кэшированием чтения. Существует одно исключение: если работа базы данных TempDB предусматривает большое количество операций записи, то для достижения более высокой производительности можно сохранить базу данных TempDB на локальном диске **D** , который на виртуальных машинах этого размера также является диском на основе SSD.

### <a name="data-disks"></a>Диски данных

* **Использование дисков данных для файлов данных и журналов**: если вы не применяете чередование дисков, используйте не менее двух [дисков P30](../premium-storage.md#scalability-and-performance-targets) хранилища класса Premium, где один диск содержит файлы журнала, а другой — файлы данных и базы данных TempDB. Каждый диск хранилища класса Premium обеспечивает определенное количество операций ввода-вывода в секунду и пропускную способность (МБ/с) в зависимости от своего размера, как описано в статье [Высокопроизводительное хранилище класса Premium и управляемые диски для виртуальных машин Azure](../premium-storage.md). При использовании чередования дисков, например в службе дисковых пространств, мы рекомендуем размещать файлы журналов и данных на одном диске.

   > [!NOTE]
   > При подготовке виртуальной машины SQL Server на портале у вас есть возможность изменить конфигурацию хранилища. В зависимости от конфигурации Azure настраивает один или несколько дисков. Несколько дисков объединяются в единый пул хранилищ с чередованием. Файлы данных и журналов совместно размещаются в этой конфигурации. Дополнительные сведения см. в статье [Настройка хранилища для виртуальных машин SQL Server](virtual-machines-windows-sql-server-storage-configuration.md).

* **Чередование дисков**: для повышения пропускной способности можно добавить дополнительные диски данных и использовать чередование дисков. Чтобы определить количество дисков данных, необходимо проанализировать количество операций ввода-вывода в секунду и пропускную способность, необходимые для ваших файлов журналов, файлов данных и tempdb. Обратите внимание, что разные размеры виртуальной машины накладывают разные ограничения на количество операций ввода-вывода в секунду и пропускную способность. Ознакомьтесь с таблицами зависимости количества операций ввода-вывода в секунду от [размера виртуальной машины](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json). Придерживайтесь приведенных ниже рекомендаций.

  * Для Windows 8 и Windows Server 2012 или более поздней версии используйте [дисковые пространства](https://technet.microsoft.com/library/hh831739.aspx), придерживаясь приведенных ниже рекомендаций.

      1. Задайте размер чередования в 64 КБ (65 536 байт) для рабочих нагрузок OLTP и 256 КБ (262 144 байт) для рабочих нагрузок хранилища данных, чтобы избежать снижения производительности из-за рассогласования разделов. Это следует сделать в PowerShell.
      1. Задайте число столбцов равным количеству физических дисков. Используйте PowerShell (не пользовательский интерфейс диспетчера сервера) при настройке более 8 дисков. 

    Например, следующая команда PowerShell создает пул носителей с размером чередования 64 КБ и числом столбцов, равным 2:

    ```powershell
    $PoolCount = Get-PhysicalDisk -CanPool $True
    $PhysicalDisks = Get-PhysicalDisk | Where-Object {$_.FriendlyName -like "*2" -or $_.FriendlyName -like "*3"}

    New-StoragePool -FriendlyName "DataFiles" -StorageSubsystemFriendlyName "Storage Spaces*" -PhysicalDisks $PhysicalDisks | New-VirtualDisk -FriendlyName "DataFiles" -Interleave 65536 -NumberOfColumns 2 -ResiliencySettingName simple –UseMaximumSize |Initialize-Disk -PartitionStyle GPT -PassThru |New-Partition -AssignDriveLetter -UseMaximumSize |Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisks" -AllocationUnitSize 65536 -Confirm:$false 
    ```

  * Для Windows 2008 R2 или более ранней версии можно воспользоваться динамическими дисками (чередующимися томами операционной системы), при этом размер чередования всегда составляет 64 КБ. Обратите внимание, что эта возможность не поддерживается в Windows 8 и Windows Server 2012. Дополнительные сведения см. в заявлении о поддержке в статье [Virtual Disk Service is transitioning to Windows Storage Management API](https://msdn.microsoft.com/library/windows/desktop/hh848071.aspx) (Служба виртуальных дисков переходит на API управления хранилищами Windows).

  * Если вы используете [локальные дисковые пространства (S2D)](/windows-server/storage/storage-spaces/storage-spaces-direct-in-vm) с таким сценарием, как, например, [экземпляры отказоустойчивого кластера SQL Server](virtual-machines-windows-portal-sql-create-failover-cluster.md), вам нужно настроить единый пул. Обратите внимание, что хотя в этом пуле можно создать тома с разной емкостью, они будут отличаться общей характеристикой, например общая политика кэширования.

  * Определите число дисков, связанных с пулом хранилищ, на основании ожидаемой нагрузки. Помните, что в разных размерах виртуальной машины можно подключать различное число дисков данных. Дополнительные сведения см. в статье [Размеры виртуальных машин в Azure](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

  * Если хранилище уровня "Премиум" не применяется (сценарии разработки и тестирования), то рекомендуется добавить максимальное количество дисков данных, поддерживаемое для вашего [размера виртуальной машины](../sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) и использовать чередование дисков.

* **Политика кэширования**: изучите предложенные ниже рекомендации по выбору политики кеширования в зависимости от конфигурации хранилища.

  * Если вы используете отдельные диски для файлов данных и файлов журналов, включите кэширование операций чтения только на дисках с файлами данных и файлами TempDB. Это позволит существенно повысить производительность. Не включайте кэширование для диска, где хранятся файлы журналов, так как это немного снижает производительность.

  * Если вы используете чередование дисков, для большинства рабочих нагрузок кэширование операций чтения повысит производительность. Эта рекомендация позволяет повысить производительность при чередовании дисков, а значит она применима даже в тех случаях, когда файл журнала находится на том же диске. Для некоторых рабочих нагрузок с операциями записи большого объема данных можно повысить производительность, отключив кэширование. Точные данные можно получить только путем тестирования.

  * Все описанные выше рекомендации относятся к дискам хранилища класса Premium. Если хранилище класса Premium не используется, не включайте кэширование ни для каких дисков данных.

  * Инструкции по настройке кэширования дисков см. в указанных ниже статьях. Сведения о классической модели развертывания (ASM) см. в статьях [Set-AzureOSDisk](https://msdn.microsoft.com/library/azure/jj152847) и [Set-AzureDataDisk](https://msdn.microsoft.com/library/azure/jj152851.aspx). Сведения о модели развертывания с помощью Azure Resource Manager см. в статьях [Set-AzureRMOSDisk](https://docs.microsoft.com/powershell/module/azurerm.compute/set-azurermvmosdisk?view=azurermps-4.4.1) и [Set-AzureRMVMDataDisk](https://docs.microsoft.com/powershell/module/azurerm.compute/set-azurermvmdatadisk?view=azurermps-4.4.1).

     > [!WARNING]
     > Остановите службу SQL Server при настройке кэширования дисков виртуальной машины Azure, чтобы избежать возможного повреждения баз данных.

* **Размер кластера NTFS**: при форматировании диска данных рекомендуется использовать размер кластера 64 КБ для файлов данных и журналов, а также базы данных TempDB.

* **Рекомендации по управлению дисками**: при удалении диска данных или изменении его типа кэша остановите службу SQL Server. При изменении параметров кэширования диска ОС Azure останавливает виртуальную машину, изменяет тип кэша и перезапускает виртуальную машину. При изменении параметров кэша диска данных виртуальная машина не останавливается. Диск данных отключается от нее на время внесения изменений, а затем снова подключается к виртуальной машине.

  > [!WARNING]
  > Если не останавливать службу SQL Server на время таких операций, это может привести к повреждению базы данных.

## <a name="io-guidance"></a>Рекомендации по использованию операций ввода-вывода

* Наилучшие результаты работы с хранилищем класса Premium достигаются при параллелизации приложений и запросов. Хранилище класса Premium предназначено для сценариев, где глубина очереди ввода-вывода больше 1, поэтому прирост производительности для однопоточных последовательных запросов почти не ощущается (даже если они направляются в хранилище в большом объеме). Например, это может негативно повлиять на результаты однопоточного тестирования в средствах анализа производительности, таких как SQLIO.

* Рекомендуется использовать [сжатие страниц базы данных](https://msdn.microsoft.com/library/cc280449.aspx) , так как это позволяет повысить производительность рабочих нагрузок с большим объемом операций ввода-вывода. Однако сжатие данных может повысить потребление ресурсов ЦП на сервере базы данных.

* Рекомендуется включить быструю инициализацию файлов для сокращения времени, необходимого для начального выделения файлов. Чтобы воспользоваться преимуществами быстрой инициализации файлов, назначьте SE_MANAGE_VOLUME_NAME учетной записи службы SQL Server (MSSQLSERVER) и добавьте ее в политику безопасности **Выполнение задач по обслуживанию томов**. Если вы используете образ платформы SQL Server для Azure, то учетная запись службы по умолчанию (NT Service\MSSQLSERVER) не добавляется в политику безопасности **Выполнение задач по обслуживанию томов**. Другими словами, быстрая инициализация файлов в образе платформы SQL Server Azure не включена. После добавления учетной записи службы SQL Server в политику безопасности **Выполнение задач по обслуживанию томов** перезапустите службу SQL Server. Использование этой функции может быть показано из соображений безопасности. Дополнительные сведения см. в статье [Мгновенная инициализация файлов базы данных](https://msdn.microsoft.com/library/ms175935.aspx).

* **Авторасширение** считается лишь предупредительной мерой на случай непредвиденного роста. Не используйте авторасширение для повседневного управления ростом данных и журналов. При использовании авторасширения предварительно увеличьте размер файла с помощью параметра размера.

* Убедитесь, что **автосжатие** отключено, чтобы избежать ненужных затрат ресурсов, что может отрицательно повлиять на производительность.

* Переместите все базы данных на диски с данными, включая системные базы данных. Дополнительные сведения см. в статье [Перемещение системных баз данных](https://msdn.microsoft.com/library/ms345408.aspx).

* Переместите журнал ошибок SQL Server и каталоги файлов трассировки на диски с данными. Для этого в диспетчере конфигурации SQL Server щелкните правой кнопкой мыши свой экземпляр SQL Server и выберите пункт "Свойства". На вкладке **Параметры запуска** можно изменить параметры файлов трассировки и журнала ошибок. Каталог дампа указан на вкладке **Дополнительно** . На приведенных далее снимках экрана показано, где находится параметр запуска журнала ошибок.

    ![Снимок экрана SQL ErrorLog](./media/virtual-machines-windows-sql-performance/sql_server_error_log_location.png)

* Настройка расположений по умолчанию для файлов резервных копий и базы данных. Следуйте рекомендациям в этой статье и внесите изменения в окне свойств сервера. Инструкции см. в статье [Просмотр или изменение расположения по умолчанию для файлов данных и журнала (среда SQL Server Management Studio)](https://msdn.microsoft.com/library/dd206993.aspx). На следующем снимке экрана показано, где нужно внести необходимые изменения.

    ![Файлы журнала данных SQL и резервных копий](./media/virtual-machines-windows-sql-performance/sql_server_default_data_log_backup_locations.png)
* Включение блокировки страниц для сокращения числа операций ввода-вывода, а также операций разбиения по страницам. Дополнительные сведения см. в статье [Включение параметра «Блокировка страниц в памяти» (Windows)](https://msdn.microsoft.com/library/ms190730.aspx).

* Если вы используете SQL Server 2012, установите накопительный пакет обновления 10 для пакета обновления 1. Это обновление содержит исправление для низкой производительности ввода-вывода при выполнении оператора выборки во временную таблицу в SQL Server 2012. Дополнительные сведения см. в этой [статье базы знаний](http://support.microsoft.com/kb/2958012).

* Рекомендуется сжимать файлы данных при их передаче в среду Azure и из нее.

## <a name="feature-specific-guidance"></a>Обзор конкретных функций

Для некоторых развертываний получить дополнительные преимущества, используя более сложные методики настройки. В следующем списке перечислены некоторые функции SQL Server, которые могут помочь добиться лучшей производительности:

* **Архивация в службу хранилища Azure**: при выполнении архивации данных SQL Server, запущенного на виртуальных машинах Azure, можно использовать [архивацию SQL Server на URL-адрес](https://msdn.microsoft.com/library/dn435916.aspx). Эта функция доступна, начиная с накопительного пакета обновления 2 для пакета обновления 1 SQL Server 2012, и рекомендуется к применению при архивации на подключенные диски данных. При выполнении архивации или восстановления с использованием службы хранилища Azure следуйте рекомендациям из раздела [Рекомендации по архивации SQL Server на URL-адрес, устранению неполадок и восстановлению из резервных копий в службе хранилища Azure](https://msdn.microsoft.com/library/jj919149.aspx). Кроме того, можно автоматизировать эти процессы архивации с помощью [автоматической архивации SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-automated-backup.md).

    В выпусках, предшествующих SQL Server 2012, можно использовать [инструмент архивации SQL Server в Azure](https://www.microsoft.com/download/details.aspx?id=40740). Это средство может помочь повысить пропускную способность при архивации благодаря использованию нескольких чередующихся целей архивации.

* **Файлы данных SQL Server в Azure**: эта новая функция [Файлы данных SQL Server в Azure](https://msdn.microsoft.com/library/dn385720.aspx)доступна, начиная с SQL Server 2014. Выполнение SQL Server с файлами данных в Azure демонстрирует уровень производительности, сравнимый с использованием дисков данных Azure.

## <a name="next-steps"></a>Дальнейшие действия

Рекомендации по безопасности см. в статье [Вопросы безопасности SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-security.md).

Ознакомьтесь с другими статьями, посвященными виртуальным машинам SQL Server, используя руководство с [обзором SQL Server на виртуальных машинах с Windows](virtual-machines-windows-sql-server-iaas-overview.md). Если у вас есть вопросы по виртуальным машинам SQL Server, см. раздел [часто задаваемых вопросов](virtual-machines-windows-sql-server-iaas-faq.md).
