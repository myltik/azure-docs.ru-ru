---
title: Настройка хранилища для виртуальных машин SQL Server | Документация Майкрософт
description: В этой статье описывается процесс настройки хранилища для виртуальных машин SQL Server на портале Azure во время подготовки (модель развертывания с помощью Resource Manager). Здесь также описывается настройка хранилища для имеющихся виртуальных машин SQL Server.
services: virtual-machines-windows
documentationcenter: na
author: ninarn
manager: craigg
tags: azure-resource-manager
ms.assetid: 169fc765-3269-48fa-83f1-9fe3e4e40947
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 12/05/2017
ms.author: ninarn
ms.openlocfilehash: 21c8b955d48da03559097db93b2cb66029a203ec
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2018
ms.locfileid: "29399089"
---
# <a name="storage-configuration-for-sql-server-vms"></a>Настройка хранилища для виртуальных машин SQL Server
При настройке образа виртуальной машины SQL Server на портале Azure некоторые процессы конфигурации хранилища выполняются автоматически. К этим процессам относится подключение хранилища к виртуальной машине, предоставление SQL Server доступа к нему и настройка параметров, которые позволяют оптимизировать производительность хранилища.

В этой статье описывается процесс настройки хранилища для подготавливаемых и уже имеющихся виртуальных машин SQL Server на портале Azure. Эта конфигурация основана на [рекомендациях по оптимизации производительности](virtual-machines-windows-sql-performance.md) для виртуальных машин Azure с SQL Server.

[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-rm-include.md)]

## <a name="prerequisites"></a>предварительным требованиям
Для поддержки параметров автоматической настройки хранилища виртуальная машина должна:

* быть подготовлена с помощью [коллекции образов SQL Server](virtual-machines-windows-sql-server-iaas-overview.md#payasyougo);
* использовать [модель развертывания с помощью Resource Manager](../../../azure-resource-manager/resource-manager-deployment-model.md);
* использовать [хранилище класса Premium](../premium-storage.md).

## <a name="new-vms"></a>Новые виртуальные машины
В следующих разделах описаны действия по настройке хранилища для новых виртуальных машин SQL Server.

### <a name="azure-portal"></a>Портал Azure
При подготовке виртуальной машины Azure с помощью образа SQL Server из коллекции хранилище для нее можно настроить автоматически. Можно указать размер хранилища, а также определить ограничения производительности и тип рабочей нагрузки. На следующем снимке экрана показана колонка "Конфигурация хранилища", используемая при подготовке виртуальной машины SQL.

![Настройка хранилища для виртуальной машины SQL Server во время подготовки](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-provisioning.png)

После создания виртуальной машины в зависимости от вашего выбора Azure выполняет следующие задачи по настройке хранилища:

* создает и присоединяет к виртуальной машине диски данных хранилища класса Premium;
* настраивает доступность дисков данных для SQL Server;
* настраивает диски данных в пуле носителей в зависимости от указанных требований к размеру и производительности (операции ввода-вывода в секунду и пропускная способность);
* связывает пул носителей с новым диском на виртуальной машине;
* оптимизирует этот диск в зависимости от указанного типа рабочей нагрузки ("Хранилище данных", "Обработка транзакций" или "Общая").

Дополнительные сведения о настройке параметров хранилища в Azure см. в разделе [Конфигурация хранилища](#storage-configuration). Полное пошаговое руководство по созданию виртуальной машины SQL Server на портале Azure см. в статье [Подготовка виртуальной машины SQL Server на портале Azure](virtual-machines-windows-portal-sql-server-provision.md).

### <a name="resource-manage-templates"></a>Шаблоны Resource Manager
При использовании следующих шаблонов Resource Manager по умолчанию к виртуальной машине присоединяются два диска данных класса Premium. В этом случае пул носителей не настраивается. Однако эти шаблоны можно настроить, чтобы изменить количество дисков данных класса Premium, присоединенных к виртуальной машине.

* [Создание виртуальной машины с поддержкой автоматической архивации](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autobackup)
* [Создание виртуальной машины с автоматической установкой исправлений](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-autopatching)
* [Создание виртуальной машины с интеграцией AKV](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-sql-full-keyvault)

## <a name="existing-vms"></a>Существующие виртуальные машины
Для имеющихся виртуальных машин SQL Server на портале Azure можно изменить некоторые параметры хранилища. Выберите виртуальную машину, перейдите в область "Параметры" и выберите "Конфигурация SQL Server". В колонке "Конфигурация SQL Server" отображаются сведения о текущем использовании хранилища вашей виртуальной машиной. На этой диаграмме отображаются все диски, подключенные к виртуальной машине. Дисковое пространство для каждого диска разбито на 4 раздела:

* данные SQL;
* журнал SQL;
* прочее (не хранилище SQL);
* Доступна

![Настройка хранилища для имеющейся виртуальной машины SQL Server](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-existing.png)

Чтобы настроить хранилище для добавления нового диска или расширения имеющегося, щелкните над диаграммой ссылку "Изменить".

Отображаемые параметры настройки зависят от того, использовали ли вы эту возможность раньше. При первом использовании можно указать собственные требования к хранилищу для нового диска. Если вы ранее использовали эту возможность для создания диска, его объем можно расширить.

### <a name="use-for-the-first-time"></a>Первое использование
При первом использовании этой возможности можно указать размер хранилища и определить ограничения производительности для нового диска. В целом этот процесс аналогичен настройке в ходе подготовки, а основное различие заключается в том, что вы не можете указать тип рабочей нагрузки. Это ограничение позволяет предотвратить нарушение имеющихся конфигураций SQL Server на виртуальной машине.

![Ползунки настройки хранилища для SQL Server](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-usage-sliders.png)

Azure создает диск на основе ваших параметров. В этом сценарии Azure выполняет следующие задачи по настройке хранилища:

* создает и присоединяет к виртуальной машине диски данных хранилища класса Premium;
* настраивает доступность дисков данных для SQL Server;
* настраивает диски данных в пуле носителей в зависимости от указанных требований к размеру и производительности (операции ввода-вывода в секунду и пропускная способность);
* связывает пул носителей с новым диском на виртуальной машине;

Дополнительные сведения о настройке параметров хранилища в Azure см. в разделе [Конфигурация хранилища](#storage-configuration).

### <a name="add-a-new-drive"></a>Добавление нового диска
Если хранилище на виртуальной машине SQL Server уже настроено, появится два параметра, позволяющие его расширить. Первый параметр позволяет добавить новый диск, чтобы повысить уровень производительности виртуальной машины.

![Добавление нового диска к виртуальной машине SQL](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-configuration-add-new-drive.png)

Однако после добавления диска для оптимизации производительности понадобится выполнить некоторые дополнительные настройки вручную.

### <a name="extend-the-drive"></a>Расширение диска
Другой параметр позволяет увеличить размер имеющегося диска. Он увеличивает количество доступной для хранения памяти, но не повышает производительность. После создания пула носителей вы не сможете изменить количество столбцов. Количество столбцов определяет число параллельных операций записи, которые могут распределяться по дискам данных. Поэтому добавление дисков данных не поможет вам повысить производительность. Они просто предоставляют дополнительное хранилище для записи данных. Это ограничение также означает, что при расширении диска количество столбцов определяет минимальное число дисков данных, которые можно добавить. Таким образом, если вы создаете пул носителей с четырьмя дисками, столбцов также будет четыре. Каждый раз при расширении хранилища необходимо добавлять по крайней мере четыре диска данных.

![Расширения диска для виртуальной машины SQL](./media/virtual-machines-windows-sql-storage-configuration/sql-vm-storage-extend-a-drive.png)

## <a name="storage-configuration"></a>Конфигурация хранилища
В этом разделе приведена справочная информация по изменениям конфигурации хранилища, которые Azure выполняет автоматически во время подготовки или настройки виртуальной машины SQL на портале Azure.

* Если для виртуальной машины выбрано хранилище объемом менее 2 ТБ, Azure не создает пул носителей,
* а если 2 ТБ или больше — пул носителей создается. В следующем разделе этой статьи приведены сведения о конфигурации пула носителей.
* При автоматической настройке хранилища всегда используются диски данных P30 [хранилища класса Premium](../premium-storage.md) . Следовательно, между выбранным числом терабайт и количеством дисков, прикрепленных к виртуальной машине, существует полноценное сопоставление.

Сведения о ценах см. на странице [Цены на хранилища Azure](https://azure.microsoft.com/pricing/details/storage) на вкладке **Хранилище дисков**.

### <a name="creation-of-the-storage-pool"></a>Создание пула носителей
Для создания пула носителей на виртуальных машинах SQL Server Azure использует следующие параметры.

| Параметр | Значение |
| --- | --- |
| Размер полосы |256 КБ (хранение данных), 64 КБ (обработка транзакций) |
| Размеры диска |1 ТБ каждый |
| Кэш |чтение |
| Размер выделения |Размер единицы выделения NTFS — 64 КБ |
| Мгновенная инициализация файлов |Включено |
| Блокировка страниц в памяти |Включено |
| Восстановление |Простая модель восстановления (без устойчивости) |
| Количество столбцов |Количество дисков данных<sup>1</sup> |
| Расположение временной базы данных |Хранится на дисках данных<sup>2</sup> |

<sup>1</sup> После создания пула носителей вы не сможете изменить в нем количество столбцов.

<sup>2</sup> Этот параметр применяется только для первого диска, созданного с помощью функции конфигурации хранилища.

## <a name="workload-optimization-settings"></a>Параметры оптимизации рабочей нагрузки
В следующей таблице описаны три доступных типа рабочей нагрузки и соответствующие оптимизации для каждого из них.

| Тип рабочей нагрузки | ОПИСАНИЕ | Оптимизация |
| --- | --- | --- |
| **Общие сведения** |Значение по умолчанию, поддерживающее большинство рабочих нагрузок |Нет |
| **Обработка транзакций** |Оптимизирует хранилище для рабочих нагрузок OLTP в традиционных базах данных |Флаг трассировки 1117<br/>Флаг трассировки 1118 |
| **Хранение данных** |Оптимизирует хранилище для рабочих нагрузок аналитики и отчетов |Флаг трассировки 610<br/>Флаг трассировки 1117 |

> [!NOTE]
> Тип рабочей нагрузки можно указать только во время подготовки виртуальной машины SQL на этапе настройки хранилища.
>
>

## <a name="next-steps"></a>Дополнительная информация
Другие темы, связанные с запуском SQL Server на виртуальных машинах Azure, рассматриваются в статье [SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).
