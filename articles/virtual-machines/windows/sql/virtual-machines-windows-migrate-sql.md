---
title: Перенос базы данных SQL Server в экземпляр SQL Server на виртуальной машине | Документация Майкрософт
description: Узнайте больше о том, как перенести локальную пользовательскую базу данных в SQL Server на виртуальной машине Azure.
services: virtual-machines-windows
documentationcenter: ''
author: rothja
manager: craigg
editor: ''
tags: azure-service-management
ms.assetid: 00fd08c6-98fa-4d62-a3b8-ca20aa5246b1
ms.service: virtual-machines-sql
ms.workload: iaas-sql-server
ms.tgt_pltfrm: vm-windows-sql-server
ms.devlang: na
ms.topic: article
ms.date: 02/13/2018
ms.author: jroth
ms.openlocfilehash: 64245a968eca94518d2e4238b4bc5c93c952563a
ms.sourcegitcommit: 168426c3545eae6287febecc8804b1035171c048
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/08/2018
ms.locfileid: "29809443"
---
# <a name="migrate-a-sql-server-database-to-sql-server-in-an-azure-vm"></a>Миграция базы данных SQL Server в экземпляр SQL Server на виртуальной машине Azure

Существует несколько методов переноса пользовательской базы данных из локального экземпляра SQL Server в SQL Server на виртуальной машине Azure. В этой статье будут кратко рассмотрены разные методы и рекомендованы лучшие из них для различных сценариев.

[!INCLUDE [learn-about-deployment-models](../../../../includes/learn-about-deployment-models-both-include.md)]

## <a name="what-are-the-primary-migration-methods"></a>Описание основных методов миграции
Ниже перечислены основные методы миграции.

* Локальная архивация с использованием сжатия и ручное копирование файла резервной копии на виртуальную машину Azure.
* Архивация на URL-адрес и восстановление в виртуальную машину Azure из URL-адреса.
* Отключение и копирование файлов данных и журналов в хранилище больших двоичных объектов Azure с последующим подключением их к SQL Server на виртуальной машине Azure с использованием URL-адреса.
* Преобразование локального физического компьютера в VHD Hyper-V, передача VHD в хранилище больших двоичных объектов Azure и последующее развертывание в виде новой виртуальной машины на базе отправленного VHD.
* Доставка жесткого диска в службу импорта и экспорта Windows.
* Кроме того, при наличии локального развертывания AlwaysOn с помощью [мастера добавления реплики Azure](../sqlclassic/virtual-machines-windows-classic-sql-onprem-availability.md) можно создать реплику в Azure, а затем выполнить отработку отказа, перенаправляя пользователей к экземпляру базы данных Azure.
* Используйте [репликацию транзакций](https://msdn.microsoft.com/library/ms151176.aspx) SQL Server для настройки экземпляра SQL Server Azure в качестве подписчика, а затем отключите репликацию, перенаправляя пользователей к экземпляру базы данных Azure.

> [!TIP]
> Эти методы можно также использовать для перемещения баз данных между виртуальными машинами SQL Server в Azure. Например, нет поддерживаемого способа обновления версии или выпуска виртуальной машины на основе образа SQL Server из коллекции. В этом случае следует создать новую виртуальную машину SQL Server с новым выпуском или версией и использовать один из способов переноса, описанных в этой статье, чтобы переместить базы данных. 

## <a name="choosing-your-migration-method"></a>Выбор метода миграции
Для достижения оптимальной скорости передачи данных переносить файлы баз данных на виртуальную машину Azure лучше всего с использованием сжатого файла резервной копии.

Чтобы свести к минимуму время простоя в процессе миграции базы данных, используйте функцию AlwaysOn или репликацию транзакций.

Если использовать указанные выше методы невозможно, перенесите базу данных вручную. В этом случае процесс, как правило, начинается с создания резервной копии базы данных, после этого выполняется перенос резервной копии базы данных в Azure, а затем восстановление базы данных. Кроме того, в Azure можно скопировать сами файлы базы данных, а затем подключить их. Существует несколько методов, с помощью которых можно выполнить ручной перенос базы данных на виртуальную машину Azure.

> [!NOTE]
> При обновлении до SQL Server 2014 или SQL Server 2016 с предыдущих версий SQL Server необходимо определить, нужны ли изменения. При разработке проекта миграции рекомендуется решить вопрос со всеми зависимостями от компонентов, не поддерживаемых в новой версии SQL Server. Дополнительные сведения о поддерживаемых выпусках и сценариях см. в статье [Обновление до SQL Server](https://msdn.microsoft.com/library/bb677622.aspx).

В таблице ниже перечислены основные методы миграции и указано, в каком случае лучше всего использовать каждый из методов.

| Метод | Версия исходной базы данных | Версия базы данных назначения | Ограничение на размер файла резервной копии исходной базы данных | Заметки |
| --- | --- | --- | --- | --- |
| [Локальная архивация с использованием сжатия и ручное копирование файла резервной копии на виртуальную машину Azure](#backup-and-restore) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) | Это очень простая и проверенная методика перемещения баз данных между компьютерами. |
| [Архивация в URL-адрес и последующее восстановление на виртуальную машину Azure с этого URL-адреса.](#backup-to-url-and-restore) |SQL Server 2012 SP1 CU2 или более поздней версии |SQL Server 2012 SP1 CU2 или более поздней версии |Менее 12,8 ТБ для SQL Server 2016, в противном случае менее 1 ТБ | Этот просто еще один способ перемещения файла резервной копии на виртуальную машину с помощью службы хранилища Azure. |
| [Отключение и копирование файлов данных и журналов в хранилище больших двоичных объектов Azure с последующим подключением к SQL Server на виртуальной машине Azure с использованием URL-адреса.](#detach-and-attach-from-url) |SQL Server 2005 или более поздней версии |SQL Server 2014 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) |Используйте этот метод, если необходимо [сохранить файлы с помощью службы хранилища больших двоичных объектов Azure](https://msdn.microsoft.com/library/dn385720.aspx) и подключить их к SQL Server на виртуальной машине Azure, особенно при работе с очень большими базами данных. |
| [Преобразование локального компьютера в VHD Hyper-V, отправка VHD в хранилище больших двоичных объектов Azure и последующее развертывание новой виртуальной машины на базе отправленного VHD.](#convert-to-vm-and-upload-to-url-and-deploy-as-new-vm) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) |Используется в случае [использования вашей собственной лицензии SQL Server](../../../sql-database/sql-database-paas-vs-sql-server-iaas.md) при миграции базы данных, которую планируется запустить на более ранней версии SQL Server, или при совместной миграции системных и пользовательских баз данных в рамках миграции базы данных, которая зависит от других пользовательских и (или) системных баз данных. |
| [Доставка жестких дисков в службу импорта и экспорта Windows.](#ship-hard-drive) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) |Следует использовать [службу импорта и экспорта Windows](../../../storage/common/storage-import-export-service.md) , когда на ручное копирование требуется слишком много времени, особенно при работе с базами данных очень большого размера. |
| [Работа с мастером добавления реплики Azure](../sqlclassic/virtual-machines-windows-classic-sql-onprem-availability.md) |SQL Server 2012 или более поздней версии |SQL Server 2012 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) |Сокращает время простоя, используется при наличии локального развертывания AlwaysOn. |
| [Использование репликации транзакций SQL Server](https://msdn.microsoft.com/library/ms151176.aspx) |SQL Server 2005 или более поздней версии |SQL Server 2005 или более поздней версии |[Ограничение на размер хранилища виртуальной машины Azure](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/) |Используется при необходимости сократить время простоя, если локальное развертывание AlwaysOn отсутствует. |

## <a name="backup-and-restore"></a>Архивация и восстановление
Создайте резервную копию базы данных с использованием сжатия, скопируйте ее на виртуальную машину, а затем восстановите базу данных. Если размер файла резервной копии превышает 1 ТБ, необходимо разбить его на части, так как максимальный размер диска виртуальной машины — 1 ТБ. Для миграции пользовательской базы данных с помощью этого ручного метода выполните указанные ниже общие действия.

1. Создайте полную резервную копию базы данных в локальном расположении.
2. Создайте или отправьте виртуальную машину с необходимой версией SQL Server.
3. Настройте подключения в соответствии со своими требованиями. Ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](virtual-machines-windows-sql-connect.md).
4. Скопируйте файлы резервной копии в виртуальную машину с помощью удаленного рабочего стола, проводника Windows или команды копирования в командной строке.

## <a name="backup-to-url-and-restore"></a>Архивация в URL-адрес и восстановление
Вместо архивации в локальный файл можно использовать [архивацию на URL-адрес](https://msdn.microsoft.com/library/dn435916.aspx), а затем — восстановление с URL-адреса на виртуальную машину. SQL Server 2016 поддерживает разбитые на части наборы резервных копий. Рекомендуется использовать их для повышения производительности и в случаях, когда необходимо обойти ограничения размера на один большой двоичный объект. Для очень больших баз данных рекомендуется использовать [службу импорта и экспорта Windows](../../../storage/common/storage-import-export-service.md).

## <a name="detach-and-attach-from-url"></a>Отключение и подключение с использованием URL-адреса
Отключите базу данных и файлы журнала и передайте их в [хранилище BLOB-объектов Azure](https://msdn.microsoft.com/library/dn385720.aspx). Затем подключите к виртуальной машине Azure базу данных по URL-адресу. Используйте это, если хотите, чтобы физические файлы базы данных находились в хранилище BLOB-объектов. Это может быть удобно для очень больших баз данных. Для миграции пользовательской базы данных с помощью этого ручного метода выполните указанные ниже общие действия.

1. Отключите файлы базы данных от локального экземпляра базы данных.
2. Скопируйте отключенные файлы базы данных в хранилище больших двоичных объектов Azure с помощью [служебной программы командной строки AZCopy](../../../storage/common/storage-use-azcopy.md).
3. Подключите файлы базы данных из URL-адреса Azure к экземпляру SQL Server в виртуальной машине Azure.

## <a name="convert-to-vm-and-upload-to-url-and-deploy-as-new-vm"></a>Преобразование в виртуальную машину, отправка на URL-адрес и развертывание в качестве новой виртуальной машины
Этот метод используется для переноса всех системных и пользовательских баз данных из локального экземпляра SQL Server на виртуальную машину Azure. Для переноса всего экземпляра SQL Server с помощью этого ручного метода выполните указанные ниже действия.

1. Преобразуйте физические или виртуальные машины в VHD Hyper-V с помощью средства [Microsoft Virtual Machine Converter](https://technet.microsoft.com/library/dn874008(v=ws.11).aspx).
2. Отправьте VHD-файлы в службу хранилища Azure с помощью [командлета Add-AzureVHD](https://msdn.microsoft.com/library/windowsazure/dn495173.aspx).
3. Разверните новую виртуальную машину на базе отправленного VHD-файла.

> [!NOTE]
> Чтобы перенести приложение целиком, можно воспользоваться [Azure Site Recovery](../../../site-recovery/site-recovery-overview.md).

## <a name="ship-hard-drive"></a>Отправка жестких дисков
Для передачи больших объемов данных в хранилище больших двоичных объектов Azure в ситуациях, когда отправка этих данных по сети чрезвычайно дорога или невыполнима, можно использовать [службу импорта и экспорта Windows](../../../storage/common/storage-import-export-service.md) . При использовании этой службы можно отправить один или несколько жестких дисков с данными в центр обработки данных Azure, где данные будут перемещены в вашу учетную запись хранения.

## <a name="next-steps"></a>Дальнейшие действия
Подробные сведения о работе SQL Server на виртуальных машинах Azure см. в разделе [Общие сведения об SQL Server на виртуальных машинах Azure](virtual-machines-windows-sql-server-iaas-overview.md).

> [!TIP]
> Если у вас есть вопросы по виртуальным машинам SQL Server, см. раздел [часто задаваемых вопросов](virtual-machines-windows-sql-server-iaas-faq.md).

Инструкции по созданию образа виртуальной машины Azure SQL Server из записанного образа см. в [рекомендациях по клонированию виртуальных машин Azure SQL из записанных образов](https://blogs.msdn.microsoft.com/psssql/2016/07/06/tips-tricks-on-cloning-azure-sql-virtual-machines-from-captured-images/) в блоге разработчиков CSS SQL Server.

