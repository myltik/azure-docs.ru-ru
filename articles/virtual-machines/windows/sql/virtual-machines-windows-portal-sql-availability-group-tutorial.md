---
title: Руководство по использованию групп доступности SQL Server и виртуальных машин Azure | Документация Майкрософт
description: В этом руководстве показано, как создать группу доступности AlwaysOn SQL Server на виртуальных машинах Azure.
services: virtual-machines
documentationCenter: na
authors: MikeRayMSFT
manager: craigg
editor: monicar
tags: azure-service-management
ms.assetid: 08a00342-fee2-4afe-8824-0db1ed4b8fca
ms.service: virtual-machines-sql
ms.devlang: na
ms.custom: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 05/09/2017
ms.author: mikeray
ms.openlocfilehash: 915f36678b8515c5f4a6bd367843255865f4b34d
ms.sourcegitcommit: c3d53d8901622f93efcd13a31863161019325216
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/29/2018
---
# <a name="configure-always-on-availability-group-in-azure-vm-manually"></a>Настройка группы доступности AlwaysOn на виртуальной машине Azure вручную

В этом руководстве показано, как создать группу доступности AlwaysOn SQL Server на виртуальных машинах Azure. Полная версия руководства позволяет создать группу доступности с репликой базы данных на двух серверах SQL Server.

**Оценка времени**. Потребуется около 30 минут (при условии, что предварительные требования уже выполнены).

На схеме ниже показаны шаги, которые описываются в этом руководстве.

![Группа доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/00-EndstateSampleNoELB.png)

## <a name="prerequisites"></a>предварительным требованиям

К данному руководству можно переходить, если у вас имеются базовое представление о группах доступности AlwaysOn SQL Server. Если вы хотите узнать больше, ознакомьтесь с разделом [Группы доступности AlwaysOn (SQL Server)](http://msdn.microsoft.com/library/ff877884.aspx).

В следующей таблице перечислены предварительные условия, которые необходимо выполнить перед изучением данного руководства.

|  |Требование |ОПИСАНИЕ |
|----- |----- |----- |
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png) | Два сервера SQL Server | В группе доступности Azure. <br/> В отдельном домене. <br/> С установленным компонентом отказоустойчивой кластеризации. |
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png)| Windows Server | Файловый ресурс для свидетеля кластера. |  
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png)|Учетная запись службы SQL Server | Доменная учетная запись. |
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png)|Учетная запись службы агента SQL Server | Доменная учетная запись. |  
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png)|Открытые порты брандмауэра | SQL Server: порт **1433** для экземпляра по умолчанию. <br/> Конечная точка зеркального отображения базы данных: порт **5022** или любой доступный порт. <br/> Проба Azure Load Balancer: порт **59999** или любой доступный порт. |
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png)|Добавление компонента отказоустойчивой кластеризации | Этот компонент нужен на обоих серверах SQL Server. |
|![Маркер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/square.png)|Доменная учетная запись для установки | Локальный администратор на каждом сервере SQL Server. <br/> Участник фиксированной роли сервера SQL Server sysadmin для каждого экземпляра SQL Server.  |


Прежде чем приступить к этому руководству, необходимо [настроить необходимые компонентов для создания групп доступности AlwaysOn на виртуальных машинах Azure](virtual-machines-windows-portal-sql-availability-group-prereq.md). Если эти предварительные условия уже выполнены, то можно перейти к [созданию кластера](#CreateCluster).


<!--**Procedure**: *This is the first “step”. Make titles H2’s and short and clear – H2’s appear in the right pane on the web page and are important for navigation.*-->

<a name="CreateCluster"></a>
## Создание кластера

Первым шагом после выполнения предварительных условий является создание отказоустойчивого кластера Windows Server, включающего в себя два сервера SQL Server и следящий сервер.  

1. Подключитесь по протоколу RDP к первому серверу SQL Server, используя доменную учетную запись с правами администратора для обоих серверов SQL Server и следящего сервера.

   >[!TIP]
   >Если вы следовали указаниям в [документе с предварительными требованиями](virtual-machines-windows-portal-sql-availability-group-prereq.md), то уже создали учетную запись **CORP\Install**. Используйте ее.

2. На панели мониторинга **Диспетчер серверов** выберите **Инструменты**, а затем **Диспетчер отказоустойчивости кластеров**.
3. В левой области щелкните правой кнопкой мыши **Диспетчер отказоустойчивости кластеров** и выберите **Создать кластер**.
   ![Создание кластера](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/40-createcluster.png)
4. В мастере создания кластеров создайте кластер с одним узлом, поэтапно настроив параметры на всех страницах, как указано в таблице ниже.

   | Страница | Параметры |
   | --- | --- |
   | Перед началом работы |По умолчанию |
   | Выбор серверов |Введите имя первого сервера SQL Server в поле **Введите имя сервера** и нажмите кнопку **Добавить**. |
   | Предупреждение проверки |Выберите вариант **Нет. Для этого кластера не требуется поддержка корпорации Майкрософт, поэтому нет необходимости выполнять проверочные тесты. После нажатия кнопки "Далее" продолжить создание кластера**. |
   | Точка доступа для администрирования кластера |Введите имя кластера, например **SQLAGCluster1**, в поле **Имя кластера**.|
   | Подтверждение |Используйте параметры по умолчанию, если вы не используете дисковые пространства. Ознакомьтесь с примечанием после этой таблицы. |

### <a name="set-the-cluster-ip-address"></a>Настройка IP-адреса кластера

1. В **диспетчере отказоустойчивости кластеров** прокрутите вниз до раздела **Ресурсы ядра кластера** и разверните сведения о кластере. Вы увидите ресурсы **Имя** и **IP-адрес** с состоянием **Ошибка**. Ресурс IP-адреса невозможно подключить к сети, так как кластеру назначен тот же IP-адрес, что и виртуальной машине, то есть он повторяется.

2. Щелкните правой кнопкой мыши ресурс **IP-адреса** в состоянии сбоя и выберите **Свойства**.

   ![Свойства кластера](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/42_IPProperties.png)

3. Выберите **Статический IP-адрес** и укажите в текстовом поле "Адрес" доступный адрес из подсети, в которой находится сервер SQL Server. Затем нажмите кнопку **ОК**.
4. В разделе **Ресурсы ядра кластера** щелкните правой кнопкой мыши имя кластера и выберите **Подключить**. Подождите, пока оба ресурса будут подключены. Когда ресурс имени кластера подключится, он добавит на контроллер домена новую учетную запись компьютера Active Directory (AD). Эта учетная запись впоследствии будет использоваться для запуска кластерной службы группы доступности.

### <a name="addNode"></a>Добавление в кластер другого сервера SQL Server

Добавьте в кластер другой сервер SQL Server.

1. В дереве браузера щелкните правой кнопкой мыши кластер и выберите **Добавить узел**.

    ![Добавление узла в кластер](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/44-addnode.png)

1. В **мастере добавления узлов** нажмите кнопку **Далее**. На странице **Выбор серверов** добавьте второй сервер SQL Server. Введите имя этого сервера в поле **Введите имя сервера** и нажмите кнопку **Добавить**. Когда будете готовы, нажмите кнопку **Далее**.

1. На странице **Предупреждение проверки** нажмите кнопку **Нет** (в рабочем сценарии следует выполнить проверочные тесты). Затем щелкните **Далее**.

8. Если вы используете дисковые пространства, то на странице **Подтверждение** снимите флажок **Добавление всех допустимых хранилищ в кластер**.

   ![Подтверждение добавления узла](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/46-addnodeconfirmation.png)

    >[!WARNING]
   >Если вы используете дисковые пространства и не сняли флажок **Добавление всех допустимых хранилищ в кластер**, то Windows отключит виртуальные диски во время процесса кластеризации. Как следствие, они не отобразятся в диспетчере дисков или Explorer, пока дисковые пространства не будут удалены из кластера и повторно подключены с помощью PowerShell. Дисковые пространства группируют несколько дисков в пулы носителей. Дополнительные сведения см. в статье [Обзор дисковых пространств](https://technet.microsoft.com/library/hh831739).

1. Нажмите кнопку **Далее**.

1. Нажмите кнопку **Готово**

   Диспетчер отказоустойчивости кластеров показывает, что в кластере появился новый узел. Он отображается в контейнере **Nodes**.

10. Выйдите из сеанса удаленного рабочего стола.

### <a name="add-a-cluster-quorum-file-share"></a>Добавление файлового ресурса кворума кластера

В этом примере кластер Windows использует файловый ресурс для создания кворума кластера. В этом руководстве используется кворум "Большинство узлов и общих файловых ресурсов". Дополнительные сведения см. в разделе [Общее представление о конфигурациях кворума в отказоустойчивом кластере](http://technet.microsoft.com/library/cc731739.aspx).

1. Подключитесь к рядовому серверу файлового ресурса-свидетеля с помощью сеанса удаленного рабочего стола.

1. В **диспетчере сервера** щелкните **Инструменты**. Щелкните **Управление компьютером**.

1. Щелкните **Общие папки**.

1. Щелкните правой кнопкой мыши **Общие ресурсы** и выберите **Создать папку…**.

   ![Новый общий ресурс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/48-newshare.png)

   Используйте **мастер создания общих ресурсов**, чтобы создать общий ресурс.

1. Рядом с полем **Путь к папке** нажмите кнопку **Обзор** и укажите путь к общей папке, или создайте его, указав в этом поле. Нажмите кнопку **Далее**.

1. В окне **Имя, описание и параметры** проверьте имя и путь общего ресурса. Нажмите кнопку **Далее**.

1. В окне **Разрешения для общей папки** выберите **Настройка разрешений доступа**. Щелкните **Настраиваемые…**.

1. В окне **Настройка разрешений доступа** нажмите кнопку **Добавить**.

1. Убедитесь, что у учетной записи, используемой для создания кластера, имеется полный доступ.

   ![Новый общий ресурс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/50-filesharepermissions.png)

1. Последовательно выберите **ОК**.

1. В окне **Разрешения для общей папки** нажмите кнопку **Готово**. Еще раз нажмите кнопку **Готово**.  

1. Выйдите с сервера.

### <a name="configure-cluster-quorum"></a>Настройка кворума кластера

Теперь настройте кворум кластера.

1. Подключитесь к первому узлу кластера с помощью сеанса удаленного рабочего стола.

1. В **диспетчере отказоустойчивости кластеров** щелкните кластер правой кнопкой мыши, наведите указатель на пункт **Дополнительные действия** и щелкните **Настройка параметров кворума кластера**.

   ![Новый общий ресурс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/52-configurequorum.png)

1. В **мастере настройки кворума кластера** нажмите кнопку **Далее**.

1. В окне **Выбор параметра конфигурации кворума** щелкните **Выбрать свидетель кворума** и нажмите кнопку **Далее**.

1. В окне **Выбрать свидетель кворума** щелкните **Настроить файловый ресурс-свидетель**.

   >[!TIP]
   >Windows Server 2016 поддерживает облако-свидетель. При выборе этого типа свидетеля файловый ресурс-свидетель не требуется. Дополнительные сведения см. в разделе [Развертывание облачного следящего сервера для отказоустойчивого кластера](http://technet.microsoft.com/windows-server-docs/failover-clustering/deploy-cloud-witness). В этом руководстве используется файловый ресурс-свидетель, который поддерживается в предыдущих операционных системах.

1. В поле **Настройка файлового ресурса-свидетеля** введите путь к созданному общему ресурсу. Нажмите кнопку **Далее**.

1. Проверьте параметры в окне **Подтверждение**. Нажмите кнопку **Далее**.

1. Нажмите кнопку **Готово**

Теперь ресурсы ядра кластера настроены для использования файлового ресурса-свидетеля.

## <a name="enable-availability-groups"></a>Включение групп доступности

Далее следует включить функцию **групп доступности AlwaysOn**. Выполните эти шаги для обоих серверов SQL Server.

1. На **начальном экране** запустите **Диспетчер конфигурации SQL Server**.
2. В дереве обозревателя выберите **Службы SQL Server**, затем щелкните правой кнопкой мыши службу **SQL Server (MSSQLSERVER)** и выберите пункт **Свойства**.
3. Выберите вкладку **Высокая доступность AlwaysOn**, затем щелкните **Включить группы доступности AlwaysOn**, как показано ниже.

    ![Включение групп доступности AlwaysOn](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/54-enableAlwaysOn.png)

4. Нажмите кнопку **Применить**. Нажмите кнопку **ОК** во всплывающем диалоговом окне.

5. Перезапустите службу SQL Server.

Повторите эти действия на другом сервере SQL Server.

<!-----------------
## <a name="endpoint-firewall"></a>Open firewall for the database mirroring endpoint

Each instance of SQL Server that participates in an Availability Group requires a database mirroring endpoint. This endpoint is a TCP port for the instance of SQL Server that is used to synchronize the database replicas in the Availability Groups on that instance.

On both SQL Servers, open the firewall for the TCP port for the database mirroring endpoint.

1. On the first SQL Server **Start** screen, launch **Windows Firewall with Advanced Security**.
2. In the left pane, select **Inbound Rules**. On the right pane, click **New Rule**.
3. For **Rule Type**, choose **Port**.
1. For the port, specify TCP and choose an unused TCP port number. For example, type *5022* and click **Next**.

   >[!NOTE]
   >For this example, we're using TCP port 5022. You can use any available port.

5. In the **Action** page, keep **Allow the connection** selected and click **Next**.
6. In the **Profile** page, accept the default settings and click **Next**.
7. In the **Name** page, specify a rule name, such as **Default Instance Mirroring Endpoint** in the **Name** text box, then click **Finish**.

Repeat these steps on the second SQL Server.
-------------------------->

## <a name="create-a-database-on-the-first-sql-server"></a>Создание базы данных на первом сервере SQL Server

1. Запустите RDP-файл подключения к первому серверу SQL Server с доменной учетной записью, которая является участником фиксированной серверной роли sysadmin.
1. Откройте SQL Server Management Studio и подключитесь к первому серверу SQL Server.
7. В **обозревателе объектов** щелкните правой кнопкой мыши **Базы данных** и выберите пункт **Новая база данных**.
8. В поле **Имя базы данных** введите **MyDB1**, а затем нажмите кнопку **ОК**.

### <a name="backupshare"></a>Создание общего ресурса для резервных копий

1. На первом сервере SQL Server в **диспетчере сервера** щелкните **Инструменты**. Щелкните **Управление компьютером**.

1. Щелкните **Общие папки**.

1. Щелкните правой кнопкой мыши **Общие ресурсы** и выберите **Создать папку…**.

   ![Новый общий ресурс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/48-newshare.png)

   Используйте **мастер создания общих ресурсов**, чтобы создать общий ресурс.

1. Рядом с полем **Путь к папке** нажмите кнопку **Обзор** и укажите путь к общей папке резервных копий баз данных, или создайте его, указав в этом поле. Нажмите кнопку **Далее**.

1. В окне **Имя, описание и параметры** проверьте имя и путь общего ресурса. Нажмите кнопку **Далее**.

1. В окне **Разрешения для общей папки** выберите **Настройка разрешений доступа**. Щелкните **Настраиваемые…**.

1. В окне **Настройка разрешений доступа** нажмите кнопку **Добавить**.

1. Убедитесь, что учетные записи службы SQL Server и агента службы SQL Server для обоих серверов имеют полный доступ.

   ![Новый общий ресурс](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/68-backupsharepermission.png)

1. Последовательно выберите **ОК**.

1. В окне **Разрешения для общей папки** нажмите кнопку **Готово**. Еще раз нажмите кнопку **Готово**.  

### <a name="take-a-full-backup-of-the-database"></a>Создание полной резервной копии базы данных

Необходимо создать резервную копию новой базы данных, чтобы инициализировать цепочку журналов. Если не создать резервную копию новой базы данных, то ее невозможно будет добавить в группу доступности.

1. В **обозревателе объектов** щелкните правой кнопкой мыши базу данных, наведите указатель на пункт **Задачи…** и щелкните **Архивировать**.

1. Нажмите кнопку **ОК**, чтобы создать полную резервную копию в расположении архива по умолчанию.

## <a name="create-the-availability-group"></a>Создание группы доступности
Теперь все готово к настройке группы доступности. Для этого выполните следующее.

* Создайте базу данных на первом сервере SQL Server.
* Создание полной резервной копии и резервной копии журнала транзакций базы данных.
* Восстановите полную резервную копию и резервную копию журналов на второй сервер SQL Server с параметром **NORECOVERY**.
* Создайте группу доступности (**AG1**) с синхронной фиксацией, автоматической отработкой отказа и доступными для чтения вторичными репликами.

### <a name="create-the-availability-group"></a>Создание группы доступности

1. Откройте сеанс удаленного рабочего стола для первого сервера SQL Server. В **обозревателе объектов** в SSMS щелкните правой кнопкой мыши **Высокая доступность AlwaysOn** и выберите пункт **Мастер создания групп доступности**.

    ![Запуск мастера создания групп доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/56-newagwiz.png)

2. На странице **Введение** нажмите кнопку **Далее**. На странице **Указание имени группы доступности** в поле **Имя группы доступности** введите имя группы доступности (например, **AG1**). Нажмите кнопку **Далее**.

    ![Мастер создания групп доступности, ввод имени групп доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/58-newagname.png)

3. На странице **Выбор баз данных** выберите свою базу данных и нажмите кнопку **Далее**.

   >[!NOTE]
   >Эта база данных отвечает требованиям для создания группы доступности, так как вы создали для нее как минимум одну полную резервную копию на соответствующей первичной реплике.

   ![Мастер создания групп доступности, выбор баз данных](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/60-newagselectdatabase.png)
4. На странице **Указание реплик** нажмите кнопку **Добавить реплику**.

   ![Мастер создания групп доступности, указание реплик](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/62-newagaddreplica.png)
5. Появится диалоговое окно **Подключение к серверу** . Введите имя второго сервера в поле **Имя сервера**. Щелкните **Подключить**.

   На странице **Указание реплик** в списке **Реплики доступности** должен отобразиться второй сервер. Настройте реплики, как описано ниже.

   ![Мастер создания групп доступности, указание реплик (завершено)](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/64-newagreplica.png)

6. Щелкните **Конечные точки**, чтобы просмотреть конечную точку зеркального отображения базы данных для этой группы доступности. Используйте тот же порт, что и при настройке [правила брандмауэра для конечных точек зеркального отображения базы данных](virtual-machines-windows-portal-sql-availability-group-prereq.md#endpoint-firewall).

    ![Мастер создания групп доступности, выбор начальной синхронизации данных](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/66-endpoint.png)

8. На странице **Выбор начальной синхронизации данных** выберите **Полная** и укажите сетевую папку. Это должен быть [созданный вами общий ресурс для резервных копий](#backupshare). В примере это была папка **\\\\\<First SQL Server\>\Backup\**. Нажмите кнопку **Далее**.

   >[!NOTE]
   >При полной синхронизации полная резервная копия базы данных создается на первом экземпляре SQL Server и восстанавливается на втором экземпляре. Полная синхронизация не рекомендуется для больших баз данных, так как может занимать много времени. Это время можно сократить, вручную создав резервную копию базы данных и восстановив ее с параметром `NO RECOVERY`. Если база данных уже была восстановлена с параметром `NO RECOVERY` на втором сервере SQL Server перед настройкой группы доступности, выберите переключатель **Только присоединение**. Если вы хотите создать резервную копию после настройки группы доступности, выберите переключатель **Пропустить начальную синхронизацию данных**.

    ![Мастер создания групп доступности, выбор начальной синхронизации данных](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/70-datasynchronization.png)

9. На странице **Проверка** нажмите кнопку **Далее**. Эта страница должна выглядеть, как на рисунке ниже.

    ![Мастер создания групп доступности, проверка](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/72-validation.png)

    >[!NOTE]
    >Появится предупреждение о конфигурации прослушивателя группы доступности, так как он еще не настроен. Это предупреждение можно игнорировать, так как на виртуальных машинах Azure создать прослушиватель можно и после создания Azure Load Balancer.

10. На странице **Сводка** нажмите кнопку **Готово**, затем подождите, пока мастер настроит новую группу доступности. На странице **Ход выполнения** вы можете нажать кнопку **Дополнительные сведения**, чтобы просмотреть подробности хода выполнения. Завершив работу с мастером, проверьте содержимое страницы **Результаты**, чтобы убедиться в том, что группа доступности успешно создана.

     ![Мастер создания групп доступности, результаты](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/74-results.png)
11. Нажмите кнопку **Закрыть**, чтобы выйти из мастера.

### <a name="check-the-availability-group"></a>Проверка группы доступности

1. В **обозревателе объектов** разверните элемент **Высокая доступность AlwaysOn**, а затем — элемент **Группы доступности**. Теперь в этом контейнере должна появиться новая группа доступности. Щелкните ее правой кнопкой мыши и выберите пункт **Show Dashboard** (Показать панель мониторинга).

   ![Отображение панели мониторинга группы доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/76-showdashboard.png)

   **Панель мониторинга AlwaysOn** должна иметь следующий вид.

   ![Панель мониторинга группы доступности](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/78-agdashboard.png)

   Вы увидите реплики, режим отработки отказа для каждой из них и состояние синхронизации.

2. В **диспетчере отказоустойчивости кластеров** щелкните свой кластер. Выберите **Роли**. Имя группы доступности, которое вы использовали, представляет собой роль в кластере. Так как вы не настроили прослушиватель, у этой группы доступности нет IP-адреса для подключений клиентов. Вы настроите прослушиватель после создания Azure Load Balancer.

   ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/80-clustermanager.png)

   > [!WARNING]
   > Не пытайтесь выполнить отработку отказа для группы доступности через диспетчер отказоустойчивости кластеров. Все операции отработки отказов следует выполнять через **панель мониторинга AlwaysOn** в SSMS. Дополнительные сведения см. в статье [Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)](https://msdn.microsoft.com/library/ff929171.aspx).
    >

На этом этапе имеется группа доступности с репликами в двух экземплярах SQL Server. Группу доступности можно перемещать между экземплярами. Пока что подключиться к группе доступности невозможно, так как отсутствует прослушиватель. В виртуальных машинах Azure для прослушивателя требуется подсистема балансировки нагрузки. Следующий шаг — создание подсистемы балансировки нагрузки в Azure.

<a name="configure-internal-load-balancer"></a>

## <a name="create-an-azure-load-balancer"></a>Создание Azure Load Balancer

Для группы доступности SQL Server на виртуальных машинах Azure необходима подсистема балансировки нагрузки. Подсистема балансировки нагрузки хранит IP-адрес для прослушивателя группы доступности. В этом разделе кратко описывается, как создать подсистему балансировки нагрузки на портале Azure.

1. На портале Azure перейдите к группе ресурсов, содержащей ваши серверы SQL Server, и щелкните **+ Добавить**.
2. Найдите **балансировщик нагрузки**. Выберите подсистему балансировки нагрузки, опубликованную корпорацией Майкрософт.

   ![Группа доступности в диспетчере отказоустойчивости кластеров](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/82-azureloadbalancer.png)

1.  Нажмите кнопку **Создать**.
3. Настройте следующие параметры для балансировщика нагрузки:

   | Параметр | Поле |
   | --- | --- |
   | **Имя** |Используйте для подсистемы балансировки нагрузки текстовое имя, например **sqlLB**. |
   | **Тип** |Внутренний |
   | **Виртуальная сеть** |Используйте имя виртуальной сети Azure. |
   | **Подсеть** |Используйте имя подсети, в которой находится виртуальная машина.  |
   | **Назначение IP-адресов** |Статическое |
   | **IP-адрес** |Используйте доступный адрес из подсети. Обратите внимание, что он отличается от IP-адреса кластера. |
   | **Подписка** |Используйте подписку, в которой находится виртуальная машина. |
   | **Местоположение.** |Используйте расположение, в котором находится виртуальная машина. |

   Колонка портала Azure должна выглядеть следующим образом.

   ![Создание балансировщика нагрузки](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/84-createloadbalancer.png)

1. Щелкните **Создать**, чтобы создать подсистему балансировки нагрузки.

Для настройки подсистемы балансировки нагрузки необходимо создать внутренний пул, пробу и задать правила балансировки нагрузки. Это можно сделать на портале Azure.

### <a name="add-backend-pool"></a>Добавление внутреннего пула

1. На портале Azure перейдите к своей группе доступности. Может потребоваться обновить представление, чтобы отобразить только что созданную подсистему балансировки нагрузки.

   ![Поиск подсистемы балансировки нагрузки в группе ресурсов](./media/virtual-machines-windows-portal-sql-availability-group-tutorial/86-findloadbalancer.png)

1. Выберите подсистему балансировки нагрузки, щелкните **Серверные пулы** и нажмите кнопку **+ Добавить**. 

1. Свяжите серверный пул с группой доступности, в которую входят виртуальные машины.

1. В разделе **Целевые IP-конфигурации сети** установите флажок **Виртуальная машина** и выберите обе виртуальные машины, на которых будут размещаться реплики группы доступности. Не следует добавлять сервер файлового ресурса-свидетеля.

   >[!NOTE]
   >Если не указать обе виртуальные машины, будет установлено подключение только к первичной реплике.

1. Нажмите кнопку **ОК**, чтобы создать внутренний пул.

### <a name="set-the-probe"></a>Настройка пробы

1. Выберите подсистему балансировки нагрузки, щелкните **Health probes** (Пробы работоспособности) и нажмите кнопку **+ Добавить**.

1. Настройте следующие параметры пробы работоспособности.

   | Параметр | ОПИСАНИЕ | Пример
   | --- | --- |---
   | **Имя** | текст | SQLAlwaysOnEndPointProbe |
   | **Протокол** | Выберите протокол TCP. | TCP |
   | **Порт** | Любой неиспользуемый порт. | 59999 |
   | **Интервал**  | Промежуток времени между повторными попытками выполнения пробы в секундах. |5 |
   | **Пороговое значение сбоя** | Число последовательных сбоев пробы, после которых виртуальная машина будет считаться неработоспособной.  | 2 |

1. Нажмите кнопку **ОК**, чтобы задать пробу работоспособности.

### <a name="set-the-load-balancing-rules"></a>Настройка правил балансировки нагрузки

1. Выберите подсистему балансировки нагрузки, щелкните **Правила балансировки нагрузки** и нажмите кнопку **+ Добавить**.

1. Настройте следующие правила балансировки нагрузки.
   | Параметр | ОПИСАНИЕ | Пример
   | --- | --- |---
   | **Имя** | текст | SQLAlwaysOnEndPointListener |
   | **Frontend IP address** (Интерфейсный IP-адрес) | Выберите адрес. |Используйте адрес, который был создан при создании подсистемы балансировки нагрузки. |
   | **Протокол** | Выберите протокол TCP. |TCP |
   | **Порт** | Используйте порт экземпляра SQL Server. | 1433 |
   | **Серверный порт** | Это поле не используется, если задан плавающий IP-адрес для прямого ответа от сервера. | 1433 |
   | **Проба** |Имя, указанное для пробы. | SQLAlwaysOnEndPointProbe |
   | **Сохранение сеанса** | Раскрывающийся список. | **None** |
   | **Время ожидания простоя** | Интервал (в минутах), в течение которого подключение TCP остается открытым. | 4. |
   | **Плавающий IP-адрес (прямой ответ от сервера)** | |Включено |

   > [!WARNING]
   > Параметры прямого ответа от сервера задаются во время создания. Их невозможно изменить.

1. Нажмите кнопку **ОК**, чтобы задать правила балансировки нагрузки.

## <a name="configure-listener"></a>Настройка прослушивателя

Далее нужно настроить прослушиватель группы доступности в отказоустойчивом кластере.

> [!NOTE]
> В этом руководстве показано, как создать отдельный прослушиватель с одним IP-адресом внутренней подсистемы балансировки нагрузки (ILB). Чтобы создать один или несколько прослушивателей с использованием одного или нескольких IP-адресов, ознакомьтесь со статьей [Configure one or more Always On Availability Group Listeners - Resource Manager](virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json) (Настройка одного или нескольких прослушивателей группы доступности AlwaysOn в модели Resource Manager).
>
>

[!INCLUDE [ag-listener-configure](../../../../includes/virtual-machines-ag-listener-configure.md)]

## <a name="set-listener-port"></a>Настройка порта прослушивателя

Настройте порт прослушивателя в SQL Server Management Studio.

1. Запустите SQL Server Management Studio и подключитесь к основной реплике.

1. Перейдите в раздел **Высокий уровень доступности AlwaysOn** | **Группы доступности** | **Прослушиватели группы доступности**.

1. Теперь вы увидите имя прослушивателя, созданного в диспетчере отказоустойчивости кластеров. Щелкните правой кнопкой мыши имя прослушивателя и выберите **Свойства**.

1. В поле **Порт** укажите номер порта для прослушивателя группы доступности с помощью использованного ранее параметра $EndpointPort (по умолчанию использовалось значение 1433) и нажмите кнопку **ОК**.

Теперь у вас есть группа доступности SQL Server на виртуальных машинах Azure в режиме Resource Manager.

## <a name="test-connection-to-listener"></a>Проверка подключения к прослушивателю

Чтобы проверить подключение:

1. Подключитесь по протоколу RDP к серверу SQL Server, который находится в той же виртуальной сети, но не содержит реплику. Можно использовать другой сервер SQL Server в кластере.

1. Для проверки подключения используйте служебную программу **sqlcmd** . Например, в следующем сценарии **sqlcmd** подключается к основной реплике через прослушиватель с использованием аутентификации Windows.

    ```
    sqlcmd -S <listenerName> -E
    ```

    Если прослушиватель использует порт, отличный от порта по умолчанию (1433), укажите порт в строке подключения. Например, следующая команда sqlcmd подключается к прослушивателю через порт 1435.

    ```
    sqlcmd -S <listenerName>,1435 -E
    ```

sqlcmd автоматически подключается к любому экземпляру SQL Server, на котором размещена основная реплика.

> [!TIP]
> Указанный порт должен быть открыт в брандмауэре обоих серверов SQL Server. Для обоих серверов требуется правило для входящего трафика используемого TCP-порта. Дополнительные сведения см. в статье [Добавление и изменение правила брандмауэра](http://technet.microsoft.com/library/cc753558.aspx).
>
>



<!--**Notes**: *Notes provide just-in-time info: A Note is “by the way” info, an Important is info users need to complete a task, Tip is for shortcuts. Don’t overdo*.-->


<!--**Procedures**: *This is the second “step." They often include substeps. Again, use a short title that tells users what they’ll do*. *("Configure a new web project.")*-->

<!--**UI**: *Note the format for documenting the UI: bold for UI elements and arrow keys for sequence. (Ex. Click **File > New > Project**.)*-->

<!--**Screenshot**: *Screenshots really help users. But don’t include too many since they’re difficult to maintain. Highlight areas you are referring to in red.*-->

<!--**No. of steps**: *Make sure the number of steps within a procedure is 10 or fewer. Seven steps is ideal. Break up long procedure logically.*-->


<!--**Next steps**: *Reiterate what users have done, and give them interesting and useful next steps so they want to go on.*-->

## <a name="next-steps"></a>Дополнительная информация

- [Добавление в подсистему балансировки нагрузки IP-адреса для второй группы доступности](virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md#Add-IP).
