---
title: Подробное описание устранения неполадок SSH для виртуальной машины Azure | Документация Майкрософт
description: Подробные указания по устранению неполадок SSH-подключений к виртуальной машине Azure
keywords: в SSH-подключении отказано, ошибка SSH, Azure SSH, ошибка SSH-подключения
services: virtual-machines-linux
documentationcenter: ''
author: iainfoulds
manager: jeconnoc
editor: ''
tags: top-support-issue,azure-service-management,azure-resource-manager
ms.assetid: b8e8be5f-e8a6-489d-9922-9df8de32e839
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 12/13/2017
ms.author: iainfou
ms.openlocfilehash: 88f3ca3202359f9f45f5b9a5054ab95b40558520
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
ms.locfileid: "34365497"
---
# <a name="detailed-ssh-troubleshooting-steps-for-issues-connecting-to-a-linux-vm-in-azure"></a>Подробные инструкции по устранению неполадок SSH-подключений к виртуальной машине Linux в Azure
Клиенту SSH не всегда удается получить доступ к SSH-службе на виртуальной машине по многим причинам. Если вы использовали более [общие действия по устранению неполадок SSH](troubleshoot-ssh-connection.md), то необходимы более конкретные действия для устранения проблемы подключения. В этой статье подробно изложено, как определить, где происходит сбой подключения SSH и как его устранить.

## <a name="take-preliminary-steps"></a>Выполнение предварительных действий
На следующей схеме показаны задействованные при этом компоненты.

![Схема компонентов службы SSH](./media/detailed-troubleshoot-ssh-connection/ssh-tshoot1.png)

Приведенные ниже шаги помогут вам выявить источник сбоя и определить способы его устранения или обхода.

1. Проверьте состояние виртуальной машины на портале.
   На [портале Azure](https://portal.azure.com) выберите **Виртуальные машины** > *Имя виртуальной машины*.

   Панель состояния виртуальной машины должна отображать состояние **Выполняется**. Прокрутите страницу вниз для просмотра последних действий в ресурсах вычислений, хранения и сетевых ресурсах.

2. Выберите **Параметры**, чтобы проверить конечные точки, IP-адреса, группы безопасности и другие параметры.

   Виртуальная машина должна иметь конечную точку, определенную для SSH-трафика, которую можно просмотреть в разделе **Конечные точки** или **[Группа безопасности сети](../../virtual-network/security-overview.md)**. Конечные точки в виртуальных машинах, созданных с помощью Resource Manager, сохраняются в группе безопасности сети. Убедитесь, что к группе безопасности сети применены правила и что в подсети присутствует ссылка на них.

Чтобы проверить сетевое подключение, проверьте настроенные конечные точки и определите, можно ли подключиться к виртуальной машине с помощью другого протокола, например HTTP, или другой службы.

Выполнив эти действия, попытайтесь создать SSH-подключение еще раз.

## <a name="find-the-source-of-the-issue"></a>Поиск источника проблемы
Неспособность клиента SSH подключиться к службе SSH на виртуальной машине Azure может быть связана с проблемами и неправильными настройками в областях, перечисленных ниже:

* [Клиентский компьютер SSH.](#source-1-ssh-client-computer)
* [Пограничное устройство организации.](#source-2-organization-edge-device)
* [Конечная точка облачной службы и список управления доступом (ACL)](#source-3-cloud-service-endpoint-and-acl)
* [Группы безопасности сети](#source-4-network-security-groups)
* [Виртуальная машина Azure под управлением Linux](#source-5-linux-based-azure-virtual-machine)

## <a name="source-1-ssh-client-computer"></a>Источник 1: клиентский компьютер SSH
Чтобы исключить компьютер из числа возможных источников ошибок, убедитесь, что с его помощью можно установить SSH-подключения к другому локальному компьютеру под управлением Linux.

![Схема, на которой выделены компоненты клиентского компьютера SSH](./media/detailed-troubleshoot-ssh-connection/ssh-tshoot2.png)

В случае сбоя подключения проверьте, нет ли на компьютере:

* настройки локального брандмауэра, блокирующей входящий и исходящий SSH-трафик (TCP 22);
* локального программного обеспечения с функциями прокси клиента, которое не позволяет установить SSH-подключение;
* локального программного обеспечения для мониторинга сети, которое не позволяет установить SSH-подключение;
* других программ для обеспечения безопасности, которые ведут мониторинг трафика либо разрешают и запрещают трафик определенных типов.

Если одно из этих условий совпадает, временно отключите программное обеспечение и попробуйте установить SSH-подключение к локальному компьютеру, чтобы узнать причину блокировки подключения на вашем компьютере. Затем при поддержке администратора сети измените параметры программного обеспечения таким образом, чтобы оно не блокировало SSH-подключение.

Если вы используете проверку подлинности на основе сертификата, убедитесь, что у вас есть следующие разрешения для папки SSH в домашнем каталоге:

* Chmod 700 ~/.ssh;
* Chmod 644 ~/.ssh/\*.pub
* Chmod 600 ~/.ssh/id_rsa (или другие файлы, в которых хранятся ваши закрытые ключи);
* Chmod 644 ~/.ssh/known_hosts (содержит узлы, к которым установлено подключение по SSH-протоколу).

## <a name="source-2-organization-edge-device"></a>Источник 2: пограничное устройство организации
Чтобы исключить пограничное устройство организации из числа возможных источников ошибок, убедитесь, что компьютер, непосредственно подключенный к Интернету, может устанавливать SSH-подключения с виртуальной машиной Azure. Если вы получаете доступ к виртуальной машине через VPN-подключение типа "сеть — сеть" или подключение Azure ExpressRoute, перейдите к подразделу [Источник 4: группы безопасности сети](#nsg).

![Схема, на которой выделено пограничное устройство организации](./media/detailed-troubleshoot-ssh-connection/ssh-tshoot3.png)

Если у вас нет компьютера, непосредственно подключенного к Интернету, создайте виртуальную машину Azure, размещенную в собственной группе ресурсов или облачной службе, и используйте ее. Дополнительные сведения см. в статье [Создание виртуальной машины Linux с помощью интерфейса командной строки Azure 2.0](quick-create-cli.md). Завершив проверку, удалите группу ресурсов или виртуальную машину и облачную службу.

Если вам удается установить SSH-подключение с компьютера, непосредственно подключенного к Интернету, убедитесь, что на пограничном устройстве вашей организации отсутствуют следующие компоненты:

* внутренний брандмауэр, который блокирует SSH-трафик в Интернете;
* прокси-сервер, который не позволяет устанавливать SSH-подключения;
* программное обеспечение для обнаружения атак и мониторинга сети, которое работает на устройствах в вашей сети периметра и блокирует SSH-подключения.

При поддержке администратора сети измените параметры пограничного устройства организации таким образом, чтобы оно не блокировало SSH-трафик через Интернет.

## <a name="source-3-cloud-service-endpoint-and-acl"></a>Источник 3: конечная точка облачной службы и список управления доступом (ACL)
> [!NOTE]
> Этот источник применяется только к виртуальным машинам, созданным с помощью классической модели развертывания. Для виртуальных машин, созданных с помощью Resource Manager, перейдите к подразделу [Источник 4: группы безопасности сети](#nsg).

Чтобы исключить конечную точку облачной службы и список управления доступом из числа возможных источников ошибок, убедитесь, что другая виртуальная машина Azure в той же виртуальной сети может подключаться с помощью SSH.

![Диаграмма, на которой выделены конечная точка облачной службы и ACL](./media/detailed-troubleshoot-ssh-connection/ssh-tshoot4.png)

Если у вас нет еще одной виртуальной машины в той же виртуальной сети, вы можете легко ее создать. Дополнительные сведения см. в статье [Создание виртуальной машины Linux с помощью интерфейса командной строки Azure 2.0](quick-create-cli.md). Завершив проверку, удалите дополнительную виртуальную машину.

Если вы создаете подключение SSH к виртуальной машине в той же виртуальной сети, проверьте следующие области.

* **Конфигурация конечной точки для SSH-трафика на целевой виртуальной машине.** Частный TCP-порт на конечной точке должен совпадать с TCP-портом, который прослушивает SSH-служба на виртуальной машине. (Порт по умолчанию — 22.) Проверьте номер TCP-порта SSH. Для этого на портале Azure последовательно выберите **Виртуальные машины** > *Имя виртуальной машины* > **Параметры** > **Конечные точки**.
* **Список управления доступом на конечной точке для SSH-трафика на целевой виртуальной машине.** С помощью него можно разрешать и запрещать входящий трафик из Интернета в зависимости от IP-адреса источника. Если список управления доступом неправильно настроен, входящий SSH-трафик на эту конечную точку может блокироваться. Проверьте свои списки управления доступом и убедитесь в том, что входящий трафик с общедоступных IP-адресов вашего прокси-сервера или другого пограничного сервера разрешен. Дополнительные сведения см. в статье [Список управления доступом (ACL) конечной точки](../../virtual-network/virtual-networks-acl.md).

Чтобы исключить конечную точку из числа возможных источников проблем, удалите ее и создайте другую конечную точку, указав имя SSH (номер для общего и частного TCP-порта — 22). Дополнительные сведения см. в статье [Настройка конечных точек в классической виртуальной машине Windows в Azure](../windows/classic/setup-endpoints.md?toc=%2fazure%2fvirtual-machines%2fwindows%2fclassic%2ftoc.json).

<a id="nsg"></a>

## <a name="source-4-network-security-groups"></a>Источник 4: группы безопасности сети
Группы безопасности сети позволяют точнее настраивать параметры разрешенного входящего и исходящего трафика. Можно создавать правила, которые распространяются на подсети и облачные службы в виртуальной сети Azure. Проверьте свои правила групп безопасности сети и убедитесь, что входящий и исходящий SSH-трафик разрешен.
Дополнительные сведения см. в статье [Группа безопасности сети](../../virtual-network/security-overview.md).

Для проверки конфигурации NSG можно также использовать функцию проверки IP-адреса. Дополнительные сведения см. в статье [Обзор мониторинга сети Azure](https://docs.microsoft.com/azure/network-watcher/network-watcher-monitoring-overview). 

## <a name="source-5-linux-based-azure-virtual-machine"></a>Источник 5: виртуальная машина Azure в службе Azure
Последним потенциальным источником проблем является сама виртуальная машина Azure.

![Диаграмма, на которой выделена виртуальная машина Azure под управлением Linux](./media/detailed-troubleshoot-ssh-connection/ssh-tshoot5.png)

Выполните указания по [сбросу пароля на виртуальных машинах Linux](reset-password.md) (если вы еще этого не сделали).

Попытайтесь снова установить подключение со своего компьютера. Если вам по-прежнему не удается подключиться, проверьте, не соответствует ли ваша среда одному из следующих условий:

* На целевой виртуальной машине не запущена SSH-служба.
* SSH-служба не прослушивает TCP-порт 22. Чтобы проверить это, установите клиент telnet на локальном компьютере и выполните команду telnet *cloudServiceName*.cloudapp.net 22. Эта команда позволит определить, разрешает ли виртуальная машина входящий и исходящий обмен данными с конечной точкой SSH.
* Правила локального брандмауэра на целевой виртуальной машине блокируют входящий и исходящий SSH-трафик.
* Программное обеспечение для обнаружения атак и мониторинга сети на виртуальной машине Azure блокирует SSH-подключения.

## <a name="additional-resources"></a>Дополнительные ресурсы
Дополнительные сведения об устранении неполадок с доступом к приложению см. в статье [Устранение проблем с подключением к приложениям на виртуальных машинах Linux в Azure](troubleshoot-app-connection.md).
