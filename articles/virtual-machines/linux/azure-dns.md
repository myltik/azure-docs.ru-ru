---
title: Параметры разрешения DNS-имен для виртуальных машин Linux в Azure
description: Сценарии разрешения имен для виртуальных машин Linux в Azure IaaS, включая предоставленные службы DNS, гибридные внешние DNS и использование собственного DNS-сервера.
services: virtual-machines
documentationcenter: na
author: RicksterCDN
manager: jeconnoc
editor: tysonn
ms.assetid: 787a1e04-cebf-4122-a1b4-1fcf0a2bbf5f
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/19/2016
ms.author: rclaus
ms.openlocfilehash: d899e037a144892d6d2c843fec08d63a9e3e514a
ms.sourcegitcommit: 6fcd9e220b9cd4cb2d4365de0299bf48fbb18c17
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2018
ms.locfileid: "30836101"
---
# <a name="dns-name-resolution-options-for-linux-virtual-machines-in-azure"></a>Параметры разрешения DNS-имен для виртуальных машин Linux в Azure
Azure по умолчанию предоставляет разрешение DNS-имен для всех виртуальных машин, находящихся в одной виртуальной сети. Вы можете реализовать собственный механизм разрешения DNS-имен, настроив собственные службы DNS в виртуальных машинах, размещенных в Azure. Ниже приведены сценарии, которые помогут вам выбрать наиболее подходящий вариант для конкретной ситуации.

* [Разрешение имен, предоставляемое Azure](#azure-provided-name-resolution)
* [разрешение имен с помощью собственного DNS-сервера.](#name-resolution-using-your-own-dns-server)

Тип разрешения имен зависит от способа взаимодействия виртуальных машин и экземпляров ролей друг с другом.

В приведенной ниже таблице представлены сценарии и соответствующие решения для разрешения имен.

| **Сценарий** | **Решение** | **Суффикс** |
| --- | --- | --- |
| Разрешение имен между экземплярами ролей или виртуальными машинами, находящимися в одной виртуальной сети |[Разрешение имен, предоставляемое Azure](#azure-provided-name-resolution) |Имя узла или полное доменное имя |
| Разрешение имен между экземплярами ролей или виртуальными машинами, находящимися в разных виртуальных сетях |Управляемые клиентами DNS-серверы, перенаправляющие запросы между виртуальными сетями для разрешения в Azure (DNS-прокси). См. раздел [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server). |только полное доменное имя |
| Разрешение имен локальных компьютеров и служб из экземпляров роли или виртуальных машин в Azure |Управляемые клиентами DNS-серверы (например, локальный контроллер домена, локальный контроллер домена только для чтения или DNS-сервер, вторично синхронизированный с помощью передач зоны). См. раздел [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server). |только полное доменное имя |
| Разрешение имен узлов Azure с локальных компьютеров |Перенаправление запросов на управляемый клиентом прокси-сервер DNS в соответствующей виртуальной сети. Прокси-сервер перенаправляет запросы в Azure для разрешения. См. раздел [Разрешение имен с помощью собственного DNS-сервера](#name-resolution-using-your-own-dns-server). |только полное доменное имя |
| Обратный поиск DNS для внутренних IP-адресов |[разрешение имен с помощью собственного DNS-сервера.](#name-resolution-using-your-own-dns-server) |Недоступно |

## <a name="name-resolution-that-azure-provides"></a>Разрешение имен, предоставляемое Azure
Вместе с разрешением общедоступных DNS-имен Azure предоставляет разрешение внутренних имен для виртуальных машин и экземпляров ролей, которые находятся в той же виртуальной сети. В виртуальных сетях на основе Azure Resource Manager DNS-суффикс является одинаковым для всей виртуальной сети; полное доменное имя не требуется. DNS-имена можно назначать как сетевым картам, так и виртуальным машинам. Несмотря на то, что разрешение имен Azure не требует настройки, это не лучший выбор для всех сценариев развертывания, как показано в таблице выше.

### <a name="features-and-considerations"></a>Функции и рекомендации
**Функции**

* Для использования разрешения имен, предоставляемого Azure, дополнительные настройки не нужны.
* Служба разрешения имен, предоставляемая Azure, отличается высокой доступностью. Вам не нужно создавать кластеры DNS-серверов и управлять ими.
* Служба разрешения имен, предоставляемая Azure, может использоваться параллельно с DNS-серверами для разрешения имен узлов в локальной среде и Azure.
* Разрешение имен предоставляется между виртуальными машинами в виртуальных сетях без необходимости указывать полное доменное имя.
* Вместо использования автоматически создаваемых имен узлов вы можете создавать имена, которые наиболее точно описывают ваши развертывания.

**Рекомендации**

* Созданный Azure DNS-суффикс нельзя изменить.
* Собственные записи нельзя регистрировать вручную.
* WINS и NetBIOS не поддерживаются.
* Имена узлов должны быть DNS-совместимыми.
    Они могут содержать только символы 0–9, a–z и "-" и не могут начинаться или заканчиваться на "-". См. раздел 2 RFC 3696.
* Трафик запросов DNS регулируется для каждой виртуальной машины. Регулирование не должно влиять на большинство приложений.  Если наблюдается регулирование запросов, проверьте, включено ли кэширование на стороне клиента.  Дополнительные сведения см. в разделе [Наиболее эффективное использование разрешения имен Azure](#getting-the-most-from-name-resolution-that-azure-provides).

### <a name="getting-the-most-from-name-resolution-that-azure-provides"></a>Наиболее эффективное использование разрешения имен Azure
**Кэширование на стороне клиента**

Не каждый запрос DNS отправляется по сети. Кэширование на стороне клиента помогает уменьшить задержку и повысить устойчивость к нестабильной работе сети, разрешая повторяющиеся запросы DNS из локального кэша. Записи DNS содержат сведения о сроке жизни (TTL). Это позволяет кэшу хранить записи максимально долго, не влияя на их актуальность. Следовательно, кэширование на стороне клиента подходит для большинства ситуаций.

В некоторых дистрибутивах Linux возможность кэширования не включена по умолчанию. Мы рекомендуем добавить кэш в каждую виртуальную машину Linux, но сперва нужно убедиться в отсутствии локального кэша.

Существует несколько разных пакетов кэширования DNS, например dnsmasq. Ниже описаны шаги по установке пакета dnsmasq на наиболее распространенные версии ОС.

**Ubuntu (используется пакет resolvconf)**
  * Установите пакет dnsmasq ("sudo apt-get install dnsmasq").

**SUSE (используется пакет netconf)**:
1. Установите пакет dnsmasq ("sudo zypper install dnsmasq").
2. Активируйте службу dnsmasq ("systemctl enable dnsmasq.service").
3. Запустите службу dnsmasq ("systemctl start dnsmasq.service").
4. Измените путь /etc/sysconfig/network/config и замените блок NETCONFIG_DNS_FORWARDER="" текстом dnsmasq.
5. Укажите в файле resolv.conf ("netconfig update") кэш в качестве локального сопоставителя DNS.

**CentOS от Rogue Wave Software (прежнее название — OpenLogic; использует NetworkManager)**
1. Установите пакет dnsmasq ("sudo yum install dnsmasq").
2. Активируйте службу dnsmasq ("systemctl enable dnsmasq.service").
3. Запустите службу dnsmasq ("systemctl start dnsmasq.service").
4. Добавьте строку "prepend domain-name-servers 127.0.0.1;" в файл /etc/dhclient-eth0.conf.
5. Перезапустите сетевую службу ("service network restart"), чтобы указать кэш в качестве локального сопоставителя DNS.

> [!NOTE]
> Пакет dnsmasq — один из многих доступных пакетов кэша DNS для ОС Linux. Перед его использованием проверьте, соответствует ли он вашим потребностям, а также не установлен ли у вас другой кэш.
>
>

**Повторные попытки на стороне клиента**

DNS использует преимущественно протокол UDP. Так как протокол UDP не гарантирует доставку сообщений, логика повторных попыток обрабатывается в самом протоколе DNS. Каждый DNS-клиент (ОС) может реализовывать разную логику повторных попыток в зависимости от предпочтений создателя.

* ОС Windows выполняет повторную попытку через одну секунду, затем через две и четыре, а затем снова через четыре секунды.
* Повторные попытки в ОС Linux по умолчанию выполняются через пять секунд.  Рекомендуется изменить этот параметр, чтобы повторные попытки выполнялись пять раз с интервалом в одну секунду.  

Чтобы проверить текущие параметры в виртуальной машине Linux, введите команду "cat /etc/resolv.conf" и просмотрите строку options. Пример:

    options timeout:1 attempts:5

Файл resolv.conf создается автоматически; его не следует изменять. Шаги по добавлению строки options отличаются в разных дистрибутивах.

**Ubuntu** (используется пакет resolvconf)
1. Добавьте строку options в "/etc/resolveconf/resolv.conf.d/head".
2. Выполните команду "resolvconf -u" для обновления.

**SUSE** (используется пакет netconf)
1. Добавьте параметр "timeout:1 attempts:5" в блок NETCONFIG_DNS_RESOLVER_OPTIONS="" в /etc/sysconfig/network/config.
2. Выполните команду "netconfig update" для обновления.

**CentOS от Rogue Wave Software (прежнее название — OpenLogic**; использует NetworkManager)
1. Добавьте RES_OPTIONS="timeout:1 attempts:5" в файл /etc/sysconfig/network.
2. Выполните команду "service network restart" для обновления.

## <a name="name-resolution-using-your-own-dns-server"></a>разрешение имен с помощью собственного DNS-сервера.
Ваши требования к разрешению имен могут выйти за рамки возможностей Azure. Например, может требоваться разрешение DNS-имен между виртуальными сетями. В таких случаях можно использовать собственные DNS-серверы.  

DNS-серверы в виртуальной сети могут перенаправлять запросы DNS рекурсивным сопоставителям Azure для разрешения имен узлов в этой виртуальной сети. Например, DNS-сервер, запущенный в Azure, может отвечать на запросы своих файлов зоны DNS и перенаправлять все остальные запросы в Azure. Это позволяет виртуальным машинам видеть как ваши записи в файлах зоны, так и имена узлов, предоставленные Azure (с помощью сервера пересылки). Доступ к рекурсивным сопоставителям Azure предоставляется через виртуальный IP-адрес 168.63.129.16.

Перенаправление запросов DNS также позволяет выполнять разрешение DNS между виртуальными сетями и дает вашим локальным компьютерам разрешать имена узлов, предоставляемые Azure. Чтобы разрешить имя узла виртуальной машины, виртуальная машина DNS-сервера должна находиться в той же виртуальной сети и быть настроена для перенаправления запросов имен узлов в Azure. Так как DNS-суффиксы в разных виртуальных сетях различаются, можно использовать правила условного перенаправления для отправки запросов DNS в правильную виртуальную сеть для разрешения. На приведенном ниже рисунке показаны две виртуальные сети и локальная сеть, выполняющая разрешение DNS между виртуальными сетями с помощью этого метода.

![Разрешение DNS между виртуальными сетями](./media/azure-dns/inter-vnet-dns.png)

При использовании разрешения имен Azure внутренний DNS-суффикс передается в каждую виртуальную машину с помощью DHCP. При использовании собственного решения для разрешения имен этот суффикс не передается в виртуальные машины, так как влияет на другие архитектуры DNS. Для ссылки на компьютеры по полному доменному имени или для настройки суффикса в виртуальных машинах можно определить суффикс с помощью PowerShell или API.

* Для управляемых виртуальных сетей в модели Azure Resource Manager суффикс можно узнать с помощью ресурса [сетевой карты](https://msdn.microsoft.com/library/azure/mt163668.aspx). Можно также выполнить команду `azure network public-ip show <resource group> <pip name>`, которая покажет ваш общедоступный IP-адрес, включая полное доменное имя сетевой карты.

Если перенаправление запросов в Azure не соответствует вашим требованиям, необходимо предоставить собственное решение DNS.  Ваше решение DNS должно:

* Предоставлять корректное разрешение имен, например, с помощью [DDNS](../../virtual-network/virtual-networks-name-resolution-ddns.md). При использовании DDNS может потребоваться отключить очистку записей DNS. Время аренды DHCP в Azure очень долгое, и очистка может удалить записи DNS преждевременно.
* Предоставлять корректное рекурсивное разрешение для разрешения внешних доменных имен.
* Быть доступным (по протоколам TCP и UDP через порт 53) для клиентов, которых оно обслуживает, и иметь доступ к Интернету.
* Быть защищенным от доступа из Интернета для снижения угроз, исходящих от внешних агентов.

> [!NOTE]
> Если в качестве DNS-серверов используются виртуальные машины Azure, для оптимальной производительности следует отключить IPv6 и назначить [общедоступный IP-адрес уровня экземпляра](../../virtual-network/virtual-networks-instance-level-public-ip.md) каждой виртуальной машине, выполняющей роль DNS-сервера.  
>
>
