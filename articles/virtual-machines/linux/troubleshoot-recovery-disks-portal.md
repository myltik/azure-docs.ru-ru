---
title: Использование виртуальной машины Linux для устранения неполадок с помощью портала Azure | Документация Майкрософт
description: Узнайте, как устранять неполадки с виртуальными машинами Linux, подключив диск операционной системы к виртуальной машине восстановления с помощью портала Azure.
services: virtual-machines-linux
documentationCenter: ''
authors: iainfoulds
manager: jeconnoc
editor: ''
ms.service: virtual-machines-linux
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-linux
ms.workload: infrastructure
ms.date: 11/14/2016
ms.author: iainfou
ms.openlocfilehash: 89c4c5c986375177918f14417c6b5a9a24925908
ms.sourcegitcommit: 96089449d17548263691d40e4f1e8f9557561197
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/17/2018
ms.locfileid: "34271748"
---
# <a name="troubleshoot-a-linux-vm-by-attaching-the-os-disk-to-a-recovery-vm-using-the-azure-portal"></a>Устранение неполадок с виртуальной машиной Linux при присоединении диска операционной системы к виртуальной машине восстановления с помощью портала Azure
Если возникает проблема с загрузкой или диском на виртуальной машине Linux, возможно, вам нужно устранить неполадки, связанные с самим виртуальным жестким диском. Например, такая ситуация возникает из-за неправильной записи в `/etc/fstab`, которая мешает успешно загрузить виртуальную машину. В этой статье подробно описано, как с помощью портала Azure подключить виртуальный жесткий диск к другой виртуальной машине Linux для устранения ошибок, а затем восстановить исходную виртуальную машину.

## <a name="recovery-process-overview"></a>Обзор процесса восстановления
Процесс устранения неполадок выглядит следующим образом.

1. Удалите виртуальную машину, на которой возникли проблемы, сохранив ее виртуальные жесткие диски.
2. Присоедините и подключите виртуальный жесткий диск к другой виртуальной машине Linux для устранения неполадок.
3. Подключитесь к этой виртуальной машине. Измените файлы или запустите средства, которые нужны для устранения неполадок на исходном виртуальном жестком диске.
4. Отключите и отсоедините виртуальный жесткий диск от виртуальной машины, на которой выполняется устранение неполадок.
5. Создайте другую виртуальную машину, используя исходный виртуальный жесткий диск.

Сведения о виртуальной машине, используемой управляемый диск, см. в разделе [Устранение неполадок виртуальной машины с управляемым диском путем подключения нового диска операционной системы](#troubleshoot-a-managed-disk-vm-by-attaching-a-new-os-disk).

## <a name="determine-boot-issues"></a>Выявление проблем при загрузке
Изучите диагностические сведения о загрузке и снимки экранов виртуальной машины, чтобы определить, почему виртуальная машина не может правильно загрузиться. Например, причиной может быть неправильная запись в `/etc/fstab`, удаление или перемещение базового виртуального жесткого диска.

Выберите на портале эту виртуальную машину и прокрутите экран вниз до раздела **Поддержка и устранение неполадок**. Щелкните **Диагностика загрузки**, чтобы просмотреть сообщения консоли, транслируемые с виртуальной машины. Изучите журналы консоли и постарайтесь определить, что вызывает проблему на виртуальной машине. В следующем примере мы видим, что виртуальная машина не может выйти из режима обслуживания и требует вмешательства оператора.

![Просмотр журналов консоли для диагностики загрузки виртуальной машины](./media/troubleshoot-recovery-disks-portal/boot-diagnostics-error.png)

Можно также щелкнуть **Снимок экрана** в верхней части журнала диагностики загрузки, чтобы загрузить снимок экрана виртуальной машины.


## <a name="view-existing-virtual-hard-disk-details"></a>Просмотр сведений для существующего виртуального жесткого диска
Прежде чем присоединить виртуальный жесткий диск к другой виртуальной машине, следует определить имя этого виртуального жесткого диска. 

Выберите на портале группу ресурсов и учетную запись хранения. Щелкните **Большие двоичные объекты**, как показано в следующем примере.

![Выбор больших двоичных объектов для хранения](./media/troubleshoot-recovery-disks-portal/storage-account-overview.png)

Обычно виртуальные жесткие диски хранятся в отдельном контейнере с именем **vhds**. Выберите этот контейнер, чтобы просмотреть список виртуальных жестких дисков. Запишите имя нужного виртуального жесткого диска (обычно используется префикс, совпадающий с именем виртуальной машины).

![Поиск виртуального жесткого диска в контейнере хранилища](./media/troubleshoot-recovery-disks-portal/storage-container.png)

Выберите из списка существующий виртуальный жесткий диск и скопируйте его URL-адрес для использования на следующих этапах.

![Копирование URL-адреса существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/copy-vhd-url.png)


## <a name="delete-existing-vm"></a>Удаление существующей виртуальной машины
Виртуальные жесткие диски и виртуальные машины — это разные ресурсы в Azure. Виртуальный жесткий диск является местом хранения операционной системы, приложений и конфигурации. Виртуальная машина — это просто метаданные, которые определяют размер или расположение объекта, а также ссылки на ресурсы, такие как виртуальные жесткие диски или виртуальные сетевые адаптеры. При присоединении виртуального жесткого диска к виртуальной машине для него регистрируется аренда. Диски данных можно присоединять и отсоединять во время работы виртуальной машины, но диск операционной системы отсоединить невозможно, пока ресурс виртуальной машины не будет удален. Аренда сохраняет привязку диска операционной системы к виртуальной машине, даже когда эта виртуальная машина остановлена или отменено ее распределение.

Поэтому для восстановления виртуальной машины нужно прежде всего удалить ресурс виртуальной машины. Удаление виртуальной машины не повлияет на виртуальные жесткие диски, размещенные в учетной записи хранения. После удаления виртуальной машины присоедините виртуальный жесткий диск к другой виртуальной машине, чтобы устранить неполадки.

Выберите на портале нужную виртуальную машину и щелкните **Удалить**.

![Снимок экрана диагностики загрузки виртуальной машины с сообщением об ошибке загрузки](./media/troubleshoot-recovery-disks-portal/stop-delete-vm.png)

Дождитесь, пока удаление завершится, прежде чем присоединять виртуальный жесткий диск к другой виртуальной машине. Чтобы присоединить виртуальный жесткий диск к другой виртуальной машине, необходимо снять аренду, которая привязывает диск к виртуальной машине.


## <a name="attach-existing-virtual-hard-disk-to-another-vm"></a>Присоединение существующего виртуального жесткого диска к другой виртуальной машине
В следующих нескольких шагах описывается использование другой виртуальной машины для устранения неполадок. Присоедините существующий виртуальный жесткий диск к виртуальной машине для устранения неполадок, чтобы можно было просматривать и изменять содержимое диска. Этот процесс позволяет, например, исправить ошибки конфигурации или изучить дополнительные журналы протоколов или системы. Выберите или создайте другую виртуальную машину, которая будет использоваться для устранения неполадок.

1. Выберите на портале группу ресурсов и виртуальную машину для устранения неполадок. Выберите **Диски** и нажмите кнопку **Подключить существующий**.

    ![Присоединение существующего диска на портале](./media/troubleshoot-recovery-disks-portal/attach-existing-disk.png)

2. Чтобы выбрать существующий виртуальный жесткий диск, щелкните его **VHD-файл**.

    ![Поиск существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/select-vhd-location.png)

3. Выберите учетную запись хранения и контейнер, затем щелкните существующий виртуальный жесткий диск. Нажмите кнопку **Выбрать**, чтобы подтвердить выбор.

    ![Выбор существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/select-vhd.png)

4. Выбрав существующий виртуальный жесткий диск, щелкните **ОК**, чтобы присоединить его.

    ![Подтверждение присоединения существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/attach-disk-confirm.png)

5. Через несколько секунд на панели **Диски** для виртуальной машины отобразится подключение существующего виртуального жесткого диска в качестве диска данных.

    ![Существующий виртуальный жесткий диск присоединен как диск данных](./media/troubleshoot-recovery-disks-portal/attached-disk.png)


## <a name="mount-the-attached-data-disk"></a>Подключение присоединенного диска данных

> [!NOTE]
> В следующих примерах описана процедура для виртуальной машины Ubuntu. Если вы используете другой дистрибутив Linux, например Red Hat Enterprise Linux или SUSE, команды `mount` и расположение файлов журнала могут немного отличаться. Используйте документацию к своему дистрибутиву, чтобы скорректировать команды соответствующим образом.

1. Подключитесь к виртуальной машине для устранения неполадок по протоколу SSH, используя соответствующие учетные данные. Если присоединенный вами диск является первым диском данных на этой виртуальной машине, он скорее всего подключен к `/dev/sdc`. Запустите команду `dmseg`, чтобы получить список присоединенных дисков.

    ```bash
    dmesg | grep SCSI
    ```
    Вы должны увидеть результат, аналогичный приведенному ниже.

    ```bash
    [    0.294784] SCSI subsystem initialized
    [    0.573458] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 252)
    [    7.110271] sd 2:0:0:0: [sda] Attached SCSI disk
    [    8.079653] sd 3:0:1:0: [sdb] Attached SCSI disk
    [ 1828.162306] sd 5:0:0:0: [sdc] Attached SCSI disk
    ```

    В предыдущем примере диск операционной системы расположен в `/dev/sda`, а временный диск, предоставляемый для каждой виртуальной машины, расположен в `/dev/sdb`. Если у вас несколько дисков данных, они будут присоединены как `/dev/sdd`, `/dev/sde` и т. д.

2. Создайте каталог для подключения существующего виртуального жесткого диска. Следующая команда создает каталог с именем `troubleshootingdisk`.

    ```bash
    sudo mkdir /mnt/troubleshootingdisk
    ```

3. Если на существующем виртуальном жестком диске есть несколько разделов, подключите нужный. Следующая команда подключает первый основной разделу к каталогу `/dev/sdc1`.

    ```bash
    sudo mount /dev/sdc1 /mnt/troubleshootingdisk
    ```

    > [!NOTE]
    > Мы рекомендуем подключать диски данных к виртуальным машинам Azure с использованием глобального уникального идентификатора (UUID) виртуального жесткого диска. Для нашего упрощенного примера по устранению неполадок можно и не использовать UUID для подключения диска. Но в обычной ситуации, если вы измените `/etc/fstab` так, чтобы виртуальные жесткие диски подключались по имени устройства вместо UUID, у виртуальной машины могут быть проблемы с загрузкой.


## <a name="fix-issues-on-original-virtual-hard-disk"></a>Устранение неполадок на исходном виртуальном жестком диске
Теперь, когда существующий виртуальный жесткий диск подключен, вы можете выполнить любые необходимые действия по обслуживанию и (или) устранению неполадок. После устранения проблем выполните следующие действия.

## <a name="unmount-and-detach-original-virtual-hard-disk"></a>Отключение и отсоединение исходного виртуального жесткого диска
После устранения ошибок отсоедините существующий виртуальный жесткий диск от виртуальной машины, которую использовали для устранения неполадок. Виртуальный жесткий диск нельзя использовать с другой виртуальной машиной, пока вы не отмените аренду, присоединяющую виртуальный жесткий диск к виртуальной машине для устранения неполадок.

1. Используя открытый сеанс подключения по SSH к виртуальной машине для устранения неполадок, отключите существующий виртуальный жесткий диск. Прежде всего выйдите из каталога, в котором создана точка подключения.

    ```bash
    cd /
    ```

    Теперь отключите существующий виртуальный жесткий диск. В следующем примере диск отключается от каталога `/dev/sdc1`:

    ```bash
    sudo umount /dev/sdc1
    ```

2. Теперь отсоедините виртуальный жесткий диск от виртуальной машины. Выберите на портале нужную виртуальную машину и щелкните **Диски**. Выберите существующий виртуальный жесткий диск и щелкните **Отсоединить**.

    ![Отсоединение существующего виртуального жесткого диска](./media/troubleshoot-recovery-disks-portal/detach-disk.png)

    Подождите, пока виртуальная машина успешно отсоединит диск данных, прежде чем продолжать процесс.

## <a name="create-vm-from-original-hard-disk"></a>Создание виртуальной машины из исходного жесткого диска
Чтобы создать виртуальную машину из исходного виртуального жесткого диска, используйте [этот шаблон Azure Resource Manager](https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-specialized-vhd-existing-vnet). Этот шаблон развертывает виртуальную машину в существующую виртуальную сеть, используя URL-адрес виртуального жесткого диска из использованной выше команды. Нажмите кнопку **Развернуть в Azure**.

![Развертывание виртуальной машины из шаблона GitHub](./media/troubleshoot-recovery-disks-portal/deploy-template-from-github.png)

Шаблон загружается на портал Azure для развертывания. Введите имя для новой виртуальной машины и укажите существующие ресурсы Azure, а затем вставьте URL-адрес исходного виртуального жесткого диска. Чтобы начать развертывание, щелкните **Приобрести**.

![Развертывание виртуальной машины на основе шаблона](./media/troubleshoot-recovery-disks-portal/deploy-from-image.png)


## <a name="re-enable-boot-diagnostics"></a>Восстановление диагностики загрузки
При создании виртуальной машины на основе существующего виртуального жесткого диска диагностика загрузки не всегда автоматически включена. Выберите эту виртуальную машину на портале, чтобы проверить состояние диагностики загрузки и включить ее, если потребуется. В разделе **Мониторинг** щелкните **Параметры диагностики**. Убедитесь, что выбрано состояние **Включено** и установлен флажок **Диагностика загрузки**. Если вы внесете здесь изменения, нажмите кнопку **Сохранить**.

![Обновление параметров диагностики загрузки](./media/troubleshoot-recovery-disks-portal/reenable-boot-diagnostics.png)

## <a name="troubleshoot-a-managed-disk-vm-by-attaching-a-new-os-disk"></a>Устранение неполадок виртуальной машины с управляемым диском путем подключения нового диска операционной системы
1. Остановите затронутую виртуальную машину Windows с управляемым диском.
2. [Создайте моментальный снимок управляемого диска](../windows/snapshot-copy-managed-disk.md) операционной системы виртуальной машины.
3. [Создайте управляемый диск на основе моментального снимка](../scripts/virtual-machines-windows-powershell-sample-create-managed-disk-from-snapshot.md).
4. [Подключите управляемый диск в качестве диска данных виртуальной машины](../windows/attach-disk-ps.md).
5. [Замените диск данных из шага 4 на диск операционной системы](../windows/os-disk-swap.md).

## <a name="next-steps"></a>Дополнительная информация
При возникновении проблем с подключением к виртуальной машине см. статью [Устранение неполадок с SSH-подключением к виртуальной машине Azure Linux: сбой, ошибка или отклонение](troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json). Для решения проблем с доступом к приложениям, выполняющимся на виртуальной машине, см. статью [Устранение проблем с подключением к приложениям на виртуальных машинах Linux в Azure](../windows/troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).

Дополнительные сведения об использовании Resource Manager вы найдете в статье [Общие сведения об Azure Resource Manager](../../azure-resource-manager/resource-group-overview.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
