---
title: "Запланированные события для виртуальных машин Linux в Azure | Документация Майкрософт"
description: "Запланированные события, использующие службу метаданных Azure, для виртуальных машин Linux."
services: virtual-machines-windows, virtual-machines-linux, cloud-services
documentationcenter: 
author: zivraf
manager: timlt
editor: 
tags: 
ms.assetid: 
ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/14/2017
ms.author: zivr
ms.openlocfilehash: 75e509a7e39f5b268ce550d0c4dea2261d4fe56f
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="azure-metadata-service-scheduled-events-preview-for-linux-vms"></a>Служба метаданных Azure. Запланированные события (предварительная версия) для виртуальных машин Linux

> [!NOTE] 
> Предварительные версии предоставляются при условии, что вы соглашаетесь с условиями использования. Дополнительные сведения см. в статье [Дополнительные условия использования предварительных выпусков Microsoft Azure](https://azure.microsoft.com/support/legal/preview-supplemental-terms/).
>

"Запланированные события" — одна из вспомогательных служб службы метаданных Azure. Она предоставляет сведения о предстоящих событиях (например, перезагрузках), что позволяет приложениям подготовиться к ним и уменьшить влияние на работу. Эти сведения доступны для всех типов виртуальных машин Azure, включая PaaS и IaaS. Благодаря запланированным событиям виртуальная машина получает возможность выполнить упреждающие действия, чтобы свести влияние события к минимуму. 

Запланированные события доступны для виртуальных машин Windows и Linux. Сведения о запланированных событиях, назначенные в Windows, см. в статье [Служба метаданных Azure. Запланированные события (предварительная версия) для виртуальных машин Windows](../windows/scheduled-events.md).

## <a name="why-scheduled-events"></a>Зачем нужны запланированные события

Благодаря запланированным событиям вы можете принять меры по ограничению воздействия на службу обслуживания, инициируемого платформой, и действий, инициируемых пользователем. 

Рабочие нагрузки с несколькими экземплярами, которые используют методы репликации для поддержания состояния, чувствительны к простоям на нескольких экземплярах. Такие простои могут потребовать дорогостоящих действий (например, перестроения индексов) или привести к потере реплики. 

Во многих других случаях общая доступность службы может быть повышена, например путем выполнения последовательности нормального завершения работы, такой как завершение (или отмена) незавершенных транзакций, переназначение задач другим виртуальным машинам в кластере (отработка отказа вручную) или удаление виртуальной машины из пула подсистемы балансировки сетевой нагрузки. 

Иногда простое уведомление администратора о предстоящих событиях или занесение такого события в журнал позволяет повысить удобство обслуживания приложений, размещенных в облаке.

Служба метаданных Azure сообщает о запланированных событиях в следующих случаях.
-   Инициируемое платформой обслуживание (например, развертывание ОС узла).
-   Инициируемые пользователем вызовы (например, пользователь перезапускает или повторно развертывает виртуальную машину).


## <a name="the-basics"></a>Основные сведения  

Служба метаданных Azure предоставляет сведения о работающих виртуальных машинах через конечную точку REST, доступную из виртуальной машины. Эта информация предоставляется через немаршрутизируемый IP-адрес, то есть она недоступна вне виртуальной машины.

### <a name="scope"></a>Область
Запланированные события отображаются на всех виртуальных машинах в облачной службе или на всех виртуальных машинах в группе доступности. Поэтому важно проверять поле `Resources` в событии, чтобы определить, на какие виртуальные машины повлияет конкретное событие. 

### <a name="discovering-the-endpoint"></a>Обнаружение конечной точки
Если виртуальная машина создана в виртуальной сети, служба метаданных доступна по статическому немаршрутизируемому IP-адресу `169.254.169.254`.
Если виртуальная машина не создается в виртуальной сети, что является стандартным сценарием для облачных служб и классических виртуальных машин, для обнаружения используемой конечной точки требуется дополнительная логика. Просмотрите этот пример, чтобы узнать как выполнить [обнаружение конечной точки узла](https://github.com/azure-samples/virtual-machines-python-scheduled-events-discover-endpoint-for-non-vnet-vm).

### <a name="versioning"></a>Управление версиями 
Для службы метаданных экземпляров включено управление версиями. Версии являются обязательными. На данный момент используется версия от `2017-03-01`.

> [!NOTE] 
> В предыдущих выпусках предварительной версии в качестве api-version поддерживалось значение {latest}. Этот формат больше не поддерживается и в дальнейшем будет считаться устаревшим.

### <a name="using-headers"></a>Использование заголовков
При запросе службы метаданных необходимо указать заголовок `Metadata: true`, чтобы избежать случайного перенаправления запроса.

### <a name="enabling-scheduled-events"></a>Включение запланированных событий
При первом создании запроса запланированных событий Azure неявно включает эту функцию на виртуальной машине. Это означает, что при первом вызове возможна задержка с ответом длительностью до двух минут.

### <a name="user-initiated-maintenance"></a>Обслуживание, инициированное пользователем
Обслуживание виртуальных машин, инициированное пользователем на портале Azure, в API, Azure CLI или PowerShell, приведет к созданию запланированных событий. Это позволяет протестировать логику подготовки обслуживания в вашем приложении, а также позволит ему подготовиться к обслуживанию, инициированном пользователем.

При перезапуске виртуальной машины планируется событие с типом `Reboot`. При развертывании виртуальной машины планируется событие с типом `Redeploy`.

> [!NOTE] 
> Сейчас можно одновременно запланировать более десяти операций обслуживания, инициированных пользователем. Это ограничение будет снято еще до выпуска общедоступной версии запланированных событий.

> [!NOTE] 
> Сейчас обслуживание, инициированное пользователем, которое влияет на запланированные события, не настраивается. Возможность настройки запланирована к следующему выпуску.

## <a name="using-the-api"></a>Использование API

### <a name="query-for-events"></a>Запрос сведений о событиях
Чтобы получить сведения о запланированных событиях, достаточно отправить следующий запрос:

```
curl -H Metadata:true http://169.254.169.254/metadata/scheduledevents?api-version=2017-03-01
```

Ответ содержит массив запланированных событий. Если это будет пустой массив, значит сейчас запланированных событий нет.
Если передаются запланированные события, массив событий в ответе выглядит так: 
```
{
    "DocumentIncarnation": {IncarnationID},
    "Events": [
        {
            "EventId": {eventID},
            "EventType": "Reboot" | "Redeploy" | "Freeze",
            "ResourceType": "VirtualMachine",
            "Resources": [{resourceName}],
            "EventStatus": "Scheduled" | "Started",
            "NotBefore": {timeInUTC},              
        }
    ]
}
```

### <a name="event-properties"></a>Свойства события
|Свойство  |  Описание |
| - | - |
| EventId | Глобальный уникальный идентификатор этого события. <br><br> Пример: <br><ul><li>602d9444-d2cd-49c7-8624-8643e7171297  |
| EventType | Влияние, которое оказывает это событие. <br><br> Значения: <br><ul><li> `Freeze`. Виртуальная машина будет приостановлена на несколько секунд. Работа ЦП приостанавливается, но это действие не повлияет на память, открытые файлы и сетевые подключения. <li>`Reboot`. Планирование перезагрузки виртуальной машины (временная память будет потеряна). <li>`Redeploy`. Виртуальная машина будет перемещена на другой узел с потерей данных на временных дисках. |
| ResourceType | Тип ресурса, на который влияет это событие. <br><br> Значения: <ul><li>`VirtualMachine`|
| Ресурсы| Список ресурсов, на которые влияет это событие. Обязательно будет содержать виртуальные машины максимум из одного [домена обновления](manage-availability.md), но не может содержать все машины в таком домене. <br><br> Пример: <br><ul><li> ["FrontEnd_IN_0", "BackEnd_IN_0"] |
| Event Status | Состояние этого события. <br><br> Значения: <ul><li>`Scheduled`. Это запланированное событие состоится по истечении времени, указанного в свойстве `NotBefore`.<li>`Started`. Это событие запущено.</ul> Состояние `Completed` (или аналогичное) никогда не предоставляется; событие не возвращается после завершения события.
| NotBefore| Время, после которого может быть запущено это событие. <br><br> Пример: <br><ul><li> 2016-09-19T18:29:47Z  |

### <a name="event-scheduling"></a>Планирование события
В зависимости от типа каждое будущее событие будет выполняться минимальное количество времени. Это время отражается в свойстве события `NotBefore`. 

|EventType  | Минимальное время уведомления |
| - | - |
| Freeze| 15 минут |
| Reboot | 15 минут |
| Повторное развертывание | 10 минут |

### <a name="starting-an-event"></a>Запуск события 

Когда вы узнаете о предстоящем событии и выполняете все действия для корректного завершения работы, вы можете утвердить ожидающее событие, выполнив вызов `POST` к службе метаданных Azure с помощью `EventId`. Это указывает службе Azure, что она может сократить минимальное время уведомления (если возможно). 

```
curl -H Metadata:true -X POST -d '{"DocumentIncarnation":"5", "StartRequests": [{"EventId": "f020ba2e-3bc0-4c40-a10b-86575a9eabd5"}]}' http://169.254.169.254/metadata/scheduledevents?api-version=2017-03-01
```

> [!NOTE] 
> Подтверждение событий позволяет выполнить событие для всех ресурсов `Resources` в событии, а не только для виртуальной машины, которая подтверждает событие. Таким образом, можно выбрать "лидера" для координации подтверждения, например первую виртуальную машину в поле `Resources`.




## <a name="python-sample"></a>Пример на языке Python 

В следующем примере выполняется запрос запланированных событий в службе метаданных, а затем утверждение каждого ожидающего события.

```python
#!/usr/bin/python

import json
import urllib2
import socket
import sys

metadata_url = "http://169.254.169.254/metadata/scheduledevents?api-version=2017-03-01"
headers = "{Metadata:true}"
this_host = socket.gethostname()

def get_scheduled_events():
   req = urllib2.Request(metadata_url)
   req.add_header('Metadata', 'true')
   resp = urllib2.urlopen(req)
   data = json.loads(resp.read())
   return data

def handle_scheduled_events(data):
    for evt in data['Events']:
        eventid = evt['EventId']
        status = evt['EventStatus']
        resources = evt['Resources']
        eventtype = evt['EventType']
        resourcetype = evt['ResourceType']
        notbefore = evt['NotBefore'].replace(" ","_")
        if this_host in resources:
            print "+ Scheduled Event. This host is scheduled for " + eventype + " not before " + notbefore
            # Add logic for handling events here

def main():
   data = get_scheduled_events()
   handle_scheduled_events(data)
   
if __name__ == '__main__':
  main()
  sys.exit(0)
```

## <a name="next-steps"></a>Дальнейшие действия 

- Дополнительные сведения об API, доступных в [службе метаданных экземпляра](instance-metadata-service.md).
- Подробнее о [плановом обслуживании виртуальных машин Linux в Azure](planned-maintenance.md).
