---
title: Обработка уведомлений по обслуживанию для виртуальных машин Linux в Azure | Документация Майкрософт
description: Просмотрите уведомления по обслуживанию для виртуальных машин Linux, запущенных в Azure, и запустите самостоятельное обслуживание.
services: virtual-machines-linux
documentationcenter: ''
author: zivraf
manager: jeconnoc
editor: ''
tags: azure-service-management,azure-resource-manager
ms.assetid: ''
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-windows
ms.devlang: na
ms.topic: article
ms.date: 12/15/2017
ms.author: zivr
ms.openlocfilehash: b1b4720c64d2eaa7578def6eac8f8231e4664d53
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30910131"
---
# <a name="handling-planned-maintenance-notifications-for-linux-virtual-machines"></a>Обработка уведомлений о плановом обслуживании для виртуальных машин Linux

Azure периодически выполняет обновления, чтобы повысить надежность, производительность и безопасность инфраструктуры узлов, в которой работают виртуальные машины. Обновления — это изменения, такие как исправление среды размещения или модернизация оборудования и вывод его из эксплуатации. Большинство этих обновлений не влияют на работу размещенных виртуальных машин. Но в некоторых случаях они все же оказывают определенное воздействие:

- Если обслуживание не требует перезагрузки, Azure с помощью миграции на месте приостанавливает работу виртуальной машины во время обновления узла.

- Если для обслуживания требуется перезагрузка, вы получите уведомление во время планирования обслуживания. В этих случаях вам предоставляется временное окно, в котором вы можете начать обслуживание самостоятельно в удобное для вас время.


Плановое обслуживание, требующее перезагрузки, разделяется на несколько этапов. Каждая волна имеет разную область (регионы).

- Волна начинается с уведомления клиентов. По умолчанию уведомление отправляется владельцу и совладельцам подписки. С помощью [оповещений журнала действий](../../monitoring-and-diagnostics/monitoring-overview-activity-logs.md) Azure вы можете добавить дополнительных получателей и методы доставки уведомлений, такие как электронная почта, текстовые сообщения или веб-перехватчики.  
- С момента создания уведомления начинается *период самообслуживания*. До завершения этого периода вы можете самостоятельно выяснить, для каких виртуальных машин запланировано обновление на этом этапе, и выполнить для них упреждающее обслуживание с учетом собственных пожеланий к графику работы.
- После периода самообслуживания, начинается *период запланированного обслуживания*. В некоторый момент этого периода Azure назначает и применяет для вашей виртуальной машины необходимые операции обслуживания. 

Два периода нужны, чтобы у вас было достаточно времени для запуска обслуживания и перезагрузки виртуальной машины до того, как Azure начнет обслуживание автоматически.


Для запроса окон обслуживания для виртуальных машин и запуска самообслуживания можно использовать портал Azure, PowerShell, REST API и CLI.

 > [!NOTE]
 > Если при попытке выполнить обслуживание запрос завершится ошибкой, Azure устанавливает для этой виртуальной машины статус **пропущена**. После этого вы не сможете выполнять для нее обслуживание по запросу клиента. Платформа Azure принудительно перезагрузит виртуальную машину в период запланированного обслуживания.


 
## <a name="should-you-start-maintenance-using-during-the-self-service-window"></a>Нужно ли начинать обслуживание в период самообслуживания?  

Следующие рекомендации помогут решить, есть ли смысл использовать эту возможность для обслуживания по собственному графику.

> [!NOTE] 
> Самостоятельное обслуживание может оказаться недоступным для некоторых виртуальных машин. Чтобы определить, доступно ли упреждающее обслуживание для ваших виртуальных машин, проверьте наличие ссылки **Начать сейчас** в информации о состоянии обслуживания. Самообслуживание в настоящее время недоступно для облачных служб (веб-ролей и рабочих ролей), Service Fabric и масштабируемых наборов виртуальных машин.


Мы не рекомендуем применять самообслуживание для развертываний, использующих **наборы доступности**, поскольку для них соблюдаются высокие требования к доступности и любые обновления в любой момент времени могут затрагивать только один домен обновления. 
    - Предоставьте Azure управление обслуживанием для них. Но учитывайте, что домены обновления будут обслуживаться в произвольном порядке и паузы между обслуживанием будут длиться 30 минут.
    - Если для вас недопустима временная потеря мощности или пропускной способности (в объеме, обратно пропорциональном количеству доменов обновления), эту проблему можно легко устранить: добавьте на весь период обслуживания необходимое количество дополнительных экземпляров. 

**Не применяйте** режим самообслуживания в следующих ситуациях. 
    - Если вы часто завершаете работу виртуальных машин, вручную, с помощью DevTest Labs, автоматического завершения работы или по расписанию. Перезагрузка может сбросить текущее состояние обслуживания, что приведет к дополнительным простоям.
    - Если вы используете виртуальные машины в течение короткого периода, то есть они наверняка будут удалены до завершения периода обслуживания. 
    - Если вы используете рабочие нагрузки с большим объемом информации о состоянии, которая хранится на локальном (временном) диске и должна сохраняться после обновления. 
    - Если вы часто изменяете размер виртуальной машины, поскольку это действие может привести к сбросу состояния обслуживания. 
    - Если вы настроили запланированные события, которые выполняют для рабочей нагрузки упреждающую отработку отказа или корректное завершение работы за 15 минут до завершения работы обслуживания.

Обязательно **используйте** самообслуживание, если вы намерены использовать виртуальную машину без перерыва в течение всего периода запланированного обслуживания и ваша система не соответствует ни одному из "блокирующих" условий, которые перечислены выше. 

Режим самообслуживания лучше всего подходит для следующих ситуаций.
    - Если вам нужно сообщить руководству или клиенту точное время обслуживания. 
    - Если вам важно завершить обслуживание не позднее определенной даты. 
    - Если вам важно соблюдать определенную последовательность обслуживания, например чтобы гарантировать безопасное восстановление для многоуровневого приложения.
    - Если вам нужна пауза более 30 минут для восстановления виртуальных машин между периодами обслуживания двух доменов обновления. Чтобы управлять длительностью пауз между обслуживанием доменов обновления, запускайте обслуживание виртуальных машин только для одного домена обновления.



## <a name="find-vms-scheduled-for-maintenance-using-cli"></a>Поиск виртуальных машин, для которых запланировано обслуживание, с использованием CLI

Сведения об плановом обслуживании можно посмотреть, используя [azure vm get-instance-view](/cli/azure/vm?view=azure-cli-latest#az_vm_get_instance_view).
 
Сведения об обслуживании возвращаются, только если имеется запланированное обслуживание. Если нет запланированного обслуживания, влияющего на виртуальную машину, команда не возвращает информацию об обслуживании. 

```azure-cli
az vm get-instance-view -g rgName -n vmName
```

В разделе MaintenanceRedeployStatus возвращаются следующие значения. 

| Значение | ОПИСАНИЕ   |
|-------|---------------|
| IsCustomerInitiatedMaintenanceAllowed | Указывает, можно ли сейчас запустить обслуживание на виртуальной машине ||
| PreMaintenanceWindowStartTime         | Начало периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| PreMaintenanceWindowEndTime           | Завершение периода самообслуживания, когда можно инициировать обслуживание на виртуальной машине ||
| MaintenanceWindowStartTime            | Начало периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. ||
| MaintenanceWindowEndTime              | Завершение периода запланированного обслуживания, в течение которого Azure запускает обслуживание для виртуальной машины. ||
| LastOperationResultCode               | Результат последней попытки инициирования обслуживания на виртуальной машине ||




## <a name="start-maintenance-on-your-vm-using-cli"></a>Запуск обслуживания вашей виртуальной машины с помощью CLI

Следующий вызов инициирует обслуживание на виртуальной машине, если для `IsCustomerInitiatedMaintenanceAllowed` установлено значение true.

```azure-cli
az vm perform-maintenance rgName vmName 
```

[!INCLUDE [virtual-machines-common-maintenance-notifications](../../../includes/virtual-machines-common-maintenance-notifications.md)]

## <a name="classic-deployments"></a>Классические развертывания

Если у вас все еще есть устаревшие виртуальные машины, развернутые с использованием классической модели развертывания, вы можете сделать запрос к ним и запустить их обслуживание с помощью CLI 1.0.

Чтобы убедиться, находитесь ли вы в правильном режиме для работы с классической виртуальной машиной, введите:

```
azure config mode asm
```

Чтобы узнать состояние обслуживания виртуальной машины с именем *myVM*, введите:

```
azure vm show myVM 
``` 

Чтобы начать обслуживание классической виртуальной машины с именем *myVM* в службе *myService* и развертывании *myDeployment*, введите команду:

```
azure compute virtual-machine initiate-maintenance --service-name myService --name myDeployment --virtual-machine-name myVM
```


## <a name="faq"></a>Часто задаваемые вопросы


**Вопрос. Зачем вам нужно перезагружать сейчас мою виртуальную машину?**

**Ответ.** Хотя обновления платформы Azure преимущественно не оказывают влияния на доступность виртуальных машин, иногда мы не можем избежать перезагрузки виртуальных машин, размещенных в Azure. Мы хотим внести несколько изменений, и для этого нам нужно перезапустить наши серверы. Это, в свою очередь, приведет к перезагрузке виртуальных машин.

**Вопрос. Безопасно ли выполнять рекомендации по обеспечению высокой доступности с помощью группы доступности?**

**Ответ.** Для виртуальных машин, развернутых в группе доступности или масштабируемом наборе виртуальных машин, применяется концепция доменов обновления. Во время обслуживания Azure учитывает ограничения доменов обновления и не выполняет перезагрузку виртуальных машин из разных доменов обновления (в пределах одной и той же группы доступности).  Azure также ожидает минимум 30 минут, прежде чем переходить к следующей группе виртуальных машин. 

Дополнительные сведения о высоком уровне доступности есть в статье о [регионах и доступности виртуальных машин в Azure](regions-and-availability.MD).

**Вопрос. Как происходит информирование о плановом обслуживании?**

**Ответ.** Процедура планового обслуживания начинается с настройки расписания для одного или нескольких регионов Azure. Вскоре после этого владельцам подписки отправляется уведомление по электронной почте (одно сообщение для каждой подписки). Дополнительные каналы и получатели для этого уведомления можно настроить с помощью оповещений журнала действий. При развертывании виртуальной машины в регионе, в котором плановое обслуживание назначено по расписанию, вы не получите уведомление. Вам нужно будет проверить состояние обслуживания виртуальной машины.

**Вопрос. Почему информация о плановом обслуживании не отображается на портале, в PowerShell или интерфейсе командной строки?**

**Ответ.** Сведения о плановом обслуживании доступны в ходе этой процедуры только для виртуальных машин, которые включены в плановое обслуживание. Другими словами, если данные не отображаются, это значит, что процедура обслуживания уже завершена (или не начата) или виртуальная машина уже размещена на обновленном сервере.

**Вопрос. Можно ли точно узнать, когда моя виртуальная машина будет затронута?**

**Ответ.** При планировании расписания мы определяем временное окно в несколько дней. Но точная последовательность серверов (и связанных виртуальных машин) в рамках этого окна неизвестна. Если клиенту нужно знать точное время обслуживания виртуальных машин, он может применить [запланированные события](scheduled-events.md) и запросы из виртуальных машин, чтобы получить уведомление за 15 минут до перезагрузки виртуальной машины.

**Вопрос. Как долго моя виртуальная машина будет перезагружаться?**

**Ответ.** Перезагрузка в течение периода самообслуживания может занять несколько минут в зависимости от размера виртуальной машины. Перезагрузка, инициированная Azure в период запланированного обслуживания, обычно занимает около 25 минут. Если вы используете облачные службы (рабочие роли и веб-роли), масштабируемые наборы виртуальных машин или группы доступности, то вы получите дополнительную паузу 30 минут между обновлением разных групп (доменов обновления) виртуальных машин в период запланированного обслуживания.

**Вопрос. Как обслуживание повлияет на облачные службы (рабочие роли или веб-роли), Service Fabric или масштабируемые наборы виртуальных машин?**

**Ответ.** Так как эти платформы будут затронуты плановым обслуживанием, клиенты смогут их безопасно использовать, если в указанный момент времени будут затронуты только виртуальные машины в одном домене обновления. Самообслуживание в настоящее время недоступно для облачных служб (веб-ролей и рабочих ролей), Service Fabric и масштабируемых наборов виртуальных машин.

**Вопрос. Мне пришло сообщение электронной почты о выводе оборудования из эксплуатации. Это и есть плановое обслуживание?**

**Ответ.** Хотя вывод оборудования из эксплуатации является частью планового обслуживания, мы еще не реализовали этот сценарий.  

**Вопрос. Информация об обслуживании не отображается в виртуальных машинах. В чем может быть проблема?**

**Ответ.** Есть несколько причин, по которым вы можете не видеть информацию об обслуживании в виртуальных машинах:
1.  Вы используете подписку, отмеченную в Майкрософт как внутренняя.
2.  Для виртуальных машин не запланировано обслуживание. Процедура обслуживания завершена, отменена или изменена так, чтобы не влиять на виртуальные машины.
3.  В представлении списка виртуальных машин отсутствует столбец **Обслуживание**. Хотя мы добавили этот столбец в представление по умолчанию, клиенты, которые настроили отображение пользовательских столбцов, должны вручную добавить столбец **Обслуживание** в представление списка виртуальных машин.

**Вопрос. Для моей виртуальной машины запланировано обслуживание во второй раз. Почему?**

**Ответ.** Есть несколько ситуаций, когда для виртуальной машины может быть запланирована еще одна процедура после обслуживания с повторным развертыванием:
1.  Мы отменили процедуру обслуживания и перезапустили ее с другими полезными данными. Мы обнаружили неисправные полезные данные, и нам просто нужно развернуть дополнительные полезные данные.
2.  Виртуальная машина *восстановлена* на другой узел из-за сбоя оборудования.
3.  Вы решили остановить (отменить распределение) и перезапустить виртуальную машину.
4.  Вы настроили **автоматическое завершение работы** для виртуальной машины.


**Вопрос. Обслуживание группы доступности выполнялось очень долго, и теперь для некоторых экземпляров в группе доступности установлен статус "Пропущено". Почему?** 

**Ответ**. Если вы в течение короткого времени запустите обновление нескольких экземпляров в одной группе доступности, Azure поместит эти запросы в очередь и будет выполнять обновление виртуальных машин только для одного домена обновления за один раз. Может показаться, что такое обновление занимает очень много времени, поскольку между разными доменами обновления соблюдаются паузы. Если обработка очереди обновления занимает более 60 минут, для некоторых экземпляров отобразится состояние **Пропущен**, даже если они успешно обновлены. Чтобы избежать этой ошибки в отображении состояния, запускайте обновление только для одного экземпляра в одной группе доступности. Подождите, пока завершится обновление этой виртуальной машины, и лишь затем запускайте обновление для следующей виртуальной машины из другого домена обновления.


## <a name="next-steps"></a>Дальнейшие действия

Узнайте, как зарегистрироваться для событий обслуживания прямо из виртуальной машины с помощью функции [запланированных событий](scheduled-events.md).
