---
title: Запись образа виртуальной машины Linux в Azure с помощью интерфейса командной строки 2.0 | Документация Майкрософт
description: Запись образа виртуальной машины Azure для использования при массовом развертывании с помощью Azure CLI 2.0.
services: virtual-machines-linux
documentationcenter: ''
author: cynthn
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: e608116f-f478-41be-b787-c2ad91b5a802
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: azurecli
ms.topic: article
ms.date: 03/22/2018
ms.author: cynthn
ms.openlocfilehash: bb70b3ff84392797ce0d93b8cf5d4018ff8ebdd8
ms.sourcegitcommit: d98d99567d0383bb8d7cbe2d767ec15ebf2daeb2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
ms.locfileid: "33941975"
---
# <a name="how-to-create-an-image-of-a-virtual-machine-or-vhd"></a>Создание образа виртуальной машины или виртуального жесткого диска

<!-- generalize, image - extended version of the tutorial-->

Чтобы создать несколько копий виртуальной машины для использования в Azure, запишите образ виртуальной машины или виртуальный жесткий диск (VHD) операционной системы. Для создания образа необходимо удалить сведения о личной учетной записи. Это сделает многократное развертывание образа более безопасным. На следующих шагах мы отзовем имеющуюся виртуальную машину, отменим ее выделение и создадим образ. Этот образ затем можно использовать для создания виртуальных машин в любой группе ресурсов в рамках вашей подписки.

Чтобы создать копию существующей виртуальной машины Linux для резервного копирования, отладки или передачи специализированного VHD Linux с локальной виртуальной машины, ознакомьтесь с разделом [Передача пользовательского образа диска и создание виртуальной машины Linux на его основе](upload-vhd.md).  

Для создания пользовательской конфигурации также можно использовать **Packer**. Дополнительные сведения об использовании Packer см. в статье [Создание образов виртуальных машин Linux в Azure с помощью Packer](build-image-with-packer.md).


## <a name="before-you-begin"></a>Перед началом работы
Необходимо выполнить следующие условия.

* Необходима виртуальная машина Azure, созданная в модели развертывания с помощью Resource Manager с использованием управляемых дисков. Если вы еще не создали виртуальную машину Linux, то для этого можно использовать [портал](quick-create-portal.md), [интерфейс командной строки Azure (Azure CLI)](quick-create-cli.md) или [шаблоны Resource Manager](create-ssh-secured-vm-from-template.md). Настройте виртуальную машину согласно своим требованиям. Например, [добавьте диски данных](add-disk.md), примените обновления и установите приложения. 

* Также необходимо установить последнюю версию [Azure CLI 2.0](/cli/azure/install-az-cli2) и войти в учетную запись Azure с помощью команды [az login](/cli/azure/reference-index#az_login).

## <a name="quick-commands"></a>Быстрые команды

Для тестирования, оценки или изучения виртуальных машинах в Azure можно использовать упрощенную версию этой статьи: [Создание пользовательского образа виртуальной машины Azure с помощью интерфейса командной строки](tutorial-custom-images.md).


## <a name="step-1-deprovision-the-vm"></a>Шаг 1. Отзыв виртуальной машины
Отзовите виртуальную машину с помощью агента виртуальной машины Azure, чтобы удалить файлы и данные конкретной машины. На исходной виртуальной машине Linux выполните команду `waagent` с параметром *-deprovision+user*. Дополнительные сведения см. в [руководстве пользователя агента Linux Azure](../extensions/agent-linux.md).

1. Подключитесь к виртуальной машине Linux c помощью клиента SSH.
2. В окне сеанса SSH введите следующую команду.
   
    ```bash
    sudo waagent -deprovision+user
    ```
<br>
   > [!NOTE]
   > Эту команду следует выполнять только на той виртуальной машине, образ которой вы хотите записать. Она не гарантирует, что из образа будет удалена вся конфиденциальная информация и что он будет готов к повторному распространению. Параметр *+user* также удаляет последнюю подготовленную учетную запись пользователя. Если вы хотите сохранить учетные данные учетной записи на виртуальной машине, то просто используйте параметр *-deprovision*, чтобы учетная запись пользователя осталась на своем месте.
 
3. Чтобы продолжить, введите **y** . Чтобы запрос на подтверждение не появлялся, добавьте параметр **-force** .
4. После выполнения команды введите **exit**. Клиент SSH будет закрыт.

## <a name="step-2-create-vm-image"></a>Шаг 2. Создайте образ виртуальной машины
Используйте Azure CLI 2.0, чтобы пометить виртуальную машину как универсальную и записать образ. В следующих примерах замените имена параметров собственными значениями. Примеры имен параметров: *myResourceGroup*, *myVnet* и *myVM*.

1. Отмените подготовку виртуальной машины, распределение которой вы отменили ранее с помощью команды [az vm deallocate](/cli//azure/vm#deallocate). В следующем примере отменяется распределение виртуальной машины *myVM*, входящей в группу ресурсов с именем *myResourceGroup*.
   
    ```azurecli
    az vm deallocate \
      --resource-group myResourceGroup \
      --name myVM
    ```

2. Пометьте виртуальную машину как универсальную с помощью команды [az vm generalize](/cli//azure/vm#generalize). В следующем примере виртуальная машина *myVM*, входящая в группу ресурсов *myResourceGroup*, помечается как универсальная:
   
    ```azurecli
    az vm generalize \
      --resource-group myResourceGroup \
      --name myVM
    ```

3. Теперь создайте образ из ресурса виртуальной машины с помощью команды [az image create](/cli/azure/image#az_image_create): В следующем примере создается образ с именем *myImage* в группе ресурсов с именем *myResourceGroup* на основе ресурса виртуальной машины с именем *myVM*:
   
    ```azurecli
    az image create \
      --resource-group myResourceGroup \
      --name myImage --source myVM
    ```
   
   > [!NOTE]
   > Образ создается в той же группе ресурсов, в которой находится исходная виртуальная машина. Виртуальную машину из этого образа можно создать в любой группе ресурсов в рамках вашей подписки. При управлении вам может потребоваться определенная группа ресурсов для ресурсов виртуальной машины и образов.
   >
   > Перед сохранением образа в хранилище, избыточном в пределах зоны, его необходимо создать в регионе, который поддерживает [зоны доступности](../../availability-zones/az-overview.md) и в котором включен параметр `--zone-resilient true`.

## <a name="step-3-create-a-vm-from-the-captured-image"></a>Шаг 3. Создание виртуальной машины из записанного образа
Создайте виртуальную машину из образа, который создали ранее с помощью команды [az vm create](/cli/azure/vm#az_vm_create). В следующем примере создается виртуальная машина *myVMDeployed* из образа *myImage*:

```azurecli
az vm create \
   --resource-group myResourceGroup \
   --name myVMDeployed \
   --image myImage\
   --admin-username azureuser \
   --ssh-key-value ~/.ssh/id_rsa.pub
```

### <a name="creating-the-vm-in-another-resource-group"></a>Создание виртуальной машины в другой группе ресурсов 

Вы можете создавать виртуальные машины из образа в любой группе ресурсов в рамках своей подписки. Чтобы создать виртуальную машину в другой группе ресурсов, укажите полный идентификатор ресурса для нужного образа. Список образов можно просмотреть с помощью команды [az image list](/cli/azure/image#az_image_list). Вы должны увидеть результат, аналогичный приведенному ниже.

```json
"id": "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage",
   "location": "westus",
   "name": "myImage",
```

В следующем примере используется команда [az vm create](/cli/azure/vm#az_vm_create) для создания виртуальной машины в группе ресурсов, отличной от той, в которой размещается исходный образ. Для этого мы указываем идентификатор ресурса образа:

```azurecli
az vm create \
   --resource-group myOtherResourceGroup \
   --name myOtherVMDeployed \
   --image "/subscriptions/guid/resourceGroups/MYRESOURCEGROUP/providers/Microsoft.Compute/images/myImage" \
   --admin-username azureuser \
   --ssh-key-value ~/.ssh/id_rsa.pub
```


## <a name="step-4-verify-the-deployment"></a>Шаг 4. Проверка развертывания

Чтобы проверить развертывание и начать использовать новую виртуальную машину, подключитесь к ней с помощью SSH-клиента. Чтобы подключиться через SSH, найдите IP-адрес или полное доменное имя виртуальной машины с помощью команды [az vm show](/cli/azure/vm#az_vm_show):

```azurecli
az vm show \
   --resource-group myResourceGroup \
   --name myVMDeployed \
   --show-details
```

## <a name="next-steps"></a>Дополнительная информация
Вы можете создать несколько виртуальных машин из исходного образа виртуальной машины. В образ при необходимости можно внести изменения следующими действиями. 

- Создайте виртуальную машину из образа.
- Выполните желаемые обновления или изменения конфигурации.
- Повторите весь процесс: отзовите виртуальную машину, освободите ее, подготовьте к работе и запишите образ.
- Используйте этот новый образ для будущих развертываний. При необходимости удалите исходный образ.

Чтобы узнать больше об управлении виртуальными машинами с помощью интерфейса командной строки, ознакомьтесь с [Azure CLI 2.0](/cli/azure).
