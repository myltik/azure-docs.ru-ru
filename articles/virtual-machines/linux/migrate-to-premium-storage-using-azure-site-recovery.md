---
title: Миграция виртуальных машин Linux в хранилище Azure уровня "Премиум" с помощью Azure Site Recovery | Документация Майкрософт
description: Перенесите имеющиеся виртуальные машины в хранилище Azure класса Premium с помощью Site Recovery. Хранилище Premium обеспечивает поддержку дисков с высокой производительностью и малой задержкой для интенсивных рабочих нагрузок ввода-вывода на виртуальных машинах Azure.
services: virtual-machines-linux
cloud: Azure
documentationcenter: na
author: luywang
manager: jeconnoc
ms.assetid: ''
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: luywang
ms.openlocfilehash: 0ab8ce25e3be85061c3fc0417b30b63e04b764ab
ms.sourcegitcommit: ca05dd10784c0651da12c4d58fb9ad40fdcd9b10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
ms.locfileid: "32777991"
---
# <a name="migrate-to-premium-storage-by-using-azure-site-recovery"></a>Перемещение в хранилище класса Premium с помощью Azure Site Recovery

[Хранилище Azure класса Premium](premium-storage.md) обеспечивает поддержку дисков с высокой производительностью и малой задержкой для виртуальных машин с интенсивной рабочей нагрузкой ввода-вывода. С помощью этого руководства вы узнаете, как переместить диски виртуальной машины из учетной записи хранения класса Standard в учетную запись хранения класса Premium с помощью [Azure Site Recovery](../../site-recovery/site-recovery-overview.md).

Site Recovery — это служба Azure, которая помогает реализовать стратегию аварийного восстановления и непрерывности бизнес-процессов. Она управляет процессами репликации локальных физических серверов и виртуальных машин в облако (Azure) или дополнительные центры обработки данных. При возникновении сбоев в исходном расположении происходит отработка отказа с выполнением перехода в дополнительное расположение. Это обеспечивает доступность приложений и рабочих нагрузок. При восстановлении нормального режима работы исходного расположения происходит переключение на него. 

Служба Site Recovery позволяет выполнять тестовую отработку отказа для поддержки аварийного восстановления, не влияя на рабочие среды. Вы можете выполнять отработки отказа с минимальной потерей данных (в зависимости от частоты репликации) в случае непредвиденных аварий. В случае перемещения в хранилище класса Premium можно использовать [отработку отказа в Site Recovery](../../site-recovery/site-recovery-failover.md), чтобы переместить целевые диски в учетную запись хранения класса Premium.

Мы рекомендуем перемещение в хранилище класса Premium с помощью Site Recovery, так как этот способ обеспечивает минимальное время простоя. Этот вариант также позволяет избежать копирования дисков и создания виртуальных машин вручную. В ходе отработки отказа Site Recovery будет систематически копировать диски и создавать новые виртуальные машины. 

Site Recovery поддерживает несколько типов отработки отказа — без простоя или с минимальным простоем. Чтобы спланировать время простоя и оценить потерю данных, ознакомьтесь со статьей [Отработка отказа в Site Recovery](../../site-recovery/site-recovery-failover.md). Если вы заранее [подготовились к подключению к виртуальным машинам Azure после отработки отказа](../../site-recovery/vmware-walkthrough-overview.md), то сможете подключиться к ним по протоколу подключения к удаленному рабочему столу.

![Схема аварийного восстановления][1]

## <a name="azure-site-recovery-components"></a>Компоненты Azure Site Recovery

Компоненты Site Recovery ниже относятся к этому сценарию перемещения.

* **Сервер конфигурации** — виртуальная машина Azure, которая координирует обмен данными и управляет процессами репликации и восстановления данных. На этой виртуальной машине необходимо запустить отдельный файл установки, который устанавливает сервер конфигурации, а также дополнительный компонент в качестве шлюза репликации, который называется сервером обработки. См. дополнительные сведения о [требованиях к серверу конфигурации](../../site-recovery/vmware-walkthrough-overview.md). Сервер конфигурации настраивается один раз и может использоваться для всех операций перемещения в один регион.

* **Сервер обработки** является шлюзом репликации, который: 

  1. получает данные репликации из исходных виртуальных машин;
  2. оптимизирует данные с помощью кэширования, сжатия и шифрования;
  3. отправляет данные в учетную запись хранения. 

  Он также обеспечивает принудительную установку службы мобильности на исходных виртуальных машинах и выполняет автоматическое обнаружение исходных виртуальных машин. Сервер обработки по умолчанию устанавливается на сервере конфигурации. Для масштабирования среды можно развернуть дополнительные автономные серверы обработки. Ознакомьтесь с [рекомендациями по развертыванию сервера обработки](https://azure.microsoft.com/blog/best-practices-for-process-server-deployment-when-protecting-vmware-and-physical-workloads-with-azure-site-recovery/) и [дополнительных серверов обработки](../../site-recovery/site-recovery-plan-capacity-vmware.md#deploy-additional-process-servers). Сервер обработки настраивается один раз и может использоваться для всех операций перемещения в один регион.

* **Служба мобильности** — это компонент, который развертывается на каждой стандартной виртуальной машине, для которой необходимо выполнить репликацию. Она фиксирует операции записи данных, выполняемые на стандартной виртуальной машине, и передает их на сервер обработки. Ознакомьтесь с [предварительными требованиями для реплицируемых компьютеров](../../site-recovery/vmware-walkthrough-overview.md).

На рисунке ниже показано, как взаимодействуют эти компоненты.

![Взаимодействие компонентов Site Recovery][15]

> [!NOTE]
> Site Recovery не поддерживает перенос дисков дисковых пространств.

Сведения о дополнительных компонентах для других сценариев см. в статье [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](../../site-recovery/vmware-walkthrough-overview.md).

## <a name="azure-essentials"></a>Основные компоненты Azure

Ниже приведены требования Azure для этого сценария перемещения.

* Подписка Azure.
* Учетная запись хранения класса Premium Azure для хранения реплицируемых данных.
* Виртуальная сеть Azure, к которой будут подключаться виртуальные машины, созданные при отработке отказа. Виртуальная сеть Azure должна располагаться в том же регионе, что и хранилище Site Recovery.
* Учетная запись хранения Azure класса Standard для хранения журналов репликации. Это может быть та же учетная запись хранения, в которую переносятся диски виртуальных машин.

## <a name="prerequisites"></a>предварительным требованиям

* Вам необходимо ознакомиться с соответствующими компонентами сценария перемещения, описанными в предыдущем разделе.
* Спланируйте время простоя, ознакомившись с [отработкой отказа в Site Recovery](../../site-recovery/site-recovery-failover.md).

## <a name="setup-and-migration-steps"></a>Этапы настройки и переноса данных

Site Recovery можно использовать для переноса виртуальных машин Azure IaaS между регионами или в одном регионе. Инструкции для этого сценария перемещения основаны на шагах, описанных в статье [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](../../site-recovery/vmware-walkthrough-overview.md). Используйте ссылки, чтобы получить подробные указания в дополнение к инструкциям в этой статье.

### <a name="step-1-create-a-recovery-services-vault"></a>Шаг 1. Создание хранилища служб восстановления

1. Откройте [портал Azure](https://portal.azure.com).
2. Последовательно выберите **Создать ресурс** > **Monitoring + Management** (Мониторинг и управление) > **Backup** and **Site Recovery (OMS)**. Вы также можете выбрать **Обзор** > **Хранилище служб восстановления** > **Добавить**. 
3. Укажите регион для репликации виртуальных машин. Для переноса данных в пределах того же региона выберите регион, где находятся исходные виртуальные и машины и исходные учетные записи. 

### <a name="step-2-choose-your-protection-goals"></a>Шаг 2. Выбор целевых объектов для защиты 

1. Откройте [портал Azure](https://portal.azure.com) на виртуальной машине, где нужно установить сервер конфигурации.
2. Перейдите в **Хранилища служб восстановления** > **Параметры** > **Site Recovery** > **Шаг 1. Подготовка инфраструктуры** > **Цель защиты**.

   ![Переход в область "Цель защиты"][2]

3. В разделе **Цель защиты** в первом раскрывающемся списке выберите **В Azure**. Во втором раскрывающемся списке выберите **Без виртуализации или иное**, а затем нажмите кнопку **ОК**.

   ![Область "Цель защиты" с заполненными полями][3]

### <a name="step-3-set-up-the-source-environment-configuration-server"></a>Шаг 3. Настройка исходной среды (сервера конфигурации)

1. Скачайте **программу унифицированной установки Azure Site Recovery** и ключ регистрации хранилища. Для этого выберите области **Подготовка инфраструктуры** > **Подготовка источника** > **Добавление сервера**. 
 
   Ключ регистрации хранилища требуется для запуска программы единой установки. Ключ действителен в течение пяти дней после создания.

   ![Переход в область "Добавление сервера"][4]

2. В области **Добавление сервера** добавьте сервер конфигурации.

   ![Область "Добавление сервера" с выбранным сервером конфигурации][5]

3. На виртуальной машине, которая используется в качестве сервера конфигурации, запустите программу унифицированной установки, чтобы установить сервер конфигурации и сервер обработки. Чтобы выполнить установку, вы можете [использовать снимки экрана](../../site-recovery/vmware-walkthrough-overview.md). Ниже приведены снимки экрана для шагов, необходимых в этом сценарии переноса данных.

   1. На странице **Перед началом работы** выберите **Install the configuration server and process server** (Установить сервер конфигурации и сервер обработки).

      ![Страница "Перед началом работы"][6]

   2. На странице **Регистрация** нажмите кнопку "Обзор" и выберите регистрационный ключ, скачанный из хранилища.

      ![Страница регистрации][7]

   3. На странице **Сведения о среде** укажите, нужно ли выполнять репликацию виртуальных машин VMware. В данном случае выберите **Нет**.

      ![Страница сведений о среде][8]

4. После завершения установки отобразится окно **сервера конфигурации Microsoft Azure Site Recovery**. Сделайте следующее:
 
   1. Чтобы создать учетную запись, которую Site Recovery сможет использовать для автоматического обнаружения, используйте вкладку **Управление учетными записями**. (При защите физических компьютеров настройка учетной записи не нужна, однако вам потребуется по крайней мере одна учетная запись, чтобы выполнить одно из следующих действий. В этом случае для учетной записи можно задать любое имя и пароль.) 
   2. Чтобы отправить файл учетных данных хранилища, используйте вкладку **Регистрация хранилища**.

      ![Вкладка регистрации хранилища][9]

### <a name="step-4-set-up-the-target-environment"></a>Шаг 4. Настройка целевой среды

Выберите **Подготовка инфраструктуры** > **Целевой объект** и укажите модель развертывания, которая будет использоваться для виртуальных машин после отработки отказа. В зависимости от конкретного сценария можно выбрать **классическую модель** или **модель развертывания Resource Manager**.

![Область "Целевой объект"][10]

Site Recovery проверяет наличие одной или нескольких совместимых учетных записей хранения и сетей Azure. 

> [!NOTE]
> Если для реплицированных данных используется учетная запись хранения класса Premium, необходимо настроить дополнительную стандартную учетную запись хранения для хранения журналов репликации.

### <a name="step-5-set-up-replication-settings"></a>Шаг 5. Настройка параметров репликации

Чтобы убедиться в том, что сервер конфигурации успешно связан с созданной политикой репликации, выполните инструкции [по настройке параметров репликации](../../site-recovery/vmware-walkthrough-overview.md).

### <a name="step-6-plan-capacity"></a>Шаг 6. Планирование ресурсов

1. Используйте [планировщик ресурсов](../../site-recovery/site-recovery-capacity-planner.md) для точной оценки требований к пропускной способности сети, хранилищу и других требований для репликации. 
2. После этого в поле **Have you completed capacity planning?** (Вы выполнили планирование ресурсов?) выберите **Да, выполнено**.

   ![Поле для подтверждения выполнения планирования ресурсов][11]

### <a name="step-7-install-the-mobility-service-and-enable-replication"></a>Шаг 7. Установка службы мобильности и включение репликации

1. Для исходных виртуальных машин можно выбрать [принудительную установку](../../site-recovery/vmware-walkthrough-overview.md) или [установить службу мобильности вручную](../../site-recovery/site-recovery-vmware-to-azure-install-mob-svc.md). Требования для принудительной установки и путь к ручному установщику можно найти, перейдя по указанной ссылке. При выполнении установки вручную может потребоваться использовать внутренний IP-адрес, чтобы найти сервер конфигурации.

   ![Страница сведений о сервере конфигурации][12]

   У виртуальной машины после отработки отказа будет два временных диска: один из основной виртуальной машины, а другой — созданный во время подготовки виртуальной машины в регионе восстановления. Чтобы исключить временный диск до репликации, установите службу мобильности, прежде чем включить репликацию. Дополнительные сведения о том, как исключить временный диск, см. в статье [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](../../site-recovery/vmware-walkthrough-overview.md).

2. Включите репликацию следующим образом:
   1. Выберите **репликацию приложения** > **Источник**. Включив репликацию впервые, выберите **+Replicate** (+ Репликация) в хранилище, чтобы включить репликацию для дополнительных машин.
   2. На шаге 1 выберите в качестве **источника** сервер обработки.
   3. На шаге 2 укажите модель развертывания после отработки отказа, учетную запись хранения класса Premium для переноса данных, стандартную учетную запись хранения для хранения журналов и виртуальную сеть для отработки отказа.
   4. На шаге 3 добавьте защищенные виртуальные машины по IP-адресам. (Вам может потребоваться внутренний IP-адрес, чтобы найти их.)
   5. На шаге 4 задайте свойства, выбрав учетные записи, настроенные ранее на сервере обработки.
   6. На шаге 5 выберите созданную ранее политику репликации (см. сведения в разделе "Шаг 5. Настройка параметров репликации").
   7. Нажмите кнопку **ОК**.

   > [!NOTE]
   > Когда виртуальная машина Azure освободится и перезапустится, нет никакой гарантии, что она получит тот же IP-адрес. Если IP-адрес сервера конфигурации, сервера обработки или защищенных виртуальных машин Azure изменится, репликация может быть выполнена неправильно.

   ![Область включения репликации с выбранным источником][13]

При разработке среды службы хранилища Azure для каждой виртуальной машины в группе доступности рекомендуется использовать отдельные учетные записи хранения. Ознакомьтесь с рекомендациями, касающимися уровня хранения, чтобы [использовать несколько учетных записей хранения для каждой группы доступности](../linux/manage-availability.md). Распределение дисков виртуальной машины между несколькими учетными записями позволит повысить доступность хранилища. Кроме того, операции ввода-вывода будут распределены по инфраструктуре службы хранилища Azure.

Если виртуальные машины находятся в группе доступности, вместо репликации дисков всех виртуальных машин в одну учетную запись хранения, мы настоятельно рекомендуем переместить несколько виртуальных машин по отдельности. Таким образом виртуальные машины в одной группе доступности будут использовать разные учетные записи хранения. Используйте область **Включение репликации**, чтобы настроить целевую учетную запись хранения для каждой виртуальной машины по отдельности.
 
Вы можете выбрать модель развертывания после отработки отказа в соответствии со своими требованиями. При выборе Azure Resource Manager в качестве модели развертывания после отработки отказа вы можете выполнить отработку отказа виртуальной машины (Resource Manager) на другую такую же машину, или же выполнить отработку отказа классической виртуальной машины на виртуальную машину (Resource Manager).

### <a name="step-8-run-a-test-failover"></a>Шаг 8. Запуск тестовой отработки отказа

Чтобы проверить, завершена ли репликация, выберите экземпляр Site Recovery, а затем — **Параметры** > **Реплицированные элементы**. Вы увидите состояние и прогресс процесса репликации в процентах. 

Когда первоначальная репликация завершится, запустите тестовую отработку отказа для проверки стратегии репликации. Подробное описание тестовой отработки отказа см. в статье [Репликация виртуальных машин VMware в Azure с помощью Site Recovery](../../site-recovery/vmware-walkthrough-overview.md). 

> [!NOTE]
> Чтобы приступить к отработке отказа, виртуальные машины и стратегия репликации должны соответствовать требованиям. Дополнительные сведения о тестовой отработке отказа см. в статье [Тестовая отработка отказа в Azure в Site Recovery](../../site-recovery/site-recovery-test-failover-to-azure.md).

Чтобы просмотреть состояние тестовой отработки отказа, выберите **Параметры** > **Задания** > , а затем выберите *название плана отработки отказа*. В открывшейся колонке вы увидите разбивку шагов и результаты выполнения (успешные и неудачные). Если какой-либо этап отработки отказа завершится ошибкой, щелкните его, чтобы просмотреть сообщение об ошибке. 

### <a name="step-9-run-a-failover"></a>Шаг 9. Запуск отработки отказа

После завершения тестовой отработки отказа запустите отработку отказа для переноса дисков в хранилище уровня "Премиум" и репликации экземпляров виртуальной машины. Выполните подробные инструкции в разделе [Запуск отработки отказа](../../site-recovery/site-recovery-failover.md#run-a-failover). 

Установите флажок **Shut down VMs and synchronize the latest data** (Завершать работу виртуальных машин и синхронизировать последние данные). Этот параметр указывает, что Site Recovery следует завершать работу защищенных виртуальных машин и синхронизировать данные для выполнения отработки отказа последних данных. Если вы не выберите этот вариант или соответствующая попытка завершится сбоем, то отработка отказа будет выполнена на основе последней доступной точки восстановления для виртуальной машины. 

Site Recovery создаст экземпляр виртуальной машины с типом виртуальной машины с поддержкой хранилища класса Premium или аналогичного типа. Сведения о производительности и стоимости различных экземпляров виртуальных машин см. на странице [Цены на виртуальные машины Windows](https://azure.microsoft.com/pricing/details/virtual-machines/windows/) или [Цены на виртуальные машины Linux](https://azure.microsoft.com/pricing/details/virtual-machines/linux/).

## <a name="post-migration-steps"></a>Действия после переноса данных

1. **Настройка и добавление реплицированных виртуальных машин в группу доступности (если применимо)**. Site Recovery не поддерживает перенос виртуальных машин вместе с группой доступности. В зависимости от типа развертывания реплицированной виртуальной машины выполните одно из следующих действий.
   * Для виртуальных машин, созданных с помощью классической модели развертывания, — добавьте виртуальную машину в группу доступности на портале Azure. Подробные инструкции см. в разделе [Добавление существующей виртуальной машины к группе доступности](../linux/classic/configure-availability-classic.md).
   * Для виртуальных машин, созданных с помощью модели развертывания Resource Manager, сохраните конфигурацию виртуальной машины, а затем удалите и повторно создайте виртуальные машины в группе доступности. Чтобы сделать это, используйте скрипт, приведенный [здесь](https://gallery.technet.microsoft.com/Set-Azure-Resource-Manager-f7509ec4). Перед выполнением этого скрипта ознакомьтесь с ограничениями и спланируйте время простоя.

2. **Удаление старых виртуальных машин и дисков**. Диски класса Premium должны быть согласованы с исходными дисками, а новые виртуальные машины выполнять функцию исходных виртуальных машин. Удалите виртуальную машину и диски из исходных учетных записей хранения на портале Azure. Если диск не удаляется даже после удаления виртуальной машины, ознакомьтесь со статьей [Устранение ошибок при удалении ресурсов хранилища](storage-resource-deletion-errors.md).

3. **Очистка инфраструктуры Azure Site Recovery**. Если служба Site Recovery больше не нужна, вы можете удалить ее инфраструктуру. Удалите реплицированные элементы, сервер конфигурации и политику восстановления, а затем удалите хранилище Azure Site Recovery.

## <a name="troubleshooting"></a>Устранение неполадок

* [Мониторинг и устранение неполадок защиты виртуальных машин и физических серверов](../../site-recovery/site-recovery-monitoring-and-troubleshooting.md)
* [Форум Microsoft Azure Site Recovery](https://social.msdn.microsoft.com/Forums/azure/home?forum=hypervrecovmgr)

## <a name="next-steps"></a>Дополнительная информация

Ознакомьтесь со следующими ресурсами, чтобы узнать о конкретных сценариях перемещения виртуальных машин.

* [Перенос виртуальных машин Azure между учетными записями хранения.](https://azure.microsoft.com/blog/2014/10/22/migrate-azure-virtual-machines-between-storage-accounts/)
* [Отправка виртуального жесткого диска Linux](upload-vhd.md)
* [Перенос виртуальных машин из Amazon AWS в Microsoft Azure.](http://channel9.msdn.com/Series/Migrating-Virtual-Machines-from-Amazon-AWS-to-Microsoft-Azure)

Дополнительные сведения о службе хранилища Azure и виртуальных машинах Azure см. также в следующих источниках:

* [Хранилище Azure](https://azure.microsoft.com/documentation/services/storage/)
* [Виртуальные машины Azure](https://azure.microsoft.com/documentation/services/virtual-machines/)
* [Хранилище Premium: высокопроизводительное хранилище для рабочих нагрузок виртуальных машин Azure](premium-storage.md)

[1]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-1.png
[2]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-2.png
[3]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-3.png
[4]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-4.png
[5]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-5.png
[6]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-6.PNG
[7]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-7.PNG
[8]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-8.PNG
[9]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-9.PNG
[10]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-10.png
[11]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-11.PNG
[12]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-12.PNG
[13]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-13.png
[14]:../site-recovery/media/site-recovery-vmware-to-azure/v2a-architecture-henry.png
[15]:./media/migrate-to-premium-storage-using-azure-site-recovery/migrate-to-premium-storage-using-azure-site-recovery-14.png
