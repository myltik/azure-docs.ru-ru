---
title: Настройка диспетчера логических томов на виртуальной машине Linux | Документация Майкрософт
description: Узнайте, как настроить диспетчер логических томов на виртуальной машине Linux в Azure.
services: virtual-machines-linux
documentationcenter: na
author: szarkos
manager: jeconnoc
editor: tysonn
tag: azure-service-management,azure-resource-manager
ms.assetid: 7f533725-1484-479d-9472-6b3098d0aecc
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 02/02/2017
ms.author: szark
ms.openlocfilehash: 9a22426d0422585714cb78d541a84d55d2fce6e0
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30912235"
---
# <a name="configure-lvm-on-a-linux-vm-in-azure"></a>Настройка диспетчера логических томов на виртуальной машине Linux в Azure
В этом документе рассматривается, как настроить диспетчер логических томов (LVM) на виртуальной машине Azure. Хотя диспетчер логических томов можно настроить на любом диске, подключенном к виртуальной машине, по умолчанию он не настроен на диске ОС большинства облачных образов. Это позволяет предотвратить возникновение проблем (например, во время выполнения сценария аварийного восстановления), связанных с одинаковыми группами томов, если диск ОС подключен к двум виртуальным машинам одного типа и версии дистрибутива. Поэтому рекомендуется использовать диспетчер логических томов только на дисках данных.

## <a name="linear-vs-striped-logical-volumes"></a>Линейные и чередующиеся логические тома
Диспетчер логических томов можно использовать, чтобы объединять несколько физических дисков в один том хранилища. По умолчанию диспетчер логических томов создает линейные логические тома. Это означает, что физическое хранилище соединено воедино. В этом случае операции чтения и записи, как правило, будут отправляться только на один диск. В свою очередь, в чередующихся логических томах операции чтения и записи распределяются между несколькими дисками в группе томов (аналогично чередованию RAID 0). Для повышения производительности вам потребуется чередовать логические тома. Это позволит выполнять операции чтения и записи на всех подключенных дисках данных.

В этом документе описано, как соединить несколько дисков данных в одну группу томов и создать чередующийся логический том. Описанные ниже действия можно выполнять с большинством дистрибутивов. В большинстве случаев служебные программы и рабочие процессы, которые используются для управления диспетчером логических томов в Azure, существенно не отличаются от других сред. Для получения дополнительных сведений и рекомендаций по использованию диспетчера логических томов с вашим дистрибутивом обратитесь к поставщику Linux.

## <a name="attaching-data-disks"></a>Присоединение дисков данных
Чтобы использовать диспетчер логических томов, обычно требуется не менее двух пустых дисков данных. В зависимости от потребностей ввода-вывода, можно подключить диски, которые хранятся в хранилище уровня "Стандартный" и допускают до 500 операций ввода-вывода в секунду на диск, или диски из хранилища уровня "Премиум", поддерживающие до 5000 операций ввода-вывода в секунду. В этой статье мы не будем подробно останавливаться на том, как подготовить и подключить диски данных к виртуальной машине Linux. Подробные указания по подключению пустого диска данных к виртуальной машине Linux в Azure см. в разделе [Добавление диска](add-disk.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) статьи Microsoft Azure.

## <a name="install-the-lvm-utilities"></a>Установка служебных программ диспетчера логических томов
* **Ubuntu**

    ```bash  
    sudo apt-get update
    sudo apt-get install lvm2
    ```

* **RHEL, CentOS и Oracle Linux**

    ```bash   
    sudo yum install lvm2
    ```

* **SLES 12 и openSUSE**

    ```bash   
    sudo zypper install lvm2
    ```

* **SLES 11**

    ```bash   
    sudo zypper install lvm2
    ```

    В системе SLES11 необходимо также изменить файл `/etc/sysconfig/lvm` и задать для параметра `LVM_ACTIVATED_ON_DISCOVERED` значение enable:

    ```sh   
    LVM_ACTIVATED_ON_DISCOVERED="enable" 
    ```

## <a name="configure-lvm"></a>Настройка диспетчера логических томов
В этом руководстве предполагается, что подключены три диска данных с именами `/dev/sdc`, `/dev/sdd` и `/dev/sde`. Обратите внимание, что имена путей в вашей виртуальной машине могут отличаться. Запустите команду`sudo fdisk -l`или подобную, чтобы просмотреть список доступных дисков.

1. Подготовьте физические тома.

    ```bash    
    sudo pvcreate /dev/sd[cde]
    Physical volume "/dev/sdc" successfully created
    Physical volume "/dev/sdd" successfully created
    Physical volume "/dev/sde" successfully created
    ```

2. Создайте группу томов. В этом примере группе томов присвоено имя `data-vg01`:

    ```bash    
    sudo vgcreate data-vg01 /dev/sd[cde]
    Volume group "data-vg01" successfully created
    ```

3. Создайте логические тома. Приведенная ниже команда создает один логический том с именем `data-lv01`, который охватывает целую группу томов, однако в группе томов также можно создать несколько логических томов.

    ```bash   
    sudo lvcreate --extents 100%FREE --stripes 3 --name data-lv01 data-vg01
    Logical volume "data-lv01" created.
    ```

4. Измените формат логического тома.

    ```bash  
    sudo mkfs -t ext4 /dev/data-vg01/data-lv01
    ```
   
   > [!NOTE]
   > Для SLES11 замените ext4 на `-t ext3`. SLES11 поддерживает доступ только для чтения к файловым системам ext4.

## <a name="add-the-new-file-system-to-etcfstab"></a>Добавление новой файловой системы в /etc/fstab
> [!IMPORTANT]
> Некорректное изменение файла `/etc/fstab` может привести к невозможности загрузить систему. Если не уверены, обратитесь к документации дистрибутива за сведениями о том, как правильно изменить этот файл. Также рекомендуется перед внесением изменений создать резервную копию файла `/etc/fstab`.

1. Создайте нужную точку монтирования для новой файловой системы, например:

    ```bash  
    sudo mkdir /data
    ```

2. Найдите путь логического тома.

    ```bash    
    lvdisplay
    --- Logical volume ---
    LV Path                /dev/data-vg01/data-lv01
    ....
    ```

3. Откройте файл `/etc/fstab` в текстовом редакторе и добавьте запись для новой файловой системы, например:

    ```bash    
    /dev/data-vg01/data-lv01  /data  ext4  defaults  0  2
    ```   
    Затем сохраните и закройте `/etc/fstab`.

4. Проверьте правильность записи `/etc/fstab`:

    ```bash    
    sudo mount -a
    ```

    Если в результате выполнения команды появляется сообщение об ошибке, то проверьте синтаксис в файле `/etc/fstab`.
   
    Теперь выполните команду `mount` для подключения файловой системы:

    ```bash    
    mount
    ......
    /dev/mapper/data--vg01-data--lv01 on /data type ext4 (rw)
    ```

5. (Необязательно) Параметры загрузки, предотвращающие сбой, в файле `/etc/fstab`
   
    Многие дистрибутивы включают в себя параметры подключения `nobootwait` или `nofail`, которые можно добавить в файл `/etc/fstab`. Эти параметры в случае сбоя при монтировании конкретной файловой системы позволяют системе Linux продолжить загрузку, даже если ей не удается надлежащим образом смонтировать файловую систему RAID. Дополнительные сведения об этих параметрах см. в документации по вашему дистрибутиву.
   
    Пример (Ubuntu):

    ```bash 
    /dev/data-vg01/data-lv01  /data  ext4  defaults,nobootwait  0  2
    ```

## <a name="trimunmap-support"></a>Поддержка операций TRIM и UNMAP
Некоторые ядра Linux поддерживают операции TRIM и UNMAP для отмены неиспользуемых блоков на диске. Эти операции особенно удобно использовать в хранилище уровня "Стандартный", чтобы сообщать Azure о том, что удаленные страницы больше не действительны и могут быть удалены. Удаление страниц позволит сократить затраты, если вы создаете большие файлы, а затем удаляете их.

Существует два способа включить поддержку операций TRIM в виртуальной машине Linux. Как обычно, обратитесь к документации дистрибутива, чтобы выбрать рекомендуемый метод.

- Используйте параметр подключения `discard` в `/etc/fstab`. Ниже приведен пример.

    ```bash 
    /dev/data-vg01/data-lv01  /data  ext4  defaults,discard  0  2
    ```

- В некоторых случаях параметр `discard` может негативно влиять на производительность. Кроме того, вы можете вручную выполнить команду `fstrim` из командной строки или добавить ее в crontab для регулярного выполнения.

    **Ubuntu**

    ```bash 
    # sudo apt-get install util-linux
    # sudo fstrim /datadrive
    ```

    **RHEL или CentOS**

    ```bash 
    # sudo yum install util-linux
    # sudo fstrim /datadrive
    ```
