---
title: Устранение неполадок SSH-подключения к виртуальной машине Azure | Документация Майкрософт
description: Диагностика ошибок, например "ошибка SSH-подключения" или "в SSH-подключении отказано", для виртуальной машины под управлением Linux.
keywords: отклонение SSH-подключения, ошибка SSH, Azure SSH, ошибка SSH-подключения
services: virtual-machines-linux
documentationcenter: ''
author: iainfoulds
manager: jeconnoc
editor: ''
tags: top-support-issue,azure-service-management,azure-resource-manager
ms.assetid: dcb82e19-29b2-47bb-99f2-900d4cfb5bbb
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 05/30/2017
ms.author: iainfou
ms.openlocfilehash: 533a80edbb115dfd324db9e4488e5c66dc36667e
ms.sourcegitcommit: 3a4ebcb58192f5bf7969482393090cb356294399
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="troubleshoot-ssh-connections-to-an-azure-linux-vm-that-fails-errors-out-or-is-refused"></a>Устранение неполадок с SSH-подключением к виртуальной машине Azure Linux: сбой, ошибка или отклонение
При попытке подключения к виртуальной машине Azure под управлением Linux ошибка, сбой или отклонение подключения Secure Shell (SSH) может возникнуть по нескольким причинам. В этой статье вы узнаете, как их выявить и устранить. Для устранения неполадок и решения проблем с подключением можно воспользоваться порталом Azure, Azure CLI или расширением для доступа к виртуальной машине для Linux.

[!INCLUDE [learn-about-deployment-models](../../../includes/learn-about-deployment-models-both-include.md)]

Если в любой момент при изучении этой статьи вам потребуется дополнительная помощь, вы можете обратиться к экспертам по Azure на [форумах MSDN Azure и Stack Overflow](http://azure.microsoft.com/support/forums/). Кроме того, можно зарегистрировать обращение в службу поддержки Azure. Перейдите на [сайт поддержки Azure](http://azure.microsoft.com/support/options/) и щелкните **Получить поддержку**. Дополнительные сведения об использовании службы поддержки Azure см. в статье [Часто задаваемые вопросы о поддержке Microsoft Azure](http://azure.microsoft.com/support/faq/).

## <a name="quick-troubleshooting-steps"></a>Действия по устранению неполадок
После выполнения каждого шага устранения неполадок попробуйте подключиться к виртуальной машине еще раз.

1. сбросить конфигурацию SSH.
2. Сбросьте учетные данные пользователя.
3. Убедитесь, что правила [группы безопасности сети](../../virtual-network/virtual-networks-nsg.md) разрешают трафик SSH.
   * Убедитесь, что правило для разрешения трафика SSH есть в группе безопасности сети (по умолчанию — TCP-порт 22).
   * Нельзя использовать перенаправление и сопоставление портов, не используя Azure Load Balancer.
4. Проверьте [работоспособность ресурсов виртуальной машины](../../resource-health/resource-health-overview.md). 
   * Убедитесь, что виртуальная машина работоспособна.
   * Если включена диагностика загрузки, убедитесь, что виртуальная машина не сообщала об ошибках загрузки в журналах.
5. Перезапустите виртуальную машину.
6. Заново разверните виртуальную машину.

Читайте статью дальше, если вам нужны более подробные инструкции или пояснения об исправлении неполадок.

## <a name="available-methods-to-troubleshoot-ssh-connection-issues"></a>Доступные методы устранения неполадок подключения SSH
Вы можете сбросить учетные данные или конфигурацию SSH одним из следующих методов:

* [Портал Azure](#use-the-azure-portal) отлично подходит, когда нужно быстро сбросить конфигурацию или ключ SSH, а у вас не установлены инструменты Azure.
* [Azure CLI 2.0](#use-the-azure-cli-20). Если вы уже открыли командную строку, быстро сбросьте конфигурацию SSH или учетные данные. Для этого можно также использовать [Azure CLI 1.0](#use-the-azure-cli-10).
* [Расширение Azure VMAccessForLinux.](#use-the-vmaccess-extension) Создайте и повторно используйте файлы определения JSON для сброса учетных данных пользователя или конфигурации SSH.

После выполнения каждого шага устранения неполадок попробуйте подключиться к виртуальной машине еще раз. Если все еще не удается подключиться, то попробуйте выполнить следующее действие.

## <a name="use-the-azure-portal"></a>Использование портала Azure
На портале Azure предусмотрена возможность быстрого сброса конфигурации SSH или учетных данных пользователей без установки каких-либо инструментов на локальном компьютере.

Выберите свою виртуальную машину на портале Azure. Прокрутите вниз до раздела **Поддержка и устранение неполадок** и выберите **Сбросить пароль**, как в следующем примере:

![Сброс конфигурации SSH или учетных данных на портале Azure](./media/troubleshoot-ssh-connection/reset-credentials-using-portal.png)

### <a name="reset-the-ssh-configuration"></a>Сброс конфигурации SSH
Сначала в раскрывающемся меню **Режим** выберите `Reset configuration only`, как на предыдущем снимке экрана, и нажмите кнопку **Сброс**. Сделав это, попытайтесь снова войти в виртуальною машину.

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Чтобы сбросить учетные данные имеющегося пользователя, в раскрывающемся меню **Режим** выберите `Reset SSH public key` или `Reset password`, как на приведенном выше снимке экрана. Укажите имя пользователя и ключ SSH или новый пароль, а затем нажмите кнопку **Сброс**.

Кроме того, в этом меню можно создать пользователя с привилегиями sudo на виртуальной машине. Введите новое имя пользователя и соответствующий пароль или ключ SSH, а затем нажмите кнопку **Сброс**.

### <a name="check-security-rules"></a>Проверка правил безопасности

Используйте [проверку потока для IP-адреса](../../network-watcher/network-watcher-check-ip-flow-verify-portal.md), чтобы определить, блокирует ли правило в группе безопасности сети входящий или исходящий трафик виртуальной машины. Кроме того, вы можете просмотреть действующие правила группы безопасности и убедиться, что для порта SSH (22 по умолчанию) существует и является приоритетным правило NSG, разрешающее входящий трафик. Дополнительные сведения см. в разделе [Использование действующих правил безопасности для устранения проблем с потоком трафика в виртуальной машине](../../virtual-network/virtual-network-nsg-troubleshoot-portal.md#using-effective-security-rules-to-troubleshoot-vm-traffic-flow).

### <a name="check-routing"></a>Проверка маршрутизации

Убедитесь, что маршрут не препятствуют маршрутизации трафика на виртуальную машину или с нее, воспользовавшись возможностью [Следующий прыжок](../../network-watcher/network-watcher-check-next-hop-portal.md) в службе "Наблюдатель за сетями". Кроме того, вы можете просмотреть фактические маршруты для сетевого интерфейса. Дополнительные сведения см. в статье об [использовании фактических маршрутов для устранения проблем с потоком трафика на виртуальной машине](../../virtual-network/virtual-network-routes-troubleshoot-portal.md#using-effective-routes-to-troubleshoot-vm-traffic-flow).

## <a name="use-the-azure-cli-20"></a>Использование Azure CLI 2.0
Установите последнюю версию [Azure CLI 2.0](/cli/azure/install-az-cli2) (если вы еще этого не сделали) и войдите в учетную запись Azure, выполнив команду [az login](/cli/azure/reference-index#az_login).

Если вы создали и отправили пользовательский образ диска Linux, убедитесь, что установлен [агент Linux для Microsoft Azure](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) версии 2.0.5 или более поздней. В виртуальных машинах, созданных с помощью образов из коллекции, это расширение для доступа уже установлено и настроено.

### <a name="reset-ssh-configuration"></a>Сбросьте конфигурацию SSH.
Вы можете сначала попробовать сбросить конфигурацию SSH к значениям по умолчанию и перезагрузить сервер SSH на виртуальной машине. Обратите внимание, что при этом не изменяется имя учетной записи пользователя, пароль или ключи SSH.
В следующем примере используется команда [az vm user reset-ssh](/cli/azure/vm/user#az_vm_user_reset_ssh) для сброса конфигурации SSH на виртуальной машине с именем `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm user reset-ssh --resource-group myResourceGroup --name myVM
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
В следующем примере используется команда [aaz vm user update](/cli/azure/vm/user#az_vm_user_update), чтобы сбросить учетные данные для `myUsername` к значению, указанному в `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm user update --resource-group myResourceGroup --name myVM \
     --username myUsername --password myPassword
```

При использовании аутентификации с помощью ключа SSH можно сбросить ключ SSH для отдельного пользователя. В следующем примере используется команда **az vm access set-linux-user**, чтобы сбросить учетные данные для `~/.ssh/id_rsa.pub` к значению, указанному в `myUsername` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm user update --resource-group myResourceGroup --name myVM \
    --username myUsername --ssh-key-value ~/.ssh/id_rsa.pub
```

## <a name="use-the-vmaccess-extension"></a>Использование расширения VMAccess
Расширение для доступа к виртуальной машине для Linux выполняет чтение в JSON-файле. При этом сбрасывается SSHD и ключ SSH или добавляется пользователь. Azure CLI по-прежнему используется для вызова расширения VMAccess, но при необходимости JSON-файлы можно использовать повторно в нескольких виртуальных машинах. Такой подход позволяет создать репозиторий JSON-файлов, которые можно впоследствии вызывать для заданных сценариев.

### <a name="reset-sshd"></a>Сброс SSHD
Создайте файл `settings.json` со следующим содержимым:

```json
{  
    "reset_ssh":"True"
}
```

С помощью Azure CLI вызовите расширение `VMAccessForLinux` для сброса подключения SSHD, указав JSON-файл. В следующем примере используется команда [az vm extension set](/cli/azure/vm/extension#az_vm_extension_set) для сброса SSHD на виртуальной машине с именем `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm extension set --resource-group philmea --vm-name Ubuntu \
    --name VMAccessForLinux --publisher Microsoft.OSTCExtensions --version 1.2 --settings settings.json
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Если SSHD работает корректно, можно сбросить учетные данные для отдельного пользователя. Чтобы сбросить пароль для пользователя, создайте файл с именем `settings.json`. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword`. Введите следующие строки в файл `settings.json`, используя свои значения:

```json
{
    "username":"myUsername", "password":"myPassword"
}
```

Чтобы сбросить ключ SSH для пользователя, сначала создайте файл с именем `settings.json`. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Введите следующие строки в файл `settings.json`, используя свои значения:

```json
{
    "username":"myUsername", "ssh_key":"mySSHKey"
}
```

Создав JSON-файл, используйте Azure CLI, чтобы вызвать расширение `VMAccessForLinux` для сброса учетных данных пользователя SSH, указав JSON-файл. В следующем примере сбрасываются учетные данные на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm extension set --resource-group philmea --vm-name Ubuntu \
    --name VMAccessForLinux --publisher Microsoft.OSTCExtensions --version 1.2 --settings settings.json
```

## <a name="use-the-azure-cli-10"></a>Использование Azure CLI 1.0
[Установите Azure CLI 1.0 и подключитесь к подписке Azure](../../cli-install-nodejs.md) (если вы еще этого не сделали). Убедитесь, что используется режим Resource Manager следующим образом:

```azurecli
azure config mode arm
```

Если вы создали и отправили пользовательский образ диска Linux, убедитесь, что установлен [агент Linux для Microsoft Azure](../windows/agent-user-guide.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) версии 2.0.5 или более поздней. В виртуальных машинах, созданных с помощью образов из коллекции, это расширение для доступа уже установлено и настроено.

### <a name="reset-ssh-configuration"></a>Сбросьте конфигурацию SSH.
Может быть неправильно настроена сама конфигурация SSHD, или в службе произошла ошибка. Чтобы убедиться, что конфигурация SSH действительна, можно выполнить сброс SSHD. При устранении неполадок сначала нужно сбросить SSHD.

В следующем примере перезапускается SSHD на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте собственные имена для виртуальной машины и группы ресурсов следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
    --reset-ssh
```

### <a name="reset-ssh-credentials-for-a-user"></a>Сброс учетных данных SSH пользователя
Если SSHD работает корректно, можно сбросить пароль для отдельного пользователя. В следующем примере сбрасываются учетные данные для имени пользователя `myUsername` до значения, указанного в пароле `myPassword` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
     --user-name myUsername --password myPassword
```

При использовании аутентификации с помощью ключа SSH можно сбросить ключ SSH для отдельного пользователя. В следующем примере обновляется ключ SSH, хранящийся в файле `~/.ssh/id_rsa.pub`, для пользователя с именем `myUsername` на виртуальной машине `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm reset-access --resource-group myResourceGroup --name myVM \
    --user-name myUsername --ssh-key-file ~/.ssh/id_rsa.pub
```


## <a name="restart-a-vm"></a>Перезапуск виртуальной машины
Если вы сбросили учетные данные пользователя и конфигурацию SSH или столкнулись с ошибкой при этом, попробуйте перезапустить виртуальную машину, чтобы устранить неполадки с базовыми вычислительными ресурсами.

### <a name="azure-portal"></a>Портал Azure
Чтобы перезапустить виртуальную машину с помощью портала Azure, выберите виртуальную машину и нажмите кнопку **Перезапуск**, как показано в следующем примере:

![Перезапуск виртуальной машины на портале Azure](./media/troubleshoot-ssh-connection/restart-vm-using-portal.png)

### <a name="azure-cli-10"></a>Azure CLI 1.0
В следующем примере перезапускается виртуальная машина `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm restart --resource-group myResourceGroup --name myVM
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
В следующем примере используется команда [az vm restart](/cli/azure/vm#az_vm_restart), чтобы перезапустить виртуальную машину `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm restart --resource-group myResourceGroup --name myVM
```


## <a name="redeploy-a-vm"></a>Повторное развертывание виртуальной машины
Виртуальную машину можно повторно развернуть на другом узле в Azure, что поможет устранить любые базовые сетевые проблемы. Сведения о повторном развертывании виртуальной машины на новом узле Azure см. [здесь](../windows/redeploy-to-new-node.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).

> [!NOTE]
> Обратите внимание, что после этой операции будут потеряны данные на временном диске, а также изменятся динамические IP-адреса, связанные с виртуальной машиной.
> 
> 

### <a name="azure-portal"></a>Портал Azure
Чтобы повторно развернуть виртуальную машину с помощью портала Azure, выберите виртуальную машину и прокрутите вниз до раздела **Поддержка и устранение неполадок**. Нажмите кнопку **Повторить развертывание**, как показано в следующем примере:

![Повторное развертывание виртуальной машины на портале Azure](./media/troubleshoot-ssh-connection/redeploy-vm-using-portal.png)

### <a name="azure-cli-10"></a>Azure CLI 1.0
В следующем примере повторно развертывается виртуальная машина `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
azure vm redeploy --resource-group myResourceGroup --name myVM
```

### <a name="azure-cli-20"></a>Azure CLI 2.0
В следующем примере используется команда [az vm restart](/cli/azure/vm#az_vm_redeploy), чтобы повторно развернуть виртуальную машину `myVM` в группе ресурсов `myResourceGroup`. Используйте свои значения следующим образом:

```azurecli
az vm redeploy --resource-group myResourceGroup --name myVM
```

## <a name="vms-created-by-using-the-classic-deployment-model"></a>Виртуальные машины, созданные с использованием классической модели развертывания
Для устранения наиболее распространенных сбоев SSH-подключения для виртуальных машин, созданных с помощью классической модели развертывания, попробуйте выполнить указанные ниже действия. После выполнения каждого шага попробуйте подключиться к виртуальной машине еще раз.

* Выполните сброс удаленного доступа на [портале Azure](https://portal.azure.com). На портале Azure выберите свою виртуальную машину и нажмите кнопку **Reset Remote...** (Удаленный сброс...).
* Перезапустите виртуальную машину. На [портале Azure](https://portal.azure.com) выберите свою виртуальную машину и нажмите кнопку **Перезапуск**.
    
* Повторно разверните виртуальную машину на новом узле Azure. Сведения о повторном развертывании виртуальной машины на новом узле Azure см. [здесь](../windows/redeploy-to-new-node.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json).
  
    Обратите внимание, что после этой операции будут потеряны данные на временном диске, а также изменятся динамические IP-адреса, связанные с виртуальной машиной.
* Следуйте указаниям в статье о [сбросе пароля или ключа SSH в виртуальных машинах Linux](classic/reset-access-classic.md?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json), чтобы сделать следующее:
  
  * сбросить пароль или ключ SSH;
  * Создайте учетную запись пользователя *sudo*.
  * сбросить конфигурацию SSH.
* Проверьте работоспособность ресурсов виртуальной машины, чтобы выявить любые проблемы, связанные с платформой.<br>
     Выберите свою виртуальную машину и прокрутите вниз до раздела **Параметры** > **Проверка работоспособности**.

## <a name="additional-resources"></a>Дополнительные ресурсы
* Если вам по-прежнему не удается выполнить SSH-подключение к виртуальной машине, см. [дополнительные действия по устранению неполадок](detailed-troubleshoot-ssh-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json), которые позволят просмотреть дополнительные шаги по устранению проблемы.
* Дополнительные сведения об устранении неполадок с доступом к приложению см. в статье [Устранение неполадок доступа к приложению, выполняющемуся в виртуальной машине Azure](../windows/troubleshoot-app-connection.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json).
* Дополнительные сведения об устранении неполадок на виртуальных машинах, созданных с помощью классической модели развертывания, см. в статье о [сбросе пароля или ключа SSH в виртуальных машинах Linux](classic/reset-access-classic.md?toc=%2fazure%2fvirtual-machines%2flinux%2fclassic%2ftoc.json).

