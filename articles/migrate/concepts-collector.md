---
title: Модуль сборщика в службе "Миграция Azure" | Документация Майкрософт
description: Сведения о модуле сборщика и его настройке.
author: ruturaj
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 01/23/2017
ms.author: ruturajd
services: azure-migrate
ms.openlocfilehash: 059f577c138847af04e92ce9ab12a8de88251c73
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="collector-appliance"></a>Модуль сборщика

Служба [Миграция Azure](migrate-overview.md) выполняет оценку локальных рабочих нагрузок для переноса в Azure. В этой статье объясняется, как использовать модуль сборщика.



## <a name="overview"></a>Обзор

Сборщик Миграции Azure — это простой модуль, который можно использовать для обнаружения локального окружения vCenter. Этот модуль обнаруживает локальные виртуальные машины VMware и отправляет метаданные о них в службу "Миграция Azure".

Модуль сборщика — это OVF-файл, который можно скачать из проекта службы "Миграция Azure". Модуль создает экземпляр виртуальной машины VMware с 4 ядрами, 8 ГБ ОЗУ и 1 диском размером 80 ГБ. Для этого модуля используется ОС Windows Server 2012 R2 (64-разрядная версия).

Чтобы создать сборщик, выполните шаги, приведенные в разделе [Создание виртуальной машины сборщика](tutorial-assessment-vmware.md#create-the-collector-vm).

## <a name="collector-communication-diagram"></a>Схема связей сборщика

![Схема связей сборщика](./media/tutorial-assessment-vmware/portdiagram.PNG)


| Компонент      | Обмен данными   | Требуемый порт                            | Причина                                   |
| -------------- | --------------------- | ---------------------------------------- | ---------------------------------------- |
| Сборщик      | со службой "Миграция Azure" | TCP 443                                  | Сборщик должен взаимодействовать со службой через SSL-порт 443. |
| Сборщик      | с сервером vCenter        | 443 (по умолчанию)                             | Сборщик должен иметь возможность взаимодействовать с сервером vCenter. По умолчанию он подключается к vCenter через порт 443. Если vCenter ожидает передачи данных на другом порте, на сборщике этот порт должен быть доступен как исходящий. |
| Сборщик      | RDP|   | TCP 3389 | Для подключения к виртуальной машине сборщика по протоколу RDP |





## <a name="collector-pre-requisites"></a>Необходимые компоненты для сборщика

Сборщик должен пройти несколько проверок предварительных требований, чтобы он мог подключиться к службе "Миграция Azure" и отправлять обнаруженные данные. В этой статье приводятся все предварительные требования и объясняется их необходимость.

### <a name="internet-connectivity"></a>Подключение к Интернету

Модуль сборщика должен быть подключен к Интернету, чтобы отправлять сведения об обнаруженных машинах. Подключить виртуальную машину к Интернету можно одним из двух способов:

1. Вы можете настроить сборщик для прямого подключения к Интернету.
2. Вы можете настроить сборщик для подключения через прокси-сервер.
    * Если для прокси-сервера требуется аутентификация, можно указать имя пользователя и пароль в параметрах подключения.
    * IP-адрес или полное доменное имя прокси-сервера должны иметь формат http://IPaddress или http://FQDN. Поддерживается только прокси-сервер HTTP.

> [!NOTE]
> Сборщик не поддерживает прокси-серверы на основе HTTPS.

#### <a name="whitelisting-urls-for-internet-connection"></a>Добавление URL-адресов в список разрешений для подключения к Интернету

Проверка предварительных требований считается успешной, если сборщик может подключиться к Интернету с использованием заданных параметров. Проверка подключения производится с помощью подключения к URL-адресам из списка, как указано в таблице ниже. При использовании любого прокси-сервера брандмауэра на основе URL-адреса для управления исходящими подключениями, внесите в список этих разрешений требуемые URL-адреса:

**URL-адрес** | **Назначение**  
--- | ---
*.portal.azure.com | Требуется для проверки подключения к службе Azure и проверки с синхронизацией времени.

Кроме того, при проверке также выполняется попытка проверить подключение к приведенным ниже URL-адресам. Но проверка не завершается ошибкой, если нет доступа. Настраивать список разрешений для следующих URL-адресов необязательно, но вам придется вручную выполнить проверку предварительных требований.

**URL-адрес** | **Назначение**  | **Что произойдет, если не добавить в список разрешений?**
--- | --- | ---
*.oneget.org:443 | Необходимо скачать модуль PowerCLI vCenter на основе PowerShell. | Установка PowerCLI завершится сбоем. Установите модуль вручную.
*.windows.net:443 | Необходимо скачать модуль PowerCLI vCenter на основе PowerShell. | Установка PowerCLI завершится сбоем. Установите модуль вручную.
*.windowsazure.com:443 | Необходимо скачать модуль PowerCLI vCenter на основе PowerShell. | Установка PowerCLI завершится сбоем. Установите модуль вручную.
*.powershellgallery.com:443 | Необходимо скачать модуль PowerCLI vCenter на основе PowerShell. | Установка PowerCLI завершится сбоем. Установите модуль вручную.
*.msecnd.net:443 | Необходимо скачать модуль PowerCLI vCenter на основе PowerShell. | Установка PowerCLI завершится сбоем. Установите модуль вручную.
*.visualstudio.com:443 | Необходимо скачать модуль PowerCLI vCenter на основе PowerShell. | Установка PowerCLI завершится сбоем. Установите модуль вручную.

### <a name="time-is-in-sync-with-the-internet-server"></a>Синхронизация времени с сервером в Интернете

Сборщик нужно синхронизировать с сервером времени в Интернете, чтобы обеспечить аутентификацию запросов к службе. Чтобы проверить время, URL-адрес portal.azure.com должен быть доступен для сборщика. Если виртуальная машина не синхронизирована, измените время на виртуальной машине сборщика в соответствии с текущим временем. Для этого сделайте следующее:

1. Откройте командную строку с правами администратора на этой виртуальной машине.
1. Чтобы проверить часовой пояс, выполните команду w32tm /tz.
1. Чтобы синхронизировать время, выполните команду w32tm /resync.

### <a name="collector-service-should-be-running"></a>Обязательный запуск службы сборщика

Служба "Сборщик Миграции Azure" должна быть запущена на виртуальной машине. Служба запускается автоматически после загрузки виртуальной машины. Если служба *Сборщик Миграции Azure* не запущена, запустите ее с помощью панели управления. Служба сборщика отвечает за подключение к серверу vCenter, сбор метаданных и данных о производительности виртуальной машины и их отправку в службу.

### <a name="vmware-powercli-65"></a>VMware PowerCLI 6.5 

Чтобы сборщик мог обмениваться данными с сервером vCenter и запрашивать сведения о виртуальных машинах и их данные о производительности, нужно установить модуль PowerShell VMware PowerCLI. Модуль PowerShell автоматически скачивается и устанавливается при проверке предварительных требований. Для автоматического скачивания нужно добавить в список разрешений несколько URL-адресов. В противном случае вам все же придется предоставить доступ, добавив эти адреса в список разрешений, или установить модуль вручную.

Установите модуль вручную, сделав следующее:

1. Чтобы установить PowerCLI в сборщике без подключения к Интернету, выполните действия, описанные [здесь](https://blogs.vmware.com/PowerCLI/2017/04/powercli-install-process-powershell-gallery.html).
2. Установив модуль PowerShell, на другом компьютере с доступом к Интернету, скопируйте файлы VMware.* с этой виртуальной машины на машину сборщика.
3. Перезапустите проверку предварительных требований и убедитесь, что модуль PowerCLI установлен.

## <a name="connecting-to-vcenter-server"></a>Подключение к vCenter Server

Сборщик должен быть подключен к vCenter Server и иметь возможность отправлять запросы для виртуальных машин, (запрашивать их метаданные и данные счетчиков производительности). Эти данные используется в проекте для проведения внутренней оценки.

1. Чтобы подключиться к vCenter Server и выполнить обнаружение, можно использовать учетную запись с разрешениями только для чтения, как показано в следующей таблице. 

    |Задача  |Требуемая роль или учетная запись  |Разрешения  |
    |---------|---------|---------|
    |Обнаружение с помощью модуля сборщика    | Потребуется по крайней мере пользователь только для чтения        |Объект центра обработки данных –> Распространение на дочерний объект, роль Read-only         |

2. Для обнаружения доступны только те центры обработки данных, к которым имеет доступ указанная учетная запись vCenter.
3. Чтобы подключиться к серверу vCenter, нужно указать FQDN или IP-адрес vCenter. По умолчанию для подключения используется порт 443. Если согласно настройкам vCenter ожидает передачи данных на порте с другим номером, можно указать его как часть адреса сервера в формате: IPAddress:номер_порта или FQDN:номер_порта.
4. Перед началом развертывания для сервера vCenter Server нужно задать параметры статистики уровня 3. Если уровень будет ниже 3, обнаружение будет выполняться, но данные о производительности хранилища и сети не будут собираться. В этом случае рекомендации по объему оценки будут основаны на данных о производительности ЦП и памяти, а также конфигурации диска и сетевых адаптеров. [Узнайте больше](./concepts-collector.md) о том, какие данные собираются и как это влияет на оценку.
5. Для сборщика требуется сеть, по которой он сможет напрямую подключаться к серверу vCenter.

> [!NOTE]
> Официально поддерживаются только версии vCenter Server 5.5, 6.0 и 6.5.

> [!IMPORTANT]
> Рекомендуем установить наибольший общий уровень (3) для статистики, чтобы данные счетчиков собирались правильно. Если задать более низкий уровень статистики vCenter, то полностью смогут быть собраны только данные нескольких счетчиков, остальные же покажут 0. Оценка может отображать неполные данные. 

### <a name="selecting-the-scope-for-discovery"></a>Выбор области для обнаружения

Подключившись к серверу vCenter, вы можете выбрать область для обнаружения. При выборе области будут обнаруживаться все виртуальные машины из указанного пути инвентаризации vCenter.

1. Областью может быть центр обработки данных, папка или узел ESXi. 
2. За один раз можно выбрать только одну область. Чтобы выбрать несколько виртуальных машин, выполните одно обнаружение и повторно запустите его с использованием новой области.
3. Можно выбрать только область, которая содержит *менее 1500 виртуальных машин*.

## <a name="specify-migration-project"></a>Определение проекта миграции

Подключив локальный сервер vCenter и выбрав область, вы можете указать данные о проекте миграции, которые будут использоваться для обнаружения и оценки. Укажите идентификатор и ключ проекта, а затем установите подключение.

## <a name="start-discovery-and-view-collection-progress"></a>Запуск обнаружения и просмотр хода выполнения сбора данных

После запуска выполняется обнаружение виртуальных машин vCenter и отправка их метаданных и данных о производительности на сервер. В ходе выполнения предоставляются следующие идентификаторы:

1. Идентификатор сборщика — уникальный идентификатор, назначенный виртуальной машине сборщика. Этот идентификатор не меняется для этой виртуальной машины при выполнении разных операций обнаружения. Вы можете использовать этот идентификатор в случае сбоя для отправки сообщения о проблеме в службу поддержки Майкрософт.
2. Идентификатор сеанса — уникальный идентификатор для выполняющегося задания по сбору данных. По завершении задания можно использовать этот идентификатор сеанса на портале. Он меняется для каждого задания по сбору данных. В случае сбоя вы можете отправить этот идентификатор в службу поддержки Майкрософт.

### <a name="what-data-is-collected"></a>Какие данные собираются?

При сборе данных обнаруживаются следующие статические метаданные о выбранных виртуальных машинах: 

1. Отображаемое имя виртуальной машины (на сервере vCenter).
2. Путь инвентаризации виртуальной машины (узел или папка на сервере vCenter).
3. IP-адрес
4. MAC-адрес.
5. Число ядер, дисков и сетевых адаптеров.
6. Объем ОЗУ и диска.
7. Данные счетчиков производительности виртуальных машин, диска и сети, приведенные в таблице ниже.

В следующей таблице перечислены счетчики производительности, данные о которых собираются, и затронутые результаты оценки, если данные счетчика не собраны.

|Счетчик                                  |Уровень    |Уровень каждого устройства  |Влияние на оценку                               |
|-----------------------------------------|---------|------------------|------------------------------------------------|
|cpu.usage.average                        | 1       |Нет данных                |Рекомендуемый размер и стоимость виртуальной машины                    |
|mem.usage.average                        | 1       |Нет данных                |Рекомендуемый размер и стоимость виртуальной машины                    |
|virtualDisk.read.average                 | 2       |2                 |Размер диска, стоимость хранения и размер виртуальной машины         |
|virtualDisk.write.average                | 2       |2                 |Размер диска, стоимость хранения и размер виртуальной машины         |
|virtualDisk.numberReadAveraged.average   | 1       |3                 |Размер диска, стоимость хранения и размер виртуальной машины         |
|virtualDisk.numberWriteAveraged.average  | 1       |3                 |Размер диска, стоимость хранения и размер виртуальной машины         |
|net.received.average                     | 2       |3                 |Размер виртуальной машины и затраты на сеть                        |
|net.transmitted.average                  | 2       |3                 |Размер виртуальной машины и затраты на сеть                        |

> [!WARNING]
> Если вы только что задали более высокий уровень статистики, то для создания данных счетчиков производительности потребуется до одного дня. Поэтому рекомендуется выполнить обнаружение через один день.

### <a name="time-required-to-complete-the-collection"></a>Время, необходимое для выполнения сбора данных

Сборщик только обнаруживает данные виртуальной машины и отправляет их в проект. Чтобы обнаруженные для проекта данные отобразились на портале и можно было приступить к созданию оценки, может потребоваться дополнительное время.

В зависимости от числа виртуальных машин в выбранной области, отправка статических метаданных в проект может занять до 15 минут. Когда статические метаданные станут доступны на портале, можно просмотреть список виртуальных машин на портале и приступить к созданию групп. Вы не сможете создать оценку до завершения задания по сбору данных и их обработки в проекте. Когда сборщик завершит выполнение задания, чтобы данные о производительности стали доступны на портале может потребоваться около часа, в зависимости от числа виртуальных машин в выбранной области.

## <a name="locking-down-the-collector-appliance"></a>Блокировка модуля сборщика
Рекомендуем непрерывно выполнять обновление Windows для модуля сборщика. Если сборщик не обновляется в течение 45 дней, он начинает автоматическое завершение работы компьютера. Если выполняется обнаружение, компьютер не отключится даже по истечении 45-дневного периода. Когда задание обнаружения будет завершено, компьютер отключится. Если сборщик используется более 45 дней, рекомендуем постоянно поддерживать компьютер в обновленном состоянии, запуская средство обновления Windows.

Также рекомендуем выполнить описанные ниже действия для защиты модуля.
1. Не предоставляйте пароли администратора неавторизованным лицам и не помещайте такие пароли в ненадлежащих расположениях.
2. Завершайте работу модуля, когда он не используется.
3. Подключите модуль к защищенной сети.
4. По завершении миграции удалите экземпляр модуля. Не забудьте также удалить файлы поддержки дисков (VMDK), так как на дисках могут храниться кэшированные учетные данные vCenter.

## <a name="how-to-upgrade-collector"></a>Как обновить сборщик

Сборщик можно обновить до последней версии, не скачивая OVA-файл повторно.

1. Скачайте [пакет обновления](https://aka.ms/migrate/col/latestupgrade) последней версии.
2. Чтобы обеспечить защиту скачиваемых исправлений, откройте командное окно от имени администратора и выполните указанную ниже команду для создания хэша ZIP-файла. Созданный хэш должен совпадать с хэшем, предусмотренным для определенной версии:

    ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```
    
    (Пример использования: C:\>CertUtil -HashFile C:\AzureMigrate\CollectorUpdate_release_1.0.9.5.zip SHA256.)
3. Скопируйте ZIP-файл на виртуальную машину сборщика службы "Миграция Azure" (модуль сборщика).
4. Щелкните ZIP-файл правой кнопкой мыши и выберите "Извлечь все".
5. Щелкните файл Setup.ps1 правой кнопкой мыши и выберите Run with PowerShell (Запуск с помощью PowerShell), а затем следуйте инструкциям на экране, чтобы установить обновление.

### <a name="list-of-updates"></a>Список обновлений

#### <a name="upgrade-to-version-1097"></a>Обновление до версии 1.0.9.7

Чтобы выполнить обновление до версии 1.0.9.7, скачайте [пакет](https://aka.ms/migrate/col/upgrade_9_7).

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | 01ccd6bc0281f63f2a672952a2a25363
SHA1 | 3e6c57523a30d5610acdaa14b833c070bffddbff
SHA256 | e3ee031fb2d47b7881cc5b13750fc7df541028e0a1cc038c796789139aa8e1e6

#### <a name="upgrade-to-version-1095"></a>Обновление до версии 1.0.9.5

Чтобы выполнить обновление до версии 1.0.9.5, скачайте [пакет](https://aka.ms/migrate/col/upgrade_9_5).

**Алгоритм** | **Значение хэша**
--- | ---
MD5 | d969ebf3bdacc3952df0310d8891ffdf
SHA1 | f96cc428eaa49d597eb77e51721dec600af19d53
SHA256 | 07c03abaac686faca1e82aef8b80e8ad8eca39067f1f80b4038967be1dc86fa1

## <a name="next-steps"></a>Дополнительная информация

[Настройка оценки локальных виртуальных машин VMware](tutorial-assessment-vmware.md)
