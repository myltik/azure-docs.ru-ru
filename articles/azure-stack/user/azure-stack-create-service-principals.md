---
title: Создание субъекта-службы для Azure Stack | Документация Майкрософт
description: Описывается создание субъекта-службы, который можно использовать в Azure Resource Manager в сочетании с управлением доступом на основе ролей для управления доступом к ресурсам.
services: azure-resource-manager
documentationcenter: na
author: mattbriggs
manager: femila
ms.assetid: 7068617b-ac5e-47b3-a1de-a18c918297b6
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 04/27/2018
ms.author: mabrigg
ms.openlocfilehash: de5712fd7b48a759b366f5b9808bbbefc6e305cd
ms.sourcegitcommit: 909469bf17211be40ea24a981c3e0331ea182996
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
ms.locfileid: "34010500"
---
# <a name="give-applications-access-to-azure-stack-resources-by-creating-service-principals"></a>Предоставление приложениям доступа к ресурсам Azure Stack за счет создания субъектов-служб

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Вы можете предоставить приложению доступ к ресурсам Azure Stack, создав субъект-службу, который использует Azure Resource Manager. Субъект-служба позволяет делегировать конкретные разрешения с помощью [управления доступом на основе ролей](azure-stack-manage-permissions.md).

Рекомендуется использовать субъекты-службы для ваших приложений. Субъекты-службы рекомендуется использовать для запуска приложения с вашими учетными данными по следующим причинам:

* Для субъекта-службы можно назначить разрешения, которые отличаются от ваших разрешений учетной записи. Как правило, разрешения субъекта-службы ограничены именно теми разрешениями, которые необходимы приложению для его работы.
* В случае изменения роли или обязанностей изменять учетные данные приложения не требуется.
* Можно использовать сертификат, чтобы автоматизировать проверку подлинности при выполнении автоматического сценария.

## <a name="example-scenario"></a>Пример сценария

У вас есть приложение для управления конфигурацией, которому необходимо составить перечень ресурсов Azure с помощью Azure Resource Manager. Вы можете создать субъект-службу и назначить ему роль "Читатель". Эта роль предоставляет приложению доступ только для чтения к ресурсам Azure.

## <a name="getting-started"></a>Приступая к работе

В этой статье описаны действия для выполнения следующих задач:

* Создание субъекта-службы для приложения.
* Регистрация приложения и создание ключа проверки подлинности.
* Назначение роли для приложения.

Способ создания субъекта-службы определяется тем, как настроен каталог Active Directory для Azure Stack. Выберите один из следующих вариантов:

* Создание субъекта-службы в [Azure Active Directory (Azure AD)](azure-stack-create-service-principals.md#create-service-principal-for-azure-ad).
* Создание субъекта-службы в [службах федерации Active Directory (AD FS)](azure-stack-create-service-principals.md#create-service-principal-for-ad-fs).

Действия для назначения роли для субъекта-службы аналогичны в Azure AD и AD FS. После создания субъекта-службы вы можете [делегировать разрешения](azure-stack-create-service-principals.md#assign-role-to-service-principal), назначив роль для этого субъекта-службы.

## <a name="create-a-service-principal-for-azure-ad"></a>Создание субъекта-службы для Azure AD

Если Azure Stack использует Azure AD в качестве хранилища удостоверений, можно создать субъект-службу, выполнив те же действия в Azure с помощью портала Microsoft Azure.

>[!NOTE]
Перед созданием субъекта-службы проверьте, что у вас есть [необходимые разрешения Azure AD](../../azure-resource-manager/resource-group-create-service-principal-portal.md#required-permissions).

### <a name="create-service-principal"></a>Создание субъекта-службы

Чтобы создать субъект-службу для приложения, выполните следующие действия:

1. Войдите в учетную запись Azure на [портале Azure](https://portal.azure.com).
2. Выберите **Azure Active Directory** > **Регистрация приложений** > **Добавить**.
3. Укажите имя и URL-адрес для приложения. Выберите тип создаваемого приложения: **веб-приложение или API** или **собственное приложение**. Выбрав нужные значения, нажмите кнопку **Создать**.

### <a name="get-credentials"></a>Получение учетных данных

При использовании программного входа в систему вам потребуются идентификатор приложения и ключ проверки подлинности. Для получения этих значений:

1. В Active Directory в разделе **регистрации приложений** выберите нужное приложение.

2. Скопируйте **идентификатор приложения** и сохраните его в коде приложения. В [примерах приложений](#sample-applications) в качестве **идентификатора приложения** используется **идентификатор клиента**.

     ![Идентификатор приложения](./media/azure-stack-create-service-principal/image12.png)
3. Чтобы создать ключ проверки подлинности, щелкните **Ключи**.

4. Введите описание и срок действия ключа. Затем нажмите кнопку **Сохранить**.

>[!IMPORTANT]
После сохранения ключа отображается **значение** ключа. Запишите это значение, так как вы не сможете получить его позже. Сохраните значение ключа, чтобы приложение могло получить к нему доступ.

![Предупреждение о значении ключа для сохраненного ключа.](./media/azure-stack-create-service-principal/image15.png)

Последний шаг — [назначение роли для приложения](azure-stack-create-service-principals.md#assign-role-to-service-principal).

## <a name="create-service-principal-for-ad-fs"></a>Создание субъекта-службы для AD FS

При развертывании Azure Stack с использованием AD FS в качестве хранилища удостоверений можно использовать PowerShell для решения следующих задач:

* Создание субъекта-службы.
* Назначение роли для субъекта-службы.
* Вход с помощью удостоверения субъекта-службы.

### <a name="before-you-begin"></a>Перед началом работы

[Скачайте на локальный компьютер необходимые инструменты Azure Stack.](azure-stack-powershell-download.md)

### <a name="import-the-identity-powershell-module"></a>Импорт модуля Identity PowerShell

Перейдите в папку скачивания инструментов Azure Stack и импортируйте модуль PowerShell Identity, выполнив следующую команду:

```PowerShell
Import-Module .\Identity\AzureStack.Identity.psm1
```

При импорте модуля Identity может появиться сообщение об ошибке "AzureStack.Connect.psm1 не имеет цифровой подписи. Скрипт не будет выполнен в системе".

Чтобы устранить эту проблему, необходимо настроить политику выполнения, разрешив запуск сценария. Чтобы настроить политику выполнения, выполните следующую команду в сеансе PowerShell с повышенными привилегиями:

```PowerShell
Set-ExecutionPolicy Unrestricted
```

### <a name="create-the-service-principal"></a>Создание субъекта-службы

Чтобы создать субъект-службу, выполните следующую команду, указав требуемое значение параметра **DisplayName**:

```powershell
$servicePrincipal = New-AzSADGraphServicePrincipal `
 -DisplayName "<YourServicePrincipalName>" `
 -AdminCredential $(Get-Credential) `
 -AdfsMachineName "AZS-ADFS01" `
 -Verbose

```

### <a name="assign-a-role"></a>Назначение роли

Созданному субъекту-службе необходимо [назначить роль](azure-stack-create-service-principals.md#assign-role-to-service-principal).

### <a name="sign-in-using-powershell"></a>Вход с помощью PowerShell

Вы сможете войти в Azure Stack, выполнив следующую команду и указав имя приложения в качестве значения параметра **EnvironmentName**:

```powershell
Add-AzureRmAccount -EnvironmentName "<AzureStackEnvironmentName>" `
 -ServicePrincipal `
 -CertificateThumbprint $servicePrincipal.Thumbprint `
 -ApplicationId $servicePrincipal.ApplicationId `
 -TenantId $directoryTenantId
```

## <a name="assign-the-service-principal-to-a-role"></a>Назначение роли для субъекта-службы

Чтобы обеспечить доступ к ресурсам в подписке, необходимо назначить приложению роль. Укажите, какая роль предоставит приложению необходимые разрешения. Дополнительные сведения о доступных ролях см. в статье [RBAC: встроенные роли](../../role-based-access-control/built-in-roles.md).

>[!NOTE]
Вы можете задать область действия роли на уровне подписки, группы ресурсов или ресурса. Разрешения наследуют более низкие уровни области действия. Например, приложение с ролью "Читатель" для группы ресурсов может считывать все ресурсы в группе ресурсов.

Чтобы назначить роль для субъекта-службы, выполните следующие действия.

1. На портале Azure Stack перейдите на уровень области действия, которой вы хотите назначить приложение. Например, чтобы назначить роль в области действия подписки выберите **Подписки**.

2. Выберите подписку, для которой хотите назначить приложение. В этом примере это подписка Visual Studio Enterprise.

     ![Выбор подписки Visual Studio Enterprise для назначения](./media/azure-stack-create-service-principal/image16.png)

3. В качестве подписки выберите **Управление доступом (IAM)**.

     ![Выбор управления доступом](./media/azure-stack-create-service-principal/image17.png)

4. Выберите **Добавить**.

5. Выберите роль, которая будет назначена приложению.

6. Найдите приложение и выберите его.

7. Нажмите кнопку **ОК**, чтобы завершить назначение роли. Вы увидите свое приложение в списке пользователей, назначенных выбранной роли для этой области действия.

Итак, вы создали субъект-службу и назначили ему роль. Теперь ваше приложение может обращаться к ресурсам Azure Stack.

## <a name="next-steps"></a>Дополнительная информация

[Управление разрешениями пользователей](azure-stack-manage-permissions.md)
