---
title: "Подключение Azure Stack к Azure с помощью VPN"
description: "Сведения о подключении виртуальных сетей в Azure Stack к виртуальным сетям в Azure с помощью VPN."
services: azure-stack
documentationcenter: 
author: brenduns
manager: femila
editor: 
ms.assetid: 
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 9/25/2017
ms.author: brenduns
ms.reviewer: scottnap
ms.openlocfilehash: 16cc1962eb72ac219adc8483f38cecf41a4296c1
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2018
---
# <a name="connect-azure-stack-to-azure-using-vpn"></a>Подключение Azure Stack к Azure с помощью VPN

*Область применения: интегрированные системы Azure Stack*

В этой статье показано, как создать подключения VPN типа "сеть — сеть", чтобы подключить виртуальную сеть в Azure Stack к виртуальной сети в Azure.

### <a name="connection-diagram"></a>Схема подключения
На следующей схеме показано, как должна выглядеть конфигурация подключения после завершения:

![Конфигурация подключения VPN типа "сеть — сеть"](media/azure-stack-connect-vpn/image2.png)

### <a name="before-you-begin"></a>Перед началом работы
Чтобы выполнить конфигурацию подключения, перед началом работы убедитесь в наличии следующих компонентов:

* Развертывание (с несколькими узлами) интегрированных систем Azure Stack с прямым соединением с Интернетом. В этом случае доступ к внешнему общедоступному диапазону IP-адресов можно получить напрямую из общедоступного Интернета.
* Действующая подписка Azure.  Если у вас еще нет ее, создайте [бесплатную учетную запись здесь](https://azure.microsoft.com/free/?b=17.06).

## <a name="network-example-values-table"></a>Таблица примеров значений сети
В таблице ниже приведены примеры значений сети, используемые в этой статье. Эти значения можно использовать или просто просмотреть, чтобы лучше понимать примеры в этой статье.

**Таблица примеров значений сети**
|   |Azure Stack|Таблицы Azure|
|---------|---------|---------|
|Имя виртуальной сети     |Azs-VNet|AzureVNet |
|Адресное пространство виртуальной сети |10.1.0.0/16|10.100.0.0/16|
|Имя подсети     |FrontEnd|FrontEnd|
|Диапазон адресов подсети|10.1.0.0/24 |10.100.0.0/24 |
|Подсеть шлюза     |10.1.1.0/24|10.100.1.0/24|

## <a name="create-the-network-resources-in-azure"></a>Создание сетевых ресурсов в Azure

Сначала необходимо создать сетевые ресурсы Azure. Ниже показано, как это сделать на [портале Azure](http://portal.azure.com/).

### <a name="create-the-virtual-network-and-vm-subnet"></a>Создание виртуальной сети и подсети виртуальной машины

1. Войдите на [портал Azure](http://portal.azure.com/) с помощью учетной записи Azure.
2. На пользовательском портале щелкните **Создать**.
3. Щелкните **Marketplace**, а затем выберите **Сети**.
4. Щелкните **Виртуальная сеть**.
5. На основе значений из таблицы конфигурации сети определите **имя**, **адресное пространство**, **имя подсети** и **диапазон адресов подсети** Azure.
6. Создайте **группу ресурсов** или используйте имеющуюся, выбрав **Использовать существующий**.
7. Выберите **расположение** виртуальной сети.  Если вы используете примеры значений, выберите **Восточная часть США**. При желании укажите другое расположение.
8. Кроме того, установите флажок **Закрепить на панели мониторинга**.
9. Нажмите кнопку **Создать**.

### <a name="create-the-gateway-subnet"></a>Создание подсети шлюза
1. На панели мониторинга откройте созданный ресурс виртуальной сети (**AzureVNet**).
2. В разделе **Параметры** выберите **Подсети**.
3. Щелкните **Подсеть шлюза**, чтобы добавить подсеть шлюза в виртуальную сеть.
4. Подсети присвоено имя **GatewaySubnet** по умолчанию.
   Подсети шлюза являются специальными, и для правильной работы им должно быть присвоено конкретное имя.
5. Проверьте, указан ли в поле **Диапазон адресов** адрес **10.100.1.0/24**.
6. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.

### <a name="create-the-virtual-network-gateway"></a>Создание шлюза виртуальной сети
1. На портале Azure щелкните **Создать**.  
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке сетевых ресурсов выберите **Шлюз виртуальной сети**.
4. В поле **Имя** введите **Azure-GW**.
5. Чтобы выбрать виртуальную сеть, щелкните **Виртуальная сеть**. В списке выберите **AzureVnet**.
6. Выберите **Общедоступный IP-адрес**. В открывшейся колонке **Выбрать общедоступный IP-адрес** щелкните **Создать**.
7. В поле **Имя** введите **Azure-GW-PiP** и нажмите кнопку **ОК**.
8. По умолчанию для параметра **VPN type** (Тип VPN) установлено значение **Route-based** (На основе маршрута).
    **Не изменяйте** это значение.
9. Убедитесь, что для параметров **Подписка** и **Расположение** выбраны правильные значения. Ресурс можно закрепить на панели мониторинга. Нажмите кнопку **Создать**.

### <a name="create-the-local-network-gateway-resource"></a>Создание ресурса шлюза локальной сети

1. На портале Azure щелкните **Создать**. 
4. Щелкните **Marketplace**, а затем выберите **Сети**.
5. В списке сетевых ресурсов выберите **Local network gateway** (Шлюз локальной сети).
6. В поле **Имя** введите **Azs-GW**.
7. В поле **IP-адрес** введите общедоступный IP-адрес шлюза виртуальной сети Azure Stack, указанный ранее в таблице конфигурации сети.
8. В поле **Адресное пространство** (из Azure Stack) введите **10.1.0.0/24** и **10.1.1.0/24** для **AzureVNet**.
9. Проверьте, выбраны ли правильные значения полей **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **Создать**.

## <a name="create-the-connection"></a>Создание подключения
1. На пользовательском портале щелкните **Создать**. 
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке ресурсов выберите **Подключение**.
4. В разделе **основных** параметров установите в поле **Тип соединения** значение **Site-to-site (IPSec)** (Сеть — сеть (IPSec)).
5. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
6. В разделе **Параметры** выберите **Шлюз виртуальной сети**, а затем щелкните **Azure-GW**.
7. Выберите **Local network gateway** (Шлюз локальной сети), а затем щелкните **Azs-GW**.
8. В поле **Имя подключения** введите **Azure-Azs**.
9. В поле **Shared Key (PSK)** (Общий ключ (PSK)) введите **12345**. Если вы хотите использовать другое значение, помните, что оно *должно* совпадать со значением общего ключа, созданного на другом конце подключения. Нажмите кнопку **ОК**.
10. Просмотрите раздел **Сводка**, а затем нажмите кнопку **ОК**.

## <a name="create-a-virtual-machine"></a>Создание виртуальной машины
Создайте виртуальную машину в Azure и поместите ее в подсеть виртуальной машины в виртуальной сети.

1. На портале Azure щелкните **Создать**.
2. Щелкните **Marketplace**, а затем выберите **Вычисление**.
3. В списке образов виртуальных машин выберите образ **Windows Server 2016 Datacenter Eval**.
4. В разделе **Основные сведения** в поле **Имя** введите **AzureVM**.
5. Введите допустимое имя пользователя и пароль. С помощью этой учетной записи вы войдете на виртуальную машину после ее создания.
6. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
7. В разделе **Размер** выберите размер этого экземпляра виртуальной машины, а затем нажмите кнопку **Выбрать**.
8. В разделе **Параметры** можно принять значения по умолчанию. Проверьте, выбрана ли виртуальная сеть **AzureVnet** и задано ли для подсети значение **10.100.0.0/24**. Нажмите кнопку **ОК**.
9. Просмотрите параметры в разделе **Сводка**, а затем нажмите кнопку **ОК**.

## <a name="create-the-network-resources-in-azure-stack"></a>Создание сетевых ресурсов в Azure Stack
Далее необходимо создать сетевые ресурсы в Azure Stack.

### <a name="sign-in-as-a-user"></a>Вход в качестве пользователя
Администратор служб может войти в систему как пользователь, чтобы протестировать планы, предложения и подписки, которые могут использовать их пользователи. Если вы еще не [создали учетную запись пользователя](azure-stack-add-new-user-aad.md), сделайте это перед входом в систему.

### <a name="create-the-virtual-network-and-vm-subnet"></a>Создание виртуальной сети и подсети виртуальной машины
1. Войдите на пользовательский портал с помощью учетной записи пользователя.
2. На пользовательском портале щелкните **Создать**.

    ![Создание виртуальной сети](media/azure-stack-create-vpn-connection-one-node-tp2/image3.png)

3. Щелкните **Marketplace**, а затем выберите **Сети**.
4. Щелкните **Виртуальная сеть**.
5. Определите **имя**, **адресное пространство**, **имя подсети** и **диапазон адресов подсети** на основе значений из таблицы конфигурации сети.
6. В поле **Подписка** отображается созданная ранее подписка.
7. Создайте **группу ресурсов** или используйте имеющуюся, щелкнув **Использовать существующий**.
8. Проверьте значение расположения по умолчанию.
9. Кроме того, установите флажок **Закрепить на панели мониторинга**.
10. Нажмите кнопку **Создать**.

### <a name="create-the-gateway-subnet"></a>Создание подсети шлюза
1. На панели мониторинга откройте созданный ресурс виртуальной сети Azs-VNet.
2. В разделе **Параметры** выберите **Подсети**.
3. Чтобы добавить подсеть шлюза в виртуальную сеть, щелкните **Подсеть шлюза**.
   
    ![Добавление подсети шлюза](media/azure-stack-create-vpn-connection-one-node-tp2/image4.png)

4. По умолчанию подсети присвоено имя **GatewaySubnet**.
   Подсети шлюза имеют специальное назначение. Чтобы функционировать должным образом, они должны использовать имя *GatewaySubnet*.
5. Проверьте, задано ли в поле **Диапазон адресов** значение **10.1.1.0/24**.
6. Нажмите кнопку **ОК**, чтобы создать подсеть шлюза.

### <a name="create-the-virtual-network-gateway"></a>Создание шлюза виртуальной сети
1. На портале Azure Stack щелкните **Создать**. 
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке сетевых ресурсов выберите **Шлюз виртуальной сети**.
4. В поле **Имя** введите **Azs-GW**.
5. Выберите пункт **Виртуальная сеть**, чтобы выбрать виртуальную сеть.
   Выберите **Azs-VNet** в списке.
6. Выберите пункт меню **Общедоступный IP-адрес**. В открывшейся колонке **Выбрать общедоступный IP-адрес** щелкните **Создать**.
7. В поле **Имя** введите **Azs-GW-PiP**, а затем нажмите кнопку **ОК**.
8.  По умолчанию для параметра **VPN type** (Тип VPN) установлено значение **Route-based** (На основе маршрута).
    **Не изменяйте** это значение.
9. Убедитесь, что для параметров **Подписка** и **Расположение** выбраны правильные значения. Ресурс можно закрепить на панели мониторинга. Нажмите кнопку **Создать**.

### <a name="create-the-local-network-gateway"></a>Создание шлюза локальной сети
Понятие *шлюза локальной сети* в Azure Stack и развертывании Azure немного отличается.

В развертывании Azure шлюз локальной сети представляет локальное физическое устройство (в расположении пользователя), с помощью которого выполняется подключение к шлюзу виртуальной сети в Azure. В Azure Stack оба конца подключения являются шлюзами виртуальной сети.

Проще говоря, ресурс шлюза локальной сети предназначен для указания удаленного шлюза на другом конце подключения. 

### <a name="create-the-local-network-gateway-resource"></a>Создание ресурса шлюза локальной сети
1. Войдите на портал Azure Stack.
2. На пользовательском портале щелкните **Создать**.
3. Щелкните **Marketplace**, а затем выберите **Сети**.
4. В списке сетевых ресурсов выберите **Local network gateway** (Шлюз локальной сети).
5. В поле **Имя** введите **Azure-GW**.
6. В поле **IP-адрес** введите общедоступный IP-адрес шлюза виртуальной сети **Azure-GW-PiP**. Этот адрес приведен в таблице конфигурации сети.
7. В поле **Адресное пространство** созданной виртуальной сети Azure введите **10.100.0.0/24** и **10.100.1.0/24**.
8. Проверьте, выбраны ли правильные значения полей **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **Создать**.

### <a name="create-the-connection"></a>Создание подключения
1. На пользовательском портале щелкните **Создать**.
2. Щелкните **Marketplace**, а затем выберите **Сети**.
3. В списке ресурсов выберите **Подключение**.
4. В разделе **основных** параметров установите в поле **Тип соединения** значение **Site-to-site (IPSec)** (Сеть — сеть (IPSec)).
5. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
6. В разделе **Параметры** выберите **Шлюз виртуальной сети**, а затем щелкните **Azs-GW**.
7. Выберите **Local network gateway** (Шлюз локальной сети), а затем щелкните **Azure-GW**.
8. В поле **Имя подключения** введите **Azs-Azure**.
9. В поле **Shared Key (PSK)** (Общий ключ (PSK)) введите **12345**, а затем нажмите кнопку **ОК**.
10. В разделе **Сводка** нажмите кнопку **ОК**.

### <a name="create-a-vm"></a>Создание виртуальной машины
Чтобы проверять данные, проходящие через VPN-подключение, необходимо создать виртуальные машины на каждом конце, которые отправляют и получают данные через туннель VPN. 

1. На портале Azure щелкните **Создать**.
2. Щелкните **Marketplace**, а затем выберите **Вычисление**.
3. В списке образов виртуальных машин выберите образ **Windows Server 2016 Datacenter Eval**.
4. В разделе **Основные сведения** в поле **Имя** введите **Azs-VM**.
5. Введите допустимое имя пользователя и пароль. С помощью этой учетной записи вы войдете на виртуальную машину после ее создания.
6. Заполните поля **Подписка**, **Группа ресурсов** и **Расположение**, а затем нажмите кнопку **ОК**.
7. В разделе **Размер** выберите размер этого экземпляра виртуальной машины, а затем нажмите кнопку **Выбрать**.
8. В разделе **Параметры** примите значения по умолчанию. Проверьте, выбрана ли виртуальная сеть **Azs-VNet** и задано ли для подсети значение **10.1.0.0/24**. Нажмите кнопку **ОК**.
9. Просмотрите параметры в разделе **Сводка**, а затем нажмите кнопку **ОК**.


## <a name="test-the-connection"></a>Проверка подключения
Теперь, когда подключение типа "сеть —сеть" установлено, необходимо проверить, может ли трафик проходить через него. Чтобы проверить, войдите на одну из виртуальных машин, созданных в Azure Stack. Затем проверьте связь виртуальной машины, созданной в Azure. 

Чтобы убедиться, что вы передаете трафик через подключение типа "сеть — сеть", проверьте связь через прямой IP-адрес (DIP) виртуальной машины в удаленной подсети, а не виртуальный IP-адрес. Чтобы сделать это, найдите прямой IP-адрес на другом конце подключения. Сохраните этот адрес для последующего использования.

### <a name="sign-in-to-the-user-vm-in-azure-stack"></a>Вход на пользовательскую виртуальную машину в Azure Stack
1. Войдите на портал Azure Stack.
2. На панели навигации слева выберите **Виртуальные машины**.
3. В списке виртуальных машин найдите созданную ранее виртуальную машину **Azs-VM** и выберите ее.
4. В разделе этой виртуальной машины нажмите кнопку **Подключение**, а затем откройте файл Azs-VM.rdp.
   
     ![Кнопка "Подключение"](media/azure-stack-create-vpn-connection-one-node-tp2/image17.png)
5. Войдите в систему с помощью учетной записи, настроенной при создании виртуальной машины.
6. Откройте окно **Windows PowerShell** с повышенными привилегиями.
7. Введите **ipconfig /all**.
8. В выходных данных найдите **IPv4-адрес** и сохраните его для дальнейшего использования. Это адрес, с помощью которого вы проверите связь из Azure. В примере среды указан адрес **10.1.0.4**, но в вашем окружении он может быть другим. Адрес должен находиться в пределах созданной ранее подсети **10.1.0.0/24**.
9. Чтобы создать правило брандмауэра, позволяющее виртуальной машине реагировать на запросы проверки связи, выполните следующую команду PowerShell:

   ```powershell
   New-NetFirewallRule `
    –DisplayName “Allow ICMPv4-In” `
    –Protocol ICMPv4
   ```

### <a name="sign-in-to-the-tenant-vm-in-azure"></a>Вход на виртуальную машину клиента в Azure
1. Войдите на портал Azure.
2. В области навигации слева щелкните **Виртуальные машины**.
3. В списке виртуальных машин найдите созданную ранее виртуальную машину **Azure-VM** и выберите ее.
4. В разделе виртуальной машины нажмите кнопку **Подключение**.
5. Войдите в систему с помощью учетной записи, настроенной при создании виртуальной машины.
6. Откройте окно **Windows PowerShell** с повышенными привилегиями.
7. Введите **ipconfig /all**.
8. Должен отобразиться IPv4-адрес, находящийся в диапазоне **10.100.0.0/24**. В этом примере окружения используется адрес **10.100.0.4**, но вы можете использовать другой адрес.
9. Чтобы создать правило брандмауэра, позволяющее виртуальной машине реагировать на запросы проверки связи, выполните следующую команду PowerShell:

   ```powershell
   New-NetFirewallRule `
    –DisplayName “Allow ICMPv4-In” `
    –Protocol ICMPv4
   ```

10. На виртуальной машине в Azure проверьте связь с виртуальной машиной в Azure Stack через туннель. Для этого проверьте связь с прямым IP-адресом, записанным из виртуальной машины Azs-VM.
   В этом примере окружения используется адрес — **10.1.0.4**, но вам следует использовать адрес, записанный в лаборатории. Должен появиться результат, как на следующем снимке экрана:
   
    ![Успешная проверка связи](media/azure-stack-create-vpn-connection-one-node-tp2/image19b.png)
11. Ответ из удаленной виртуальной машины указывает, что проверка выполнена успешно. Вы можете закрыть окно виртуальной машины. Чтобы проверить подключение, вы можете выполнить другие передачи данных, например копирование файлов.

### <a name="viewing-data-transfer-statistics-through-the-gateway-connection"></a>Просмотр статистики передачи данных через подключение шлюза
Если вы хотите узнать, какой объем данных передается через подключение типа "сеть — сеть", просмотрите раздел **Подключение**. Эта проверка также позволяет убедиться в том, что проверка связи действительно прошла через VPN-подключение.

1. На виртуальной машине в Azure Stack войдите на пользовательский портал с помощью учетной записи пользователя.
2. Щелкните **Все ресурсы**, а затем выберите подключение **Azs-Azure**. После этого отобразятся **подключения**.
4. В разделе **Подключение** в полях **Входящие данные** и **Исходящие данные** отобразится статистика. На снимке экрана ниже указаны большие числа, что обеспечивает дополнительную передачу файлов. Там будут отображаться ненулевые значения.
   
    ![Входящие и исходящие данные](media/azure-stack-connect-vpn/Connection.png)

## <a name="next-steps"></a>Дополнительная информация

[Развертывание приложений в Azure и Azure Stack](azure-stack-solution-pipeline.md)
