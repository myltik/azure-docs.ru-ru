---
title: Управление емкостью хранилища в Azure Stack | Документация Майкрософт
description: Мониторинг доступного объема хранилища и управление им для Azure Stack.
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.assetid: b0e694e4-3575-424c-afda-7d48c2025a62
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: PowerShell
ms.topic: get-started-article
ms.date: 05/10/2018
ms.author: mabrigg
ms.reviewer: xiaofmao
ms.openlocfilehash: da6bb00d7538c1a26e1ed4be29d3c882aa378e9e
ms.sourcegitcommit: fc64acba9d9b9784e3662327414e5fe7bd3e972e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/12/2018
ms.locfileid: "34077417"
---
# <a name="manage-storage-capacity-for-azure-stack"></a>Управление емкостью хранилища для Azure Stack

*Область применения: интегрированные системы Azure Stack и Пакет средств разработки Azure Stack*

Сведения в этой статье помогают оператору облака Azure Stack отслеживать емкость хранилища развертывания Azure Stack и управлять ею. Инфраструктура хранилища Azure Stack выделяет для развертывания Azure Stack часть от общей емкости хранилища для использования **службами хранения**. Службы хранения сохраняют данные клиента в общих ресурсах на томах, которые соответствуют узлам развертывания.

Как у оператора облака, у вас есть ограниченный объем хранилища для работы. Объем хранилища определяется реализуемым решением. Решение предоставляется поставщиком OEM при использовании решения с несколькими узлами или оборудованием, на котором устанавливается Пакет средств разработки Azure Stack.

Так как Azure Stack не поддерживает расширение емкости хранилища, для обеспечения эффективной работы важно [отслеживать](#monitor-shares) доступный объем хранилища.  

Когда остается ограниченный объем емкости общего ресурса, запланируйте [управление пространством](#manage-available-space), чтобы предотвратить нехватку емкости в общих ресурсах.

Варианты управления емкостью включают:
- Освобождение емкости
- Перенос контейнера

Если общий ресурс используется полностью, служба хранения больше не функционирует для него. Чтобы получить помощь в восстановлении операций для общих ресурсов, обратитесь в службу поддержки Майкрософт.

## <a name="understand-volumes-and-shares-containers-and-disks"></a>Общие сведения о томах, общих ресурсах, контейнерах и дисках
### <a name="volumes-and-shares"></a>Тома и общие ресурсы
*Служба хранения* разделяет доступное хранилище на равнозначные тома, которые выделены для хранения данных клиента. Количество томов равно количеству узлов в развертывании Azure Stack:

- В развертывании с четырьмя узлами есть четыре тома. Каждый том имеет один общий ресурс. В развертывании с несколькими узлами число общих ресурсов не уменьшается, если узел удален или неисправен.
- Если используется комплект разработчика Azure Stack, есть один том с одним ресурсом.

Так как общие ресурсы службы хранения предназначены для монопольного использования этими службами, не нужно напрямую изменять, добавлять или удалять какие-либо файлы в общих ресурсах. Только службы хранения должны работать с файлами, хранящимися в этих томах.

Общие ресурсы в томах хранят данные клиента. К данным клиента относятся страничные BLOB-объекты, блочные BLOB-объекты, добавочные большие двоичные объекты, таблицы, очереди, базы данных и связанные хранилища метаданных. Так как объекты хранилища (большие двоичные объекты и т. д.) по отдельности находятся в одном общем ресурсе, максимальный размер каждого объекта не может превышать размер общего ресурса. Максимальный размер новых объектов зависит от емкости, которая остается в общем ресурсе в качестве неиспользуемого пространства при создании нового объекта.

Если у общего ресурса недостаточно свободного места, а действия по [освобождению](#reclaim-capacity) места не были выполнены или недоступны, оператор облака Azure Stack может [перенести](#migrate-a-container-between) контейнеры больших двоичных объектов из одного общего ресурса в другой.

- Дополнительные сведения о контейнерах и больших двоичных объектах см. в подпункте [Хранилище BLOB-объектов](azure-stack-key-features.md#blob-storage) статьи "Общие сведения о хранилище Azure Stack".
- См. дополнительные сведения о том, как пользователи клиента взаимодействуют с [хранилищем BLOB-объектов в Azure Stack](/azure/azure-stack/user/azure-stack-storage-overview#azure-stack-storage-services).


### <a name="containers"></a>Контейнеры
Пользователи клиента создают контейнеры, которые затем используются для хранения данных больших двоичных объектов. Пока пользователь решает, в каком контейнере размещать большие двоичные объекты, служба хранения использует алгоритм, чтобы определить, в каком томе разместить контейнер. Алгоритм обычно выбирает том с наибольшим количеством свободного места.  

Большой двоичный объект после размещения в контейнере может увеличиться и занимать больше места. По мере добавления новых больших двоичных объектов и увеличения имеющихся доступное пространство в томе, который содержит этот контейнер, уменьшается.  

Контейнеры не ограничены одним общим ресурсом. Когда объединенные данные большого двоичного объекта в контейнере растут и используют 80 % свободного места и более, контейнер переходит в режим *переполнения*. В режиме переполнения все большие двоичные объекты, созданные в этом контейнере, выделяются на другой том, где есть достаточно места. Со временем контейнер в режиме переполнения сможет иметь большие двоичные объекты, распределенные между несколькими томами.

Если 80 %, а затем 90 % доступного места в томе используется, система вызывает оповещения на портале администратора Azure Stack. Операторам облака необходимо просмотреть доступную емкость хранилища и запланировать перераспределение содержимого. Служба хранения перестает работать, когда диск используется на 100 %. Никакие дополнительные оповещения не поступают.

### <a name="disks"></a>диски;
Диски виртуальных машин добавляются в контейнеры клиентами и включают в себя диск операционной системы. Виртуальные машины также могут иметь один или несколько дисков данных. Оба типа дисков хранятся в качестве страничных BLOB-объектов. Клиенты должны размещать каждый диск в отдельном контейнере для повышения производительности виртуальной машины.
- Каждый контейнер, хранящий диск виртуальной машины (страничный BLOB-объект), считается присоединенным контейнером к виртуальной машине, которой принадлежит диск.
- Контейнер, который не содержит дисков виртуальных машин, считается свободным контейнером.

Варианты освобождения места в прикрепленном контейнере [ограничены](#move-vm-disks).
> [!TIP]  
> Операторы облака напрямую не управляют дисками, подключаемыми к виртуальным машинам, которые клиенты могут добавить в контейнер. Однако при планировании управления пространством в общих ресурсах хранения важно понимать, как диски относятся к контейнерам и общим ресурсам.

## <a name="monitor-shares"></a>Мониторинг общих ресурсов
Используйте PowerShell или портал администратора для мониторинга общих ресурсов, чтобы знать, когда свободное пространство ограничено. При использовании портала можно получать оповещения об общих ресурсах, в которых мало места.    

### <a name="use-powershell"></a>Использование PowerShell
Оператор облака может отслеживать емкость хранения в общем ресурсе с помощью командлета PowerShell **Get-AzsStorageShare**. Командлет Get-AzsStorageShare возвращает общее, выделенное и свободное место в байтах для каждого общего ресурса.   
![Пример. Возвращение показателя свободного места для общих ресурсов](media/azure-stack-manage-storage-shares/free-space.png)

- **Общая емкость** — это общее место в байтах, доступное в общем ресурсе. Это пространство используется для данных и метаданных, обрабатываемых службами хранения.
- **Используемая емкость** — это объем данных в байтах, используемый всеми экстентами из файлов, в которых хранятся данные клиента и связанные метаданные.

### <a name="use-the-administrator-portal"></a>Использование портала администрирования
Оператор облака может использовать портал администрирования для просмотра емкости всех общих ресурсов. Выберите **Хранилище** > **Общие файловые ресурсы**, чтобы открыть список общих файловых ресурсов, в котором можно просмотреть сведения об использовании.
![Пример. Общие файловые ресурсы хранилища](media/azure-stack-manage-storage-shares/storage-file-shares.png)
- **Всего**. Это общее место в байтах, доступное в общем ресурсе. Это пространство используется для данных и метаданных, обрабатываемых службами хранения.
- **Используется**. Это объем данных в байтах, используемый всеми экстентами из файлов, в которых хранятся данные клиента и связанные метаданные.

### <a name="storage-space-alerts"></a>Оповещения о дисковом пространстве
При использовании портала администрирования можно получать оповещения об общих ресурсах, в которых мало места.

> [!IMPORTANT]
> Как оператор облака предотвращайте полное использование общих ресурсов. Если общий ресурс используется полностью, служба хранения больше не функционирует для него. Чтобы освободить пространство и восстановить операции в общем ресурсе, который полностью используется, нужно обратиться в службу поддержки Майкрософт.

**Предупреждение**. Когда общий файловый ресурс используется на более чем 80 %, вы получите оповещение типа *Предупреждение* на портале администрирования ![Пример. Предупреждающее оповещение](media/azure-stack-manage-storage-shares/alert-warning.png).


**Критическое**. Когда общий файловый ресурс используется более чем на 90 %, вы получите оповещение типа *Критическое* на портале администрирования ![Пример. Критическое оповещение](media/azure-stack-manage-storage-shares/alert-critical.png).

**Просмотр сведений**. На портале администрирования можно открыть сведения для просмотра параметров устранения оповещения. ![Пример. Просмотр сведений о предупреждении](media/azure-stack-manage-storage-shares/alert-details.png).


## <a name="manage-available-space"></a>Управление доступным местом
Когда необходимо освободить место в общем ресурсе, сначала используйте наименее агрессивные методы. Например, попробуйте освободить место, прежде чем переносить контейнер.  

### <a name="reclaim-capacity"></a>Освобождение емкости
*Этот вариант применяется как для развертываний с несколькими узлами, так и к Пакету средств разработки Azure Stack.*

Можно освободить емкость, используемую учетными записями клиента, которые были удалены. Эта емкость автоматически освобождается при истечении [срока хранения данных](azure-stack-manage-storage-accounts.md#set-the-retention-period) (или же вы можете немедленно освободить ее).

Дополнительные сведения см. в разделе [Освобождение емкости](azure-stack-manage-storage-accounts.md#reclaim) в статье "Управление учетными записями хранения в Azure Stack".

### <a name="migrate-a-container-between-volumes"></a>Перенос контейнера между томами
*Этот вариант применяется только к системам с несколькими узлами.*

Из-за шаблонов использования клиентами некоторые клиентские общие ресурсы используют больше места, чем другие. В результате в общем ресурсе может заканчиваться свободное пространство, тогда как другие общие ресурсы практически не используются.

Попробуйте освободить место в общих ресурсах с большой нагрузкой вручную, перенеся некоторые контейнеры больших двоичных объектов в другой общий ресурс. Несколько контейнеров меньшего размера можно перенести в один общий ресурс, где достаточно места, чтобы хранить их все. Можно использовать миграцию для перемещения *свободных* контейнеров. Свободные контейнеры — это контейнеры, которые не содержат диски виртуальных машин.   

При миграции все контейнеры больших двоичных объектов объединяются в новом общем ресурсе.

- Если контейнер перешел в режим переполнения и поместил большие двоичные объекты в дополнительные тома, в новом общем ресурсе должно быть достаточно емкости для хранения всех больших двоичных объектов контейнера, который нужно перенести. Сюда входят большие двоичные объекты, расположенные в дополнительных общих ресурсах.

- Командлет PowerShell *Get-AzsStorageContainer* определяет только пространство, используемое в изначальном томе контейнера. Он не определяет пространство, которое используется большими двоичными объектами, помещенными в дополнительные тома. Поэтому полный размер контейнера может быть не очевиден. Консолидация контейнера в новом общем ресурсе может вызвать состояние переполнения ресурса, и данные будут помещаться в дополнительные общие ресурсы. В результате может потребоваться повторно перераспределить общие ресурсы.

- Если разрешения на использование группы ресурсов отсутствуют и вы не можете использовать PowerShell для запроса дополнительных томов для избыточных данных, совместно с владельцем этих групп ресурсов и контейнеров оцените общий объем данных для переноса, прежде чем переносить их.  

> [!IMPORTANT]
> Перенос больших двоичных объектов для контейнера является автономной операцией, требующей использования PowerShell. До завершения переноса все большие двоичные объекты для переносимого контейнера остаются в автономном режиме и не могут использоваться. Также не следует обновлять Azure Stack до завершения всех текущих операций миграции.

#### <a name="to-migrate-containers-using-powershell"></a>Перенос контейнеров с помощью PowerShell
1. Проверьте, [установлена и настроена ли среда Azure PowerShell](http://azure.microsoft.com/documentation/articles/powershell-install-configure/). Дополнительные сведения см. в статье [Использование Azure PowerShell с диспетчером ресурсов Azure](http://go.microsoft.com/fwlink/?LinkId=394767).
2.  Изучите контейнер, чтобы понять, какие данные находятся в общем ресурсе, который планируется перенести. Чтобы определить наиболее подходящие для переноса контейнеры в томе, используйте командлет **Get-AzsStorageContainer**:

    ````PowerShell  
    $farm_name = (Get-AzsStorageFarm)[0].name
    $shares = Get-AzsStorageShare -FarmName $farm_name
    $containers = Get-AzsStorageContainer -ShareName $shares[0].ShareName -FarmName $farm_name
    ````
    Затем проверьте значение $containers:

    ````PowerShell
    $containers
    ````

    ![Пример. $Containers](media/azure-stack-manage-storage-shares/containers.png)

3.  Определите наиболее подходящие общие ресурсы назначения для хранения контейнера, который переносится:

    ````PowerShell
    $destinationshares = Get-AzsStorageShare -SourceShareName
    $shares[0].ShareName -Intent ContainerMigration
    ````

    Затем проверьте значение $destinationshares:

    ````PowerShell $destinationshares
    ````

    ![Example: $destination shares](media/azure-stack-manage-storage-shares/examine-destinationshares.png)

4. Start migration for a container. Migration is asynchronous. If you start migration of additional containers before the first migration completes, use the job id to track the status of each.

  ````PowerShell
  $job_id = Start-AzsStorageContainerMigration -StorageAccountName $containers[0].Accountname -ContainerName $containers[0].Containername -ShareName $containers[0].Sharename -DestinationShareUncPath $destinationshares[0].UncPath -FarmName $farm_name
  ````

  Затем проверьте значение $jobId. В следующем примере замените *d62f8f7a-8b46-4f59-a8aa-5db96db4ebb0* идентификатором задания, которое нужно просмотреть:

  ````PowerShell
  $jobId
  d62f8f7a-8b46-4f59-a8aa-5db96db4ebb0
  ````

5. Используйте идентификатор задания, чтобы проверить состояние задания переноса. По завершении переноса параметру **MigrationStatus** присваивается значение **Complete**.

  ````PowerShell 
  Get-AzsStorageContainerMigrationStatus -JobId $job_id -FarmName $farm_name
  ````

  ![Пример. Состояние переноса](media/azure-stack-manage-storage-shares/migration-status1.png)

6.  Вы можете отменить выполняющиеся задания переноса. Отмененные задания переноса обрабатываются асинхронно. Отслеживать отмену можно с помощью $jobid:

  ````PowerShell
  Stop-AzsStorageContainerMigration -JobId $job_id -FarmName $farm_name
  ````

  ![Пример. Состояние отката](media/azure-stack-manage-storage-shares/rollback.png)

7. Вы можете выполнить команду из шага 6 еще раз, пока состояние задания переноса не получит значение **Canceled**:  

    ![Пример. Состояние "Canceled" (Отменено)](media/azure-stack-manage-storage-shares/cancelled.png)

### <a name="move-vm-disks"></a>Перемещение дисков виртуальной машины
*Этот вариант применяется только к системам с несколькими узлами.*

Перемещение дисков виртуальной машины применяется как метод управления пространством в крайнем случае. Так как перемещение вложенного контейнера (содержащего диск виртуальной машины) является сложной задачей, обратитесь в службу поддержки Майкрософт, чтобы выполнить это действие.

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения см. в статье [Предоставление виртуальных машин для пользователей Azure Stack](azure-stack-tutorial-tenant-vm.md).
