---
title: Ранний выпуск с помощью Vamp в кластере DC/OS Azure
description: Узнайте, как использовать Vamp для раннего выпуска служб и применения интеллектуальной фильтрации трафика в кластере DC/OS Службы контейнеров Azure.
services: container-service
author: gggina
manager: jeconnoc
ms.service: container-service
ms.topic: article
ms.date: 04/17/2017
ms.author: rasquill
ms.custom: mvc
ms.openlocfilehash: 339864f6261d031a21b138f880654bcd6ef51855
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32177807"
---
# <a name="canary-release-microservices-with-vamp-on-an-azure-container-service-dcos-cluster"></a>Ранний выпуск микрослужб с помощью Vamp в кластере DC/OS Службы контейнеров Azure

В этом пошаговом руководстве мы настраиваем Vamp в Службе контейнеров Azure, используя кластер DC/OS. Мы создаем ранний выпуск демоверсии службы Vamp "sava", а затем устраняем несовместимость этой службы с Firefox, применив интеллектуальную фильтрацию трафика. 

> [!TIP] 
> В этом пошаговом руководстве Vamp выполняется в кластере DC/OS, но в качестве оркестратора для Vamp также можно использовать Kubernetes.
>

## <a name="about-canary-releases-and-vamp"></a>О ранних выпусках и Vamp


Функция [раннего выпуска](https://martinfowler.com/bliki/CanaryRelease.html) — это интеллектуальная стратегия развертывания, активно применяемая в таких инновационных компаниях, как Netflix, Facebook и Spotify. Такой подход полностью обоснован, так как он сокращает вероятность возникновения проблем, формирует сети безопасности и повышает уровень инноваций. Почему же его применяют не все компании? Расширение конвейера CI/CD за счет внедрения стратегий ранних выпусков повышает сложность системы и требует значительных знаний и опыта в области разработки и выполнения операций. Этого достаточно для блокировки небольших компаний и предприятий еще до того, как они приступят к работе. 

[Vamp](http://vamp.io/) — система с открытым исходным кодом, разработанная для того, чтобы упростить этот переход и реализовать функции ранних выпусков в вашем планировщике контейнеров. Функция раннего выпуска в Vamp предоставляет больше возможностей, чем выпуски на основе процентов. Трафик можно отфильтровать и разделить, используя широкий диапазон условий, например для ориентирования на определенных пользователей, диапазоны IP-адресов или устройства. Vamp отслеживает и анализирует метрики производительности, позволяя обеспечить автоматизацию на основе реальных данных. Можно настроить автоматический откат в случае возникновения ошибок или масштабировать индивидуальные варианты службы на основе нагрузки или задержки.

## <a name="set-up-azure-container-service-with-dcos"></a>Настройка Службы контейнеров Azure с помощью DC/OS



1. [Разверните кластер DC/OS](container-service-deployment.md) с одним главным узлом и двумя агентами, имеющими размер по умолчанию. 

2. [Создайте туннель SSH](../container-service-connect.md) для подключения к кластеру DC/OS. В этой статьей предполагается, что вы создаете туннель к кластеру на локальном порте 80.


## <a name="set-up-vamp"></a>Настройка Vamp

Теперь, когда кластер DC/OS работает, можно установить Vamp из пользовательского интерфейса DC/OS (http://localhost:80). 

![Пользовательский интерфейс DC/OS](./media/container-service-dcos-vamp-canary-release/01_set_up_vamp.png)

Установка выполняется в два этапа:

1. **Разверните Elasticsearch**.

2. Затем **разверните Vamp**, установив пакет Vamp DC/OS Universe.

### <a name="deploy-elasticsearch"></a>Развертывание Elasticsearch

Vamp требуется Elasticsearch для сбора метрик и агрегации. Для развертывания совместимого стека Elasticsearch для Vamp можно использовать [образы Docker magneticio](https://hub.docker.com/r/magneticio/elastic/).

1. В пользовательском интерфейсе DC/OS перейдите к разделу **Services** (Службы) и щелкните **Deploy Service** (Развернуть службу).

2. Во всплывающем окне **Deploy New Service** (Развертывание новой службы) выберите **JSON mode** (Режим JSON).

  ![Выбор режима JSON](./media/container-service-dcos-vamp-canary-release/02_deploy_service_json_mode.png)

3. Вставьте приведенный ниже код JSON. Эта конфигурация запускает контейнер с ОЗУ объемом 1 ГБ и обычную проверку работоспособности на порте Elasticsearch.
  
  ```JSON
  {
    "id": "elasticsearch",
    "instances": 1,
    "cpus": 0.2,
    "mem": 1024.0,
    "container": {
      "docker": {
        "image": "magneticio/elastic:2.2",
        "network": "HOST",
        "forcePullImage": true
      }
    },
    "healthChecks": [
      {
        "protocol": "TCP",
        "gracePeriodSeconds": 30,
        "intervalSeconds": 10,
        "timeoutSeconds": 5,
        "port": 9200,
        "maxConsecutiveFailures": 0
      }
    ]
  }
  ```
  

3. Щелкните **Развернуть**.

  DC/OS развертывает контейнер Elasticsearch. Ход выполнения операции можно отслеживать на странице **Services** (Службы).  

  ![Развертывание Elasticsearch](./media/container-service-dcos-vamp-canary-release/03_deply_elasticsearch.png)

### <a name="deploy-vamp"></a>Развертывание Vamp

Когда в Elasticsearch отобразится состояние **Running** (Выполняется), можно добавить пакет Vamp DC/OS Universe. 

1. Перейдите в раздел **Universe** и выполните поиск по слову **vamp**. 
  ![Vamp на DC/OS Universe](./media/container-service-dcos-vamp-canary-release/04_universe_deploy_vamp.png)

2. Нажмите кнопку **install** (установить) напротив пакета Vamp и выберите **Advanced Installation** (Дополнительные параметры установки).

3. Прокрутите вниз и введите следующий адрес elasticsearch-url: `http://elasticsearch.marathon.mesos:9200`. 

  ![Введение URL-адреса Elasticsearch](./media/container-service-dcos-vamp-canary-release/05_universe_elasticsearch_url.png)

4. Нажмите кнопку **Review and Install** (Просмотреть и установить), а затем щелкните **Install** (Установить), чтобы начать развертывание.  

  DC/OS развертывает все необходимые компоненты Vamp. Ход выполнения операции можно отслеживать на странице **Services** (Службы).
  
  ![Развертывание Vamp как пакета Universe](./media/container-service-dcos-vamp-canary-release/06_deploy_vamp.png)
  
5. По завершении развертывания можно получить доступ к пользовательскому интерфейсу Vamp.

  ![Служба Vamp в DC/OS](./media/container-service-dcos-vamp-canary-release/07_deploy_vamp_complete.png)
  
  ![Пользовательский интерфейс Vamp](./media/container-service-dcos-vamp-canary-release/08_vamp_ui.png)


## <a name="deploy-your-first-service"></a>Развертывание первой службы

Теперь, когда Vamp запущена и работает, разверните службу из схемы. 

Самая простая форма [схемы Vamp](http://vamp.io/documentation/using-vamp/blueprints/) описывает конечные точки (шлюзы), кластеры и службы, которые необходимо развернуть. Vamp использует кластеры, чтобы сгруппировать различные варианты одной службы в логические группы для раннего выпуска или A/B-тестирования.  

В этом сценарии используется пример монолитного приложения с именем [**sava**](https://github.com/magneticio/sava), которое имеет версию 1.0. Монолит упакован в контейнер Docker, который находится в Docker Hub в разделе magneticio/sava:1.0.0. Приложение обычно работает через порт 8080, но в нашем случае необходимо предоставить к нему доступ через порт 9050. Разверните приложение через Vamp, используя простую схему.

1. Перейдите в раздел **Deployments** (Развертывания).

2. Щелкните **Добавить**.

3. Вставьте приведенный ниже YAML-файл схемы. Эта схема содержит один кластер только с одним вариантом службы, который мы изменим в дальнейшем:

  ```YAML
  name: sava                        # deployment name
  gateways:
    9050: sava_cluster/webport      # stable endpoint
  clusters:
    sava_cluster:               # cluster to create
     services:
        -
          breed:
            name: sava:1.0.0        # service variant name
            deployable: magneticio/sava:1.0.0
            ports:
              webport: 8080/http # cluster endpoint, used for canary releasing
  ```

4. Выберите команду **Сохранить**. Vamp инициирует развертывание.

Развертывание отображается на странице **Deployments** (Развертывания). Щелкните развертывание, чтобы отследить его состояние.

![Пользовательский интерфейс Vamp: развертывание sava](./media/container-service-dcos-vamp-canary-release/09_sava100.png)

![Служба sava в пользовательском интерфейсе Vamp](./media/container-service-dcos-vamp-canary-release/09a_sava100.png)

Создаются два шлюза, которые перечислены на странице **Gateways** (Шлюзы):

* стабильная конечная точка для доступа к выполняющейся службе (порт 9050); 
* внутренний шлюз, управляемый Vamp (позже мы рассмотрим этот шлюз подробнее). 

![Пользовательский интерфейс Vamp: шлюзы sava](./media/container-service-dcos-vamp-canary-release/10_vamp_sava_gateways.png)

Служба sava развернута, но внешний доступ к ней недоступен, так как Azure Load Balancer пока не может перенаправлять в нее трафик. Для доступа к службе обновите конфигурацию сети Azure.


## <a name="update-the-azure-network-configuration"></a>Обновление конфигурации сети Azure

Vamp развернула службу sava на узлах агента DC/OS, предоставив стабильную конечную точку на порте 9050. Для доступа к службе из-за пределов кластера DC/OS в развертывании кластера необходимо внести следующие изменения в конфигурацию сети Azure: 

1. **Настройте Azure Load Balancer** для агентов (ресурс с именем **dcos-agent-lb-xxxx**) с проверкой работоспособности и правилом перенаправления трафика с порта 9050 в экземпляры sava. 

2. **Обновите группу безопасности сети** для общедоступных агентов (ресурс с именем **XXXX-agent-public-nsg-XXXX**), чтобы разрешить трафик с порта 9050.

Подробные инструкции по выполнению этих задач с помощью портала Azure см. в статье [Предоставление общего доступа к приложению Службы контейнеров Azure](container-service-enable-public-access.md). Укажите порт 9050 для всех параметров портов.


Когда все создано, перейдите к колонке **Overview** (Обзор) подсистемы балансировки нагрузки агента DC/OS (ресурс с именем **dcos-agent-lb-xxxx**). Найдите **Public IP address** (Общедоступный IP-адрес) и используйте этот адрес для доступа к службе sava через порт 9050.

![Портал Azure: получение общедоступного IP-адреса](./media/container-service-dcos-vamp-canary-release/18_public_ip_address.png)

![sava](./media/container-service-dcos-vamp-canary-release/19_sava100.png)


## <a name="run-a-canary-release"></a>Запуск раннего выпуска

Предположим, что у вас есть новая версия этого приложения, для которой требуется создать ранний выпуск и запустить его в рабочей среде. Вы поместили ее в контейнер как magneticio/sava:1.1.0, и все готово для начала процесса. Vamp позволяет легко добавлять новые службы в работающую развернутую систему. Эти "объединенные" службы развертываются параллельно с существующими службами в кластере, и им назначается вес 0 %. Трафик не направляется во вновь объединенные службы, пока вы не настроите распределение трафика. Ползунок веса в пользовательском интерфейсе Vamp дает полный контроль над распределением, позволяя выполнять добавочные корректировки (ранний выпуск) или мгновенный откат.

### <a name="merge-a-new-service-variant"></a>Объединение нового варианта службы

Чтобы объединить новую службу sava 1.1 с работающей развернутой системой, выполните следующие действия:

1. В пользовательском интерфейсе Vamp щелкните **Blueprints** (Схемы).

2. Щелкните **Add** (Добавить) и вставьте приведенный ниже YAML-файл схемы. Эта схема описывает новый вариант службы (sava:1.1.0) для развертывания в существующем кластере (sava_cluster).

  ```YAML
  name: sava:1.1.0      # blueprint name
  clusters:
    sava_cluster:       # cluster to update
      services:
        -
          breed:
            name: sava:1.1.0    # service variant name
            deployable: magneticio/sava:1.1.0    
            ports:
              webport: 8080/http # cluster endpoint to update
  ```
  
3. Выберите команду **Сохранить**. Схема сохраняется и отображается на странице **Blueprints** (Схемы).

4. Откройте меню действий схемы sava:1.1 и выберите команду **Merge to** (Объединить с).

  ![Пользовательский интерфейс Vamp: схемы](./media/container-service-dcos-vamp-canary-release/20_sava110_mergeto.png)

5. Выберите развертывание **sava** и нажмите кнопку **Merge** (Объединить).

  ![Пользовательский интерфейс Vamp: объединение схемы с развертыванием](./media/container-service-dcos-vamp-canary-release/21_sava110_merge.png)

Vamp развертывает новый вариант службы sava:1.1.0, описанный в схеме, наряду с sava:1.0.0 в кластере **sava_cluster** работающей развернутой системы. 

![Пользовательский интерфейс Vamp: обновленное развертывание sava](./media/container-service-dcos-vamp-canary-release/22_sava_cluster.png)

Шлюз **sava/sava_cluster/webport** (конечная точка кластера) также обновляется, добавляя маршрут к развернутой службе sava:1.1.0. На этом этапе трафик в службу не перенаправляется (параметру **WEIGHT** (Вес) задано значение 0 %).

![Пользовательский интерфейс Vamp: шлюз кластера](./media/container-service-dcos-vamp-canary-release/23_sava_cluster_webport.png)

### <a name="canary-release"></a>Ранний выпуск

Когда обе версии службы sava развернуты в одном кластере, настройте распределение трафика между ними, перемещая ползунок **WEIGHT** (Вес).

1. Щелкните значок ![Пользовательский интерфейс Vamp: изменить](./media/container-service-dcos-vamp-canary-release/vamp_ui_edit.png) рядом с параметром **WEIGHT** (Вес).

2. Задайте значение распределения веса 50 %/50 % и нажмите кнопку **Save** (Сохранить).

  ![Пользовательский интерфейс Vamp: ползунок веса шлюза](./media/container-service-dcos-vamp-canary-release/24_sava_cluster_webport_weight.png)

3. Вернитесь в браузер и обновите страницу sava еще несколько раз. Теперь приложение sava переключается между страницами sava:1.0 и sava:1.1.

  ![чередование служб sava1.0 и sava1.1](./media/container-service-dcos-vamp-canary-release/25_sava_100_101.png)


  > [!NOTE]
  > Это чередование страниц лучше всего работает в режиме "Инкогнито" или "Анонимный" из-за кэширования статических ресурсов.
  >

### <a name="filter-traffic"></a>Фильтрация трафика

Предположим, что после развертывания в sava:1.1.0 обнаружилась несовместимость, которая вызывает проблемы с отображением в браузерах Firefox. В Vamp можно настроить фильтрацию входящего трафика и перенаправление всех пользователей Firefox обратно в известную стабильную службу sava:1.0.0. Этот фильтр мгновенно устраняет нарушение в работе для пользователей Firefox, в то время как остальные продолжают пользоваться преимуществами улучшенной службы sava:1.1.0.

Vamp использует **условия** для фильтрации трафика между маршрутами шлюза. Трафик сначала фильтруется и направляется в соответствии с условиями, примененными к каждому маршруту. Весь остальной трафик распределяется в соответствии с настройками веса шлюза.

Можно создать условие, фильтрующее всех пользователей Firefox и направляющее их в старую службу sava:1.0.0:

1. На странице **Gateways** (Шлюзы) конечной точки sava/sava_cluster/webport щелкните значок ![Пользовательский интерфейс Vamp: изменить](./media/container-service-dcos-vamp-canary-release/vamp_ui_edit.png), чтобы добавить **CONDITION** (Условие) в маршрут sava/sava_cluster/sava:1.0.0/webport. 

2. Введите условие **user-agent == Firefox** и щелкните значок ![Пользовательский интерфейс Vamp: сохранить](./media/container-service-dcos-vamp-canary-release/vamp_ui_save.png).

  Vamp добавляет условие со значением силы по умолчанию 0 %. Чтобы начать фильтрацию трафика, необходимо настроить силу условия.

3. Щелкните значок ![Пользовательский интерфейс Vamp: изменить](./media/container-service-dcos-vamp-canary-release/vamp_ui_edit.png), чтобы изменить параметр **STRENGTH** (Сила), применяемый к условию.
 
4. Задайте параметру **STRENGTH** (Сила) значение 100% и щелкните значок ![Пользовательский интерфейс Vamp: сохранить](./media/container-service-dcos-vamp-canary-release/vamp_ui_save.png), чтобы сохранить.

  Теперь Vamp отправляет весь трафик, соответствующий условию (все пользователи Firefox), в службу sava:1.0.0.

  ![Пользовательский интерфейс Vamp: применение условия к шлюзу](./media/container-service-dcos-vamp-canary-release/26_apply_condition.png)

5. Наконец, настройте вес шлюза для отправки всего остального трафика (все пользователи, отличные от Firefox) в новую службу sava:1.1.0. Щелкните значок ![Пользовательский интерфейс Vamp: изменить](./media/container-service-dcos-vamp-canary-release/vamp_ui_edit.png) рядом с параметром **WEIGHT** (Вес) и задайте значение распределения веса, чтобы 100 % трафика направлялось по маршруту sava/sava_cluster/sava:1.1.0/webport.

  Весь трафик, который не фильтруется по условию, теперь направляется в новую службу sava:1.1.0.

6. Чтобы увидеть фильтр в действии, откройте два разных браузера (Firefox и еще один браузер) и войдите в службу sava с обоих. Все запросы из Firefox отправляются в sava:1.0.0, а все прочие браузеры направляются в sava:1.1.0.

  ![Пользовательский интерфейс Vamp: фильтрация трафика](./media/container-service-dcos-vamp-canary-release/27_filter_traffic.png)

## <a name="summing-up"></a>Подведем итоги

В этой статье представлены краткие сведения о Vamp в кластере DC/OS. Для начинающих показано, как установить и запустить Vamp в кластере DC/OS Службы контейнеров Azure, развернуть службу с помощью схемы Vamp, а также войти в службу через предоставленную конечную точку (шлюз).

Мы также рассмотрели несколько эффективных функций Vamp: объединение нового варианта службы с работающей развернутой системой и постепенное ее введение, а затем фильтрация трафика для устранения известной несовместимости.


## <a name="next-steps"></a>Дополнительная информация

* Ознакомьтесь со сведениями об управлении действиями Vamp через интерфейс [REST API Vamp](http://vamp.io/documentation/api/api-reference/).

* Создайте сценарии автоматизации Vamp, используя Node.js, и выполните их как [рабочие процессы Vamp](http://vamp.io/documentation/tutorials/create-a-workflow/).

* Также ознакомьтесь с дополнительными [руководствами по VAMP](http://vamp.io/documentation/tutorials/overview/).

