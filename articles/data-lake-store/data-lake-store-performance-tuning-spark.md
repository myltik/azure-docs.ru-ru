---
title: Рекомендации по настройке производительности для Spark в Azure Data Lake Store | Документация Майкрософт
description: Рекомендации по настройке производительности для Spark в Azure Data Lake Store
services: data-lake-store
documentationcenter: ''
author: stewu
manager: amitkul
editor: stewu
ms.assetid: ebde7b9f-2e51-4d43-b7ab-566417221335
ms.service: data-lake-store
ms.devlang: na
ms.topic: article
ms.date: 12/19/2016
ms.author: stewu
ms.openlocfilehash: a807bea13063d2a0b3c1c71ddb6c98aa2d2568d3
ms.sourcegitcommit: eb75f177fc59d90b1b667afcfe64ac51936e2638
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2018
ms.locfileid: "34197075"
---
# <a name="performance-tuning-guidance-for-spark-on-hdinsight-and-azure-data-lake-store"></a>Рекомендации по настройке производительности для Spark в HDInsight и Azure Data Lake Store

При настройке производительности для Spark необходимо учитывать количество приложений, которые будут выполняться в кластере.  По умолчанию в кластере HDI можно одновременно выполнять 4 приложения (настройку по умолчанию можно изменить).  Вам может понадобиться использовать меньшее количество приложений. В таком случае можно переопределить параметры по умолчанию и использовать больше ресурсов кластера для этих приложений.  

## <a name="prerequisites"></a>предварительным требованиям

* **Подписка Azure**. См. страницу [бесплатной пробной версии Azure](https://azure.microsoft.com/pricing/free-trial/).
* **Учетная запись хранения озера данных Azure**. Инструкции по созданию учетной записи см. в статье [Начало работы с Azure Data Lake Store с помощью портала Azure](data-lake-store-get-started-portal.md).
* **Кластер Azure HDInsight** с доступом к учетной записи Data Lake Store. См. статью [Создание кластера HDInsight с Data Lake Store](data-lake-store-hdinsight-hadoop-use-portal.md). Убедитесь, что вы включили удаленный рабочий стол для кластера.
* **Работающий кластер Spark в Azure Data Lake Store.**  Дополнительные сведения см. в статье [Использование кластера HDInsight Spark для анализа данных в Data Lake Store](https://docs.microsoft.com/azure/hdinsight/hdinsight-apache-spark-use-with-data-lake-store).
* **Рекомендации по настройке производительности в Azure Data Lake Store**.  См. [рекомендации по настройке производительности для Azure Data Lake Store](https://docs.microsoft.com/azure/data-lake-store/data-lake-store-performance-tuning-guidance). 

## <a name="parameters"></a>Параметры

Ниже приведены самые важные параметры, которые можно настроить для повышения производительности в Azure Data Lake Store при выполнении заданий Spark.

* **num-executors** — количество параллельных задач, которые можно выполнить.

* **executor-memory** — объем памяти, выделенной для каждого исполнителя.

* **executor-cores** — количество ядер, выделенных для каждого исполнителя.                     

**num-executors**.Этот параметр позволяет задать максимальное число задач, которые могут выполняться параллельно.  Фактическое число задач, которые могут выполняться параллельно, ограничено ресурсами памяти и ЦП, доступными в кластере.

**executor-memory** — это объем памяти, выделенной для каждого исполнителя.  Объем памяти, необходимый для каждого исполнителя, зависит от задания.  При выполнении сложных операций требования к памяти возрастают.  Для более простых операций, таких как чтение и запись, требования к памяти ниже.  Объем памяти, необходимый для каждого исполнителя, можно просмотреть в Ambari.  В Ambari перейдите к Spark и откройте вкладку конфигураций.  

**executor-cores**. Этот параметр задает количество ядер, используемых для каждого исполнителя, что определяет число параллельных потоков, выполняемых на исполнителя.  Например, если задать executor-cores = 2, тогда каждый исполнитель может выполнять 2 параллельные задачи.  Необходимое количество ядер исполнителя зависит от задания.  Задания, включающие большое количество операций ввода-вывода, не требуют большого объема памяти на задачу, так что каждый исполнитель может обрабатывать большее количество параллельных задач.

При выполнении Spark в HDInsight для каждого физического ядра по умолчанию определяются два виртуальных ядра YARN.  Такое количество обеспечивает хороший баланс параллелизма и объема контекста, переключающегося между несколькими потоками.  

## <a name="guidance"></a>Руководство

Во время выполнения аналитических рабочих нагрузок Spark для работы с данными в Data Lake Store рекомендуется использовать последнюю версию HDInsight для обеспечения высокой производительности Data Lake Store. Если во время вашего задания выполняется большое количество операций ввода-вывода, можно настроить некоторые параметры для повышения производительности.  Azure Data Lake Store — это высокомасштабируемая платформа хранилища, способная справиться с высокой пропускной способностью.  Если задание состоит преимущественно из операций чтения или записи, повысить производительность можно, увеличив значение параметра параллелизма для операций ввода-вывода в Azure Data Lake Store и из него.

Есть несколько основных способов повышения параллелизма для заданий с большим количеством операций ввода-вывода.

**Шаг 1. Определение количества приложений, выполняющихся в кластере.** Необходимо знать количество выполняющихся в кластере приложений, включая текущее.  Значения по умолчанию для каждого параметра Spark подразумевают, что параллельно выполняются 4 приложения.  Таким образом на каждое приложение доступно всего 25 % ресурсов кластера.  Чтобы получить более высокую производительность, можно переопределить значения по умолчанию, изменив число исполнителей.  

**Шаг 2. Настройка памяти исполнителя.** В первую очередь необходимо задать параметр executor-memory.  Требуемый объем памяти зависит от задания, которое необходимо выполнить.  Значение параметра параллелизма можно увеличить, выделив меньший объем памяти на каждый исполнитель.  Если во время выполнения задания возникают исключения памяти, можно повысить значение для этого параметра.  Альтернативой будет обеспечить больший объем памяти, используя кластер с большим объемом памяти или увеличивая размер кластера.  Больший объем памяти позволит использовать дополнительные исполнители, обеспечивая возможность параллельной обработки.

**Шаг 3. Настройка ядер исполнителя.** Для рабочих нагрузок с большим количеством операций ввода-вывода, которые не включают сложные операции, рекомендуется настроить большее количество ядер исполнителя, чтобы увеличить число параллельно выполняемых задач на каждый исполнитель.  Оптимальный вариант — 4 ядра исполнителя.   

    executor-cores = 4
Увеличение количества ядер исполнителя обеспечит больший параллелизм, так что можно поэкспериментировать с разным количеством ядер.  Для заданий, которые включают более сложные операции, количество ядер на исполнитель необходимо уменьшить.  Если количество ядер исполнителя превышает 4, тогда сборка мусора может оказаться неэффективной и производительность снизится.

**Шаг 4. Определение объема памяти YARN в кластере.** Информация об этом доступна в Ambari.  Перейдите к YARN и откройте вкладку конфигураций.  Объем памяти YARN отобразится в этом окне.  
Примечание. В этом окне можно увидеть размер контейнера YARN по умолчанию.  Размер контейнера YARN такой же, как и параметр объема памяти на исполнителя.

    Total YARN memory = nodes * YARN memory per node
**Шаг 5. Вычисление параметра num-executors**

**Вычисление ограничения памяти.** Параметр num-executors ограничен памятью или ЦП.  Ограничение памяти определяется объемом доступной памяти YARN для вашего приложения.  Разделите общий объем памяти YARN на значение executor-memory.  Ограничение необходимо рассчитать для каждого приложения, так что мы разделим полученное значение на количество приложений.

    Memory constraint = (total YARN memory / executor memory) / # of apps   
**Вычисление ограничения ЦП.** Ограничение ЦП можно рассчитать, разделив общее количество виртуальных ядер на количество ядер на исполнителя.  Для каждого физического ядра существует 2 виртуальных ядра.  Как и в случае с ограничением памяти, необходимо делить на количество приложений.

    virtual cores = (nodes in cluster * # of physical cores in node * 2)
    CPU constraint = (total virtual cores / # of cores per executor) / # of apps
**Настройка параметра num-executors.** Параметр num-executors определяется минимальным значением ограничения памяти и ограничением ЦП. 

    num-executors = Min (total virtual Cores / # of cores per executor, available YARN memory / executor-memory)   
Увеличение количества исполнителей не обязательно влияет на повышение производительности.  Следует учитывать, что добавление дополнительных исполнителей ведет к соответствующему увеличению нагрузки для каждого дополнительного исполнителя, что может снизить производительность.  Параметр num-executors ограничен ресурсами кластера.    

## <a name="example-calculation"></a>Пример вычисления

Предположим, у вас есть кластер из 8 узлов D4v2, на котором выполняется 2 приложения, включая приложение, которое вы собираетесь выполнить.  

**Шаг 1. Определите, сколько приложений выполняется в кластере.** Вы знаете, что в кластере выполняется 2 приложения, включая приложение, которое вы собираетесь выполнить.  

**Шаг 2. Задайте параметр executor-memory.** Для данного примера мы определяем, что 6 ГБ памяти на исполнитель будет достаточно для выполнения задания с большим количеством операций ввода-вывода.  

    executor-memory = 6GB
**Шаг 3. Задайте параметр executor-cores.** Так как это задание с большим количеством операций ввода-вывода, для каждого исполнителя можно задать 4 ядра.  Если задать большее количество ядер на исполнитель, это может вызвать проблемы со сборкой мусора.  

    executor-cores = 4
**Шаг 4. Определите объем памяти YARN в кластере.** Перейдите в Ambari, чтобы узнать, что каждый узел D4v2 имеет 25 ГБ памяти YARN.  Так как в кластере 8 узлов, объем доступной памяти YARN увеличивается в 8 раз.

    Total YARN memory = nodes * YARN memory* per node
    Total YARN memory = 8 nodes * 25GB = 200GB
**Шаг 5. Настройте параметр num-executors.** Параметр num-executors определяется общим минимальным значением ограничения памяти и ограничением ЦП, разделенными на количество приложений, выполняемых в Spark.    

**Рассчитайте ограничение памяти.** Ограничение памяти рассчитывается как общий объем памяти YARN, разделенный на объем памяти на исполнитель.

    Memory constraint = (total YARN memory / executor memory) / # of apps   
    Memory constraint = (200GB / 6GB) / 2   
    Memory constraint = 16 (rounded)
**Рассчитайте ограничение ЦП.** Ограничение ЦП можно рассчитать, разделив общее количество ядер YARN на количество ядер на исполнителя.
    
    YARN cores = nodes in cluster * # of cores per node * 2   
    YARN cores = 8 nodes * 8 cores per D14 * 2 = 128
    CPU constraint = (total YARN cores / # of cores per executor) / # of apps
    CPU constraint = (128 / 4) / 2
    CPU constraint = 16
**Настройте параметр num-executors.**

    num-executors = Min (memory constraint, CPU constraint)
    num-executors = Min (16, 16)
    num-executors = 16    

