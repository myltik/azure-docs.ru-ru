---
title: Выборка данных телеметрии в Azure Application Insights | Документация Майкрософт
description: Как управлять объемом данных телеметрии.
services: application-insights
documentationcenter: windows
author: vgorbenko
manager: carmonm
ms.assetid: 015ab744-d514-42c0-8553-8410eef00368
ms.service: application-insights
ms.workload: tbd
ms.tgt_pltfrm: ibiza
ms.devlang: na
ms.topic: article
ms.date: 03/24/2017
ms.author: mbullwin
ms.openlocfilehash: d0614e2eae0f60068e69b7a4687fc62fbe082c64
ms.sourcegitcommit: 20d103fb8658b29b48115782fe01f76239b240aa
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/03/2018
---
# <a name="sampling-in-application-insights"></a>Выборка в Application Insights


Выборка — это функция [Azure Application Insights](app-insights-overview.md), которую мы рекомендуем использовать для сокращения трафика телеметрии и хранения. Эта функция также поддерживает статистически правильный анализ данных приложения. Фильтр выбирает связанные элементы, позволяя переходить между ними при диагностике.
Отображаемые на портале счетчики метрик перенормированы с учетом выборки, чтобы их влияние на статистику было минимальным.

Выборка сокращает расходы, связанные с использованием трафика и данных, помогая избежать регулирования.

## <a name="in-brief"></a>Краткое описание
* Выборка сохраняет 1 из *n* записей и отклоняет остальные. Например, при частоте выборки 20 % сохраняется 1 из 5 событий. 
* Если приложение отправляет большие объемы данных телеметрии, выборка происходит автоматически (в приложениях веб-сервера ASP.NET).
* Вы также можете выполнять выборку вручную, чтобы сократить сетевой трафик. Это можно настроить на портале на странице "Usage and estimated costs" (Данные об использовании и предполагаемые расходы), в пакете SDK для ASP.NET посредством CONFIG-файла, или в пакете SDK для Java посредством файла ApplicationInsights.xml.
* Если при регистрации пользовательских событий необходимо убедиться, что набор событий сохранен или отклонен полностью, проверьте, одинаковое ли у них значение идентификатора операции.
* Делитель выборки *n* указывается в каждой записи в свойстве `itemCount`, которая при поиске отображается как число запросов или счетчик событий. Если выборка не выполняется, `itemCount==1`.
* При написании запросов аналитики необходимо [учитывать выборку](app-insights-analytics-tour.md#counting-sampled-data). В частности, вместо простого подсчета записей следует использовать функцию `summarize sum(itemCount)`.

## <a name="types-of-sampling"></a>Типы выборки
Существует три альтернативных метода выборки.

* **Адаптивная выборка** автоматически корректирует объем данных телеметрии, отправляемых из пакета SDK в приложение ASP.NET. Начиная с пакета SDK версии 2.0.0-beta3 этот метод выборки используется по умолчанию. Адаптивная выборка сейчас доступна только в рамках серверной телеметрии ASP.NET. 
* **Выборка с фиксированной частотой** уменьшает объем данных телеметрии, отправляемых с сервера ASP.NET или Java и из браузеров пользователей. Частоту вы задаете сами. Благодаря тому, что клиент и сервер будут синхронизировать свои выборки, при поиске вы сможете перемещаться между связанными представлениями страниц и запросами.
* **Выборка приема**, поддерживаемая на портале Azure, отклоняет некоторые данные телеметрии, поступающие из приложения, с заданной скоростью выборки. Выборка не сокращает трафик телеметрии, отправляемый из вашего приложения, но помогает оставаться в пределах месячной квоты. Основное преимущество выборки приема заключается в том, что ее скорость можно задать без повторного развертывания приложения, а ее использование одинаково для всех серверов и клиентов. 

Если выполняется адаптивная или фиксированная выборка, выборка приема отключена.

## <a name="ingestion-sampling"></a>Выборка приема
Этот вид выборки работает в точке, где данные телеметрии с веб-сервера, браузеров и устройств достигают конечной точки службы Application Insights. Несмотря на то, что трафик телеметрии, отправляемой из приложения, такая выборка не уменьшает, она сокращает объем данных для обработки и сохранения в службе Application Insights, а значит и размер оплаты.

Используйте этот тип выборки, если ваше приложение часто выходит за рамки ежемесячной квоты, а возможности использовать один из типов выборки на основе SDK нет. 

Задайте частоту выборки на странице "Usage and estimated costs" (Данные об использовании и предполагаемые расходы).

![В колонке общих сведений о приложении щелкните "Параметры", "Квота", "Выборки", выберите частоту выборки и щелкните "Обновить".](./media/app-insights-sampling/04.png)

Как и в других типах выборки, алгоритм сохраняет связанные элементы телеметрии. Например, при проверке телеметрии в поиске это позволит найти запрос, связанный с определенным исключением. Правильно сохраняются счетчики метрик, например частота запросов и частота исключений.

Точки данных, отклоненные выборкой, доступны не во всех функциях Application Insights, например [Непрерывный экспорт](app-insights-export-telemetry.md).

Выборка приема не работает во время действия адаптивной или фиксированной выборки на основе пакета SDK. Обратите внимание на то, что адаптивная выборка включена по умолчанию, если пакет SDK для ASP.NET включен в Visual Studio или с помощью монитора состояния, а выборка при приеме отключена. Если частота выборки в пакете SDK меньше 100 %, заданная частота выборки приема не учитывается.

> [!WARNING]
> Значение, отображаемое на плитке, обозначает значение, которое вы задали для выборки приема. Оно не отражает фактическую частоту выборки, если действует выборка пакета SDK.
> 
> 

## <a name="adaptive-sampling-at-your-web-server"></a>Адаптивная выборка на веб-сервере
Адаптивная выборка доступна в пакете SDK Application Insights для ASP.NET 2.0.0-beta3 или более поздней версии и по умолчанию включена. 

Адаптивная выборка влияет на объем данных телеметрии, отправляемых в конечную точку службы Application Insights из приложения веб-сервера. Том автоматически настраивается на работу с заданным максимальным объемом трафика.

Он не работает с небольшими объемами данных телеметрии и не затрагивается при отладке приложения или веб-узла с низкой нагрузкой.

Для получения целевого объема некоторые формируемые данные телеметрии игнорируются. Однако, как и в других типах выборки, алгоритм сохраняет связанные элементы телеметрии. Например, при проверке телеметрии в поиске это позволит найти запрос, связанный с определенным исключением. 

Счетчики метрик, например частота запросов и частота исключений, корректируются с учетом частоты выборки, так что в обозревателе метрик отображаются приблизительно точные значения.

### <a name="update-nuget-packages"></a>Обновление пакетов NuGet ###

Обновите пакеты NuGet проекта до последней *предварительной* версии Application Insights. В Visual Studio щелкните проект правой кнопкой мыши в обозревателе решений, выберите "Управление пакетами NuGet", установите флажок **Включить предварительный выпуск** и выполните поиск Microsoft.ApplicationInsights.Web. 

### <a name="configuring-adaptive-sampling"></a>Настройка адаптивной выборки ###

В файле [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md) можно настроить несколько параметров узла `AdaptiveSamplingTelemetryProcessor`. Ниже представлены значения по умолчанию.

* `<MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>`
  
    Целевая частота, к которой стремится адаптивный алгоритм **на каждом узле сервера**. Если веб-приложение выполняется на множестве узлов, нужно уменьшить это значение, чтобы не превышать целевую скорость трафика на портале Application Insights.
* `<EvaluationInterval>00:00:15</EvaluationInterval>` 
  
    Интервал повторного вычисления текущей частоты телеметрии. Вычисление выполняется на основе скользящего среднего. Вы можете сократить этот интервал, если наблюдаете неожиданные скачки данных телеметрии в сторону увеличения.
* `<SamplingPercentageDecreaseTimeout>00:02:00</SamplingPercentageDecreaseTimeout>`
  
    Время, по истечении которого можно снова снизить процент выборки для сбора меньшего объема данных после изменения значения процента выборки.
* `<SamplingPercentageIncreaseTimeout>00:15:00</SamplingPercentageIncreaseTimeout>`
  
    Время, по истечении которого можно снова увеличить процент выборки для сбора большего объема данных после изменения значения процента выборки.
* `<MinSamplingPercentage>0.1</MinSamplingPercentage>`
  
    Минимальное допустимое значение с учетом изменения процента выборки.
* `<MaxSamplingPercentage>100.0</MaxSamplingPercentage>`
  
    Максимальное допустимое значение с учетом изменения процента выборки.
* `<MovingAverageRatio>0.25</MovingAverageRatio>` 
  
    Взвешенное значение, присваиваемое последнему значению при вычислении скользящего среднего. Используйте значение не больше 1. Использование значений ниже рекомендуемых приводит к тому, что скорость реагирования алгоритма на резкие изменения замедляется.
* `<InitialSamplingPercentage>100</InitialSamplingPercentage>`
  
    Значение, назначенное сразу после запуска приложения. Не снижайте это значение во время отладки. 

* `<ExcludedTypes>Trace;Exception</ExcludedTypes>`
  
    Разделенный точкой с запятой список типов, которые не должны включаться в выборку. Распознаваемые типы: Dependency, Event, Exception, PageView, Request, Trace. Передаются все экземпляры указанных типов; типы, которые не указаны, включаются в выборку.

* `<IncludedTypes>Request;Dependency</IncludedTypes>`
  
    Разделенный точкой с запятой список типов, которые должны включаться в выборку. Распознаваемые типы: Dependency, Event, Exception, PageView, Request, Trace. Указанные типы включаются в выборку; все экземпляры других типов будут всегда передаваться.


Чтобы **отключить** адаптивную выборку, удалите узел AdaptiveSamplingTelemetryProcessor в файле applicationinsights-config.

### <a name="alternative-configure-adaptive-sampling-in-code"></a>Альтернатива: настройка адаптивной выборки в коде
Вместо установки параметра выборки в CONFIG-файле можно задать эти значения программным способом. Это позволяет указать функцию обратного вызова, которая вызывается каждый раз, когда производится повторная оценка частоты выборки. Это можно использовать, например, чтобы узнать, какая частота выборки используется.

Удалите узел `AdaptiveSamplingTelemetryProcessor` из CONFIG-файла.

*C#*

```csharp

    using Microsoft.ApplicationInsights;
    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.Channel.Implementation;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    ...

    var adaptiveSamplingSettings = new SamplingPercentageEstimatorSettings();

    // Optional: here you can adjust the settings from their defaults.

    var builder = TelemetryConfiguration.Active.TelemetryProcessorChainBuilder;

    builder.UseAdaptiveSampling(
         adaptiveSamplingSettings,

        // Callback on rate re-evaluation:
        (double afterSamplingTelemetryItemRatePerSecond,
         double currentSamplingPercentage,
         double newSamplingPercentage,
         bool isSamplingPercentageChanged,
         SamplingPercentageEstimatorSettings s
        ) =>
        {
          if (isSamplingPercentageChanged)
          {
             // Report the sampling rate.
             telemetryClient.TrackMetric("samplingPercentage", newSamplingPercentage);
          }
      });

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));

    builder.Build();

```

([Сведения о процессорах телеметрии](app-insights-api-filtering-sampling.md#filtering).)

<a name="other-web-pages"></a>

## <a name="sampling-for-web-pages-with-javascript"></a>Включение выборки для веб-страниц с помощью JavaScript
Вы можете настроить выборку с фиксированной частотой для веб-страниц с любого сервера. 

При [настройке веб-страниц для Application Insights](app-insights-javascript.md) измените фрагмент JavaScript, скачанный с портала Application Insights. (В приложениях ASP.NET фрагменты обычно содержатся в _Layout.cshtml.)  Вставьте строку, похожую на `samplingPercentage: 10,`, перед ключом инструментирования:

    <script>
    var appInsights= ... 
    }({ 


    // Value must be 100/N where N is an integer.
    // Valid examples: 50, 25, 20, 10, 5, 1, 0.1, ...
    samplingPercentage: 10, 

    instrumentationKey:...
    }); 

    window.appInsights=appInsights; 
    appInsights.trackPageView(); 
    </script> 

В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число.  В настоящее время выборка не поддерживает другие значения.

Если вы также включите выборку с фиксированной частотой на сервере, выборка будет синхронизироваться между клиентом и сервером. Благодаря этому вы сможете перемещаться между связанными представлениями страниц и запросами в службе поиска.

## <a name="fixed-rate-sampling-for-aspnet-and-java-web-sites"></a>Выборка с фиксированной частотой для веб-сайтов ASP.NET и Java
Выборка с фиксированной частотой уменьшает объем трафика, отправляемого с веб-сервера и веб-браузеров. В отличие от адаптивной выборки объем данных уменьшается в фиксированном, заданном вами размере. Выборки клиента и сервера синхронизируются, а связанные элементы сохраняются. Например, просматривая представление страницы в поиске, вы всегда сможете найти соответствующий ему запрос.

Алгоритм выборки сохраняет связанные элементы. При каждом событии HTTP-запроса этот запрос и связанные с ним события игнорируются или передаются вместе. 

В обозревателе метрик такие параметры, как счетчики запросов и исключений, умножаются на коэффициент, компенсирующий частоту выборки, что позволяет получать примерно точные значения.

### <a name="configuring-fixed-rate-sampling-in-aspnet"></a>Настройка выборки с фиксированной частотой в ASP.NET ###

1. **Обновите пакеты NuGet проекта** до последней *предварительной* версии Application Insights. В Visual Studio щелкните проект правой кнопкой мыши в обозревателе решений, выберите "Управление пакетами NuGet", установите флажок **Включить предварительный выпуск** и выполните поиск Microsoft.ApplicationInsights.Web. 
2. **Отключите адаптивную выборку.** В файле [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md) удалите или преобразуйте в комментарий узел `AdaptiveSamplingTelemetryProcessor`.
   
    ```xml
   
    <TelemetryProcessors>
   
    <!-- Disabled adaptive sampling:
      <Add Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.AdaptiveSamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
        <MaxTelemetryItemsPerSecond>5</MaxTelemetryItemsPerSecond>
      </Add>
    -->

    ```

3. **Включите модуль выборки с фиксированной частотой.** Добавьте этот фрагмент кода в файл [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md):
   
    ```XML
   
    <TelemetryProcessors>
     <Add  Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.SamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">
   
      <!-- Set a percentage close to 100/N where N is an integer. -->
     <!-- E.g. 50 (=100/2), 33.33 (=100/3), 25 (=100/4), 20, 1 (=100/100), 0.1 (=100/1000) -->
      <SamplingPercentage>10</SamplingPercentage>
      </Add>
    </TelemetryProcessors>
   
    ```

### <a name="configuring-fixed-rate-sampling-in-java"></a>Настройка выборки с фиксированной частотой в Java ###

1. Скачайте [пакет SDK Application Insights для Java](app-insights-java-get-started.md) последней версии и настройте его в веб-приложении.

2. **Включите модуль выборки с фиксированной частотой**, добавив следующий фрагмент кода в файл ApplicationInsights.xml.

```XML
    <TelemetryProcessors>
        <BuiltInProcessors>
            <Processor type = "FixedRateSamplingTelemetryProcessor">
                <!-- Set a percentage close to 100/N where N is an integer. -->
                <!-- E.g. 50 (=100/2), 33.33 (=100/3), 25 (=100/4), 20, 1 (=100/100), 0.1 (=100/1000) -->
                <Add name = "SamplingPercentage" value = "50" />
            </Processor>
        </BuilrInProcessors>
    <TelemetryProcessors/>
```

3. Конкретные типы телеметрии можно включить в выборку или исключить из нее с помощью следующих тегов внутри тега обработчика данных FixedRateSamplingTelemetryProcessor.
```XML
    <ExcludedTypes>
        <ExcludedType>Request</ExcludedType>
    </ExcludedTypes>

    <IncludedTypes>
        <IncludedType>Exception</IncludedType>
    </IncludedTypes>
```
Включение и (или) исключение можно настроить для следующих типов данных телеметрии: Dependency (зависимость), Event (событие), Exception (исключение), PageView (просмотр страницы), Request (запрос) и Trace (трассировка).

> [!NOTE]
> В качестве процента выборки выберите значение в процентах, близкое к 100/N, где N — это целое число.  В настоящее время выборка не поддерживает другие значения.
> 
> 

### <a name="alternative-enable-fixed-rate-sampling-in-your-server-code"></a>Альтернатива: включение выборки с фиксированной частотой в коде сервера
Вместо установки параметра выборки в CONFIG-файле можно задать эти значения программным способом. 

*C#*

```csharp

    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;
    ...

    var builder = TelemetryConfiguration.Active.GetTelemetryProcessorChainBuilder();
    builder.UseSampling(10.0); // percentage

    // If you have other telemetry processors:
    builder.Use((next) => new AnotherProcessor(next));

    builder.Build();

```

([Сведения о процессорах телеметрии](app-insights-api-filtering-sampling.md#filtering).)

## <a name="when-to-use-sampling"></a>Когда следует использовать выборку?
Адаптивная выборка включается автоматически, если используется пакет SDK для ASP.NET 2.0.0-beta3 или более поздней версии. Независимо от того, какая версия пакета SDK используется, можно включить выборку при приеме, чтобы разрешить Application Insights выборку собранных данных.

По умолчанию в пакете SDK для Java выборка не включена. В настоящее время он поддерживает только выборку с фиксированный частотой. Адаптивная выборка в пакете SDK для Java не поддерживается.

В общем случае для большинства приложений малого и среднего размера выборка не требуется. Наиболее полезные диагностические сведения и наиболее точную статистику можно получить, собирая данные обо всех действиях пользователей. 

Основные преимущества выборки:

* Служба Application Insights удаляет («регулирует») точки данных, когда приложение слишком часто отправляет данные телеметрии за короткий интервал времени. 
* Вы остаетесь в пределах [квоты](app-insights-pricing.md) на точки данных для своей ценовой категории. 
* Вам нужно сократить сетевой трафик, который тратится на сбор данных телеметрии. 

### <a name="which-type-of-sampling-should-i-use"></a>Какой тип выборки следует использовать?
**Используйте выборку приема, если:**

* Вы часто превышаете ежемесячную квоту телеметрии.
* Вы используете версию пакета SDK, которая не поддерживает выборки, например версию пакета для ASP.NET ниже 2.
* Вы получаете много данных телеметрии с веб-браузеров пользователей.

**Используйте выборку с фиксированной частотой, если:**

* Вы используете пакет SDK Application Insights для веб-служб ASP.NET 2.0.0 или более поздней версии или для Java 2.0.1 или более поздней версии.
* Вам нужна синхронизированная выборка между клиентом и сервером, которая позволяет перемещаться между связанными событиями на стороне клиента и сервера (такими, как просмотры страниц и HTTP-запросы) при использовании [службы поиска](app-insights-diagnostic-search.md)в ходе анализа событий.
* Вам нужна уверенность в выборе соответствующего процента выборки для вашего приложения. Он должен быть достаточно высоким, чтобы получить точные метрики и при этом не превышать ценовую квоту и ограничения регулирования. 

**Используйте адаптивную выборку:**

Если условия для использования других форм выборки не применяются, мы рекомендуем адаптивную выборку. В SDK сервера ASP.NET 2.0.0-beta3 или более поздней версии она включена по умолчанию. Она не приведет к уменьшению трафика, пока не будет достигнута определенная минимальная скорость. Таким образом, сайты, которые используются редко, не будут затронуты.

## <a name="how-do-i-know-whether-sampling-is-in-operation"></a>Как узнать, действует ли выборка
Чтобы узнать фактическую частоту выборки (где бы она ни применялась), выполните такой [запрос аналитики](app-insights-analytics.md) :

    requests | where timestamp > ago(1d)
    | summarize 100/avg(itemCount) by bin(timestamp, 1h) 
    | render areachart 

Для каждой сохранившейся записи `itemCount` обозначает число исходных записей, которые эта запись представляет (1 + число предыдущих удаленных записей). 

## <a name="how-does-sampling-work"></a>Как работает функция выборки?
Функция выборки с фиксированной частотой поддерживается в пакетах SDK для ASP.NET версии 2.0.0 и выше и в пакетах SDK для Java версии 2.0.1 и выше. Адаптивная выборка поддерживается в пакете SDK для ASP.NET версии 2.0.0 и выше. Выборка приема — это компонент службы Application Insights. Она может работать, даже если пакет SDK не выполняет выборку. 

Алгоритм выборки решает, какие элементы телеметрии необходимо удалить, а какие сохранить (как в пакете SDK, так и в службе Application Insights). Решение выборки основано на нескольких правилах, цель которых — сохранение всех точек взаимосвязанных данных без изменений, а также реализация функции диагностики в Application Insights даже с использованием сокращенного набора данных. Например, если для неудачно завершенного запроса приложение отправляет дополнительные элементы телеметрии (например, исключение и трассировки, зарегистрированные этим запросом), выборка не будет разделять этот запрос и другие данные телеметрии. Она либо сохраняет, либо удаляет все элементы вместе. Поэтому при просмотре сведений о запросе в Application Insights вы всегда будете видеть запрос вместе со связанными элементами телеметрии. 

Для приложений, которые определяют пользователя (т. е. наиболее типичных веб-приложений), решение выборки основывается на хэше идентификатора пользователя. Это означает, что все данные телеметрии для конкретного пользователя либо сохраняются, либо удаляются. Для типов приложений, которые не определяют пользователей (например, веб-службы), решение выборки основывается на идентификаторе операции запроса. Наконец, для элементов телеметрии, у которых нет ни идентификатора пользователя, ни идентификатора операции (например, элементы телеметрии, включенные в отчет по асинхронным потокам без контекста HTTP), выборка будет просто собирать определенный процент элементов телеметрии каждого типа. 

Представляя вам данные телеметрии, служба Application Insights корректирует метрики в соответствии с процентом выборки, который использовался во время сбора. Это делается, чтобы компенсировать отсутствующие точки данных. Следовательно, при просмотре данных телеметрии в Application Insights пользователи видят статистически правильные приблизительные значения, очень близкие к реальным цифрам.

Точность приблизительного значения в значительной степени зависит от заданного процента выборки. Кроме того, точность возрастает для приложений, обрабатывающих большой объем сходных запросов от большого количества пользователей. С другой стороны, для приложений, которые не работают с существенной нагрузкой, выборка не требуется, так как такие приложения обычно могут отправлять все данные телеметрии, не выходя за пределы квоты и не вызывая потерю данных в результате регулирования. 

> [!WARNING]
> Application Insights не использует выборки данных телеметрии для метрик и сеансов. Снижение точности может быть нежелательным для данных типов телеметрии.
> 

### <a name="adaptive-sampling"></a>Адаптивная выборка
Адаптивная выборка добавляет компонент, который отслеживает текущую скорость передачи данных из пакета SDK и корректирует процент выборки, чтобы оставаться в пределах целевой максимальной скорости. Корректировка пересчитывается через регулярные интервалы времени в зависимости от скользящего среднего для скорости исходящей передачи.

## <a name="sampling-and-the-javascript-sdk"></a>Выборка и пакет SDK для JavaScript
Пакет SDK клиента (JavaScript) участвует в выборке с фиксированной частотой в сочетании с серверным пакетом SDK. Инструментированные страницы отправляют данные телеметрии клиента только от тех пользователей, которых сервер включил в выборку. Такая логика обеспечивает непрерывность сеанса пользователя как на клиенте, так и на сервере. Благодаря этому с помощью любого элемента телеметрии в Application Insights можно найти все остальные элементы телеметрии для этого пользователя или сеанса. 

*Данные телеметрии на клиенте и сервере не отображают скоординированные образцы, как описано выше.*

* Убедитесь в том, что выборка с фиксированной частотой включена и на сервере, и в клиенте.
* Убедитесь в том, что используется пакет SDK версии 2.0 или выше.
* Проверьте, указан ли процент выборки на клиенте и сервере.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
*Почему выборка — это не простой сбор X процентов данных телеметрии каждого типа?*

* Хотя такой подход к выборке обеспечил бы очень высокую точность в приблизительных значениях метрик, он не позволит сопоставлять диагностические данные для каждого пользователя, сеанса и запроса, что является критически важным для диагностики. Поэтому выборку лучше всего описать как «сбор всех элементов телеметрии для X процентов пользователей приложения» или «сбор всех данных телеметрии для X процентов запросов приложения». Для элементов телеметрии, не связанных с запросами (включая асинхронную фоновую обработку), альтернативным вариантом является сбор X процентов всех элементов для данных телеметрии каждого типа. 

*Может ли процент выборки меняться со временем?*

* Да, адаптивная выборка постепенно меняет процент выборки в зависимости от текущего объема данных телеметрии.

*Если я использую выборку с фиксированной частотой, как узнать, какой процент выборки будет оптимальным для моего приложения?*

* Один из способов — начать с адаптивной выборки, узнать подобранную частоту (см. вопрос выше) и переключиться на выборку с этой фиксированной частотой. 
  
    В противном случае придется только угадывать. Анализируйте текущее использование телеметрии в Application Insights, наблюдайте осуществляемое регулирование и оценивайте объем собранных данных телеметрии. Эти три фактора в сочетании с выбранной ценовой категорией позволяют оценить объем собранных данных телеметрии, который может потребоваться сократить. Однако увеличение числа пользователей или некоторые другие факторы, меняющие объем данных телеметрии, могут сделать оценку недействительной.

*Что произойдет, если настроить слишком низкий процент выборки?*

* Слишком низкий процент выборки (излишне агрессивная выборка) снижает точность приблизительных значений, когда служба Application Insights пытается компенсировать отображение данных для сокращения объема данных. Кроме того, это может отрицательно повлиять на функцию диагностики, так как в выборку могут не попасть некоторые редкие сбои или медленные запросы.

*Что произойдет, если настроить слишком высокий процент выборки?*

* Слишком высокий процент выборки (недостаточно агрессивная выборка) приводит к недостаточному снижению объема собранных данных телеметрии. У вас по-прежнему может наблюдаться потеря данных телеметрии, связанная с регулированием, а затраты на использование Application Insights могут быть выше запланированных из-за избыточных расходов.

*На каких платформах можно использовать выборку?*

* Выборка приема может выполняться автоматически, когда объем данных телеметрии превышает определенный порог, если пакет SDK не выполняет выборку. Например, если вы используете старую версию пакета SDK для ASP.NET или Java (версию 1.0.10 или более раннюю).
* Если вы используете пакет SDK ASP.NET 2.0.0 и более поздних версий (размещенный в Azure или на собственном сервере), адаптивная выборка работает по умолчанию, однако вы можете перейти на выборку с фиксированной частотой, как описано выше. При выборке с фиксированной частотой пакет SDK браузера выполняет автоматическую синхронизацию с событиями, связанными с выборкой. 
* Если вы используете пакет SDK для Java версии 2.0.1 или более поздней, в файле ApplicationInsights.xml можно включить выборку с фиксированной частотой. По умолчанию выборка отключена. При выборке с фиксированной частотой пакет SDK браузера выполняет автоматическую синхронизацию с событиями, связанными с выборкой.

*Есть определенные редкие события, которые я всегда хочу просматривать. Как сделать так, чтобы модуль выборки не отфильтровывал их?*

* Инициализируете отдельный экземпляр TelemetryClient с новой конфигурацией TelemetryConfiguration (не активной по умолчанию). Используйте его для отправки редких событий.

## <a name="next-steps"></a>Дополнительная информация
* [Фильтрация](app-insights-api-filtering-sampling.md) может обеспечивать более строгий контроль над данными, отправляемыми пакетом SDK.

