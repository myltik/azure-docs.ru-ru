<properties
	pageTitle="Пример решения IoT Azure MyDriving: сборка | Microsoft Azure"
	description="Выполните сборку приложения, которое демонстрирует пример проектирования системы IoT с помощью Microsoft Azure, включая Stream Analytics, машинное обучение и концентраторы событий."
	services=""
    documentationCenter=""
    suite="iot-suite"
	authors="alancameronwills"
	manager="douge"/>

<tags
	ms.service="iot-suite"
	ms.workload="tbd"
	ms.tgt_pltfrm="ibiza"
	ms.devlang="na"
	ms.topic="article"
	ms.date="03/25/2016"
	ms.author="awills"/>


# Создание и развертывание решения MyDriving в вашей среде

MyDriving — это решение "Интернета вещей" (IoT), которое собирает данные о работе автомобиля, обрабатывает их с помощью методов машинного обучения и выводит полученную информацию на экран мобильного телефона. Серверная состоит из различных служб, предоставляемых Microsoft Azure. Клиентами могут быть телефоны под управлением Android, iOS или Windows 10.

MyDriving — первый шаг на пути к созданию собственной системы IoT. Из [репозитория MyDriving в GitHub](https://github.com/Azure-Samples/MyDriving) можно получить сценарии Azure Resource Manager для развертывания серверной архитектуры в учетной записи Azure. После этого вы сможете перенастроить различные службы, изменить запросы в соответствии со своими данными и т. п. Эти сценарии, а также код для мобильного приложения, проект API службы приложений Azure и многое другое можно найти в репозитории MyDriving.

Если вы еще не знакомы с этим приложением, см. дополнительные сведения о нем в [руководстве по началу работы](iot-solution-get-started.md).

Подробное описание компонентов архитектуры можно найти в [справочном руководстве по MyDriving](http://aka.ms/mydrivingdocs). Ниже приведены компоненты, которые необходимо установить и настроить. Это те же компоненты, которые понадобились бы и для создания другого аналогичного проекта.

* **Клиентское приложение** работает на телефонах Android, iOS и Windows 10. Для распространения большей части кода используется платформа Xamarin. Код размещен на сайте GitHub в разделе `src/MobileApp`. По сути, приложение выполняет две роли:
 * Оно ретранслирует телеметрию из устройства встроенной диагностики (OBD) и собственной службы расположений в облачную серверную часть системы.
 * Это пользовательский интерфейс, который позволяет пользователям запрашивать сведения о записанных поездках.
* **Облачная служба** принимает данные о поездках в режиме реального времени и обрабатывает их. Главная задача при создании этой службы — выбрать, параметризовать и подключить различные службы Azure. Кроме того, чтобы фильтровать и обрабатывать входящие данные, для некоторых компонентов этого приложения требуются скрипты. Мы используем для настройки всех компонентов шаблон Azure Resource Management.
* **Приложение мобильной службы** — это веб-служба, которая составляет основу пользовательского интерфейса приложения устройства. Ее основная задача — отправлять запросы к базе данных, содержащей сохраненную обработанную информацию. Код для этой службы размещен на сайте GitHub в разделе `src/MobileAppService`.
* Наша среда разработки — **Visual Studio с Xamarin**. Xamarin (как компонент Visual Studio или изолированная интегрированная среда разработки (IDE)) используется для создания кроссплатформенного кода для устройств. Для сборки кода iOS необходим экземпляр Xamarin, работающий на компьютере OS X. При необходимости он может выполняться как агент, управляемый из Visual Studio.
* **Модульное тестирование** приложений устройств выполняется в тестовом облаке Xamarin.
* **GitHub** является репозиторием, где хранятся код, сценарии и шаблоны.
* **Visual Studio Team Services** — это облачная служба, которая используется для управления непрерывным процессом сборки и тестирования приложений веб-службы и устройств.
* Служба **HockeyApp** используется для распространения версий кода устройства. Она также собирает отчеты о сбоях и использовании и отзывы пользователей.
* **Visual Studio Application Insights** отслеживает мобильную веб-службу.

Теперь нам нужно все это установить и настроить. Обратите внимание, что многие действия не являются обязательными.

## Регистрация учетных записей

-   [Visual Studio Dev Essentials](https://www.visualstudio.com/products/visual-studio-dev-essentials-vs.aspx). Эта бесплатная программа предоставляет удобный доступ ко многим службам и инструментам для разработки, в том числе Visual Studio, Visual Studio Team Services и Azure. Кроме того, вы получаете кредит на использование Azure в размере 25 долл. США в месяц на протяжении года. Она также предоставляет подписки на обучающие ресурсы Pluralsight и Xamarin University. Можно также отдельно подписаться на службы [Azure](https://azure.com) и [Visual Studio Team Services](https://www.visualstudio.com/products/visual-studio-team-services-vs.aspx) уровня "Бесплатный", но эти подписки не предоставляют деньги на счете в Azure.

-   [HockeyApp](https://rink.hockeyapp.net/) (необязательно). С помощью этой службы можно управлять тестовым распространением мобильных приложений и осуществлять сбор данных телеметрии.

-   [Xamarin](https://xamarin.com/) (обязательно). Этот компонент необходим для сборки мобильного приложения, а также выполнения отладки и тестирования в [тестовом облаке Xamarin](https://xamarin.com/test-cloud).

-   [GitHub](https://github.com/Azure-Samples/MyDriving/) (необязательно). Этот ресурс позволяет создавать общедоступные бесплатные репозитории кода (частные репозитории оплачиваются). В качестве альтернативы для частных репозиториев можно использовать Visual Studio Team Services с планом "Базовый".

-   [Power BI](https://powerbi.microsoft.com/) (необязательно). Power BI можно использовать для создания расширенных визуализаций данных во всей системе.

> [AZURE.NOTE] Получить доступ к коду MyDriving можно в [репозитории MyDriving в GitHub](https://github.com/Azure-Samples/MyDriving). Для этого учетная запись GitHub не требуется.

## Установка средств разработки

Приведенные ниже шаги настройки позволят разработать комплексное решение: кроссплатформенное приложение iOS, Android и Windows 10 Mobile с серверной частью Azure.

Если вы не используете серверную часть Azure, для разработки мобильных приложений можно воспользоваться Xamarin Studio на компьютере Mac или Windows.

Подробное описание инструкций по настройке см. [здесь](https://msdn.microsoft.com/library/mt613162.aspx).

### Компьютер разработки Windows

Основным средством для работы с приложением MyDriving для Android, Windows, проекта API службы приложений и расширений микрослужб в Windows выступает Visual Studio.

Xamarin, Git, эмуляторы и другие полезные компоненты интегрированы в Visual Studio.

Установка:

-   [Visual Studio 2015 с Xamarin](https://www.visualstudio.com/products/visual-studio-community-vs) (любой выпуск; выпуск Community — бесплатный).

-   [SQLite для универсальной платформы Windows](https://visualstudiogallery.msdn.microsoft.com/4913e7d5-96c9-4dde-a1a1-69820d615936). Требуется для сборки кода для Windows 10 Mobile.

-   [Пакет SDK Azure для Visual Studio 2015](https://go.microsoft.com/fwlink/?linkid=518003&clcid=0x409). Этот пакет SDK позволяет выполнять приложения в Azure и управлять Azure с помощью программ командной строки.

-   [Пакет SDK для Azure Service Fabric](http://www.microsoft.com/web/handlers/webpi.ashx?command=getinstallerredirect&appid=MicrosoftAzure-ServiceFabric). Требуется для создания расширения [микрослужб](../service-fabric/service-fabric-get-started.md).

Кроме того, убедитесь, что используете соответствующие расширения Visual Studio. Проверить это можно в разделе **Сервис**. Там вы увидите **Android, iOS, Xamarin и т. д.** В противном случае откройте панель управления и выберите **Программы и компоненты** > **Microsoft** > **Visual Studio 2015** > **Изменить**. В разделе **Cross-Platform development** (Кроссплатформенная разработка) выберите **C#/.Net (Xamarin)**. Там же убедитесь, что **GitHub** установлен.

### Компьютер разработки Mac

Компьютер Mac (Yosemite или более поздней версии) необходим для разработки для iOS. Несмотря на то, что на компьютере Windows для создания кода и управления им используется Visual Studio с расширением Xamarin, для создания и подписи кода iOS на компьютере Mac необходимо установить агент Xamarin.

![Разработка в среде Windows и выполнение сборки в среде Mac](./media/iot-solution-build-system/image1.png)

(В качестве альтернативы для разработки кроссплатформенных приложений можно использовать Xamarin Studio непосредственно на компьютере Mac.)

Если iOS не будет использоваться в качестве целевой платформы, нет необходимости в компьютере Mac.

Установка:

-   [Xamarin Studio для iOS](https://developer.xamarin.com/guides/ios/getting_started/installation/mac/). Можно также установить Visual Studio и Xamarin на компьютере Mac с виртуальной машиной Windows. Дополнительные сведения см. в статье [Программа установки, установка и проверки для пользователей Mac](https://msdn.microsoft.com/library/mt488770.aspx) на портале MSDN.

-   [Средства разработки Azure](https://azure.microsoft.com/downloads/) (необязательно).

Настройте удаленный вход на компьютере Mac. Откройте **Системные настройки** > **Общий доступ** и установите флажок **Удаленный вход**.

При открытии проекта iOS в Visual Studio на компьютере Windows подключаемый модуль Xamarin запросит ввод идентификатора Mac.

## Получение репозитория GitHub

Получите локальную копию [репозитория MyDriving из GitHub](https://github.com/Azure-Samples/MyDriving), нажав кнопку **Download ZIP** (Скачать ZIP-файл) на GitHub, в Visual Studio или в другом клиенте Git.

Распакуйте файл в расположение с коротким путем, например C:\\code.

Кроме того, если вы хотите следить за обновлениями кода или принимать участие в его разработке, клонируйте репозиторий, используя следующую команду:

****git clone https://github.com/Azure-Samples/MyDriving.git**

## Получение ключа API для Карт Bing

[Зарегистрируйтесь для получения ключа API для Карт Bing](https://msdn.microsoft.com/library/ff428642.aspx).

Его нужно указать в строке 22 в `src/MobileApps/MyDriving/MyDriving.Utils/Logger.cs`.



## Создание демонстрационного приложения

Откройте следующие решения в Visual Studio:

-   src\\MobileApps\\MyDriving.sln;

-   src\\MobileAppService\\MyDrivingService.sln;

-   src\\Extensions\\ServiceFabric\\VINLookUpApplication\\VINLookUpApplication.sln.

При этом вам понадобится сделать следующее:

-   Подтвердить доверие некоторым потенциально ненадежным проектам. Откройте их, если вы хотите продолжить.

-   Задать режим разработчика, если вы работаете на новом компьютере Windows 10.

-   Ввести учетные данные Xamarin.

-   Подключиться к компьютеру Mac с Xamarin. Если у вас нет компьютера Mac, щелкните правой кнопкой мыши проект iOS в Visual Studio и выберите **Выгрузить проект**.

Повторно создайте решение.

В случае проблем при сборке попробуйте применить решения для обеспечения совместимости, которые мы нашли.

-   [Проект VINLookupApplication не загружается](https://go.microsoft.com/fwlink/?linkid=518003&clcid=0x409). Убедитесь, что *пакет SDK Azure для Visual Studio 2015* установлен.

-   *Не удается создать проект Service Fabric*. Сначала выполните сборку проектов интерфейсов и убедитесь, что пакет SDK для Service Fabric установлен.

-   *Не удается выполнить сборку приложения Android*.

    -   Щелкните **Сервис** > **Android** > **Android SDK Manager** (Диспетчер SDK для Android) и убедитесь, что Android 6 (API 23) и платформа SDK установлены.

    -   Удалите следующий каталог, а затем повторите сборку:<br/> `%LocalAppData%\Xamarin\zips`

## Компоненты кода

В решении вы увидите следующие компоненты:

-   расширения Azure: Service Fabric;

-   Azure HDInsight: сценарии для обработки данных поездок в Azure;

-   мобильные приложения: приложения для устройств;

-   MobileAppsService и MyDrivingService: серверная веб-служба;

-   Power BI: определение отчета Power BI.

-   Scripts:

    -   Resource Manager: шаблоны для создания ресурсов Azure;

    -   PowerShell: сценарии для запуска шаблонов Resource Manager;

    -   База данных SQL: базы данных отладки;

-   База данных SQL: CreateTables — определения схем;

-   Azure StreamingAnalytics: запросы, которые преобразовывают входящий поток данных.

## Запуск приложений в режиме разработки

Выполните действие для запуска приложений в соответствии с устройством, которое вы используете.

-  Серверная часть: установите MyDrivingService в качестве запускаемого проекта и нажмите клавишу F5, чтобы запустить серверную веб-службу. После этого в браузере откроется список интерфейсов API.

-  Мобильные клиенты: [мобильные приложения разрабатываются в Xamarin](https://developer.xamarin.com/guides/cross-platform/deployment,_testing,_and_metrics/debugging_with_xamarin/).
 -  Android: чтобы узнать больше, ознакомьтесь с [отладкой приложений Android в Xamarin](http://developer.xamarin.com/guides/android/deployment,_testing,_and_metrics/debugging_with_xamarin_android/).

 -  iOS: чтобы узнать больше, ознакомьтесь с [отладкой в iOS](http://developer.xamarin.com/guides/ios/deployment,_testing,_and_metrics/debugging_in_xamarin_ios/).

 -  Windows Phone: чтобы узнать больше, ознакомьтесь с разделом [Xamarin + Universal Windows Platform](https://developer.xamarin.com/guides/cross-platform/windows/phone/) (Xamarin и универсальная платформа Windows).

## Передача мобильного приложения в HockeyApp

HockeyApp управляет распространением приложений Android, iOS или для Windows среди тестовых пользователей, уведомляя их о новых выпусках. Кроме того, эта служба собирает отчеты о сбоях, отзывы пользователей со снимками экрана, а также метрики использования.

[Сначала передайте](http://support.hockeyapp.net/kb/app-management-2/how-to-create-a-new-app) приложение сборки. Войдите в службу [HockeyApp](https://rink.hockeyapp.net) на компьютере, на котором ведется разработка. На панели мониторинга разработчика щелкните **New App** (Создать приложение) и перетащите файлы сборки в окно. (Позже в службе сборки можно настроить автоматическое выполнение этой задачи.)

После этого вы перейдете на панель мониторинга приложения.

![Вкладка "Обзор" на панели мониторинга приложения](./media/iot-solution-build-system/image2.png)

Повторите этот процесс для каждой платформы, на которой работает приложение. После этого вы можете выполнить следующее.

-  Используйте значение параметра [App Id](http://support.hockeyapp.net/kb/app-management-2/how-to-find-the-app-id) (Идентификатор приложения) на панели мониторинга, чтобы получать данные о сбоях и отзывы о своем приложении. В MyDriving обновите идентификаторы в файле src/MobileApps/MyDriving/MyDriving.Utils/Logger.cs.

-  [Пригласите тестовых пользователей](http://support.hockeyapp.net/kb/app-management-2/how-to-invite-beta-testers). Для этого им нужно отправить URL-адрес. Они смогут зарегистрироваться в вашей группе, скачать приложение и отправить отзыв.

-  Если вам нужна более открытая бета-версия, задайте общее распространение. Щелкните **Manage App** (Управление приложением) > **Distribution** (Распространение) > **Download = Public** (Общедоступное скачивание). Теперь все пользователи могут скачать приложение и отправить отзыв о нем. Если вы опубликуете новую версию, они увидят соответствующее уведомление. Кроме того, они также могут отправить вам отчеты о сбоях.

    ![Группы на панели мониторинга](./media/iot-solution-build-system/image3.png)

-  [Свяжите отчеты о сбоях с Visual Studio Team Services](http://support.hockeyapp.net/kb/third-party-bug-trackers-services-and-webhooks/how-to-use-hockeyapp-with-visual-studio-team-services-vsts-or-team-foundation-server-tfs). Щелкните **Manage App** (Управление приложением) > **Visual Studio Team Services**. Служба HockeyApp может автоматически создавать рабочие элементы в Team Services при получении отчетов о сбоях или отзывов.

Прочтите дополнительные сведения на [сайте HockeyApp](https://hockeyapp.net).

## Тестирование мобильного приложения в тестовом облаке Xamarin

[Тестовое облако Xamarin](https://developer.xamarin.com/guides/testcloud/introduction-to-test-cloud/) позволяет автоматизировать тестирование пользовательского интерфейса на реальных устройствах в облаке. При этом вы используете платформу NUnit, чтобы написать тесты, которые запускают ваше приложение через пользовательский интерфейс.

Чтобы использовать Xamarin, внедрите пакет SDK [Xamarin.UITests](https://developer.xamarin.com/guides/testcloud/uitest/intro-to-uitest/) в приложение. Он поставляется как пакет NuGet. Этот пакет включен в состав демонстрационного приложения и новых создаваемых проектов тестирования с шаблонами Xamarin.

![Где в интерфейсе найти кроссплатформенный пакет SDK](./media/iot-solution-build-system/image4.png)

Пример тестового проекта включен в состав приложения в репозитории. Ищите его в каталоге [src](https://github.com/Azure-Samples/MyDriving/tree/master/src)/MobileApps/[MyDriving](https://github.com/Azure-Samples/MyDriving/tree/master/src/MobileApps/MyDriving)/MyDriving.UITests/ в [MyDriving](https://github.com/Azure-Samples/MyDriving/tree/master/src/MobileAppService).

При использовании сборки Visual Studio Team Services можно написать модульные тесты пользовательского интерфейса Xamarin и запустить их как часть этой сборки.

## Развертывание служб Azure

Подробные инструкции по автоматическому развертыванию служб Azure и служб сборки Team Services см. в файле **scripts/README.md**.

Microsoft Azure предоставляет множество различных служб, предназначенных для создания облачных приложений. Несмотря на то, что многие из них можно использовать по отдельности (например, службу приложений и веб-приложения), они более эффективны, если их объединить в одну интегрированную систему, например такую, которая используется в MyDriving.

Можно создать службы Azure и установить связи между ними вручную, но гораздо быстрее и надежнее использовать шаблоны Azure Resource Manager. [Resource Manager](../resource-group-overview.md) автоматизирует развертывание ресурсов решения и устанавливает между ними взаимосвязи.

Шаблон для системы MyDriving находится в репозитории GitHub в разделе [scripts/ARM](https://github.com/Azure-Samples/MyDriving/tree/master/scripts/ARM). Он обеспечивает точное комплексное представление взаимосвязи различных служб в архитектуре. Все это подробно описано в [справочном руководстве по MyDriving](http://aka.ms/mydrivingdocs). Тем не менее, в самом шаблоне также содержится много полезных сведений.

> [AZURE.NOTE] Большинство служб Azure платные. Их тариф зависит от ценовой категории. Если вы только начинаете знакомство с Azure, вы можете [опробовать возможности Azure бесплатно](https://azure.microsoft.com/free/). Однако если вы не планируете использовать определенные компоненты в системе MyDriving, удалите их, иначе с вас будет взиматься плата. В разделе "Оценка эксплуатационных расходов" далее в этой статье представлена сводка типичных расходов на службы.

### Изменение шаблона

Прежде чем приступить к настройке развертывания, например удалить ненужные компоненты или добавить дополнительные компоненты, создайте копии файлов scenario\_complete.params.json и scenario\_complete.json, в которые необходимо внести изменения.

В файле scenario\_complete.params.json можно переопределить различные значения по умолчанию, такие как SKU службы или тип репликации хранилища, как описано в таблице ниже. Значения по умолчанию соответствуют вариантам с наименьшей стоимостью.

| **Параметр** | **Описание** | **Значение по умолчанию** |
|--------|---------|-------|
| IoT Hub SKU | Уровень службы центра IoT Azure | F1 |
| Storage Account Type | Тип репликации хранилища | Standard LRS |
| SQL Service Objective | Использование слотов выдачи | DW100 |
| Hosting Plan SKU | План обслуживания службы приложений | F1 |

В файле scenario\_complete.json сделайте следующее:

-   Найдите значение baseName и измените его на имя, которое вы хотите использовать.

-   Найдите значения Create. Каждый такой раздел создает ресурс.

-   Задайте подходящие значения для параметров sqlServerAdminLogin и sqlServerAdminPassword.

-   Прежде чем удалить раздел, который создает ресурс, проверьте, нет ли в нем зависимостей. Для этого просмотрите, не указано ли его имя еще где-либо в файле. Обратите внимание, что каждый раздел, который создает службу, содержит раздел *dependsOn*, где перечислены ее зависимости.

Вот что настраивает шаблон. Дополнительные сведения см. в [справочном руководстве](http://aka.ms/mydrivingdocs).

| **Служба** | **Описание и объяснение**  
|---|----
| учетные записи хранения; | Этот шаблон создает три учетные записи:                                                                                                                                                                       
|| — базы данных SQL, которая получает сводные данные телеметрии из Stream Analytics и выполняет роль резервного хранилища для таблиц службы приложений Azure, которые предоставляют эти данные через конечные точки API;                      
|| — хранилища BLOB-объектов, которое накапливает архивные данные, обрабатываемые HDInisight, из другого задания Stream Analytics;                                                                                         
|| — базы данных SQL, которая получает обработанные HDInsight данные для использования с Power BI.                                                                                                                 
| Центр Azure IoT | Эта служба устанавливает двустороннюю связь с каждым подключенным устройством. Мобильное приложение в решении MyDriving действует как магистральный шлюз для отправки данных в центр IoT Azure. В этом случае центр IoT Azure выступает в качестве источника входных данных для Stream Analytics. |
| Концентраторы событий Azure | Сюда поступают выходные данные задания Stream Analytics и помещаются в очередь для расширений, созданных в Azure Service Fabric.                                                                                               
| Хранилище данных SQL Azure |                                                                                                                                                                                                            
| Задания Stream Analytics | Эти задания соединяют входные и выходные данные с запросом, который используется для объединения данных реального времени и архивных данных для API службы приложений, машинного обучения Azure, расширений и Power BI.                               
| Рабочая область машинного обучения | Включает в себя эксперименты, код R и службу API.                                                                                                                                                              
| Фабрика данных Azure | Эта служба используется для планового повторного обучения механизма машинного обучения.                                                                                                                                                                     
| План размещения Service Fabric | Это план для расширений.                                                                                                                                                                                            
| Служба приложений (мобильное приложение) | Эта служба размещает проект API мобильных приложений, который предоставляет конечные точки для мобильного приложения. Код API необходимо развернуть в службе приложений из Visual Studio.                                                         
| Правила оповещения | Эти правила можно настроить таким образом, чтобы в случае упоминания сбоев в ответах приложений вам отправлялось электронное сообщение.                                                                                                                                            
| Application Insights | Эта служба предназначена для мониторинга производительности API в службе приложений. Для этого необходимо настроить подключение в Visual Studio.                                                                                          
| Хранилище ключей Azure | В этом хранилище содержится сертификат кластера веб-службы.                                                                                                                                                                

### Запуск шаблона

Подробные инструкции по запуску шаблона см. в файле **scripts/README.md**.

Чтобы подготовить все эти службы в собственной учетной записи Azure при помощи сценария, выполните одно из следующих действий.

-   Используйте PowerShell.

    ```

    cd scripts/PowerShell;
    deploy.ps1 *location* *resourceGroupName*
    ```

 -   *location* — [расположение Azure](https://azure.microsoft.com/regions/), например `North Europe` или `West US`. Список доступных расположений можно найти с помощью команды `Get-AzureLocation`.

 -   *resourceGroupName* — имя группы, которой будут принадлежать все ресурсы. По завершении работы с ресурсами вы сможете удалить их вместе с группой в рамках одной операции.

-   Запустите DeploymentScripts/Bash/deploy.sh с помощью Bash.

-   Откройте решение Visual Studio DeploymentScripts/VS/DeployARM.sln и выполните его сборку.

Обратите внимание, что каждый раз при выполнении шаблона создается набор ресурсов с новыми именами. Чтобы удалить эти ресурсы, перейдите на портал и удалите группу ресурсов.

Если скрипт по какой-либо причине завершится ошибкой, перезапустите его.

С помощью скрипта можно настроить непрерывную интеграцию в Visual Studio Team Services. Если вы установили проект Team Services, у вас будет URL-адрес https://yourAccountName.visualstudio.com. Введите полный URL-адрес при запросе. Проекту Team Services можно присвоить как новое, так и существующее имя.

## Настройка определений сборки и тестирования в Visual Studio Team Services

В рамках это проекта Team Services главным образом используется из-за своих функций создания и тестирования. Однако эта среда также предоставляет отличную поддержку совместной работы, например управление задачами с помощью канбан-досок, функцию просмотра кода, интегрированную с задачами и системой управления версиями, и сборку с проверкой изменений. Кроме того, службы Team Services поддерживают интеграцию с другими инструментами, например GitHub, Xamarin, HockeyApp и, конечно же, Visual Studio. К ней можно получить доступ через веб-интерфейс или Visual Studio (как вам удобнее в определенный момент).

На этапе создания определений сборки и выпуска используются разнообразные подключаемые службы, доступные в [Marketplace](https://marketplace.visualstudio.com/VSTS) для Team Services. Помимо основных служебных программ для использования командной строки и копирования файлов, доступны службы, которые вызывают сборки Xamarin, Android и других поставщиков, а также подключаются к HockeyApp.

![Параметры сборки в Team Services](./media/iot-solution-build-system/image5.png)

### Определения сборки

У нас есть определения сборки для каждой из основных целей. У нас также есть отклонения для тестирования компонентов и регрессионного тестирования. Таким образом, мы имеем:

-   MyDriving.Services (серверное веб-приложение для мобильного приложения);

-   MyDriving.Xamarin.Android:

    -   MyDriving.Xamarin.Android-Feature;

    -   MyDriving.Xamarin.Android-Regression.

-   MyDriving.Xamarin.iOS:

    -   MyDriving.Xamarin.iOS-Feature;

    -   MyDriving.Xamarin.iOS-Regression.

-   MyDriving.Xamarin.UWP:

    -   MyDriving.Xamarin.UWP-Feature;

    -   MyDriving.Xamarin.UWP-Regression.

Полное описание нашей конфигурации см. в разделе 4.7 о настройке сборки и выпуска [справочного руководства по MyDriving](http://aka.ms/mydrivingdocs). Там представлены общие шаги настройки. Сценарий:

1.  Восстанавливает пакет NuGet. Мы не храним скомпилированный код в репозитории, поэтому в начале каждой сборки необходимо восстановить требуемые пакеты NuGet.

2.  Активирует лицензию. Сборка выполняется в облаке, поэтому нам нужно активировать лицензию (в частности, для службы сборки Xamarin) на текущем компьютере сборки. После выполнения необходимых действий лицензию нужно будет деактивировать, чтобы ее можно было использовать на другом компьютере.

3.  Выполняет сборку с использованием соответствующей службы. Мы используем сборки Xamarin для мобильных приложений и сборки Visual Studio для серверной веб-службы.

4.  Выполняет сборку тестов.

5.  Выполняет тесты Мы выполним тесты мобильного приложения в тестовом облаке Xamarin.

6.  Публикует результат выполнения в расположении сброса.

Для триггера основных сборок задается непрерывная интеграция. То есть сборка выполняется каждый раз при записи после изменения кода главной ветви.

![Интерфейс, в котором устанавливается триггер непрерывной интеграции](./media/iot-solution-build-system/image6.png)

### Определения выпуска

Определения выпуска настраиваются практически таким же образом.

Для веб-службы мы задаем развертывание в качестве веб-приложения Azure:

![Интерфейс для настройки развертывания в виде веб-приложения Azure](./media/iot-solution-build-system/image7.png)

И мы задаем для триггера выпуска непрерывное развертывание. То есть за каждой записью после изменения и успешными результатами сборки следует обновление веб-приложения.

![Интерфейс для настройки триггер выпуска для непрерывного развертывания](./media/iot-solution-build-system/image8.png)

Для мобильных приложений необходимо задать развертывание в HockeyApp.

![Интерфейс для развертывания мобильного приложения в HockeyApp](./media/iot-solution-build-system/image9.png)

## Просмотр данных телеметрии с помощью Application Insights

[Application Insights](../application-insights/app-insights-overview.md) собирает данные телеметрии о производительности и использовании веб-служб. Пакет SDK для Application Insights отправляет данные телеметрии из службы в ресурс Application Insights в Azure.

Перейдите к ресурсу Application Insights, настроенному с помощью шаблона. Там можно просматривать диаграммы производительности [проекта службы мобильных приложений](https://github.com/Azure-Samples/MyDriving/tree/master/src/MobileAppService). На них отображено число запросов к серверу и время ответа сервера, а также число сбоев и исключений. Кроме того, также доступны диаграммы времени отклика зависимостей, то есть вызовов к базе данных и интерфейсам REST API, например машинного обучения. Если у вас возникнут какие-либо проблемы с производительностью, вы сможете узнать, с каким компонентом системы они связаны.

![Пример диаграммы производительности](./media/iot-solution-build-system/image11.png)

Для веб-службы, которая настроена вручную, можно с легкостью получить такие же диаграммы. В колонке веб-службы щелкните **Сервис** > **Расширения** > **Добавить**. Выберите **Application Insights**.

![Интерфейс для выбора Application Insights для получения диаграмм](./media/iot-solution-build-system/image12.png)

В основе этой функции лежит инструментирование приложения с помощью пакета SDK для Application Insights.

Чтобы добавить пользовательскую телеметрию (или инструментировать приложение, запущенное вне Azure), во время разработки нужно [добавить пакет SDK для Application Insights](../application-insights/app-insights-asp-net.md). Это позволяет вести журнал показателей, которые зависят от приложения, например среднее или общее расстояние поездки. В Visual Studio щелкните правой кнопкой мыши проект и выберите пункт **Добавление Application Insights**.

![Интерфейс для выбора элемента "Добавление Application Insights" для добавления пользовательской телеметрии](./media/iot-solution-build-system/image10.png)

Application Insights будет отправлять оповещения по электронной почте при обнаружении необычного числа ответов о сбое. Можно также настроить собственные оповещения о различных метриках, например, о времени отклика.

Чтобы гарантировать, что веб-служба всегда будет запущена и работоспособна, можно настроить [тесты доступности](../application-insights/app-insights-monitor-web-app-availability.md). Эти тесты каждые 15 минут проверяют связь с сайтом из различных расположений по всему миру. Опять же, в случае возникновения каких-либо проблем вы получите электронное сообщение.

## Оценка эксплуатационных расходов

Работа такого приложения при небольшом масштабе обходится достаточно дешево. Для многих служб предусмотрены бесплатные начальные уровни, поэтому разработка и использование приложения в небольшом масштабе не влечет существенных затрат. К тому же в приложениях необязательно использовать все возможности, демонстрируемые в MyDriving.

Ниже приведена приблизительная оценка затрат на настройку параметров разработки для MyDriving. Мы также отметим некоторые альтернативные варианты, которые мы *не* использовали. Эти сведения могут быть полезны при оценке своих собственных затрат.

Предполагается следующий сценарий:

-   группа максимум из пяти человек (а также наблюдающие заинтересованные лица);

-   приложение будет работать примерно месяц;

-   100 пользователей с четырьмя поездками в день.

>[AZURE.NOTE] Если вы новичок в Azure, то можете воспользоваться [бесплатной учетной записью](https://azure.microsoft.com/free/).

| **Служба или компонент** | **Примечания** | **Стоимость в месяц** |
|--------|--------|----------------|
| [Visual Studio 2015 Community](https://www.visualstudio.com/products/visual-studio-community-vs) с [Xamarin](https://visualstudiogallery.msdn.microsoft.com/dcd5b7bd-48f0-4245-80b6-002d22ea6eee) <br/>Кроссплатформенная среда разработки.| Visual Studio Community. (Для разработки кроссплатформенной среды с единой базой кода требуется [Visual Studio Professional](https://www.visualstudio.com/vs-2015-product-editions) для [Xamarin.Forms](https://xamarin.com/forms).) | 0 долл. США |
| [Центр IoT Azure](https://azure.microsoft.com/pricing/details/iot-hub/) <br/>Двунаправленное подключение данных к устройствам. | 8000 сообщений плюс 0,5 КБ данных на сообщение — бесплатно. | 0 долл. США |
| [Stream Analytics](https://azure.microsoft.com/pricing/details/stream-analytics/) <br/>Обработка большого объема потоковых данных. | Если включена, взимается 0,031 долл. США за единицу потоковой передачи в час. Вы сами выбираете число единиц потоковой передачи. Можно выбрать дополнительные единицы для увеличения масштаба. | 23 долл. США |
| [Машинное обучение Azure](https://azure.microsoft.com/documentation/services/machine-learning/) <br/>Адаптивные ответы. | 10 долл. США за рабочее место в месяц.<br/> Плюс 3 часа эксперимента * 1 долл. США за час эксперимента. <br/> + 3,5 часа процессорного времени API * 2 долл. США за час рабочего ЦП. <br/> Во времени ЦП API учитываются затраты 5 минут в день на повторное обучение, однако это значение будет увеличиваться по мере роста объема входных данных. <br/> Плюс 2 минуты в день на оценку для обработки 400 поездок в день. | 20 долл. США |
| [Служба приложений](https://azure.microsoft.com/pricing/details/app-service/) <br/>Размещение серверной части мобильной службы. | Уровень B1 — рабочие веб-приложения. | 56 долл. США |
| [Visual Studio Team Services](https://azure.microsoft.com/pricing/details/visual-studio-team-services/) <br/>Сборка, модульное тестирование и управление выпусками, управление задачами. | Частные агенты, пять пользователей.| 0 долл. США |
| [Application Insights](https://azure.microsoft.com/pricing/details/application-insights/) <br/>Мониторинг производительности и использования веб-служб и сайтов.| Уровень "Бесплатный". | 0 долл. США |
| [HockeyApp](http://hockeyapp.net/pricing/) <br/>Распространение бета-версий приложений, а также сбор отзывов и данных об использовании и сбоях. | Два бесплатных приложения для новых пользователей.<br/> Затем 30 долл. США в месяц. | 0 долл. США |
| [Xamarin](https://store.xamarin.com/) <br/>Программирование для универсальной платформы, подходящей для нескольких устройств. | Бесплатная пробная версия. <br/>Затем 25 долл. США в месяц.| 0 долл. США |
| [База данных SQL](https://azure.microsoft.com/pricing/details/sql-database/) для службы приложений Azure.| Уровень "Базовый"; модель отдельных баз данных. | 5 долл. США |
| [Service Fabric](../service-fabric/services/service-fabric.md) (необязательно). | Запуск локального кластера. | 0 долл. США |
| [Power BI](https://powerbi.microsoft.com/pricing/) <br/>Универсальное средство отображения и исследования потоковых и статических данных.| Уровень "Бесплатный": 1 ГБ, 10 000 строк в час, ежедневное обновление. <br/> 10 долл. США за пользователя в месяц: [более высокие лимиты](https://powerbi.microsoft.com/documentation/powerbi-power-bi-pro-content-what-is-it/), дополнительные варианты подключения, совместная работа. | 0 долл. США |
| [Хранилище](https://azure.microsoft.com/pricing/details/storage/) | Локально избыточное хранилище до 100 ГБ по 0,024 долл. США за 1 ГБ. | 3 долл. США |
| [Фабрика данных](https://azure.microsoft.com/pricing/details/data-factory/) | 0,60 долл. США за действие* (8-5 FOC).| 2 долл. США |
| [HDInsight](https://azure.microsoft.com/pricing/details/hdinsight/) <br/>Кластер по требованию для ежедневного повторного обучения. | Три узла A3 за 0,32 долл. США в час ежедневно * 31 день. | 30 долл. США |
| [Концентраторы событий](https://azure.microsoft.com/pricing/details/event-hubs/) | Уровень "Базовый", 11 долл. США в месяц за единицу пропускной способности плюс 0,028 долл. США за входящие данные. | 11 долл. США |
| Аппаратный ключ OBD || 12 долл. США |
| **Всего**| | **157 долл. США** |

Дополнительные сведения см. в следующих статьях:

-   Сводка по [квотам и ограничениям на службы Azure](../azure-subscription-service-limits/#iot-hub-limits).

-   [Калькулятор стоимости](https://azure.microsoft.com/pricing/calculator/) Azure.

## Отправка отзывов

Мы создали MyDriving, чтобы помочь вам ускорить начало работы с системами IoT, и непременно хотим узнать о ваших впечатлениях о работе этого решения. Сообщите нам, если во время использования приложения вы столкнулись с такими ситуациями.

-  Возникли неполадки или проблемы.

-  У вас есть дополнительные замечания, которые помогут лучше адаптировать приложение для вашего сценария.

-  Вы нашли более эффективный способ выполнения определенных требований.

-  У вас есть предложения по улучшению MyDriving или этой документации.

Чтобы отправить отзыв, отправьте заявку на GitHub или оставьте комментарий ниже (на странице с английской версией статьи).

Мы будем рады узнать о ваших впечатлениях!

## Дальнейшие действия

Рекомендуется ознакомиться со [справочным руководством по MyDriving](http://aka.ms/mydrivingdocs), в котором содержится подробное описание архитектуры системы и ее компонентов.

<!---HONumber=AcomDC_0518_2016-->