---
title: Моделирование устройств с помощью решения удаленного мониторинга в Azure | Документация Майкрософт
description: В этом руководстве показано, как использовать симулятор устройств с акселератором решения для удаленного мониторинга.
services: iot-suite
suite: iot-suite
author: dominicbetts
manager: timlt
ms.author: dobett
ms.service: iot-suite
ms.date: 01/15/2018
ms.topic: article
ms.devlang: NA
ms.tgt_pltfrm: NA
ms.workload: NA
ms.openlocfilehash: 9b4f7f9a9c501204d48b738089dc3cbd015a744c
ms.sourcegitcommit: 688a394c4901590bbcf5351f9afdf9e8f0c89505
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/18/2018
---
# <a name="create-a-new-simulated-device"></a>Создание имитированного устройства

В этом руководстве показано, как настраивать микрослужбу моделирования устройств в акселераторе решения для удаленного мониторинга. Чтобы продемонстрировать возможности симулятора устройств, здесь рассматривается два сценария с приложением Интернета вещей компании Contoso.

В следующем видео представлен обзор возможностей настройки микрослужбы для симулятора устройства:

>[!VIDEO https://channel9.msdn.com/Shows/Internet-of-Things-Show/How-to-customize-the-Remote-Monitoring-Preconfigured-Solution-for-Azure-IoT/Player]

В первом сценарии компания Contoso планирует протестировать новое интеллектуальное устройство управления освещением. Чтобы сделать это, необходимо создать виртуальное устройство со следующими характеристиками:

*Свойства*

| ИМЯ                     | Значения                      |
| ------------------------ | --------------------------- |
| Цвет                    | Белый, красный, синий            |
| Яркость               | 0–100                    |
| Ожидаемое время работы | Обратный отсчет, начиная с 10 000 часов |

*Телеметрия*

В таблице ниже приведены данные, которые система освещения потоком передает в облако.

| ИМЯ   | Значения      |
| ------ | ----------- |
| Status | on, off |
| температура; | Градусы по Фаренгейту |
| в сети | true, false |

> [!NOTE]
> Значение телеметрии **в сети** является обязательным для всех типов имитации.

*Методы*

В таблице ниже приведены действия, поддерживаемые новым устройством.

| ИМЯ        |
| ----------- |
| Включение   |
| Выключение  |

*Начальное состояние*

В таблице ниже представлены начальные показатели устройства.

| ИМЯ                     | Значения |
| ------------------------ | -------|
| Начальный цвет            | Белый  |
| Начальная яркость       | 75     |
| Начальное ожидаемое время работы   | 10 000 |
| Начальное состояние передачи данных телеметрии | on   |
| Начальная температура телеметрии | 200   |

Во втором сценарии вы добавите новый тип телеметрии в имеющееся устройство **Chiller** компании Contoso.

В этом руководстве показано, как использовать симулятор устройств с акселератором решения для удаленного мониторинга:

Из этого руководства вы узнаете, как выполнять такие задачи:

>[!div class="checklist"]
> * создавать тип устройства;
> * моделировать реакцию на событие пользовательского устройства;
> * добавлять новый тип устройства на панель мониторинга;
> * отправлять пользовательские данные телеметрии из имеющегося типа устройства.

В следующем видео показано пошаговое соединение имитированного и реального устройств с решением для удаленного мониторинга.

>[!VIDEO https://channel9.msdn.com/Shows/Internet-of-Things-Show/Part-38-Customizing-Azure-IoT-Suite-solution-and-connect-a-real-device/Player]

## <a name="prerequisites"></a>предварительным требованиям

Чтобы выполнить это руководство, требуется:

* Развернутый экземпляр решения для удаленного мониторинга в подписке Azure. Если решение для удаленного мониторинга еще не развернуто, выполните инструкции по [развертыванию акселератора решений для удаленного мониторинга](../iot-accelerators/iot-accelerators-remote-monitoring-deploy.md).

* Visual Studio 2017. Если вы не установили Visual Studio 2017, вы можете скачать бесплатный выпуск [Visual Studio Community Edition](https://www.visualstudio.com/free-developer-offers/).

* Расширение [Cloud Explorer для Visual Studio 2017](https://marketplace.visualstudio.com/items?itemName=MicrosoftCloudExplorer.CloudExplorerforVS15Preview).

* Учетная запись в [центре Docker](https://hub.docker.com/). Зарегистрируйтесь бесплатно, чтобы начать работу.

* На настольном компьютере установлена [Git](https://git-scm.com/downloads).

## <a name="prepare-your-development-environment"></a>Подготовка среды разработки

Выполните приведенные ниже действия, чтобы подготовить среду разработки для добавления нового имитированного устройства в решение удаленного мониторинга.

### <a name="configure-ssh-access-to-the-solution-virtual-machine-in-azure"></a>Настройка доступа по протоколу SSH к виртуальной машине решения в Azure

При создании решения удаленного мониторинга на сайте [www.azureiotsuite.com](https://www.azureiotsuite.com) вы выбрали имя решения. Оно становится именем группы ресурсов Azure, которая содержит различные развернутые ресурсы, используемые решением. Следующие команды используют группу ресурсов с именем **Contoso-01**, **это имя** следует заменить на имя группы ресурсов.

Следующие команды используют команду `az` из [Azure CLI 2.0](https://docs.microsoft.com/cli/azure?view=azure-cli-latest). Вы можете установить Azure CLI 2.0 на своем компьютере разработки или использовать [Cloud Shell](https://docs.microsoft.com/azure/cloud-shell/overview) на [портале Azure](http://portal.azure.com). Azure CLI 2.0 предварительно установлен в Cloud Shell.

1. Чтобы проверить имя группы ресурсов, содержащей ресурсы удаленного мониторинга, выполните следующую команду:

    ```sh
    az group list | grep "name"
    ```

    Эта команда перечисляет все группы ресурсов в подписке. Этот список должен содержать группу ресурсов с тем же именем, что и у решения удаленного мониторинга.

1. Чтобы сделать группу ресурсов группой по умолчанию для последующих команд, выполните следующую команду, используя имя группы ресурсов вместо **Contoso-01**:

    ```sh
    az configure --defaults group=Contoso-01
    ```

1. Чтобы получить список ресурсов в группе ресурсов, выполните следующую команду:

    ```sh
    az resource list -o table
    ```

    Запишите имена виртуальной машины и группы безопасности сети. Эти значения понадобятся на последующих этапах.

1. Чтобы включить доступ по протоколу SSH к виртуальной машине, выполните следующую команду, подставив имя группы безопасности сети из предыдущего шага:

    ```sh
    az network nsg rule create --name SSH --nsg-name YOUR-NETWORK-SECURITY-GROUP --priority 101 --destination-port-ranges 22 --access Allow --protocol TCP
    ```

    Чтобы просмотреть список правил для входящих подключений сети, выполните следующую команду:

    ```sh
    az network nsg rule list --nsg-name YOUR-NETWORK-SECURITY-GROUP -o table
    ```

1. Чтобы изменить пароль виртуальной машины на известный, выполните следующую команду. Используйте имя виртуальной машины, записанное ранее, и пароль по своему выбору:

    ```sh
    az vm user update --name YOUR-VM-NAME --username azureuser --password YOUR-PASSWORD
    ```
1. Чтобы найти IP-адрес виртуальной машины, используйте следующую команду и запишите общедоступный IP-адрес:

    ```sh
    az vm list-ip-addresses --name YOUR-VM-NAME
    ```

1. Теперь к виртуальной машине можно подключаться по протоколу SSH. Команда `ssh` предварительно установлена в Cloud Shell. Используйте общедоступный IP-адрес из предыдущего шага и при появлении запроса на ввод укажите пароль, настроенный для виртуальной машины:

    ```sh
    ssh azureuser@public-ip-address
    ```

    Теперь у вас есть доступ к оболочке на виртуальной машине, где выполняются контейнеры Docker в решении удаленного мониторинга. Чтобы просмотреть выполняемые контейнеры, используйте следующую команду:

    ```sh
    docker ps
    ```

### <a name="find-the-service-connection-strings"></a>Поиск строк подключения службы

В этом руководстве вы работаете с решением Visual Studio, которое подключается к службам Cosmos DB и Центра Интернета вещей решения. Ниже показан один из способов найти необходимые значения строки подключения:

1. Чтобы найти строку подключения к Cosmos DB, выполните следующую команду в сеансе SSH, подключенном к виртуальной машине:

    ```sh
    sudo grep STORAGEADAPTER_DOCUMENTDB /app/env-vars
    ```

    Запишите строку подключения. Это значение используется далее в руководстве.

1. Чтобы найти строку подключения к Центру Интернета вещей, выполните следующую команду в сеансе SSH, подключенном к виртуальной машине:

    ```sh
    sudo grep IOTHUB_CONNSTRING /app/env-vars
    ```

    Запишите строку подключения. Это значение используется далее в руководстве.

> [!NOTE]
> Эти строки подключения также можно найти, перейдя на портал Azure или используя команду `az`.

### <a name="stop-the-device-simulation-service-in-the-virtual-machine"></a>Остановка службы моделирования устройств на виртуальной машине

При изменении службы моделирования устройств можно запустить ее локально, чтобы проверить внесенные изменения. Перед запуском службы моделирования устройств локально необходимо остановить экземпляр, работающий на виртуальной машине, следующим образом:

1. Чтобы найти **идентификатор контейнера** службы **device-simulation**, выполните следующую команду в сеансе SSH, подключенном к виртуальной машине:

    ```sh
    docker ps
    ```

    Запишите идентификатор контейнера службы **device-simulation**.

1. Чтобы остановить контейнер **device-simulation**, выполните следующую команду:

    ```sh
    docker stop container-id-from-previous-step
    ```

### <a name="clone-the-github-repositories"></a>Клонирование репозиториев GitHub

В этом руководстве вы работаете с проектами Visual Studio **device-simulation** и **storage-adapter**. Вы можете клонировать репозитории исходного кода с GitHub. Выполните это действие на локальном компьютере разработки, где установлена среда Visual Studio:

1. Откройте командную строку и перейдите к папке, в которой вы хотите сохранить копию репозиториев GitHub **device-simulation** и **storage-adapter**.

1. Чтобы клонировать версию .NET репозитория **device-simulation**, выполните следующую команду:

    ```cmd
    git clone https://github.com/Azure/device-simulation-dotnet.git
    ```

    Служба моделирования устройств в решении удаленного мониторинга позволяет вносить изменения в имеющиеся типы имитированных устройств, а также создавать другие. С помощью пользовательских типов устройств можно тестировать реакцию на событие решения удаленного мониторинга перед подключением к нему физических устройств.

1. Чтобы клонировать версию .NET репозитория **storage-adapter**, выполните следующую команду:

    ```cmd
    git clone https://github.com/Azure/pcs-storage-adapter-dotnet.git
    ```

    Служба моделирования устройств использует службу адаптера хранилища для подключения к службе Cosmos DB в Azure. Решение удаленного мониторинга хранит данные конфигурации имитированного устройства в базе данных Cosmos DB.

### <a name="run-the-storage-adapter-service-locally"></a>Запуск службы адаптера хранилища локально

Служба моделирования устройств использует службу адаптера хранилища для подключения к базе данных Cosmos DB решения. Если служба моделирования устройств выполняется локально, службу адаптера хранилища также необходимо выполнять локально. Ниже показано, как запустить службу адаптера хранилища из Visual Studio:

1. В Visual Studio откройте файл решения **pcs-storage-adapter.sln** в своей локальной копии репозитория **storage-adapter**.

1. В обозревателе решений щелкните правой кнопкой мыши проект **WebService**, выберите **Свойства**, а затем — **Отладка**.

1. В разделе **Переменные среды** измените значение переменной **PCS\_STORAGEADAPTER\_DOCUMENTDB\_CONNSTRING** на строку подключения к Cosmos DB, записанную ранее. Сохраните изменения.

1. В обозревателе решений щелкните проект **WebService** правой кнопкой мыши, выберите пункт **Отладка**, а затем щелкните **Запустить новый экземпляр**.

1. Служба запустится локально и откроет адрес `http://localhost:9022/v1/status` в браузере по умолчанию. Убедитесь, что **состояние** имеет значение OK: Alive and well (ОК. Активно и работоспособно).

1. Пусть служба адаптера хранилища выполняется локально, пока вы не завершите работу с руководством.

Теперь у вас есть все необходимое и можно приступить к добавлению нового типа имитированного устройства в решение удаленного мониторинга.

## <a name="create-a-simulated-device-type"></a>Создание типа виртуального устройства

Тип устройства в службе моделирования устройств проще всего создать, скопировав и изменив имеющийся тип. Ниже показано, как скопировать встроенное устройство **Chiller**, чтобы создать устройство **Lightbulb**.

1. В Visual Studio откройте файл решения **device-simulation.sln** в локальной копии репозитория **device-simulation**.

1. В обозревателе решений щелкните правой кнопкой мыши проект **SimulationAgent**, выберите **Свойства**, а затем — **Отладка**.

1. В разделе **Переменные среды** измените значение переменной **PCS\_IOTHUB\_CONNSTRING** на строку подключения к Центру Интернета вещей, записанную ранее. Сохраните изменения.

1. В обозревателе решений щелкните правой кнопкой мыши проект **WebService**, выберите **Свойства**, а затем — **Отладка**.

1. В разделе **Переменные среды** измените значение переменной **PCS\_IOTHUB\_CONNSTRING** на строку подключения к Центру Интернета вещей, записанную ранее. Сохраните изменения.

1. В обозревателе решений щелкните правой кнопкой мыши решение **device-simulation** и выберите **Назначить запускаемые проекты**. Последовательно выберите **Один запускаемый проект** и **WebService**. Нажмите кнопку **ОК**.

1. Каждый тип устройства имеет файл модели JSON и связанные сценарии в папке **Services/data/devicemodels**. В обозревателе решений скопируйте приведенные в таблице ниже файлы **Chiller**, чтобы на их основе создать файлы **Lightbulb**:

    | Источник                      | Место назначения                   |
    | --------------------------- | ----------------------------- |
    | chiller-01.json             | lightbulb-01.json             |
    | scripts/chiller-01-state.js | scripts/lightbulb-01-state.js |
    | scripts/reboot-method.js    | scripts/SwitchOn-method.js    |

### <a name="define-the-characteristics-of-the-new-device-type"></a>Определение характеристик нового типа устройства

Характеристики типа устройства, например создаваемые им данные телеметрии и поддерживаемые методы, определены в файле **lightbulb-01.json**. Ниже показано, как изменить файл **lightbulb-01.json**, чтобы определить характеристики устройства **Lightbulb**.

1. В файле **lightbulb-01.json** измените метаданные устройства, как показано в следующем фрагменте кода:

    ```json
    "SchemaVersion": "1.0.0",
    "Id": "lightbulb-01",
    "Version": "0.0.1",
    "Name": "Lightbulb",
    "Description": "Smart lightbulb device.",
    "Protocol": "MQTT",
    ```

1. В файле **lightbulb-01.json** измените определение имитирования, как показано в следующем фрагменте кода:

    ```json
    "Simulation": {
      "InitialState": {
        "online": true,
        "temperature": 200.0,
        "temperature_unit": "F",
        "status": "on"
      },
      "Interval": "00:00:20",
      "Scripts": [
        {
          "Type": "javascript",
          "Path": "lightbulb-01-state.js"
        }
      ]
    },
    ```

1. В файле **lightbulb-01.json** измените тип свойств, как показано в следующем фрагменте кода:

    ```json
    "Properties": {
      "Type": "Lightbulb",
      "Color": "White",
      "Brightness": 75,
      "EstimatedRemainingLife": 10000
    },
    ```

1. В файле **lightbulb-01.json** обновите определения телеметрии типа устройств, как показано в следующем фрагменте кода:

    ```json
    "Telemetry": [
      {
        "Interval": "00:00:20",
        "MessageTemplate": "{\"temperature\":${temperature},\"temperature_unit\":\"${temperature_unit}\",\"status\":\"${status}\"}",
        "MessageSchema": {
          "Name": "lightbulb-status;v1",
          "Format": "JSON",
          "Fields": {
            "temperature": "double",
            "temperature_unit": "text",
            "status": "text"
          }
        }
      }
    ],
    ```

1. В файле **lightbulb-01.json** обновите методы телеметрии типа устройств, как показано в следующем фрагменте кода:

    ```json
    "CloudToDeviceMethods": {
      "SwitchOn": {
        "Type": "javascript",
        "Path": "SwitchOn-method.js"
      },
      "SwitchOff": {
        "Type": "javascript",
        "Path": "SwitchOff-method.js"
      }
    }
    ```

1. Сохраните файл **lightbulb-01.json**.

### <a name="simulate-custom-device-behavior"></a>моделировать реакцию на событие пользовательского устройства;

Файл **scripts/lightbulb-01-state.js** определяет поведение имитации типа **Lightbulb**. Ниже показано, как изменить файл **scripts/lightbulb-01-state.js**, чтобы определить реакцию на событие устройства **Lightbulb**:

1. Измените определение состояния в файле **scripts/lightbulb-01-state.js**, как показано в следующем фрагменте кода:

    ```js
    // Default state
    var state = {
      online: true,
      temperature: 200.0,
      temperature_unit: "F",
      status: "on"
    };
    ```

1. Добавьте функцию **flip** после функции **vary** со следующим определением:

    ```js
    /**
    * Simple formula that sometimes flips the status of the lightbulb
    */
    function flip(value) {
      if (Math.random() < 0.2) {
        return (value == "on") ? "off" : "on"
      }
      return value;
    }
    ```

1. Измените функцию **main**, чтобы реализовать реакцию на событие, как показано в следующем фрагменте:

    ```js
    function main(context, previousState) {

      // Restore the global state before generating the new telemetry, so that
      // the telemetry can apply changes using the previous function state.
      restoreState(previousState);

      state.temperature = vary(200, 5, 150, 250);

      // Make this flip every so often
      state.status = flip(state.status);

      return state;
    }
    ```

1. Сохраните файл **scripts/lightbulb-01-state.js**.

Файл **scripts/SwitchOn-method.js** реализует метод **Switch On** в устройстве **Lightbulb**. В следующих шагах показано, как обновить файл **scripts/SwitchOn-method.js**:

1. Измените определение состояния в файле **scripts/SwitchOn-method.js**, как показано в следующем фрагменте кода:

    ```js
    var state = {
       status: "on"
    };
    ```

1. Чтобы включить освещение, измените функцию **main** следующим образом:

    ```js
    function main(context, previousState) {
        log("Executing lightbulb Switch On method.");
        state.status = "on";
        updateState(state);
    }
    ```

1. Сохраните файл **scripts/SwitchOn-method.js**.

1. Создайте копию файла **scripts/SwitchOn-method.js** с именем **scripts/SwitchOff-method.js**.

1. Чтобы отключить освещение, измените функцию **main** в файле **scripts/SwitchOff-method.js** следующим образом:

    ```js
    function main(context, previousState) {
        log("Executing lightbulb Switch Off method.");
        state.status = "off";
        updateState(state);
    }
    ```

1. Сохраните файл **scripts/SwitchOff-method.js**.

1. В обозревателе решений по очереди выберите каждый из четырех новых файлов. В окне **Свойства** для каждого файла убедитесь, что для параметра **Копировать в выходной каталог** задано значение **Копировать, если новее**.

### <a name="configure-the-device-simulation-service"></a>Настройка службы моделирования устройств

Чтобы ограничить количество имитированных устройств, которые подключаются к решению во время тестирования, настройте службу на запуск одного устройства Chiller и Lightbulb. Данные конфигурации хранятся в экземпляре Cosmos DB группы ресурсов решения. Чтобы изменить данные конфигурации, используйте представление **Cloud Explorer** в Visual Studio:

1. Чтобы открыть представление **Cloud Explorer** в Visual Studio, выберите **Представление**, а затем — **Cloud Explorer**.

1. Чтобы найти документ конфигурации имитации, в поле **Поиск ресурсов** введите **simualtions.1**.

1. Дважды щелкните документ **simulations.1**, чтобы открыть его для редактирования.

1. В значении для **данных** найдите массив **DeviceModels**, который выглядит, как следующий фрагмент кода:

    ```json
    [{\"Id\":\"chiller-01\",\"Count\":1},{\"Id\":\"chiller-02\",\"Count\":1},{\"Id\":\"elevator-01\",\"Count\":1},{\"Id\":\"elevator-02\",\"Count\":1},{\"Id\":\"engine-01\",\"Count\":1},{\"Id\":\"engine-02\",\"Count\":1},{\"Id\":\"prototype-01\",\"Count\":1},{\"Id\":\"prototype-02\",\"Count\":1},{\"Id\":\"truck-01\",\"Count\":1},{\"Id\":\"truck-02\",\"Count\":1}]
    ```

1. Чтобы определить имитированное устройство типа Chiller и Lightbulb, замените массив **DeviceModels** следующим кодом:

    ```json
    [{\"Id\":\"chiller-01\",\"Count\":1},{\"Id\":\"lightbulb-01\",\"Count\":1}]
    ```

    Сохраните изменения в документе **simulations.1**.

> [!NOTE]
> Документ **simulations.1** также можно изменить в обозревателе данных Cosmos DB на портале Azure.

### <a name="test-the-lightbulb-device-type-locally"></a>Тестирование типа устройства Lightbulb локально

Теперь все готово для тестирования нового имитированного устройства типа Lightbulb, запустив проект моделирования устройства локально.

1. В обозревателе решений щелкните **WebService** правой кнопкой мыши. Затем последовательно выберите **Отладка** и **Запустить новый экземпляр**.

1. Чтобы проверить, подключены ли имитированные устройства к Центру Интернета вещей, откройте портал Azure в своем браузере.

1. Перейдите к Центру Интернета вещей в группе ресурсов, содержащей решение для удаленного мониторинга.

1. В разделе **Мониторинг** щелкните **Метрики**. Убедитесь, что число **подключенных устройств** равно двум:

    ![Количество подключенных клиентов](media/iot-suite-remote-monitoring-test/connecteddevices.png)

1. В браузере перейдите к **панели мониторинга** решения удаленного мониторинга. На панели телеметрии **панели мониторинга** выберите вкладку **температура**. На диаграмме появятся значения температуры для всех имитированных устройств:

    ![Данные телеметрии температуры](media/iot-suite-remote-monitoring-test/telemetry.png)

Теперь у вас есть имитированное устройство управления освещением, выполняемое локально. На следующем шаге обновленная служба моделирования развертывается на виртуальной машине, где выполняются удаленные микрослужбы мониторинга Azure.

Прежде чем продолжить, вы можете остановить отладку проектов имитации устройства и адаптера хранилища в Visual Studio.

### <a name="deploy-the-updated-simulator-to-the-cloud"></a>Развертывание обновленной службы моделирования в облако

Микрослужбы в решении удаленного мониторинга выполняются в контейнерах Docker, которые размещаются в виртуальной машине решения в Azure. В этом разделе выполняются следующие действия:

* создание образа Docker для моделирования устройства;
* передача образа в репозиторий центра Docker;
* импорт образа на виртуальную машину решения.

В следующих шагах предполагается, что в вашей учетной записи центра Docker есть репозиторий с именем **lightbulb**.

1. В Visual Studio в проекте **device-simulation** откройте файл **solution\scripts\docker\build.cmd**.

1. Измените строку, которая задает переменную среды **DOCKER_IMAGE**, на имя репозитория центра Docker:

    ```cmd
    SET DOCKER_IMAGE=your-docker-hub-acccount/lightbulb
    ```

    Сохраните изменения.

1. В Visual Studio в проекте **device-simulation** откройте файл **solution\scripts\docker\publish.cmd**.

1. Измените строку, которая задает переменную среды **DOCKER_IMAGE**, на имя репозитория центра Docker:

    ```cmd
    SET DOCKER_IMAGE=your-docker-hub-acccount/lightbulb
    ```

    Сохраните изменения.

1. Запустите командную строку от имени администратора. Затем перейдите в папку **scripts\docker** в копии репозитория GitHub **device-simulation**.

1. Чтобы создать образ Docker, выполните следующую команду:

    ```cmd
    build.cmd
    ```

1. Чтобы войти в учетную запись центра Docker, выполните следующую команду:

    ```cmd
    docker login
    ```

1. Чтобы отправить новый образ в учетную запись центра Docker, выполните следующую команду:

    ```cmd
    publish.cmd
    ```

1. Чтобы проверить отправку, перейдите по адресу [https://hub.docker.com/](https://hub.docker.com/). Найдите репозиторий **lightbulb** и выберите **Сведения**. Затем выберите **Теги**:

    ![Центр Docker](media/iot-suite-remote-monitoring-test/dockerhub.png)

    При выполнении сценариев в образ был добавлен тег **testing**.

1. Подключитесь к виртуальной машине решения в Azure по протоколу SSH. Затем перейдите в папку **App** и измените файл **docker-compose.yaml**:

    ```sh
    cd /app
    sudo nano docker-compose.yaml
    ```

1. Измените запись для службы моделирования устройств, чтобы использовать образ Docker:

    ```yaml
    devicesimulation:
      image: {your docker ID}/lightbulb:testing
    ```

    Сохраните изменения.

1. Чтобы перезапустить все службы с использованием новых параметров, выполните следующую команду:

    ```sh
    sudo ./start.sh
    ```

1. Чтобы проверить файл журнала в новом контейнере моделирования устройства, выполните следующую команду для поиска идентификатора контейнера:

    ```sh
    docker ps
    ```

    Затем выполните следующую команду, используя идентификатор контейнера:

    ```sh
    docker logs {container ID}
    ```

Вы завершили шаги по развертыванию обновленной версии службы моделирования устройств в решении удаленного мониторинга.

В браузере перейдите к **панели мониторинга** решения удаленного мониторинга. На панели телеметрии **панели мониторинга** выберите вкладку **температура**. На диаграмме появятся значения температуры для двух имитированных устройств:

![Данные телеметрии температуры](media/iot-suite-remote-monitoring-test/telemetry.png)

Экземпляры нового типа можно подготовить на странице **Устройства**:

![Просмотр списка доступных виртуальных устройств](media/iot-suite-remote-monitoring-test/devicesmodellist.png)

Вы можете просмотреть данные телеметрии из виртуального устройства:

![Просмотр данных телеметрии устройства Lightbulb](media/iot-suite-remote-monitoring-test/devicestelemetry.png)

Вы можете вызвать методы **SwitchOn** и **SwitchOff** на устройстве:

![Вызов методов устройства Lightbulb](media/iot-suite-remote-monitoring-test/devicesmethods.png)

## <a name="add-a-new-telemetry-type"></a>Добавление нового типа данных телеметрии

В этом разделе описано, как изменить имеющийся тип виртуального устройства, чтобы реализовать поддержку нового типа данных телеметрии.

### <a name="locate-the-chiller-device-type-files"></a>Получение файлов типа устройства Chiller

Ниже показано, как найти файлы, определяющие встроенное устройство **Chiller**.

1. Выполните команду ниже, чтобы клонировать репозиторий **device-simulation** GitHub на локальный компьютер (если вы еще не сделали это).

    ```cmd/sh
    git clone https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet.git
    ```

1. Каждый тип устройства имеет JSON-файл модели и связанные скрипты. Они хранятся в папке `data/devicemodels`. Тип виртуального устройства **Chiller** определен в следующих файлах:

    * **data/devicemodels/chiller-01.json**
    * **data/devicemodels/scripts/chiller-01-state.js**

### <a name="specify-the-new-telemetry-type"></a>Указание нового типа данных телеметрии

Ниже показано, как добавить новый тип данных телеметрии (**Внутренняя температура**) в тип устройства **Chiller**.

1. Откройте файл **chiller-01.json**.

1. Измените значение **SchemaVersion** следующим образом:

    ```json
    "SchemaVersion": "1.1.0",
    ```

1. В разделе **InitialState** добавьте два следующих определения:

    ```json
    "internal_temperature": 65.0,
    "internal_temperature_unit": "F",
    ```

1. В массиве **Telemetry** добавьте следующее определение:

    ```json
    {
      "Interval": "00:00:05",
      "MessageTemplate": "{\"internal_temperature\":${internal_temperature},\"internal_temperature_unit\":\"${internal_temperature_unit}\"}",
      "MessageSchema": {
        "Name": "chiller-internal-temperature;v1",
        "Format": "JSON",
        "Fields": {
          "temperature": "double",
          "temperature_unit": "text"
        }
      }
    },
    ```

1. Сохраните файл **chiller-01.json**.

1. Откройте файл **scripts/chiller-01-state.js**.

1. Добавьте в переменную **state** следующие поля:

    ```js
    internal_temperature: 65.0,
    internal_temperature_unit: "F",
    ```

1. Добавьте следующую строку в функцию **main**:

    ```js
    state.internal_temperature = vary(65, 2, 15, 125);
    ```

1. Сохраните файл **scripts/chiller-01-state.js**.

### <a name="test-the-chiller-device-type"></a>Тестирование типа устройства Chiller

Чтобы протестировать измененный тип устройства **Chiller**, сначала нужно проверить реакцию на событие своего типа устройства, запустив локальную копию службы **device-simulation**. Проверив и завершив отладку измененного типа устройства в локальной среде, вы можете перестроить контейнер и повторно развернуть службу **device-simulation** в Azure.

При запуске службы **device-simulation** в локальной среде она отправляет данные телеметрии в решение для удаленного мониторинга. Экземпляры измененного типа можно подготовить на странице **Устройства**.

Дополнительные сведения о тестировании и отладке изменений локально см. в разделе [Тестирование типа устройства Lightbulb локально](#test-the-lightbulb-device-type-locally).

Сведения о развертывании обновленной службы моделирования устройств на виртуальной машине решения см. в предыдущем разделе [Развертывание обновленной службы моделирования в облако](#deploy-the-updated-simulator-to-the-cloud).

Экземпляры измененного типа можно подготовить на странице **Устройства**:

![Добавление измененного устройства Chiller](media/iot-suite-remote-monitoring-test/devicesupdatedchiller.png)

На виртуальном устройстве можно просмотреть данные телеметрии **Внутренняя температура**.

## <a name="next-steps"></a>Дополнительная информация

В рамках этого руководства вы узнали, как:

<!-- Repeat task list from intro -->
>[!div class="checklist"]
> * создавать тип устройства;
> * моделировать реакцию на событие пользовательского устройства;
> * добавлять новый тип устройства на панель мониторинга;
> * отправлять пользовательские данные телеметрии из имеющегося типа устройства.

Теперь вы знаете, как настраивать службу моделирования устройств. Далее мы предлагаем вам ознакомиться со статьей [Подключение устройства к предварительно настроенному решению для удаленного мониторинга (Node.js)](iot-suite-connecting-devices-node.md).

Дополнительные сведения для разработчиков о решении удаленного мониторинга см. в следующих источниках:

* [Справочник разработчика](https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/wiki/Developer-Reference-Guide)
* [Руководство по устранению неполадок для разработчиков](https://github.com/Azure/azure-iot-pcs-remote-monitoring-dotnet/wiki/Developer-Troubleshooting-Guide)

<!-- Next tutorials in the sequence -->
