---
title: "Резервное копирование фермы SharePoint с помощью сервера резервного копирования Azure | Документация Майкрософт"
description: "Резервное копирование данных SharePoint с помощью Azure Backup Server. Эта статья содержит информацию о настройке фермы SharePoint для сохранения нужных данных в Azure. Защищенные данные SharePoint можно восстановить с диска или из Azure."
services: backup
documentationcenter: 
author: pvrk
manager: shivamg
editor: 
ms.assetid: 34ba87a4-91f1-4054-a4a1-272af1e15496
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/24/2017
ms.author: pullabhk
ms.openlocfilehash: 3ed000affd326eb1bd7c99773ec021ad6e03cc3b
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="back-up-a-sharepoint-farm-to-azure"></a>Архивация фермы SharePoint в Azure
Резервное копирование SharePoint в Microsoft Azure с помощью Microsoft Azure Backup Server (MABS) во многом напоминает резервное копирование других источников данных. Служба архивации Azure позволяет гибко планировать архивацию, задавая ежедневные, еженедельные, ежемесячные или ежегодные точки архивации, и предоставляет параметры политики хранения для любой из этих точек. Также она позволяет сохранять копии локальных дисков для краткосрочных целей времени восстановления, а также сохранять копии в Azure для экономичного и длительного хранения.

## <a name="sharepoint-supported-versions-and-related-protection-scenarios"></a>Поддерживаемые версии SharePoint и соответствующие сценарии защиты
Служба архивации Azure для DPM поддерживает следующие сценарии:

| Рабочая нагрузка | Версия | Развертывание SharePoint | Защита и восстановление |
| --- | --- | --- | --- | --- | --- |
| SharePoint |SharePoint 2013, SharePoint 2010, SharePoint 2007, SharePoint 3.0 |SharePoint разворачивается как физический сервер или виртуальная машина Hyper-V/VMware  <br> -------------- <br> SQL AlwaysOn | Параметры восстановления фермы SharePoint: ферма, база данных, файл или элемент списка для восстановления из точек восстановления диска.  Восстановление фермы и базы данных из точек восстановления Azure. |

## <a name="before-you-start"></a>Перед началом работы
Перед архивацией фермы SharePoint в Azure необходимо выполнить некоторые действия.

### <a name="prerequisites"></a>предварительным требованиям
Прежде чем продолжить, [установили и подготовили Azure Backup Server](backup-azure-microsoft-azure-backup.md) для защиты рабочих нагрузок.

### <a name="protection-agent"></a>Агент защиты
Агент защиты необходимо установить на все серверы, где работает SharePoint или SQL Server, и на все остальные серверы, входящие в ферму SharePoint. Дополнительные сведения о настройке агента защиты см. в статье [Настройка защиты для SharePoint](https://technet.microsoft.com/library/hh758034\(v=sc.12\).aspx).  Единственное исключение состоит в том, что агент устанавливается только на один интерфейсный веб-сервер. DPM требует установки агента только на один интерфейсный веб-сервер, который будет служить точкой входа для защиты.

### <a name="sharepoint-farm"></a>Ферма SharePoint
На каждые 10 млн элементов, содержащихся в ферме, требуется не менее 2 ГБ памяти в томе, где находится папка MABS. Эта память нужна для создания каталога. Чтобы сервер MABS мог восстанавливать определенные элементы (семейства веб-сайтов, сайты, списки, библиотеки документов, папки, документов или элементы списков), операция создания каталога формирует список URL-адресов, сохраняемых в каждой базе данных контента. Этот список URL-адресов можно просмотреть в консоли администратора MABS, открыв панель восстанавливаемых элементов в области задач **Восстановление**.

### <a name="sql-server"></a>SQL Server;
MABS запускается от имени учетной записи LocalSystem. Чтобы сервер MABS мог создавать резервные копии баз данных SQL Server, эта учетная запись должна иметь права системного администратора для того сервера, на котором выполняется SQL Server. Установите для параметра NT AUTHORITY\SYSTEM значение *sysadmin* на сервере под управлением SQL Server, для которого нужно создать резервную копию.

Если в ферме SharePoint есть базы данных SQL Server, настроенные с псевдонимами SQL Server, установите клиентские компоненты SQL Server на интерфейсный веб-сервер, защищаемый MABS.

### <a name="sharepoint-server"></a>SharePoint Server
Производительность системы зависит от многих факторов, включая размер фермы SharePoint. Как правило, для защиты фермы SharePoint объемом 25 ТБ используется один сервер MABS.

### <a name="whats-not-supported"></a>Что не поддерживается
* Защита фермы SharePoint с помощью MABS не охватывает индексы поиска или базы данных службы приложений. Защиту этих баз данных необходимо настраивать отдельно.
* MABS не поддерживает резервное копирование баз данных SharePoint SQL Server, размещенных в общих хранилищах на масштабируемом файловом сервере.

## <a name="configure-sharepoint-protection"></a>Настройка защиты SharePoint
Чтобы использовать MABS для защиты SharePoint, сначала нужно настроить службу модуля записи VSS SharePoint (службу модуля записи WSS) с помощью файла **ConfigureSharePoint.exe**.

Файл **ConfigureSharePoint.exe** находится в папке [путь_установки_MABS]\bin на интерфейсном веб-сервере. Он позволяет установить агент защиты с учетными данными для фермы SharePoint. Файл нужно распаковать на одном интерфейсном веб-сервере. Если у вас таких серверов несколько, выберите один из них для настройки группы защиты.

### <a name="to-configure-the-sharepoint-vss-writer-service"></a>Настройка службы модуля записи VSS SharePoint
1. На интерфейсном веб-сервере откройте командную строку и перейдите в папку [путь установки MABS]\bin\.
2. Введите ConfigureSharePoint -EnableSharePointProtection.
3. Введите учетные данные администратора фермы. Эта учетная запись должна быть членом локальной группы администраторов на интерфейсном веб-сервере. Если администратор фермы не является локальным администратором, предоставьте на интерфейсном веб-сервере следующие разрешения:
   * Предоставьте группе WSS_Admin_WPG полный доступ к папке DPM (%Program Files%\Microsoft Azure Backup\DPM).
   * Предоставьте группе WSS_Admin_WPG право чтения реестра DPM (HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Data Protection Manager).

> [!NOTE]
> После каждого изменения в учетных данных администратора фермы SharePoint файл ConfigureSharePoint.exe необходимо перезапускать.
>
>

## <a name="back-up-a-sharepoint-farm-by-using-mabs"></a>Архивация фермы SharePoint с помощью MABS
Когда вы примените для DPM и фермы SharePoint все указанные выше настройки, можно развернуть защиту SharePoint с помощью MABS.

### <a name="to-protect-a-sharepoint-farm"></a>Защита фермы SharePoint
1. На вкладке **Защита** консоли администратора MABS нажмите кнопку **Создать**.
    ![Вкладка создания защиты](./media/backup-azure-backup-sharepoint/dpm-new-protection-tab.png)
2. На странице **Выбор типа группы защиты** мастера **создания группы защиты** выберите **Серверы** и нажмите кнопку **Далее**.

    ![Выберите тип группы защиты](./media/backup-azure-backup-sharepoint/select-protection-group-type.png)
3. На экране **Выбор элементов группы** установите флажок для сервера SharePoint, который нужно защитить, и нажмите кнопку **Далее**.

    ![Выберите членов группы](./media/backup-azure-backup-sharepoint/select-group-members2.png)

   > [!NOTE]
   > Если агент защиты установлен, сервер виден в мастере. Также сервер MABS отображает его структуру. Так как файл ConfigureSharePoint.exe запущен, MABS обменивается данными со службой модуля записи VSS SharePoint и соответствующими базами данных SQL Server, а также распознает структуру фермы SharePoint, связанные базы данных контента и все соответствующие элементы.
   >
   >
4. На странице **Выбор метода защиты данных** введите имя группы защиты в поле **Имя группы защиты** и выберите желаемые *методы защиты*. Нажмите кнопку **Далее**.

    ![Выберите метод защиты данных](./media/backup-azure-backup-sharepoint/select-data-protection-method1.png)

   > [!NOTE]
   > С помощью метода защиты диска можно удовлетворить краткосрочные цели времени восстановления.
   >
   >
5. На странице **Выбор краткосрочных целей** выберите желаемый диапазон хранения в поле **Диапазон хранения** и укажите время создания резервных копий.

    ![Выберите краткосрочные цели](./media/backup-azure-backup-sharepoint/specify-short-term-goals2.png)

   > [!NOTE]
   > Так как восстановления обычно требуют данные менее чем за пять последних дней, в данном примере выбран пятидневный диапазон хранения на диске и назначена архивация на нерабочее время.
   >
   >
6. Проверьте, какой объем дискового пространства в пуле носителей выделен для группы защиты, и нажмите кнопку **Далее**.
7. Для каждой группы защиты MABS выделяет дисковую память для хранения и администрирования реплик. На этом этапе MABS должен создать копию выбранных данных. Выберите способ и время создания реплики и нажмите кнопку **Далее**.

    ![Выберите метод создания реплики](./media/backup-azure-backup-sharepoint/choose-replica-creation-method.png)

   > [!NOTE]
   > Чтобы не мешать сетевому трафику, выбирайте нерабочее время.
   >
   >
8. MABS обеспечивает целостность данных за счет проверки реплик на согласованность. Доступны два параметра. Вы можете установить расписание проверок согласованности или DPM может выполнять такие проверки в реплике автоматически, как только она становится несогласованной. Выберите желаемый параметр и нажмите кнопку **Далее**.

    ![Проверка согласованности](./media/backup-azure-backup-sharepoint/consistency-check.png)
9. На странице **Указание данных для оперативной защиты** выберите ферму SharePoint, которую нужно защитить, и нажмите кнопку **Далее**.

    ![DPM SharePoint Protection1](./media/backup-azure-backup-sharepoint/select-online-protection1.png)
10. На странице **Указание данных для оперативной защиты** выберите желаемое расписание и нажмите кнопку **Далее**.

    ![Online_backup_schedule](./media/backup-azure-backup-sharepoint/specify-online-backup-schedule.png)

    > [!NOTE]
    > MABS поддерживает не более двух резервных копий в Azure за день на основе последней доступной точки резервного копирования диска. Служба архивации Azure также может контролировать объем пропускной способности глобальной сети, который может использоваться для архивации в пиковые и непиковые часы, с помощью [регулирования сети службы архивации Azure](https://azure.microsoft.com/documentation/articles/backup-configure-vault/#enable-network-throttling).
    >
    >
11. В зависимости от выбранного расписания архивации на странице **Укажите политику хранения в сети** выберите политику хранения для ежедневных, еженедельных, ежемесячных и ежегодных точек архивации.

    ![Online_retention_policy](./media/backup-azure-backup-sharepoint/specify-online-retention.png)

    > [!NOTE]
    > MABS использует трехуровневую схему хранения, которая позволяет выбирать разную политику хранения для разных точек резервного копирования.
    >
    >
12. Как и диск, реплика начальной контрольной точки должна быть создана в Azure. Выберите желаемый параметр для создания начальной резервной копии в Azure и нажмите кнопку **Далее**.

    ![Online_replica](./media/backup-azure-backup-sharepoint/online-replication.png)
13. Просмотрите выбранные параметры на странице **Сводка** и нажмите кнопку **Создать группу**. После создания группы защиты появится сообщение об успешном выполнении операции.

    ![Сводка](./media/backup-azure-backup-sharepoint/summary.png)

## <a name="restore-a-sharepoint-item-from-disk-by-using-mabs"></a>Восстановление элемента SharePoint с диска с помощью MABS
В приведенном ниже примере *элемент восстановления SharePoint* был случайно удален и должен быть восстановлен.
![DPM SharePoint Protection4](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection5.png)

1. Откройте **консоль администратора DPM**. На вкладке **Защита** отображаются все фермы SharePoint, защищаемые DPM.

    ![MABS SharePoint Protection3](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection4.png)
2. Чтобы начать восстановление элемента, откройте вкладку **Восстановление** .

    ![MABS SharePoint Protection5](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection6.png)
3. Чтобы найти *элемент восстановления SharePoint* , можно использовать поиск на основе подстановки в пределах диапазона точек восстановления.

    ![MABS SharePoint Protection6](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection7.png)
4. Найдите в результатах поиска нужную точку восстановления, щелкните элемент правой кнопкой мыши и выберите пункт **Восстановить**.
5. Вы можете просмотреть разные точки восстановления и выбрать базу данных или элементы для восстановления. Выберите **дату и время восстановления**, а затем выберите **базу данных, ферму SharePoint, точку восстановления и элемент** в соответствующих полях.

    ![MABS SharePoint Protection7](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection8.png)
6. Щелкните элемент правой кнопкой мыши и выберите параметр **Восстановить**, чтобы открыть **мастер восстановления**. Нажмите кнопку **Далее**.

    ![Просмотр выбранных параметров восстановления](./media/backup-azure-backup-sharepoint/review-recovery-selection.png)
7. Выберите желаемый тип восстановления и нажмите кнопку **Далее**.

    ![Тип восстановления](./media/backup-azure-backup-sharepoint/select-recovery-type.png)

   > [!NOTE]
   > Выбранный в примере параметр **Восстановить в исходное местоположение** восстанавливает элемент на исходный сайт SharePoint.
   >
   >
8. Выберите желаемый **процесс восстановления** на соответствующей странице мастера.

   * Если ферма SharePoint не изменилась и находится в том же состоянии, что и в указанной точке восстановления, выберите **Восстановить без фермы восстановления** .
   * Если с момента создания точки восстановления ферма SharePoint изменилась, выберите вариант **Восстановление с использованием фермы восстановления** .

     ![процесс восстановления](./media/backup-azure-backup-sharepoint/recovery-process.png)
9. Укажите размещение промежуточного экземпляра SQL Server для временного восстановления базы данных, а также промежуточную общую папку на сервере MABS и на сервере, где выполняется SharePoint, для восстановления элемента.

    ![Расположение промежуточного хранения 1](./media/backup-azure-backup-sharepoint/staging-location1.png)

    Сервер MABS присоединяет базу данных контента, в которой размещается элемент SharePoint, к временному экземпляру SQL Server. Затем он восстанавливает элемент из базы данных контента и помещает его в промежуточную папку на сервере MABS. Теперь элемент, восстановленный в папке промежуточного хранения, нужно экспортировать в папку промежуточного хранения на ферме SharePoint.

    ![Расположение промежуточного хранения 2](./media/backup-azure-backup-sharepoint/staging-location2.png)
10. Откройте страницу **Указание параметров восстановления**и примените параметры безопасности к ферме SharePoint или к точке восстановления. Нажмите кнопку **Далее**.

    ![Варианты восстановления](./media/backup-azure-backup-sharepoint/recovery-options.png)

    > [!NOTE]
    > Здесь же можно отрегулировать использование пропускной способности сети. Это позволит сократить нежелательную нагрузку на сервер в рабочие часы.
    >
    >
11. Просмотрите сводные данные и нажмите кнопку **Восстановить** , чтобы начать восстановление файла.

    ![Сводка параметров восстановления](./media/backup-azure-backup-sharepoint/recovery-summary.png)
12. Теперь откройте вкладку **Мониторинг** в **консоли администратора MABS** и проверьте **состояние** восстановления.

    ![Состояние восстановления](./media/backup-azure-backup-sharepoint/recovery-monitoring.png)

    > [!NOTE]
    > Файл восстановлен. Обновите сайт SharePoint, чтобы проверить восстановленный файл.
    >
    >

## <a name="restore-a-sharepoint-database-from-azure-by-using-dpm"></a>Восстановление базы данных SharePoint из Azure с помощью DPM
1. Чтобы восстановить базу данных контента SharePoint, просмотрите различные точки восстановления (как было показано ранее) и выберите желаемую точку восстановления.

    ![MABS SharePoint Protection8](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection9.png)
2. Дважды щелкните точку восстановления SharePoint, чтобы отобразить доступные регистрационные сведения SharePoint.

   > [!NOTE]
   > Так как длительное хранение фермы SharePoint выполняется в Azure, на сервере MABS нет доступных сведений (метаданных) для каталога. В результате каждый раз, когда базу данных контента SharePoint требуется вернуть в состояние на определенный момент, необходимо каталогизировать ферму SharePoint заново.
   >
   >
3. Нажмите кнопку **Повторить каталогизацию**.

    ![MABS SharePoint Protection10](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection12.png)

    Откроется окно состояния **Повторная каталогизация облака** .

    ![MABS SharePoint Protection11](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection13.png)

    После завершения каталогизации состояние изменится на *Успешно*. Нажмите кнопку **Закрыть**

    ![MABS SharePoint Protection12](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection14.png)
4. Щелкните объект SharePoint на вкладке MABS **Восстановление**, чтобы получить структуру базы данных контента. Щелкните элемент правой кнопкой мыши и выберите **Восстановить**.

    ![MABS SharePoint Protection13](./media/backup-azure-backup-sharepoint/dpm-sharepoint-protection15.png)
5. Выполните [процедуру восстановления, описанную ранее в этой статье](#restore-a-sharepoint-item-from-disk-using-dpm) , чтобы восстановить базу данных контента SharePoint с диска.

## <a name="faqs"></a>Часто задаваемые вопросы
В. Можно ли восстановить элемент SharePoint в исходное расположение, если SharePoint настроен с использованием SQL AlwaysOn (с защитой на диске)?<br>
О. Да, элемент можно восстановить на исходный сайт SharePoint.

В. Можно ли восстановить базу данных SharePoint в исходное расположение, если SharePoint настроен с использованием SQL AlwaysOn?<br>
О. Так как базы данных SharePoint настраиваются в SQL AlwaysOn, их нельзя изменить, не удалив группу доступности. В связи с этим сервер MABS не может восстанавливать базы данных в исходное расположение. Вы можете восстановить базу данных SQL Server в другой экземпляр SQL Server.

## <a name="next-steps"></a>Дополнительная информация
* Дополнительные сведения о защите SharePoint с помощью MABS см. в [этой серии видеоматериалов](http://channel9.msdn.com/Series/Azure-Backup/Microsoft-SCDPM-Protection-of-SharePoint-1-of-2-How-to-create-a-SharePoint-Protection-Group).
