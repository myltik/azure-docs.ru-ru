---
title: 'Azure Backup: восстановление состояния системы в Windows Server | Документация Майкрософт'
description: Это пошаговое руководство по восстановлению состояния системы Windows Server из резервной копии в Azure.
services: backup
documentationcenter: ''
author: saurabhsensharma
manager: shivamg
editor: ''
ms.assetid: ''
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 8/18/2017
ms.author: saurse;trinadhk;markgal;
ms.openlocfilehash: c673cca6a35cfdc0edaecdc69a797f48772d847c
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
---
# <a name="restore-system-state-to-windows-server"></a>Восстановление состояния системы в Windows Server

В этой статье описано, как восстановить резервные копии состояния системы Windows Server из хранилища служб восстановления Azure. Чтобы восстановить состояние системы, необходимо иметь резервную копию состояния системы (созданную с помощью инструкций в разделе [Резервное копирование состояния системы Windows Server](backup-azure-system-state.md#back-up-windows-server-system-state)) и установленный [агент служб восстановления Microsoft Azure (MARS) последней версии](http://aka.ms/azurebackup_agent). Восстановление данных состояния системы Windows Server из хранилища службы восстановления Azure состоит из двух этапов:

1. Восстановление состояния системы в виде файлов из службы Azure Backup. При восстановлении состояния системы в виде файлов из службы Azure Backup вы можете:
  * восстановить состояние системы на тот же сервер, где создавались резервные копии;
  * восстановить файл состояния системы на другой сервер.

2. Применение восстановленных файлов состояния системы в Windows Server.


## <a name="recover-system-state-files-to-the-same-server"></a>Восстановление файлов состояния системы на том же сервере
Здесь описывается, как откатить конфигурацию Windows Server до предыдущего состояния. Откат конфигурации сервера к известному ранее стабильному состоянию может быть очень важен. На следующих шагах восстанавливается состояние системы сервера из хранилища служб восстановления. 

1. Откройте оснастку **Microsoft Azure Backup**. Если вы не знаете, куда была установлена оснастка, найдите на компьютере или сервере службу **Microsoft Azure Backup**.

    Классическое приложение должны быть в результатах поиска.

2. Щелкните **Восстановить данные** для запуска мастера.

    ![Восстановить данные](./media/backup-azure-restore-windows-server/recover.png)

3. Чтобы восстановить данные на тот же сервер или компьютер, в области **Приступая к работе** выберите **Этот сервер (`<server name>`)** и нажмите кнопку **Далее**.

    ![Выберите параметр "Этот сервер", чтобы восстановить данные на тот же компьютер](./media/backup-azure-restore-system-state/samemachine.png)

4. В области **Выбор режима восстановления** выберите **Состояние системы** и нажмите кнопку **Далее**.

    ![Обзор файлов](./media/backup-azure-restore-system-state/recover-type-selection.png)

5. В календаре в области **Выбор тома и даты** выберите точку восстановления. 

    Можно восстановить данные на любой момент времени. Даты **полужирным** шрифтом означают доступность по крайней мере одной точки восстановления. Если после выбора даты доступно несколько точек восстановления, выберите конкретную точку восстановления из раскрывающегося меню **Время**.

    ![Том и дата](./media/backup-azure-restore-system-state/select-date.png)

6. После выбора точки восстановления нажмите кнопку **Далее**.

    Служба архивации Azure подключит локальную точку восстановления и использует ее в качестве тома для восстановления.

7. В следующей области укажите назначение для восстановленных файлов состояния системы и нажмите кнопку **Обзор**, чтобы открыть проводник Windows и найти необходимые файлы и папки. Параметр **Создавать копии, чтобы иметь обе версии** создает копии отдельных файлов в имеющемся архиве файлов состояния системы вместо создания копии всего архива состояния системы.

    ![Варианты восстановления](./media/backup-azure-restore-system-state/recover-as-files.png)

8. Проверьте сведения о восстановлении в области **Подтверждение** и нажмите кнопку **Восстановить**.

   ![Нажмите кнопку "Восстановить", чтобы подтвердить действие восстановления](./media/backup-azure-restore-system-state/confirm-recovery.png)

9. Скопируйте каталог *WindowsImageBackup* в место назначения восстановления на некритический том сервера. Обычно том ОС Windows является критическим томом.

10. После успешного восстановления следуйте указаниям в разделе [Применение восстановленного состояния системы в Windows Server](backup-azure-restore-system-state.md#apply-restored-system-state-files-to-the-windows-server), чтобы завершить процесс восстановления состояния системы.

## <a name="recover-system-state-files-to-an-alternate-server"></a>Восстановление файлов состояния системы на другой сервер

Если Windows Server поврежден или недоступен и требуется вернуть его в стабильное состояние путем восстановления состояния системы Windows Server, его можно восстановить с другого сервера. Выполните следующие действия для восстановления состояния системы на отдельном сервере.  

Ниже приведена терминология, используемая в этих действиях:

- *Исходный компьютер* — компьютер, для данных на котором была создана резервная копия и который в настоящий момент недоступен.
- *Целевой компьютер* — компьютер, на который восстанавливаются данные.
- *Пример хранилища* — хранилище служб восстановления, в котором зарегистрированы *исходный* и *целевой* компьютеры. <br/>

> [!NOTE]
> Резервные копии, созданные на компьютере с более поздней версией ОС, невозможно восстановить на компьютер с более ранней версией ОС. Например, резервные копии, созданные на компьютере с Windows Server 2016, нельзя восстановить на Windows Server 2012 R2. Однако обратное возможно. Резервные копии Windows Server 2012 R2 можно использовать для восстановления Windows Server 2016.
>

1. Откройте на **целевом компьютере** оснастку *Microsoft Azure Backup*.
2. Зарегистрируйте *целевой* и *исходный* компьютеры в одном хранилище служб восстановления.
3. Щелкните **Восстановить данные**, чтобы запустить рабочий процесс.
4. Выберите **Другой сервер**

    ![Другой сервер](./media/backup-azure-restore-system-state/anotherserver.png)

5. Укажите файл с учетными данными хранилища, который соответствует *примеру хранилища*. Если файл с учетными данными хранилища недействителен (или просрочен), скачайте новый файл из *примера хранилища* на портале Azure. После указания файла с учетными данными отобразится связанное хранилище служб восстановления.

6. В области "Выбор резервного сервера" из списка компьютеров выберите *исходный компьютер*.
7. В области "Выбор режима восстановления" выберите **Состояние системы** и нажмите кнопку **Далее**. 

    ![поиска](./media/backup-azure-restore-system-state/recover-type-selection.png)

8. В календаре в области **Выбор тома и даты** выберите точку восстановления. Можно восстановить данные на любой момент времени. Даты **полужирным** шрифтом означают доступность по крайней мере одной точки восстановления. Если после выбора даты доступно несколько точек восстановления, выберите конкретную точку восстановления из раскрывающегося меню **Время**. 

    ![Поиск элементов](./media/backup-azure-restore-system-state/select-date.png)

9. После выбора точки восстановления нажмите кнопку **Далее**.

10. В области **Выберите режим восстановления состояния системы** укажите назначение, куда будут восстановлены файлы состояния системы, а затем нажмите кнопку **Далее**.

    ![Шифрование](./media/backup-azure-restore-system-state/recover-as-files.png)

    Параметр **Создавать копии, чтобы иметь обе версии** создает копии отдельных файлов в имеющемся архиве файлов состояния системы вместо создания копии всего архива состояния системы.

11. Проверьте сведения о восстановлении в области "Подтверждение" и нажмите кнопку **Восстановить**. 

    ![Нажмите кнопку "Восстановить", чтобы подтвердить процесс восстановления](./media/backup-azure-restore-system-state/confirm-recovery.png)

12. Скопируйте каталог *WindowsImageBackup* на некритический том сервера (например, D:\). Обычно том ОС Windows является критическим томом.

13. Чтобы завершить процесс восстановления, используйте следующий раздел, чтобы [применить восстановленные файлы состояния системы в Windows Server](backup-azure-restore-system-state.md#apply-restored-system-state-on-a-windows-server).




## <a name="apply-restored-system-state-on-a-windows-server"></a>Применение восстановленного состояния системы в Windows Server

После восстановления состояния системы в виде файлов с помощью агента служб восстановления Azure используйте служебную программу системы архивации данных Windows Server, чтобы применить восстановленное состояние системы к Windows Server. Служебная программа системы архивации данных Windows Server уже доступна на сервере. На следующих шагах описывается, как применить восстановленное состояние системы.

1. Используйте следующие команды для перезагрузки сервера в *режиме восстановления служб каталогов*. В командной строке с повышенными привилегиями:

    ```
    PS C:\> Bcdedit /set safeboot dsrepair
    PS C:\> Shutdown /r /t 0
    ```

2. После перезагрузки откройте оснастку системы архивации данных Windows Server. Если вы не знаете, куда была установлена оснастка, найдите на компьютере или сервере **систему архивации данных Windows Server**.

    Классическое приложение появится в результатах поиска.

3. В оснастке выберите **Локальная архивация**.

    ![Выбор локальной резервной копии для восстановления отсюда](./media/backup-azure-restore-system-state/win-server-backup-local-backup.png)

4. На консоли локальной архивации в **области действий** щелкните **Восстановить**, чтобы открыть мастер восстановления.

5. Выберите параметр **Архив находится в другом расположении** и нажмите кнопку **Далее**.

   ![Выберите восстановление на другой сервер](./media/backup-azure-restore-system-state/backup-stored-in-diff-location.png)

6. При указании типа расположения выберите **Удаленная общая папка**, если резервная копия состояния системы была восстановлена на другой сервер. Если состояние системы было восстановлено локально, выберите **Локальные диски**. 

    ![Выберите, следует ли выполнять восстановление из локального сервера или другого](./media/backup-azure-restore-system-state/ss-recovery-remote-shared-folder.png)

7. Введите путь к каталогу *WindowsImageBackup* или выберите локальный диск, содержащий этот каталог (например, D:\WindowsImageBackup), восстановленный в процессе восстановления файлов состояния системы с помощью агента служб восстановления Azure, и нажмите кнопку **Далее**.

    ![Путь к общему файлу](./media/backup-azure-restore-system-state/ss-recovery-remote-folder.png)

8. Выберите версию состояния системы, которую нужно восстановить, и нажмите кнопку **Далее**.

9. В области "Тип восстановления" выберите **Состояние системы** и нажмите кнопку **Далее**.

10. Для расположения восстановления состояния системы выберите **Исходное расположение** и нажмите кнопку **Далее**.

11. Просмотрите сведения о подтверждении, проверьте параметры перезагрузки и нажмите кнопку **Восстановить**, чтобы применить восстановленные файлы состояния системы.

    ![Запуск восстановленных файлов состояния системы](./media/backup-azure-restore-system-state/launch-ss-recovery.png)

## <a name="special-considerations-for-system-state-recovery-on-active-directory-server"></a>Специальные рекомендации для восстановления состояния системы на сервере Active Directory

Резервная копия состояния системы включает данные Active Directory. Выполните следующие действия для восстановления предыдущего состояния доменных служб Active Directory (AD DS).

1. Перезапустите контроллер домена в режиме восстановления служб каталогов (DSRM).
2. Выполните [следующие действия](https://technet.microsoft.com/library/cc794755(v=ws.10).aspx), чтобы восстановить доменные службы Active Directory с помощью командлетов системы архивации данных Windows Server.


## <a name="troubleshoot-failed-system-state-restore"></a>Устранение неполадок при сбое восстановления состояния системы

Если предыдущий процесс применения состояния системы не завершился успешно, используйте среду восстановления Windows (Win RE) для восстановления сервера Windows. На следующих шагах описывается, как восстанавливать с помощью Win RE. Используйте этот вариант, только если Windows Server не загружается нормально после восстановления состояния системы. Будьте осторожны, следующий процесс стирает все несистемные данные. 

1. Загрузите Windows Server в среде восстановления Windows (Win RE).

2. Выберите "Устранение неполадок" из трех доступных вариантов.

    ![Открытие меню](./media/backup-azure-restore-system-state/winre-1.png)

3. На экране **Дополнительные параметры** выберите **Командная строка** и укажите имя администратора сервера и пароль.

   ![Открытие меню](./media/backup-azure-restore-system-state/winre-2.png)

4. Укажите имя администратора сервера и пароль.

    ![Открытие меню](./media/backup-azure-restore-system-state/winre-3.png)

5. При открытии командной строки с правами администратора выполните следующую команду, чтобы получить версии резервного копирования состояния системы.

    ```
    Wbadmin get versions -backuptarget:<Volume where WindowsImageBackup folder is copied>:
    ```
    ![Получение версий резервного копирования состояния системы](./media/backup-azure-restore-system-state/winre-4.png)

6. Выполните следующую команду, чтобы получить все тома, которые доступны в резервной копии.

    ```
    Wbadmin get items -version:<copy version from above step> -backuptarget:<Backup volume>
    ```

    ![Получение версий резервного копирования состояния системы](./media/backup-azure-restore-system-state/winre-5.png)

7. Следующая команда восстанавливает все тома, которые являются частью резервной копии состояния системы. Обратите внимание, что этот шаг восстанавливает только критические тома, которые являются частью состояния системы. Все несистемные данные удаляются.

    ```
    Wbadmin start recovery -items:C: -itemtype:Volume -version:<Backupversion> -backuptarget:<backup target volume>
    ```
     ![Получение версий резервного копирования состояния системы](./media/backup-azure-restore-system-state/winre-6.png)



## <a name="next-steps"></a>Дополнительная информация
* Теперь после восстановления файлов и папок можно [управлять резервными копиями](backup-azure-manage-windows-server.md).
