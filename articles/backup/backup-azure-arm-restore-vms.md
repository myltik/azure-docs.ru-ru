---
title: 'Azure Backup: восстановление виртуальных машин с помощью портала Azure | Документация Майкрософт'
description: Восстановление виртуальной машины Azure из точки восстановления с помощью портала Azure
services: backup
documentationcenter: ''
author: markgalioto
manager: carmonm
editor: ''
keywords: восстановление резервной копии; восстановление; точка восстановления;
ms.assetid: 372b87c6-3544-4dc5-bbc9-c742ca502159
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/04/2017
ms.author: markgal;trinadhk;
ms.openlocfilehash: 9a25a2f40e93c291d4c69ee726c732468005d2cd
ms.sourcegitcommit: d28bba5fd49049ec7492e88f2519d7f42184e3a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2018
---
# <a name="use-the-azure-portal-to-restore-virtual-machines"></a>Восстановление виртуальных машин с помощью портала Azure
Защитите свои данные, создавая моментальные снимки данных через определенные интервалы времени. Эти моментальные снимки называются точками восстановления. Они хранятся в хранилищах служб восстановления. Если вам нужно исправить или повторно создать виртуальную машину, вы можете восстановить ее из любой сохраненной точки восстановления. При восстановлении из точки восстановления можно:

* Создать виртуальную машину, которая будет представлять собой архивированную виртуальную машину в определенный момент времени.
* Восстановить диски и использовать шаблон, который поставляется в процессе, чтобы настроить восстановленную виртуальную машину или восстановить отдельные файлы. 

В этой статье описывается, как восстановить виртуальную машину в новую виртуальную машину или как восстановить все заархивированные диски. Сведения о восстановлении отдельных файлов см. в статье [Восстановление файлов из резервной копии виртуальной машины Azure](backup-azure-restore-files-from-vm.md).

![Три способа восстановления из резервной копии виртуальной машины](./media/backup-azure-arm-restore-vms/azure-vm-backup-restore.png)

> [!NOTE]
> В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Azure Resource Manager и классическая модель](../azure-resource-manager/resource-manager-deployment-model.md). Данная статья содержит сведения и процедуры для восстановления виртуальных машин, развернутых с использованием модели Resource Manager.
>
>

Восстановление виртуальной машины или всех дисков из резервной копии виртуальной машины выполняется в два этапа.

* Выбор точки восстановления.
* Выбор типа восстановления, создание виртуальной машины или восстановление дисков и указание необходимых параметров. 

## <a name="select-a-restore-point-for-restore"></a>Выбор точки восстановления.
1. Войдите на [портале Azure](http://portal.azure.com/).

2. В меню Azure щелкните **Обзор**. В списке служб введите **Службы восстановления**. Список служб будет отображаться в соответствии с вводимым текстом. Когда вы увидите пункт **Хранилища служб восстановления**, щелкните его.

    ![Хранилище служб восстановления](./media/backup-azure-arm-restore-vms/open-recovery-services-vault.png)

    Появится список хранилищ, доступных в подписке.

    ![Список хранилищ служб восстановления](./media/backup-azure-arm-restore-vms/list-of-rs-vaults.png)
3. В этом списке выберите хранилище, связанное с восстанавливаемой виртуальной машиной. Выберите это хранилище, чтобы открыть панель мониторинга.

    ![Выбор хранилища служб восстановления](./media/backup-azure-arm-restore-vms/select-vault-open-vault-blade.png)
4. На панели мониторинга хранилища на плитке **Архивные элементы** щелкните **Виртуальные машины Azure**.

    ![Панель мониторинга хранилища](./media/backup-azure-arm-restore-vms/vault-dashboard.png)

    Откроется колонка **Архивные элементы**, в которой вы увидите список виртуальных машин Azure.

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/list-of-vms-in-vault.png)
5. Выберите в этом списке нужную виртуальную машину, чтобы открыть панель мониторинга. На панели мониторинга виртуальной машины откроется область мониторинга с плиткой **Точки восстановления**.

    ![Точки восстановления](./media/backup-azure-arm-restore-vms/vm-blade.png)
6. В меню панели мониторинга виртуальной машины выберите **Восстановить**.

    ![Кнопка "Восстановить"](./media/backup-azure-arm-restore-vms/vm-blade-menu-restore.png)

    Откроется колонка **Восстановление**.

    ![Колонка "Восстановление"](./media/backup-azure-arm-restore-vms/restore-blade.png)
7. В колонке **Восстановление** выберите **Точка восстановления**. Откроется колонка **Select restore point** (Выбор точки восстановления).

    ![Выбор точки восстановления](./media/backup-azure-arm-restore-vms/recovery-point-selector.png)

    По умолчанию в этом диалоговом окне показаны все точки восстановления, созданные за последние 30 дней. Используйте **фильтр**, чтобы изменить диапазон времени отображения точек восстановления. По умолчанию отображаются точки восстановления всех уровней согласованности. Измените значение фильтра **Все точки восстановления**, чтобы выбрать определенный уровень согласованности точек восстановления. Дополнительные сведения о типах точек восстановления см. в разделе [Согласованность данных](backup-azure-vms-introduction.md#data-consistency).

    Варианты согласованности точек восстановления:

     * точки восстановления с файлами, согласованными на момент времени;
     * точки восстановления с согласованным состоянием приложений;
     * точки восстановления с согласованным состоянием файловой системы;
     * все точки восстановления.

8. Выберите точку восстановления и нажмите кнопку **ОК**.

    ![Варианты точек восстановления](./media/backup-azure-arm-restore-vms/select-recovery-point.png)

    В колонке **Восстановление** показано, что точка восстановления выбрана.

9. Перейдите к колонке **Восстановление**, если она еще не открыта. Убедитесь, что [точка восстановления выбрана](#select-a-restore-point-for-restore), и выберите **конфигурацию восстановления**. Откроется колонка **Restore configuration** (Конфигурация восстановления).

## <a name="choose-a-vm-restore-configuration"></a>Выбор конфигурации восстановления для виртуальной машины
После выбора точки восстановления выберите конфигурацию восстановления для виртуальной машины. Чтобы настроить восстановленную виртуальную машину, можно использовать портал Azure или PowerShell.

1. Перейдите к колонке **Восстановление**, если она еще не открыта. Убедитесь, что [точка восстановления выбрана](#select-a-restore-point-for-restore), и выберите **конфигурацию восстановления**. Откроется колонка **Restore configuration** (Конфигурация восстановления).

    ![Мастер настройки восстановления](./media/backup-azure-arm-restore-vms/recovery-configuration-wizard-recovery-type.png)
2. В колонке **Конфигурация восстановления** есть два параметра:

   * **Создание виртуальной машины**;

   * **Restore disks** (Восстановление дисков).

Для восстановленной виртуальной машины на портале используется параметр **Быстрое создание**. Чтобы настроить конфигурацию виртуальной машины или имена ресурсов, генерируемых при создании новой виртуальной машины, используйте PowerShell или портал для восстановления резервных копий дисков. Используйте команды PowerShell, чтобы добавить их в выбранную конфигурацию виртуальной машины. Или используйте шаблон, который поставляется с восстановленными дисками, чтобы настроить восстановленную виртуальную машину. Дополнительные сведения о том, как восстановить виртуальную машину с несколькими сетевыми интерфейсами или под управлением балансировщика нагрузки, см. в статье [Восстановление виртуальных машин с помощью портала Azure](#restore-vms-with-special-network-configurations). Если виртуальная машина Windows использует [лицензии для преимуществ гибридного использования (HUB)](../virtual-machines/windows/hybrid-use-benefit-licensing.md), восстановите диски и используйте PowerShell или шаблон для создания виртуальной машины (как указано в этой статье). Укажите для параметра **Тип лицензии** "Windows_Server" при ее создании, чтобы воспользоваться преимуществами гибридного использования на восстановленной виртуальной машине. 
 
## <a name="create-a-new-vm-from-a-restore-point"></a>Создание виртуальной машины из точки восстановления
1. Если это еще не сделано, [выберите точку восстановления](#restore-a vm-with-special-network-configurations), прежде чем приступить к созданию виртуальной машины с ее помощью. Выбрав точку восстановления, в колонке **конфигурации восстановления** введите или выберите значения для каждого из следующих полей.

    a. **Тип восстановления**. Создайте виртуальную машину.

    Б. **Имя виртуальной машины**. Укажите имя виртуальной машины. Оно должно быть уникальным в пределах группы ресурсов (для виртуальной машины Azure, развернутой с помощью Azure Resource Manager) или облачной службы (для классической виртуальной машины). Невозможно заменить виртуальную машину, если она уже существует в подписке.

    c. **Группа ресурсов**. Используйте имеющуюся группу ресурсов или создайте новую. При восстановлении классической виртуальной машины укажите в этом поле имя новой облачной службы. Имя создаваемой группы ресурсов или облачной службы должно быть глобально уникальным. Обычно имя облачной службы связано с общедоступным URL-адресом, например: [облачная_служба].cloudapp.net. Если вы попытаетесь использовать уже существующее имя группы ресурсов или облачной службы, Azure назначит группе ресурсов или облачной службе имя виртуальной машины. Azure отображает группы ресурсов, облачные службы и виртуальные машины, не связанные с территориальными группами. Дополнительные сведения см. в статье [Перенос виртуальной сети (классической) из территориальной группы в регион](../virtual-network/virtual-networks-migrate-to-regional-vnet.md).

    d. **Виртуальная сеть**. Выберите виртуальную сеть при создании виртуальной машины. В этом поле перечислены все виртуальные сети, связанные с подпиской. Группа ресурсов виртуальной машины отображается в скобках.

    д. **Подсеть**. Если виртуальная сеть содержит подсети, по умолчанию будет выбрана первая из них. Если подсетей несколько, выберите нужную.

    f. **Учетная запись хранения**. В этом меню перечислены учетные записи хранения в том же расположении, что и хранилище служб восстановления. Учетные записи хранения, избыточные в пределах зоны, не поддерживаются. Если у вас нет учетной записи хранения в одном расположении с хранилищем служб восстановления, ее следует создать до запуска операции восстановления. Тип репликации учетной записи хранения отображается в скобках.

    ![Мастер настройки восстановления](./media/backup-azure-arm-restore-vms/recovery-configuration-wizard.png)

    > [!NOTE]
    > * При восстановлении виртуальной машины, развернутой с помощью Resource Manager, необходимо определить виртуальную сеть. Для классической виртуальной машины виртуальную сеть можно не указывать.

    > * При восстановлении виртуальных машин с управляемыми дисками убедитесь, что выбранная учетная запись хранения не включена для шифрования службы хранилища Azure за определенное время существования.

    > * В зависимости от типа хранилища выбранной учетной записи хранения (Premium или Standard), все восстановленные диски будут иметь категорию Premium или Standard. Сейчас смешанный режим дисков при восстановлении не поддерживается.
    >
    >

2. Чтобы подтвердить конфигурацию восстановления, в колонке **Restore configuration** (Конфигурация восстановления) нажмите кнопку **ОК**. В колонке **Восстановление** выберите **Восстановить**, чтобы активировать операцию восстановления.

## <a name="restore-backed-up-disks"></a>Восстановление резервных копий дисков
Чтобы настроить виртуальную машину, которую нужно создать из резервных копий дисков, отличающихся от доступных в колонке **Restore configuration** (Конфигурация восстановления), выберите значение  **Restore disks** (Восстановление дисков) для параметра **Тип восстановления**. При этом будет предложено указать учетную запись хранения для копирования дисков из резервных копий. Следует выбрать учетную запись хранения, которая находится в одном расположении с хранилищем служб восстановления. Учетные записи хранения, избыточные в пределах зоны, не поддерживаются. Если у вас нет учетной записи хранения в одном расположении с хранилищем служб восстановления, ее следует создать до запуска операции восстановления. Тип репликации учетной записи хранения отображается в скобках.

После завершения операции восстановления можно сделать следующее:

* [использовать шаблон для настройки восстановленной виртуальной машины](#use-templates-to-customize-restore-vm);
* [подключить восстановленные диски к имеющейся виртуальной машине](../virtual-machines/windows/attach-managed-disk-portal.md);
* [с помощью PowerShell создать виртуальную машину на основе восстановленных дисков](./backup-azure-vms-automation.md#restore-an-azure-vm).

Чтобы подтвердить конфигурацию восстановления, в колонке **Restore configuration** (Конфигурация восстановления) нажмите кнопку **ОК**. В колонке **Восстановление** выберите **Восстановить**, чтобы активировать операцию восстановления.

![Завершенная настройка восстановления](./media/backup-azure-arm-restore-vms/trigger-restore-operation.png)

## <a name="track-the-restore-operation"></a>Отслеживание восстановления
Когда вы запускаете операцию восстановления, служба архивации создает задание для отслеживания выполнения операции. Служба архивации также создает и временно отображает уведомление в области **Уведомления** портала. Если уведомление не появилось, выберите символ **Уведомления**, чтобы просмотреть его.

![Запущенное восстановление](./media/backup-azure-arm-restore-vms/restore-notification.png)

Чтобы просмотреть состояние выполняющейся или завершенной операции, откройте список **Задания резервного копирования**.

1. В меню Azure щелкните **Обзор**, а затем в списке служб введите **Службы восстановления**. Список служб будет отображаться в соответствии с вводимым текстом. Когда вы увидите пункт **Хранилища служб восстановления**, щелкните его.

    ![Открытие хранилища служб восстановления](./media/backup-azure-arm-restore-vms/open-recovery-services-vault.png)

    Появится список хранилищ, доступных в подписке.

    ![Список хранилищ служб восстановления](./media/backup-azure-arm-restore-vms/list-of-rs-vaults.png)
2. В этом списке выберите хранилище, связанное с восстанавливаемой виртуальной машиной. Выберите это хранилище, чтобы открыть панель мониторинга.

3. На панели мониторинга хранилища на плитке **Задания архивации** выберите **Виртуальные машины Azure**, чтобы увидеть связанные с этим хранилищем задания.

    ![Панель мониторинга хранилища](./media/backup-azure-arm-restore-vms/vault-dashboard-jobs.png)

    Откроется колонка **Задания архивации**, где содержится список заданий.

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/restore-job-in-progress.png)
    
## <a name="use-templates-to-customize-a-restored-vm"></a>Использование шаблонов для настройки восстановленной виртуальной машины
После [завершения операции восстановления дисков](#Track-the-restore-operation) используйте шаблон, созданный как часть операции восстановления, чтобы создать виртуальную машину с конфигурацией, отличающейся от конфигурации резервного копирования. Его также можно использовать для настройки имен ресурсов, созданных при создании виртуальной машины из точки восстановления. 

> [!NOTE]
> Шаблоны добавляются к восстановленным дискам для точек восстановления, созданных после 1 марта 2017 года. Они применимы к виртуальным машинам с неуправляемыми дисками. Поддержка виртуальных машин с управляемыми дисками будет реализована в будущих выпусках. 
>
>

Чтобы получить шаблон, созданный при восстановлении дисков, сделайте следующее:

1. Перейдите к данным соответствующего задания восстановления.

2. На экране **подробных сведений о задании восстановления** нажмите кнопку **Deploy Template** (Развернуть шаблон), чтобы запустить развертывание шаблона. 

     ![Детализация задания восстановления](./media/backup-azure-arm-restore-vms/restore-job-drill-down.png)
   
3. В колонке **Шаблон развертывания** для настраиваемого развертывания воспользуйтесь функцией развертывания шаблона, чтобы [изменить и развернуть его](../azure-resource-manager/resource-group-template-deploy-portal.md#deploy-resources-from-custom-template), или настройте дополнительные параметры, [создав шаблон](../azure-resource-manager/resource-group-authoring-templates.md) перед развертыванием. 

   ![Загрузка развертывания шаблона](./media/backup-azure-arm-restore-vms/loading-template.png)
   
4. Введя необходимые значения, примите **условия** и выберите **Приобрести**.

   ![Отправка развертывания шаблона](./media/backup-azure-arm-restore-vms/submitting-template.png)

## <a name="post-restore-steps"></a>Действия после восстановления
* Если вы используете дистрибутив Linux на основе cloud-init (например, Ubuntu), то в целях безопасности пароль будет заблокирован после восстановления. Чтобы [сбросить пароль](../virtual-machines/linux/reset-password.md), на восстановленной виртуальной машине рекомендуется использовать расширение VMAccess. Мы рекомендуем также использовать ключи SSH с такими дистрибутивами, чтобы предотвратить сброс пароля после восстановления.
* Расширения, имеющиеся при настройке резервного копирования, установлены, но не будут включены. Обнаружив проблему, переустановите расширения. 
* Если архивируемая виртуальная машина имеет статический IP-адрес, то у восстановленной виртуальной машины будет динамический IP-адрес во избежание конфликтов при ее создании. Ознакомьтесь с дополнительными сведениями о [добавлении статического IP-адреса в восстановленную виртуальную машину](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm).
* У восстановленной виртуальной машины нет набора значений доступности. При создании виртуальной машины из восстановленных дисков с помощью PowerShell или шаблонов рекомендуется использовать параметр восстановления дисков, чтобы [добавить группу доступности](../virtual-machines/windows/tutorial-availability-sets.md). 


## <a name="backup-for-restored-vms"></a>Архивация для восстановленных виртуальных машин
Если виртуальная машина восстановлена в той же группе ресурсов и с тем же именем, что и первоначально заархивированная виртуальная машина, то архивация будет продолжена и после восстановления виртуальной машины. Если восстановить виртуальную машину в другой группе ресурсов или задать для нее другое имя, она рассматривается в качестве новой виртуальной машины. Необходимо настроить резервную копию для восстановленной виртуальной машины.

## <a name="restore-a-vm-during-an-azure-datacenter-disaster"></a>Восстановление виртуальной машины в случае отказа центра обработки данных Azure
Azure Backup позволяет восстанавливать резервные копии виртуальных машин в сопряженном центре обработки данных в случае отказа основного центра обработки данных, в котором запущены эти виртуальные машины, если при этом хранилище архивации настроено как геоизбыточное. При выполнении таких сценариев выберите учетную запись хранения, которая присутствует в сопряженном центре обработки данных. Остальная часть процесса восстановления остается неизменной. В службе архивации для создания восстановленной виртуальной машины используется служба вычислений, расположенная в сопряженном геообъекте. Дополнительные сведения см. в [техническом руководстве по обеспечению устойчивости центра обработки данных](../resiliency/resiliency-technical-guidance-recovery-loss-azure-region.md).

## <a name="restore-domain-controller-vms"></a>Восстановление виртуальных машин контроллера домена
Резервное копирование виртуальных машин контроллера домена поддерживается в службе Azure Backup. Тем не менее во время процесса восстановления необходимо соблюдать осторожность. Правильный процесс восстановления зависит от структуры домена. Простейший случай — один контроллер домена в одном домене. Более распространенный вариант для рабочих нагрузок — один домен с несколькими контроллерами домена (некоторые из них могут быть на локальном компьютере). И еще один вариант — лес с несколькими доменами. 

Для перспективы Active Directory виртуальная машина Azure соответствует любой другой виртуальной машине в современном поддерживаемом гипервизоре. Особенностью использования локальных гипервизоров является отсутствие доступной консоли виртуальной машины в Azure. Консоль требуется в некоторых сценариях, например при восстановлении файла резервной копии с помощью восстановления исходного состояния системы. Хотя есть и полная замена такому типу восстановления. Это — восстановление виртуальной машины из резервного хранилища. Кроме того, доступен режим восстановления служб каталогов, следовательно, все сценарии восстановления Active Directory также являются приемлемыми. Дополнительные сведения см. в разделе о [резервном копировании и восстановлении для виртуализированных контроллеров домена](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv(v=ws.10).aspx#backup_and_restore_considerations_for_virtualized_domain_controllers) и в статье о [планировании для восстановления леса Active Directory](https://technet.microsoft.com/library/planning-active-directory-forest-recovery(v=ws.10).aspx).

### <a name="single-dc-in-a-single-domain"></a>Один контроллер домена в одном домене
В этом случае виртуальная машина может быть восстановлена (как и любая другая виртуальная машина) на портале Azure или с помощью PowerShell.

### <a name="multiple-dcs-in-a-single-domain"></a>Несколько контроллеров домена в одном домене
Если другие контроллеры домена в одном домене доступны по сети, контроллер домена можно восстановить как виртуальную машину. Если это последний контроллер домена в домене или выполняется восстановление в изолированной сети, должно выполняться восстановление леса.

### <a name="multiple-domains-in-one-forest"></a>Несколько доменов в одном лесу
Если другие контроллеры домена в одном домене доступны по сети, контроллер домена можно восстановить как виртуальную машину. Во всех остальных случаях мы рекомендуем восстановление леса.

## <a name="restore-vms-with-special-network-configurations"></a>Восстановление виртуальных машин с помощью специальных конфигураций сети
Вы можете выполнять архивацию и восстановление виртуальных машин, используя следующие специальные конфигурации сети. Но восстановление с использованием таких конфигураций предполагает соблюдение следующих требований:

* Виртуальные машины с балансировщиками нагрузки (внутренним или внешним).
* Виртуальные машины с несколькими зарезервированными IP-адресами
* Виртуальные машины с несколькими сетевыми картами

> [!IMPORTANT]
> Если вы создаете специальную конфигурацию сети для виртуальных машин, следует использовать PowerShell, чтобы создать виртуальные машины на основе восстановленных дисков.
>
>

Вот как можно повторно создать виртуальные машины после восстановления на диск:

1. Восстановите диски из хранилища служб восстановления с помощью [PowerShell](backup-azure-vms-automation.md#restore-an-azure-vm).

2. Создайте конфигурацию виртуальной машины для сценариев с использованием балансировщика нагрузки, нескольких сетевых адаптеров или зарезервированных IP-адресов с помощью командлетов PowerShell. Затем создайте с помощью этой конфигурации виртуальную машину с нужными параметрами.

   a. Создайте виртуальную машину в облачной службе с [внутренним балансировщиком нагрузки](https://azure.microsoft.com/documentation/articles/load-balancer-internal-getstarted/).

   Б. Создайте виртуальную машину для подключения к [балансировщику нагрузки, доступному в Интернете](https://azure.microsoft.com/documentation/articles/load-balancer-internet-getstarted/).

   c. Создайте виртуальную машину с [несколькими сетевыми адаптерами](https://azure.microsoft.com/documentation/articles/virtual-networks-multiple-nics/).

   d. Создайте виртуальную машину с [несколькими зарезервированными IP-адресами](https://azure.microsoft.com/documentation/articles/virtual-networks-reserved-public-ip/).

## <a name="next-steps"></a>Дополнительная информация
Теперь вы знаете, как восстанавливать виртуальные машины. Информацию о типичных ошибках, связанных с работой виртуальных машин, см. в статье об устранении неполадок. Ознакомьтесь также с инструкцией по управлению задачами, выполняемыми на виртуальных машинах.

* [Устранение ошибок](backup-azure-vms-troubleshoot.md#restore)
* [Управление виртуальными машинами](backup-azure-manage-vms.md)
