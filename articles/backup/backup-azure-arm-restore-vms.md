---
title: "Служба архивации Azure: восстановление виртуальных машин с помощью портала Azure | Документация Майкрософт"
description: "Восстановление виртуальной машины Azure из точки восстановления с помощью портала Azure."
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
editor: 
keywords: "восстановление резервной копии; восстановление; точка восстановления;"
ms.assetid: 372b87c6-3544-4dc5-bbc9-c742ca502159
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 3/12/2017
ms.author: markgal;trinadhk;
ms.translationtype: Human Translation
ms.sourcegitcommit: ef1e603ea7759af76db595d95171cdbe1c995598
ms.openlocfilehash: 2ab86ed8aafb01e97b3ac9ba0411f4b80f88ac5b
ms.contentlocale: ru-ru
ms.lasthandoff: 06/16/2017


---
# <a name="use-azure-portal-to-restore-virtual-machines"></a>Восстановление виртуальных машин с помощью портала Azure
> [!div class="op_single_selector"]
> * [Восстановление виртуальных машин на классическом портале Azure](backup-azure-restore-vms.md)
> * [Восстановление виртуальных машин на портале Azure](backup-azure-arm-restore-vms.md)
>
>

Защитите свои данные, создавая моментальные снимки данных через определенные интервалы времени. Эти моментальные снимки называются точками восстановления. Они хранятся в хранилищах служб восстановления. Если вам нужно исправить или повторно создать виртуальную машину, вы можете восстановить ее из любой сохраненной точки восстановления. При восстановлении точки восстановления можно создать новую виртуальную машину, которая представляет собой заархивированную виртуальную машину на определенный момент времени, или восстановить диски и использовать предоставляемый шаблон, чтобы настроить восстановленную виртуальную машину, или выполнить восстановление отдельного файла. В этой статье описывается, как восстановить виртуальную машину в новую виртуальную машину или как восстановить все заархивированные диски. Восстановление отдельных файлов описывается в разделе [Восстановление файлов из резервной копии виртуальной машины Azure (предварительная версия)](backup-azure-restore-files-from-vm.md).

![3-ways-restore-from-vm-backup](./media/backup-azure-arm-restore-vms/azure-vm-backup-restore.png)

> [!NOTE]
> В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../azure-resource-manager/resource-manager-deployment-model.md). Данная статья содержит сведения о восстановлении виртуальных машин, развернутых с использованием модели Resource Manager.
>
>

Восстановление виртуальной машины или всех дисков из резервной копии виртуальной машины выполняется в два этапа.

1. Выбор точки восстановления.
2. Выбор типа восстановления: создание новой виртуальной машины или восстановление дисков и указание необходимых параметров. 

## <a name="select-restore-point-for-restore"></a>Выбор точки восстановления
1. Войдите на [портал Azure](http://portal.azure.com/)
2. В меню Azure щелкните **Обзор**, а затем в списке ресурсов введите **Службы восстановления**. Список служб будет отображаться в соответствии с вводимым текстом. Когда вы увидите пункт **Хранилища служб восстановления**, щелкните его.

    ![Открытие хранилища служб восстановления](./media/backup-azure-arm-restore-vms/open-recovery-services-vault.png)

    Появится список хранилищ, доступных в подписке.

    ![Список хранилищ служб восстановления](./media/backup-azure-arm-restore-vms/list-of-rs-vaults.png)
3. В этом списке выберите хранилище, связанное с восстанавливаемой виртуальной машиной. Щелкните это хранилище, чтобы открыть панель мониторинга.

    ![Список хранилищ служб восстановления](./media/backup-azure-arm-restore-vms/select-vault-open-vault-blade.png)
4. На панели мониторинга выполните следующие действия. На плитке **Архивные элементы** щелкните **Виртуальные машины Azure**, чтобы увидеть связанные с этим хранилищем виртуальные машины.

    ![Панель мониторинга хранилища](./media/backup-azure-arm-restore-vms/vault-dashboard.png)

    Откроется колонка **Элементы службы архивации** , в которой вы увидите список виртуальных машин Azure.

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/list-of-vms-in-vault.png)
5. Выберите в этом списке нужную виртуальную машину, чтобы открыть панель мониторинга. В области мониторинга откроется панель мониторинга виртуальной машины с элементом "Точки восстановления".

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/vm-blade.png)
6. В меню панели мониторинга виртуальной машины щелкните **Восстановить**

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/vm-blade-menu-restore.png)

    Откроется колонка "Восстановление".

    ![Колонка восстановления](./media/backup-azure-arm-restore-vms/restore-blade.png)
7. В колонке **Восстановление** щелкните **Точка восстановления**, чтобы открыть колонку **Выбор точки восстановления**.

    ![Колонка восстановления](./media/backup-azure-arm-restore-vms/recovery-point-selector.png)

    По умолчанию в этом диалоговом окне показаны все точки восстановления, созданные за последние 30 дней. Используйте **фильтр**, чтобы изменить диапазон времени отображения точек восстановления. По умолчанию отображаются точки восстановления всех уровней согласованности. Измените значение фильтра **Все точки восстановления**, чтобы выбрать определенный уровень согласованности точек восстановления. Дополнительные сведения о типах точек восстановления см. в разделе [Согласованность данных](backup-azure-vms-introduction.md#data-consistency).  

   * **Согласованность точек восстановления**. Можно выбрать следующие варианты:
     * точки восстановления с файлами, согласованными на момент времени;
     * точки восстановления с согласованным состоянием приложений;
     * точки восстановления с согласованным состоянием файловой системы;
     * все точки восстановления.  
8. Выберите точку восстановления и нажмите кнопку **ОК**.

    ![выбор точки восстановления](./media/backup-azure-arm-restore-vms/select-recovery-point.png)

    В колонке **Восстановление** отобразится выбранная точка восстановления.

    ![точка восстановления выбрана](./media/backup-azure-arm-restore-vms/recovery-point-set.png)
9. В колонке **Восстановление** после выбора точки восстановления автоматически откроется колонка **Конфигурация восстановления**.

## <a name="choosing-a-vm-restore-configuration"></a>Выбор конфигурации восстановления для виртуальной машины
Теперь, когда вы выбрали точку восстановления, следует задать конфигурацию восстановления для виртуальной машины. Настроить восстановление виртуальной машины можно с помощью портала Azure или PowerShell.

1. Перейдите к колонке **Восстановление** , если она еще не открыта. Убедитесь, что вы выбрали [точку восстановления](#select-restore-point-for-restore), а затем щелкните **Конфигурация восстановления**, чтобы открыть колонку **Конфигурация восстановления**.

    ![Выбранный мастер настройки восстановления](./media/backup-azure-arm-restore-vms/recovery-configuration-wizard-recovery-type.png)
2. В колонке **Конфигурация восстановления** есть два параметра:
   * "Restore full virtual machine" (Полное восстановление виртуальной машины);
   * "Restore backed up disks" (Восстановление резервных копий дисков).

Для восстановления виртуальной машины на портале Azure используется параметр "Быстрое создание". Если вы хотите настроить конфигурацию виртуальной машины или имена ресурсов, создаваемых вместе с новой виртуальной машиной, используйте PowerShell или портал, чтобы восстановить заархивированные диски, после чего с помощью команд PowerShell подключите их к конфигурации виртуальной машины или используйте шаблон, предоставляемый вместе восстановленными дисками, чтобы настроить восстановленную виртуальную машину. В разделе [Восстановление виртуальных машин с помощью специальных конфигураций сети](#restoring-vms-with-special-network-configurations) приведены подробные сведения о восстановлении виртуальной машины, использующей несколько сетевых карт или управляемой подсистемой балансировки нагрузки. Если виртуальная машина Windows использует [лицензии для преимуществ гибридного использования (HUB)](../virtual-machines/windows/hybrid-use-benefit-licensing.md), то необходимо восстановить диски и использовать PowerShell или шаблон, как указано ниже, чтобы создать виртуальную машину, и обязательно указать для параметра LicenseType значение Windows_Server при ее создании, чтобы воспользоваться преимуществами гибридного использования на восстановленной виртуальной машине. 
 
## <a name="create-a-new-vm-from-restore-point"></a>Создание виртуальной машины из точки восстановления
Если это еще не сделано, [выберите точку восстановления](#restoring-vms-with-special-network-configurations), прежде чем приступить к созданию виртуальной машины с ее помощью. Выбрав точку восстановления, в колонке **Конфигурация восстановления** введите или выберите значения для каждого из следующих полей.

* **Тип восстановления** — выберите "Создание виртуальной машины".
* **Имя виртуальной машины** — введите имя виртуальной машины. Имя должно быть уникальным в пределах группы ресурсов (для виртуальной машины, развернутой с помощью Resource Manager) или облачной службы (для классической виртуальной машины). Невозможно заменить виртуальную машину, если она уже существует в подписке.
* **Группа ресурсов** — выберите имеющуюся группу ресурсов или создайте новую. При восстановлении классической виртуальной машины укажите в этом поле имя новой облачной службы. Имя создаваемой группы ресурсов или облачной службы должно быть глобально уникальным. Обычно имя облачной службы связано с общедоступным URL-адресом, например: [облачная_служба].cloudapp.net. Если вы попытаетесь использовать уже существующее имя группы ресурсов или облачной службы, Azure назначит группе ресурсов или облачной службе имя виртуальной машины. Azure отображает группы ресурсов, облачные службы и виртуальные машины, не связанные с территориальными группами. Дополнительные сведения см. в статье [Переход от территориальных групп к региональной виртуальной сети](../virtual-network/virtual-networks-migrate-to-regional-vnet.md).
* **Виртуальная сеть** — выберите нужную виртуальную сеть для создания виртуальной машины. В этом раскрывающемся списке перечислены все виртуальные сети, связанные с подпиской. Группа ресурсов виртуальной машины отображается в скобках.
* **Подсеть** — если виртуальная сеть содержит подсети, по умолчанию будет выбрана первая из них. Если подсетей несколько, выберите нужную.
* **Учетная запись хранения** — в этом меню перечислены учетные записи хранения в том же расположении, где находится хранилище служб восстановления. Учетные записи хранения, избыточные в пределах зоны, не поддерживаются. Если у вас нет учетной записи хранения в одном расположении с хранилищем служб восстановления, ее следует создать до запуска восстановления. Тип репликации учетной записи хранения отображается в скобках.

![мастер настройки восстановления выбран](./media/backup-azure-arm-restore-vms/recovery-configuration-wizard.png)

> [!NOTE]
> 1. При восстановлении виртуальной машины, развернутой с помощью Resource Manager, необходимо определить виртуальную сеть. Для классической виртуальной машины виртуальную сеть можно не указывать.
> 2. При восстановлении виртуальных машин с управляемыми дисками убедитесь, что выбранная учетная запись хранения не включена для шифрования службы хранилища (SSE) за определенное время существования.
> 3. В зависимости от типа хранилища выбранной учетной записи хранения (Premium или Standard), все восстановленные диски будут иметь категорию Premium или Standard. Сейчас смешанный режим дисков при восстановлении не поддерживается.  
>
>

Чтобы подтвердить конфигурацию восстановления, в колонке **Конфигурация восстановления** щелкните **ОК**. В колонке **Восстановление** щелкните **Восстановить**, чтобы активировать восстановление.

## <a name="restore-backed-up-disks"></a>"Restore backed up disks" (Восстановление резервных копий дисков).
Если вы хотите настроить виртуальную машину, создаваемую из резервных копий дисков, доступных в колонке "Конфигурация восстановления", выберите значение **Restore disks** (Восстановления дисков) для параметра **Тип восстановления**. При этом будет предложено указать учетную запись хранения для копирования дисков из резервных копий. Следует выбрать учетную запись хранения, которая находится в одном расположении с хранилищем служб восстановления. Учетные записи хранения, избыточные в пределах зоны, не поддерживаются. Если у вас нет учетной записи хранения в одном расположении с хранилищем служб восстановления, ее следует создать до запуска восстановления. Тип репликации учетной записи хранения отображается в скобках.

После завершения восстановления можно:
* [использовать шаблон для настройки восстановленной виртуальной машины;](#use-templates-to-customize-restore-vm)
* [подключить восстановленные диски к существующей виртуальной машине;](../virtual-machines/windows/attach-disk-portal.md)
* [с помощью PowerShell создать виртуальную машину на основе восстановленных дисков.](./backup-azure-vms-automation.md#restore-an-azure-vm)

Чтобы подтвердить конфигурацию восстановления, в колонке **Конфигурация восстановления** щелкните **ОК**. В колонке **Восстановление** щелкните **Восстановить**, чтобы активировать восстановление.

![Завершенная настройка восстановления](./media/backup-azure-arm-restore-vms/trigger-restore-operation.png)

## <a name="track-the-restore-operation"></a>Отслеживание восстановления
Когда вы запускаете восстановление, служба архивации создает задание для отслеживания выполнения операции. Служба архивации также создает и временно отображает уведомление в области уведомлений портала. Если вы пропустите это уведомление, вы всегда сможете щелкнуть соответствующий значок для просмотра уведомлений.

![Запущенное восстановление](./media/backup-azure-arm-restore-vms/restore-notification.png)

Чтобы просмотреть состояние выполняющейся или завершенной операции, откройте список заданий службы архивации.

1. В меню Azure щелкните **Обзор**, а затем в списке ресурсов введите **Службы восстановления**. Список служб будет отображаться в соответствии с вводимым текстом. Когда вы увидите пункт **Хранилища служб восстановления**, щелкните его.

    ![Открытие хранилища служб восстановления](./media/backup-azure-arm-restore-vms/open-recovery-services-vault.png)

    Появится список хранилищ, доступных в подписке.

    ![Список хранилищ служб восстановления](./media/backup-azure-arm-restore-vms/list-of-rs-vaults.png)
2. В этом списке выберите хранилище, связанное с восстанавливаемой виртуальной машиной. Щелкните это хранилище, чтобы открыть панель мониторинга.
3. На панели мониторинга хранилища в колонке **Задания архивации** щелкните **Виртуальные машины Azure**, чтобы увидеть связанные с этим хранилищем задания.

    ![Панель мониторинга хранилища](./media/backup-azure-arm-restore-vms/vault-dashboard-jobs.png)

    Откроется колонка **Задания архивации** , где содержится список заданий.

    ![Список виртуальных машин в хранилище](./media/backup-azure-arm-restore-vms/restore-job-in-progress.png)
    
## <a name="use-templates-to-customize-restore-vm"></a>Использование шаблонов для настройки восстановленной виртуальной машины
После [завершения восстановления дисков](#Track-the-restore-operation) вы можете использовать шаблон, который создается при этом, чтобы создать виртуальную машину с конфигурацией, отличной от архивной конфигурации, или настроить имена ресурсов, создаваемых вместе с виртуальной машиной из точки восстановления. 

> [!NOTE]
> Шаблоны будут добавляться к восстановленным дискам для точек восстановления, созданных после 1 марта 2017 года. Они применимы к виртуальным машинам с незашифрованными и неуправляемыми дисками. Поддержка виртуальных машин с зашифрованными и управляемыми дисками будет реализована в будущих выпусках. 
>
>

Создание шаблона при восстановлении дисков

1. Перейдите к данными соответствующего задания восстановления. 
2. Появится универсальный код ресурса (URI) шаблона, с помощью которого его можно скачать. Запишите имя контейнера из показанных значений. 

     ![Детализация задания восстановления](./media/backup-azure-arm-restore-vms/restore-job-drill-down.png)
     
3. Запишите значения имени конечной учетной записи хранения, имени контейнера и универсального кода ресурса (URI) большого двоичного объекта шаблона. Последовательно выберите *конечная учетная запись хранения > Большие двоичные объекты > Контейнеры*, перейдите к файлам и скачайте файл, имя которого начинается с *azuredeploy*.

    ![download-template-storage-account](./media/backup-azure-arm-restore-vms/download-template.png)
    
   Кроме того, можно использовать [Azure Storage Explorer](http://storageexplorer.com/), чтобы перейти к соответствующей подписке, выбрать целевую учетную запись хранения, щелкнуть колонку "Контейнеры больших двоичных объектов" и выбрать имя контейнера, указанное на предыдущем шаге. В области справа, в которой показаны файлы внутри контейнера, скачайте файл, имя которого начинается с *azuredeploy*. 
   
   ![download-template-storage-explorer](./media/backup-azure-arm-restore-vms/template-storage-explorer-download.png)
     
Скачав шаблон, используйте функцию развертывания шаблона, чтобы [изменить и развернуть его](../azure-resource-manager/resource-group-template-deploy-portal.md#deploy-resources-from-custom-template), или настройте дополнительные параметры, [создав шаблон](../azure-resource-manager/resource-group-authoring-templates.md) перед развертыванием. Для развертывания скачанного шаблона можно использовать параметр "Загрузить файл". 

   ![Загрузка шаблона для развертывания](./media/backup-azure-arm-restore-vms/loading-template.png)
   
Введя необходимые значения, примите *условия* и нажмите кнопку **Приобрести**.

   ![Отправка шаблона для развертывания](./media/backup-azure-arm-restore-vms/submitting-template.png)

## <a name="post-restore-steps"></a>Действия после восстановления
* Если вы используете дистрибутив Linux на основе cloud-init (например, Ubuntu), то в целях безопасности пароль будет заблокирован после восстановления. Для [сброса пароль](../virtual-machines/linux/classic/reset-access.md)на восстановленной виртуальной машине рекомендуется использовать расширение VMAccess. Также мы рекомендуем использовать ключи SSH с такими дистрибутивами, чтобы предотвратить сброс пароля после восстановления.
* Расширения, имеющиеся при настройке архивации, будут установлены, но не будут включены. В случае возникновения каких-либо проблем переустановите расширения. 
* Если архивируемая виртуальная машина имеет статический IP-адрес, то после восстановления у восстановленной виртуальной машины будет динамический IP-адрес во избежание конфликтов при создании этой машины. Ознакомьтесь с дополнительными сведениями о [добавлении статического IP-адреса в восстановленную виртуальную машину](../virtual-network/virtual-networks-reserved-private-ip.md#how-to-add-a-static-internal-ip-to-an-existing-vm).
* У восстановленной виртуальной машины не будет набора значений доступности. При создании виртуальной машины из восстановленных дисков с помощью PowerShell или шаблонов рекомендуется использовать параметр восстановления дисков и [добавление группы доступности](../virtual-machines/windows/create-availability-set.md#use-powershell-to-create-an-availability-set). 


## <a name="backup-for-restored-vms"></a>Архивация для восстановленных виртуальных машин
Если виртуальная машина восстановлена в той же группе ресурсов и с тем же именем, что и первоначально заархивированная виртуальная машина, то архивация будет продолжена и после восстановления виртуальной машины. Если виртуальная машина восстановлена в другой группе ресурсов или под другим именем, то она будет рассматриваться как новая виртуальная машина, и поэтому для нее потребуется настроить архивацию.

## <a name="restoring-a-vm-during-azure-datacenter-disaster"></a>Восстановление виртуальной машины в случае отказа центра обработки данных Azure
Служба архивации Azure позволяет восстанавливать резервные копии виртуальных машин в сопряженном центре обработки данных в случае отказа основного центра обработки данных, в котором запущены эти виртуальные машины, если при этом хранилище архивации настроено как геоизбыточное. В таких случаях необходимо выбрать учетную запись хранения, которая присутствует в сопряженном центре данных. Остальная часть процесса восстановления остается неизменной. В службе архивации Azure для создания восстановленной виртуальной машины используется служба вычислений, расположенная в сопряженном геообъекте. Дополнительные сведения см. в статье [Техническое руководство по обеспечению устойчивости в Azure. Восстановление после прерывания работы служб во всем регионе](../resiliency/resiliency-technical-guidance-recovery-loss-azure-region.md)

## <a name="restoring-domain-controller-vms"></a>Восстановление виртуальных машин контроллера домена
Резервное копирование виртуальных машин контроллера домена поддерживается Azure Backup. Тем не менее при восстановлении необходимо соблюдать осторожность. Правильный процесс восстановления зависит от структуры домена. Простейший случай — один контроллер домена в одном домене. Более распространенный вариант для рабочих нагрузок — один домен с несколькими контроллерами домена (некоторые из них могут быть на локальном компьютере). И еще один вариант — лес с несколькими доменами. 

Для Active Directory виртуальная машина Azure соответствует любой другой виртуальной машине в современном поддерживаемом гипервизоре. Особенностью использования локальных гипервизоров является отсутствие доступной консоли виртуальной машины в Azure. Консоль требуется в некоторых случаях, например при восстановлении из резервной копии в рамках восстановления исходного состояния системы. Хотя есть и полная замена такому типу восстановления. Это — восстановление виртуальной машины из резервного хранилища. Кроме того, доступен режим восстановления Active Directory, следовательно, все сценарии восстановления Active Directory также являются приемлемыми. См. дополнительные сведения о [резервном копировании и восстановлении рекомендации для виртуализированных контроллеров домена](https://technet.microsoft.com/en-us/library/virtual_active_directory_domain_controller_virtualization_hyperv(v=ws.10).aspx#backup_and_restore_considerations_for_virtualized_domain_controllers) и [планировании восстановления леса Active Directory](https://technet.microsoft.com/en-us/library/planning-active-directory-forest-recovery(v=ws.10).aspx).

### <a name="single-dc-in-a-single-domain"></a>Один контроллер домена в одном домене
В этом случае виртуальная машина может быть восстановлена (как и любая другая виртуальная машина) на портале Azure или с помощью PowerShell.

### <a name="multiple-dcs-in-a-single-domain"></a>Несколько контроллеров домена в одном домене
Если другие контроллеры домена в одном домене доступны по сети, контроллер домена можно восстановить как виртуальную машину. Если это последний контроллер домена в домене или выполняется восстановление в изолированной сети, восстановление должно выполняться как для леса.

### <a name="multiple-domains-in-one-forest"></a>Несколько доменов в одном лесу
Если другие контроллеры домена в одном домене доступны по сети, контроллер домена можно восстановить как виртуальную машину. Во всех остальных случаях рекомендуется восстановление леса.

## <a name="restoring-vms-with-special-network-configurations"></a>Восстановление виртуальных машин с помощью специальных конфигураций сети
Вы можете выполнять архивацию и восстановление виртуальных машин, используя следующие специальные конфигурации сети. Но восстановление с использованием таких конфигураций предполагает соблюдение следующих требований.

* Виртуальные машины с балансировщиком нагрузки (внутренним или внешним).
* Виртуальные машины с несколькими зарезервированными IP-адресами
* Виртуальные машины с несколькими сетевыми картами

> [!IMPORTANT]
> Если вы создаете специальную конфигурацию сети для виртуальных машин, следует использовать PowerShell, чтобы создать виртуальную машину на основе восстановленных дисков.
>
>

Вот как можно повторно создать виртуальные машины после восстановления на диск.

1. Восстановите диски из хранилища служб восстановления с помощью средства [PowerShell](backup-azure-vms-automation.md#restore-an-azure-vm).
2. Создайте конфигурацию виртуальной машины для сценариев с использованием балансировщика нагрузки, нескольких сетевых адаптеров или зарезервированных IP-адресов с помощью командлетов PowerShell. Затем создайте с помощью этой конфигурации виртуальную машину с нужными параметрами.

   * Создайте виртуальную машину в облачной службе с [внутренним балансировщиком нагрузки ](https://azure.microsoft.com/documentation/articles/load-balancer-internal-getstarted/)
   * Создайте виртуальную машину для подключения к [подсистеме балансировки нагрузки для Интернета](https://azure.microsoft.com/en-us/documentation/articles/load-balancer-internet-getstarted/).
   * Создайте виртуальную машину с [несколькими сетевыми адаптерами](https://azure.microsoft.com/documentation/articles/virtual-networks-multiple-nics/)
   * Создайте виртуальную машину с [несколькими зарезервированными IP-адресами](https://azure.microsoft.com/documentation/articles/virtual-networks-reserved-public-ip/)

## <a name="next-steps"></a>Дальнейшие действия
Теперь вы знаете, как восстанавливать виртуальные машины. Информацию о типичных ошибках, связанных с работой виртуальных машин, см. в статье об устранении неполадок. Ознакомьтесь также с инструкцией по управлению задачами, выполняемыми на виртуальных машинах.

* [Устранение ошибок](backup-azure-vms-troubleshoot.md#restore)
* [Управление виртуальными машинами](backup-azure-manage-vms.md)

