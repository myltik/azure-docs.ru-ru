---
title: Подготовка среды для архивации виртуальных машин Azure | Документация Майкрософт
description: Убедитесь, что ваша среда подготовлена для резервного копирования виртуальных машин в Azure.
services: backup
documentationcenter: ''
author: markgalioto
manager: carmonn
editor: ''
keywords: резервные копии; резервное копирование;
ms.assetid: 238ab93b-8acc-4262-81b7-ce930f76a662
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 9/10/2017
ms.author: cwatson
ms.openlocfilehash: 03bb4c3e68643ded686c20b7ba0d5d079a9d4057
ms.sourcegitcommit: d98d99567d0383bb8d7cbe2d767ec15ebf2daeb2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
---
# <a name="prepare-your-environment-to-back-up-azure-virtual-machines"></a>Подготовка среды для резервного копирования виртуальных машин Azure
> [!div class="op_single_selector"]
> * [Модель Resource Manager](backup-azure-arm-vms-prepare.md)
> * [Классическая модель](backup-azure-vms-prepare.md)
>
>

Прежде чем можно будет выполнять резервное копирование виртуальной машины Azure, необходимо обеспечить выполнение трех условий:

* Создайте хранилище архивации или найдите имеющееся хранилище архивации *в том же регионе, что и виртуальная машина*.
* Установить сетевое подключение между общедоступными IP-адресами Azure и конечными точками хранилища Azure.
* Установить агент виртуальной машины.

Если вы знаете, что эти условия в вашей среде уже выполнены, переходите к статье [Резервное копирование виртуальных машин](backup-azure-vms.md). Если это не так, подготовьте среду к резервному копированию виртуальной машины Azure, как описано в этой статье.

##<a name="supported-operating-system-for-backup"></a>Поддерживаемые версии операционных систем для архивации
 * **Linux**: служба архивации Azure поддерживает весь [список дистрибутивов, рекомендуемых для использования в Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) , за исключением CoreOS Linux. _Другие собственные дистрибутивы Linux также должны работать, если агент виртуальной машины доступен на виртуальной машине и есть поддержка Python. Тем не менее мы не поддерживаем использование этих дистрибутивов для архивации._
 * **Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.


## <a name="limitations-when-backing-up-and-restoring-a-vm"></a>Ограничения при резервном копировании и восстановлении виртуальной машины
> [!NOTE]
> В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../azure-resource-manager/resource-manager-deployment-model.md). При развертывании по классической модели действуют следующие ограничения.
>
>

* Архивация виртуальных машин, к которым подключено более 16 дисков данных, не поддерживается.
* Архивация виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.
* Данные архивации не содержат установленные в сети диски, подключенные к виртуальной машине.
* Замена существующей виртуальной машины во время восстановления не поддерживается. Сначала необходимо удалить существующую виртуальную машину и все связанные диски, а затем восстановить данные из резервной копии.
* Резервное копирования и восстановление между регионами не поддерживается.
* Архивация виртуальных машин с помощью службы архивации Azure поддерживается во всех областях, общих для Azure (см. [контрольный список](https://azure.microsoft.com/regions/#services) поддерживаемых регионов). Если искомый регион в настоящее время не поддерживается, он будет отсутствовать в раскрывающемся списке при создании хранилища.
* Архивация виртуальных машин с помощью службы архивации Azure поддерживается только в определенных версиях операционных систем:
* Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell. Дополнительные сведения о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).
* Восстановление виртуальных машин с описанными ниже особыми конфигурациями сети поддерживается только в PowerShell. Когда процедура восстановления будет завершена, виртуальные машины, созданные в пользовательском интерфейсе с помощью рабочего процесса восстановления, не будут включать эти конфигурации сети. Дополнительные сведения см. в разделе [Восстановление виртуальных машин с помощью специальных конфигураций сети](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).
  * Виртуальные машины в конфигурации балансировщика нагрузки (внутренняя и внешняя)
  * Виртуальные машины с несколькими зарезервированными IP-адресами
  * Виртуальные машины с несколькими сетевыми адаптерами

## <a name="create-a-backup-vault-for-a-vm"></a>Создание хранилища архивации для виртуальной машины
Хранилище архивации — это сущность, в которой хранятся созданные резервные копии и точки восстановления. Хранилище архивации также содержит политики резервного копирования, применяемые к виртуальным машинам, для которых настроена архивация.

> [!IMPORTANT]
> Начиная с марта 2017 года классический портал больше нельзя использовать для создания хранилищ службы архивации. Имеющиеся хранилища службы архивации по-прежнему поддерживаются. Вы также [можете использовать Azure PowerShell, чтобы создать новые](./backup-client-automation-classic.md#create-a-backup-vault). Однако мы советуем создавать хранилища служб восстановления для всех развертываний, так как все новые улучшения будут применяться только к этим хранилищам.


На рисунке ниже показаны связи между разными сущностями службы архивации Azure: ![Сущности и связи службы архивации Azure](./media/backup-azure-vms-prepare/vault-policy-vm.png).



## <a name="network-connectivity"></a>Сетевое подключение
Чтобы управлять моментальными снимками виртуальной машины, для расширения архивации требуется подключение к общедоступным IP-адресам Azure. Без правильного подключения к Интернету время ожидания HTTP-запросов от виртуальной машины истекает, а архивация завершается сбоем. Если для развертывания установлены ограничения доступа на месте, например, через группу безопасности сети (NSG), выберите один из следующих вариантов, чтобы открыть путь для трафика архивации:

* [Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений](http://www.microsoft.com/en-us/download/details.aspx?id=41653). В статье вы найдете указания по добавлению IP-адресов в список разрешений.
* Разверните прокси-сервер HTTP для маршрутизации трафика.

Решая, какой вариант использовать, обратите внимание на соотношение управляемости, детального управления и затрат.

| Параметр | Преимущества | Недостатки |
| --- | --- | --- |
| Разрешенные диапазоны IP-адресов |Нет дополнительных затрат.<br><br>Нет дополнительных затрат. Открыть доступ в NSG можно с помощью командлета <i>Set-AzureNetworkSecurityRule</i>. |Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются.<br><br>Доступ ко всей службе Azure, а не только к хранилищу. |
| Прокси-сервер HTTP |Точное управление разрешенными URL-адресами хранилища в прокси-сервере. Чтобы настроить детальное управление на прокси-сервере, нужно внести шаблон URL-адреса https://\*.blob.core.windows.net/\* в список разрешений. Чтобы разрешить только учетную запись, используемую виртуальной машиной, нужно внести шаблон URL-адреса https://\<storageAccount\>.blob.core.windows.net/\* в список разрешений. <br>Единая точка доступа к виртуальным машинам через Интернет.<br>Не подвергается влиянию изменений IP-адресов Azure. |Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера. |

### <a name="whitelist-the-azure-datacenter-ip-ranges"></a>Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.
Чтобы добавить диапазоны IP-адресов центра обработки данных Azure в список разрешений, ознакомьтесь с дополнительными сведениями о диапазонах IP-адресов и указаниями на [веб-сайте Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) .

### <a name="using-an-http-proxy-for-vm-backups"></a>Использование прокси-сервера HTTP для архивации виртуальных машин
Во время архивации виртуальных машин команды управления моментальными снимками отправляются из расширения архивации в службу хранилища Azure с помощью API HTTPS. Направьте трафик расширения архивации через прокси-сервер HTTP, потому что это единственный компонент, который настроен для общего доступа в Интернете.

> [!NOTE]
> Особых требований к программному обеспечению нет. Убедитесь, что вы выбрали прокси-сервер с закреплением исходящего трафика, который можно использовать в приведенных ниже шагах конфигурации. Убедитесь, что сторонние программы не изменяют настройки прокси-сервера.
>
>

На приведенном ниже изображении показан пример трех этапов настройки, которые необходимо выполнить, чтобы использовать прокси-сервер HTTP:

* Виртуальная машина приложения направляет весь HTTP-трафик для общего доступа в Интернете через виртуальную машину прокси-сервера.
* В виртуальной машине прокси-сервера разрешен входящий трафик от виртуальных машин в виртуальной сети.
* Для группы безопасности сети с именем NSF-lockdown требуется правило безопасности, которое разрешает передачу интернет-трафика из виртуальной машины прокси-сервера.

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

Чтобы использовать прокси-сервер HTTP для обмена данными для общего доступа в Интернете, выполните следующие действия.

#### <a name="step-1-configure-outgoing-network-connections"></a>Шаг 1. Настройка исходящих сетевых подключений
###### <a name="for-windows-machines"></a>Для компьютеров Windows
Следующая процедура позволяет настроить конфигурацию прокси-сервера для учетной записи Local System.

1. Скачайте программу [PsExec](https://technet.microsoft.com/sysinternals/bb897553)
2. Выполните следующую команду из командной строки с повышенными привилегиями:

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     Откроется окно Internet Explorer.
3. Последовательно выберите "Сервис -> Свойства обозревателя -> Подключения -> Настройка сети".
4. Проверьте параметры прокси-сервера для системной учетной записи. Задайте IP-адрес прокси-сервера и порт.
5. Закройте Internet Explorer.

В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.

Если вы настроили прокси-сервер из текущей учетной записи пользователя, а не учетной записи Local System, используйте следующий сценарий для применения к SYSTEMACCOUNT:

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> Если в журнале прокси-сервера отобразится сообщение "407 — Требуется проверка подлинности прокси", проверьте правильность настройки аутентификации.
>
>

###### <a name="for-linux-machines"></a>Для компьютеров Linux
Добавьте следующую строку в файл ```/etc/environment``` :

```
http_proxy=http://<proxy IP>:<proxy port>
```

Добавьте следующие строки в файл ```/etc/waagent.conf``` :

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-the-proxy-server"></a>Шаг 2. Разрешение входящих подключений на прокси-сервере
1. Откройте брандмауэр Windows на прокси-сервере. Самый простой способ доступа к брандмауэру — это поиск брандмауэра Windows в режиме повышенной безопасности.

    ![Открытие брандмауэра](./media/backup-azure-vms-prepare/firewall-01.png)
2. В диалоговом окне брандмауэра Windows щелкните правой кнопкой мыши **Правила для входящих подключений** и выберите **Создать правило**.

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)
3. В **мастере создания правила для нового входящего подключения** выберите значение **Настраиваемое** для параметра **Тип правила** и нажмите кнопку **Далее**.
4. Чтобы выбрать **программу**, щелкните элемент **Все программы** и нажмите кнопку **Далее**.
5. На странице **Протокол и порты** введите следующие сведения и нажмите кнопку **Далее**.

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

   * Для параметра *Тип протокола* выберите *TCP*.
   * В поле *Локальный порт* выберите *Определенные порты*, а в поле под ним укажите уже настроенный порт ```<Proxy Port>```.
   * В поле *Удаленный порт* выберите *Все порты*.

     Выполните все инструкции мастера и укажите имя правила.

#### <a name="step-3-add-an-exception-rule-to-the-nsg"></a>Шаг 3. Добавление правила исключения к группе NSG
Введите следующую команду в командной строке Azure PowerShell:

Она добавляет исключение к группе NSG. Это исключение разрешает TCP-трафик из любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS). Если вам необходимо разрешить общий доступ из Интернета к какому-либо порту, добавьте этот порт в параметр ```-DestinationPortRange``` .

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```

*Не забудьте заменить имена из примера данными, соответствующими вашему развертыванию.*

## <a name="vm-agent"></a>Агент виртуальной машины
Перед началом архивации виртуальной машины Azure убедитесь, что на ней правильно установлен агент виртуальной машины. Так как агент виртуальной машины является необязательным компонентом при создании виртуальной машины, убедитесь, что флажок агента виртуальной машины установлен до ее подготовки.

### <a name="manual-installation-and-update"></a>Ручная установка и обновление
Как правило, агент виртуальной машины уже имеется на виртуальных машинах, которые созданы с помощью коллекции Azure. Однако на виртуальных машинах, которые переносятся из локальных центров обработки данных, агент виртуальной машины отсутствует. Для таких виртуальных машин агент VM необходимо установить явным образом. 

| **Операция** | **Windows** | **Linux** |
| --- | --- | --- |
| Установка агента VM |Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора.<li>[Обновите свойство виртуальной машины](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) , чтобы указать, что агент установлен. |<li> Установите последнюю версию [агента Linux](../virtual-machines/extensions/agent-linux.md). Чтобы выполнить установку, необходимо иметь права администратора. Мы рекомендуем устанавливать агент из репозитория дистрибутива. Мы **не рекомендуем** устанавливать агент виртуальной машины Linux непосредственно из Github.  |
| Обновление агента виртуальной машины |Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции архивации. |Следуйте указаниям по [обновлению агента виртуальной машины Linux ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json). Мы рекомендуем обновлять агент из репозитория дистрибутива. Мы **не рекомендуем** обновлять агент виртуальной машины Linux непосредственно из Github.<br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции резервного копирования. |
| Проверка установки агента VM |<li>На виртуальной машине Azure перейдите в папку *C:\WindowsAzure\Packages*. <li>В ней должен находиться файл WaAppAgent.exe.<li> Щелкните правой кнопкой мыши этот файл, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше. |Недоступно |

Ознакомьтесь с дополнительными сведениями об [агенте виртуальной машины](https://go.microsoft.com/fwLink/?LinkID=390493&clcid=0x409) и [его установке](https://azure.microsoft.com/blog/2014/04/15/vm-agent-and-extensions-part-2/).

### <a name="backup-extension"></a>Расширение резервного копирования
Чтобы выполнить архивацию виртуальной машины, служба архивации Azure устанавливает расширение для агента виртуальной машины. Служба резервного копирования Azure легко обновляет и применяет исправления к расширению резервного копирования без дополнительного вмешательства пользователя.

Расширение резервного копирования устанавливается, если виртуальная машина запущена. Кроме того, на запущенной виртуальной машине проще всего получить точку восстановления, согласованную с приложениями. Тем не менее, служба архивации Azure будет продолжать архивацию виртуальной машины, даже если она выключена и установить расширение невозможно (автономная виртуальная машина). В этом случае точка восстановления будет *отказоустойчивой* , как обсуждалось выше.

## <a name="questions"></a>Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>Дополнительная информация
Следующий шаг после подготовки среды для резервного копирования виртуальной машины — это создание резервной копии. Более подробные сведения о резервном копировании виртуальных машин см. в статье по планированию.

* [Настройка виртуальных машин](backup-azure-vms.md)
* [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](backup-azure-vms-introduction.md)
* [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)
