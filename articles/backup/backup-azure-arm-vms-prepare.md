---
title: "Служба архивации Azure: подготовка к архивации виртуальных машин | Документация Майкрософт"
description: "Убедитесь, что ваша среда подготовлена для архивации виртуальных машин в Azure."
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
editor: 
keywords: "резервные копии; резервное копирование;"
ms.assetid: e87e8db2-b4d9-40e1-a481-1aa560c03395
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 7/10/2017
ms.author: markgal;trinadhk;
ms.translationtype: HT
ms.sourcegitcommit: 83f19cfdff37ce4bb03eae4d8d69ba3cbcdc42f3
ms.openlocfilehash: 8d701f4a459da2e08510e8001adca0847b08e924
ms.contentlocale: ru-ru
ms.lasthandoff: 08/21/2017

---
# <a name="prepare-your-environment-to-back-up-resource-manager-deployed-virtual-machines"></a>Подготовка среды к архивации виртуальных машин, развернутых с помощью Resource Manager
> [!div class="op_single_selector"]
> * [Модель Resource Manager](backup-azure-arm-vms-prepare.md)
> * [Классическая модель](backup-azure-vms-prepare.md)
>
>

В этой статье приведены шаги по подготовке среды к архивации виртуальной машины, развернутой с помощью Resource Manager. Шаги процедур выполняются на портале Azure.  

Служба архивации Azure использует два типа хранилищ (резервные и хранилища служб восстановления) для защиты виртуальных машин. Хранилище архивации служит для защиты виртуальных машин, развернутых с использованием классической модели развертывания. Хранилище служб восстановления служит для защиты виртуальных машин, **развернутых с использованием как классической модели, так и Resource Manager**. Чтобы обеспечить защиту виртуальных машин, развернутых с помощью Resource Manager, необходимо использовать хранилище служб восстановления.

> [!NOTE]
> В Azure предусмотрены две модели развертывания, позволяющие создавать ресурсы и работать с ними: [модель Resource Manager и классическая модель](../azure-resource-manager/resource-manager-deployment-model.md). Дополнительные сведения о работе с виртуальными машинами, развернутыми с использованием классической модели, см. в статье [Подготовка среды для резервного копирования виртуальных машин Azure](backup-azure-vms-prepare.md).
>
>

Чтобы можно было защитить или архивировать виртуальную машину, развернутую с помощью Resource Manager, необходимо выполнить следующие предварительные требования.

* Создайте хранилище служб восстановления (или укажите имеющееся) *в том же расположении, где находится виртуальная машина*.
* Выберите сценарий, определите политику архивации, а также элементы, которые необходимо защитить.
* Проверьте, установлен ли на виртуальной машине соответствующий агент.
* Проверьте сетевое подключение.
* Если для виртуальных машин Linux требуется настроить среду архивации для создания резервных копий с согласованием приложений, выполните [инструкции по настройке сценариев, выполняемых перед созданием моментального снимка и после него](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent).

Если вы знаете, что эти условия в вашей среде уже выполнены, переходите к статье [Резервное копирование виртуальных машин](backup-azure-vms.md). Если нужно выполнить любые из этих предварительных требований или проверить их соблюдение, в этой статье описаны шаги по их подготовке.

##<a name="supported-operating-system-for-backup"></a>Поддерживаемые версии операционных систем для архивации
 * **Linux**: служба архивации Azure поддерживает весь [список дистрибутивов, рекомендуемых для использования в Azure](../virtual-machines/linux/endorsed-distros.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json) , за исключением CoreOS Linux. _Другие собственные дистрибутивы Linux также должны работать, если агент виртуальной машины доступен на виртуальной машине и есть поддержка Python. Тем не менее мы не поддерживаем использование этих дистрибутивов для архивации._
 * **Windows Server**: версии до Windows Server 2008 R2 не поддерживаются.

## <a name="limitations-when-backing-up-and-restoring-a-vm"></a>Ограничения при резервном копировании и восстановлении виртуальной машины
Перед подготовкой среды ознакомьтесь с ограничениями.

* Архивация виртуальных машин, к которым подключено более 16 дисков данных, не поддерживается.
* Резервное копирование виртуальных машин, к которым подключены диски емкостью 1023 ГБ, не поддерживается.
* Архивация виртуальных машин с зарезервированным IP-адресом и без заданной конечной точки не поддерживается.
* Архивация виртуальных машин, зашифрованных только с помощью BEK, не поддерживается. Архивация виртуальных машин Linux, зашифрованных с помощью шифрования LUKS, не поддерживается.
* Резервное копирование виртуальных машин в развернутой конфигурации файлового сервера не рекомендуется.
* Данные архивации не содержат установленные в сети диски, подключенные к виртуальной машине.
* Замена существующей виртуальной машины во время восстановления не поддерживается. При попытке восстановить имеющуюся виртуальную машину произойдет сбой операции.
* Архивация и восстановление между регионами не поддерживаются.
* Резервные копии виртуальных машин можно создавать в любых общедоступных регионах Azure (см. [список](https://azure.microsoft.com/regions/#services) поддерживаемых регионов). Если искомый регион в настоящее время не поддерживается, он будет отсутствовать в раскрывающемся списке при создании хранилища.
* Восстановление контроллера домена виртуальной машины, которая входит в конфигурацию с несколькими контроллерами домена, поддерживается только с помощью PowerShell. Дополнительные сведения о [восстановлении контроллера домена в конфигурации с несколькими контроллерами домена](backup-azure-restore-vms.md#restoring-domain-controller-vms).
* Восстановление виртуальных машин с описанными ниже особыми конфигурациями сети поддерживается только в PowerShell. Когда процедура восстановления будет завершена, виртуальные машины, созданные в пользовательском интерфейсе с помощью рабочего процесса восстановления, не будут включать в себя эти конфигурации сети. Дополнительные сведения см. в разделе [Восстановление виртуальных машин с помощью специальных конфигураций сети](backup-azure-restore-vms.md#restoring-vms-with-special-network-configurations).
  * Виртуальные машины в конфигурации балансировщика нагрузки (внутренняя и внешняя)
  * Виртуальные машины с несколькими зарезервированными IP-адресами
  * Виртуальные машины с несколькими сетевыми адаптерами

## <a name="create-a-recovery-services-vault-for-a-vm"></a>Создание хранилища служб восстановления для виртуальной машины
Хранилище служб восстановления — это сущность, в которой хранятся созданные резервные копии и точки восстановления. В нем также содержатся политики архивации, связанные с защищенными виртуальными машинами.

Чтобы создать хранилище служб восстановления, сделайте следующее:

1. Войдите на [портал Azure](https://portal.azure.com/).
2. В главном меню щелкните **Обзор**, а затем в списке ресурсов введите **Службы восстановления**. Как только вы начнете вводить, список отфильтруется соответствующим образом. Щелкните **Хранилище служб восстановления**.

    ![Нажмите кнопку "Обзор" и введите "службы восстановления". Когда отобразится пункт "Хранилище служб восстановления", щелкните его, чтобы открылась колонка "Хранилище служб восстановления".](./media/backup-azure-arm-vms-prepare/browse-to-rs-vaults-updated.png) <br/>

    После этого отобразится список хранилищ служб восстановления.
3. В меню **Хранилища служб восстановления** щелкните **Добавить**.

    ![Создание хранилища служб восстановления — шаг 2](./media/backup-azure-arm-vms-prepare/rs-vault-menu.png)

    Откроется колонка хранилища служб восстановления, в которой нужно указать **имя**, **подписку**, **группу ресурсов** и **расположение**.

    ![Создание хранилища служб восстановления — шаг 5](./media/backup-azure-arm-vms-prepare/rs-vault-attributes.png)
4. В поле **Имя**введите понятное имя хранилища. Имя должно быть уникальным в пределах подписки Azure. Введите имя длиной от 2 до 50 знаков. Имя должно начинаться с буквы, оно может содержать только буквы, цифры и дефисы.
5. Щелкните **Подписка** , чтобы просмотреть список доступных подписок. Если неизвестно, какую подписку нужно использовать, оставьте подписку по умолчанию (или предлагаемую подписку). Вариантов будет несколько только в том случае, если учетная запись вашей организации связана с несколькими подписками Azure.
6. Щелкните **Группа ресурсов**, чтобы просмотреть список доступных групп ресурсов, или создайте группу ресурсов, щелкнув **Создать**. Дополнительные сведения о группах ресурсов см. в [обзоре Azure Resource Manager](../azure-resource-manager/resource-group-overview.md).
7. В поле **Расположение** выберите географический регион, в котором будет находиться хранилище. Хранилище **должно** находиться в том же регионе, что и виртуальные машины, которые необходимо защитить.

   > [!IMPORTANT]
   > Если вы не уверены, в каком расположении находится ваша виртуальная машина, закройте диалоговое окно создания хранилища и перейдите к списку виртуальных машин на портале. Если у вас есть виртуальные машины в нескольких регионах, вам необходимо создать хранилище служб восстановления в каждом из них. Прежде чем переходить к следующему расположению, необходимо создать хранилище в первом расположении. Указывать учетные записи хранения для данных резервных копий не требуется: хранилище служб восстановления и служба архивации Azure сделают это автоматически.
   >
   >

8. Щелкните **Создать**. Для создания хранилища служб восстановления может потребоваться некоторое время. Следите за уведомлениями о состоянии на портале в верхней правой области. После создания хранилище появится в списке хранилищ служб восстановления. Если хранилище не отобразилось, щелкните **Обновить**.

    ![Список хранилищ службы архивации](./media/backup-azure-arm-vms-prepare/rs-list-of-vaults.png)

    Теперь, когда вы создали хранилище, можно приступить к настройке репликации.

## <a name="set-storage-replication"></a>Настройка репликации хранилища
При настройке репликации хранилища можно выбирать между геоизбыточным хранилищем и локально избыточным хранилищем. По умолчанию это геоизбыточное хранилище. Если данная резервная копия является основной, оставьте установленный параметр. Если вам нужно более дешевое и не такое надежное решение, выберите локально избыточное хранилище.

Чтобы изменить параметр репликации хранилища:

1. В колонке **Хранилища служб восстановления** выберите хранилище.
    При выборе хранилища открывается колонка "Параметры" (*с именем хранилища вверху*), а также колонка со сведениями о хранилище.

    ![выбор хранилища в списке хранилищ службы архивации](./media/backup-azure-arm-vms-prepare/new-vault-settings-blade.png)

2. В колонке **Параметры** прокрутите вниз с помощью вертикального ползунка к разделу **Управление**. Щелкните **Инфраструктура резервного копирования**, чтобы открыть соответствующую колонку. В разделе **Общие** щелкните **Резервная конфигурация**, чтобы открыть соответствующую колонку. В колонке **Конфигурация архивации** выберите вариант репликации для своего хранилища. По умолчанию это геоизбыточное хранилище. Если тип репликации хранилища был изменен, щелкните **Сохранить**.

    ![Список хранилищ службы архивации](./media/backup-azure-arm-vms-prepare/full-blade.png)

     Если в качестве конечной точки основного хранилища службы архивации используется Azure, продолжайте использовать геоизбыточное хранилище. Если Azure используется в качестве конечной точки вторичного хранилища службы архивации, выберите локально избыточное хранилище. Дополнительные сведения о [геоизбыточном](../storage/common/storage-redundancy.md#geo-redundant-storage) и [локально избыточном](../storage/common/storage-redundancy.md#locally-redundant-storage) хранилищах см. в [обзоре репликации службы хранилища Azure](../storage/common/storage-redundancy.md).
    Выбрав параметры хранилища, вы можете приступать к связыванию виртуальной машины с хранилищем. Перед началом связывания нужно обнаружить и зарегистрировать виртуальные машины Azure.

## <a name="select-a-backup-goal-set-policy-and-define-items-to-protect"></a>Выбор цели архивации, настройка политики и определение объектов для защиты
Прежде чем регистрировать виртуальную машину в хранилище, нужно запустить процесс обнаружения, чтобы определить все недавно добавленные в подписку виртуальные машины. В ходе этого процесса в Azure отправляется запрос о предоставлении списка виртуальных машин в подписке и дополнительных сведений, в том числе имени и региона облачной службы. На портале Azure под сценарием имеется в виду то, что вы собираетесь поместить в хранилище служб восстановления. Политика — это расписание, которое определяет частоту и время создания точек восстановления. Политика также включает диапазон хранения для точек восстановления.

1. Если хранилище служб восстановления уже открыто, перейдите к шагу 2. Если хранилище служб восстановления не открыто, откройте [портал Azure](https://portal.azure.com/) и в главном меню щелкните **Больше служб**.

   * В списке ресурсов введите **Службы восстановления**.
   * Как только вы начнете вводить, список отфильтруется соответствующим образом. Когда появится пункт **Хранилища служб восстановления**, щелкните его.

     ![Создание хранилища служб восстановления — шаг 1](./media/backup-azure-arm-vms-prepare/browse-to-rs-vaults-updated.png) <br/>

     После этого отобразится список хранилищ служб восстановления, Если в подписке нет хранилищ, список останется пустым.

    ![Просмотр списка хранилищ служб восстановления](./media/backup-azure-arm-vms-prepare/rs-list-of-vaults.png)

   * В списке хранилищ служб восстановления выберите хранилище, чтобы открыть соответствующую панель мониторинга.

     Для выбранного хранилища откроется колонка "Параметры" и панель мониторинга.

     ![Открытие колонки хранилища](./media/backup-azure-arm-vms-prepare/new-vault-settings-blade.png)
2. В меню панели мониторинга хранилища щелкните **Архивация**, чтобы открыть соответствующую колонку.

    ![Открытие колонки резервного копирования](./media/backup-azure-arm-vms-prepare/backup-button.png)

    Откроются колонки "Архивация" и "Цель резервного копирования".

    ![Открытие колонки сценария](./media/backup-azure-arm-vms-prepare/select-backup-goal-1.png)

3. В колонке "Цель резервного копирования" для параметра **Где выполняется рабочая нагрузка?** установите значение Azure, а для параметра **What do you want to backup** (Что вы хотите резервировать?) — значение "Виртуальная машина", а затем нажмите кнопку **ОК**.

    При этом расширение виртуальной машины зарегистрируется в хранилище. После этого колонка "Цель резервного копирования" закроется и откроется колонка **Политика архивации**.

    ![Открытие колонки сценария](./media/backup-azure-arm-vms-prepare/select-backup-goal-2.png)
4. В колонке "Политика архивации" выберите политику архивации для своего хранилища.

    ![Выбор политики резервного копирования](./media/backup-azure-arm-vms-prepare/setting-rs-backup-policy-new.png)

    Подробные сведения о политике по умолчанию указаны в раскрывающемся меню. Если вы хотите создать политику, в раскрывающемся меню щелкните **Создать**. Инструкции по определению политики резервного копирования см. в разделе [Определение политики резервного копирования](backup-azure-vms-first-look-arm.md#defining-a-backup-policy).
    Чтобы связать политику архивации с хранилищем, нажмите кнопку **ОК**.

    После этого колонка "Цель резервного копирования" закроется и откроется колонка **Выбор виртуальных машин**.
5. Выберите виртуальные машины в колонке **Выбор виртуальных машин**, чтобы связать их с указанной политикой, и нажмите кнопку **OK**.

    ![Выбор рабочей нагрузки](./media/backup-azure-arm-vms-prepare/select-vms-to-backup.png)

    Выбранная виртуальная машина пройдет проверку. Если необходимые вам виртуальные машины не отобразятся, проверьте, относятся ли они к тому же расположению Azure, что и хранилище служб восстановления, и не защищены ли они уже в другом хранилище. Расположение хранилища служб восстановления отображается на панели мониторинга хранилища.

6. Теперь, когда все параметры для хранилища заданы, в колонке "Архивация" щелкните **Включить архивацию**. В результате выполнения этой команды для хранилища и виртуальных машин будет развернута политика. Эта команда не создает начальную точку восстановления для виртуальной машины.

    ![Включить резервное копирование](./media/backup-azure-arm-vms-prepare/vm-validated-click-enable.png)

После успешного включения архивации политика архивации будет выполняться по расписанию. Если вы хотите создать задание архивации по запросу, чтобы выполнить архивацию виртуальных машин, см. раздел [Активация задания архивации](./backup-azure-arm-vms.md#triggering-the-backup-job).

Если у вас возникли проблемы с регистрацией виртуальной машины, см. сведения об установке агента виртуальной машины и сетевом подключении. Если защита виртуальных машин, созданных в Azure, включена, следующие сведения можно пропустить. Однако если вы перенесли виртуальные машины в Azure, убедитесь, что агент виртуальной машины установлен должным образом и что виртуальная машина может подключиться к виртуальной сети.

## <a name="install-the-vm-agent-on-the-virtual-machine"></a>Установка агента ВМ на виртуальной машине
Агент VM Azure необходимо установить на виртуальной машине Azure, чтобы обеспечить работоспособность модуля резервного копирования. Если виртуальная машина создана из коллекции Azure, агент уже существует на виртуальной машине. Эти сведения указываются, если вы *не* используете виртуальную машину, созданную из коллекции Azure, например если вы перенесли виртуальную машину из локального центра обработки данных. В таком случае необходимо установить агент виртуальной машины, чтобы защитить ее. Ознакомьтесь со сведениями об [агенте виртуальной машины](../virtual-machines/windows/classic/agents-and-extensions.md#azure-vm-agents-for-windows-and-linux).

Если у вас возникли сложности с резервным копированием виртуальной машины Azure, убедитесь, что на ней правильно установлен агент ВМ Azure (см. таблицу ниже). В таблице ниже приведены дополнительные сведения об агенте для виртуальных машин Windows и Linux.

| **Операция** | **Windows** | **Linux** |
| --- | --- | --- |
| Установка агента VM |Скачайте и установите [MSI-файл агента](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). Чтобы выполнить установку, необходимо иметь права администратора. |<li> Установите последнюю версию [агента Linux](../virtual-machines/linux/agent-user-guide.md). Чтобы выполнить установку, необходимо иметь права администратора. Мы рекомендуем устанавливать агент из репозитория дистрибутива. Мы **не рекомендуем** устанавливать агент виртуальной машины Linux непосредственно из Github.  |
| Обновление агента виртуальной машины |Обновление агента виртуальной машины — это простая процедура, схожая с переустановкой [двоичных файлов агента виртуальной машины](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409). <br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции резервного копирования. |Следуйте указаниям по [обновлению агента виртуальной машины Linux ](../virtual-machines/linux/update-agent.md?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json). Мы рекомендуем обновлять агент из репозитория дистрибутива. Мы **не рекомендуем** обновлять агент виртуальной машины Linux непосредственно из Github.<br>Необходимо убедиться, что во время обновления агента виртуальной машины не выполняются операции резервного копирования. |
| Проверка установки агента VM |<li>На виртуальной машине Azure перейдите в папку *C:\WindowsAzure\Packages*. <li>В ней должен находиться файл WaAppAgent.exe.<li> Щелкните правой кнопкой мыши этот файл, выберите пункт **Свойства** и перейдите на вкладку **Подробно**. В поле "Версия продукта" должно отображаться значение 2.6.1198.718 или выше. |Недоступно |

### <a name="backup-extension"></a>Расширение резервного копирования
Когда агент будет установлен на виртуальной машине, служба архивации Azure установит для агента модуль резервного копирования. Служба архивации Azure легко обновляет и применяет исправления к расширению архивации.

Модуль резервного копирования устанавливается службой архивации независимо от того, запущена ли виртуальная машина. На запущенной виртуальной машине проще получить точку восстановления, согласованную с приложениями. При этом служба архивации Azure продолжает архивацию виртуальной машины, даже если она выключена, и нельзя установить расширение. (автономная виртуальная машина). В этом случае точка восстановления будет *отказоустойчивой*.

## <a name="network-connectivity"></a>Сетевое подключение
Чтобы управлять моментальными снимками виртуальной машины, для расширения архивации требуется подключение к общедоступным IP-адресам Azure. Без правильного подключения к Интернету время ожидания HTTP-запросов от виртуальной машины истекает, а архивация завершается сбоем. Если для развертывания установлены ограничения доступа на месте, например, через группу безопасности сети (NSG), выберите один из следующих вариантов, чтобы открыть путь для трафика архивации:

* [Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений](http://www.microsoft.com/en-us/download/details.aspx?id=41653). В статье вы найдете указания по добавлению IP-адресов в список разрешений.
* Разверните прокси-сервер HTTP для маршрутизации трафика.

Решая, какой вариант использовать, обратите внимание на соотношение управляемости, детального управления и затрат.

| Параметр | Преимущества | Недостатки |
| --- | --- | --- |
| Разрешенные диапазоны IP-адресов |Нет дополнительных затрат.<br><br>Нет дополнительных затрат. Открыть доступ в NSG можно с помощью командлета <i>Set-AzureNetworkSecurityRule</i>. |Сложность управления, так как задействованные диапазоны IP-адресов со временем меняются.<br><br>Доступ ко всей службе Azure, а не только к хранилищу. |
| Прокси-сервер HTTP |Точное управление разрешенными URL-адресами хранилища в прокси-сервере.<br>Единая точка доступа к виртуальным машинам через Интернет.<br>Не подвергается влиянию изменений IP-адресов Azure. |Дополнительные затраты для работы виртуальной машины с программным обеспечением прокси-сервера. |

### <a name="whitelist-the-azure-datacenter-ip-ranges"></a>Добавьте диапазоны IP-адресов центра обработки данных Azure в список разрешений.
Чтобы добавить диапазоны IP-адресов центра обработки данных Azure в список разрешений, ознакомьтесь с дополнительными сведениями о диапазонах IP-адресов и указаниями на [веб-сайте Azure](http://www.microsoft.com/en-us/download/details.aspx?id=41653) .

### <a name="using-an-http-proxy-for-vm-backups"></a>Использование прокси-сервера HTTP для архивации виртуальных машин
Во время архивации виртуальных машин команды управления моментальными снимками отправляются из расширения архивации в службу хранилища Azure с помощью API HTTPS. Направьте трафик расширения архивации через прокси-сервер HTTP, потому что это единственный компонент, который настроен для общего доступа в Интернете.

> [!NOTE]
> Особых требований к программному обеспечению нет. Убедитесь, что прокси-сервер подходит для выполнения описанных ниже настроек.
>
>

На приведенном ниже изображении показан пример трех этапов настройки, которые необходимо выполнить, чтобы использовать прокси-сервер HTTP:

* Виртуальная машина приложения направляет весь HTTP-трафик для общего доступа в Интернете через виртуальную машину прокси-сервера.
* В виртуальной машине прокси-сервера разрешен входящий трафик от виртуальных машин в виртуальной сети.
* Для группы безопасности сети с именем NSF-lockdown требуется правило безопасности, которое разрешает передачу интернет-трафика из виртуальной машины прокси-сервера.

![Диаграмма развертывания NSG с прокси-сервером HTTP](./media/backup-azure-vms-prepare/nsg-with-http-proxy.png)

Чтобы использовать прокси-сервер HTTP для обмена данными для общего доступа в Интернете, выполните следующие действия.

#### <a name="step-1-configure-outgoing-network-connections"></a>Шаг 1. Настройка исходящих сетевых подключений
###### <a name="for-windows-machines"></a>Для компьютеров Windows
Следующая процедура позволяет настроить конфигурацию прокси-сервера для учетной записи Local System.

1. Скачайте программу [PsExec](https://technet.microsoft.com/sysinternals/bb897553)
2. Выполните следующую команду из командной строки с повышенными привилегиями:

     ```
     psexec -i -s "c:\Program Files\Internet Explorer\iexplore.exe"
     ```
     Откроется окно Internet Explorer.
3. Последовательно выберите "Сервис -> Свойства обозревателя -> Подключения -> Настройка сети".
4. Проверьте параметры прокси-сервера для системной учетной записи. Задайте IP-адрес прокси-сервера и порт.
5. Закройте Internet Explorer.

В результате для компьютера будет настроен прокси-сервер, который будет использоваться для любого исходящего трафика HTTP или HTTPS.

Если вы настроили прокси-сервер из текущей учетной записи пользователя, а не учетной записи Local System, используйте следующий сценарий для применения к SYSTEMACCOUNT:

```
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name DefaultConnectionSettings -Value $obj.DefaultConnectionSettings
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections" -Name SavedLegacySettings -Value $obj.SavedLegacySettings
   $obj = Get-ItemProperty -Path Registry::”HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name ProxyEnable -Value $obj.ProxyEnable
   Set-ItemProperty -Path Registry::”HKEY_USERS\S-1-5-18\Software\Microsoft\Windows\CurrentVersion\Internet Settings" -Name Proxyserver -Value $obj.Proxyserver
```

> [!NOTE]
> Если в журнале прокси-сервера отобразится сообщение "407 — Требуется проверка подлинности прокси", проверьте правильность настройки проверки подлинности.
>
>

###### <a name="for-linux-machines"></a>Для компьютеров Linux
Добавьте следующую строку в файл ```/etc/environment``` :

```
http_proxy=http://<proxy IP>:<proxy port>
```

Добавьте следующие строки в файл ```/etc/waagent.conf``` :

```
HttpProxy.Host=<proxy IP>
HttpProxy.Port=<proxy port>
```

#### <a name="step-2-allow-incoming-connections-on-the-proxy-server"></a>Шаг 2. Разрешение входящих подключений на прокси-сервере
1. Откройте брандмауэр Windows на прокси-сервере. Самый простой способ доступа к брандмауэру — это поиск брандмауэра Windows в режиме повышенной безопасности.

    ![Открытие брандмауэра](./media/backup-azure-vms-prepare/firewall-01.png)
2. В диалоговом окне брандмауэра Windows щелкните правой кнопкой мыши **Правила для входящих подключений** и выберите **Создать правило...**

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-02.png)
3. В **мастере создания правила для нового входящего подключения** выберите значение **Настраиваемое** для параметра **Тип правила** и нажмите кнопку **Далее**.
4. Чтобы выбрать **программу**, щелкните элемент **Все программы** и нажмите кнопку **Далее**.
5. На странице **Протокол и порты** введите следующие сведения и нажмите кнопку **Далее**.

    ![Создание нового правила](./media/backup-azure-vms-prepare/firewall-03.png)

   * Для параметра *Тип протокола* выберите *TCP*.
   * В поле *Локальный порт* выберите *Определенные порты*, а в поле под ним укажите уже настроенный порт ```<Proxy Port>```.
   * В поле *Удаленный порт* выберите *Все порты*.

     Выполните все инструкции мастера и укажите имя правила.

#### <a name="step-3-add-an-exception-rule-to-the-nsg"></a>Шаг 3. Добавление правила исключения к группе NSG
Введите следующую команду в командной строке Azure PowerShell:

Она добавляет исключение к группе NSG. Это исключение разрешает TCP-трафик из любого порта на сервере 10.0.0.5 на любой адрес в Интернете по порту 80 (HTTP) или 443 (HTTPS). Если вам необходимо разрешить общий доступ из Интернета к какому-либо порту, добавьте этот порт в параметр ```-DestinationPortRange```.

```
Get-AzureNetworkSecurityGroup -Name "NSG-lockdown" |
Set-AzureNetworkSecurityRule -Name "allow-proxy " -Action Allow -Protocol TCP -Type Outbound -Priority 200 -SourceAddressPrefix "10.0.0.5/32" -SourcePortRange "*" -DestinationAddressPrefix Internet -DestinationPortRange "80-443"
```


*Имена и значения на этих шагах указаны только для примера. Используйте имена и значения своего развертывания, вводя, вырезая или вставляя сведения в свой код.*

Теперь, когда есть подключение к сети, вы можете создать резервную копию виртуальной машины. См. сведения в статье [Резервное копирование виртуальных машин Azure в хранилище служб восстановления](backup-azure-arm-vms.md).

## <a name="questions"></a>Вопросы?
Если вы хотите задать вопрос или предложить добавить какие-либо функции, [отправьте нам свой отзыв](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>Дальнейшие действия
Следующий шаг после подготовки среды для резервного копирования виртуальной машины — это создание резервной копии. Более подробные сведения о резервном копировании виртуальных машин см. в статье по планированию.

* [Настройка виртуальных машин](backup-azure-vms.md)
* [Планирование инфраструктуры резервного копирования виртуальных машин в Azure](backup-azure-vms-introduction.md)
* [Управление резервными копиями виртуальной машины](backup-azure-manage-vms.md)

