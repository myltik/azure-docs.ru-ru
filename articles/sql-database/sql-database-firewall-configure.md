---
title: Правила брандмауэра базы данных SQL Azure | Документация Майкрософт
description: Узнайте, как настроить брандмауэр базы данных SQL с помощью правил брандмауэра уровня сервера и базы данных для управления доступом.
keywords: брандмауэр базы данных
services: sql-database
author: CarlRabeler
manager: craigg
ms.service: sql-database
ms.custom: security
ms.topic: conceptual
ms.date: 04/01/2018
ms.author: carlrab
ms.openlocfilehash: 1848fea8a21afc473873cb8c4a5ba87b09da02e2
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34646819"
---
# <a name="azure-sql-database-server-level-and-database-level-firewall-rules"></a>Правила брандмауэра уровня сервера и уровня базы данных SQL Azure 

База данных SQL Microsoft Azure предоставляет службу реляционных баз данных для Azure и других интернет-приложений. Чтобы защитить ваши данные, брандмауэр запрещает любой доступ к серверу базы данных, пока вы не укажете компьютеры, у которых есть разрешение на доступ. Брандмауэр предоставляет доступ к базам данным на основе исходного IP-адреса каждого запроса.

#### <a name="virtual-network-rules-as-alternatives-to-ip-rules"></a>Правила виртуальной сети как альтернатива правилам фильтрации IP-адресов

Помимо правил фильтрации IP-адресов брандмауэр также управляет *правилами виртуальной сети*. Правила виртуальной сети основаны на конечных точках службы виртуальной сети. В некоторых случаях предпочтительнее использовать правила виртуальной сети, а не правила фильтрации IP-адресов. Чтобы узнать больше, ознакомьтесь с разделом [Использование конечных точек службы и правил виртуальной сети для базы данных SQL Azure](sql-database-vnet-service-endpoint-rule-overview.md).

## <a name="overview"></a>Обзор

Первоначально весь доступ к серверу Azure SQL Server с использованием Transact-SQ блокируется брандмауэром. Чтобы использовать Azure SQL Server, сначала нужно указать одно или несколько правил брандмауэра уровня сервера, которые обеспечивают доступ к этому серверу. Используйте правила брандмауэра, чтобы определить разрешенные диапазоны IP-адресов из Интернета. Кроме того, нужно указать, разрешено ли приложениям Azure пытаться подключиться к серверу Azure SQL Server.

Чтобы выборочно предоставить доступ только к одной из баз данных на сервере Azure SQL Server, необходимо создать правило уровня базы данных для соответствующей базы данных. В правиле брандмауэра уровня базы данных укажите диапазон IP-адресов, выходящий за пределы диапазона, указанного в правиле брандмауэра уровня сервера, и убедитесь, что IP-адрес клиента попадает в диапазон, указанный в правиле уровня базы данных.

Запросы на подключение из Интернета и Azure должны сначала обрабатываться брандмауэром и только потом достигать сервера Azure SQL Server или базы данных SQL, как показано на следующей схеме.

   ![Схема, описывающая конфигурацию брандмауэра.][1]

* **Правила брандмауэра серверного уровня:** эти правила разрешают клиентам доступ ко всему серверу Azure SQL Server, то есть ко всем базам данных на одном логическом сервере. Эти правила хранятся в базе данных **master** . Правила брандмауэра серверного уровня можно настроить на портале или с помощью инструкций Transact-SQL. Для создания правил брандмауэра на уровне сервера с помощью портала Azure или PowerShell необходимо быть владельцем или участником подписки. Чтобы создать правило брандмауэра на уровне сервера с помощью Transact-SQL, необходимо подключиться к экземпляру базы данных SQL от имени участника уровня сервера или администратора Azure Active Directory (это означает, что правило брандмауэра на уровне сервера изначально должен создать пользователь с разрешениями на уровне Azure).
* **Правила брандмауэра уровня базы данных.** Эти правила разрешают клиентам доступ к определенным (защищенным) базам данных на одном логическом сервере. Вы можете создать такие правила для каждой базы данных (в том числе базы данных **master**), и они будут храниться в отдельных базах данных. Для создания правил брандмауэра уровня базы данных для базы данных master и пользовательской базы данных и управления этими правилами можно использовать только инструкции Transact-SQL и только после настройки первого правила брандмауэра уровня сервера. Если в правиле брандмауэра уровня базы данных указать диапазон IP-адресов, выходящий за пределы диапазона, указанного в правиле брандмауэра уровня сервера, доступ к базе данных смогут получить только те клиенты, которые имеют IP-адреса в диапазоне уровня базы данных. Для базы данных можно задать не более 128 правил брандмауэра уровня базы данных. Дополнительные сведения о настройке правил брандмауэра уровня базы данных см. в примере ниже и в статье [sp_set_database_firewall_rule (база данных SQL Azure)](https://msdn.microsoft.com/library/dn270010.aspx).

**Рекомендация.** Корпорация Майкрософт рекомендует по возможности всегда использовать правила брандмауэра на уровне базы данных, чтобы повысить уровень безопасности и портативность базы данных. Используйте правила брандмауэра серверного уровня для администраторов, если у вас много баз данных с одинаковыми требованиями к доступу и вы не хотите тратить время на настройку каждой базы данных по отдельности.

> [!Important]
> База данных SQL Windows Azure поддерживает не более 128 правил брандмауэра.
>

> [!Note]
> Сведения о портативных базах данных в контексте непрерывности бизнес-процессов см. в разделе [Требования к проверке подлинности для аварийного восстановления](sql-database-geo-replication-security-config.md).
>

### <a name="connecting-from-the-internet"></a>Подключение через Интернет

Когда компьютер пытается подключиться к серверу базы данных из Интернета, брандмауэр сначала проверяет исходный IP-адрес запроса относительно правил брандмауэра уровня базы данных для базы данных, к которой устанавливается подключение.

* Если IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня базы данных, подключение предоставляется к базе данных SQL, которая содержит правило.
* Если IP-адрес запроса не находится в одном из диапазонов, указанных в правиле брандмауэра уровня базы данных, проверяются правила брандмауэра уровня сервера. Если IP-адрес запроса находится в одном из диапазонов, указанных в правилах брандмауэра уровня сервера, подключение предоставляется. Правила брандмауэра уровня сервера применяются ко всем базам данных SQL на сервере SQL Azure.  
* Если IP-адрес запроса находится за пределами диапазонов, указанных в любом из правил брандмауэра уровня базы данных или уровня сервера, то запрос на подключение отклоняется.

> [!NOTE]
> Для доступа к базе данных SQL Azure с локального компьютера убедитесь, что брандмауэр сети и локального компьютера разрешает исходящие подключения по TCP-порту 1433.
> 

### <a name="connecting-from-azure"></a>Подключение из Azure
Чтобы приложения из Azure могли подключаться к серверу SQL Azure, необходимо разрешить подключения Azure. Когда приложение из Azure пытается подключиться к серверу базы данных, брандмауэр проверяет, разрешены ли подключения Azure. Параметр брандмауэра с начальным и конечным адресом, равным 0.0.0.0, указывает, что эти подключения разрешены. Если попытка подключения не разрешена, запрос не достигает сервера базы данных SQL Azure.

> [!IMPORTANT]
> Этот параметр позволяет настроить брандмауэр так, чтобы разрешить все подключения из Azure, включая подключения из подписок других клиентов. При выборе этого параметра убедитесь, что используемое имя для входа и разрешения пользователя предоставляют доступ только авторизованным пользователям.
> 

## <a name="creating-and-managing-firewall-rules"></a>Создание правил брандмауэра и управление ими
Первый параметр брандмауэра уровня сервера можно создать на [портале Azure](https://portal.azure.com/) или программным путем с помощью [Azure PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql), [Azure CLI](/cli/azure/sql/server/firewall-rule#az_sql_server_firewall_rule_create) или [REST API](https://docs.microsoft.com/rest/api/sql/firewallrules). Последующие правила брандмауэра уровня сервера можно создавать и контролировать с помощью этих методов и Transact-SQL. 

> [!IMPORTANT]
> Правила брандмауэра уровня базы данных можно создавать только с помощью Transact-SQL. То же самое касается и управления ими. 
>

Для повышения производительности правила брандмауэра на уровне сервера временно кэшируются на уровне базы данных. Сведения об обновлении кэша см. в статье [DBCC FLUSHAUTHCACHE (Transact-SQL)](https://msdn.microsoft.com/library/mt627793.aspx). 

> [!TIP]
> Чтобы провести аудит изменений брандмауэра уровня сервера и уровня базы данных, можно использовать [аудит базы данных SQL](sql-database-auditing.md).
>

## <a name="manage-firewall-rules-using-the-azure-portal"></a>Управление правилами брандмауэра с помощью портала Azure

Чтобы задать правило брандмауэра уровня сервера на портале Azure, перейдите на страницу обзора базы данных SQL Azure или логического сервера базы данных SQL Azure.

> [!TIP]
> Руководство см. в статье [Создание базы данных SQL Azure на портале Azure](sql-database-get-started-portal.md).
>

**На странице обзора базы данных**

1. Чтобы задать правило брандмауэра уровня сервера на странице обзора базы данных, щелкните **Настройка брандмауэра для сервера** на панели инструментов, как показано на рисунке ниже. После этого откроется страница **Параметры брандмауэра** для сервера базы данных SQL.

      ![правило брандмауэра для сервера](./media/sql-database-get-started-portal/server-firewall-rule.png) 

2. Щелкните **Добавить IP-адрес клиента** на панели инструментов, чтобы добавить IP-адрес используемого компьютера, а затем щелкните **Сохранить**. Для текущего IP-адреса будет создано правило брандмауэра уровня сервера.

      ![Настройка правила брандмауэра для сервера](./media/sql-database-get-started-portal/server-firewall-rule-set.png) 

**На странице обзора сервера**

После этого откроется страница обзора сервера, где будет указано полное имя сервера (например, **mynewserver20170403.database.windows.net**) и предоставлены параметры для дальнейшей настройки.

1. Чтобы настроить правило серверного уровня на странице обзора, в меню слева в разделе "Параметры" щелкните **Брандмауэр**: 

2. Щелкните **Добавить IP-адрес клиента** на панели инструментов, чтобы добавить IP-адрес используемого компьютера, а затем щелкните **Сохранить**. Для текущего IP-адреса будет создано правило брандмауэра уровня сервера.

## <a name="manage-firewall-rules-using-transact-sql"></a>Управление правилами брандмауэра с помощью Transact-SQL
| Представление каталога или хранимая процедура | Уровень | ОПИСАНИЕ |
| --- | --- | --- |
| [sys.firewall_rules](https://msdn.microsoft.com/library/dn269980.aspx) |сервер; |Отображает текущие правила брандмауэра уровня сервера |
| [sp_set_firewall_rule](https://msdn.microsoft.com/library/dn270017.aspx) |сервер; |Создает или обновляет правила брандмауэра уровня сервера |
| [sp_delete_firewall_rule](https://msdn.microsoft.com/library/dn270024.aspx) |сервер; |Удаляет правила брандмауэра уровня сервера |
| [sys.database_firewall_rules](https://msdn.microsoft.com/library/dn269982.aspx) |База данных |Отображает текущие правила брандмауэра уровня базы данных |
| [sp_set_database_firewall_rule](https://msdn.microsoft.com/library/dn270010.aspx) |База данных |Создает или обновляет правила брандмауэра уровня базы данных |
| [sp_delete_database_firewall_rule](https://msdn.microsoft.com/library/dn270030.aspx) |Базы данных |Удаляет правила брандмауэра на уровне базы данных |


Чтобы просмотреть имеющиеся правила, включить диапазон IP-адресов на сервере Contoso и удалить правило брандмауэра, используйте следующий пример:
   
```sql
SELECT * FROM sys.firewall_rules ORDER BY name;
```
  
Добавьте правило брандмауэра.
   
```sql
EXECUTE sp_set_firewall_rule @name = N'ContosoFirewallRule',
   @start_ip_address = '192.168.1.1', @end_ip_address = '192.168.1.10'
```

Для удаления правил брандмауэра на уровне сервера выполните хранимую процедуру sp_delete_firewall_rule. Приведенный ниже пример удаляет правило с именем ContosoFirewallRule.
   
```sql
EXECUTE sp_delete_firewall_rule @name = N'ContosoFirewallRule'
```   

## <a name="manage-firewall-rules-using-azure-powershell"></a>Управление правилами брандмауэра с помощью Azure PowerShell
| Командлет | Уровень | ОПИСАНИЕ |
| --- | --- | --- |
| [Get-AzureRmSqlServerFirewallRule](/powershell/module/azurerm.sql/get-azurermsqlserverfirewallrule) |сервер; |Возвращает текущие правила брандмауэра уровня сервера |
| [New-AzureRmSqlServerFirewallRule](/powershell/module/azurerm.sql/new-azurermsqlserverfirewallrule) |сервер; |Создает новое правило брандмауэра уровня сервера |
| [Set-AzureRmSqlServerFirewallRule](/powershell/module/azurerm.sql/set-azurermsqlserverfirewallrule) |сервер; |Обновляет свойства существующего правила брандмауэра уровня сервера |
| [Remove-AzureRmSqlServerFirewallRule](/powershell/module/azurerm.sql/remove-azurermsqlserverfirewallrule) |сервер; |Удаляет правила брандмауэра уровня сервера |


Приведенный ниже пример настраивает правило брандмауэра уровня сервера с помощью PowerShell.

```powershell
New-AzureRmSqlServerFirewallRule -ResourceGroupName "myResourceGroup" `
    -ServerName $servername `
    -FirewallRuleName "AllowSome" -StartIpAddress "0.0.0.0" -EndIpAddress "0.0.0.0"
```

> [!TIP]
> Примеры быстрого запуска PowerShell см. в статье [Создание отдельной базы данных SQL Azure с помощью PowerShell](sql-database-get-started-powershell.md) и [Создание отдельной базы данных SQL и настройка правила брандмауэра с помощью PowerShell](scripts/sql-database-create-and-configure-database-powershell.md).
>

## <a name="manage-firewall-rules-using-azure-cli"></a>Управление правилами брандмауэра с помощью Azure CLI
| Командлет | Уровень | ОПИСАНИЕ |
| --- | --- | --- |
|[az sql server firewall-rule create](/cli/azure/sql/server/firewall-rule#az_sql_server_firewall_rule_create)|сервер;|Создает правило брандмауэра для сервера.|
|[az sql server firewall-rule list](/cli/azure/sql/server/firewall-rule#az_sql_server_firewall_rule_list)|сервер;|Выводит список правил брандмауэра на сервере.|
|[az sql server firewall-rule show](/cli/azure/sql/server/firewall-rule#az_sql_server_firewall_rule_show)|сервер;|Отображает сведения о правиле брандмауэра.|
|[az sql server firewall-rule update](/cli/azure/sql/server/firewall-rule##az_sql_server_firewall_rule_update)|сервер;|Обновляет правило брандмауэра.|
|[az sql server firewall-rule delete](/cli/azure/sql/server/firewall-rule#az_sql_server_firewall_rule_delete)|сервер;|Удаляет правило брандмауэра.|

Приведенный ниже пример задает правило брандмауэра уровня сервера с помощью Azure CLI. 

```azurecli-interactive
az sql server firewall-rule create --resource-group myResourceGroup --server $servername \
    -n AllowYourIp --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0
```

> [!TIP]
> Примеры быстрого запуска Azure CLI см. в статье [Создание отдельной базы данных SQL Azure с помощью Azure CLI](sql-database-get-started-cli.md) и [Создание отдельной базы данных SQL и настройка правила брандмауэра с помощью Azure CLI](scripts/sql-database-create-and-configure-database-cli.md).
>

## <a name="manage-firewall-rules-using-rest-api"></a>Управление правилами брандмауэра с помощью REST API
| API | Уровень | ОПИСАНИЕ |
| --- | --- | --- |
| [Вывод списка правил брандмауэра](https://docs.microsoft.com/rest/api/sql/FirewallRules/ListByServer) |сервер; |Отображает текущие правила брандмауэра уровня сервера |
| [Создание и изменение правила брандмауэра](https://docs.microsoft.com/rest/api/sql/FirewallRules/CreateOrUpdate) |сервер; |Создает или обновляет правила брандмауэра уровня сервера |
| [Удаление правила брандмауэра](https://docs.microsoft.com/rest/api/sql/FirewallRules/Delete) |сервер; |Удаляет правила брандмауэра уровня сервера |

## <a name="server-level-firewall-rule-versus-a-database-level-firewall-rule"></a>Сравнение правила брандмауэра уровня сервера и правила брандмауэра уровня базы данных
В. Необходимо ли полностью изолировать пользователей одной базы данных от пользователей другой базы данных ?   
  Если да, то предоставьте доступ с помощью правил брандмауэра уровня базы данных. Это позволяет избежать использования правил брандмауэра уровня сервера, которые предоставляют доступ через брандмауэр ко всем базам данных, уменьшая тем самым глубину защиты.   
 
В. Необходим ли пользователям с IP-адреса доступ ко всем базам данных?   
  Используйте правила брандмауэра уровня сервера, чтобы сократить количество раз, когда необходимо настраивать правила брандмауэра.   

В. Пользователь или группа пользователей, которые настраивают правила брандмауэра, имеют доступ только через портал Azure, PowerShell или REST API?   
  Необходимо использовать правила брандмауэра уровня сервера. Правила брандмауэра уровня базы данных можно настроить только с помощью Transact-SQL.  

В. Запрещено ли пользователю или группе пользователей, которые настраивают правила брандмауэра, иметь разрешения высокого уровня на уровне базы данных?   
  Используйте правила брандмауэра уровня сервера. Для настройки правил брандмауэра уровня базы данных с помощью Transact-SQL требуется разрешение на уровне базы данных не ниже `CONTROL DATABASE`.  

В. Осуществляют ли пользователь или группа пользователей, которые настраивают правила брандмауэра или выполняют аудит этих правил, централизованное управление правилами брандмауэра для множества (возможно, сотен) баз данных?   
  Это зависит от ваших потребностей и среды. Правила брандмауэра уровня сервера проще настроить, но сценарии позволяют настроить правила уровня базы данных. И даже если вы используете правила брандмауэра уровня сервера, вам может потребоваться провести аудит правил уровня базы данных, чтобы выяснить, создали ли пользователи с разрешением `CONTROL` для базы данных правила брандмауэра уровня базы данных.   

В. Можно ли одновременно использовать правила брандмауэра уровня сервера и уровня базы данных?   
  Да. Некоторым пользователям, например администраторам, требуются правила брандмауэра уровня сервера. А другим пользователям, например пользователям приложения базы данных, необходимы правила брандмауэра уровня базы данных.   

## <a name="troubleshooting-the-database-firewall"></a>Устранение неполадок брандмауэра базы данных
Если доступ к службе базы данных SQL Microsoft Azure не работает должным образом, необходимо учитывать следующее.

* **Конфигурация локального брандмауэра.** Прежде чем компьютер сможет получить доступ к Базе данных SQL Azure, может потребоваться создать исключение брандмауэра на компьютере для TCP-порта 1433. Вам может потребоваться открыть дополнительные порты при создании подключений в пределах облака Azure. Дополнительные сведения см. в разделе **Снаружи или внутри** статьи [Порты для ADO.NET 4.5, отличные от порта 1433](sql-database-develop-direct-route-ports-adonet-v12.md).
* **Преобразование сетевых адресов (NAT):** из-за применения NAT IP-адрес, используемый компьютером для подключения к Базе данных SQL Azure, может отличаться от IP-адреса, показанного в параметрах конфигурации IP-адреса компьютера. Чтобы просмотреть IP-адрес, используемый компьютером для подключения к Azure, войдите на портал и откройте вкладку **Настройка** для сервера, где размещена база данных. В разделе **Разрешенные IP-адреса** отображается **текущий IP-адрес клиента**. Щелкните **Добавить** в разделе **Разрешенные IP-адреса**, чтобы разрешить компьютеру доступ к серверу.
* **Изменения в списке разрешенных адресов еще не вступили в силу:** до вступления в силу изменений конфигурации брандмауэра Базы данных SQL Azure может присутствовать задержка до пяти минут.
* **Имя для входа не авторизовано, или использован неправильный пароль.** Если имя для входа не имеет разрешений на сервере Базы данных SQL Azure или введен неправильный пароль, то подключение к серверу Базы данных SQL Azure отклоняется. Создание параметра брандмауэра только предоставляет клиентам возможность подключения к серверу. Каждый клиент должен предоставить необходимые учетные данные безопасности. Дополнительные сведения о подготовке имен входа см. в разделе [Управление базами данных, именами входа и пользователями в базе данных SQL Azure](sql-database-manage-logins.md).
* **Динамический IP-адрес:** при наличии подключения к Интернету с динамическим предоставлением IP-адресов и возникновении проблем с прохождением через брандмауэр попробуйте одно из описанных ниже решений.
  
  * Попросите поставщика услуг Интернета (ISP) назначить диапазон IP-адресов тем клиентским компьютерам, с которых осуществляется доступ к серверу Базы данных SQL Azure, а затем добавьте диапазон IP-адресов в качестве правила брандмауэра.
  * Получите статические IP-адреса для клиентских компьютеров, а затем добавьте IP-адреса как правила брандмауэра.

## <a name="next-steps"></a>Дополнительная информация

- Чтобы быстро приступить к созданию правила брандмауэра уровня сервера и уровня базы данных, ознакомьтесь со статьей [Создание базы данных SQL Azure на портале Azure](sql-database-get-started-portal.md).
- Дополнительные сведения о подключении к базе данных SQL Azure из приложений с открытым кодом или приложений сторонних производителей см. в статье [Библиотеки подключений для базы данных SQL и SQL Server](https://msdn.microsoft.com/library/azure/ee336282.aspx).
- Дополнительные сведения о портах, которые, возможно, потребуется открыть, см. в разделе **Снаружи или внутри** статьи [Порты для ADO.NET 4.5, отличные от порта 1433](sql-database-develop-direct-route-ports-adonet-v12.md).
- Общие сведения о методах защиты в базе данных SQL Azure см. в [этой статье](sql-database-security-overview.md).

<!--Image references-->
[1]: ./media/sql-database-firewall-configure/sqldb-firewall-1.png
