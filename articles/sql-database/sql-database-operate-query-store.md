---
title: Управление хранилищем запросов в базе данных SQL Azure
description: Узнайте, как управлять хранилищем запросов в базе данных SQL Azure
services: sql-database
author: bonova
manager: craigg
ms.service: sql-database
ms.custom: monitor & tune
ms.topic: article
ms.date: 04/01/2018
ms.author: bonova
ms.openlocfilehash: 4722399525b376e232f2bc7802a570836da79e29
ms.sourcegitcommit: 3a4ebcb58192f5bf7969482393090cb356294399
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="operating-the-query-store-in-azure-sql-database"></a>Управление хранилищем запросов в базе данных SQL Azure
Хранилище запросов в Azure является полностью управляемой службой базы данных, которая непрерывно собирает и предоставляет подробные статистические сведения обо всех запросах. Хранилище запросов можно рассматривать как аналог бортового самописца, который значительно упрощает устранение проблем, отражающихся на производительности запросов, для клиентов в облаке и в локальной среде. В этой статье объясняются некоторые аспекты управления хранилищем запросов в Azure. С помощью предварительно собранных данных о запросах можно быстро диагностировать и устранять проблемы с производительностью, что позволяет уделять больше времени основным рабочим задачам. 

Хранилище запросов [глобально доступно](https://azure.microsoft.com/updates/general-availability-azure-sql-database-query-store/) в базе данных SQL Azure с ноября 2015 г. Хранилище запросов является основой для анализа производительности и настройки компонентов, таких как [помощник по настройке базы данных SQL и панель мониторинга производительности](https://azure.microsoft.com/updates/sqldatabaseadvisorga/). На момент публикации этой статьи хранилище запросов работает в более чем 200 000 пользовательских баз данных в Azure, безостановочно собирая информацию о запросах за несколько месяцев.

> [!IMPORTANT]
> Корпорация Майкрософт работает над тем, чтобы хранилище запросов стало доступно для всех баз данных SQL Azure (как существующих, так и новых). 
> 
> 

## <a name="optimal-query-store-configuration"></a>Оптимальная конфигурация хранилища запросов
В этом разделе описываются оптимальные настройки по умолчанию, призванные обеспечить надежную работу хранилища запросов и зависимых компонентов, таких как [помощник по базам данных SQL Azure и панель мониторинга производительности](https://azure.microsoft.com/updates/sqldatabaseadvisorga/). По умолчанию конфигурация оптимизирована для постоянного сбора данных, т. е. для минимальной продолжительности состояний "Отключено" и "Только для чтения".

| Параметр Configuration | ОПИСАНИЕ | значение по умолчанию | Комментарий |
| --- | --- | --- | --- |
| MAX_STORAGE_SIZE_MB |Предельный размер пространства данных, которое хранилище запросов использует в базе данных клиента |100 |Принудительно для новых баз данных |
| INTERVAL_LENGTH_MINUTES |Определяет время, в течение которого объединяются и сохраняются собранные статистические данные среды выполнения по планам запросов. Для каждого активного плана запроса в течение периода, заданного в этом параметре, будет сохраняться только одна строка. |60 |Принудительно для новых баз данных |
| STALE_QUERY_THRESHOLD_DAYS |Политика очистки на основе времени, которая контролирует срок хранения статистики для среды выполнения и неактивных запросов. |30 |Принудительно для новых баз данных и баз данных с предыдущим значением по умолчанию (367) |
| SIZE_BASED_CLEANUP_MODE |Указывает, нужно ли выполнять автоматическую очистку данных при приближении к предельному значению, установленному для размера данных хранилища запросов. |AUTO (АВТОМАТИЧЕСКИ) |Принудительно для всех баз данных |
| QUERY_CAPTURE_MODE |Указывает, следует ли отслеживать все запросы или только определенное подмножество. |AUTO (АВТОМАТИЧЕСКИ) |Принудительно для всех баз данных |
| FLUSH_INTERVAL_SECONDS |Указывает максимальный период, в течение которого статистика среды выполнения будет храниться в памяти перед записью на диск. |900 |Принудительно для новых баз данных |
|  | | | |

> [!IMPORTANT]
> Эти значения по умолчанию будут автоматически применяться на последнем этапе активации хранилища запросов для всех баз данных Azure SQL (см. важное примечание выше). После этого база данных SQL Azure не будет изменять значения настроек, заданные пользователями, за исключением случаев негативного влияния на основную рабочую нагрузку или на надежность работы хранилища запросов.
> 
> 

Если вы хотите сохранить свои пользовательские настройки, используйте [параметры ALTER DATABASE для хранилища запросов](https://msdn.microsoft.com/library/bb522682.aspx) , чтобы восстановить предыдущее состояние конфигурации. Изучите [рекомендации по использованию хранилища запросов](https://msdn.microsoft.com/library/mt604821.aspx) , чтобы научиться правильно выбирать оптимальные параметры конфигурации.

## <a name="next-steps"></a>Дополнительная информация
[Анализ производительности базы данных SQL](sql-database-performance.md)

## <a name="additional-resources"></a>Дополнительные ресурсы
Дополнительные сведения вы найдете в следующих статьях.

* [Query Store: A flight data recorder for your database (Хранилище запросов: "бортовой самописец" для вашей базы данных)](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database) 
* [Мониторинг производительности с использованием хранилища запросов](https://msdn.microsoft.com/library/dn817826.aspx)
* [Query Store Usage Scenarios (Сценарии использования хранилища запросов)](https://msdn.microsoft.com/library/mt614796.aspx)
* [Мониторинг производительности с использованием хранилища запросов](https://msdn.microsoft.com/library/dn817826.aspx) 

