---
title: Защита базы данных SQL Azure | Документация Майкрософт
description: Узнайте о методах и функциях, используемых для защиты Базы данных SQL Azure.
services: sql-database
author: DRediske
manager: craigg
ms.service: sql-database
ms.custom: mvc,security
ms.topic: tutorial
ms.date: 04/24/2018
ms.author: daredis
ms.openlocfilehash: 54ec3c1386d6ce2023106367a6af1915e754948f
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32193467"
---
# <a name="secure-your-azure-sql-database"></a>Защита базы данных SQL Azure

Защита Базы данных SQL включает: 
- Ограничение доступа к базе данных с помощью правил брандмауэра. 
- Использование механизмов аутентификации, требующих учетных данных.
- Авторизация для использования данных на основе разрешений и членства с учетом ролей. 
- Безопасность на уровне строк
- Динамическое маскирование данных

База данных SQL также включает расширенные функции мониторинга, аудита и обнаружения угроз. 

Выполнив всего несколько простых действий, можно значительно повысить уровень защиты базы данных от пользователей-злоумышленников или несанкционированного доступа. Из этого руководства вы узнаете, как выполнять такие задачи. 

> [!div class="checklist"]
> * Настройка правил брандмауэра уровня сервера для сервера на портале Azure.
> * Создание правил брандмауэра на уровне базы данных для базы данных с помощью SSMS.
> * Подключение к базе данных с помощью безопасной строки подключения.
> * Управление доступом пользователей.
> * Защита данных с помощью шифрования
> * Включение аудита базы данных SQL
> * Включение обнаружения угроз базы данных SQL

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/), прежде чем начинать работу.

## <a name="prerequisites"></a>предварительным требованиям

Для работы с этим руководством вам потребуется следующее.

- Установите последнюю версию [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms) (SSMS). 
- Установите Microsoft Excel.
- Создайте сервер и базу данных SQL Azure. Для этого ознакомьтесь с разделами [Создание базы данных SQL Azure на портале Azure](sql-database-get-started-portal.md), [Создание отдельной базы данных SQL Azure с помощью Azure CLI](sql-database-get-started-cli.md) и [Создание отдельной базы данных SQL Azure с помощью PowerShell](sql-database-get-started-powershell.md). 

## <a name="log-in-to-the-azure-portal"></a>Войдите на портал Azure.

Войдите на [портал Azure](https://portal.azure.com/).

## <a name="create-a-server-level-firewall-rule-in-the-azure-portal"></a>Создание правила брандмауэра на уровне сервера с помощью портала Azure

Базы данных SQL защищены брандмауэром в Azure. По умолчанию все подключения к серверу и базам данных на сервере отклоняются, за исключением подключений служб Azure. Дополнительные сведения см. в разделе [Правила брандмауэра уровня сервера и уровня базы данных SQL Azure](sql-database-firewall-configure.md).

Чтобы обеспечить наибольшую безопасность, для параметра "Разрешить доступ к службам Azure" следует установить значение "Выключено". Если необходимо подключаться к базе данных из виртуальной машины Azure или облачной службы, необходимо создать [зарезервированный IP-адрес](../virtual-network/virtual-networks-reserved-public-ip.md) и разрешить доступ через брандмауэр только с этого зарезервированного IP-адреса. 

Выполните приведенные ниже действия, чтобы создать для сервера [правило брандмауэра уровня сервера базы данных SQL](sql-database-firewall-configure.md), разрешающее подключения с определенного IP-адреса. 

> [!NOTE]
> Если вы создали пример базы данных в Azure с помощью одного из предыдущих руководств или кратких руководств и выполняете инструкции данного руководства на компьютере с тем же IP-адресом, что и при выполнении тех руководств, то этот шаг можно пропустить, так как правило брандмауэра уровня сервера уже создано.
>

1. Щелкните **Базы данных SQL** в левом меню, затем на странице **Базы данных SQL** щелкните базу данных, для которой вы хотите настроить правило брандмауэра. После этого откроется страница обзора базы данных, где будет указано полное имя сервера (например, **mynewserver-20170313.database.windows.net**) и предоставлены параметры для дальнейшей настройки.

      ![правило брандмауэра для сервера](./media/sql-database-security-tutorial/server-firewall-rule.png) 

2. Щелкните **Настройка брандмауэра для сервера** на панели инструментов, как показано на предыдущем рисунке. Откроется страница **параметров брандмауэра** для сервера базы данных SQL. 

3. Щелкните **Добавить IP-адрес клиента** на панели инструментов, чтобы добавить общедоступный IP-адрес компьютера, подключающегося к порталу, или вручную введите правило брандмауэра. Нажмите кнопку **Сохранить**.

      ![Настройка правила брандмауэра для сервера](./media/sql-database-security-tutorial/server-firewall-rule-set.png) 

4. Нажмите кнопку **ОК**, а затем щелкните **X**, чтобы закрыть страницу **Параметры брандмауэра**.

Теперь можно подключиться к любой базе данных на сервере с указанным IP-адресом или диапазоном IP-адресов.

> [!NOTE]
> База данных SQL обменивается данными через порт 1433. Если вы пытаетесь подключиться из корпоративной сети, исходящий трафик через порт 1433 может быть запрещен сетевым брандмауэром. В таком случае вы не сможете подключиться к серверу базы данных SQL Azure. Для этого ваш ИТ-отдел должен открыть порт 1433.
>

## <a name="create-a-database-level-firewall-rule-using-ssms"></a>Создание правила брандмауэра уровня базы данных с помощью SSMS

Правила брандмауэра уровня базы данных позволяют создавать отличающиеся параметры брандмауэра для разных баз данных на одном логическом сервере, а также создавать переносимые правила брандмауэра, то есть правила, которые следуют за базой данных во время [отработки отказа](sql-database-geo-replication-overview.md), а не хранятся на сервере SQL Server. Правила брандмауэра уровня базы данных можно настроить только с помощью инструкций Transact-SQL и только после настройки первого правила брандмауэра уровня сервера. Дополнительные сведения см. в разделе [Правила брандмауэра уровня сервера и уровня базы данных SQL Azure](sql-database-firewall-configure.md).

Ниже приведены инструкции по созданию правила брандмауэра для конкретной базы данных.

1. Подключитесь к базе данных, например с помощью [SQL Server Management Studio](./sql-database-connect-query-ssms.md).

2. В обозревателе объектов щелкните правой кнопкой мыши базу данных, для которой нужно добавить правило брандмауэра, и щелкните **Создать запрос**. Откроется пустое окно запроса, подключенное к базе данных.

3. В окне запроса измените IP-адрес на свой общедоступный IP-адрес, затем выполните приведенный ниже запрос.

    ```sql
    EXECUTE sp_set_database_firewall_rule N'Example DB Rule','0.0.0.4','0.0.0.4';
    ```

4. На панели инструментов щелкните **Выполнить**, чтобы создать правило брандмауэра.

## <a name="view-how-to-connect-an-application-to-your-database-using-a-secure-connection-string"></a>Просмотр подключения приложения к базе данных с помощью безопасной строки подключения

Чтобы обеспечить защищенное зашифрованное подключение между клиентским приложением и базой данных SQL, строка подключения должна быть настроена таким образом, чтобы:

- запрашивалось зашифрованное подключение и
- сертификат сервера не считался доверенным. 

В этом случае устанавливается подключение по протоколу TLS и уменьшается риск атак "злоумышленник в середине". Правильно настроенные строки подключения к базе данных SQL для поддерживаемых драйверов клиента можно получить на портале Azure, как показано для ADO.NET на приведенном снимке экрана. Чтобы получить сведения о протоколе TLS и проверить возможность подключения, просмотрите [рекомендации по использованию протокола TLS](sql-database-connect-query.md#tls-considerations-for-sql-database-connectivity).

1. В меню слева выберите **Базы данных SQL** и на странице **Базы данных SQL** щелкните имя своей базы данных.

2. На странице **Обзор** для базы данных щелкните **Показать строки подключения к базам данных**.

3. Просмотрите полную строку подключения **ADO.NET**.

    ![Строка подключения по протоколу ADO.NET](./media/sql-database-security-tutorial/adonet-connection-string.png)

## <a name="creating-database-users"></a>Создание пользователей базы данных

Прежде чем создавать пользователей, необходимо выбрать один из двух типов аутентификации, поддерживаемых базой данных SQL Azure: 

**Аутентификация SQL**: для имен для входа и пользователей используются имя пользователя и пароль, действительные только в контексте конкретной базы данных на логическом сервере. 

**Аутентификация Azure Active Directory**: используются удостоверения, управляемые Azure Active Directory. 

Если вы хотите использовать [Azure Active Directory](./sql-database-aad-authentication.md) для аутентификации базы данных SQL, должен существовать предварительно заполненный каталог Azure Active Directory.

Выполните следующее, чтобы создать пользователя, использующего аутентификацию SQL.

1. Подключитесь к базе данных, например с помощью [SQL Server Management Studio](./sql-database-connect-query-ssms.md), с использованием учетных данных администратора сервера.

2. В обозревателе объектов щелкните правой кнопкой мыши базу данных, для которой нужно добавить нового пользователя, и щелкните **Создать запрос**. Откроется пустое окно запроса, связанное с выбранной базой данных.

3. В окне запроса введите следующее:

    ```sql
    CREATE USER ApplicationUser WITH PASSWORD = 'YourStrongPassword1';
    ```

4. На панели инструментов щелкните **Выполнить**, чтобы создать пользователя.

5. По умолчанию пользователь может подключаться к базе данных, но не имеет разрешений на чтение и запись данных. Чтобы предоставить эти разрешения только что созданному пользователю, выполните следующие две команды в новом окне запроса.

    ```sql
    ALTER ROLE db_datareader ADD MEMBER ApplicationUser;
    ALTER ROLE db_datawriter ADD MEMBER ApplicationUser;
    ```

Рекомендуется создавать эти учетные записи без прав администратора на уровне базы данных для подключения к базе данных, если только не требуется выполнять задачи администрирования, например создавать пользователей. Ознакомьтесь с [руководством по Azure Active Directory](./sql-database-aad-authentication-configure.md), посвященном аутентификации с помощью Azure Active Directory.


## <a name="protect-your-data-with-encryption"></a>Защита данных с помощью шифрования

Прозрачное шифрование данных базы данных SQL Azure (TDE) позволяет автоматически шифровать неактивные данные, не внося каких-либо изменений в приложение, обращающееся к зашифрованной базе данных. Для новых баз данных прозрачное шифрование данных включено по умолчанию. Чтобы включить прозрачное шифрование данных для базы данных или убедиться, что оно включено, выполните следующее.

1. В меню слева выберите **Базы данных SQL** и на странице **Базы данных SQL** щелкните имя своей базы данных. 

2. Щелкните **Прозрачное шифрование данных**, чтобы открыть страницу настройки TDE.

    ![Прозрачное шифрование данных](./media/sql-database-security-tutorial/transparent-data-encryption-enabled.png)

3. Если требуется, для параметра **Шифрование данных** задайте значение "Вкл." и нажмите кнопку **Сохранить**.

Начнется процесс шифрования в фоновом режиме. Можно отслеживать ход выполнения, подключившись к базе данных SQL с помощью [SQL Server Management Studio](./sql-database-connect-query-ssms.md) и запросив столбец encryption_state в представлении [sys.dm_database_encryption_keys](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-database-encryption-keys-transact-sql?view=sql-server-2017). Состояние 3 указывает, что база данных зашифрована. 

## <a name="enable-sql-database-auditing-if-necessary"></a>Включение аудита базы данных SQL (при необходимости)

Аудит базы данных SQL Azure позволяет отслеживать события базы данных и записывать их в журнал аудита в учетной записи хранения Azure. Аудит может помочь вам соблюсти требования нормативов, проанализировать работу с базой данных и получить представление о расхождениях и аномалиях, которые могут указывать на предполагаемые нарушения безопасности. Чтобы создать политику аудита по умолчанию для базы данных SQL, сделайте следующее:

1. В меню слева выберите **Базы данных SQL** и на странице **Базы данных SQL** щелкните имя своей базы данных. 

2. В колонке "Параметры" выберите **Аудит и обнаружение угроз**. Обратите внимание на то, что аудит уровня сервера отключен и в колонке имеется ссылка **Просмотр настроек аудита сервера**, позволяющая просмотреть или изменить настройки аудита сервера в данном контексте.

    ![Колонка "Аудит"](./media/sql-database-security-tutorial/auditing-get-started-settings.png)

3. Если вы хотите включить тип аудита (или расположение), отличный от указанного на уровне сервера, **включите** аудит и выберите тип аудита **BLOB-объект**. Если включен аудит больших двоичных объектов сервера, настроенный аудит для базы данных будет существовать параллельно с ним.

    ![Включение аудита](./media/sql-database-security-tutorial/auditing-get-started-turn-on.png)

4. Выберите **Сведения о хранилище** , чтобы открыть колонку хранилища журналов аудита. Выберите учетную запись хранения Azure, в которой будут сохраняться журналы, и срок хранения, по истечении которого старые журналы будут удалены. Затем нажмите кнопку **ОК** внизу. 

   > [!TIP]
   > Для того чтобы в полной мере воспользоваться возможностями шаблонов отчетов об аудите, используйте одну и ту же учетную запись хранения для всех баз данных.
   > 

5. Выберите команду **Сохранить**.

> [!IMPORTANT]
> Если вы хотите настроить события аудита, это можно сделать с помощью PowerShell или REST API. Дополнительные сведения см. в статье [Приступая к работе с аудитом базы данных SQL](sql-database-auditing.md).
>

## <a name="enable-sql-database-threat-detection"></a>Включение обнаружения угроз базы данных SQL

Благодаря оповещениям безопасности о подозрительной активности система обнаружения угроз формирует дополнительный уровень безопасности, позволяющий клиентам обнаруживать потенциальные угрозы по мере возникновения и реагировать на них. Пользователи могут анализировать подозрительные события с помощью аудита базы данных SQL, который позволяет определить причину таких событий (попытка получить доступ к данным в базе данных, нарушить безопасность или использовать их уязвимость). Система обнаружения угроз упрощает устранение потенциальных угроз безопасности базы данных, не требуя наличия у пользователя экспертных навыков в сфере безопасности либо умения работать в сложных системах отслеживания угроз.
Например, система обнаружения угроз обнаруживает определенную подозрительную активность в базе данных, указывающую на потенциальные попытки внедрения кода SQL. Внедрение кода SQL — один из распространенных видов угроз безопасности веб-приложений в Интернете, используемый для получения несанкционированного доступа к приложениям, управляемым данными. Взломщики используют уязвимые места приложения, чтобы ввести вредоносные инструкции SQL в поля ввода приложения, чтобы нарушить или изменить данные в базе данных.

1. Перейдите к колонке настройки базы данных SQL, которую требуется отслеживать. В колонке "Параметры" выберите **Аудит и обнаружение угроз**.

    ![Область навигации](./media/sql-database-security-tutorial/auditing-get-started-settings.png)
2. В колонке настроек **Аудит и обнаружение угроз** установите переключатель аудита в положение **Вкл.**, после чего отобразятся настройки обнаружения угроз.

3. Переведите переключатель обнаружения угроз в положение **Вкл.**

4. Настройте список электронных адресов, на которые будут приходить оповещения безопасности в случае обнаружения подозрительной активности в базе данных.

5. В колонке **Аудит и обнаружение угроз** щелкните **Сохранить**, чтобы сохранить новую или обновленную версию политики аудита и обнаружения угроз.

    ![Область навигации](./media/sql-database-security-tutorial/td-turn-on-threat-detection.png)

    При обнаружении подозрительных действий в базе данных вы получите уведомление по электронной почте. В электронном сообщении будет содержаться информация о подозрительном событии безопасности, включая характер подозрительной активности, имя базы данных и сервера, а также время, когда произошло событие. Кроме того, в сообщении приводится информация о возможных причинах возникновения события, а также рекомендуемые действия по поиску и устранению потенциальной угрозы безопасности базы данных. Ниже описывается, что делать, если вы получили приведенное ниже электронное сообщение.

    ![Электронное сообщение об обнаружении угроз](./media/sql-database-threat-detection-get-started/4_td_email.png)

6. В электронном сообщении щелкните ссылку **Журнал аудита SQL Azure**, после чего откроется портал Azure и будут показаны соответствующие записи аудита, зафиксированные примерно во время возникновения подозрительного события.

    ![Записи аудита](./media/sql-database-threat-detection-get-started/5_td_audit_records.png)

7. Щелкните записи аудита, чтобы просмотреть более подробную информацию о подозрительной активности в базе данных, включая инструкции SQL, причины ошибки и IP-адрес клиента.

    ![Сведения о записи](./media/sql-database-security-tutorial/6_td_audit_record_details.png)

8. В колонке записей аудита щелкните **Открыть в Excel**, чтобы открыть предварительно настроенный шаблон Excel и импортировать для более детального анализа записи из журнала аудита, зафиксированные примерно во время возникновения подозрительного события.

    > [!NOTE]
    > В Excel 2010 или более поздней версии требуется Power Query и параметр **Быстрое объединение**.

    ![Открытые записей в Excel](./media/sql-database-threat-detection-get-started/7_td_audit_records_open_excel.png)

9. Чтобы настроить параметр **Быстрое объединение**, на вкладке ленты **POWER QUERY** выберите **Параметры**, чтобы открыть диалоговое окно "Параметры". Щелкните раздел «Конфиденциальность» и выберите в нем второй вариант — «Игнорировать уровни конфиденциальности и по возможности повышать производительность»:

    ![Быстрое объединение в Excel](./media/sql-database-threat-detection-get-started/8_td_excel_fast_combine.png)

10. Чтобы загрузить записи журнала аудита SQL, убедитесь, что параметры на вкладке настроек установлены правильно, а затем откройте ленту «Данные» и нажмите кнопку «Обновить все».

    ![Параметры Excel](./media/sql-database-threat-detection-get-started/9_td_excel_parameters.png)

11. Результаты появятся на листе **Записи журнала аудита SQL** , что позволит выполнить более детальный анализ обнаруженной подозрительной активности, а также снизить степень влияния событий безопасности в приложении.


## <a name="next-steps"></a>Дополнительная информация
Из этого руководства вы узнаете, как быстро усилить защиту базы данных от действий пользователей-злоумышленников и несанкционированного доступа.  Вы научились выполнять следующие задачи: 

> [!div class="checklist"]
> * Настройка правил брандмауэра для сервера и (или) базы данных.
> * Подключение к базе данных с помощью безопасной строки подключения.
> * Управление доступом пользователей.
> * Защита данных с помощью шифрования
> * Включение аудита базы данных SQL
> * Включение обнаружения угроз базы данных SQL

Перейдите к следующему руководству, чтобы узнать, как реализовать географически распределенную базу данных.

> [!div class="nextstepaction"]
>[Реализация географически распределенной базы данных](sql-database-implement-geo-distributed-database.md)

