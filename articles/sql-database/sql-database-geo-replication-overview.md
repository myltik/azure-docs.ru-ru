---
title: Группы отработки отказа и активная георепликация в базе данных SQL Azure | Документация Майкрософт
description: Используйте группы автоматической отработки отказа для активной георепликации и включите автоматическую отработку отказа в случае сбоя.
services: sql-database
author: anosov1960
manager: craigg
ms.service: sql-database
ms.custom: business continuity
ms.topic: conceptual
ms.date: 04/04/2018
ms.author: sashan
ms.reviewer: carlrab
ms.openlocfilehash: 0c27aec90dad6eb3aeb46871d20202870eba886d
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34647651"
---
# <a name="overview-failover-groups-and-active-geo-replication"></a>Обзор. Группы отработки отказа и активная георепликация
Активная георепликация позволяет настроить до четырех доступных для чтения баз данных-получателей в одном или в разных расположениях (регионах) центров обработки данных. Базы данных-получатели доступны для выполнения запросов и отработки отказа при сбое центра обработки данных или невозможности подключения к базе данных-источнику. Отработка отказа должна инициироваться вручную приложением пользователя. После отработки отказа у новой базы данных-источника будет другая конечная точка подключения. 

> [!NOTE]
> Активная георепликация доступна для всех баз данных и всех уровней обслуживания во всех регионах.
>  

Группы автоматической отработки отказа (в предварительной версии) базы данных SQL Azure являются функцией базы данных SQL. Они предназначены для автоматического управления связями георепликации, подключением и отработкой отказа в нужном масштабе. Благодаря им клиенты получают возможность автоматического восстановления нескольких связанных баз данных в дополнительном регионе после катастрофических региональных сбоев или других незапланированных событий, которые приводят к полной или частичной потере доступности службы базы данных SQL в основном регионе. Кроме того, клиенты могут использовать доступные для чтения базы данных-получатели для разгрузки рабочих нагрузок, доступных только для чтения.  Так как группы автоматической отработки отказа включают в себя несколько баз данных, их необходимо настроить на сервере-источнике. Основной сервер и сервер-получатель должны находиться в одной подписке. Группы автоматической отработки отказа поддерживают репликацию всех баз данных в группе только на один сервер-получатель в другом регионе. Активная георепликация без групп автоматической отработки отказа поддерживает до четырех серверов-получателей в любом регионе.

Если при использовании активной георепликации по какой-либо причине произойдет сбой вашей базы данных-источника (или вам просто потребуется перевести ее в автономный режим), вы можете выполнить отработку отказа в любую из баз данных-получателей. При активации отработки отказа в одной из баз данных-получателей все прочие получатели автоматически связываются с новой базой данных-источником. Если вы используете группы автоматической отработки отказа (в предварительной версии) для управления восстановлением базы данных, любой сбой, который влияет на одну или несколько баз данных в группе, приведет к автоматической отработке отказа. Вы можете настроить политику автоматической отработки отказа, которая лучше всего подойдет вашему приложению, или же вы можете отказаться от этой настройки и использовать активацию вручную. Кроме того, группы автоматической отработки отказа (в предварительной версии) предоставляют конечные точки прослушивателя только для чтения и для чтения-записи, которые во время отработки отказа не изменяются. Независимо от того, используете ли вы активацию вручную или автоматическую активацию отработки отказа, отработка отказа переключит все базы данных-получатели в группе в базу данных-источник. После завершения отработки отказа базы данных запись DNS автоматически обновляется, чтобы перенаправить конечные точки в новый регион.

Вы можете управлять репликацией и отработкой отказа отдельной базы данных или набора баз данных на сервере или в эластичном пуле с помощью активной георепликации. Для этого используйте: 

- [портал Azure](sql-database-geo-replication-portal.md).
- [PowerShell: отдельную базу данных](scripts/sql-database-setup-geodr-and-failover-database-powershell.md);
- [PowerShell: эластичный пул](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md);
- [PowerShell: группу отработки отказа](scripts/sql-database-setup-geodr-failover-database-failover-group-powershell.md);
- [Transact-SQL: отдельную базу данных или эластичный пул](/sql/t-sql/statements/alter-database-azure-sql-database);
- [REST API: отдельную базу данных](/rest/api/sql/replicationlinks/failover);
- [REST API: группу отработки отказа](/rest/api/sql/failovergroups/failover). 
 
После отработки отказа убедитесь, что для новой базы данных-источника настроены требования аутентификации ваших сервера и базы данных. Дополнительные сведения см. в разделе [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md). Это применимо к активной георепликации и группам автоматической отработки отказа (в предварительной версии).

Активная георепликация использует технологию SQL Server [AlwaysOn](https://docs.microsoft.com/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) для асинхронной репликации зафиксированных транзакций в базе данных-источнике в базы данных-получатели с помощью изоляции фиксации моментального снимка при чтении (RCSI). Группы автоматической отработки отказа обеспечивают групповую семантику на основе активной георепликации, однако используется тот же механизм асинхронной репликации. Хотя в любой момент база данных-получатель может немного отстать от базы данных-источника, в базе данных-получателе никогда не будет частично выполненных транзакций. Избыточность в различных регионах позволяет быстро восстанавливать приложения после необратимой потери всего центра обработки данных или его частей, вызванной стихийным бедствием, неисправимыми человеческими ошибками или вредоносными действиями. Конкретные сведения о RPO можно найти в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).

На следующем рисунке показан пример активной георепликации, настроенной с помощью базы данных-источника в северо-центральном регионе США и базы данных-получателя в юго-центральном регионе США.

![Отношение георепликации](./media/sql-database-active-geo-replication/geo-replication-relationship.png)

Так как базы данных-получатели доступны для чтения, они могут использоваться для разгрузки рабочих нагрузок только для чтения, например заданий для составления отчетов. Если вы используете активную георепликацию, вы можете создать базу данных-получатель в том же регионе, в котором расположена база данных-источник, однако устойчивость приложения к катастрофическим сбоям останется на прежнем уровне. Если вы используете группы автоматической отработки отказа (в предварительной версии), база данных-получатель всегда будет создаваться в другом регионе.

Активная георепликация может использоваться не только для аварийного восстановления, но и в следующих сценариях:

* **Перенос баз данных**: с помощью активной георепликации можно перенести базу данных с одного сервера на другой с минимальным временем простоя.
* **Обновления приложения**: при обновлении приложения вы можете создать дополнительную базу данных-получатель как резервную копию на случай сбоя.

Добавление избыточности баз данных между центрами обработки данных — только часть решения для достижения настоящей непрерывности бизнес-процессов. Для комплексного восстановления приложения (службы) после катастрофического сбоя необходимо восстановить все компоненты, из которых состоит служба и все зависимые службы. К примерам этих компонентов относятся клиентское программное обеспечение (например, браузер с пользовательским кодом JavaScript), интерфейсные веб-серверы, хранилище и DNS. Очень важно, чтобы все компоненты были устойчивы к одинаковым сбоям и становились доступными в соответствии с целевым временем восстановления (RTO) вашего приложения. Следовательно, необходимо определить все зависимые службы и получить сведения о гарантиях и возможностях, которые они предоставляют. Затем необходимо выполнить соответствующие действия, чтобы обеспечить работу службы во время отработки отказа служб, от которых она зависит. Дополнительные сведения о проектировании решений для аварийного восстановления см. в статье о [разработке облачных решений для аварийного восстановления с помощью активной георепликации](sql-database-designing-cloud-solutions-for-disaster-recovery.md).

## <a name="active-geo-replication-capabilities"></a>Возможности активной георепликации
Функция активной георепликации предоставляет следующие возможности:
* **Автоматическая асинхронная репликация**: базу данных-получатель можно создать, только добавив ее к существующей базе данных. Базу данных-получатель можно создать на любом сервере базы данных SQL Azure. После создания база данных-получатель заполняется данными, которые копируются из базы данных-источника. Этот процесс называется заполнением. После создания и начального заполнения базы данных-получателя обновления базы данных-источника асинхронно и автоматически реплицируются в базу данных-получателя. Асинхронная репликация означает, что транзакции фиксируются в базе данных-источнике перед их репликацией в базу данных-получатель. 
* **Базы данных-получатели, доступные для чтения**: приложение может получить доступ к базе данных-получателю только для чтения с использованием тех же или других субъектов безопасности, которые применяются для доступа к базе данных-источнику. База данных-получатель работает в режиме изоляции моментальных снимков, чтобы гарантировать, что репликация обновлений базы данных-источника (воспроизведение журнала) не будет задерживаться из-за запросов, выполняемых на базе данных-получателе.

   > [!NOTE]
   > Если в базе данных-источнике есть обновления схем, воспроизведение журнала в базе данных-получателе откладывается. Для последнего требуется заблокировать схему базы данных-получателя. 
   > 

* **Несколько баз данных-получателей для чтения.** Две или более базы данных-получателей повышают избыточность и уровень защиты для базы данных-источника и приложения. Если существует несколько баз данных-получателей, то приложение остается защищенным даже при сбое одной из баз данных-получателей. Если же имеется только одна база данных-получатель и на ней происходит сбой, приложение подвергается более высокому риску, пока не будет создана новая база данных-получатель.

   > [!NOTE]
   > Если вы используете активную георепликацию, чтобы создать глобально распределенное приложение, и вам необходимо предоставить к данным доступ только для чтения более чем в четырех регионах, вы можете создать базу данных-получатель первой базы данных-получателя (цепочку). Это гарантирует виртуально неограниченное масштабирование репликации базы данных. Кроме того, эта цепочка снижает нагрузку репликации в базе данных-источнике. Недостатком является увеличенная задержка репликации в конечных базах данных-получателях. 
   >

* **Поддержка баз данных эластичного пула**: каждая реплика может отдельно участвовать в эластичном пуле или вообще не участвовать в каком-либо эластичном пуле. Выбор пула для каждой реплики осуществляется отдельно и не зависит от конфигурации других реплик (первичных или вторичных). Каждый эластичный пул содержится в одном регионе, поэтому несколько реплик в одной топологии никогда не могут совместно использовать один эластичный пул.
* **Настраиваемый уровень производительности базы данных-получателя.** Для базы данных-источника и базы данных-получателя должен использоваться один и тот же уровень служб. Базу данных-получатель можно создать с более низким уровнем производительности (DTU), чем у базы данных-источника. Эта конфигурация не рекомендуется для приложений с высокой интенсивностью записи в базы данных, так как увеличение задержки репликации повышает риск потери значительного объема данных после отработки отказа. Кроме того, после отработки отказа производительность приложения будет снижена, пока новая база данных-источник не будет обновлена до более высокого уровня производительности. Диаграмма журнала операций ввода-вывода в процентах на портале Azure — это удобный способ оценить минимальный уровень производительности базы данных-получателя, необходимый для того, чтобы выдержать нагрузку репликации. Например, если уровень базы данных-источника — P6 (1000 DTU) и процент операций ввода-вывода для нее равен 50 %, то уровень базы-данных получателя должен быть не менее P4 (500 DTU). Данные журнала операций ввода-вывода также можно получить с помощью представления базы данных [sys.resource_stats](/sql/relational-databases/system-catalog-views/sys-resource-stats-azure-sql-database) или [sys.dm_db_resource_stats](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-resource-stats-azure-sql-database).  Дополнительные сведения об уровнях производительности Базы данных SQL см. в статье [Что такое уровни служб Базы данных SQL](sql-database-service-tiers.md). 
* **Управляемые пользователем отработка отказа и восстановление размещения**: приложение или пользователь может в любой момент явным образом использовать базу данных-получатель в качестве базы данных-источника. Во время настоящего сбоя следует использовать параметр "unplanned", при котором база данных-получатель будет немедленно повышена до базы данных-источника. Когда работоспособность вышедшей из строя базы данных-источника будет восстановлена и она снова станет доступной, система автоматически пометит ее как базу данных-получатель и синхронизирует с новой базой данных-источником. Из-за асинхронного характера репликации во время внеплановой отработки отказа может быть потерян небольшой объем данных, если сбой базы данных-источника произойдет до того, как будет выполнена репликация самых последних изменений в базу данных-получатель. При сбое базы данных-источника с несколькими базами данных-получателями система автоматически перенастраивает отношения репликации и связывает оставшиеся базы данных-получатели с новой развернутой базой данных-источником без вмешательства пользователя. После устранения сбоя, который вызвал отработку отказа, желательно вернуть приложение в основной регион. Для этого необходимо вызвать команду отработки отказа с параметром "planned". 
* **Синхронизация учетных данных и правил брандмауэра**. Мы рекомендуем использовать [правила брандмауэра базы данных](sql-database-firewall-configure.md) для геореплицируемых баз данных. Таким образом, эти правила можно реплицировать в базу данных, чтобы все базы данных-получатели использовали те же правила брандмауэра, что и база данных-источник. Такой подход избавляет клиентов от необходимости вручную настраивать и обслуживать правила брандмауэра на серверах, на которых размещаются как базы данных-источники, так и базы данных-получатели. Аналогично, в случае получения доступа к данным с помощью [пользователей автономной базы данных](sql-database-manage-logins.md) базы данных-источники и базы данных-получатели всегда используют одни и те же учетные данные. Поэтому при отработке отказа можно избежать нарушений в работе из-за несоответствия имен для входа или паролей. Благодаря добавлению [Azure Active Directory](../active-directory/active-directory-whatis.md) клиенты могут управлять доступом пользователей к базам данных-источникам и базам данных-получателям, и им не нужно управлять учетными данными для баз данных.

## <a name="auto-failover-group-capabilities"></a>Возможности группы автоматической отработки отказа

Группы автоматической отработки отказа обеспечивают расширенную абстракцию активной георепликации за счет поддержки репликации на уровне группы и автоматической отработки отказа. Кроме того, отпадает необходимость в изменении строки подключения SQL после отработки отказа благодаря предоставлению дополнительных конечных точек прослушивателя. 

* **Группа отработки отказа.** Вы можете создать одну или несколько групп отработки отказа между двумя серверами в различных регионах (для основного сервера и сервера-получателя). Каждая группа может содержать одну или несколько баз данных, которые восстанавливаются единым блоком в случае, когда все или часть баз данных-источников становятся недоступными из-за сбоя в основном регионе.  
* **Основной сервер.** Сервер, на котором размещаются базы данных-источники в группе отработки отказа.
* **Сервер-получатель.** Сервер, на котором размещаются базы данных-получатели в группе отработки отказа. Сервер-получатель не может находиться в том же регионе, что и основной сервер.
* **Добавление баз данных в группу отработки отказа.** Вы можете разместить несколько баз данных на сервере или в эластичном пуле в одну группу отработки отказа. Если вы добавите автономную базу данных в группу, она автоматически создаст базу данных-получатель, используя тот же выпуск и уровень производительности. Если база данных-источник расположена в эластичном пуле, в нем автоматически создается база данных-получатель с тем же именем. Если вы добавите базу данных, у которой уже есть база данных-получатель на сервере-получателе, эта георепликация наследуется группой.

   > [!NOTE]
   > Если вы добавите базу данных, у которой уже есть база данных-получатель на сервере, который не является частью группы отработки отказа, на этом сервере-получателе будет создана новая база данных-получатель. 
   >

* **Прослушиватель чтения и записи для группы отработки отказа.** Это запись DNS CNAME в формате **&lt;имя_группы_отработки_отказа&gt;.database.windows.net**, которая указывает на текущий URL-адрес основного сервера. Она позволяет приложениям SQL для чтения и записи прозрачно повторно подключиться к базе данных-источнику, когда эта база данных изменяется после отработки отказа. 
* **Прослушиватель только для чтения для группы отработки отказа.** Это запись DNS CNAME в формате **&lt;имя_группы_отработки_отказа&gt;.secondary.database.windows.net**, которая указывает на URL-адрес сервера-получателя. Она позволяет приложениям SQL только для чтения прозрачно подключиться к базе данных-получателю с помощью специальных правил балансировки нагрузки. При необходимости вы можете указать, хотите ли вы, чтобы трафик только для чтения автоматически перенаправлялся к основному серверу, если сервер-получатель недоступен.
* **Политика автоматической отработки отказа.** По умолчанию группа отработки отказа настроена с помощью политики автоматической отработки отказа. Система запускает отработку отказа сразу же после обнаружения сбоя. Если вы хотите управлять рабочим процессом отработки отказа из приложения, вы можете отключить автоматическую отработку отказа. 
* **Отработка отказа вручную.** Вы можете запустить отработку отказа вручную в любое время, независимо от настройки автоматической отработки отказа. Если политика автоматической отработки отказа не настроена, для восстановления баз данных в группе отработки отказа требуется отработка отказа вручную. Вы можете запустить принудительную отработку отказа или адаптированную (с полной синхронизацией данных). Адаптированная отработка отказа может использоваться для перемещения активного сервера в основной регион. После завершения отработки отказа записи DNS автоматически обновляются для установления подключения к нужному серверу.
* **Льготный период с потерей данных.** Так как база данных-источник и база данных-получатель синхронизированы с помощью асинхронной репликации, отработка отказа может привести к потере данных. Вы можете настроить политику автоматической отработки отказа, чтобы представить устойчивость приложения к потере данных. Настраивая параметр **GracePeriodWithDataLossHours**, вы можете управлять продолжительностью периода ожидания системы перед последующим запуском отработки отказа, которая, вероятнее всего, приведет к потере данных. 

   > [!NOTE]
   > Когда система обнаружит, что базы данных в группе все еще работают (например, когда сбой повлиял только на уровень управления службы), она немедленно запустит отработку отказа с полной синхронизацией данных (адаптированную отработку отказа), несмотря на значение, заданное для параметра **GracePeriodWithDataLossHours**. Это поведение гарантирует, что во время восстановления не произойдет потеря данных. Этот льготный период актуален, только если адаптированная отработка отказа недоступна. Если же сбой удалось устранить до истечения срока действия льготного периода, отработка отказа не будет активирована.
   >

* **Несколько групп отработки отказа.** Вы можете настроить несколько групп отработки отказа для одной пары серверов, чтобы управлять масштабом отработок отказа. Каждая группа выполняет отработку отказа независимо от других групп. Если ваше мультитенантное приложение использует эластичные пулы, вы можете воспользоваться этой возможностью, чтобы объединить базу данных-источник и базу данных-получатель в каждом пуле. Таким образом вы сможете снизить последствия сбоя для половины клиентов.

## <a name="best-practices-of-building-highly-available-service"></a>Рекомендации по созданию службы высокой доступности

Для создания высокодоступной службы, которая использует базу данных SQL Azure, следует придерживаться следующих рекомендаций.

- **Использование группы отработки отказа.** Вы можете создать одну или несколько групп отработки отказа между двумя серверами (источником и получателем) в разных регионах. Каждая группа может содержать одну или несколько баз данных, которые восстанавливаются единым блоком в случае, когда все или часть баз данных-источников становятся недоступными из-за сбоя в основном регионе. Группа отработки отказа создает базу данных-получатель в дополнительном географическом регионе с таким же целевым уровнем служб, который указан для базы данных-источника. При добавлении существующей связи георепликации к группе отработки отказа убедитесь, что база данных-получатель геореплицируемых данных настроена с тем же целевым уровнем служб, что и база данных-источник.
- **Использование прослушивателя чтения и записи для рабочей нагрузки OLTP.** При выполнении операций OLTP в качестве URL-адреса сервера будет использоваться значение **&lt;имя_группы_отработки_отказа&gt;.database.windows.net**, чтобы все подключения автоматически перенаправлялись на сервер-источник. Этот URL-адрес не будет изменяться после отработки отказа. Обратите внимание на то, что отработка отказа включает в себя обновление DNS-записи, поэтому клиентские подключения будут перенаправляться на новый сервер-источник только после обновления кэша DNS на стороне клиента.
- **Использование прослушивателя только для чтения для рабочей нагрузки только для чтения.** Если вы используете логически изолированную рабочую нагрузку в режиме только для чтения, устойчивую к некоторым задержкам в обновлении данных, в приложении можно использовать базу данных-получатель. Для сеансов с доступом только для чтения в качестве URL-адреса сервера используется значение **&lt;имя_группы_отработки_отказа&gt;.secondary.database.windows.net**, чтобы подключение автоматически перенаправлялось на сервер-получатель. Кроме того, мы рекомендуем указать режим только для чтения прямо в строке подключения, добавив аргумент **ApplicationIntent=ReadOnly**. 
- **Будьте готовы к снижению производительности.** Решение отработки отказа SQL не зависит от остальной части приложения или других используемых служб. Приложение может смешаться с некоторыми компонентами в одном регионе и с некоторыми в другом. Чтобы избежать снижения производительности, обеспечьте избыточное развертывание приложения в регионе аварийного восстановления и следуйте рекомендациям в этой статье. Обратите внимание, что приложение в регионе аварийного восстановления не требует использования другой строки подключения.  
- **Подготовка к потере данных.** Если обнаруживается сбой и у нас нет оснований полагать, что произошла потеря данных, SQL автоматически активирует отработку отказа с чтением и записью. В противном случае он ожидает в течение периода, указанного в **GracePeriodWithDataLossHours**. Если вы указали параметр **GracePeriodWithDataLossHours**, будьте готовы к потере данных. Во время сбоев Azure, как правило, повышает доступность. Если вы не можете позволить себе потерю данных, установите для параметра **GracePeriodWithDataLossHours** достаточно большое количество времени, например 24 часа. 

> [!IMPORTANT]
> Эластичные пулы с 800 или менее DTU и более 250 базами данных, использующими георепликацию, могут испытывать проблемы, включая более длительные плановые операции отработки отказа и снижение производительности.  Эти проблемы чаще всего возникают из-за рабочих нагрузок, интенсивно записывающих данные, если конечные точки георепликации физически находятся далеко друг от друга или если используется несколько дополнительных конечных точек для каждой базы данных.  Симптомы этих проблем проявляются при увеличении задержки георепликации с течением времени.  Эту задержку можно отслеживать с помощью [sys.dm_geo_replication_link_status](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database).  Если эти проблемы возникли, к возможным способам их устранения относятся увеличение числа DTU пула или уменьшение количества геореплицируемых баз данных в одном пуле.

## <a name="upgrading-or-downgrading-a-primary-database"></a>Повышение или понижение уровня производительности базы данных-источника
Вы можете повышать или понижать уровень производительности базы данных-источника (в рамках одного уровня служб) без отключения каких-либо баз данных-получателей. При повышении рекомендуется сначала повысить уровень производительности базы данных-получателя, а затем — уровень базы данных-источника. При понижении следует действовать в обратном порядке: сначала нужно понизить уровень производительности базы данных-источника, а после этого — базы данных-получателя. Когда вы повышаете или понижаете базу данных до следующего уровня службы, особенно важно выполнять рекомендацию выше. 

> [!NOTE]
> Если вы создали базу данных-получатель как часть конфигурации группы отработки отказа, понижение ее уровня не рекомендуется. Это необходимо, чтобы обеспечить достаточную емкость уровня данных для обработки регулярных рабочих нагрузок после активации отработки отказа. 
>

## <a name="preventing-the-loss-of-critical-data"></a>Предотвращение потери важных данных
Из-за высокой задержки глобальных сетей непрерывная копия использует механизм асинхронной репликации. Ввиду асинхронной репликации потеря данных в случае сбоя неизбежна. Тем не менее для некоторых приложений терять данные недопустимо. Чтобы защитить эти критические обновления, разработчик приложения сразу же после фиксации транзакции может вызывать системную процедуру [sp_wait_for_database_copy_sync](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync). Вызов **sp_wait_for_database_copy_sync** блокирует вызывающий поток до передачи последней зафиксированной транзакции в базе данных-получателе. Но вызов не дожидается воспроизведения и фиксации переданных транзакций в базе данных-получателе. **sp_wait_for_database_copy_sync** ограничена конкретной связью непрерывной копии. Эту процедуру может вызвать любой пользователь с правами подключения к базе данных-источнику.

> [!NOTE]
> Процедура **sp_wait_for_database_copy_sync** предотвращает потерю данных после отработки отказа, но не гарантирует полную синхронизацию для доступа на чтение. Вызов процедуры **sp_wait_for_database_copy_sync** может привести к значительной задержке, которая будет зависеть от размера журнала транзакций во время вызова. 
> 

## <a name="programmatically-managing-failover-groups-and-active-geo-replication"></a>Программное управление группами отработки отказа и активной георепликацией
Как уже говорилось ранее, группами автоматической отработки отказа (в предварительной версии) и активной георепликацией можно также управлять программно с помощью Azure PowerShell и REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

**API Azure Resource Manager и безопасность на основе ролей.** Активная георепликация включает в себя набор API-интерфейсов Azure Resource Manager для управления, в том числе [REST API базы данных SQL Azure](https://docs.microsoft.com/rest/api/sql/) и [командлеты Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview). Эти интерфейсы API требуют использования групп ресурсов и поддерживают безопасность на основе ролей (RBAC). Дополнительные сведения о том, как реализовать контроль доступа на основе ролей, см. в статье [Использование управления доступом на основе ролей для контроля доступа к ресурсам в подписке Azure](../role-based-access-control/overview.md).

## <a name="manage-sql-database-failover-using-transact-sql"></a>Управление отработкой отказа базы данных SQL с помощью Transact-SQL

| Get-Help | ОПИСАНИЕ |
| --- | --- |
| [ALTER DATABASE (база данных SQL Azure)](/sql/t-sql/statements/alter-database-azure-sql-database) |Используйте аргумент ADD SECONDARY ON SERVER, чтобы создать базу данных-получатель для существующей базы данных и начать репликацию данных. |
| [ALTER DATABASE (база данных SQL Azure)](/sql/t-sql/statements/alter-database-azure-sql-database) |Используйте аргумент FAILOVER или FORCE_FAILOVER_ALLOW_DATA_LOSS, чтобы задать базу данных-получатель в качестве базы данных-источника для запуска отработки отказа. |
| [ALTER DATABASE (база данных SQL Azure)](/sql/t-sql/statements/alter-database-azure-sql-database) |Используйте аргумент REMOVE SECONDARY ON SERVER, чтобы завершить репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [sys.geo_replication_links (база данных SQL Azure)](/sql/relational-databases/system-dynamic-management-views/sys-geo-replication-links-azure-sql-database) |Возвращает сведения о всех существующих связях репликации для каждой базы данных на логическом сервере Базы данных SQL Azure. |
| [sys.dm_geo_replication_link_status (база данных SQL Azure)](/sql/relational-databases/system-dynamic-management-views/sys-dm-geo-replication-link-status-azure-sql-database) |Получает время последней репликации, задержку при последней репликации и другие сведения о связи репликации для заданной базы данных SQL. |
| [sys.dm_operation_status (база данных SQL Azure)](/sql/relational-databases/system-dynamic-management-views/sys-dm-operation-status-azure-sql-database) |Показывает состояние всех операций с базой данных, включая состояние связей репликации. |
| [sp_wait_for_database_copy_sync (база данных SQL Azure)](/sql/relational-databases/system-stored-procedures/active-geo-replication-sp-wait-for-database-copy-sync) |Указывает приложению ждать, пока все зафиксированные транзакции не будут реплицированы и подтверждены активной базой данных-получателем. |
|  | |

## <a name="manage-sql-database-failover-using-powershell"></a>Управление отработкой отказа базы данных SQL с помощью PowerShell

| Командлет | ОПИСАНИЕ |
| --- | --- |
| [Get-AzureRmSqlDatabase](/powershell/module/azurerm.sql/get-azurermsqldatabase) |Получает одну или несколько баз данных. |
| [New-AzureRmSqlDatabaseSecondary](/powershell/module/azurerm.sql/new-azurermsqldatabasesecondary) |Создает базу данных-получатель для существующей базы данных и начинает репликацию данных. |
| [Set-AzureRmSqlDatabaseSecondary](/powershell/module/azurerm.sql/set-azurermsqldatabasesecondary) |Преобразует базу данных-получатель в базу данных-источник для запуска отработки отказа. |
| [Remove-AzureRmSqlDatabaseSecondary](/powershell/module/azurerm.sql/remove-azurermsqldatabasesecondary) |Завершает репликацию данных между базой данных SQL и указанной базой данных-получателем. |
| [Get-AzureRmSqlDatabaseReplicationLink](/powershell/module/azurerm.sql/get-azurermsqldatabasereplicationlink) |Получает связи георепликации между базой данных SQL Azure и группой ресурсов или SQL Server. |
| [New-AzureRmSqlDatabaseFailoverGroup](/powershell/module/azurerm.sql/set-azurermsqldatabasefailovergroup) |   Создает группу отработки отказа и регистрирует ее на основном сервере и сервере-получателе.|
| [Remove-AzureRmSqlDatabaseFailoverGroup](/powershell/module/azurerm.sql/remove-azurermsqldatabasefailovergroup) | Удаляет группу отработки отказа с сервера, а также удаляет все входящие в нее базы данных-получатели. |
| [Get-AzureRmSqlDatabaseFailoverGroup](/powershell/module/azurerm.sql/get-azurermsqldatabasefailovergroup) | Возвращает конфигурацию группы отработки отказа. |
| [Set-AzureRmSqlDatabaseFailoverGroup](/powershell/module/azurerm.sql/set-azurermsqldatabasefailovergroup) |   Изменяет конфигурацию группы отработки отказа. |
| [Switch-AzureRMSqlDatabaseFailoverGroup](/powershell/module/azurerm.sql/switch-azurermsqldatabasefailovergroup) | Запускает отработку отказа группы отработки отказа на сервер-получатель. |
|  | |

> [!IMPORTANT]
> Дополнительные сведения о примерах сценариев см. в руководствах по [настройке и отработке отказа для отдельной базы данных с помощью активной георепликации](scripts/sql-database-setup-geodr-and-failover-database-powershell.md), [настройке и отработке отказа для активной базы данных в составе пула с помощью активной георепликации](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md), а также [настройке и отработке отказа для группы отработки отказа для отдельной базы данных (предварительная версия)](scripts/sql-database-setup-geodr-failover-database-failover-group-powershell.md).
>

## <a name="manage-sql-database-failover-using-the-rest-api"></a>Управление отработкой отказа базы данных SQL с помощью REST API
| API | ОПИСАНИЕ |
| --- | --- |
| [Создание или обновление базы данных (createMode=Restore)](/rest/api/sql/Databases/CreateOrUpdate) |Создает, обновляет или восстанавливает базу данных-источник или базу данных-получатель. |
| [Получение, создание или обновление состояния базы данных](/rest/api/sql/Databases/CreateOrUpdate) |Возвращает состояние во время операции создания. |
| [Задание базы данных-получателя в качестве базы данных-источника (плановая отработка отказа)](/rest/api/sql/replicationlinks/failover) |Задает базу данных-источник реплики. Для этого выполняется отработка отказа из текущей базы данных-источника реплики. |
| [Задание базы данных-получателя в качестве базы данных-источника (внеплановая отработка отказа)](/rest/api/sql/replicationlinks/failoverallowdataloss) |Задает базу данных-источник реплики. Для этого выполняется отработка отказа из текущей базы данных-источника реплики. Эта операция может привести к потере данных. |
| [Получение связи репликации](/rest/api/sql/replicationlinks/get) |Получает определенную связь репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. |
| [Replication Links - List By Database](/rest/api/sql/replicationlinks/listbydatabase) (Ссылки для репликации: вывод списка по базе данных) | Получает все связи репликации для заданной базы данных SQL, участвующей в партнерстве георепликации. Извлекает сведения, отображаемые в представлении каталога sys.geo_replication_links. |
| [Удаление связей репликации](/rest/api/sql/databases/delete) | Удаляет связь репликации базы данных. Невозможно выполнить во время отработки отказа. |
| [Создание или обновление группы отработки отказа](/rest/api/sql/failovergroups/createorupdate) | Создает или обновляет группу отработки отказа. |
| [Удаление группы отработки отказа](/rest/api/sql/failovergroups/delete) | Удаляет группу отработки отказа с сервера. |
| [Плановая отработка отказа](/rest/api/sql/failovergroups/failover) | Выполняет отработку отказа из текущего основного сервера на этот сервер. |
| [Принудительная отработка отказа (возможна потеря данных)](/rest/api/sql/failovergroups/forcefailoverallowdataloss) |Выполняет отработку отказа из текущего основного сервера на этот сервер. Эта операция может привести к потере данных. |
| [Получение группы отработки отказа](/rest/api/sql/failovergroups/get) | Получает группу отработки отказа. |
| [Вывод списка групп отработки отказа с фильтрацией по серверу](/rest/api/sql/failovergroups/listbyserver) | Перечисляет группы отработки отказа на сервере. |
| [Обновление группы отработки отказа](/rest/api/sql/failovergroups/update) | Обновляет группу отработки отказа. |
|  | |

## <a name="next-steps"></a>Дополнительная информация
* Ознакомьтесь с примерами скриптов в следующих статьях:
   - [Настройка активной георепликации для отдельной базы данных SQL Azure с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-database-powershell.md)
   - [Настройка активной георепликации для базы данных SQL Azure в составе пула с помощью PowerShell](scripts/sql-database-setup-geodr-and-failover-pool-powershell.md)
   - [Use PowerShell to configure an active geo-replication failover group for a single Azure SQL database](scripts/sql-database-setup-geodr-failover-database-failover-group-powershell.md) (Использование PowerShell для настройки группы отработки отказа активной георепликации для отдельной базы данных SQL Azure (предварительная версия)).
* Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md)
* Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
* Чтобы узнать об использовании автоматически создаваемых резервных копий для восстановления, ознакомьтесь с [восстановлением базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md).
* Дополнительные сведения о требованиях к проверке подлинности для новых сервера-источника и базы данных-источника см. в статье [Безопасность базы данных SQL после аварийного восстановления](sql-database-geo-replication-security-config.md).

