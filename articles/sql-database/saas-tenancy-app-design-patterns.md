---
title: Мультитенантные шаблоны SaaS в базе данных SQL Azure | Документация Майкрософт
description: Узнайте о требованиях и общих шаблонах архитектуры данных для мультитенантных приложений базы данных программного обеспечения как услуги (SaaS), работающих в облачной среде Azure.
keywords: руководство по базе данных sql
services: sql-database
author: billgib
manager: craigg
ms.service: sql-database
ms.custom: scale out apps
ms.topic: article
ms.date: 04/01/2018
ms.author: billgib
ms.openlocfilehash: 3220c538e08753ed3515f42a5b8110df71745a63
ms.sourcegitcommit: 3a4ebcb58192f5bf7969482393090cb356294399
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="multi-tenant-saas-database-tenancy-patterns"></a>Мультитенантные шаблоны клиента в базе данных SaaS

При разработке мультитенантного приложения SaaS необходимо тщательно выбрать клиентскую модель, которая лучше всего соответствует требованиям приложения.  Клиентская модель определяет способ сопоставления данных каждого клиента с хранилищем.  Выбор клиентской модели влияет на проектирование приложения и управление им.  Последующее переключение на другую модель иногда является дорогостоящим.

Ниже рассматриваются альтернативные клиентские модели.

## <a name="a-how-to-choose-the-appropriate-tenancy-model"></a>О. Как выбрать соответствующую клиентскую модель

Как правило, клиентская модель не влияет на функции приложения, но влияет на другие аспекты решения в целом.  Для оценки каждой модели используются критерии ниже.

- **Масштабируемость:**
    - число клиентов;
    - хранилище на клиент;
    - хранилище в статистической обработке;
    - рабочая нагрузка.

- **Изоляция клиента:** &nbsp; изоляция данных и производительность (влияет ли рабочая нагрузка одного клиента на другие).

- **Стоимость каждого клиента:** &nbsp; затраты на базу данных.

- **Сложность разработки:**
    - изменения схемы;
    - изменения запросов (требуемые шаблоном).

- **Сложность эксплуатации:**
    - мониторинг производительности и управление ею;
    - управление схемами;
    - восстановление клиента;
    - аварийное восстановление.

- **Возможность настройки:**&nbsp; доступная поддержка настроек схемы — для клиента или его определенного класса.

В обсуждении клиента больше рассматривается слой *данных*.  Но следует вкратце рассмотреть слой *приложения*.  Слой приложения рассматривается как монолитная сущность.  Если разделить приложение на несколько небольших компонентов, выбор клиентской модели может измениться.  Обработка некоторых компонентов отличается от обработки других с учетом используемых клиента и технологии или платформы хранения.

## <a name="b-standalone-single-tenant-app-with-single-tenant-database"></a>B. Изолированное однотенантное приложение с однотенантной базой данных

#### <a name="application-level-isolation"></a>Изоляция на уровне приложения

В этой модели установка всего приложения выполняется несколько раз, один раз для каждого клиента.  Каждый экземпляр приложения представляет собой автономный экземпляр, поэтому он никогда не взаимодействует с каким-либо другим автономным экземпляром.  Каждый экземпляр приложения имеет только один клиент, поэтому ему необходима только одна база данных.  Эта база данных предназначена только для этого клиента.

![Структура изолированного приложения с однотенантной базой данных.][image-standalone-app-st-db-111a]

Каждый экземпляр приложения устанавливается в отдельной группе ресурсов Azure.  Каждая группа ресурсов может принадлежать подписке, владельцем которой является поставщик программного обеспечения или клиент.  В любом случае поставщик может управлять программным обеспечением клиента.  Каждый экземпляр приложения настроен для подключения к соответствующей базе данных.

Каждая база данных клиента развертывается как автономная база данных.  Эта модель обеспечивает наивысшую степень изоляции базы данных.  Однако для каждой базы данных требуется выделять достаточно ресурсов, чтобы обрабатывать ее пиковые нагрузки.  Важно, что эластичные пулы не могут использоваться для баз данных, развернутых в других группах ресурсов или подписках.  Такое ограничение делает эту изолированную модель однотенантного приложения самым дорогостоящим решением с точки зрения общих затрат на базу данных.

#### <a name="vendor-management"></a>Управление со стороны поставщика

У поставщика есть доступ ко всем базам данных во всех изолированных экземплярах приложения, даже если эти экземпляры установлены в других подписках клиента.  Доступ осуществляется через подключения SQL.  С помощью этого перекрестного доступа поставщик может централизовать управление схемой и межбазовые запросы для задач отчетности и аналитики.  Если требуется такой вид централизованного управления, должен быть развернут каталог для сопоставления идентификаторов клиентов с URI баз данных.  База данных SQL Azure предоставляет библиотеку сегментирования, которая используется вместе с базой данных SQL для предоставления каталога.  Библиотека сегментирования формально называется [клиентской библиотекой эластичной базы данных][docu-elastic-db-client-library-536r].

## <a name="c-multi-tenant-app-with-database-per-tenant"></a>C. Мультитенантное приложение с однотенантной базой данных

Этот шаблон использует мультитенантное приложение с несколькими однотенантными базами данных.  Новая база данных подготавливается для каждого нового клиента.  Можно вертикально *увеличивать* масштаб уровня приложения, добавляя больше ресурсов для каждого узла.  Или же горизонтально *уменьшать* масштаб, добавляя большее число узлов.  Масштабирование зависит от рабочей нагрузки и не зависит от количества или масштаба отдельных баз данных.

![Структура мультитенантного приложения с однотенантной базой данных.][image-mt-app-db-per-tenant-132d]

#### <a name="customize-for-a-tenant"></a>Настройка клиента

Как и при изолированном шаблоне приложения использование однотенантных баз данных обеспечивает надежную изоляцию клиента.  В любом приложении, модель которого определяет только однотенантные базы данных, можно оптимизировать и настроить схему любой базы данных для ее клиента.  Такая настройка не влияет на другие клиенты в приложении. Возможно, клиенту потребуются данные помимо основных полей данных, которые нужны всем клиентам.  Кроме того, дополнительному полю данных может понадобиться индекс.

С помощью отдельной однотенантной базы данных можно настроить схему для одного или нескольких клиентов.  Поставщик приложения должен разработать процедуры, чтобы соответствующим образом управлять настройками схемы в нужном масштабе.

#### <a name="elastic-pools"></a>Пулы эластичных БД

При развертывании баз данных в одной группе ресурсов их можно группировать в пулы эластичных баз данных.  Пулы обеспечивают экономичный способ совместного использования ресурсов между несколькими базами данных.  Использование пула обходится дешевле, чем баз данных большого размера, необходимого, чтобы справиться с пиками использования.  Несмотря на то что базы данных в составе пула имеют совместный доступ к ресурсам, по-прежнему возможна высокая степень изоляции производительности.

![Структура мультитенантного приложения с однотенантной базой данных с использованием эластичного пула.][image-mt-app-db-per-tenant-pool-153p]

База данных SQL Azure предоставляет средства, необходимые для настройки и мониторинга совместного доступа, а также управления им.  На портале Azure, а также в службе Log Analytics доступны метрики производительности на уровне базы данных и пула.  С помощью этих метрик можно получить подробные сведения об общей производительности и производительности отдельного клиента.  Отдельные базы данных можно перемещать между пулами, чтобы предоставить зарезервированные ресурсы конкретным клиентам.  Эти инструменты позволяют обеспечить оптимальную производительность без лишних затрат.

#### <a name="operations-scale-for-database-per-tenant"></a>Масштабирование операций для однотенантной базы данных

Платформа базы данных SQL Azure предлагает множество функций управления, разработанных для управления большим количеством баз данных, например свыше 100 000.  Эти функции делают вероятный шаблон однотенантной базы данных.

Предположим, что в системе имеется база данных с 1000 клиентов — только одна база данных.  У базы данных может быть 20 индексов.  Если система выполнит преобразование для получения 1000 однотенантных баз данных, количество индексов возрастет до 20 000.  В базе данных SQL в рамках [автоматической настройки][docu-sql-db-automatic-tuning-771a] функции автоматического индексирования включены по умолчанию.  С помощью автоматического индексирования выполняется управление всеми 20 000 индексами и их текущими операциями создания и удаления.  Эти автоматические действия применяются в отдельной базе данных и не координируются или ограничиваются подобными действиями в других базах данных.  Автоматическое индексирование неодинаково обрабатывает индексы в базах данных с разными нагрузками.  Такой тип настройки управления индексами был бы крайне неэффективным для масштабирования однотенантной базы данных, если задача по такому управлению должна была бы выполняться вручную.

Ниже приведены другие функции управления, которые поддерживают масштабирование:

- встроенные резервные копии;
- обеспечение высокой доступности; Каждый набор масштабирования помещает свои виртуальные машины в группу доступности с 5 доменами сбоя (FD) и 5 доменами обновления (UD) для обеспечения доступности (дополнительные сведения о доменах сбоя и обновления см.
- шифрование дисков;
- телеметрия производительности.

#### <a name="automation"></a>Служба автоматизации

Операции управления можно выполнять с помощью сценариев и реализовывать через модель [разработки и операций][http-visual-studio-devops-485m].  Их даже можно автоматизировать и реализовывать в приложении.

Например, вы можете автоматизировать восстановление отдельного клиента до более ранней точки во времени.  Для восстановления необходимо только восстановить однотенантную базу данных, в которой хранится клиент.  Такое восстановление не оказывает влияние на другие клиенты, что подтверждает выполнение операций управления на более глубоком уровне каждого отдельного клиента.

## <a name="d-multi-tenant-app-with-multi-tenant-databases"></a>D. Мультитенантное приложение с мультитенантными базами данных

Другой доступный шаблон — хранение нескольких клиентов в мультитенантной базе данных.  Экземпляр приложения может иметь любое количество мультитенантных баз данных.  Схема мультитенантной базы данных должна иметь один или несколько столбцов идентификаторов клиентов, чтобы можно было выборочно извлечь данные из любого соответствующего клиента.  Кроме того, схеме может потребоваться несколько таблиц или столбцов, используемых только подмножеством клиентов.  Однако статический код и эталонные данные сохраняются только раз и совместно используются всеми клиентами.

#### <a name="tenant-isolation-is-sacrificed"></a>Потеря изоляции клиента

*Данные:* &nbsp; мультитенантная база данных по необходимости "жертвует" изоляцией клиента.  Данные нескольких клиентов совместно хранятся в одной базе данных.  Во время разработки запросы никогда не должны предоставлять данные из более чем одного клиента.  База данных SQL поддерживает [безопасность на уровне строк][docu-sql-svr-db-row-level-security-947w], которую можно применить к данным, возвращенным из запроса, и ограничить их отдельным клиентом.

*Обработка:*&nbsp; мультитенантная база данных предоставляет совместный доступ к вычислительным ресурсам и ресурсам хранения для всех своих клиентов.  Вы можете отслеживать всю базу данных, чтобы наблюдать за ее работой.  Тем не менее система Azure не имеет встроенной функции мониторинга или контроля использования этих ресурсов отдельным клиентом.  Таким образом, мультитенантная база данных повышает риск возникновения "шумных соседей", где рабочая нагрузка одного активного клиента влияет на производительность других клиентов в этой базе данных.  С помощью дополнительного мониторинга на уровне приложения можно отслеживать производительность на уровне клиента.

#### <a name="lower-cost"></a>Низкая стоимость

Как правило, мультитенантные базы данных имеют наименьшую стоимость на каждого клиента.  Затраты на ресурсы для автономной базы данных ниже, чем для эластичного пула аналогичного размера.  Кроме того, в сценариях, где клиентам требуется только ограниченный объем хранилища, потенциально миллионы клиентов могут храниться в одной базе данных.  Эластичный пул не может содержать миллионы баз данных.  Однако рассмотрим решение, содержащее 1000 баз данных на пул. С 1000 пулами можно достичь масштабируемости, обеспечиваемой миллионом клиентов, с риском трудоемкого управления.

Есть два варианта модели мультитенантной базы данных, которые описываются ниже. Наиболее гибкой и масштабируемой является сегментированная мультитенантная модель.

## <a name="e-multi-tenant-app-with-a-single-multi-tenant-database"></a>E. Мультитенантное приложение с отдельной мультитенантной базой данных

Самый простой шаблон мультитенантной базы данных использует отдельную изолированную базу данных для размещения данных всех клиентов.  По мере добавления дополнительных клиентов база данных масштабируется и, соответственно, увеличивается объем хранилища и вычислительных ресурсов.  Даже такая масштабируемость является ограниченной.  Тем не менее к тому моменту, когда будет достигнут предел масштабируемости, управление базой данных станет очень трудоемким процессом.

В мультитенантной базе данных гораздо сложнее реализовать операции управления, ориентированные на отдельных клиентов.  И в рамках масштабирования они могут работать очень медленно.  В качестве примера можно привести восстановление данных до точки во времени только для одного клиента.

## <a name="f-multi-tenant-app-with-sharded-multi-tenant-databases"></a>F. Мультитенантное приложение с сегментированными мультитенантными базами данных

Большинство приложений SaaS получают доступ к данным только одного клиента за раз.  Этот шаблон доступа позволяет распределять данные клиента между несколькими базами данных или сегментами, где все данные для любого отдельного клиента содержатся в одном сегменте.  Вместе с шаблоном мультитенантной базы данных сегментированная модель обеспечивает практически неограниченное масштабирование.

![Структура мультитенантного приложения с сегментированными мультитенантными базами данных.][image-mt-app-sharded-mt-db-174s]

#### <a name="manage-shards"></a>Управление сегментами

Сегментирование усложняет проектирование и эксплуатационное управление.  Для поддержки сопоставления между клиентами и базами данных требуется каталог.  Кроме того, процедуры управления необходимы для управления сегментами и заполнения клиента.  Например, должны быть разработаны процедуры для добавления и удаления сегментов, а также перемещения данных клиента между сегментами.  Способом масштабирования является добавление нового сегмента и его заполнение новыми клиентами.  В других случаях можно разделить плотно заполненный сегмент на два менее заполненных сегмента.  После перемещения нескольких клиентов или прекращения их использования можно объединить менее заполненные сегменты.  Так можно достичь более экономически выгодного использования ресурсов.  Клиенты также можно перемещать между сегментами, чтобы распределять рабочую нагрузку.

База данных SQL предоставляет средство разделения и объединения, которое работает в сочетании с библиотекой сегментирования и базой данных каталога.  Предоставленное приложение может разделять, объединять сегменты и перемещать между ними данные клиента.  Приложение также поддерживает каталог во время выполнения этих операций, помечая затронутые клиенты как автономные перед их перемещением.  После перемещения каталог снова обновляется и образуется новое сопоставление, а отмеченный клиент снова становится активным.

#### <a name="smaller-databases-more-easily-managed"></a>Небольшими базами данных проще управлять

Распределяя клиенты между несколькими базами данных, сегментированное мультитенантное решение формирует небольшие базы данных, управлять которыми гораздо проще.  Например, восстановление конкретного клиента до предыдущей точки во времени теперь включает восстановление отдельной небольшой базы данных из резервной копии, а не большой базы данных со всеми клиентами. Для балансировки рабочей нагрузки и распределения действий по управлению можно выбрать размер базы данных и количество клиентов на нее.

#### <a name="tenant-identifier-in-the-schema"></a>Идентификатор клиента в схеме

В зависимости от используемого подхода к сегментированию на схему базы данных могут быть наложены дополнительные ограничения.  Приложение разделения и объединения базы данных SQL требует, чтобы схема включала ключ сегментирования, которым обычно является идентификатор клиента.  Идентификатор клиента является ведущим элементом в первичном ключе всех сегментированных таблиц.  Он позволяет приложению разделения и объединения быстро найти и переместить данные, связанные с конкретным клиентом.

#### <a name="elastic-pool-for-shards"></a>Эластичный пул для сегментов

Сегментированные мультитенантные базы данных можно поместить в эластичные пулы.  Как правило, наличие нескольких однотенантных баз данных в пуле так же экономически выгодно, как и наличие нескольких клиентов в нескольких мультитенантных базах данных.  Мультитенантные базы данных выгодны, если имеется большое число относительно неактивных клиентов.

## <a name="g-hybrid-sharded-multi-tenant-database-model"></a>Ж. Гибридная модель сегментированной мультитенантной базы данных

В гибридной модели все базы данных содержат идентификатор клиента в своей схеме.  Все базы данных могут хранить более одного клиента, и их можно сегментировать.  Таким образом, в рамках схемы все они являются мультитенантными базами данных.  Однако на практике некоторые из этих баз данных содержат только один клиент.  Тем не менее количество клиентов, хранящихся в определенной базе данных, не оказывает влияния на схему базы данных.

#### <a name="move-tenants-around"></a>Перемещение клиентов

Вы можете переместить конкретный клиент в его собственную мультитенантную базу данных в любое время.  И также в любой момент можно изменить свое решение и переместить клиент обратно в базу данных, в которой содержится несколько клиентов.  При подготовке новой базы данных можно также назначить клиент новой однотенантной базе данных.

Гибридная модель оптимальна, когда присутствуют большие различия в отношении потребностей ресурсов в идентифицируемых группах клиентов.  Предположим, что клиенты, доступные в бесплатной пробной версии, не гарантируют такой же высокий уровень производительности, как клиенты в подписке.  Политика для клиентов на этапе бесплатной пробной версии должна храниться в мультитенантной базе данных, которая совместно используется всеми клиентами бесплатной пробной версии.  Когда клиент бесплатной пробной версии подписывается на базовый уровень обслуживания, его можно переместить в другую мультитенантную базу данных с меньшим количеством клиентов.  Подписчика, который приобретает уровень обслуживания "Премиум", можно переместить в его собственную новую однотенантную базу данных.

#### <a name="pools"></a>Пулы

В этой гибридной модели однотенантные базы данных для клиентов подписчика можно поместить в пулы ресурсов, чтобы снизить затраты на однотенантную базу данных.  Это также актуально для модели однотенантной базы данных.

## <a name="h-tenancy-models-compared"></a>З. Сравнение клиентских моделей

В следующей таблице приведены различия между основными клиентскими моделями.

| Измерения | Изолированное приложение | Однотенантная база данных | Сегментированная мультитенантная база данных |
| :---------- | :------------- | :------------------ | :------------------- |
| Масштаб | Средний<br />1–100 | Очень высокая<br />1–100 000 | Без ограничений<br />1–1 000 000 |
| Изоляция клиентов | Очень высокая | Высокий | Низкая. За исключением одноэлементного клиента (одного в базе данных MT). |
| Стоимость на базу данных для каждого клиента | Высокая. Размер зависит от пиков. | Низкая. Используются пулы. | Наименьшая. Для небольших клиентов в базах данных MT. |
| Мониторинг производительности и управление ею | Только для каждого клиента | Общая статистическая обработка + для каждого клиента | Статистическая обработка. Для каждого клиента только для одноэлементных экземпляров. |
| Сложность разработки | Низкий | Низкий | Средняя из-за сегментирования. |
| Сложность эксплуатации | Варьируется от низкой до высокой. Отдельные клиенты — низкая, высокая при масштабировании. | Варьируется от низкой до средней. Сложность зависит от масштабирования. | Варьируется от низкой до высокой. Сложное управление отдельным клиентом. |
| &nbsp; ||||

## <a name="next-steps"></a>Дополнительная информация

- [Deploy and explore a multi-tenant SaaS application that uses the database per tenant pattern with Azure SQL Database][docu-sql-db-saas-tutorial-deploy-wingtip-db-per-tenant-496y] (Развертывание и изучение мультитенантного приложения SaaS, использующего шаблон однотенантной базы данных в базе данных SQL Azure)

- [Знакомство с SaaS-приложением Wingtip Tickets для размещения клиентов в службе "База данных SQL Azure"][docu-saas-tenancy-welcome-wingtip-tickets-app-384w]


<!--  Article link references.  -->

[http-visual-studio-devops-485m]: https://www.visualstudio.com/devops/

[docu-sql-svr-db-row-level-security-947w]: https://docs.microsoft.com/sql/relational-databases/security/row-level-security

[docu-elastic-db-client-library-536r]: sql-database-elastic-database-client-library.md
[docu-sql-db-saas-tutorial-deploy-wingtip-db-per-tenant-496y]: sql-database-saas-tutorial.md
[docu-sql-db-automatic-tuning-771a]: sql-database-automatic-tuning.md
[docu-saas-tenancy-welcome-wingtip-tickets-app-384w]: saas-tenancy-welcome-wingtip-tickets-app.md


<!--  Image references.  -->

[image-standalone-app-st-db-111a]: media/saas-tenancy-app-design-patterns/saas-standalone-app-single-tenant-database-11.png "Структура изолированного приложения с однотенантной базой данных."

[image-mt-app-db-per-tenant-132d]: media/saas-tenancy-app-design-patterns/saas-multi-tenant-app-database-per-tenant-13.png "Структура мультитенантного приложения с однотенантной базой данных."

[image-mt-app-db-per-tenant-pool-153p]: media/saas-tenancy-app-design-patterns/saas-multi-tenant-app-database-per-tenant-pool-15.png "Структура мультитенантного приложения с однотенантной базой данных с использованием эластичного пула."

[image-mt-app-sharded-mt-db-174s]: media/saas-tenancy-app-design-patterns/saas-multi-tenant-app-sharded-multi-tenant-databases-17.png "Структура мультитенантного приложения с сегментированными мультитенантными базами данных."

