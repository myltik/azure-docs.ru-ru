---
title: Последовательные обновления приложений (База данных SQL Azure) | Документация Майкрософт
description: Вы можете узнать, как использовать георепликацию базы данных SQL Azure для поддержки оперативных обновлений облачного приложения.
services: sql-database
author: anosov1960
manager: craigg
ms.service: sql-database
ms.custom: business continuity
ms.topic: conceptual
ms.date: 04/01/2018
ms.author: sashan
ms.openlocfilehash: a73284d679b4be1fbae6d5e1688915c98cbf2392
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34649505"
---
# <a name="managing-rolling-upgrades-of-cloud-applications-using-sql-database-active-geo-replication"></a>Управление последовательными обновлениями для облачных приложений с помощью активной георепликации базы данных SQL
> [!NOTE]
> [Активная георепликация](sql-database-geo-replication-overview.md) теперь доступна для всех баз данных и всех уровней.
> 

Узнайте, как использовать [георепликацию](sql-database-geo-replication-overview.md) в базе данных SQL для установки последовательных обновлений облачного приложения. Так как обновление представляет собой нарушающую работу операцию, оно должно учитываться при планировании и проектировании непрерывности бизнес-процессов. В этой статье мы рассмотрим два разных метода для оркестрации процесса обновления, а также преимущества и недостатки каждой из них. В рамках этой статьи мы используем простое приложение, состоящее из веб-сайта, подключенного к одной базе данных в качестве уровня данных. Наша цель заключается в обновлении версии 1 приложения до версии 2 без значительного влияния на работу пользователей. 

При оценке вариантов обновления необходимо учитывать следующие факторы.

* Влияние на доступность приложения во время обновления. На какой срок допускается ограничение или сокращение функциональности приложения.
* Возможность отката в случае сбоя во время обновления.
* Уязвимость приложения к не связанному с ним разрушительному сбою во время обновления.
* Общие денежные затраты.  Сюда входят затраты на дополнительную избыточность и добавочные затраты на временные компоненты, используемые в процессе обновления. 

## <a name="upgrading-applications-that-rely-on-database-backups-for-disaster-recovery"></a>Обновление приложений, полагающихся на резервные копии базы данных в случае аварийного восстановления
Если приложение полагается на создаваемые автоматически резервные копии базы данных и использует геовосстановление для аварийного восстановления, оно обычно развертывается в одном регионе Azure. В этом случае процесс обновления включает в себя создание резервного развертывания всех компонентов приложения, участвующих в обновлении. Чтобы минимизировать нарушения в работе конечных пользователей, вы воспользуетесь диспетчером трафика Azure (WATM) с профилем отработки отказов.  На приведенной ниже схеме показана рабочая среда до начала процесса обновления. Конечная точка <i>contoso-1.azurewebsites.net</i> представляет рабочий слот приложения, которое необходимо обновить. Чтобы включить возможность отката обновления, необходимо создать промежуточный слот с полностью синхронизированной копией приложения. Для подготовки приложения к обновлению необходимо выполнить следующее.

1. Создайте промежуточный слот для обновления. Для этого создайте базу данных-получатель (1) и разверните идентичный веб-сайт в том же регионе Azure. Осуществляйте ее мониторинг, чтобы определить завершение процесса заполнения.
2. Создайте профиль отработки отказа в WATM, используя <i>contoso-1.azurewebsites.net</i> в качестве работающей конечной точки и <i>contoso-2.azurewebsites.net</i> в качестве отключенной. 

> [!NOTE]
> Обратите внимание, что эти подготовительные меры не затронут приложение в рабочем слоте, поэтому оно может работать в режиме полного доступа.
>  

![Настройка георепликации базы данных SQL. Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option1-1.png)

После завершения этих действий приложение готово к фактическому обновлению. Шаги, входящие в процесс обновления, показаны на приведенной ниже схеме. 

1. Переключите базу данных-источник в рабочем слоте в режиме только для чтения (3). Это гарантирует, что производственный экземпляр приложения (V1) останется доступным только для чтения во время обновления, предотвращая расхождение данных между экземплярами базы данных V1 и V2 .  
2. Отключите базу данных-получатель, используя режим планового завершения (4). При этом создается полностью синхронизированная независимая копия базы данных-источника. Эта база данных будет обновлена.
3. Переключите базу данных-источник в режим чтения и записи, а затем запустите сценарий обновления в промежуточном слоте (5).     

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option1-2.png)

В случае успешного завершения обновления все готово к переключению конечных пользователей на промежуточную копию приложения. Теперь она станет рабочим слотом приложения.  Это включает в себя несколько дополнительных действий, как показано на приведенной ниже схеме.

1. Переключите рабочую конечную точку в профиле WATM на <i>contoso-2.azurewebsites.net</i>, которая указывает на версию V2 веб-сайта (6). Теперь она становится рабочим слотом с приложением V2, куда направляется трафик пользователей.  
2. Если компоненты приложения V1 больше не нужны, их можно удалить (7).   

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option1-3.png)

Если процесс обновления завершается неудачно, например из-за ошибки в сценарии обновления, промежуточный слот следует считать нарушенным. Чтобы выполнить откат приложения до состояния перед обновлением, просто верните приложение в рабочем слоте в режим полного доступа. Соответствующие шаги показаны на приведенной ниже схеме.    

1. Переключите копию базы данных в режим чтения и записи (8). Это восстановит полную функциональность версии V1 в рабочем слоте.
2. Выполните анализ первопричин и удалите скомпрометированные компоненты в промежуточном слоте (9). 

На этом этапе приложение полностью работоспособно, и можно повторить действия по обновлению.

> [!NOTE]
> Откат не требует изменения профиля WATM, так как уже указывает на <i>contoso-1.azurewebsites.net</i> как активную конечную точку.
> 
> 

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option1-4.png)

Ключевым **преимуществом** этого варианта является возможность обновить приложение в одном регионе с помощью набора простых шагов. Денежная стоимость обновления сравнительно мала. Главный **недостаток** заключается в том, что в случае разрушительного сбоя во время обновления для восстановления до состояния перед обновлением потребуется повторное развертывание приложения в другом регионе и восстановление базы данных из резервной копии с помощью геовосстановления. Этот процесс приведет к значительному простою.   

## <a name="upgrading-applications-that-rely-on-database-geo-replication-for-disaster-recovery"></a>Обновление приложений, полагающихся на геовосстановление базы данных в случае аварийного восстановления
Если приложение использует георепликацию для обеспечения непрерывности бизнес-процессов, оно развертывается по крайней мере в двух разных регионах: активное развертывание выполняется в основном регионе и резервное развертывание — в резервном регионе. Помимо упомянутых ранее факторов процесс обновления должен гарантировать следующее.

* Приложение остается защищенным от разрушительного сбоя на протяжении всего обновления.
* Геоизбыточные компоненты приложения обновляются параллельно с активными компонентами.

Для достижения этих целей применяется диспетчер трафика Azure (WATM) с использованием профиля отработки отказа с одной активной и тремя резервными конечными точками.  На приведенной ниже схеме показана рабочая среда до начала процесса обновления. Веб-сайты <i>contoso-1.azurewebsites.net</i> и <i>contoso-dr.azurewebsites.net</i> представляют рабочий слот приложения с полной геоизбыточностью. Чтобы включить возможность отката обновления, необходимо создать промежуточный слот с полностью синхронизированной копией приложения. Так как необходимо убедиться, что приложение можно быстро восстановить в случае разрушительного сбоя во время обновления, промежуточный слот также должен быть геоизбыточным. Для подготовки приложения к обновлению необходимо выполнить следующее.

1. Создайте промежуточный слот для обновления. Для этого создайте базу данных-получатель (1) и разверните идентичную копию веб-сайта в том же регионе Azure. Осуществляйте ее мониторинг, чтобы определить завершение процесса заполнения.
2. Создайте геоизбыточную базу данных-получатель в промежуточном слоте путем георепликации базы данных-получателя в резервную область (это называется "цепной георепликацией"). Осуществляйте мониторинг этой базы данных-получателя, чтобы определить завершение процесса заполнения (3).
3. Создайте резервную копию веб-сайта в резервном регионе и свяжите ее с геоизбыточной базой данных-получателем (4).  
4. Добавьте дополнительные конечные точки <i>contoso-2.azurewebsites.net</i> и <i>contoso-3.azurewebsites.net</i> в профиль отработки отказа в WATM как автономные конечные точки (5). 

> [!NOTE]
> Обратите внимание, что эти подготовительные меры не затронут приложение в рабочем слоте, поэтому оно может работать в режиме полного доступа.
> 
> 

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option2-1.png)

После завершения этих действий промежуточный слот готов к обновлению. Шаги обновления показаны на схеме ниже.

1. Переключите базу данных-источник в рабочем слоте в режиме только для чтения (6). Это гарантирует, что производственный экземпляр приложения (V1) останется доступным только для чтения во время обновления, предотвращая расхождение данных между экземплярами базы данных V1 и V2 .  
2. Отключите базу данных-получатель в том же регионе, используя режим планового завершения (7). При этом создается полностью синхронизированная независимая копия базы данных-источника, которая автоматически становится основной после завершения. Эта база данных будет обновлена.
3. Переключите базу данных-источник в промежуточном слоте в режим чтения и записи и запустите сценарий обновления (8).    

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option2-2.png)

В случае успешного завершения обновления все готово к переключению конечных пользователей на версию V2 приложения. Соответствующие шаги показаны на схеме ниже.

1. Переключите активную конечную точку в профиле WATM на <i>contoso-2.azurewebsites.net</i>, которая теперь указывает на версию V2 веб-сайта (9). Теперь она становится рабочим слотом с приложением V2, куда направляется трафик конечных пользователей. 
2. Если приложение V1 больше не нужно, его можно удалить (10 и 11).  

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option2-3.png)

Если процесс обновления завершается неудачно, например из-за ошибки в сценарии обновления, промежуточный слот следует считать нарушенным. Чтобы выполнить откат приложения до состояния перед обновлением, просто вернитесь к использованию приложения в рабочем слоте в режиме полного доступа. Соответствующие шаги показаны на приведенной ниже схеме.    

1. Переключите копию базы данных-источника в рабочем слоте в режиме только чтения и записи (12). Это восстановит полную функциональность версии V1 в рабочем слоте.
2. Выполните анализ первопричин и удалите скомпрометированные компоненты в промежуточном слоте (13 и 14). 

На этом этапе приложение полностью работоспособно, и можно повторить действия по обновлению.

> [!NOTE]
> Откат не требует изменения профиля WATM, так как уже указывает на <i>contoso-1.azurewebsites.net</i> как активную конечную точку.
> 
> 

![Настройка георепликации базы данных SQL Аварийное восстановление облака.](media/sql-database-manage-application-rolling-upgrade/Option2-4.png)

Ключевым **преимуществом** этого варианта является возможность параллельно обновить приложение и его геоизбыточную копию, не нарушая непрерывность бизнес-процессов во время обновления. Главный **недостаток** заключается в двукратной избыточности каждого компонента приложения, что влечет за собой повышенную стоимость. Кроме того, этот вариант подразумевает более сложный рабочий процесс. 

## <a name="summary"></a>Сводка
Два описанных здесь метода обновления отличаются по сложности и стоимости, но они оба позволяют минимизировать то время, когда конечный пользователь будет ограничен только операциями чтения. Это время напрямую зависит от длительности выполнения сценария обновления. Оно не зависит от размера базы данных, выбранного уровня обслуживания, конфигурация веб-сайта и других факторов, которыми нелегко управлять. Это достигается за счет того, что подготовительные шаги отделены от действий по обновлению и могут выполняться, не влияя на рабочее приложение. Эффективность сценария обновления является ключевым фактором, определяющий взаимодействие с конечным пользователем во время обновления. Поэтому для улучшения всей процедуры рекомендуется сосредоточиться на повышении эффективности сценария обновления.  

## <a name="next-steps"></a>Дополнительная информация
* Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).
* Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
* Чтобы узнать об использовании автоматически создаваемых резервных копий для восстановления, ознакомьтесь со сведениями о [восстановлении базы данных из резервных копий, инициируемых службой](sql-database-recovery-using-backups.md).
* Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями об [активной георепликации](sql-database-geo-replication-overview.md).


