---
title: Руководство по мультитенантному приложению SaaS, использующему базу данных SQL Azure | Документация Майкрософт
description: Подготовка новых клиентов и их каталогизация при помощи шаблона изолированного приложения
keywords: руководство по базе данных sql
services: sql-database
author: stevestein
manager: craigg
ms.service: sql-database
ms.custom: SaaS
ms.topic: conceptual
ms.date: 01/31/2018
ms.author: billgib
ms.openlocfilehash: 0f2495ddc5d5053582d67bd44cdf80d018f79e42
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34646159"
---
# <a name="provision-and-catalog-new-tenants-using-the--application-per-tenant-saas-pattern"></a>Подготовка новых клиентов и их каталогизация при помощи шаблона однотенантного приложения SaaS

В этой статье рассматривается подготовка и каталогизация новых клиентов при помощи шаблона однотенантного приложения SaaS.
Эта статья состоит из двух основных частей:
* Основное описание подготовки и каталогизации новых клиентов.
* Руководство, в котором приведен пример кода PowerShell, выполняющего подготовку и каталогизацию.
    * В руководстве используется пример приложения SaaS Wingtip Tickets, адаптированного для шаблона однотенантного приложения.

## <a name="standalone-application-per-tenant-pattern"></a>Шаблон однотенантного изолированного приложения
Шаблон изолированного однотенантного приложения относится к шаблонам мультитенантных приложений SaaS.  В этом шаблоне изолированное приложение подготавливается для каждого клиента. Приложение состоит из компонентов уровня приложения и базы данных SQL.  Каждое приложение клиента можно развернуть в подписке поставщика.  Кроме того, Azure предлагает [программу управляемых приложений](https://docs.microsoft.com/azure/managed-applications/overview), в которой приложение может развертываться в подписке клиента и управляться поставщиком от его имени. 

   ![Шаблон однотенантного приложения](media/saas-standaloneapp-provision-and-catalog/standalone-app-pattern.png)

При развертывании приложение и база данных подготавливаются в новой группе ресурсов, созданной для клиента.  Использование отдельных групп ресурсов позволяет изолировать ресурсы каждого клиента и управлять ими независимо. В каждой группе ресурсов экземпляр приложения настраивается для прямого доступа к соответствующей базе данных.  Эта модель подключения отличается от других шаблонов, которые используют каталог в качестве посредника подключений между приложением и базой данных.  Так как отсутствует совместное использование ресурсов, каждую базу данных клиента следует подготовить с достаточными ресурсами для обработки пиковой нагрузки. Этот шаблон обычно используется для приложений SaaS с меньшим количеством клиентов, где упор делается на изоляцию клиентов и меньше внимания уделяется затратам ресурсов.  

## <a name="using-a-tenant-catalog-with-the-application-per-tenant-pattern"></a>Использование каталога клиента с шаблоном однотенантного приложения
Так как каждое приложение и база данных каждого клиента полностью изолированы, различные сценарии управления и анализа могут работать во всех клиентах.  Например, для изменения схемы нового выпуска приложения требуются изменения в схеме каждой базы данных клиента. В сценариях отчетов и аналитики также может требоваться доступ ко всем базам данных клиентов, независимо от того, где они развернуты.

   ![Шаблон однотенантного приложения](media/saas-standaloneapp-provision-and-catalog/standalone-app-pattern-with-catalog.png)

Каталог клиента содержит сопоставление между идентификатором клиента и базой данных клиента, что позволяет разрешать идентификатор для сервера и имени базы данных.  В приложении Wingtip SaaS идентификатор клиента вычисляется как хэш имени клиента, хотя могут использоваться другие схемы.  Изолированным приложениям не требуется каталог для управления подключениями. Каталог может использоваться, чтобы определить область действий в наборе баз данных клиента. Например, эластичный запрос может использовать каталог для определения набора баз данных, в которых распространяются запросы для формирования отчетов между клиентами.

## <a name="elastic-database-client-library"></a>Клиентская библиотека эластичной базы данных
Каталог в примере приложения Wingtip реализуется с помощью функций управления сегментами в [клиентской библиотеке эластичной базы данных (EDCL)](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library).  Библиотека позволяет приложению создавать, администрировать и использовать карту сегментов, которая хранится в базе данных. В примере Wingtip Tickets каталог хранится в базе данных *каталогов клиента*.  Сегмент сопоставляет ключ клиента с сегментом (база данных), в котором хранятся данные клиента.  Функции EDCL управляют *глобальной картой сегментов*, которая хранится в таблицах базы данных *каталогов клиента*, и *локальной картой*, хранящейся в каждом сегменте.

Функции EDCL можно использовать в приложениях или сценариях PowerShell, чтобы создавать и управлять записями в карте сегментов. Другие функции EDCL могут использоваться для извлечения набора сегментов или подключения к правильной базе данных определенного ключа клиента. 
    
> [!IMPORTANT] 
> Не изменяйте данные в базе данных каталога или локальной карте сегментов непосредственно в базе данных клиента. Прямые обновления не поддерживаются из-за высокого риска повреждения данных. Вместо этого измените данные сопоставления с использованием только API-интерфейсов EDCL.

## <a name="tenant-provisioning"></a>Подготовка клиента 
Для каждого клиента требуется новая группа ресурсов Azure, которая должна быть создана перед подготовкой в ней ресурсов. После создания группы ресурсов для развертывания компонентов приложения и базы данных можно использовать шаблон управления ресурсами Azure, а затем настроить соединение с базой данных. Чтобы инициализировать схему базы данных, шаблон может импортировать BACPAC-файл.  Кроме того, база данных может быть создана как копия базы данных шаблона.  Затем в базе данных будут дополнительно обновлены ​​изначальные данные о месте мероприятия, а база данных зарегистрирована в каталоге.

## <a name="tutorial"></a>Учебник

Из этого руководства вы узнали, как выполнять такие задачи:
* Подготовка каталога
* Регистрация примеров баз данных клиента, развернутых ранее в каталоге.
* Подготовка дополнительных клиентов и их регистрация в каталоге

Шаблон Azure Resource Manager используется для развертывания и настройки приложения, создания базы данных клиента и последующего импорта BACPAC-файла для его инициализации. Запрос на импорт может быть поставлен в очередь в течение нескольких минут до выполнения.

В конце работы с этим руководством у вас будет набор изолированных однотенантных приложений, базы данных которых будут зарегистрированы в каталоге.

## <a name="prerequisites"></a>предварительным требованиям
Для работы с этим руководством выполните следующие предварительные требования: 
* Установите Azure PowerShell. Дополнительные сведения см. в статье [Начало работы с Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps).
* Разверните три примера приложений для клиента. Вы можете развернуть их менее чем за пять минут, используя инструкцию из статьи [Развертывание и изучение отдельного однотенантного приложения, в котором используется база данных SQL Azure](https://docs.microsoft.com/azure/sql-database/saas-standaloneapp-get-started-deploy).

## <a name="provision-the-catalog"></a>Подготовка каталога
В этой задаче вы узнаете, как создать каталог, используемый для регистрации всех баз данных клиента. Вы сможете выполнять следующие задачи: 
* **Подготовка базы данных каталога** с помощью шаблона управления ресурсами Azure. База данных инициализируется путем импорта BACPAC-файла.  
* **Регистрация примеров приложений для клиента**, развернутых ранее.  Каждый клиент регистрируется с использованием ключа, созданного на основе хэша имени клиента.  Имя клиента также сохраняется в таблице расширений каталога.

1. В интегрированной среде сценариев PowerShell откройте файл *...\Learning Modules\UserConfig.psm* и замените значение **\<user\>** на значение, используемое при развертывании трех примеров приложений.  **Сохраните файл**.  
1. В интегрированной среде сценариев PowerShell откройте файл *...\Learning Modules\ProvisionTenants\Demo-ProvisionAndCatalog.ps1* и установите значение **$Scenario = 1**. Разверните каталог клиента и зарегистрируйте заранее определенные клиенты.

1. Добавьте точку останова, поместив курсор в любом месте строки 38, содержащей `& $PSScriptRoot\New-Catalog.ps1`, а затем нажмите клавишу **F9**.

    ![настройка точки останова для трассировки](media/saas-standaloneapp-provision-and-catalog/breakpoint.png)

1. Запустите сценарий, нажав клавишу **F5**. 
1.  После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить сценарий New-Catalog.ps1.
1.  Отслеживайте выполнение сценария и используйте клавиши F10 и F11 (меню Отладка), чтобы обойти вызываемые функции или перейти в них по очереди.
    *   Дополнительные сведения об отладке сценариев PowerShell см. в разделе [Отладка сценариев в интегрированной среде сценариев Windows PowerShell](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).

После завершения сценария будет создан каталог, а все примеры клиентов будут зарегистрированы. 

Теперь посмотрим на созданные ресурсы.

1. Войдите на [портал Azure](https://portal.azure.com/) и перейдите к группам ресурсов.  Откройте группу ресурсов **wingtip-sa-catalog-\<user\>** и запишите сервер каталога и базу данных.
1. Откройте базу данных на портале и выберите *обозреватель данных* в левом меню.  Щелкните команду для входа, а затем введите пароль **P@ssword1**.


1. Изучите схему базы данных *tenantcatalog*.  
   * Объекты в схеме `__ShardManagement` предоставляются клиентской библиотекой эластичной базы данных.
   * Таблица `Tenants` и представление `TenantsExtended` — это расширения, добавленные в пример, которые демонстрируют, как вы можете расширить каталог для использования дополнительных значений.
1. Выполните запрос `SELECT * FROM dbo.TenantsExtended`.          

   ![Обозреватель данных](media/saas-standaloneapp-provision-and-catalog/data-explorer-tenantsextended.png)

    В качестве альтернативы использованию обозревателя данных вы можете подключиться к базе данных из SQL Server Management Studio. Для этого подключитесь к серверу wingtip- 

    
    Обратите внимание, что не следует изменять данные непосредственно в каталоге. Для этого следует использовать API-интерфейсы управления сегментами. 

## <a name="provision-a-new-tenant-application"></a>Подготовка нового приложения для клиента

В этой задаче вы узнаете, как подготовить однотенантное приложение. Вы сможете выполнять следующие задачи:  
* **Создание группы ресурсов** для клиента. 
* **Подготовка приложения и базы данных** в новой группе ресурсов с помощью шаблона управления ресурсами Azure.  Это действие включает в себя инициализацию базы данных с помощью общей схемы и справочных данных путем импорта BACPAC-файла. 
* **Инициализация базы данных с помощью основных сведений клиента**. Это действие включает в себя указание типа места мероприятия, которое определяет фотографию, используемую в качестве фона на веб-сайте событий. 
* **Регистрация базы данных в базе данных каталога**. 

1. В интегрированной среде сценариев PowerShell откройте файл *...\Learning Modules\ProvisionTenants\Demo-ProvisionAndCatalog.ps1* и установите значение **$Scenario = 2**. Разверните каталог клиента и зарегистрируйте заранее определенные клиенты.

1. Добавьте точку останова в сценарий, поместив курсор в любом месте строки 49, содержащей `& $PSScriptRoot\New-TenantApp.ps1`, а затем нажмите клавишу **F9**.
1. Запустите сценарий, нажав клавишу **F5**. 
1.  После остановки выполнения сценария в точке останова нажмите клавишу **F11**, чтобы пошагово выполнить сценарий New-Catalog.ps1.
1.  Отслеживайте выполнение сценария и используйте клавиши F10 и F11 (меню Отладка), чтобы обойти вызываемые функции или перейти в них по очереди.

После подготовки клиента откроется веб-сайт нового клиента событий.

   ![гонка red maple](media/saas-standaloneapp-provision-and-catalog/redmapleracing.png)

Затем можно проверить новые ресурсы, созданные на портале Azure. 

   ![ресурсы гонки red maple](media/saas-standaloneapp-provision-and-catalog/redmapleracing-resources.png)


## <a name="to-stop-billing-delete-resource-groups"></a>Чтобы остановить выставление счетов, удалите группы ресурсов. ##

Изучив пример, удалите все созданные группы ресурсов, чтобы остановить соответствующее выставление счетов.

## <a name="additional-resources"></a>Дополнительные ресурсы

- Дополнительные сведения о приложениях SaaS для мультитенантных приложений см. в статье [Мультитенантные шаблоны клиента в базе данных SaaS](saas-tenancy-app-design-patterns.md).

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали следующее:

> [!div class="checklist"]
> * как развернуть изолированное SaaS-приложение Wingtip Tickets;
> * сведения о серверах и базах данных, формирующих приложение;
> * как удалить примеры ресурсов, чтобы не оплачивать их.

Вы можете узнать, как используется каталог для поддержки различных межклиентских сценариев, с помощью версии [приложения SaaS Wingtip Tickets](https://docs.microsoft.com/azure/sql-database/saas-dbpertenant-wingtip-app-overview), использующей одну базу данных на клиент.  
