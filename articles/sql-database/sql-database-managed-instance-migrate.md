---
title: Перенос экземпляра SQL Server в Управляемый экземпляр Базы данных SQL Azure | Документация Майкрософт
description: Сведения о переносе экземпляра SQL Server в Управляемый экземпляр Базы данных SQL Azure.
keywords: миграция базы данных, миграция базы данных SQL Server, средства миграции базы данных, миграция базы данных, миграция базы данных SQL
services: sql-database
author: bonova
ms.reviewer: carlrab
manager: craigg
ms.service: sql-database
ms.custom: managed instance
ms.topic: conceptual
ms.date: 04/10/2018
ms.author: bonova
ms.openlocfilehash: 8f666bc352dc1706da4812590f85adc7695e2f13
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34647668"
---
# <a name="sql-server-instance-migration-to-azure-sql-database-managed-instance"></a>Перенос экземпляра SQL Server в Управляемый экземпляр Базы данных SQL Azure

В этой статье вы узнаете о методах переноса экземпляра SQL Server 2005 или более поздней версии в Управляемый экземпляр Базы данных SQL Azure (предварительная версия). 

Управляемый экземпляр Базы данных SQL — это расширение имеющейся службы "База данных SQL", которое кроме отдельных баз данных и эластичных пулов предлагает и третий вариант развертывания.  С его помощью можно выполнять перенос базы данных методом lift-and-shift в полностью управляемое приложение PaaS, не изменяя его. Управляемый экземпляр Базы данных SQL Azure обеспечивает высокую совместимость с моделью программирования локального SQL Server и реализацию поддержки большинства возможностей, дополнительных инструментов и служб SQL Server.

Общий процесс переноса приложения выглядит, как показано на следующей схеме.

![процесс переноса](./media/sql-database-managed-instance-migration/migration-process.png)

- [Оценка совместимости управляемого экземпляра](sql-database-managed-instance-migrate.md#assess-managed-instance-compatibility)
- [Выбор варианта подключения к приложению](sql-database-managed-instance-migrate.md#choose-app-connectivity-option)
- [Развертывание в управляемый экземпляр оптимального размера](sql-database-managed-instance-migrate.md#deploy-to-an-optimally-sized-managed-instance)
- [Выбор метода переноса и выполнение переноса](sql-database-managed-instance-migrate.md#select-migration-method-and-migrate)
- [Мониторинг приложений](sql-database-managed-instance-migrate.md#monitor-applications)

> [!NOTE]
> Сведения о переносе отдельной базы данных в базу данных или эластичный пул см. в статье [Миграция базы данных SQL Server в базу данных SQL в облаке](sql-database-cloud-migrate.md).

## <a name="assess-managed-instance-compatibility"></a>Оценка совместимости управляемого экземпляра

Сначала определите, соответствует ли управляемый экземпляр требованиям к базе данных вашего приложения. Управляемый экземпляр предназначен для обеспечения простого переноса методом lift-and-shift для большинства имеющихся приложений, которые используют SQL Server локально или на виртуальных машинах. Однако иногда вам могут потребоваться еще не поддерживаемые функции или возможности, а затраты на реализацию обходного пути слишком высоки. 

Используйте [Data Migration Assistant (DMA)](https://docs.microsoft.com/sql/dma/dma-overview) для выявления потенциальных проблем совместимости, влияющих на функциональность базы данных в службе "База данных SQL Azure". DMA еще не поддерживает управляемый экземпляр в качестве назначения миграции, однако мы рекомендуем выполнить оценку базы данных SQL Azure, внимательно просмотреть список обнаруженных проблем равенства функций и совместимости, сравнимая с документацией по продукту. Большинство блокирующих проблем, препятствующих переносу в базу данных SQL Azure, были устранены с выпуском управляемого экземпляра. Например, в управляемых экземплярах доступны такие функции, как запросы и транзакции между базами данных в одном экземпляре, связывание сервера с другими источниками SQL, поддержка общеязыковой среды выполнения (CLR), глобальные временные таблицы, представления уровня экземпляра и Service Broker. 

Однако в некоторых случаях вам нужно будет использовать альтернативный вариант, например [SQL Server на виртуальных машинах в Azure](https://azure.microsoft.com/services/virtual-machines/sql-server/). Ниже приведены некоторые примеры:

- Если вам необходим прямой доступ к ОС или файловой системе, например, для установки сторонних или настраиваемых агентов на одной и той же виртуальной машине с SQL Server.
- Если у вас есть строгая зависимость от функций, которые все еще не поддерживаются, например FileStream или FileTable, PolyBase и транзакции между несколькими экземплярами.
- Если вам необходимо использовать только определенную версию SQL Server (например, 2012).
- Если ваши требования к вычислению намного ниже предлагаемых управляемым экземпляром в общедоступной предварительной версии (например, одно виртуальное ядро), а консолидация базы данных неприемлема.

## <a name="deploy-to-an-optimally-sized-managed-instance"></a>Развертывание в управляемый экземпляр оптимального размера

Управляемый экземпляр предназначен для локальных рабочих нагрузок, которые планируется перенести в облако. Он представляет новую модель приобретения, которая обеспечивает большую гибкость при выборе правильного уровня ресурсов для рабочих нагрузок. В локальной среде вы, вероятно, изменяли размер этих рабочих нагрузок с помощью физических ядер. Новая модель приобретения для управляемого экземпляра основана на виртуальных ядрах, а дополнительное хранилище и операции ввода-вывода доступны отдельно. Модель на основе виртуального ядра — это более простой способ понять требования к вычислению в облаке по сравнению с используемым в локальной среде. Эта новая модель позволяет выбирать оптимальный размер целевой среды в облаке.

Вы можете выбрать ресурсы вычисления и хранения во время развертывания, а затем изменить их без простоя для вашего приложения.

![изменение размера управляемого экземпляра](./media/sql-database-managed-instance-migration/managed-instance-sizing.png)

Сведения о создании инфраструктуры виртуальной сети и управляемого экземпляра см. в статье [Создание управляемого экземпляра базы данных SQL Azure на портале Azure](sql-database-managed-instance-create-tutorial-portal.md).

> [!IMPORTANT]
> Важно, чтобы целевая виртуальная сеть и подсеть всегда соответствовали [требованиям к виртуальной сети управляемого экземпляра](sql-database-managed-instance-vnet-configuration.md#requirements). Любая несовместимость может помешать созданию новых экземпляров или использованию созданных.

## <a name="select-migration-method-and-migrate"></a>Выбор метода переноса и выполнение переноса

Управляемый экземпляр предназначен для пользовательских сценариев, требующих массового переноса баз данных из реализаций локальной базы данных или базы данных IaaS. Они являются оптимальным выбором, если вам нужно выполнить перенос методом lift-and-shift для серверной части приложение, которая регулярно используют уровень экземпляра и (или) межбазовые функции. В этом случае вы можете переместить весь экземпляр в соответствующую среду в Azure без необходимости изменять архитектуру приложения. 

Чтобы переместить экземпляры SQL, необходимо тщательно спланировать следующее:

-   Перенос всех баз данных, которые должны быть размещены совместно (те, которые выполняются в одном экземпляре).
-   Перенос объектов уровня экземпляра, от которых зависит ваше приложение, включая имена для входа, учетные данные, операторы и задания агентов SQL, а также триггеры уровня сервера. 

Управляемый экземпляр — это полностью управляемая служба, позволяющая выполнять некоторые из обычных действий администратора базы данных на платформе, так как они встроены. Поэтому некоторые данные уровня экземпляра не нужно переносить (например, задания обслуживания для регулярных резервных копий или конфигурацию Always On). [Высокий уровень доступности](sql-database-high-availability.md) обеспечивается по умолчанию.

Управляемый экземпляр поддерживает следующие варианты переноса базы данных (в настоящее время это единственные поддерживаемые методы переноса).

- Azure Database Migration Service — миграция выполняется практически без простоев.
- Исходное восстановление из URL-адреса — используются исходные резервные копии из SQL Server. Использование этого метода сопряжено с некоторым простоем.
- Миграция с помощью BACPAC-файла — используется BACPAC-файл из SQL Server или базы данных SQL. Использование этого метода сопряжено с некоторым простоем.

### <a name="azure-database-migration-service"></a>Azure Database Migration Service

[Azure Database Migration Service (DMS)](../dms/dms-overview.md) — это полностью управляемая служба, которая выполняет непрерывную миграцию из множества источников баз данных на платформы данных Azure с минимальным временем простоя. Эта служба упрощает выполнение задач, необходимых для перемещения имеющихся сторонних баз данных и баз данных SQL Server в Azure. Варианты развертывания в общедоступной предварительной версии включают базу данных SQL Azure, управляемый экземпляр и SQL Server на виртуальной машине Azure. DMS — это рекомендуемый метод переноса для корпоративных рабочих нагрузок. 

Дополнительные сведения об этом сценарии и шагах настройки для DMS см. в статье [Migrate SQL Server to Azure SQL Database Managed Instance](../dms/tutorial-sql-server-to-managed-instance.md) (Перенос SQL Server в Управляемый экземпляр Базы данных SQL Azure).  

### <a name="native-restore-from-url"></a>Исходное восстановление из URL-адреса

Восстановление исходных резервных копий (BAK-файлов), взятых из локального SQL Server или [SQL Server на виртуальных машинах](https://azure.microsoft.com/services/virtual-machines/sql-server/), доступно в [службе хранилища Azure](https://azure.microsoft.com/services/storage/). Это одна из ключевых возможностей в управляемом экземпляре базы данных SQL. Она обеспечивает быстрое и простое перемещение базы данных в автономном режиме. 

На следующей схеме показан общий процесс переноса:

![последовательность переноса](./media/sql-database-managed-instance-migration/migration-flow.png)

В следующей таблице представлена дополнительная информация о методе, который вы можете использовать в зависимости от используемой исходной версии SQL Server.

|Шаг|Ядро и версия SQL|Метод резервного копирования и восстановления|
|---|---|---|
|Помещение резервной копии в службу хранилища Azure|Версия до SQL 2012 SP1 CU2|Переча BAK-файла непосредственно в службу хранилища Azure|
||От 2012 SP1 CU2 до 2016|Прямое резервное копирование с использованием устаревшего синтаксиса [WITH CREDENTIAL](https://docs.microsoft.com/sql/t-sql/statements/restore-statements-transact-sql)|
||2016 и более поздние версии|Прямое резервное копирование с использованием синтаксиса [WITH SAS CREDENTIAL](https://docs.microsoft.com/sql/relational-databases/backup-restore/sql-server-backup-to-url)|
|Восстановление из службы хранилища Azure в управляемый экземпляр|[Восстановление на основе URL-адреса с помощью учетных данных SAS](sql-database-managed-instance-restore-from-backup-tutorial.md)|

> [!IMPORTANT]
> Восстановление системных баз данных не поддерживается. Чтобы перенести объекты уровня экземпляра (хранящиеся в базах данных master или msdb), рекомендуем создать для них скрипт и запустить скрипты T-SQL в экземпляре среды назначения.

Полное руководство со сведениями о восстановлении резервной копии базы данных в управляемый экземпляр с использованием учетных данных SAS см. в статье [Восстановление резервной копии базы данных в Управляемый экземпляр Базы данных SQL Azure](sql-database-managed-instance-restore-from-backup-tutorial.md).

### <a name="migrate-using-bacpac-file"></a>Перенос с помощью BACPAC-файла

Вы можете создать копию исходной базы данных в BACPAC-файле и импортировать ее базу данных SQL Azure и управляемый экземпляр. См. раздел [Импорт BACPAC-файла в новую базу данных SQL Azure](sql-database-import.md).

## <a name="monitor-applications"></a>Мониторинг приложений

Отследите поведение и производительность приложения после переноса. Некоторые изменения в управляемом экземпляре активируются только после [изменения уровня совместимости базы данных](https://docs.microsoft.com/sql/relational-databases/databases/view-or-change-the-compatibility-level-of-a-database). При переносе базы данных в базу данных SQL Azure в большинстве случаев сохраняется первоначальный уровень совместимости. Если уровень совместимости пользовательской базы данных до переноса был равен 100 или выше, он остается неизменным после переноса. Если он был равен 90, в обновленной базе данных уровень совместимости будет равен 100. Это самый низкий уровень совместимости в управляемом экземпляре. Уровень совместимости системных баз данных равен 140.

Чтобы уменьшить риски, связанные с переносом, измените уровень совместимости базы данных только после мониторинга производительности. Используйте хранилище запросов в качестве оптимального средства для получения информации о производительности рабочей нагрузки до и после изменения уровня совместимости базы данных, как описано в разделе [Поддержание стабильной производительности во время обновления до новой версии SQL Server](https://docs.microsoft.com/sql/relational-databases/performance/query-store-usage-scenarios#CEUpgrade).

Когда вы перейдете на полностью управляемую платформу, вам будут доступны возможности, которые предоставляются автоматически как часть службы "База данных SQL". Например, вам не нужно будет создавать резервные копии в управляемом экземпляре — служба автоматически выполняет резервное копирование. Вам больше не нужно будет контролировать планирование, создание резервных копий и управление ими. Благодаря возможности [восстановления на определенный момент времени](sql-database-recovery-using-backups.md#point-in-time-restore) управляемый экземпляр позволяет восстанавливать данные на любой момент времени в пределах этого срока хранения. На время действия общедоступной предварительной версии срок хранения составляет семь дней.
Кроме того, вам не нужно будет настраивать высокой уровень доступности, так как [он](sql-database-high-availability.md) встроен.

Чтобы повысить уровень безопасности, рассмотрите возможность использования следующих доступных функций:
- проверка подлинности Azure Active Directory на уровне базы данных;
- аудит и обнаружение угроз для мониторинга действий;
- управление доступом к конфиденциальным и привилегированным данным ([безопасность на уровне строк](https://docs.microsoft.com/sql/relational-databases/security/row-level-security) и [динамическое маскирование данных](https://docs.microsoft.com/sql/relational-databases/security/dynamic-data-masking)).

## <a name="next-steps"></a>Дополнительная информация

- Сведения об управляемом экземпляре см. в статье [Общие сведения об Управляемом экземпляре Базы данных SQL Azure (предварительная версия)](sql-database-managed-instance.md).
- Руководство со сведениями о восстановлении из резервной копии см. в статье [Создание управляемого экземпляра базы данных SQL Azure на портале Azure](sql-database-managed-instance-create-tutorial-portal.md).
- Руководство по миграции с помощью DMS см. в статье [Migrate SQL Server to Azure SQL Database Managed Instance](../dms/tutorial-sql-server-to-managed-instance.md) (Перенос SQL Server в Управляемый экземпляр Базы данных SQL Azure).  
