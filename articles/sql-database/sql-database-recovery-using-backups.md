---
title: Восстановление базы данных SQL Azure из резервной копии | Документация Майкрософт
description: В этой статье описывается функция восстановления до точки во времени, позволяющая откатить Базу данных Azure SQL до состояния на момент времени в прошлом (до 35 дней).
services: sql-database
author: anosov1960
manager: craigg
ms.service: sql-database
ms.custom: business continuity
ms.topic: article
ms.date: 04/04/2018
ms.author: sashan
ms.reviewer: carlrab
ms.openlocfilehash: f40bd7954bbf079c87f8312bff731b68d1acb7dc
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32192770"
---
# <a name="recover-an-azure-sql-database-using-automated-database-backups"></a>Восстановление базы данных Azure SQL с помощью создаваемых автоматически резервных копий
База данных SQL предоставляет такие варианты восстановления базы данных с помощью [создаваемых автоматически резервных копий баз данных](sql-database-automated-backups.md) и [резервных копий в хранилище с включенной функцией долгосрочного хранения](sql-database-long-term-retention.md) Вы можете восстановить из резервной копии базы данных следующее:

* Новую базу данных на том же логическом сервере, восстановленную до указанной точки во времени в пределах срока хранения. 
* Базу данных на том же логическом сервере, восстановленную до момента удаления, если исходная база данных была удалена.
* Новую базу данных на любом логическом сервере в любом регионе, восстановленную до точки во времени последней ежедневной резервной копии в геореплицированном хранилище BLOB-объектов (RA-GRS).

> [!IMPORTANT]
> При восстановлении существующую базу данных невозможно перезаписать.
>

За восстановленную базу данных взимается дополнительная оплата за хранилище при следующих условиях. 
- Восстановление P11–P15 в S4–S12 или P1–P6, если максимальный размер базы данных превышает 500 ГБ.
- Восстановление P1–P6 в S4–S12, если максимальный размер базы данных превышает 250 ГБ.

Дополнительная плата связана с тем, что максимальный размер восстановленной базы данных превышает объем хранилища для уровня производительности. За все дополнительные ресурсы хранилища, подготовленные сверх включенного объема, взимается дополнительная плата.  Сведения о ценах на дополнительное хранилище см. на [странице цен на Базу данных SQL](https://azure.microsoft.com/pricing/details/sql-database/).  Если фактический объем пространства, которое используется, меньше, чем включенный объем хранилища, то этих дополнительных затрат можно избежать, уменьшив максимальный размер базы данных до включенного объема. Дополнительные сведения о размерах хранилищ базы данных и изменении максимального размера базы данных см. в разделах об ограничениях ресурсов отдельной службы базы данных на основе [DTU](sql-database-dtu-resource-limits.md#single-database-storage-sizes-and-performance-levels) и [виртуальных ядер](sql-database-vcore-resource-limits.md#single-database-storage-sizes-and-performance-levels).  

> [!NOTE]
> [Создаваемые автоматически резервные копии базы данных](sql-database-automated-backups.md) используются при создании [копии базы данных](sql-database-copy.md). 
>


## <a name="recovery-time"></a>Время восстановления
На время восстановления базы данных с использованием создаваемых автоматически резервных копий влияет несколько факторов: 

* размер базы данных;
* уровень производительности базы данных;
* число участвующих журналов транзакций;
* объем операций, которые требуется воспроизвести для восстановления до точки восстановления;
* пропускная способность сети, если выполняется восстановление в другой регион; 
* количество одновременных запросов на восстановление, обрабатываемых в целевом регионе. 
  
  Восстановление очень большой и (или) активной базы данных может занять несколько часов. В случае длительного простоя в регионе возможно появление большого количества запросов на геовосстановление, обрабатываемых другими регионами. Наличие большого числа запросов может увеличить время восстановления баз данных в соответствующем регионе. В большинстве случаев на восстановление базы данных требуется до 12 часов.

Для одной подписки действуют определенные ограничения на количество одновременных запросов на восстановление (восстановление до точки во времени, геовосстановление и восстановление из резервной копии долгосрочного хранения), которые могут быть отправлены и обработаны.
|  | **Максимальное количество одновременно обрабатываемых запросов** | **Максимальное количество одновременно отправляемых запросов** |
| :--- | --: | --: |
|Отдельная база данных (на подписку)|10|60|
|Эластичный пул (на пул)|4.|200|
||||

Возможность массового восстановления встроенными средствами не предусмотрена. Сценарий [База данных SQL Azure: полное восстановление сервера](https://gallery.technet.microsoft.com/Azure-SQL-Database-Full-82941666) является примером одного из способов выполнения этой задачи.

> [!IMPORTANT]
> Чтобы использовать восстановление с помощью автоматически создаваемых резервных копий, нужно быть участником роли "Участник SQL Server" в подписке или владельцем подписки. Выполнить восстановление можно с помощью портала Azure, PowerShell или REST API. Использовать для этого Transact-SQL невозможно. 
> 

## <a name="point-in-time-restore"></a>Восстановление до точки во времени

Вы можете восстановить существующую базу данных до предшествующей точки во времени как новую базу данных на том же логическом сервере с помощью портала Azure, [PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/restore-azurermsqldatabase) или [REST API](https://msdn.microsoft.com/library/azure/mt163685.aspx). 

> [!TIP]
> Пример сценария PowerShell, показывающий, как выполнить восстановление базы данных до точки во времени, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).
>

Базу данных можно восстановить для любого уровня служб или уровня производительности как отдельную базу данных либо как базу данных в эластичном пуле. Убедитесь, что на логическом сервере или в эластичном пуле, в который выполняется восстановление базы данных, достаточно ресурсов. После завершения восстановленная вы получите обычную полностью доступную базу данных в сети. Использование восстановленной базы данных оплачивается по обычным тарифам на основе уровня служб и уровня производительности. Плата не взимается до завершения восстановления базы данных.

Обычно база данных восстанавливается до более ранней точки во времени. Таким образом восстановленную базу данных можно рассматривать как замену исходной базы данных или же использовать для извлечения данных, чтобы затем обновить исходную базу данных. 

* ***Замена базы данных.*** Если восстановленная база данных предназначена для замены исходной базы данных, то следует проверить, настроен ли для нее соответствующий уровень производительности и (или) служб, и при необходимости масштабировать эту базу данных. Можно переименовать исходную базу данных, а затем присвоить восстановленной базе данных исходное имя с помощью команды [ALTER DATABASE](/sql/t-sql/statements/alter-database-azure-sql-database) в T-SQL. 
* ***Восстановление данных.*** Если вы планируете извлечь данные из восстановленной базы данных для восстановления после ошибки пользователя или приложения, то потребуется создать и выполнить сценарии восстановления данных, необходимые для извлечения данных из восстановленной базы данных в исходную. Несмотря на то, что операция восстановления может занять много времени, восстанавливаемая база данных будет отображаться в списке баз данных на протяжении всего процесса. Если удалить эту базу данных во время восстановления, то операция будет отменена и плата за базу данных, восстановление которой не было завершено, взиматься не будет. 

### <a name="azure-portal"></a>Портал Azure

Чтобы выполнить восстановление до точки во времени с помощью портала Azure, откройте страницу для базы данных и щелкните **Восстановление** на панели инструментов.

![point-in-time-restore](./media/sql-database-recovery-using-backups/point-in-time-recovery.png)

## <a name="deleted-database-restore"></a>Восстановление удаленной базы данных
Вы можете восстановить удаленную базу данных до момента удаления на том же логическом сервере с помощью портала Azure, [PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/restore-azurermsqldatabase) или [REST (createMode=Restore)](https://msdn.microsoft.com/library/azure/mt163685.aspx). Удаленную базу данных можно восстановить до предшествующей точки во времени при хранении с помощью [PowerShell](https://docs.microsoft.com/powershell/module/azurerm.sql/restore-azurermsqldatabase).

> [!TIP]
> Пример сценария PowerShell, показывающий, как восстановить удаленную базу данных, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).
>

> [!IMPORTANT]
> При удалении экземпляра сервера базы данных SQL Azure все базы данных, находившиеся на нем, также будут удалены без возможности восстановления. В настоящее время восстановление удаленного сервера не поддерживается.
> 

### <a name="azure-portal"></a>Портал Azure

Чтобы восстановить удаленную базу данных в течение [срока хранения для модели на основе DTU](sql-database-service-tiers-dtu.md) или [срока хранения ля модели на основе виртуальных ядер](sql-database-service-tiers-vcore.md) с помощью портала Azure, откройте страницу сервера и в области операций щелкните **Удаленные базы данных**.

![deleted-database-restore-1](./media/sql-database-recovery-using-backups/deleted-database-restore-1.png)


![deleted-database-restore-2](./media/sql-database-recovery-using-backups/deleted-database-restore-2.png)

## <a name="geo-restore"></a>Геовосстановление
Можно восстановить базу данных SQL на любой сервер в любом регионе Azure из последней геореплицированной полной или разностной резервной копии. В качестве источника геовосстановление использует геоизбыточную резервную копию для восстановления базы данных, даже если она или центр обработки данных недоступны из-за сбоя. 

Геовосстановление используется по умолчанию, когда база данных недоступна из-за происшествия в регионе, в котором она размещена. Если масштабная авария в регионе приведет к недоступности приложения базы данных, то базу данных можно будет восстановить из геореплицированных резервных копий на сервер в любом другом регионе. Между созданием разностной резервной копии и ее георепликацией в большой двоичный объект Azure в другом регионе существует задержка. Эта задержка может длиться до часа, поэтому в случае аварии возможна потеря данных за час или менее. На следующем рисунке показано восстановление базы данных из последней доступной резервной копии в другом регионе.

![Геовосстановление](./media/sql-database-geo-restore/geo-restore-2.png)

> [!TIP]
> Пример сценария PowerShell, показывающий, как выполнить геовосстановление, приведен в разделе [Восстановление базы данных SQL с помощью PowerShell](scripts/sql-database-restore-database-powershell.md).
> 

Восстановление до точки во времени для базы данных-получателя геореплицируемых данных в настоящее время не поддерживается. Восстановление до точки во времени может выполняться только для базы данных-источника. Дополнительные сведения об использовании геовосстановления для восстановления после сбоя см. в статье [Восстановление базы данных SQL Azure или переход на базу данных-получатель при отказе](sql-database-disaster-recovery.md).

> [!IMPORTANT]
> Восстановление из резервных копий — это наиболее простое из решений аварийного восстановления, доступных в Базе данных SQL, с наибольшими значениями целевой точки восстановления (RPO) и предполагаемого времени восстановления (ERT). Для решений с небольшими базами данных (например, на уровне службы "Базовый" или для небольших баз данных клиентов в эластичных пулах) часто целесообразным решением аварийного восстановления является геовосстановление с периодом ERT, составляющим 12 часов. В решениях, использующих большие базы данных, для которых требуется минимизировать интервалы восстановления, мы рекомендуем использовать [группы отработки отказа и активную георепликацию](sql-database-geo-replication-overview.md). Активная георепликация обеспечивает более низкие значения RPO и ERT, так как требует только инициировать отработку отказа для перехода на непрерывно реплицируемую базу данных-получатель. Дополнительные сведения о непрерывности бизнес-процессов см. в [обзоре обеспечения непрерывности бизнес-процессов](sql-database-business-continuity.md).
> 

### <a name="azure-portal"></a>Портал Azure

Чтобы выполнить геовосстановление базы данных в течение ее [срока хранения для модели на основе DTU](sql-database-service-tiers-dtu.md) или [срока хранения для модели на основе виртуальных ядер](sql-database-service-tiers-vcore.md) с помощью портала Azure, откройте страницу "Базы данных SQL" и щелкните **Добавить**. В текстовом поле **Выбрать источник** выберите **Резервная копия**. Укажите, из какой резервной копии будет выполняться восстановление в регионе и на сервере по своему усмотрению. 

## <a name="programmatically-performing-recovery-using-automated-backups"></a>Программное восстановление с помощью создаваемых автоматически резервных копий
Как уже говорилось ранее, в дополнение к порталу Azure восстановление базы данных можно выполнить программно, с помощью Azure PowerShell или REST API. В приведенных ниже таблицах описан доступный для этого набор команд.

### <a name="powershell"></a>PowerShell
| Командлет | ОПИСАНИЕ |
| --- | --- |
| [Get-AzureRmSqlDatabase](/powershell/module/azurerm.sql/get-azurermsqldatabase) |Получает одну или несколько баз данных. |
| [Get-AzureRMSqlDeletedDatabaseBackup](/powershell/module/azurerm.sql/get-azurermsqldeleteddatabasebackup) | Получает удаленную базу данных, которую можно восстановить. |
| [Get-AzureRmSqlDatabaseGeoBackup](/powershell/module/azurerm.sql/get-azurermsqldatabasegeobackup) |Получает геоизбыточную резервную копию базы данных. |
| [Restore-AzureRmSqlDatabase](/powershell/module/azurerm.sql/restore-azurermsqldatabase) |Восстанавливает базу данных SQL. |
|  | |

### <a name="rest-api"></a>ИНТЕРФЕЙС REST API
| API | ОПИСАНИЕ |
| --- | --- |
| [REST (createMode=Recovery)](https://msdn.microsoft.com/library/azure/mt163685.aspx) |Восстанавливает базу данных. |
| [Получение, создание или обновление состояния базы данных](https://msdn.microsoft.com/library/azure/mt643934.aspx) |Возвращает состояние во время операции восстановления. |
|  | |

## <a name="summary"></a>Сводка
Создаваемые автоматически резервные копии позволяют защитить базы данных от ошибок пользователей и приложений, случайного удаления базы данных и длительных простоев. Эта встроенная возможность доступна для всех уровней служб и уровней производительности. 

## <a name="next-steps"></a>Дополнительная информация
* Сведения об обеспечении непрерывности бизнес-процессов и возможные сценарии описаны в [обзоре непрерывности бизнес-процессов](sql-database-business-continuity.md).
* Чтобы узнать об автоматически создаваемых резервных копиях базы данных SQL Azure, ознакомьтесь со статьей [Общие сведения об автоматическом резервном копировании базы данных SQL](sql-database-automated-backups.md).
* Дополнительные сведения см. в статье о [долгосрочном хранении](sql-database-long-term-retention.md).
* Чтобы узнать о более быстрых вариантах восстановления, ознакомьтесь со сведениями о [группах отработки отказа и активной георепликации](sql-database-geo-replication-overview.md).  
