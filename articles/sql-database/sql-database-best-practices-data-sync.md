---
title: Рекомендации по синхронизации данных SQL Azure (предварительная версия) | Документация Майкрософт
description: Рекомендации по настройке и выполнению синхронизации данных SQL Azure (предварительная версия).
services: sql-database
ms.date: 04/01/2018
ms.topic: conceptual
ms.service: sql-database
author: douglaslMS
ms.author: douglasl
manager: craigg
ms.openlocfilehash: 683cf1426f01b3ab495b2380612dbf37342fc27a
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34646013"
---
# <a name="best-practices-for-sql-data-sync-preview"></a>Рекомендации по синхронизации данных SQL (предварительная версия) 

В этой статье описываются рекомендации по синхронизации данных SQL Azure (предварительная версия).

Общие сведения о синхронизации данных SQL (предварительная версия) см. в статье [Синхронизация данных в нескольких облачных и локальных базах данных с помощью синхронизации данных SQL Azure (предварительная версия)](sql-database-sync-data.md).

## <a name="security-and-reliability"></a> Безопасность и надежность

### <a name="client-agent"></a>Агент клиента

-   Установите агент клиента, используя учетную запись пользователя с наименьшим уровнем привилегий и доступом к службе сети.  
-   Установите агент клиента на компьютере, отличном от локального компьютера SQL Server.  
-   Не регистрируйте локальную базу данных в нескольких агентах.    
    -   Избегайте этого, даже если вы синхронизируете разные таблицы из разных групп синхронизации.  
    -   Регистрация локальной базы данных в нескольких агентах клиента создает проблемы при удалении вами одной из групп синхронизации.

### <a name="database-accounts-with-least-required-privileges"></a>Учетные записи базы данных с наименьшими требуемыми привилегиями

-   **Для настройки синхронизации.** Создание/изменение таблицы; изменение базы данных; создание процедуры; выбор/изменение схемы; создание пользовательских типов.

-   **Для непрерывной синхронизации.** Выбор/вставка/обновление/удаление в таблицах, выбранных для синхронизации, а также в метаданных синхронизации и таблицах отслеживания, разрешение выполнения для хранимых процедур, созданных службой, разрешение выполнения для пользовательских типов таблиц.

-   **Для отзыва.** Изменение части синхронизации таблиц; выбор/удаление в таблицах синхронизации метаданных; управление таблицами отслеживания синхронизации, хранимых процедур и пользовательских типов.

База данных SQL Azure поддерживает только один набор учетных данных. Для выполнения этих задач в пределах этого ограничения рассмотрите следующие варианты:

-   Изменяйте учетные данные для разных этапов (например, *учетные данные1* для настройки и *учетные данные2* для непрерывной синхронизации).  
-   Изменяйте разрешения для учетных данных (то есть изменяйте разрешение после настройки синхронизации).

## <a name="setup"></a>Настройка

### <a name="database-considerations-and-constraints"></a> Рекомендации по базам данных и ограничения

#### <a name="sql-database-instance-size"></a>Размер экземпляра базы данных SQL

Когда вы создаете экземпляр базы данных SQL, установите максимальный размер, чтобы он всегда превышал размер базы данных, которую вы развертываете. Если этого не сделать, синхронизация завершится ошибкой. Несмотря на то, что синхронизация данных SQL (предварительная версия) не предлагает автоматическое увеличение размера, вы можете выполнить команду `ALTER DATABASE`, чтобы увеличить размер базы данных после ее создания. Убедитесь, что вы остаетесь в пределах размера экземпляра базы данных SQL.

> [!IMPORTANT]
> Синхронизация данных SQL (предварительная версия) хранит дополнительные метаданные в каждой базе данных. Обязательно учтите эти метаданные при определении необходимого пространства. Количество добавленных данных зависит от ширины таблиц (например, для узких таблиц требуются дополнительные накладные расходы) и объема трафика.

### <a name="table-considerations-and-constraints"></a> Рекомендации по таблицам и ограничения

#### <a name="selecting-tables"></a>Выбор таблиц

Не обязательно включать в группу синхронизации все таблицы, которые находятся в базе данных. Таблицы, которые включены в группу синхронизации, влияют на эффективность и стоимость. Включайте таблицы и таблицы, зависящие от них, в группу синхронизации только в соответствии с требованиями бизнеса.

#### <a name="primary-keys"></a>Первичные ключи

Каждая таблица в группе синхронизации должна иметь первичный ключ. Служба синхронизации данных SQL (предварительная версия) не сможет синхронизировать таблицу без первичного ключа.

Перед использованием синхронизации данных SQL (предварительная версия) в рабочей среде проверьте эффективность начальной и непрерывной синхронизации.

### <a name="provisioning-destination-databases"></a> Подготовка баз данных назначения

Компонент предварительного просмотра синхронизации данных SQL (предварительная версия) предоставляет автоматическую подготовку баз данных.

В этом разделе рассматриваются ограничения подготовки синхронизации данных SQL (предварительная версия).

#### <a name="autoprovisioning-limitations"></a>Ограничения автоматической подготовки баз данных

Автоматическая подготовка синхронизации данных SQL (предварительная версия) имеет следующие ограничения:

-   Выбирайте только столбцы, создаваемые в таблице назначения.  
    Столбцы, которые не входят в группу синхронизации, не подготавливаются в таблицах назначения.
-   Индексы создаются только для выбранных столбцов.  
    Если индекс исходной таблицы содержит столбцы, которые не входят в группу синхронизации, такой индекс не подготавливается в таблицах назначения.  
-   Индексы столбцов типа XML не подготавливаются.  
-   Проверочные ограничения не подготавливаются.  
-   Имеющиеся триггеры в исходных таблицах не подготавливаются.  
-   Представления и хранимые процедуры не создаются в базе данных назначения.

#### <a name="recommendations"></a>Рекомендации

-   Используйте возможность автоматической подготовки синхронизации данных SQL (предварительная версия) только при тестировании службы.  
-   Для рабочей среды подготовьте схему базы данных.

### <a name="locate-hub"></a> Где найти центральную базу данных

#### <a name="enterprise-to-cloud-scenario"></a>Сценарий перемещения из предприятия в облако

Чтобы свести к минимуму задержки, храните центральную базу данных в регионе максимальной концентрации трафика базы данных в группе синхронизации.

#### <a name="cloud-to-cloud-scenario"></a>Сценарий перемещения из облака в облако

-   Когда все базы данных в группе синхронизации находятся в одном центре обработки данных, центральная база данных должна находиться в том же центре обработки данных. Эта конфигурация уменьшает время задержки и стоимость передачи данных между центрами обработки данных.
-   Когда базы данных в группе синхронизации находятся в нескольких центрах обработки данных, центральная база данных должна находиться в том же центре обработки данных, где и большинство баз данных и их трафик.

#### <a name="mixed-scenarios"></a>Смешанные сценарии

Примените предыдущие рекомендации к более сложным конфигурациям групп синхронизации, например со смешанными сценариями перемещения из предприятия в облако и из облака в облако.

## <a name="sync"></a>Sync

### <a name="avoid-a-slow-and-costly-initial-synchronization"></a> Избегайте медленной и дорогостоящей начальной синхронизации

В этом разделе мы рассмотрим начальную синхронизацию группы синхронизации. Узнайте, как можно ускорить начальную синхронизацию и сэкономить затраты на нее.

#### <a name="how-initial-sync-works"></a>Как работает начальная синхронизация

Когда вы создаете группу синхронизации, начните с данных в одной базе данных. Если у вас есть данные в нескольких базах данных, синхронизация данных SQL (предварительная версия) обрабатывает каждую строку как конфликт, требующий разрешения. Это разрешение конфликтов приводит к замедлению начальной синхронизации. При наличии данных в нескольких базах данных начальная синхронизации может выполняться от нескольких дней до нескольких месяцев в зависимости от размера базы данных.

Если базы данных находятся в разных центрах обработки данных, то каждая строка должна пройти между всеми центрами обработки данных. Это увеличивает затраты на начальную синхронизацию.

#### <a name="recommendation"></a>Рекомендации

По возможности начинайте с данных только в одной базе данных группы синхронизации.

### <a name="design-to-avoid-synchronization-loops"></a>При проектировании избегайте петель синхронизации

Петля синхронизации возникает при наличии циклических ссылок в группе синхронизации. В этом случае каждое изменение в одной базе данных приводит к бесконечной циклической репликации по базам данных в группе синхронизации.   

Не допускайте возникновения петель синхронизации, так как они приводят к замедлению и могут значительно увеличить расходы.

### <a name="handling-changes-that-fail-to-propagate"></a> Изменения, которые не удается распространить

#### <a name="reasons-that-changes-fail-to-propagate"></a>Причины, по которым не удается распространить изменения

Изменения могут не распространиться по одной из следующих причин:

-   Несовместимость схемы или типа данных.
-   Вставка нулевого значения в столбцах, не допускающих нуля.
-   Нарушение ограничений внешнего ключа.

#### <a name="what-happens-when-changes-fail-to-propagate"></a>Что происходит, когда изменения не распространяются?

-   Группа синхронизации показывает, что находится в состоянии **предупреждения**.
-   Подробности содержатся в средстве просмотра журнала в пользовательском интерфейсе портала.
-   Если проблема не будет устранена в течение 45 дней, база данных станет устаревшей.

> [!NOTE]
> Эти изменения никогда не распространяются. Единственным способом восстановления в этом сценарии является повторное создание группы синхронизации.

#### <a name="recommendation"></a>Рекомендации

Регулярно отслеживайте состояние группы синхронизации и базы данных через интерфейс портала и журнала.


## <a name="maintenance"></a>Обслуживание, 

### <a name="avoid-out-of-date-databases-and-sync-groups"></a> Избегайте устаревших баз данных и групп синхронизации

Группа синхронизации или база данных в группе синхронизации могут устареть. Если группа синхронизации **устаревает**, она перестает работать. Если база данных **устаревает**, данные могут быть утеряны. Лучше избежать этого сценария, а не восстанавливать данные после него.

#### <a name="avoid-out-of-date-databases"></a>Избегайте появления устаревших баз данных

База данных получает состояние **устаревшей**, если она находилась в автономном режиме более 45 дней. Чтобы избежать **устаревания** баз данных, следите за тем, чтобы ни одна из них не отключалась на срок более 45 дней.

#### <a name="avoid-out-of-date-sync-groups"></a>Избегайте появления устаревших групп синхронизации

Группа синхронизации считается **устаревшей**, если любые изменения в этой группе не распространялись на остальную часть группы синхронизации более 45 дней. Чтобы группы синхронизации не **устаревали**, регулярно проверяйте журнал групп синхронизации. Убедитесь, что все конфликты решены и изменения успешно распространяются в базах данных групп синхронизации.

Группа синхронизации может не применять изменения по одной из следующих причин:

-   Несовместимость схемы между таблицами.
-   Несовместимость данных между таблицами.
-   Вставка строки с нулевым значением в столбце, который не допускает нулевые значения.
-   Обновление строки со значением, которое нарушает ограничение внешнего ключа.

Чтобы предотвратить устаревание групп синхронизации, сделайте следующее:

-   Обновите схему, разрешив значения, содержащиеся в строках с ошибками.
-   Обновите значения внешнего ключа, чтобы включить значения, содержащиеся в строках с ошибками.
-   Обновите значения данных в строке с ошибкой, чтобы они были совместимы со схемой или внешними ключами в целевой базе данных.

### <a name="avoid-deprovisioning-issues"></a> Избегайте проблем с отменой подготовки

При определенных обстоятельствах отмена регистрации базы данных в агенте клиента может привести к сбою синхронизации.

#### <a name="scenario"></a>Сценарий

1. Группа синхронизации A была создана с использованием экземпляра базы данных SQL и локальной базы данных SQL Server, которая связана с локальным агентом 1.
2. Та же самая локальная база данных регистрируется в локальном агенте 2 (этот агент не связан с какой-либо группой синхронизации).
3. При отмене регистрации локальной базы данных в локальном агенте 2 удаляются таблицы отслеживания и метаданных из группы синхронизации A для локальной базы данных.
4. Операции группы синхронизации A завершаются такой ошибкой: The current operation could not be completed because the database is not provisioned for sync or you do not have permissions to the sync configuration tables (Текущая операция не может быть завершена, потому что база данных не подготовлена для синхронизации или у вас нет разрешений для таблиц конфигурации синхронизации).

#### <a name="solution"></a>Решение

Чтобы избежать этого сценария, не регистрируйте базу данных в нескольких агентах.

Чтобы исправить ошибку, сделайте следующее:

1. Удалите базу данных из каждой группы синхронизации, к которой она принадлежит.  
2. Добавьте базу данных обратно в каждую группу синхронизации, из которой вы удалили ее.  
3. Разверните каждую затронутую группу синхронизации (при этом действии подготавливается база данных).  

### <a name="modifying-your-sync-group"></a> Изменение группы синхронизации

Не пытайтесь удалить базу данных из группы синхронизации, а затем отредактировать группу без предварительного развертывания одного из этих изменений.

Вот как следует поступить вместо этого: сначала удалите базу данных из группы синхронизации. Затем разверните изменение и дождитесь отмены подготовки. После отмены подготовки вы можете отредактировать группу синхронизации и развернуть изменения.

Если вы попытаетесь удалить базу данных, а затем отредактировать группу синхронизации без предварительного развертывания одного из этих изменений, одна из операций завершится сбоем, а интерфейс портала станет несогласованным. В этом случае обновите страницу, чтобы восстановить правильное состояние.

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения о службе синхронизации данных SQL (предварительная версия) см. в разделах:

-   [Синхронизация данных в нескольких облачных и локальных базах данных с помощью функции синхронизации данных SQL Azure (предварительная версия)](sql-database-sync-data.md)
-   [Настройка синхронизации данных SQL Azure (предварительная версия)](sql-database-get-started-sql-data-sync.md)
-   [Мониторинг синхронизации данных SQL Azure (предварительная версия) с помощью Log Analytics](sql-database-sync-monitor-oms.md)
-   [Устранение неполадок с синхронизацией данных SQL Azure (предварительная версия)](sql-database-troubleshoot-data-sync.md)  
-   Полные примеры PowerShell, которые демонстрируют, как настроить синхронизацию данных SQL (предварительная версия):  
    -   [Использование PowerShell для синхронизации данных между несколькими базами данных SQL Azure](scripts/sql-database-sync-data-between-sql-databases.md)  
    -   [Использование PowerShell для синхронизации данных между базой данных SQL Azure и локальной базой данных SQL Server](scripts/sql-database-sync-data-between-azure-onprem.md)  
-   [Документация по REST API синхронизации данных SQL (предварительная версия)](https://github.com/Microsoft/sql-server-samples/raw/master/samples/features/sql-data-sync/Data_Sync_Preview_REST_API.pdf?raw=true)  

Дополнительные сведения о Базе данных SQL см. в разделах:

-   [Функции службы базы данных SQL Azure](sql-database-technical-overview.md)
-   [Database Lifecycle Management (DLM)](https://msdn.microsoft.com/library/jj907294.aspx) (Управление жизненным циклом базы данных)
