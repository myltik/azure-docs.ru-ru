---
title: Мониторинг производительности базы данных в базе данных SQL Azure | Документация Майкрософт
description: Узнайте о возможностях мониторинга своей базы данных с помощью средств Azure и динамических административных представлений.
keywords: мониторинг базы данных, производительность облачной базы данных
services: sql-database
author: CarlRabeler
manager: craigg
ms.service: sql-database
ms.custom: monitor & tune
ms.topic: conceptual
ms.date: 04/01/2018
ms.author: carlrab
ms.openlocfilehash: 44d68d69a7034e80846fb44f3ae26c0d73c61f28
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34648315"
---
# <a name="monitoring-database-performance-in-azure-sql-database"></a>Мониторинг производительности базы данных в базе данных SQL Azure
Мониторинг производительности базы данных SQL в Azure начинается с мониторинга использования ресурсов в соответствии с выбранным уровнем производительности базы данных. С помощью мониторинга можно определить, является ли емкость базы данных избыточной или же проблема возникает из-за того, что ресурсы используются на пределе возможностей. Затем при необходимости можно изменить уровень производительности и уровень служб своей базы данных в [моделью приобретения на основе DTU](sql-database-service-tiers-dtu.md) или [моделью приобретения на основе виртуальных ядер (предварительная версия)](sql-database-service-tiers-vcore.md). Вы можете выполнять мониторинг базы данных с помощью графических средств на [портале Azure](https://portal.azure.com) или с использованием [динамических административных представлений](https://msdn.microsoft.com/library/ms188754.aspx).

> [!TIP]
> Используйте [Azure SQL Intelligent Insights](sql-database-intelligent-insights.md) для автоматического мониторинга производительности базы данных. После обнаружения проблемы с производительностью создается журнал диагностики, в который записываются сведения о проблеме и результат анализа ее первопричин (RCA). При возможности также приводятся рекомендации по повышению производительности.
>

## <a name="monitor-databases-using-the-azure-portal"></a>Мониторинг баз данных с помощью портала Azure
На [портале Azure](https://portal.azure.com/) можно отслеживать использование отдельной базы данных. Для этого нужно выбрать базу данных и щелкнуть диаграмму **Мониторинг**. Появится окно **Метрика**, которое можно изменить, нажав кнопку **Изменить диаграмму**. Добавьте следующие метрики:

* Процент использования ЦП
* Процент использования DTU
* Процент операций ввода/вывода данных
* Размер базы данных в процентах

После добавления этих метрик можно продолжить наблюдение за ними на диаграмме **Мониторинг** с более подробными сведениями в окне **Метрика**. Все четыре метрики показывают средний процент использования в соответствии с количеством единиц **DTU** для вашей базы данных. Узнайте больше об уровнях служб, ознакомившись с [моделью приобретения на основе DTU](sql-database-service-tiers-dtu.md) и [моделью приобретения на основе виртуальных ядер (предварительная версия)](sql-database-service-tiers-vcore.md).  

![Мониторинг производительности базы данных для разных уровней служб.](./media/sql-database-single-database-monitoring/sqldb_service_tier_monitoring.png)

Также можно настроить оповещения для метрик производительности. В окне **Метрика** нажмите кнопку **Добавить оповещение**. Следуйте инструкциям мастера для настройки оповещения. Можно настроить предупреждение, информирующее либо о превышении показателями определенного порога, либо о падении показателей ниже определенного порога.

Например, если предполагается, что рабочая нагрузка базы данных будет расти, можно настроить отправку оповещения по электронной почте каждый раз, когда любой из показателей производительности для вашей базы данных достигнет 80%. Это оповещение можно использовать как предварительное предупреждение о том, что необходимо перейти на следующий, более высокий уровень производительности.

Метрики производительности также помогут определить, можете ли вы перейти на более низкий уровень производительности. Предположим, вы используете базу данных размера S2 уровня Стандартный, и все метрики производительности показывают, что база данных никогда не используется более чем на 10%. Вполне вероятно, что эта база данных будет хорошо работать с размером S1 уровня Стандартный. Однако перед переходом на более низкий уровень производительности следует учитывать скачки и колебания рабочих нагрузок.

## <a name="monitor-databases-using-dmvs"></a>Мониторинг баз данных с помощью динамических административных представлений
Метрики, которые отображаются на портале, доступны также в системных представлениях: [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) — в логической базе данных **master** вашего сервера, а также [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) — в пользовательской базе данных. Используйте **sys.resource_stats**, если необходимо отслеживать менее детализированные данные для длительного периода времени. Используйте **sys.dm_db_resource_stats**, если необходимо отслеживать более детализированные данные для менее длительного периода времени. Дополнительные сведения см. в статье [База данных SQL Azure и производительность отдельных баз данных](sql-database-single-database-monitor.md#monitor-resource-use).

> [!NOTE]
> При использовании в базах данных устаревших выпусков Web Edition и Business Edition **sys.dm_db_resource_stats** возвращает пустой результирующий набор.
>
>

### <a name="monitor-resource-use"></a>Отслеживание использования ресурсов

Использование ресурсов можно отслеживать с помощью [анализа производительности запросов базы данных SQL](sql-database-query-performance.md) и [хранилища запросов](https://msdn.microsoft.com/library/dn817826.aspx).

Кроме того, для отслеживания использования можно применять два приведенных ниже представления.

* [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx)
* [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx)

#### <a name="sysdmdbresourcestats"></a>sys.dm_db_resource_stats
Представление [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx) можно использовать в каждой базе данных SQL. В представлении **sys.dm_db_resource_stats** отображаются последние данные использования ресурсов в соответствии с уровнем служб. Средний процент нагрузки ЦП, показатели операций ввода-вывода данных, записи в журнал и данные о памяти записываются каждые 15 секунд и хранятся 1 час.

Так как это представление содержит более подробные сведения об использовании ресурсов, сначала используйте представление **sys.dm_db_resource_stats** для любого анализа текущего состояния и устранения неполадок. Например, этот запрос показывает среднее и максимальное использование ресурсов для текущей базы данных за последний час:

    SELECT  
        AVG(avg_cpu_percent) AS 'Average CPU use in percent',
        MAX(avg_cpu_percent) AS 'Maximum CPU use in percent',
        AVG(avg_data_io_percent) AS 'Average data IO in percent',
        MAX(avg_data_io_percent) AS 'Maximum data IO in percent',
        AVG(avg_log_write_percent) AS 'Average log write use in percent',
        MAX(avg_log_write_percent) AS 'Maximum log write use in percent',
        AVG(avg_memory_usage_percent) AS 'Average memory use in percent',
        MAX(avg_memory_usage_percent) AS 'Maximum memory use in percent'
    FROM sys.dm_db_resource_stats;  

Примеры других запросов см. в [sys.dm_db_resource_stats](https://msdn.microsoft.com/library/dn800981.aspx).

#### <a name="sysresourcestats"></a>sys.resource_stats
Представление [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) в базе данных **master** предоставляет дополнительные сведения, с помощью которых можно контролировать производительность базы данных SQL в рамках конкретного уровня службы и производительности. Данные собираются каждые 5 минут и хранятся приблизительно 14 дней. Это представление полезно для анализа использования ресурсов Базы данных SQL за более долгий период.

На следующей диаграмме показано почасовое использование ресурсов процессора для базы данных уровня "Премиум" с уровнем производительности P2 в течение недели. Диаграмма начинается в понедельник, охватывает 5 рабочих дней и выходные, когда нагрузка заметно ниже.

![Использование ресурсов Базы данных SQL](./media/sql-database-performance-guidance/sql_db_resource_utilization.png)

Судя по этим данным, пиковая нагрузка на процессор составляет чуть более 50 % от максимальной нагрузки на уровне производительности P2 (полдень вторника). Если мощность процессора была главным фактором ресурсного профиля приложения, то клиент может решить, что P2 — оптимальный уровень производительности, который гарантирует стабильную работу с учетом средней нагрузки. Если ожидается рост нагрузки на приложение с течением времени, рекомендуется увеличить запас ресурсов, чтобы приложения не достигло предела производительности. Увеличив уровень производительности, можно избежать заметных пользователю ошибок, которые могут возникнуть из-за нехватки в базе данных мощности для эффективной обработки запросов, особенно в средах, чувствительных к задержкам. Это может быть база данных, поддерживающая приложение, создающее веб-страницы на основе запросов к базе данных.

Для других приложений эту диаграмму можно интерпретировать иначе. Например, если приложение обрабатывало данные по зарплате каждый день и получало ту же диаграмму, то выполнение таких "пакетных заданий" будет эффективным и на уровне производительности P1. Уровень производительности P1 предоставляет 100 DTU, а P2 — 200 DTU. P1 обеспечивает производительность в два раза меньше, чем P2. Таким образом, 50 процентов использования ЦП на уровне P2 равняется 100 процентам использования ЦП на уровне P1. Если в работе приложения не возникает пауз, возможно, не имеет значения, сколько времени выполняется задание — 2 или 2,5 часа, а важно только, чтобы оно было завершено сегодня. Приложение такой категории может использовать уровень Р1. Вы можете воспользоваться тем, что в определенное время дня использование ресурсов ниже, и перенести пиковую нагрузку именно на этот период. Уровень производительности Р1 может отлично подойти для такого приложения (и сэкономить деньги), если задания будут завершаться вовремя в течение одного дня.

База данных SQL Azure предоставляет сведения об использовании ресурсов по каждой активной базе данных в представлении **sys.resource_stats** для базы данных **master** на каждом сервере. Данные в таблице агрегируются каждые 5 минут. На уровнях служб "Базовый", "Стандартный" и "Премиум" может потребоваться более 5 минут, прежде чем данные появятся в таблице, то есть эти данные лучше подходят для ретроспективного анализа, чем для анализа в режиме реального времени. Выполните запрос представления **sys.resource_stats**, чтобы просмотреть журнал базы данных и проверить, обеспечил ли выбранный уровень резервирования требуемую производительность.

> [!NOTE]
> Вы должны быть подключены к базе данных **master** логического сервера базы данных SQL, чтобы отправить запрос **sys.resource_stats** в следующих примерах.
> 
> 

В этом примере показано, как отображаются данные в этом представлении.

    SELECT TOP 10 *
    FROM sys.resource_stats
    WHERE database_name = 'resource1'
    ORDER BY start_time DESC

![Представление каталога sys.resource_stats](./media/sql-database-performance-guidance/sys_resource_stats.png)

Ниже показаны различные способы использования представления каталога **sys.resource_stats** для получения сведений об использовании ресурсов в базе данных SQL.

1. Чтобы просмотреть данные использования ресурсов на прошлой неделе для базы данных userdb1, можно выполнить следующий запрос:
   
        SELECT *
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND
              start_time > DATEADD(day, -7, GETDATE())
        ORDER BY start_time DESC;
2. Чтобы определить, какой уровень производительности лучше всего подходит для конкретной рабочей нагрузки, нужно детализировать все значения использования ресурсов: процессор, операции чтения и записи, количество рабочих ролей и количество сеансов. Ниже приведен измененный запрос, использующий **sys.resource_stats** для получения отчета о средних и максимальных значениях использования ресурсов.
   
        SELECT
            avg(avg_cpu_percent) AS 'Average CPU use in percent',
            max(avg_cpu_percent) AS 'Maximum CPU use in percent',
            avg(avg_data_io_percent) AS 'Average physical data IO use in percent',
            max(avg_data_io_percent) AS 'Maximum physical data IO use in percent',
            avg(avg_log_write_percent) AS 'Average log write use in percent',
            max(avg_log_write_percent) AS 'Maximum log write use in percent',
            avg(max_session_percent) AS 'Average % of sessions',
            max(max_session_percent) AS 'Maximum % of sessions',
            avg(max_worker_percent) AS 'Average % of workers',
            max(max_worker_percent) AS 'Maximum % of workers'
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND start_time > DATEADD(day, -7, GETDATE());
3. С помощью средних и максимальных значений по каждому ресурсу можно оценить, насколько выбранный уровень производительности подходит для вашей рабочей нагрузки. Как правило, средние значения из **sys.resource_stats** дают хорошую основу для определения целевого резервирования. Эти сведения следует использовать в качестве отправной точки анализа. Например, вы можете использовать уровень служб "Стандартный" с уровнем производительности S2. При этом средняя нагрузка на процессор и число операций чтения и записи ввода-вывода составляют меньше 40 %, среднее число рабочих ролей — меньше 50, а среднее количество сеансов — меньше 200. Для такой рабочей нагрузки может подойти уровень производительности S1. Вы легко можете определить, отвечает ли уровень базы данных ограничениям рабочих ролей и сеансов. Чтобы узнать, можно ли для базы данных использовать более низкий уровень производительности с учетом нагрузки на процессор, количества операций чтения и записи, разделите число DTU более низкого уровня на DTU текущего уровня производительности и умножьте результат на 100.
   
    **DTU S1 / DTU S2 * 100 = 20 / 50 * 100 = 40**
   
    Результатом будет относительная разница производительности между двумя уровнями в процентах. Если использование ресурсов не превышает это значение, для рабочей нагрузки может подойти более низкий уровень производительности. Однако необходимо рассмотреть все диапазоны значений использования ресурсов, а также определить (в процентном отношении), как часто рабочая нагрузка будет вписываться в рамки более низкого уровня производительности. Следующий запрос отображает процентный показатель измерения ресурсов, исходя из 40-процентного порога, вычисленного в предыдущем примере.
   
        SELECT
            (COUNT(database_name) - SUM(CASE WHEN avg_cpu_percent >= 40 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'CPU Fit Percent'
            ,(COUNT(database_name) - SUM(CASE WHEN avg_log_write_percent >= 40 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Log Write Fit Percent'
            ,(COUNT(database_name) - SUM(CASE WHEN avg_data_io_percent >= 40 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Physical Data IO Fit Percent'
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND start_time > DATEADD(day, -7, GETDATE());
   
    В зависимости от целевого уровня обслуживания (SLO) базы данных вы можете определить, подходит ли более низкий уровень производительности для вашей рабочей нагрузки. Если SLO составляет 99,9 % и указанный выше запрос возвращает значение больше 99,9 % для всех трех измерений ресурсов, весьма вероятно, что рабочую нагрузку можно выполнять на более низком уровне производительности.
   
    Процентное значение также поможет вам понять, следует ли перейти на следующий уровень производительности для выполнения требований SLO. Например, для userdb1 мы видим следующую нагрузку ЦП за прошлую неделю.
   
   | Средняя нагрузка ЦП, % | Максимальная нагрузка ЦП, % |
   | --- | --- |
   | 24,5 |100,00 |
   
    Средняя нагрузка процессора равна приблизительно одной четвертой ограничения уровня производительности, что вполне соответствует уровню производительности базы данных. Однако максимальное значение показывает, что база данных достигла ограничения уровня производительности. Требуется ли перейти на следующий уровень производительности? Определите, сколько раз рабочая нагрузка достигает 100 %, и сравните это значение с SLO рабочей нагрузки базы данных.
   
        SELECT
        (COUNT(database_name) - SUM(CASE WHEN avg_cpu_percent >= 100 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'CPU fit percent'
        ,(COUNT(database_name) - SUM(CASE WHEN avg_log_write_percent >= 100 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Log write fit percent'
        ,(COUNT(database_name) - SUM(CASE WHEN avg_data_io_percent >= 100 THEN 1 ELSE 0 END) * 1.0) / COUNT(database_name) AS 'Physical data IO fit percent'
        FROM sys.resource_stats
        WHERE database_name = 'userdb1' AND start_time > DATEADD(day, -7, GETDATE());
   
    Если этот запрос возвращает значение меньше 99,9 для любого из трех измерений ресурсов, следует перейти на следующий уровень или использовать методы оптимизации приложения для сокращения нагрузки на Базу данных SQL Azure.
4. В таких расчетах также следует учитывать возможное увеличение рабочей нагрузки в будущем.

Для эластичных пулов можно отслеживать отдельные базы данных в пуле с помощью способов, описанных в этом разделе. Но также можно отслеживать и пул в целом. Дополнительные сведения см. в статье [Мониторинг пула эластичных баз данных и управление им на портале Azure](sql-database-elastic-pool-manage-portal.md).


### <a name="maximum-concurrent-requests"></a>Максимальное количество параллельных запросов
Чтобы просмотреть число параллельных запросов, выполните в Базе данных SQL этот запрос Transact-SQL:

    SELECT COUNT(*) AS [Concurrent_Requests]
    FROM sys.dm_exec_requests R

Чтобы проанализировать рабочую нагрузку локальной базы данных SQL Server, следует изменить этот запрос для фильтрации конкретной базы данных, которую необходимо проанализировать. Например, если у вас есть локальная база данных с именем MyDatabase, для получения числа параллельных запросов в этой базе данных можно использовать следующий запрос Transact-SQL:

    SELECT COUNT(*) AS [Concurrent_Requests]
    FROM sys.dm_exec_requests R
    INNER JOIN sys.databases D ON D.database_id = R.database_id
    AND D.name = 'MyDatabase'

Это только моментальный снимок в один момент времени. Для лучшего понимания рабочей нагрузки и требований к параллельным запросам потребуется собрать большое количество примеров с течением времени.

### <a name="maximum-concurrent-logins"></a>Максимальное число параллельных операций входа
Чтобы получить представление о частоте входа, можно проанализировать шаблоны работы пользователей и приложений. Кроме того, можно запустить реальные нагрузки в тестовой среде, чтобы убедиться в том, что вы не приближаетесь к этим или другим ограничениям, описанным в этой статье. Нет единого запроса или динамического административного представления, с помощью которых можно просмотреть количество параллельных операций входа или журнал.

Если несколько клиентов используют ту же строку подключения, служба проверяет подлинность каждого входа. Если 10 пользователей одновременно подключаются к базе данных с использованием того же имени пользователя и пароля, это будет 10 параллельных операций входа. Это ограничение применяется только на время входа и проверки подлинности. Если те же 10 пользователей последовательно подключатся к базе данных, количество параллельных операций входа никогда не будет больше 1.

> [!NOTE]
> Сейчас это ограничение не применимо к базам данных в пулах эластичных баз данных.
> 
> 

### <a name="maximum-sessions"></a>Максимальное число сеансов
Чтобы просмотреть число текущих активных сеансов, выполните в Базе данных SQL этот запрос Transact-SQL:

    SELECT COUNT(*) AS [Sessions]
    FROM sys.dm_exec_connections

При анализе рабочей нагрузки локального SQL Server измените запрос, чтобы сосредоточиться на определенной базе данных. Это поможет определить возможные потребности в сеансах для этой базы данных, если вы собираетесь переместить ее в Базу данных SQL Azure.

    SELECT COUNT(*)  AS [Sessions]
    FROM sys.dm_exec_connections C
    INNER JOIN sys.dm_exec_sessions S ON (S.session_id = C.session_id)
    INNER JOIN sys.databases D ON (D.database_id = S.database_id)
    WHERE D.name = 'MyDatabase'

Опять же, эти запросы возвращают значение счетчика на определенный момент времени. Сбор нескольких образцов за определенный период времени обеспечивает лучшее понимание использования сеансов.

Для анализа базы данных SQL можно получить журнал статистики использования сеансов, запросив представление [sys.resource_stats](https://msdn.microsoft.com/library/dn269979.aspx) и просмотрев столбец **active_session_count**. 

## <a name="next-steps"></a>Дополнительная информация

- Узнайте, как использовать автоматическую настройку индексов базы данных и планов выполнения запросов, изучив раздел [Автоматическая настройка](sql-database-automatic-tuning.md).
- Узнайте, как автоматически отслеживать производительность базы данных с помощью [Azure SQL Intelligent Insights](sql-database-intelligent-insights.md). Этот компонент предоставляет диагностические данные и анализ первопричин проблем с производительностью.
