---
title: Потоковая трансляция с помощью локальных кодировщиков, создающих потоки с разными скоростями | Документация Майкрософт
description: 'В этой статье описывается настройка канала, который получает динамический поток с поддержкой нескольких скоростей от локального кодировщика. Далее этот поток можно доставлять в клиентские приложения для воспроизведения через одну или несколько конечных точек потоковой передачи по одному из следующих протоколов потоковой передачи с переменной скоростью: HLS, Smooth Streaming или DASH.'
services: media-services
documentationcenter: ''
author: Juliako
manager: cfowler
editor: ''
ms.assetid: d9f0912d-39ec-4c9c-817b-e5d9fcf1f7ea
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: ne
ms.topic: article
ms.date: 04/12/2017
ms.author: cenkd;juliako
ms.openlocfilehash: e1a7c3cec7925c6fb01aafba152dde2383cee442
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
---
# <a name="live-streaming-with-on-premises-encoders-that-create-multi-bitrate-streams"></a>Потоковая трансляция с помощью локальных кодировщиков, создающих потоки с разными скоростями

> [!NOTE]
> С 12 мая 2018 г. динамические каналы больше не будут поддерживать протокол приема транспортного потока RTP/MPEG-2. Выполните миграцию из RTP/MPEG-2 в протокол приема RTMP или фрагментированный протокол MP4 (Smooth Streaming).

## <a name="overview"></a>Обзор
В службах мультимедиа Azure *канал* представляет собой конвейер для обработки контента, передаваемого в потоковом режиме. Канал получает входные потоки одним из двух способов.

* Локальный динамический кодировщик передает содержимое в формате RTMP или формате потока Smooth Streaming (фрагментированный MP4) с несколькими скоростями в канал, для которого не включена поддержка кодирования в реальном времени с помощью служб мультимедиа. Полученные потоки передаются через каналы без дальнейшей обработки. Этот способ называется *сквозной передачей*. Динамический кодировщик может также передавать односкоростной поток в канал, для которого не включено кодирование в реальном времени, но это не рекомендуется. При получении запроса службы мультимедиа предоставляют потоки запрашивающим клиентам.

  > [!NOTE]
  > Использование сквозной передачи является наиболее экономичным способом потоковой передачи в реальном времени.


* Локальный динамический кодировщик передает односкоростной поток в канал, который может осуществлять кодирование в реальном времени с помощью служб мультимедиа, в одном из следующих форматов: RTP (MPEG-TS), RTMP или Smooth Streaming (фрагментированный MP4). Затем канал кодирует входящий односкоростной поток в реальном времени в многоскоростной (адаптивный) видеопоток. При получении запроса службы мультимедиа предоставляют потоки запрашивающим клиентам.

Начиная с выпуска 2.10 служб мультимедиа при создании канала можно указать, как он должен принимать входной поток и должен ли он выполнять его кодирование в реальном времени. Существует два варианта.

* **Сквозная передача**. Выберите это значение, если собираетесь использовать локальный динамический кодировщик, который в качестве вывода будет использовать поток с несколькими скоростями (сквозной поток). В этом случае входящий поток передается на выход без кодирования. Таким образом каналы работали до выпуска 2.10. В этой статье приведены подробные сведения о работе с каналами именно этого типа.
* **Кодирование в реальном времени** — выберите это значение, если собираетесь использовать службы мультимедиа для кодирования односкоростного динамического потока в поток с несколькими скоростями. Чтобы избежать непредвиденных расходов, не оставляйте канал кодирования в реальном времени в состоянии **Работает**. Рекомендуется сразу же прекращать работу канала после завершения потоковой передачи в реальном времени во избежание оплаты дополнительных часов. При получении запроса службы мультимедиа предоставляют потоки запрашивающим клиентам.

> [!NOTE]
> В этой статье рассматриваются атрибуты каналов, которые не поддерживают кодирование в реальном времени. Сведения о работе с каналами, которые поддерживают кодирование в реальном времени, см. в статье [Потоковая трансляция с использованием служб мультимедиа Azure для создания потоков с разными скоростями](media-services-manage-live-encoder-enabled-channels.md).
>
>Сведения о рекомендуемых локальных кодировщиках см. в статье [Рекомендуемые локальные кодировщики](media-services-recommended-encoders.md).

На следующей схеме показан рабочий процесс динамической потоковой передачи, использующий локальный динамический кодировщик для вывода потоков с разными скоростями RTMP или фрагментированного потока MP4 (Smooth Streaming).

![Динамический рабочий процесс][live-overview]

## <a id="scenario"></a>Стандартный сценарий потоковой передачи в режиме реального времени
Далее описываются задачи, связанные с созданием распространенных приложений динамической потоковой передачи.

1. Подключите видеокамеру к компьютеру. Запустите и настройте локальный динамический кодировщик, который выводит поток с разными скоростями RTMP или поток в формате "фрагментированный MP4" (Smooth Streaming). Дополнительные сведения см. в статье о [поддержке протокола RTMP в службах мультимедиа Azure и о динамических кодировщиках](http://go.microsoft.com/fwlink/?LinkId=532824).

    Это действие также можно выполнить после создания канала.
2. Создайте и запустите канал.

3. Получение входного URL-адреса канала.

    URL-адрес приема используется динамическим кодировщиком для отправки потока в канал.
4. Получите URL-адрес предварительного просмотра канала.

    С его помощью можно убедиться в том, что канал надлежащим образом получает поток.
5. Создайте программу.

    Если вы используете портал Azure, то при создании программы также создается ресурс-контейнер.

    Если вы используете пакет .NET SDK или REST, необходимо создать ресурс и указать его при создании программы.
6. Опубликуйте ресурс, связанный с программой.   

    >[!NOTE]
    >При создании учетной записи служб мультимедиа Azure в нее добавляется конечная точка потоковой передачи **по умолчанию** в состоянии **Остановлена**. Конечная точка потоковой передачи, из которой нужно передавать содержимое потоком, должна находиться в состоянии **Выполняется**.

7. Когда вы будете готовы начать потоковую передачу и архивацию, запустите программу.

8. При необходимости динамическому кодировщику можно дать сигнал начать показ рекламы. Реклама вставляется в выходной поток.

9. Чтобы остановить потоковую передачу и архивацию содержимого мероприятия, завершите работу программы.

10. Удалите программу (и при необходимости ресурс).     

## <a id="channel"></a>Описание канала и связанных с ним компонентов
### <a id="channel_input"></a>Конфигурации входа (приема) канала
#### <a id="ingest_protocols"></a>Протокол входного потока
Службы мультимедиа поддерживают прием динамических каналов с использованием фрагментированного MP4 и RTMP с поддержкой разных скоростей в качестве потоковых протоколов. Если выбран протокол потоковой передачи RTMP, для канала создаются две конечные точки приема (ввода):

* **Основной URL-адрес**задает полный URL-адрес основной конечной точки приема RTMP канала.
* **Дополнительный URL-адрес** (необязательно) задает полный URL-адрес дополнительной конечной точки приема RTMP канала.

Используйте дополнительный URL-адрес, чтобы повысить надежность и отказоустойчивость потока приема, а также отказоустойчивость кодировщика, особенно в следующих сценариях.

- Двойная передача одного кодировщика как по основному, так и по дополнительному URL-адресам.

    Основная цель такого приема — повысить устойчивость к колебаниям сети и ухудшению качества сигнала. Некоторые кодировщики RTMP не очень хорошо справляются с сетевыми отключениями. При отключении от сети кодировщик может прекратить кодирование, не отправляя буферизованные данные при возобновлении подключения. Это ведет к перебоям в работе и потере данных. Отключение сети может происходить из-за ее неисправности или во время технического обслуживания со стороны Azure. Основной и дополнительный URL-адреса минимизируют проблемы с сетью, а также обеспечивают управляемый процесс обновления. При каждом плановом отключении сети службы мультимедиа управляют первичным и вторичным отключением, обеспечивая отложенное отключение между двумя адресами. Это дает время кодировщикам поддерживать отправку данных и возобновлять подключение. Порядок отключений может быть случайным, но задержка между отключением основного и дополнительного или дополнительного и основного URL-адресов будет присутствовать всегда. В этом сценарии кодировщик по-прежнему является единственной точкой отказа.

- Несколько кодировщиков, каждый из которых осуществляет передачу в выделенную точку.

    Этот сценарий обеспечивает избыточность как кодировщиков, так и приема. В этом сценарии кодировщик1 передает сигнал на основной URL-адрес, а кодировщик2 — на дополнительный URL-адрес. При сбое одного из кодировщиков другой может по-прежнему отправлять данные. Избыточность данных при этом все равно поддерживается, так как службы мультимедиа не отключают основной и дополнительный URL-адреса одновременно. В этом сценарии предполагается, что кодировщики синхронизированы по времени и предоставляют абсолютно одинаковые данные.  

- Несколько кодировщиков, осуществляющих двойную передачу как по основному, так и по дополнительному URL-адресам.

    В этом сценарии оба кодировщика передают данные по основному и дополнительному URL-адресам. Это обеспечивает самую высокую надежность и отказоустойчивость, а также избыточность данных. Такая конфигурация может выдержать отключения и сбои обоих кодировщиков, даже если один из кодировщиков перестанет работать. В этом сценарии предполагается, что кодировщики синхронизированы по времени и предоставляют абсолютно одинаковые данные.  

Сведения о динамических кодировщиках RTMP см. в записи блога [Azure Media Services RTMP Support and Live Encoders](http://go.microsoft.com/fwlink/?LinkId=532824) (Поддержка RTMP в службах мультимедиа Azure и динамические кодировщики).

#### <a name="ingest-urls-endpoints"></a>URL-адреса (конечные точки) приема
Канал предоставляет входную конечную точку (URL-адрес приема), которая определяется в динамическом кодировщике, чтобы кодировщик мог передать потоки в каналы.   

URL-адреса приема можно получить при создании канала. Для этого каналу не обязательно находиться в состоянии **Выполняется**. Чтобы начать передавать данные каналу, его нужно перевести в состояние **Выполняется**. После того как канал начинает принимать данные, можно просмотреть поток через URL-адрес предварительного просмотра.

Предусмотрена возможность приема динамического потока в формате "фрагментированный MP4" (Smooth Streaming) по SSL-подключению. Для приема по протоколу SSL измените URL-адрес приема на HTTPS. В настоящее время прием RTMP по протоколу SSL не поддерживается.

#### <a id="keyframe_interval"></a>Интервал опорного кадра
При использовании локального динамического кодировщика для формирования потока с поддержкой нескольких скоростей интервал опорного кадра определяет длительность группы кадров (которая используется внешним кодировщиком). После того как канал получит входящий поток, вы можете предоставить динамический поток клиентским приложениям для воспроизведения в любом из следующих форматов: Smooth Streaming, динамическая адаптивная потоковая передача по протоколу HTTP (DASH) и HTTP Live Streaming (HLS). При динамической потоковой трансляции HLS всегда упаковывается динамически. По умолчанию службы мультимедиа автоматически вычисляют соотношение упаковки сегмента HLS (число фрагментов на сегмент) на основе интервала опорного кадра, полученного из динамического кодировщика.

В следующей таблице показано вычисление длительности сегментов.

| Интервал опорного кадра | Соотношение упаковки сегмента HLS (FragmentsPerSegment) | Пример |
| --- | --- | --- |
| Меньше или равно 3 секундам |3:1 |Если значение KeyFrameInterval (или GOP) равно 2 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 3 к 1. Это приведет к созданию сегмента HLS длительностью 6 секунд. |
| 3–5 секунд |2:1 |Если значение KeyFrameInterval (или GOP) равно 4 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 2 к 1. Это приведет к созданию сегмента HLS длительностью 8 секунд. |
| Более 5 секунд |1:1 |Если значение KeyFrameInterval (или GOP) равно 6 секундам, соотношение упаковки сегмента HLS по умолчанию будет равно 1 к 1. Это приведет к созданию сегмента HLS длительностью 6 секунд. |

Можно изменить соотношение фрагментов на сегмент, настроив вывод канала и установив параметр FragmentsPerSegment в ChannelOutputHls.

Также можно изменить значение интервала опорного кадра, установив свойство KeyFrameInterval в ChanneInput. Если явно задать значение KeyFrameInterval, соотношение упаковки сегмента HLS, FragmentsPerSegment, вычисляется с помощью правил, описанных выше.  

Если явно задать свойства KeyFrameInterval и FragmentsPerSegment, службы мультимедиа будут использовать значения, указанные пользователем.

#### <a name="allowed-ip-addresses"></a>Разрешенные IP-адреса
Вы можете определить IP-адреса, с которых разрешено публиковать видео в этом канале. Разрешенные IP-адреса можно указать следующим образом:

* отдельный IP-адрес (например, 10.0.0.1);
* диапазон IP-адресов, заданный с помощью IP-адреса и маски подсети CIDR (например,10.0.0.1/22);
* диапазон IP-адресов, заданный с помощью IP-адреса и маски подсети в десятичной записи (например, 10.0.0.1(255.255.252.0)).

Если IP-адреса не указаны и правила не заданы, все IP-адреса будут блокироваться. Чтобы разрешить все IP-адреса, создайте правило и задайте адрес 0.0.0.0/0.

### <a name="channel-preview"></a>Предварительный просмотр канала
#### <a name="preview-urls"></a>URL-адреса предварительного просмотра
Канал предоставляет конечную точку (URL-адрес) предварительного просмотра, с помощью которой можно проверить поток перед дальнейшей обработкой и доставкой.

Получить URL-адрес предварительного просмотра можно при создании канала. Для этого каналу не обязательно находиться в состоянии **Выполняется**. После запуска канала можно выполнить предварительный просмотр потока.

В настоящее время поток предварительного просмотра может доставляться только в формате фрагментированного MP4 (Smooth Streaming) вне зависимости от указанного входного типа. Для проверки потока Smooth Streaming можно использовать проигрыватель [Smooth Streaming Health Monitor](http://smf.cloudapp.net/healthmonitor). Также для просмотра потока можно воспользоваться проигрывателем, размещенным на портале Azure.

#### <a name="allowed-ip-addresses"></a>Разрешенные IP-адреса
Вы можете определить IP-адреса, которым разрешено подключаться к конечной точке предварительного просмотра. Если этого не сделать, будут разрешены все IP-адреса. Разрешенные IP-адреса можно указать следующим образом:

* отдельный IP-адрес (например, 10.0.0.1);
* диапазон IP-адресов, заданный с помощью IP-адреса и маски подсети CIDR (например,10.0.0.1/22);
* диапазон IP-адресов, заданный с помощью IP-адреса и маски подсети в десятичной записи (например, 10.0.0.1(255.255.252.0)).

### <a name="channel-output"></a>Вывод канала
Дополнительные сведения о выводе канала см.в разделе [Интервал опорного кадра](#keyframe_interval).

### <a name="channel-managed-programs"></a>Программы, управляемые каналом
Канал связан с программами, с помощью которых вы можете управлять публикацией и хранением сегментов динамического потока. Каналы управляют программами. Отношение между каналом и программой похоже на традиционное телевидение, где канал передает постоянный поток контента, а программа ограничена временным событием на этом канале.

Задать количество часов, в течение которых следует хранить записанное содержимое программы, можно с помощью параметра длины **окна архивирования** . Это значение может быть задано в диапазоне от 5 минут до 25 часов. Длина окна архивирования также определяет максимальный период, в пределах которого клиенты могут перемещаться назад во времени относительно текущей позиции в передаваемом потоке данных. Программы могут длиться в течение определенного времени, однако содержимое, выходящее за пределы окна указанной длины, теряется. Значение этого свойства также определяет максимальный размер манифестов клиентов.

Каждая программа связана с ресурсом, в котором хранится передаваемый в потоковом режиме контент. Ресурс сопоставляется с контейнером блочных BLOB-объектов в учетной записи хранения Azure. Файлы ресурса хранятся в этом контейнере как большие двоичные объекты. Чтобы опубликовать программу для просмотра потока клиентами, необходимо создать указатель OnDemand для соответствующего ресурса. С помощью этого указателя можно сформировать URL-адрес потоковой передачи данных, который предоставляется клиентам.

Канал поддерживает одновременную потоковую трансляцию до трех программ, поэтому можно создавать по несколько архивов одного и того же входящего потока. Благодаря этому можно публиковать и архивировать разные части транслируемого мероприятия. Предположим, например, что, согласно существующим нормативам, необходимо архивировать 6 часов программы, а транслировать только последние 10 минут. Для этого необходимо создать две одновременно работающие программы. Для одной из них настроено архивирование шести часов транслируемого мероприятия, но без публикации. Для второй программы настроено архивирование 10 минут с публикацией.

Не используйте существующие программы повторно для новых мероприятий. Вместо этого создайте новую программу для каждого события. Когда вы будете готовы начать потоковую передачу и архивацию, запустите программу. Чтобы остановить потоковую передачу и архивацию содержимого мероприятия, завершите работу программы.

Чтобы удалить архивированное содержимое, остановите и удалите программу, а затем удалите связанный с ней ресурс. Ресурс невозможно удалить, пока он используется какой-либо программой. Сначала нужно удалить программу.

Даже после остановки и удаления программы пользователи смогут запрашивать потоковую передачу архивированного видеосодержимого, пока не удален соответствующий ресурс. Если вы хотите сохранить архивированное содержимое, но при этом заблокировать возможность его потоковой передачи, удалите указатель.

## <a id="states"></a>Состояния канала и их сопоставление с режимом выставления счетов
Возможные значения для текущего состояния канала:

* **Остановлен.** Это начальное состояние канала после его создания. В этом состоянии можно изменять свойства канала, но потоковая передача запрещена.
* **Запуск.** Канал запускается. В этом состоянии обновление и потоковая передача запрещены. Если возникает ошибка, канал возвращается в состояние **Остановлен**.
* **Выполняется.** Канал может обрабатывать динамические потоки.
* **Остановка.** Канал останавливается. В этом состоянии обновление и потоковая передача запрещены.
* **Удаление.** Канал удаляется. В этом состоянии обновление и потоковая передача запрещены.

В таблице ниже показано, как состояния канала соотносятся с режимом выставления счетов.

| Состояние канала | Индикаторы в пользовательском интерфейсе портала | Выставление счетов |
| --- | --- | --- | --- |
| **Запуск** |**Запуск** |Нет (переходное состояние) |
| **Выполнение** |**Готово** (нет запущенных программ)<p><p>или<p>**Потоковая передача** (запущена по крайней мере одна программа) |Yes |
| **Остановка** |**Остановка** |Нет (переходное состояние) |
| **Stopped** |**Stopped** |Нет  |

## <a id="cc_and_ads"></a>Вставка субтитров и рекламы
В следующей таблице показаны поддерживаемые стандарты субтитров и рекламы.

| Стандартная | Заметки |
| --- | --- |
| CEA-708 и EIA-608 (708/608) |CEA-708 и EIA-608 — это стандарты субтитров для США и Канады.<p><p>В настоящее время субтитры поддерживаются, только если они передаются в закодированном входном потоке. Необходимо использовать динамический кодировщик мультимедиа, который может вставлять субтитры стандарта 608 или 708 в закодированный поток, передаваемый службам мультимедиа. Службы мультимедиа доставляют зрителям контент с субтитрами. |
| TTML в ismt (текстовые дорожки Smooth Streaming) |Динамическая упаковка служб мультимедиа позволяет клиентам выполнять потоковую передачу контента в любом из следующих форматов: DASH, HLS или Smooth Streaming. Однако если вы принимаете фрагментированный поток MP4 (Smooth Streaming) с субтитрами внутри ISMT (текстовых дорожек Smooth Streaming), вы сможете доставлять контент только клиентам Smooth Streaming. |
| SCTE-35 |SCTE-35 — это цифровая система передачи сигналов, которая используется для вставки рекламы. Получатели используют сигнал для вставки рекламы в поток на отведенное время. Данные SCTE-35 следует передавать в виде отдельной дорожки во входном потоке.<p><p>В настоящее время поддерживается только один формат входного потока, который переносит рекламные сигналы, — фрагментированный MP4 (Smooth Streaming). Единственным поддерживаемый выходной формат — это также Smooth Streaming. |

## <a id="considerations"></a>Рекомендации
При использовании локального динамического кодировщика для отправки потока с разными скоростями в канал действуют следующие ограничения.

* Убедитесь, что имеется достаточно свободных возможностей подключения к Интернету для отправки данных точкам приема.
* Для использования дополнительного URL-адреса приема требуется дополнительная пропускная способность.
* Входящий поток с разными скоростями может предоставлять не более 10 уровней качества видео (слоев) и не более 5 звуковых дорожек.
* Наибольшая средняя скорость передачи для любого из уровней качества видео не должна превышать 10 Мбит/с.
* Общее значение средних скоростей для всех видео- и аудиопотоков всегда должно быть меньше 25 Мбит/с.
* Во время работы канала или связанных с ним программ входной протокол изменить нельзя. Если вам нужны другие протоколы, создайте отдельный канал для каждого из них.
* Канал может принимать поток с одной скоростью передачи. Но из-за того, что поток не обрабатывается каналом, клиентские приложения также будут получать поток с одной скоростью. (Этот вариант не рекомендуется.)

Ниже приведены другие рекомендации по работе с каналами и связанными компонентами.

* Каждый раз при повторной настройке динамического кодировщика вызывайте для канала метод **Reset** . Перед сбросом канала нужно остановить программу. После сброса канала перезапустите программу.

  > [!NOTE]
  > Когда вы перезапускаете программу, необходимо связать ее с новым ресурсом и создать новый указатель. 
  
* Канал можно остановить, только если он находится в состоянии **Выполняется** и все передаваемые по нему программы остановлены.
* По умолчанию в учетную запись служб мультимедиа можно добавить не более пяти каналов. Дополнительные сведения см. в статье [Квоты и ограничения](media-services-quotas-and-limitations.md).
* Счета выставляются, только когда канал находится в состоянии **Выполняется**. Дополнительные сведения см. в разделе [Состояния канала и их сопоставление с режимом выставления счетов](media-services-live-streaming-with-onprem-encoders.md#states).

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../../includes/media-services-learning-paths-include.md)]

## <a name="feedback"></a>Отзыв
[!INCLUDE [media-services-user-voice-include](../../../includes/media-services-user-voice-include.md)]

## <a name="related-topics"></a>Связанные разделы
[Рекомендуемые локальные кодировщики](media-services-recommended-encoders.md)

[Спецификация приема фрагментированного MP4 в реальном времени в службах мультимедиа Azure](media-services-fmp4-live-ingest-overview.md)

[Общие сведения о службах мультимедиа Azure и распространенные сценарии](media-services-overview.md)

[Основные понятия служб мультимедиа Azure](media-services-concepts.md)

[live-overview]: ./media/media-services-manage-channels-overview/media-services-live-streaming-current.png
