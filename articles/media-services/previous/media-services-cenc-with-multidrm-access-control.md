---
title: 'CENC с несколькими DRM и контролем доступа: справочная структура и реализация в Azure и службах мультимедиа Azure | Документация Майкрософт'
description: Сведения о лицензировании пакета для портирования клиента бесперебойной потоковой передачи Microsoft Smooth Streaming.
services: media-services
documentationcenter: ''
author: willzhan
manager: cfowler
editor: ''
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 8f072f13909190eee194565673ccfa1f381f7503
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a>CENC с несколькими DRM и управлением доступом: справочная структура и реализация в Azure и Azure Media Services
 
## <a name="introduction"></a>Введение
Проектирование и построение подсистемы управления цифровыми правами (DRM) для OTT или веб-решений для потоковой передачи — непростая задача. Общепринятой практикой операторов и поставщиков веб-видео является передача этой задачи на реализацию специализированным поставщикам служб DRM. Цель данного документа — предоставить справочную структуру и реализацию готовой подсистемы DRM в OTT или веб-решении для потоковой передачи.

Этот документ предназначен для инженеров, работающих в подсистеме DRM OTT или с веб-решениями для потоковой передачи или с несколькими экранами, а также для всех читателей, заинтересованных в подсистеме DRM. Предполагается, что читатели знакомы по крайней мере с одной из технологий DRM на рынке, например PlayReady, Widevine, FairPlay или Adobe Access.

В этом обсуждении DRM мы также рассмотрим общее шифрование (CENC) с несколькими подсистемами DRM. Основной тенденцией в отрасли интерактивной потоковой передачи и OTT является использование CENC с несколькими собственными DRM на различных клиентских платформах. Это переход от предыдущей тенденции использования единого DRM и клиентского пакета SDK для различных клиентских платформ. При использовании CENC с несколькими собственными DRM и PlayReady, и Widevine шифруются посредством спецификации [стандартного шифрования (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/).

Ниже приведены преимущества CENC с несколькими DRM:

* Снижается стоимость шифрования, так как используется единая обработка шифрования для разных платформ с собственными DRM.
* Снижаются расходы на управление зашифрованными ресурсами, так как требуется только одна копия зашифрованных ресурсов.
* Исключаются расходы на лицензирование клиента DRM, так как собственный клиент DRM обычно предоставляется бесплатно на собственной платформе.

Майкрософт является активным распространителем DASH и CENC вместе с некоторыми крупнейшими компаниями отрасли. Службы мультимедиа Azure предоставляют поддержку DASH и CENC. Последние объявления см. в следующих блогах:

*  [Анонс служб доставки лицензий Google Widevine в службах мультимедиа Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/)
* [Azure Media Services adds Google Widevine packaging for delivering multi-DRM stream](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/) (Добавление пакета Google Widevine в Службах мультимедиа Azure для предоставления потоковой передачи с несколькими DRM)  

### <a name="overview-of-this-article"></a>Описание раздела
Цели этой статьи:

* Предоставить справочную структуру подсистемы DRM с помощью CENC с несколькими DRM.
* Предоставить справочную реализацию на платформе Azure или Служб мультимедиа Azure.
* Рассмотреть некоторые вопросы проектирования и реализации.

В этой статье термин "несколько DRM" распространяется на следующие продукты:

* Microsoft PlayReady
* Google Widevine
* Apple FairPlay 

В следующей таблице перечислены собственные платформы, приложения и браузеры, поддерживаемые каждой службой DRM.

| **Платформа клиента** | **Поддержка собственного DRM** | **Браузер или приложение** | **Форматы потоковой передачи** |
| --- | --- | --- | --- |
| **Смарт-ТВ, операторские STB, OTT STB** |В основном PlayReady и (или) Widevine и (или) другие |Linux, Opera и WebKit, другие |Различные форматы |
| **Устройства Windows 10 (компьютер с Windows, планшеты с Windows, Windows Phone, Xbox)** |PlayReady |MS Edge/IE11/EME<br/><br/><br/>Универсальные приложения Windows |DASH (PlayReady не поддерживается для HLS)<br/><br/>DASH, Smooth Streaming (PlayReady не поддерживается для HLS) |
| **Устройства Android (телефоны, планшеты, телевизоры)** |Widevine |Chrome или EME |DASH, HLS |
| **iOS (iPhone, iPad), клиенты OS X и Apple TV** |FairPlay |Safari 8+ или EME |HLS |


С учетом текущего состояния развертывания для каждого DRM службе обычно требуется реализовать 2 или 3 DRM, чтобы вы могли максимально эффективно использовать все типы конечных точек.

Существует компромиссное решение, позволяющее справиться со сложностями логики службы и сложностями на стороне клиента по достижению определенного уровня работы пользователей на различных клиентах.

Делая выбор, необходимо иметь в виду следующее:

* Технология PlayReady изначально реализована на всех устройствах Windows, на некоторых устройствах Android и доступна в пакетах SDK программ практически на любой платформе.
* Widevine изначально реализована на каждом устройстве Android, Chrome и некоторых других устройствах.
* Технология FairPlay доступна только на клиентах iOS и Mac OS или через iTunes.

Существует два варианта типичных структур с несколькими подсистемами DRM:

* PlayReady и Widevine;
* PlayReady, Widevine и FairPlay.

## <a name="a-reference-design"></a>Справочное проектирование
В этом разделе мы представим справочную структуру, не зависящую от технологий, используемых для ее реализации.

Подсистема DRM может содержать следующие компоненты:

* Управление ключами
* Упаковка DRM
* Доставка лицензий DRM
* Проверка прав
* Проверка подлинности и авторизация
* Проигрыватель
* Исходная сеть доставки содержимого (CDN).

На следующей схеме представлено взаимодействие высокого уровня между компонентами в подсистеме DRM:

![Подсистема DRM с CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

Структура состоит из трех основных уровней:

* Уровень операционного отдела организации (черный), который не предоставляется внешним объектам.
* Уровень сети периметра (темно-синий) содержит все общедоступные конечные точки.
* Уровень общедоступного Интернета (светло-синий), содержащий CDN и проигрыватели с трафиком через общедоступный Интернет.

Кроме того, должно быть внедрено средство управления содержимым для контроля защиты DRM независимо от используемого шифрования (статического или динамического). Входные данные для шифрования DRM должны включать:

* видеосодержимое MBR;
* Ключ содержимого
* URL-адреса для приобретения лицензии;

Во время воспроизведения поток верхнего уровня включает:

* Проверку подлинности пользователя.
* Создание маркера авторизации пользователя.
* Загрузку защищенного DRM содержимого (манифест) в проигрыватель.
* Отправку проигрывателем запроса на приобретение лицензий на серверы лицензий вместе с идентификатором ключа и маркером авторизации.

В следующем разделе описываются структуры управления ключами.

| **Отношение ContentKey к ресурсу** | **Сценарий** |
| --- | --- |
| "Один к одному" |Простейший случай. Он предоставляет самый лучший контроль. Однако обычно этот договор приводит к наибольшей стоимости доставки лицензий. Для каждого защищенного ресурса требуется минимум один запрос лицензии. |
| "Один ко многим" |Можно использовать тот же ключ содержимого для нескольких ресурсов. Например, для всех ресурсов в логической группе, такой как жанр или подмножество жанров (или жанр фильма), можно использовать один ключ содержимого. |
| "Многие к одному" |Несколько ключей содержимого необходимы для каждого ресурса. <br/><br/>Например, если необходимо применить динамическую защиту CENC с несколькими DRM для MPEG-DASH и динамическое шифрование AES-128 для HLS, требуется два отдельных ключа содержимого. Каждый из ключей имеет свой собственный ContentKeyType. (Для ключа содержимого, используемого для динамической защиты CENC, следует применять ContentKeyType.CommonEncryption. Для ключа содержимого, применяемого для динамического шифрования AES-128, используйте ContentKeyType.EnvelopeEncryption).<br/><br/>Другой пример: в защите CENC содержимого DASH теоретически можно использовать один ключ содержимого для защиты видеопотока и другой ключ содержимого для защиты аудиопотока. |
| "Многие ко многим" |Сочетание описанных выше сценариев. Один набор ключей содержимого используется для каждого из нескольких ресурсов в одной группе ресурсов. |

Другим важным вопросом является использование постоянных и временных лицензий.

Почему эти вопросы важны?

Они имеют непосредственное влияние на стоимость доставки лицензий при использовании общедоступного облака для доставки постоянных и временных лицензий. Рассмотрим следующие два случая разных структур для иллюстрации:

* Ежемесячная подписка: используйте постоянную лицензию и 1 ключ содержимого для нескольких ресурсов. Например, для всех детских фильмов мы используем один ключ содержимого для шифрования. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств, = 1

* Ежемесячная подписка: используйте временную лицензию и 1 ключ содержимого для 1 ресурса. В данном случае:

    Общее число лицензий, запрашиваемых для всех детских фильмов или устройств, = [число просмотренных фильмов] x [число сеансов]

Два различных варианта дают очень разные шаблоны запросов лицензий. Следовательно, и затраты на доставку лицензий, осуществляемую через общедоступное облако, например через Службы мультимедиа.

## <a name="map-design-to-technology-for-implementation"></a>Сопоставление структуры и технологии для реализации
Далее мы сопоставим универсальную структуру и технологии на платформе Azure и Служб мультимедиа Azure, указав, какую технологию использовать для каждого стандартного блока.

Сопоставление показано в следующей таблице.

| **Стандартный блок** | **Технология** |
| --- | --- |
| **Проигрыватель** |[Проигрыватель мультимедиа Azure](https://azure.microsoft.com/services/media-services/media-player/) |
| **Поставщик удостоверений (IDP)** |Azure Active Directory (Azure AD) |
| **Служба маркеров безопасности (STS)** |Azure AD |
| **Рабочий процесс защиты DRM** |Динамическая защита Служб мультимедиа |
| **Доставка лицензий DRM** |* Доставка лицензий Служб мультимедиа (PlayReady, Widevine, FairPlay) <br/>* Сервер лицензирования Axinom <br/>* Пользовательский сервер лицензирования PlayReady |
| **Исходный домен** |Конечная точка потоковой передачи служб мультимедиа |
| **Управление ключами** |Не требуется для справочной реализации |
| **Управление содержимым** |Консольное приложение C# |

Другими словами в Azure AD используются поставщик удостоверений и служба маркеров безопасности. Для проигрывателя используется [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). Службы мультимедиа и Проигрыватель мультимедиа поддерживают DASH и CENC с несколькими DRM.

Следующая схема показывает общую структуру и поток с описанным выше сопоставлением технологии:

![CENC в Службах мультимедиа](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

Чтобы настроить динамическое шифрование CENC, средство управления содержимым будет использовать следующие входные данные:

* открытое содержимое;
* ключ содержимого из раздела создания и управления ключом;
* URL-адреса для приобретения лицензии;
* список сведений из Azure AD.

Выходные данные средства управления содержимым будут выглядеть так:

* ContentKeyAuthorizationPolicy, содержащая спецификацию на способ доставки лицензий, проверяет веб-маркер JSON (JWT) и спецификации лицензий DRM.
* AssetDeliveryPolicy, содержащая спецификации потоковых форматов, защиту DRM и URL-адреса приобретения лицензий.

Ниже приведена последовательность действий во время выполнения:

* После проверки подлинности пользователя создается маркер JWT.
* Одно из утверждений, содержащихся в маркере JWT, является утверждением группы и содержит идентификатор объекта группы EntitledUserGroup. Это утверждение используется для проверки прав.
* Проигрыватель загружает клиентский манифест содержимого, защищенного с помощью CENC, и определяет следующее:
   * идентификатор ключа;
   * содержимое защищено CENC;
   * URL-адреса для приобретения лицензии.
* Проигрыватель делает запрос на приобретение лицензий на основании поддерживаемого браузера и DRM. Идентификатор ключа и маркер JWT также отправляются в запросе на приобретение лицензии. Перед выдачей необходимых лицензий служба доставки лицензий проверяет маркер JWT и содержащиеся утверждения.

## <a name="implementation"></a>Реализация
### <a name="implementation-procedures"></a>Процедуры реализации
Реализация включает в себя следующие шаги:

1. Подготовка тестовых ресурсов. Кодирование или упаковка тестового видео в формат MP4 с разными скоростями в службах мультимедиа. Этот ресурс *НЕ* защищен DRM. Защита DRM будет реализована позже с помощью динамической защиты.

2. Создание идентификатора ключа и ключа содержимого (при необходимости из начального значения). В этом случае система управления ключами не требуется, так как мы имеем дело только с одним набором идентификатора ключа и ключа содержимого для нескольких тестовых ресурсов.

3. Использование API Служб мультимедиа для настройки службы доставки лицензий с несколькими DRM для тестовых ресурсов. Если ваша компания или поставщик компании использует пользовательские серверы лицензий вместо служб лицензирования в Службах мультимедиа, можно пропустить этот шаг. URL-адреса приобретения лицензий можно указать на этапе настройки доставки лицензий. API Служб мультимедиа необходим, чтобы указать подробные конфигурации, например ограничения политики авторизации, шаблоны ответов лицензий для различных лицензионных служб DRM. В настоящее время портал Azure пока не предоставляет необходимый пользовательский интерфейс для этой конфигурации. Дополнительные сведения об уровне API и пример кода см. в статье [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-playready-widevine.md).

4. Использование API Служб мультимедиа для настройки политики доставки ресурсов для тестовых ресурсов. Дополнительные сведения об уровне API и пример кода см. в статье [Использование общего динамического шифрования PlayReady и (или) Widevine DRM](media-services-protect-with-playready-widevine.md).

5. Создание и настройка клиента Azure AD в Azure.

6. Создание нескольких учетных записей пользователей и групп в клиенте Azure AD. Создайте по крайней мере группу "Пользователи с правами" и добавьте в нее пользователя. Пользователи этой группы проходят проверку прав на получение лицензии. Пользователи, не входящие в эту группу, не могут пройти проверку подлинности и получить лицензию. Членство в группе "Пользователи с правами" является обязательным утверждением группы в маркере JWT, выданном Azure AD. Это требование утверждения должно быть указано при настройке служб доставки лицензий с несколькими DRM.

7. Создание приложения ASP.NET MVC для размещения вашего видеопроигрывателя. Это приложение ASP.NET будет защищено с помощью проверки подлинности пользователей в клиенте Azure Active Directory. Соответствующие утверждения будут включены в маркеры доступа, получаемые после проверки подлинности пользователя. На этом шаге рекомендуется использовать API OpenID Connect. Установите следующие пакеты NuGet:

   * Install-Package Microsoft.Azure.ActiveDirectory.GraphClient
   * Install-Package Microsoft.Owin.Security.OpenIdConnect
   * Install-Package Microsoft.Owin.Security.Cookies
   * Install-Package Microsoft.Owin.Host.SystemWeb
   * Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory

8. Создание проигрывателя с помощью [API Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/). [API ProtectionInfo Проигрывателя мультимедиа Azure](http://amp.azure.net/libs/amp/latest/docs/) позволяет указать, какие технологии DRM следует использовать на разных платформах DRM.

9. Сопоставление показано в тестовой матрице.

    | **DRM** | **"Обзор"** | **Результат для соответствующего пользователя** | **Результат для не соответствующего пользователя** |
    | --- | --- | --- | --- |
    | **PlayReady** |Microsoft Edge или Internet Explorer 11 в Windows 10 |Успешно |Fail; |
    | **Widevine** |Chrome на Windows 10 |Успешно |Fail; |
    | **FairPlay** |ПОДЛЕЖИТ УТОЧНЕНИЮ | | |

Дополнительные сведения о настройке Azure AD для приложения проигрывателя ASP.NET MVC см. в статье [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/) (Интеграция приложения на основе OWIN MVC Служб мультимедиа Azure с Azure Active Directory и ограничение доставки ключей содержимого на основе утверждений JWT).

Дополнительные сведения см. в статье [JWT token Authentication in Azure Media Services and Dynamic Encryption](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/) (Проверка подлинности маркера JWT в службах мультимедиа Azure и динамическое шифрование).  

Сведения об Azure AD:

* Сведения для разработчиков см. в [руководстве разработчика по Azure Active Directory](../../active-directory/active-directory-developers-guide.md).
* Сведения для администраторов см. в статье [Управление каталогом Azure AD](../../active-directory/active-directory-administer.md).

### <a name="some-issues-in-implementation"></a>Некоторые проблемы в реализации
Используйте следующие сведения по устранению неполадок при реализации.

* URL-адрес издателя должен заканчиваться символом "/". Значением параметра audience должен быть идентификатор клиента приложения проигрывателя. Кроме того, добавьте символ "/" в конце URL-адреса издателя.

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    В [декодере JWT](http://jwt.calebb.net/) должны быть **aud** и **iss**, как показано ниже в маркере JWT:

    ![JWT](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)

* Добавьте разрешения для приложения в AAD (на вкладке **Настройка** приложения). Разрешения необходимы для каждого приложения (локальной и развернутой версий).

    ![Разрешения](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)

* Используйте правильного издателя при настройке динамической защиты CENC.

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    Следующий пример не сработает:

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    Идентификатор GUID — идентификатор клиента AAD. Идентификатор GUID можно найти во всплывающем меню **Конечные точки** на портале Azure.

* Предоставление привилегий утверждения членства в группе. Убедитесь, что в файле манифеста приложения AAD содержится следующее: 

    "groupMembershipClaims": "All", (значение по умолчанию: null)

* Установите правильный TokenType при создании требований к ограничениям.

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    После добавления поддержки для JWT (AAD) в дополнение к SWT (ACS) значение по умолчанию TokenType — TokenType.JWT. Если вы используете SWT и ACS, необходимо задать значение маркера TokenType.SWT.

## <a name="additional-topics-for-implementation"></a>Дополнительные разделы по реализации
В этом разделе мы рассмотрим некоторые дополнительные вопросы в нашей теме о проектировании и реализации.

### <a name="http-or-https"></a>HTTP или HTTPS?
Приложение проигрывателя ASP.NET MVC, которое мы разработали, должно поддерживать следующее:

* Проверку подлинности пользователя через Azure AD, который должен находиться в разделе HTTPS.
* Обмен маркерами JWT между клиентом и Azure AD, который находится в разделе HTTPS.
* Приобретение лицензий DRM клиентом, который должен находиться в разделе HTTPS, если доставка лицензий осуществляется Службами мультимедиа. Набор продуктов PlayReady не требует HTTPS для доставки лицензий. Если ваш сервер лицензирования PlayReady находится за пределами Служб мультимедиа, можно использовать HTTP или HTTPS.

Приложение проигрывателя ASP.NET использует рекомендуемый протокол HTTPS, поэтому проигрыватель находится на странице в разделе HTTPS. Тем не менее, для потоковой передачи предпочтительно использовать HTTP, поэтому следует обратить внимание на проблему смешанного содержимого.

* Браузер запрещает смешанное содержимое. Однако подключаемые модули, например Silverlight и OSMF для бесперебойной работы и DASH, разрешают. Смешанное содержимое является угрозой безопасности — это происходит из-за возможности вставить вредоносные JavaScript, что может подвергнуть риску данные клиента. Браузеры по умолчанию блокируют эту возможность. На данный момент единственным способом обойти это на стороне сервера (источника) — разрешить все домены (и HTTPS, и HTTP). Это, скорее всего, тоже не самая лучшая идея.
* Не следует использовать смешанное содержимое. Приложение проигрывателя и Проигрыватель мультимедиа должны использовать HTTP или HTTPS. При воспроизведении смешанного содержимого технология silverlightSS требует удаления предупреждения о смешанном содержимом. Технология flashSS обрабатывает смешанное содержимое без предупреждения о смешанном содержимом.
* Если конечная точка потоковой передачи была создана до августа 2014 г., она не будет поддерживать протокол HTTPS. В этом случае создайте и используйте новую конечную точку потоковой передачи для использования протокола HTTPS.

В справочной реализации в случае защищенного DRM содержимого и приложения, и потоковая передача будут в разделе HTTPS. Для открытого содержимого проигрывателю не требуется лицензия или проверка подлинности, и вы можете использовать протокол HTTP или HTTPS.

### <a name="azure-active-directory-signing-key-rollover"></a>Смена ключей подписывания Azure Active Directory
Смену ключей подписывания важно учитывать при реализации. Если вы проигнорируете это, готовая система в конечном итоге полностью перестанет работать в течение максимум шести недель.

Azure AD использует отраслевой стандарт для установления доверительных отношений между собой и приложениями, использующими Azure AD. В частности, Azure AD использует ключ подписывания, состоящий из пары открытого и закрытого ключей. Когда Azure AD создает маркер безопасности, который содержит сведения о пользователе, он подписывается с помощью Azure AD, используя свой закрытый ключ перед отправкой в приложение. Чтобы убедиться, что маркер является допустимым и получен от Azure AD, приложение должно проверить его подпись. Приложение использует открытый ключ, который предоставляется Azure AD и содержится в документе метаданных федерации клиента. Этот открытый ключ — и ключ подписывания, от которого он происходит, — аналогичен тому, который используется для всех клиентов в Azure AD.

Дополнительные сведения о смене ключей Azure AD см. в статье [Смена ключей подписывания Azure Active Directory](../../active-directory/active-directory-signing-key-rollover.md).

Между [парой открытого и закрытого ключей](https://login.microsoftonline.com/common/discovery/keys/):

* Закрытый ключ используется Azure AD для создания JWT.
* Открытый ключ используется приложением, таким как службы доставки лицензий DRM в AMS, для проверки маркера JWT.

В целях безопасности Azure Active Directory периодически сменяет этот сертификат (каждые 6 недель). В случае нарушения безопасности смена ключей может произойти любое время. Таким образом, службам доставки лицензий в Службах мультимедиа необходимо обновить открытый ключ, используемый по мере смены пары ключей Azure AD. В противном случае произойдет сбой проверки подлинности маркера в AMS и лицензия не будет выдана.

Это достигается путем установки TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument при настройке службы доставки лицензий DRM.

Ниже приведена последовательность обработки JWT:

* Azure AD выдаст маркер JWT с текущим закрытым ключом для прошедшего проверку пользователя.
* Когда проигрыватель обнаруживает CENC с защищенным несколькими DRM содержимым, он сначала ищет маркер JWT, выданный Azure AD.
* Проигрыватель отправляет запрос на приобретение лицензии с маркером JWT в Службы доставки лицензий в службы мультимедиа.
* Службы доставки лицензий в Службах мультимедиа будут использовать текущий и допустимый открытый ключ из Azure AD для проверки маркера JWT перед выдачей лицензий.

Службы доставки лицензий DRM всегда будут проверять текущий и допустимый открытый ключ из Azure AD. Открытый ключ, предоставленный Azure AD, будет ключом, используемым для проверки маркера JWT, выданного Azure AD.

Что делать, если смена ключей происходит после того, как AAD создал маркер JWT, но перед тем, как маркер JWT отправляется проигрывателями в службы доставки лицензий DRM в Службах мультимедиа для проверки?

Так как ключ может быть сменен в любой момент, всегда существует более одного допустимого открытого ключа в документе метаданных федерации. Доставка лицензий Служб мультимедиа может использовать любой из ключей, указанных в документе. Так как один ключ может быть сменен раньше, другой может оказаться его заменой и т. д.

### <a name="where-is-the-access-token"></a>Где маркер доступа?
Если взглянуть на то, как веб-приложение вызывает приложение API в разделе [Из веб-приложения в веб-интерфейс API](../../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), схема проверки подлинности выглядит следующим образом:

* Пользователь выполняет вход в Azure AD в веб-приложении. Дополнительные сведения см. в разделе [Из веб-браузера в веб-приложение](../../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).
* Конечная точка авторизации Azure AD перенаправляет агента пользователя в клиентское приложение с кодом авторизации. Агент пользователя возвращает код авторизации в URI перенаправления клиентского приложения.
* Чтобы веб-приложение могло выполнить проверку подлинности для веб-интерфейса API и получить нужный ресурс, это приложение должно получить маркер доступа. Оно отправляет запрос в конечную точку маркера Azure AD, предоставляя учетные данные, идентификатор клиента и URI идентификатора приложения веб-интерфейса API. Представляет код авторизации, чтобы доказать, что пользователь дал свое согласие.
* Azure AD проверяет подлинность приложения и возвращает маркер доступа JWT, который используется для вызова веб-интерфейса API.
* Веб-приложение использует возвращенный маркер доступа JWT, добавляя строку JWT с обозначением "Носитель" в заголовок авторизации запроса, отправляемого по протоколу HTTPS в веб-интерфейс API. Затем веб-API проверяет JWT. Если проверка прошла успешно, он возвращает нужный ресурс.

В этом потоке "удостоверения приложения" веб-интерфейс API доверяет тому, что веб-приложение проверило подлинность пользователя. По этой причине данная схема называется доверенной (надежной) подсистемой. На [диаграмме потока авторизации](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) отображается принцип действия предоставления кода авторизации.

При приобретении лицензий с ограничением маркера мы следуем тому же шаблону доверенной подсистемы. А служба доставки лицензий в службах мультимедиа — это ресурс веб-API, "внутренний ресурс", доступ к которому требуется веб-приложению. Так где же маркер доступа?

Маркер доступа получается из Azure AD. После успешной проверки подлинности пользователя возвращается код авторизации. Код авторизации затем используется совместно с идентификатором клиента и ключом приложения для обмена на маркер доступа. Маркер доступа предназначен для доступа к указывающему приложению, которое представляет службу доставки лицензий Служб мультимедиа.

Необходимо зарегистрировать и настроить указывающее приложение в Azure AD, выполнив следующие действия:

1. В клиенте Azure AD:

   * Добавьте приложение (ресурс) с URL-адресом входа: https://[resource_name].azurewebsites.net/. 
   * Добавьте идентификатор приложения с URL-адресом https://[aad_tenant_name].onmicrosoft.com/[resource_name].

2. Добавьте новый ключ для приложения ресурса.

3. Обновите файл манифеста приложения, чтобы свойство groupMembershipClaims имело следующее значение: "groupMembershipClaims": "All".

4. В приложении Azure AD, которое указывает на веб-приложение проигрывателя в разделе **Разрешения для других приложений**, добавьте приложение ресурса, которое было добавлено на шаге 1. В разделе **Delegated permission** (Делегированные разрешения) установите флажок **Доступ [имя_ресурса]**. Этот параметр дает разрешение веб-приложению создать маркеры доступа для доступа к приложению ресурса. Это следует сделать для локальной и развернутой версий веб-приложения при разработке с помощью веб-приложения Azure и Visual Studio.

Маркер JWT, выданный Azure AD, является маркером доступа, который используется для доступа к ресурсу указателя.

### <a name="what-about-live-streaming"></a>Как насчет динамической потоковой передачи?
Выше мы рассматривали ресурсы по требованию. Как насчет динамической потоковой передачи?

Вы можете использовать точно такую же структуру и реализацию для защиты динамической потоковой передачи в службах мультимедиа, рассматривая ресурс, связанный с программой, как ресурс VOD.

В частности, для реализации потоковой трансляции в Службах мультимедиа необходимо создать канал, а затем программу в рамках канала. Чтобы создать программу, необходимо создать ресурс, который будет содержать текущий архив для программы. Чтобы предоставить защиту динамического содержимого CENC с несколькими DRM, необходимо применить ту же программу установки и обработки к ресурсу, как если бы это был ресурс VOD, прежде чем запустить программу.

### <a name="what-about-license-servers-outside-media-services"></a>Как насчет серверов лицензирования за пределами служб мультимедиа?
Часто пользователи могли вложить средства в ферму серверов лицензирования в собственном центре обработки данных или у поставщика услуг DRM. Система защиты содержимого Служб мультимедиа дает возможность работы в гибридном режиме. Содержимое размещается и динамически защищается в Службах мультимедиа, в то же время лицензии DRM доставляются серверами за пределами Служб мультимедиа. В этом случае обратите внимание на следующие изменения:

* Служба маркеров безопасности должна выдавать маркеры, которые являются допустимыми и могут быть проверены на ферме серверов лицензий. Например, серверы лицензий Widevine, предоставляемые Axinom, требуют определенного маркера JWT, который содержит сообщение о правах. Таким образом, необходимо иметь STS для издания такого маркера JWT. Подробные сведения об этом типе реализации см. в [центре документации Azure](https://azure.microsoft.com/documentation/) и в статье [Использование Axinom для доставки лицензий Widevine в службах мультимедиа Azure](media-services-axinom-integration.md).
* Настройка службы доставки лицензий (ContentKeyAuthorizationPolicy) в Службах мультимедиа больше не требуется. Вам нужно предоставить URL-адреса приобретения лицензии (для PlayReady, Widevine и FairPlay) при настройке AssetDeliveryPolicy в ходе настройки CENC с несколькими DRM.

### <a name="what-if-i-want-to-use-a-custom-sts"></a>Что делать, если нужно использовать пользовательскую службу STS?
Клиент может использовать пользовательскую STS для предоставления маркеров JWT. Некоторые из причин:

* Поставщик удостоверений (IDP), используемый клиентом, не поддерживает STS. В этом случае решение — использовать пользовательскую службу STS.
* Клиенту может потребоваться более гибкий или более жесткий контроль при интеграции STS с системой выставления счетов подписчика клиента. Например, оператор MVPD может предлагать несколько пакетов подписчиков OTT, таких как Premium, Basic, Sports и т. д. Оператору может потребоваться сопоставить утверждения в маркере с пакетом подписчика, чтобы предоставлялось только содержимое в определенном пакете. В этом случае пользовательская STS предоставляет необходимую гибкость и контроль.

При применении пользовательской STS необходимо внести два изменения:

* При настройке службы доставки лицензий для ресурса необходимо указать ключ безопасности, используемый для проверки пользовательской STS вместо текущего ключа из Azure Active Directory. (Более подробное описание ниже). 
* Когда создается маркер JTW, вместо закрытого ключа текущего сертификата X509 в Azure AD указан ключ безопасности.

Существует два типа ключей безопасности:

* Симметричный ключ: тот же ключ используется для создания и проверки маркера JWT.
* Асимметричный ключ: пара открытого и закрытого ключей в сертификате X509 используется с закрытым ключом для шифрования и создания маркера JWT и с открытым ключом для проверки маркера.

> [!NOTE]
> При использовании .NET Framework/C# в качестве платформы разработки сертификат X509, используемый для асимметричного ключа безопасности, должен иметь длину ключа минимум 2048 бит. Это требование класса System.IdentityModel.Tokens.X509AsymmetricSecurityKey в .NET Framework. В противном случае будет создано следующее исключение:

> IDX10630: System.IdentityModel.Tokens.X509AsymmetricSecurityKey не может быть менее 2048 бит.

## <a name="the-completed-system-and-test"></a>Завершенная система и тестирование
В этом разделе мы рассмотрим несколько сценариев в завершенной комплексной системе, чтобы читатели получили базовое представление о поведении до получения учетной записи для входа:

* Если необходим неинтегрированный сценарий:

    * Видеоматериалы, размещенные в Службах мультимедиа либо не защищены, либо защищены DRM, но без проверки подлинности маркера (лицензия выдается тому, кто ее запрашивает). Вы можете проверить его без входа в систему. Переключитесь на использование HTTP, если ваше потоковое видео передается по протоколу HTTP.

* Если необходим полностью интегрированный сценарий:

    * При использовании видеоматериалов, на которые распространяется динамическая защита DRM в Службах мультимедиа с проверкой подлинности маркера и маркером JWT, создаваемым в Azure AD, необходимо войти в систему.

Дополнительные сведения о веб-приложении проигрывателя и его входе в систему см. на [этом веб-сайте](https://openidconnectweb.azurewebsites.net/).

### <a name="user-sign-in"></a>Вход пользователя
Чтобы протестировать полностью интегрированную систему DRM, необходимо создать или добавить учетную запись.

Какую учетную запись?

Хотя изначально система Azure разрешала доступ только пользователям учетных записей Майкрософт, теперь она позволяет получать доступ пользователям обеих систем. Теперь все свойства Azure стали доверять процессу проверки подлинности Azure AD, чтобы Azure AD выполняла проверку подлинности пользователей организации. Кроме того, были созданы федеративные отношения, при которых Azure AD доверяет системе идентификации Майкрософт выполнять проверку подлинности пользователей-клиентов. В результате Azure AD может проверять подлинность "гостевых" учетных записей Майкрософт, а также собственных учетных записей Azure AD.

Так как Azure AD доверяет домену учетных записей Майкрософт, можно добавить любые учетные записи из любого из следующих доменов в пользовательский клиент Azure AD и использовать учетную запись для входа:

| **Доменное имя** | **Домен** |
| --- | --- |
| **Домен пользовательского клиента Azure AD** |somename.onmicrosoft.com |
| **Домен организации** |microsoft.com |
| **Домен учетных записей Майкрософт** |outlook.com, live.com, hotmail.com |

Вы можете связаться с любым автором, чтобы получить созданную или добавленную учетную запись.

Ниже приведены снимки экранов различных страниц входа, используемых разными учетными записями домена:

**Учетная запись домена пользовательского клиента Azure AD**: в этом случае вы видите настраиваемую страницу входа домена пользовательского клиента Azure AD.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

**Учетная запись домена Майкрософт со смарт-картой**: в этом случае вы видите страницу входа, настроенную ИТ-специалистами корпорации Майкрософт, с двухфакторной проверкой подлинности.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

**Учетная запись Майкрософт**: в этом случае вы видите страницу входа учетной записи Майкрософт для потребителей.

![Учетная запись домена пользовательского клиента Azure AD](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="use-encrypted-media-extensions-for-playready"></a>Использование расширений зашифрованных носителей для PlayReady
В современных браузерах с поддержкой расширений зашифрованных носителей (EME) или PlayReady, таких как Internet Explorer 11 в Windows 8.1 и выше и Microsoft Edge в Windows 10, PlayReady является базовым решением DRM для EME.

![Использование EME для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

Темная область проигрывателя возникает из-за того, что защита PlayReady не позволяет сделать снимок экрана защищенного видео.

На следующем снимке экрана показаны подключаемые модули проигрывателя, а также поддержка Microsoft Security Essentials и EME:

![Подключаемые модули проигрывателя для PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

EME в Microsoft Edge и Internet Explorer 11 в Windows 10 позволяет вызывать [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) на поддерживающих устройствах Windows 10. PlayReady SL3000 разблокирует поток улучшенного содержимого премиум-класса (4K, HDR) и новые модели доставки содержимого (для улучшенного содержимого).

Если брать во внимание устройства Windows, PlayReady является единственной технологией DRM в оборудовании, доступной на устройствах Windows (PlayReady SL3000). Служба потоковой передачи может использовать PlayReady через EME или приложение универсальной платформы Windows. Благодаря PlayReady SL3000 она предлагает более высокое качество видеоизображения, чем другие DRM. Как правило, содержимое 2K будет передаваться через Chrome или Firefox, а содержимое 4K — через Microsoft Edge и Internet Explorer 11 или приложение универсальной платформы Windows на том же устройстве. Объем зависит от реализации и параметров службы.

#### <a name="use-eme-for-widevine"></a>Использование EME для Widevine
В современных браузерах с поддержкой EME и Widevine, таких как Chrome 41+ в Windows 10, Windows 8.1, Mac OSX Yosemite и Chrome в Android 4.4.4, Google Widevine является DRM в основе EME.

![Использование EME для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

Widevine не запрещает делать снимок экрана защищенного видео.

![Подключаемые модули проигрывателя для Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="unentitled-users"></a>Пользователи, не имеющие прав
Если пользователь не является участником группы "Пользователи с правами", то он не сможет пройти проверку прав. Служба лицензий с несколькими DRM откажется выдать запрашиваемую лицензию, как показано ниже. Подробное описание звучит "Не удалось получить лицензию", как это и было задумано.

![Пользователи, не имеющие прав](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="run-a-custom-security-token-service"></a>Запуск пользовательской службы маркеров безопасности
При запуске пользовательской STS маркер JWT выдается пользовательской службой маркеров безопасности с помощью симметричного или асимметричного ключа.

На следующем снимке экрана показан сценарий использования симметричного ключа (в Chrome):

![Пользовательская STS с симметричным ключом](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

На следующем снимке экрана показан сценарий использования асимметричного ключа через сертификат X509 (в современных браузерах Майкрософт):

![Пользовательская STS с асимметричным ключом](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

В обоих указанных случаях проверка подлинности пользователя остается неизменной. Она происходит через Azure AD. Единственное различие состоит в том, что маркеры JWT выдаются пользовательской STS вместо Azure AD. При настройке динамической защиты CENC ограничение службы доставки лицензий указывает тип маркера JWT — симметричный или асимметричный ключи.

## <a name="summary"></a>Сводка
В этом документе мы обсуждали CENC с несколькими собственными решениями DRM и функцией управления доступом через аутентификацию на основе маркера: проектирование и реализацию системы с помощью Azure, Служб мультимедиа и Проигрывателя мультимедиа.

* Мы представили справочную структуру, содержащую все необходимые компоненты в подсистеме DRM и CENC, а также
* справочную реализацию в Azure, Службах мультимедиа и Проигрывателе мультимедиа.
* Мы также обсудили некоторые вопросы, напрямую связанные с проектированием и реализацией.

## <a name="media-services-learning-paths"></a>Схемы обучения работе со службами мультимедиа
[!INCLUDE [media-services-learning-paths-include](../../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a>Отзывы
[!INCLUDE [media-services-user-voice-include](../../../includes/media-services-user-voice-include.md)]
 
