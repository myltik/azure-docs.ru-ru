---
title: Архитектура системы полнотекстового поиска Lucene в службе поиска Azure | Документация Майкрософт
description: Понятия обработки запросов Lucene и извлечения документов для полнотекстового поиска в контексте службы поиска Azure.
manager: jlembicz
author: yahnoosh
services: search
ms.service: search
ms.devlang: NA
ms.topic: conceptual
ms.date: 04/20/2018
ms.author: jlembicz
ms.openlocfilehash: 4382c3001f6b0a9227407beccb483347bccb387c
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32195024"
---
# <a name="how-full-text-search-works-in-azure-search"></a>Как работает полнотекстовый поиск в службе поиска Azure

Эта статья предназначена для разработчиков, которым нужно тщательно разобраться с работой полнотекстового поиска Lucene в поиске Azure. Для текстовых запросов служба поиска Azure в большинстве сценариев быстро предоставляет ожидаемые результаты, однако иногда вы можете получить и неточные результаты. В таких ситуациях понимание четырех этапов выполнения запросов Lucene (синтаксический анализ запроса, лексический анализ, поиск соответствующего документа и оценка) помогут определить характерные изменения параметров запроса или конфигурации индекса, которые приведут к желаемому результату. 

> [!Note] 
> В службе поиска Azure для полнотекстового поиска используется Lucene, но процесс не ограничивается интеграцией Lucene. Мы выборочно предоставили функции Lucene и расширили их, чтобы включить важные для поиска Azure сценарии. 

## <a name="architecture-overview-and-diagram"></a>Схема архитектуры и ее обзор

Обработка полнотекстового поискового запроса начинается с анализа текста запроса для извлечения поисковых терминов. Поисковая система использует индекс для извлечения документов, где есть соответствующие термины. Отдельные термины запроса иногда разбиваются и повторно собираются в новые формы, чтобы найти больше потенциальных совпадений. Результирующий набор затем сортируется по оценке релевантности, назначенной каждому отдельному документу с совпадением. Элементы в верхней части ранжированного списка возвращаются вызывающему приложению.

Итак, запрос выполняется в четыре этапа: 

1. синтаксический анализ запроса; 
2. лексический анализ; 
3. извлечение документа; 
4. оценка. 

На схеме ниже представлены компоненты, используемые для обработки поискового запроса. 

 ![Схема архитектуры запросов Lucene в службе поиска Azure][1]


| Ключевые компоненты | Описание функций | 
|----------------|------------------------|
|**Средства синтаксического анализа запроса** | Отделяют термины запроса от операторов и создают структуру запроса (дерево запроса), которая отправляется в поисковую систему. |
|**Анализаторы** | Выполняют лексический анализ терминов запроса, что может включать их преобразование, удаление или расширение. |
|**Индекс** | Эффективная структура данных, используемая для хранения и упорядочивания доступных для поиска терминов, извлеченных из индексированных документов. |
|**Поисковая система** | Извлекает и оценивает совпадающие документы на основе содержимого обращенного индекса. |

## <a name="anatomy-of-a-search-request"></a>Схема поискового запроса

Поисковый запрос представляет собой полную спецификацию содержимого, возвращаемого в результирующем наборе. В самой простой форме это пустой запрос с отсутствием каких-либо критериев. В более реалистичном примере он включает в себя параметры, несколько терминов запроса, вероятно, ограниченных определенными полями, выражение фильтра и правила упорядочения.  

Ниже приведен пример поискового запроса, который можно отправить в службу поиска Azure с помощью [интерфейса REST API](https://docs.microsoft.com/rest/api/searchservice/search-documents).  

~~~~
POST /indexes/hotels/docs/search?api-version=2017-11-11 
{  
    "search": "Spacious, air-condition* +\"Ocean view\"",  
    "searchFields": "description, title",  
    "searchMode": "any",
    "filter": "price ge 60 and price lt 300",  
    "orderby": "geo.distance(location, geography'POINT(-159.476235 22.227659)')", 
    "queryType": "full" 
 } 
~~~~

Для этого запроса, предназначенного для поиска отелей, поисковая система выполняет следующее:

1. Фильтрует документы, в которых цена составляет не менее 60 и не более 300  долл. США.
2. Выполняет запрос. В этом примере поисковый запрос содержит следующие фразы и термины: `"Spacious, air-condition* +\"Ocean view\""` (пользователи обычно не вводят знаки пунктуации, но здесь они помогут нам объяснить, каким образом такой запрос обрабатывают анализаторы). Для этого запроса поисковая система сканирует поля описания и заголовка, указанные в `searchFields` для документов, содержащих "Ocean view", а также дополнительно для термина "spacious" или терминов, которые начинаются с префикса "air-condition". Параметр `searchMode` используется для поиска совпадений по любому термину (по умолчанию) или по всем терминам, когда термин не требуется явным образом (`+`).
3. Упорядочивает результирующий набор отелей поблизости к определенному географическому расположению и возвращает его вызывающему приложению. 

В основном в этой статье рассматривается обработка *поискового запроса* `"Spacious, air-condition* +\"Ocean view\""`. Фильтрация и упорядочение выходят за рамки этого руководства. Дополнительные сведения см. в статье о [поиске документов с помощью интерфейса REST API службы поиска Azure](https://docs.microsoft.com/rest/api/searchservice/search-documents).

<a name="stage1"></a>
## <a name="stage-1-query-parsing"></a>Этап 1. Синтаксический анализ запроса 

Как было отмечено, строка запроса — это первая строка. 

~~~~
 "search": "Spacious, air-condition* +\"Ocean view\"", 
~~~~

Средство синтаксического анализа запросов отделяет операторы (`*` и `+` в нашем примере) от поисковых терминов, а затем заново формирует поисковый запрос, создавая *вложенные запросы* поддерживаемого типа: 

+ *запрос термина* — для автономных терминов (например, spacious);
+ *запрос фразы* — для терминов, заключенных в кавычки (например, ocean view);
+ *запрос префикса* — для терминов, за которыми следует оператор префикса `*` (например, air-condition).

Полный список поддерживаемых типов запросов см. в руководстве по [синтаксису запросов Lucene](https://docs.microsoft.com/rest/api/searchservice/lucene-query-syntax-in-azure-search).

Операторы, связанные с вложенными запросами, определяют, обязательно ли должен быть удовлетворен запрос, чтобы документ рассматривался в качестве подходящего. Например, запрос `+"Ocean view"` является обязательным, так как указан оператор `+`. 

Средство синтаксического анализа запросов перестраивает вложенные запросы в *дерево запроса* (внутреннюю структуру, представляющую запрос), которое передается в поисковую систему. На первом этапе синтаксического анализа запроса дерево запроса выглядит следующим образом:  

 ![Режим поиска логических запросов any][2]

### <a name="supported-parsers-simple-and-full-lucene"></a>Поддерживаемые средства синтаксического анализа запроса для упрощенного и полного языка запросов Lucene 

 Служба поиска Azure поддерживает два разных языка запросов — `simple` (по умолчанию) и `full`. Задавая параметр `queryType` для поискового запроса, вы сообщаете средству синтаксического анализа запросов выбранный язык запросов для верной интерпретации операторов и синтаксиса. [Язык простых запросов](https://docs.microsoft.com/rest/api/searchservice/simple-query-syntax-in-azure-search) является интуитивно понятным и надежным. В большинстве случаев он подходит для интерпретации введенных пользователем данных как есть, то есть без обработки на стороне клиента. Он поддерживает те же операторы запросов,что и поисковые системы в Интернете. [Язык расширенных запросов Lucene](https://docs.microsoft.com/rest/api/searchservice/lucene-query-syntax-in-azure-search). Чтобы задать этот язык, необходимо установить параметр `queryType=full`. Этот язык поддерживает большее количество типов операторов и запросов, например поиск нечетких соответствий, запросы с подстановочными знаками, регулярными выражениями и запросы, относящиеся к полям. Например, регулярное выражение, отправленное в простой синтаксис запросов, будет интерпретироваться как строка запроса, а не как выражение. В нашем примере запроса используется язык расширенных запросов Lucene.

### <a name="impact-of-searchmode-on-the-parser"></a>Влияние параметра searchMode на средство синтаксического анализа 

На синтаксический анализ также влияет поисковой параметр `searchMode`. Он управляет оператором по умолчанию для логических запросов: any (по умолчанию) или all.  

Если используется значение по умолчанию `searchMode=any`, разделителем пространства между spacious и air-condition является OR (`||`). Вот как выглядит пример текста запроса в таком случае: 

~~~~
Spacious,||air-condition*+"Ocean view" 
~~~~

Явные операторы, например `+` в `+"Ocean view"`, являются однозначными в конструкции логического запроса (для *обязательного* соответствия). Но как же будут интерпретироваться оставшиеся термины: spacious и air-condition? Нужно ли поисковой системе искать соответствия, где содержатся все термины: ocean view, *spacious* *и* air-condition? Или же нужно найти ocean view и *какой-либо* из оставшихся терминов? 

При использовании режима по умолчанию (`searchMode=any`) поисковая система использует расширенную интерпретацию. Будет выполняться поиск соответствия по какому-либо из терминов, что *представляет* семантику оператора or. Исходное дерево запроса выше с двумя необязательными операциями соответствует режиму по умолчанию.  

Предположим, что мы задали параметр `searchMode=all`. В этом случае пробел интерпретируется как оператор and. Каждый из оставшихся терминов обязательно должен находиться в документе для соответствия запросу. Результирующий пример запроса будет интерпретирован следующим образом: 

~~~~
+Spacious,+air-condition*+"Ocean view"  
~~~~

Измененное дерево запроса в этом случае будет выглядеть, как показано ниже. Соответствующий документ здесь представляет пересечение всех трех вложенных запросов. 

 ![Режим поиска логических запросов all][3]

> [!Note] 
> Для выполнения репрезентативных запросов лучше выбрать `searchMode=any`, а не `searchMode=all`. Пользователи, которые предпочитают использовать операторы (как правило, при поиске по хранилищам документов), могут получить более точные результаты, если с параметром `searchMode=all` указать операторы логических запросов. Дополнительные сведения о взаимосвязи между `searchMode` и операторами, см. в статье о [синтаксисе простых запросов в службе поиска Azure](https://docs.microsoft.com/rest/api/searchservice/simple-query-syntax-in-azure-search).

<a name="stage2"></a>
## <a name="stage-2-lexical-analysis"></a>Этап 2. Лексический анализ 

Лексические анализаторы обрабатывают *запросы терминов* и *запросы фраз* после формирования дерева запроса. Анализатор принимает текстовые входные данные, предоставленные ему синтаксическим анализатором, обрабатывает их, а затем отправляет обратно термины, снабженные маркером, для их последующего включения в дерево запроса. 

Чаще всего применяется *лингвистический анализ*, который преобразует термины запроса на основе правил, характерных для соответствующего языка, в частности: 

* сокращает термин запроса, оставляя только корень слова; 
* удаляет слова, которые не представляют смысла (стоп-слова, например артикли the и and в английском языке); 
* разбивает составные слова на части; 
* преобразовывает слова с верхним регистром в нижний. 

Цель всех этих операций — стереть различия между текстовыми входными данными, предоставленными пользователем, и терминами, сохраненными в индексе. Эти операции выходят за рамки обработки текста и требуют глубоких знаний самого языка. Чтобы включить такой уровень лингвистического контроля, служба поиска Azure поддерживает длинный список [языковых анализаторов](https://docs.microsoft.com/rest/api/searchservice/language-support) Lucene и Microsoft.

> [!Note]
> Требования анализа могут варьироваться от минимальных до четко детализированных в зависимости от вашего сценария. Вы можете контролировать уровень сложности лексического анализа, выбрав один из стандартных анализаторов или же создав свой собственный [пользовательский анализатор](https://docs.microsoft.com/rest/api/searchservice/Custom-analyzers-in-Azure-Search). Анализаторы могут использоваться в пределах полей, поддерживающих поиск, и задаются как часть определения поля. Таким образом, вы можете изменять лексический анализ на основе поля. Если конкретное определение не указано, используется *стандартный* анализатор Lucene.

В нашем примере (до анализа) начальное дерево запроса включает термин "Spacious,", содержащий прописную букву S, а также запятую, которую средство синтаксического анализа запросов интерпретирует как часть термина запроса (запятая не рассматривается как оператор языка запросов).  

Когда анализатор по умолчанию обрабатывает этот термин, "ocean view" и "spacious" преобразуются в нижний регистр, а запятая удаляется. Измененное дерево запроса будет выглядеть следующим образом: 

 ![Логический запрос с терминами после анализа][4]

### <a name="testing-analyzer-behaviors"></a>Проверка поведения анализатора 

Поведение анализатора можно проверить с помощью [API анализа](https://docs.microsoft.com/rest/api/searchservice/test-analyzer). Укажите текст, который необходимо проанализировать, чтобы увидеть, какие термины создаст анализатор. Например, чтобы увидеть, каким образом стандартный анализатор будет обрабатывать текст "air-condition", вы можете использовать запрос ниже.

~~~~
{ 
    "text": "air-condition",
    "analyzer": "standard"
}
~~~~

Стандартный анализатор разбивает входной текст на два следующих маркера, создавая для них атрибуты — startOffset и endOffset (используемые для выделения совпадений), а также атрибут position (для поиска совпадения фразы).

~~~~
{  
  "tokens": [
    {
      "token": "air",
      "startOffset": 0,
      "endOffset": 3,
      "position": 0
    },
    {
      "token": "condition",
      "startOffset": 4,
      "endOffset": 13,
      "position": 1
    }
  ]
}
~~~~

<a name="exceptions"></a>

### <a name="exceptions-to-lexical-analysis"></a>Исключения лексического анализа 

Лексический анализ применяется только к типам запросов, требующим поиска либо термина, либо фразы. Его нельзя применить к типам запросов с неполными терминами — запросам по префиксу, подстановочному знаку, регулярному выражению или поиску нечетких соответствий. Такие типы запросов, в том числе запрос префикса с термином *air-condition\** в нашем примере, добавляются непосредственно в дерево запроса, минуя этап анализа. Единственное преобразование для терминов запроса такого типа — преобразование в нижний регистр.

<a name="stage3"></a>

## <a name="stage-3-document-retrieval"></a>Этап 3. Извлечение документа 

Извлечение документа относится к поиску документов с совпадающими терминами в индексе. Лучше всего этот этап рассмотреть на примере. Начнем с индекса отелей. Итак, у нас есть следующая схема: 

~~~~
{   
    "name": "hotels",     
    "fields": [     
        { "name": "id", "type": "Edm.String", "key": true, "searchable": false },     
        { "name": "title", "type": "Edm.String", "searchable": true },     
        { "name": "description", "type": "Edm.String", "searchable": true }
    ] 
} 
~~~~

Предположим, что этот индекс содержит следующие четыре документа: 

~~~~
{ 
    "value": [
        {         
            "id": "1",         
            "title": "Hotel Atman",         
            "description": "Spacious rooms, ocean view, walking distance to the beach."   
        },       
        {         
            "id": "2",         
            "title": "Beach Resort",        
            "description": "Located on the north shore of the island of Kauaʻi. Ocean view."     
        },       
        {         
            "id": "3",         
            "title": "Playa Hotel",         
            "description": "Comfortable, air-conditioned rooms with ocean view."
        },       
        {         
            "id": "4",         
            "title": "Ocean Retreat",         
            "description": "Quiet and secluded"
        }    
    ]
}
~~~~

**Как индексируются термины**

Чтобы понять процесс извлечения, необходимо знать основные сведения об индексировании. Единицей хранения является обращенный индекс, по одному для каждого поля, доступного для поиска. Обращенный индекс содержит отсортированный список со всеми терминами из всех документов. Каждый термин сопоставляется со списком документов, в которых он встречается, что очевидно из примера ниже.

Чтобы создать термины в обращенном индексе, система поиска выполняет лексический анализ содержимого документов, схожий с процессом обработки запросов:

1. В зависимости от конфигурации анализатора *текстовые входные данные* передаются в анализатор, преобразуются в нижний регистр, знаки пунктуации в них удаляются и т. д. 
2. *Токены* являются выходными данными текстового анализа.
3. *Термины* добавляются в индекс.

По желанию вы можете использовать один анализатор для операций поиска и индексирования, чтобы термины запроса были больше похожи на термины запроса внутри индекса.

> [!Note]
> Служба поиска Azure позволяет указать различные анализаторы для индексирования и поиска с помощью дополнительных параметров полей — `indexAnalyzer` и `searchAnalyzer`. Если их не указать, анализатор с заданным свойством `analyzer` будет использоваться для двух операций — индексирования и поиска.  

**Обращенный индекс для примеров документов**

Возвращаясь к нашему примеру, для поля **заголовка** обращенный индекс будет выглядеть следующим образом:

| Термин | Список документов |
|------|---------------|
| atman | 1 |
| beach | 2 |
| hotel | 1, 3 |
| ocean | 4.  |
| playa | 3 |
| resort | 3 |
| retreat | 4. |

В поле заголовка только *hotel* встречается в двух документах — 1 и 3.

Для поля **описания** индекс выглядит следующим образом:

| Термин | Список документов |
|------|---------------|
| air | 3
| и | 4.
| beach | 1
| conditioned | 3
| comfortable | 3
| distance | 1
| island | 2
| kauaʻi | 2
| located | 2
| north | 2
| ocean | 1, 2, 3
| of | 2
| on |2
| quiet | 4.
| rooms  | 1, 3
| secluded | 4.
| shore | 2
| spacious | 1
| the | 1, 2
| значение | 1
| view | 1, 2, 3
| walking | 1
| на | 3


**Соответствие терминов запроса индексированным терминам**

Учитывая обращенные индексы выше, давайте вернемся к примеру запроса и узнаем, каким образом были найдены соответствующие документы для примера запроса. Вспомним, что конечное дерево запроса выглядит следующим образом: 

 ![Логический запрос с терминами после анализа][4]

Во время выполнения запроса отдельные запросы по отдельности выполняются к полям, доступным для поиска. 

+ Запрос термина "spacious" соответствует документу 1 (Hotel Atman). 

+ Запрос префикса "air-condition*" не соответствует ни одному документу. 

  Именно такие случаи и запутывают разработчиков. Несмотря на то что термин air-conditioned содержится в документе, он разделен на два термина анализатором по умолчанию. Вспомним, что запросы префикса, содержащие частичные термины, анализу не подлежат. Именно поэтому при поиске в обращенном индексе термины с префиксом "air-condition" не найдены.

+ Для запроса фразы "ocean view" был выполнен поиск по терминам "ocean" и "view" и проверка на приблизительные соответствия в исходном документе. Документы 1, 2 и 3 содержат совпадение в поле описания. Обратите внимание, документ 4 содержит термин ocean в заголовке, но соответствие не найдено, так как мы искали фразу "ocean view", а не отдельные слова. 

> [!Note]
> Поисковый запрос независимо выполняется по всем полям, доступным для поиска, в индексе поиска Azure, пока вы не ограничите поля, задав параметр `searchFields`, как показано в примере поискового запроса. Возвращаются документы, содержащие совпадение в любом из выбранных полей. 

В целом для рассматриваемого запроса возвращаются документы 1, 2 и 3. 

## <a name="stage-4-scoring"></a>Этап 4. Оценка  

Каждому документу в результирующем наборе поиска присваивается оценка релевантности. Функция оценки релевантности — задать более высокий приоритет документам, которые лучше соответствуют вопросам пользователей, выраженным в поисковом запросе. Оценка вычисляется на основе статистических свойств терминов, для которых найдены соответствия. Основным элементом формулы оценки является [TF-IDF (частота встречаемости термина — обратная частота документа)](https://en.wikipedia.org/wiki/Tf%E2%80%93idf). В запросах, содержащих редкие и распространенные термины, TF-IDF придает большую важность результатам для терминов, которые встречаются нечасто. Например, в гипотетическом индексе со всеми статьями Wikipedia среди документов, содержащих поисковой термин *the president*, документы, содержащие *president*, будут более релевантными по сравнению с теми, которые содержат *the*.


### <a name="scoring-example"></a>Пример оценки

Вспомните три документа, которые соответствовали примеру запроса:
~~~~
search=Spacious, air-condition* +"Ocean view"  
~~~~
~~~~
{  
  "value": [
    {
      "@search.score": 0.25610128,
      "id": "1",
      "title": "Hotel Atman",
      "description": "Spacious rooms, ocean view, walking distance to the beach."
    },
    {
      "@search.score": 0.08951007,
      "id": "3",
      "title": "Playa Hotel",
      "description": "Comfortable, air-conditioned rooms with ocean view."
    },
    {
      "@search.score": 0.05967338,
      "id": "2",
      "title": "Ocean Resort",
      "description": "Located on a cliff on the north shore of the island of Kauai. Ocean view."
    }
  ]
}
~~~~

Документ 1 лучше всего соответствовал запросу, так как в его поле описания содержится и термин *spacious*, и обязательная фраза *ocean view*. Следующие два документа содержат только фразу *ocean view*. Наверное, неожиданно, что оценка релевантности для документов 2 и 3 различна, хотя они одинаковым образом соответствовали запросу. Так произошло из-за того, что формула оценки не ограничивается лишь компонентом TF-IDF. В этом случае документу 3 была присвоена оценка выше, так как его описание короче. Ознакомьтесь с [практической формулой оценки Lucene](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/search/similarities/TFIDFSimilarity.html), чтобы узнать, как длина поля и другие факторы влияют на оценку релевантности.

Некоторые типы запросов (с подстановочными знаками, префиксом и регулярными выражениями) всегда присваивают постоянную оценку общей оценке документа. Это позволяет включить найденные с помощью расширения запроса совпадения в результаты, не влияя на приоритет. 

В примере объясняется, почему это важно. Поиск с использованием подстановочных знаков, включая поиск с использованием префикса, является однозначным по определению, так как входное содержимое представляет частичную строку с потенциальными совпадениями в больших количествах разрозненных терминов (например, термин "tour*", для которого находятся соответствия tours, tourettes и tourmaline). Учитывая характер этих результатов, нет смысла сортировать термины по большему соответствию. Именно поэтому при оценке результатов в запросах с подстановочными знаками, префиксами и регулярными выражениями стоит игнорировать частоту встречаемости термина. Во множественном поисковом запросе, который включает частичные и полные термины, результаты из неполных входных данных объединяются с постоянной оценкой, чтобы избежать смещения по отношению к потенциально неожиданным соответствиям.

### <a name="score-tuning"></a>Настройка оценки

Существует два способа настройки оценки релевантности в службе поиска Azure:

1. **Профили оценки** повышают позицию документов в ранжированном списке результатов на основе набора правил. В нашем примере мы можем рассмотреть документы, для которых найдены совпадения в заголовке поля, как более релевантные, чем те, которые содержат совпадения в поле описания. Кроме того, если бы для индекса было задано поле цены для каждого отеля, мы могли бы повысить позиции документов с более низкой стоимостью. Дополнительные сведения см. в статье о [добавлении профилей оценки в поисковый индекс](https://docs.microsoft.com/rest/api/searchservice/add-scoring-profiles-to-a-search-index).
2. **Повышение приоритета слов** (доступно только в синтаксисе расширенных запросов Lucene) достигается с помощью оператора `^`, который можно применить к любой части дерева запроса. В нашем примере вместо поиска по префиксу *air-condition*\* можно выполнить поиск по точному термину *air-condition* или префиксу, но документы с соответствием точному термину будут ранжированы выше, так как для запроса применен оператор повышения приоритета — *air-condition^2||air-condition**. Дополнительные сведения см. в разделе о [повышении приоритета слов](https://docs.microsoft.com/rest/api/searchservice/lucene-query-syntax-in-azure-search#bkmk_termboost).


### <a name="scoring-in-a-distributed-index"></a>Оценка в распределенном индексе

Все индексы в службе поиска Azure автоматически разбиваются на несколько сегментов, что позволяет быстро распределить индекс между несколькими узлами во время увеличения или уменьшения масштаба службы. Когда инициирован поисковый запрос, он выполняется отдельно для каждого сегмента. Затем результаты из каждого сегмента объединяются и упорядочиваются по оценке (если не определен другой порядок). Важно знать, что функция оценки анализирует частоту термина запроса по отношению к обратной частоте документа во всех документах в пределах определенного сегмента, а не всех сегментов.

Это значит, что оценка релевантности *может* отличаться для идентичных документов, если они находятся в разных сегментах. К счастью, подобные различия обычно исчезают по мере увеличения документов в индексе, что происходит благодаря более равномерному распределению термина. Невозможно предположить, в какой именно сегмент будет помещен любой из документов. Но так как, вероятнее всего, ключ документа не меняется, он всегда будет присвоен одному сегменту.

В целом оценка документа — не лучший атрибут для упорядочения документов, если важна стабильность порядка. Например, при наличии двух документов с одинаковой оценкой невозможно предугадать, какой из них отобразится первым в последующих запусках одного и того же запроса. Оценка документов должна представлять только общее представление релевантности документа относительно других документов в результирующем наборе.

## <a name="conclusion"></a>Заключение

Успех поисковых систем в Интернете также повлиял на ожидания в отношении полнотекстового поиска личных данных. Теперь мы ожидаем, что независимо от типа поиска система будет распознавать наши намерения, даже если используются термины с ошибками или же неполные термины. Более того, могут даже возвращаться совпадения на основе терминов с приблизительным эквивалентным значением или синонимов, которые не были указаны.

С технической точки зрения полнотекстовый поиск является чрезвычайно сложным и требует тщательного лингвистического анализа и систематического подхода к обработке, которая включает извлечение, расширение и преобразование терминов запроса, для обеспечения релевантного результата. Исходя из специфических сложностей, существует множество факторов, которые могут повлиять на результаты запроса. По этой причине, разобравшись с механизмами полнотекстового поиска, мы можем получить ощутимые преимущества при работе с неожиданными результатами.  

В этой статье мы рассмотрели принцип работы полнотекстового поиска в контексте службы поиска Azure. Мы надеемся, вы достаточно хорошо разобрались с этим вопросом и сможете применить полученные знания для разрешения распространенных проблем запросов. 

## <a name="next-steps"></a>Дополнительная информация

+ Создайте пример индекса, попробуйте выполнить различные запросы и проанализируйте результаты. Дополнительные сведения см. в разделе о [запросе индекса](search-get-started-portal.md#query-index).

+ Попробуйте использовать другой синтаксис запросов на основе примеров в статьях о [поиске документов](https://docs.microsoft.com/rest/api/searchservice/search-documents#examples) или [простом синтаксисе запросов](https://docs.microsoft.com/rest/api/searchservice/simple-query-syntax-in-azure-search) в проводнике поиска на портале.

+ Если вы хотите настроить ранжирование в поисковом приложении, ознакомьтесь со статьей о [добавлении профилей оценки в поисковый индекс](https://docs.microsoft.com/rest/api/searchservice/add-scoring-profiles-to-a-search-index).

+ Узнайте, как применить [лексические анализаторы для конкретного языка](https://docs.microsoft.com/rest/api/searchservice/language-support).

+ [Настройте пользовательские анализаторы](https://docs.microsoft.com/rest/api/searchservice/custom-analyzers-in-azure-search) для минимальной или специализированной обработки определенных полей.

+ Параллельно [сравните стандартный анализатор и анализатор английского языка](http://alice.unearth.ai/) на этом демонстрационном веб-сайте. 

## <a name="see-also"></a>См. также

[Search Documents (Azure Search Service REST API)](https://docs.microsoft.com/rest/api/searchservice/search-documents) (Поиск по документам (REST API службы поиска Azure)) 

[Простой синтаксис запросов](https://docs.microsoft.com/rest/api/searchservice/simple-query-syntax-in-azure-search) 

[Lucene query syntax in Azure Search](https://docs.microsoft.com/rest/api/searchservice/lucene-query-syntax-in-azure-search) (Синтаксис запросов Lucene в службе поиска Azure) 

[Обработка результатов поиска](https://docs.microsoft.com/azure/search/search-pagination-page-layout)

<!--Image references-->
[1]: ./media/search-lucene-query-architecture/architecture-diagram2.png
[2]: ./media/search-lucene-query-architecture/azSearch-queryparsing-should2.png
[3]: ./media/search-lucene-query-architecture/azSearch-queryparsing-must2.png
[4]: ./media/search-lucene-query-architecture/azSearch-queryparsing-spacious2.png
