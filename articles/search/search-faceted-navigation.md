---
title: Как реализовать фасетную навигацию в службе Поиск Azure | Документация Майкрософт
description: Добавьте фасетную навигацию в приложения, которые интегрируются с Поиском Azure, размещенной облачной службой поиска в Microsoft Azure.
author: HeidiSteen
manager: cgronlun
services: search
ms.service: search
ms.topic: conceptual
ms.date: 3/10/2017
ms.author: heidist
ms.openlocfilehash: e00e875619e4ed6800f5739362ff0c52971f6f16
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32195300"
---
# <a name="how-to-implement-faceted-navigation-in-azure-search"></a>Как реализовать фасетную навигацию в службе поиска Azure
Фасетная навигация представляет собой механизм фильтрации, обеспечивающий самоуправляемую детализированную навигацию в приложениях поиска. Термин "фасетная навигация" может быть неизвестен вам, но вы, вероятно, использовали этот механизм ранее. Как показано в следующем примере, фасетная навигации — это не что иное, как категории, с помощью которых фильтруются результаты.

 ![Демоверсия портала поиска работы, использующего Поиск Azure][1]

Фасетная навигация — это альтернативная точка входа в поиск. Ее можно использовать вместо того, чтобы вручную вводить сложные выражения поиска. С помощью фасетов вы можете найти нужные данные. Вероятность нулевого результата практически исключена. Используя фасеты, разработчики могут определить наиболее полезные условия поиска для навигации в пределах совокупности искомых данных. В интерактивных приложениях для розничного торговли в фасетной навигации часто используются такие категории, как торговые марки, отделы (например, "Детская обувь"), размер, цена, популярность и оценки. 

Способ реализации фасетной навигации зависит от технологии поиска. В службе поиска Azure фасетная навигация реализуется при отправке запроса с использованием полей атрибутов, ранее указанных в схеме.

-   Создаваемые приложением запросы должны включать *параметры запроса фасета*, чтобы получить доступные значения фильтра фасетов для получаемого в результате набора документов.

-   Чтобы усечь результирующий набор документов, приложение должно также применить выражение `$filter`.

При разработке приложений основную часть работы составляет написание кода, который создает запросы. Многие функции, ожидаемые от фасетной навигации, реализуются в приложении с помощью службы, которая среди прочего обеспечивает встроенную поддержку определения диапазонов и получение количества результатов, полученных с использованием аспекта. Кроме того, служба включает понятные значения по умолчанию, которые помогают упростить структуру навигации. 

## <a name="sample-code-and-demo"></a>Пример кода и демонстрация
В этой статье в качестве примера используется портал поиска работы. Он реализован в виде приложения ASP.NET MVC.

-   Просмотреть и протестировать рабочую демоверсию в режиме реального времени можно [здесь](http://azjobsdemo.azurewebsites.net/).

-   Скачайте код из [репозитория примеров Azure на GitHub](https://github.com/Azure-Samples/search-dotnet-asp-net-mvc-jobs).

## <a name="get-started"></a>Начало работы
Если вы ранее не разрабатывали средства поиска, представьте, что фасетная навигация обеспечивает возможности самоуправляемого поиска. Это тип детализированного поиска на основе предопределенных фильтров, который позволяет быстро сузить результаты поиска с помощью интерактивных действий. 

### <a name="interaction-model"></a>Модель взаимодействия

При фасетной навигации поиск является итеративным, поэтому его следует рассматривать как последовательность запросов, которые развертываются в ответ на действия пользователя.

Начальная точка — страница приложения, которая обеспечивает фасетную навигацию (возможности которой, как правило, представлены на периферии). Часто фасетная навигации представляет из себя древовидную структуру с флажками для каждого значения или текстом, который можно щелкнуть. 

1. В запросе, отправляемом в службу поиска Azure, с помощью одного или нескольких параметров запроса фасета указывается структура фасетной навигации. Например, запрос может включать элемент `facet=Rating` с необязательным параметром `:values` или `:sort`, дополнительно уточняющим представление данных.
2. Уровень представления данных прорисовывает страницу поиска с возможностями фасетной навигации, используя указанные в запросе фасеты.
3. Если структура фасетной навигации включает оценку, чтобы отобразить исключительно продукты с оценкой 4 или выше, вам нужно щелкнуть "4". 
4. В ответ приложение отправляет запрос, включающий `$filter=Rating ge 4` 
5. Уровень представления данных обновляет страницу, показывая сокращенный результирующий набор, который содержит только элементы, соответствующие новым условиям (в этом случае — продукты с оценкой 4 и выше).

Фасет — это параметр запроса. Однако его не следует путать с входными данными запроса. Он никогда не используется в качестве критериев выбора в запросе. Вместо этого рассматривайте параметры запроса фасета как входные данные в структуре переходов, возвращаемой в ответе. Для каждого указанного вами параметра запроса фасета служба поиска Azure определяет, сколько документов содержат частичные результаты для каждого значения фасета.

Обратите внимание на выражение `$filter` в шаге 4. Этот фильтр является важным аспектом фасетной навигации. Хотя фасеты и фильтры являются независимыми в интерфейсе API, для реализации нужных возможностей вам понадобятся и те, и другие. 

### <a name="app-design-pattern"></a>Конструктивный шаблон приложения

В коде приложения шаблон состоит в использовании параметров запроса фасета для возврата структуры фасетной навигации вместе с результатами фасета, а также выражения $filter,  которое обрабатывает событие щелчка в значении фасета. Представьте выражение `$filter` кодом, который обеспечивает фактическое усечение результатов поиска, возвращаемых на уровень представления данных. Предположим, что у нас есть фасет Colors (Цвета). Если щелкнуть цвет Red (Красный), с помощью выражения `$filter` будут выбраны элементы исключительно красного цвета. 

### <a name="query-basics"></a>Основы запросов

В службе поиска Azure запрос указывается с помощью одного или нескольких параметров запроса (описание каждого из них приведено в [статье, посвященной поиску документов](https://docs.microsoft.com/rest/api/searchservice/Search-Documents) ). Ни один из параметров запроса не является обязательным, но при этом необходимо указать по крайней мере один параметр запроса.

Точность, которая рассматривается как возможность фильтровать ненужные совпадения, обеспечивается с помощью одного или обоих следующих выражений:

-   **search=**  
    Значение этого параметра представляет из себя выражение поиска. Это может быть текстовый фрагмент или сложное выражение поиска, которое включает в себя несколько условий и операторов. На сервере выражение поиска используется для полнотекстового поиска. Оно запрашивает соответствующие условия в индексе в пределах полей, поддерживающих поиск, и возвращает результаты в порядке ранжирования. Если задать для выражения `search` значение NULL, запрос будет выполняться в пределах всего индекса (то есть `search=*`). В этом случае другие элементы запроса, такие как `$filter` или профиль оценки, будут основными факторами, определяющими возвращаемые документы (`($filter`) и порядок их возвращения (`scoringProfile` или `$orderby`).

-   **$filter=**  
    Фильтр — это мощный механизм ограничения количества результатов поиск а на основе значений атрибутов конкретных документов. Сначала оценивается выражение `$filter` , после чего логика по фасетному принципу создает допустимые значения и определяет количественные показатели каждого из них.

Сложные выражения поиска снижают производительность запроса. По возможности используйте правильно сформированные выражения фильтров, чтобы повысить точность и производительность запросов.

Чтобы лучше понять, как фильтр улучшает точность поиска, сравните сложное выражение поиска с выражением, которое включает в себя выражение фильтра.

-   `GET /indexes/hotel/docs?search=lodging budget +Seattle –motel +parking`
-   `GET /indexes/hotel/docs?search=lodging&$filter=City eq ‘Seattle’ and Parking and Type ne ‘motel’`

Оба запроса являются допустимыми, однако второй предпочтителен, если вы ищете гостиницы, отличные от мотелей, с парковкой в Сиэтле.
-   В первом запросе используются конкретные слова, которые упоминаются или не упоминаются в полях строк, таких как Name (Имя) или Description (Описание), и других полях с данными, поддерживающими поиск.
-   Второй запрос выполняет поиск точных совпадений среди структурированных данных и, скорее всего, вернет гораздо более точные результаты.

В приложениях, содержащих фасетную навигацию, необходимо убедиться, что все действия, которые выполняет пользователь со структурой фасетной навигации, сопровождаются сужением результатов поиска. Чтобы сузить результаты, используйте выражение фильтра.

<a name="howtobuildit"></a>

## <a name="build-a-faceted-navigation-app"></a>Создание приложения с фасетной навигацией
Фасетная навигация в службе поиска Azure реализуется в коде приложения, создающем запрос на поиск. Фасетная навигация зависит от определенных ранее элементов схемы.

В индексе поиска предопределяются такие элементы, как атрибут индекса `Facetable [true|false]` , который задается для выбранных полей, чтобы включить или отключить их использование в структуре фасетной навигации. Если поле не содержит атрибута `"Facetable" = true`, его невозможно использовать в фасетной навигации.

Уровень представления данных в коде обеспечивает взаимодействие с пользователем. Он должен содержать составные части фасетной навигации, например метку, значения, флажки и счетчик. Интерфейс API REST службы поиска Azure не зависит от платформы, поэтому вы можете использовать любой язык и платформу. Важно включить элементы пользовательского интерфейса, поддерживающие добавочное обновление. При этом состояние пользовательского интерфейса должно обновляться при выборе каждого дополнительного фасета. 

Во время выполнения запроса код приложения создает запрос, который включает элемент `facet=[string]`— параметр запроса, указывающий поле для фасетной навигации. Запрос может содержать несколько фасетов, таких как `&facet=color&facet=category&facet=rating`, которые разделяются символов "амперсанд" (&).

Кроме того, код приложения также должен создать выражение `$filter` для обработки событий, выполняемых при щелчке, во время фасетной навигации. Выражение `$filter` сокращает количество результатов поиска, используя значение фасета в качестве условия фильтра.

Служба поиска Azure возвращает результаты поиска на основе одного или нескольких условий, которые ввел пользователь, обновляя при этом структуру фасетной навигации. В службе поиска Azure фасетная навигация представляет из себя одноуровневую структуру со значениями фасетов и количеством результаты, найденных для каждого из них.

В следующих разделах мы более подробно рассмотрим, как создать каждую из частей.

<a name="buildindex"></a>

## <a name="build-the-index"></a>Создание индекса
Поддержка фасетов включается для каждого поля в индексе по отдельности с помощью этого атрибута индекса: `"Facetable": true`.  
Для всех типов полей, которые можно использовать в фасетной навигации, по умолчанию устанавливается значение `Facetable` . К таким типам полей относятся `Edm.String`, `Edm.DateTimeOffset` и все типы числовых полей (по сути, поддержкой фасетов отличаются все типы полей, за исключением `Edm.GeographyPoint`, который невозможно использовать в фасетной навигации). 

При создании индекса с помощью фасетной навигации рекомендуется явно отключить поддержку фасетов для полей, которые не должны использоваться в качестве фасетов.  В частности, для полей строк одноэлементных значений, таких как идентификатор или название продукта, следует задать значение `"Facetable": false` во избежание их случайного (и неэффективного) использования при фасетной навигации. Отключение поддержки фасетов в случаях, где она не нужна, обеспечивает небольшой размер индекса и обычно улучшает производительность.

Ниже приведена часть схемы для примера приложения демоверсии портала поиска работы (некоторые атрибуты усечены, чтобы уменьшить размер):

```json
{
  ...
  "name": "nycjobs",
  "fields": [
    { “name”: "id",                 "type": "Edm.String",              "searchable": false, "filterable": false, ... "facetable": false, ... },
    { “name”: "job_id",             "type": "Edm.String",              "searchable": false, "filterable": false, ... "facetable": false, ... },
    { “name”: "agency",              "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "posting_type",        "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "num_of_positions",    "type": "Edm.Int32",              "searchable": false, "filterable": true, ...  "facetable": true, ...  },
    { “name”: "business_title",      "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "civil_service_title", "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "title_code_no",       "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "level",               "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "salary_range_from",   "type": "Edm.Int32",              "searchable": false, "filterable": true, ...  "facetable": true, ...  },
    { “name”: "salary_range_to",     "type": "Edm.Int32",              "searchable": false, "filterable": true, ...  "facetable": true, ...  },
    { “name”: "salary_frequency",    "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
    { “name”: "work_location",       "type": "Edm.String",             "searchable": true,  "filterable": true, ...  "facetable": true, ...  },
…
    { “name”: "geo_location",        "type": "Edm.GeographyPoint",     "searchable": false, "filterable": true, ...  "facetable": false, ... },
    { “name”: "tags",                "type": "Collection(Edm.String)", "searchable": true,  "filterable": true, ...  "facetable": true, ...  }
  ],
…
}
```

Как видно в примере схемы, атрибут `Facetable` отключен для полей строк, которые не должны использоваться в качестве фасетов, например значения идентификаторов. Отключение поддержки фасетов в случаях, где она не нужна, обеспечивает небольшой размер индекса и обычно улучшает производительность.

> [!TIP]
> Для каждого поля рекомендуется включить полный набор атрибутов индекса. Хотя атрибут `Facetable` по умолчанию активируется для практически всех полей, в случае намеренной установки каждого атрибута вы можете продумать, как применить каждое решение схемы. 

<a name="checkdata"></a>

## <a name="check-the-data"></a>Проверка данных
Качество данных напрямую влияет на реализацию структуры фасетной навигации. От него также зависит создание фильтров для уменьшения размера результирующего набора.

Если вы хотите выполнять поиск по такому аспекту, как Brand (Торговая марка) или Price (Цена), то каждый документ должен содержать допустимые, согласованные и эффективные значения *BrandName* и *ProductPrice*, используемые для фильтрации.

Ниже перечислены несколько напоминаний о том, как повысить эффективность поиска:

* Определите, содержит ли каждое из полей, используемых в качестве фасетов, значения, которые можно использовать как фильтры при самоуправляемом поиске. Значения должны быть краткими, описательными и в достаточной мере отличительными для разграничения различных параметров.
* Опечатки или близкие значения. Если вы используете фасет Color (Цвет), а значения полей включают Orange (Оранжевый) и Ornage (опечатка), фасет, в основе которой лежит поле Color (Цвет), выберет оба значения.
* Использование текста, написанного прописными и строчными буквами, также может негативно отразиться на фасетной навигации, так как элементы orange и Orange будут считаться двумя разными значениями. 
* Если одно значение указано в единственном и множественном числе, для каждой формы будет создан отдельный фасет.

Как вы видите, тщательная подготовка данных обеспечивает максимальную эффективность фасетной навигации.

<a name="presentationlayer"></a>

## <a name="build-the-ui"></a>Создание пользовательского интерфейса
Уровень представления данных позволяет определить требования, которые в противном случае могли бы быть упущены. Кроме того, вы узнаете, какие возможности являются ключевыми для выполнения поиска.

С точки зрения фасетной навигации ваша веб-страница или страница приложения отображает структуру фасетной навигации, обнаруживает данные, которые пользователь ввел на странице, и вставляет измененные элементы. 

В веб-приложениях на уровне представления данных обычно используется технология AJAX, так как она позволяет обновлять добавочные изменения. Вы также можете использовать ASP.NET MVC или любую другую платформу визуализации, которая поддерживает подключение к службе поиска Azure по протоколу HTTP. Пример приложения, который приводится в этой статье (**Демоверсия портала поиска работы, использующего Поиск Azure**), — это приложение ASP.NET MVC.

В этом примере фасетная навигация встроена в страницу результатов поиска. В следующем примере, взятом из файла `index.cshtml` примера приложения, показана статическая структура HTML для отображения фасетной навигации на странице результатов поиска. Список фасетов создается или повторно создается динамически при отправке условия запроса, выборе или очистке фасета.

```html
<div class="widget sidebar-widget jobs-filter-widget">
  <h5 class="widget-title">Filter Results</h5>
    <p id="filterReset"></p>
    <div class="widget-content">

      <h6 id="businessTitleFacetTitle">Business Title</h6>
      <ul class="filter-list" id="business_title_facets">
      </ul>

      <h6>Location</h6>
      <ul class="filter-list" id="posting_type_facets">
      </ul>

      <h6>Posting Type</h6>
      <ul class="filter-list" id="posting_type_facets"></ul>

      <h6>Minimum Salary</h6>
      <ul class="filter-list" id="salary_range_facets">
      </ul>

  </div>
</div>
```

В следующем фрагменте кода со страницы `index.cshtml` динамически создается HTML для отображения первого фасета — Business Title (Должность в компании). Аналогичные функции динамически создают HTML для других фасетов. Каждый фасет содержит метку и счетчик, отображающий число элементов, найденных для соответствующего результата фасета.

```js
function UpdateBusinessTitleFacets(data) {
  var facetResultsHTML = '';
  for (var i = 0; i < data.length; i++) {
    facetResultsHTML += '<li><a href="javascript:void(0)" onclick="ChooseBusinessTitleFacet(\'' + data[i].Value + '\');">' + data[i].Value + ' (' + data[i].Count + ')</span></a></li>';
  }

  $("#business_title_facets").html(facetResultsHTML);
}
```

> [!TIP]
> При разработке страницы результатов поиска не забудьте включить механизм очистки фасетов. Устанавливая флажки, можно легко понять, как очистить фильтры. Для других структур может понадобиться шаблон навигации или другой нестандартный элемент. Например, в примере приложения портала поиска работы можно щелкнуть `[X]` возле выбранного фасета, чтобы очистить его.

<a name="buildquery"></a>

## <a name="build-the-query"></a>Создание запроса
В коде, написанном для построения запросов, следует указать все компоненты допустимого запроса, включая выражения поиска, фасеты, фильтры и профили оценки, то есть все элементы, используемые для создания запроса. В этом разделе мы изучим роль фасетов в создании запроса и покажем, как использовать с ними фильтры для сокращения размера результирующего набора.

Обратите внимание, что фасеты являются неотъемлемой частью этого примера приложения. При поиске в демоверсии портала поиска работы используются фасетная навигация и фильтры. О важности фасетной навигации свидетельствует место, которое занимают ее элементы на странице. 

Лучше всего начать с примера. В следующем примере, взятом из файла `JobsSearch.cs`, создается запрос, применяемый для фасетной навигации с использованием фасетов Business Title (Должность в компании), Location (Расположение), Posting Type (Тип объявления) и Minimum Salary (Минимальная заработная плата). 

```cs
SearchParameters sp = new SearchParameters()
{
  ...
  // Add facets
  Facets = new List<String>() { "business_title", "posting_type", "level", "salary_range_from,interval:50000" },
};
```

Параметр запроса фасета задается для поля и (в зависимости от типа данных) может дополняться списком параметров, разделенных запятыми, таких как `count:<integer>`, `sort:<>`, `interval:<integer>` и `values:<list>`. Список значений, создаваемый при настройке диапазонов, поддерживает числовые данные. Дополнительные сведения об использовании см. в статье [Поиск документов (API REST службы поиска Azure)](https://docs.microsoft.com/rest/api/searchservice/Search-Documents).

Создаваемый с помощью приложения запрос должен включать, помимо фасетов, также и соответствующие фильтры, которые позволяют сузить набор документов на основе выбранного значения фасета. Предположим, что вы ищете велосипед в специализированном магазине. С помощью фасетной навигации вы можете узнать об *имеющихся в наличии велосипедах по цвету, производителю и типу*. Используя фильтрацию, вы можете найти, к примеру, *горные велосипеды красного цвета в указанном ценовом диапазоне*. Если вы щелкнете Red, чтобы отобразить только велосипеды красного цвета, отправляемый приложением запрос будет включать фрагмент `$filter=Color eq ‘Red’`.

В следующем фрагменте кода со страницы `JobsSearch.cs` выбранная должность в компании добавляется в фильтр, если выбрать значение из фасета Business Title.

```cs
if (businessTitleFacet != "")
  filter = "business_title eq '" + businessTitleFacet + "'";
```

<a name="tips"></a> 

## <a name="tips-and-best-practices"></a>Советы и рекомендации

### <a name="indexing-tips"></a>Советы по индексированию
**Повышение эффективности индекса, если не используется поле поиска**

Если в приложении используется исключительно фасетная навигации (без поля поиска), то вы можете задать для поля атрибуты `searchable=false`, `facetable=true`, чтобы сократить размер индекса. Кроме того, индексируются только целые значения фасетов, а не фрагменты слов или компоненты многосложных значений.

**Определение полей, которые можно использовать в качестве аспектов**

Вспомним, что схема индекса определяет, какие поля можно использовать в качестве фасетов. Если поля поддерживают фасеты, в запросе указываются поля, по которым следует выполнять поиск с использованием фасетов. Поле, по которому выполняется поиск, предоставляет значения, которые отображаются под меткой. 

Значения, которые отображаются под каждой меткой, извлекаются из индекса. Например, если используется поле фасета *Color* (Цвет), дополнительная фильтрация будет выполняться по доступным значениям этого поля, таким как Red (Красный), Black (Черный) и так далее.

Для числовых значений, а также значений даты и времени можно явно задать значения поля фасета (например, `facet=Rating,values:1|2|3|4|5`). Поля этих типов поддерживают список значений, что позволяет упростить разделение целевых фасетов по смежным диапазонам (диапазонам на основе числовых значений или периодов времени). 

**По умолчанию можно использовать только один уровень фасетной навигации** 

Как уже упоминалось, фасеты невозможно непосредственно вкладывать в иерархию. По умолчанию фасетная навигация в службе поиска Azure поддерживает только один уровень фильтров. Однако это ограничение можно обойти. Вы можете кодировать иерархическую структуру фасета в `Collection(Edm.String)` с одной точкой входа для одной иерархии. Обход этого ограничения выходит за рамки данной статьи. 

### <a name="querying-tips"></a>Советы по выполнению запросов
**Проверка полей**

При динамическом создании списка фасетов на основе данных, введенных ненадежными пользователями, следует проверить допустимость имен полей фасетов или исключить имена при создании URL-адресов с помощью `Uri.EscapeDataString()` в .NET или его эквивалента в другой платформе.

### <a name="filtering-tips"></a>Советы по фильтрации
**Повышение точности поиска с помощью фильтров**

Используйте фильтры. Если вы полагаетесь исключительно на выражения поиска, выделение корней приведет к возврату документа, поля которого не будут содержать точных значений фасетов.

**Повышение производительности поиска с помощью фильтров**

Фильтры позволяют сузить набор документов для поиска и исключить их из ранжирования. Если у вас имеется большой набор документов, фасетная детализация с использованием выбранных фасетов часто повышает эффективность поиска.
  
**Фильтрация только фасетных полей**

Как правило, при детализации с использованием фасетов требуется включать только документы, содержащие значение фасета в конкретном (фасетном) поле, а не во всех полях, которые поддерживают поиск. Если добавить фильтр, поиск соответствующего значения будет выполнен только в поле фасета.

**Обрезание результатов аспекта с помощью дополнительных фильтров**

Фасеты позволяют отобразить в результатах поиска документы, соответствующие определенному фасету. В следующем примере результаты поиска фразы *cloud computing* (облачные вычисления) включают 254 элемента с типом содержимого *internal specification* (внутренняя спецификация). Элементы не обязательно взаимно исключают друг друга. Если элемент соответствует условиям обоих фильтров, он учитывается в каждом из них. Это дублирование возможно при фасетном поиске в полях `Collection(Edm.String)`, которые часто используются для обозначения документов тегами.

        Search term: "cloud computing"
        Content type
           Internal specification (254)
           Video (10) 

Как правило, если вам кажется, что при использовании фасета вы получаете слишком много результатов, мы рекомендуем добавить фильтры, чтобы пользователи могли сузить область поиска.

### <a name="tips-about-result-count"></a>Советы по числу результатов

**Ограничение числа элементов, используемых для фасетной навигации**

Для каждого поля фасета в дереве навигации по умолчанию можно задать не более 10 значений. Это упрощает структуру переходов, позволяя управлять списком значений. Вы можете переопределить это ограничение по умолчанию, указав соответствующее число.

* Параметр `&facet=city,count:5` указывает, что при применении фасета будут возвращены только первые 5 городов с наивысшим приоритетом. Предположим, вы задали условие поиска airport (аэропорт) и получили 32 совпадения. Если при этом включить в запрос параметр `&facet=city,count:5`, то в результаты поиска, полученные при использовании фасета, будут включены только первые пять уникальных городов с наибольшим количеством документов.

Обратите внимание на различие между результатами применения фасета и результатами поиска. Результаты поиска — это все документы, которые удовлетворяют условиям запроса. Результаты фасета — это совпадения для каждого значения фасета. В этом примере результаты поиска будут включать названия городов, которые не входят в список классификации фасета (в этом случае — 5). Результаты, которые фильтруются посредством фасетной навигации, отображаются пользователям, когда они удаляют фасеты или выбирают другие фасеты помимо City (Город). 

> [!NOTE]
> Если имеются фасеты несколько типов, параметр `count` может привести к отображению различных данных. В следующей таблице вкратце описывается, как этот параметр используется в интерфейсе API службы поиска Azure, примере кода и документации. 

* `@colorFacet.count`<br/>
  В коде представления данных фасет включает параметр количества, который используется для отображения числа результатов, полученных при использовании фасета. В результатах применения фасета параметр count указывает на число документов, соответствующих условию одного или диапазону нескольких фасетов.
* `&facet=City,count:12`<br/>
  В запросе фасета вы можете задать значение параметра count.  Значение по умолчанию — 10, но его можно изменить. Если задать значение `count:12` , результаты применения фасета будут включать 12 лучших совпадений по числу документов.
* "`@odata.count`"<br/>
  В ответе на запрос это значение указывает количество совпадений в результатах поиска. В среднем оно превышает суммарное число результатов применения фасета из-за наличия элементов, которые соответствуют условию поиска, но при этом не совпадают со значениями фасета.

**Получение числа результатов для аспекта**

При добавлении фильтра в фасетный запрос вам может потребоваться сохранить инструкцию аспекта (например, `facet=Rating&$filter=Rating ge 4`). С технической точки зрения элемент facet=Rating не требуется, но он позволяет возвратить количество значений фасетов для оценок, начиная с 4 и выше. Например, если вы щелкнете "4", а запрос включает фильтр для отображения оценок, начиная с "4", будут возвращены количественные показатели для каждой оценки от 4 и выше.  

**Обеспечение точного числа результатов для аспекта**

В определенных ситуациях может оказаться, что количественные показатели аспектов не соответствуют результирующим наборам (ознакомьтесь с [сообщением на форуме, посвященным фасетной навигации в Поиске Azure](https://social.msdn.microsoft.com/Forums/azure/06461173-ea26-4e6a-9545-fbbd7ee61c8f/faceting-on-azure-search?forum=azuresearch)).

Такие неточности обусловлены особенностями архитектуры сегментирования. Каждый индекс поиска включает несколько сегментов, каждый из которых в свою очередь содержит сведения о числе наиболее соответствующих фасетов, которые затем объединяются в единый результат. Если некоторые сегменты включают много совпадающих значений, в то время как другие сегменты содержат меньше значений, некоторые значения фасетов могут отсутствовать или не учитываться в результатах.

Хотя такое поведение может измениться в любое время, при наличии подобных проблем их можно устранить, искусственно увеличив значение count:<number> до очень большого числа, чтобы затребовать отображение всех данных с каждого сегмента. Если значение параметра count: больше или равно количеству уникальных значений в поле, вы гарантировано получите точные результаты. Однако если имеется очень много документов, производительность снижается, поэтому выполняйте эти действия рассудительно.

### <a name="user-interface-tips"></a>Советы по пользовательскому интерфейсу
**Используя фасетную навигацию, добавляйте метки для всех полей.**

Метки обычно определяются в HTML-файле или форме (`index.cshtml` в примере приложения). В службе поиска Azure не предусмотрен интерфейс API для работы с метками фасетной навигации или другими метаданными.

<a name="rangefacets"></a>

## <a name="filter-based-on-a-range"></a>Фильтрация по диапазону значений
В приложениях поиска часто используется фасетная навигация на основе диапазонов значений. Поддерживаются диапазоны числовых данных, а также значений даты и времени. Каждый подход подробно описан в [статье, посвященной поиску документов с помощью интерфейса API службы поиска Azure)](https://docs.microsoft.com/rest/api/searchservice/Search-Documents).

Служба поиска Azure упрощает создание диапазонов, обеспечивая два способа их вычисления. В обоих способах служба поиска Azure создает соответствующие диапазоны с учетом данных, которые вы ввели. Например, если указать диапазон значений 10|20|30, будут автоматически созданы диапазоны 0–10, 10–20, 20–30–10, 10–20 и 20–30. Приложение может при необходимости удалить все пустые интервалы. 

**Способ 1. Использование параметра interval**  
Чтобы задать аспекты цены с шагом в 10 долл. США, следует указать: `&facet=price,interval:10`

**Способ 2. Использование списка значений**  
Для числовых данных можно использовать список значений.  Рассмотрим следующий диапазон значений поля фасета `listPrice`:

  ![Пример списка значений][5]

Чтобы указать диапазон значений фасета, как показано на предыдущем снимке экрана, используйте список значений:

    facet=listPrice,values:10|25|100|500|1000|2500

Каждый диапазон создается с использованием отправной точки 0 и конечной точки, равной значению из списка. Затем из всего диапазона удаляется предыдущий диапазон, что позволяет создавать дискретные интервалы. Служба поиска Azure выполняет эти действия в рамках фасетной навигации. Для создания каждого интервала не нужно писать код.

### <a name="build-a-filter-for-a-range"></a>Создание фильтра для диапазона
Чтобы фильтровать документы на основе выбранного диапазона значений, вы можете включить операторы фильтров `"ge"` и `"lt"` в двухкомпонентное выражение, которое определяет конечные точки диапазона значений. Например, если выбрать диапазон 10–25 для поля `listPrice`, будет применен фильтр `$filter=listPrice ge 10 and listPrice lt 25`. В примере кода для задания конечных точек в выражении фильтра используются параметры **priceFrom** и **priceTo**. 

  ![Запрос для диапазона значений][6]

<a name="geofacets"></a> 

## <a name="filter-based-on-distance"></a>Фильтрация по расстоянию
Часто используются фильтры, помогающие выбрать магазин, ресторан или пункт назначения в зависимости от их близости к вашему текущему местоположению. Хотя фильтр такого типа похож на фасетную навигацию, он является всего лишь обычным фильтром. Этот вопрос упоминается здесь для пользователей, которым нужно решить проблему с реализацией этого компонента.

Поиск Azure поддерживает две геопространственные функции: **geo.distance** и **geo.intersects**.

* Функция **geo.distance** возвращает расстояние в километрах между двумя точками. Одна точка представляет собой поле, а другая — константу, переданную как часть фильтра. 
* Функция **geo.distance** возвращает значение true, если заданная точка находится в пределах указанного многоугольника. Точка представляет собой поле, а многоугольник указывается в качестве списка констант координат, переданных как часть фильтра.

Примеры фильтров приведены в статье [Синтаксис выражений OData для поиска Azure](https://docs.microsoft.com/rest/api/searchservice/odata-expression-syntax-for-azure-search).

<a name="tryitout"></a>

## <a name="try-the-demo"></a>Пробное использование демоверсии
Примеры, на которые ссылается эта статья, приведены в демоверсии портала поиска работы, использующего Поиск Azure.

-   Просмотреть и протестировать рабочую демоверсию в режиме реального времени можно [здесь](http://azjobsdemo.azurewebsites.net/).

-   Скачайте код из [репозитория примеров Azure на GitHub](https://github.com/Azure-Samples/search-dotnet-asp-net-mvc-jobs).

При работе с результатами поиска понаблюдайте, как меняется URL-адрес при построении запроса. Когда вы выбираете фасеты, это приложение добавляет их к универсальному коду ресурса (URI).

1. Чтобы использовать функцию сопоставления демоверсии приложения, получите ключ для Карт Bing в [Центре разработки Карт Bing](https://www.bingmapsportal.com/). Вставьте его вместо существующего ключа на странице `index.cshtml`. Параметр `BingApiKey` в файле `Web.config` не используется. 

2. Запустите приложение. Можно просмотреть приложение или закрыть диалоговое окно.
   
3. Введите условие поиска, например "аналитика", и щелкните значок "Поиск". Будет быстро выполнен запрос.
   
   Вместе с результатами поиска будет также возвращена структура фасетной навигации. На странице результатов поиска структура фасетной навигации включает количественные показатели для каждого результата фасета. Фасеты не выбраны, поэтому возвращаются все соответствующие результаты.
   
   ![Результаты поиска до выбора фасетов][11]

4. Щелкните фасеты Business Title (Должность в компании), Location (Расположение) или Minimum Salary (Минимальная заработная плата). При первоначальном поиске фасеты имеют значение NULL, но по мере того, как они принимают значения, из результатов поиска удаляются несоответствующие элементы.
   
   ![Результаты поиска после выбора фасетов][12]

5. Вы можете по-разному очистить запрос, использующий фасеты, например щелкнуть `[X]` возле выбранного фасета, чтобы его очистить.
   
<a name="nextstep"></a>

## <a name="learn-more"></a>Подробнее
Просмотрите видео [Azure Search Deep Dive](http://channel9.msdn.com/Events/TechEd/Europe/2014/DBI-B410) (Подробный обзор Поиска Azure). Начиная с 45:25, на этой видеозаписи демонстрируется, как реализовать фасеты.

Чтобы больше узнать о принципах разработки решений фасетной навигации, щелкните следующие ссылки.

* [Разработка решения для поиска с использованием фасетов](http://www.uie.com/articles/faceted_search/)
* [Шаблоны разработки: фасетная навигация](http://alistapart.com/article/design-patterns-faceted-navigation)


<!--Anchors-->
[How to build it]: #howtobuildit
[Build the presentation layer]: #presentationlayer
[Build the index]: #buildindex
[Check for data quality]: #checkdata
[Build the query]: #buildquery
[Tips on how to control faceted navigation]: #tips
[Faceted navigation based on range values]: #rangefacets
[Faceted navigation based on GeoPoints]: #geofacets
[Try it out]: #tryitout

<!--Image references-->
[1]: ./media/search-faceted-navigation/azure-search-faceting-example.PNG
[2]: ./media/search-faceted-navigation/Facet-2-CSHTML.PNG
[3]: ./media/search-faceted-navigation/Facet-3-schema.PNG
[4]: ./media/search-faceted-navigation/Facet-4-SearchMethod.PNG
[5]: ./media/search-faceted-navigation/Facet-5-Prices.PNG
[6]: ./media/search-faceted-navigation/Facet-6-buildfilter.PNG
[7]: ./media/search-faceted-navigation/Facet-7-appstart.png
[8]: ./media/search-faceted-navigation/Facet-8-appbike.png
[9]: ./media/search-faceted-navigation/Facet-9-appbikefaceted.png
[10]: ./media/search-faceted-navigation/Facet-10-appTitle.png
[11]: ./media/search-faceted-navigation/faceted-search-before-facets.png
[12]: ./media/search-faceted-navigation/faceted-search-after-facets.png

<!--Link references-->
[Designing for Faceted Search]: http://www.uie.com/articles/faceted_search/
[Design Patterns: Faceted Navigation]: http://alistapart.com/article/design-patterns-faceted-navigation
[Create your first application]: search-create-first-solution.md
[OData expression syntax (Azure Search)]: https://docs.microsoft.com/rest/api/searchservice/odata-expression-syntax-for-azure-search
[Azure Search Adventure Works Demo]: https://azuresearchadventureworksdemo.codeplex.com/
[http://www.odata.org/documentation/odata-version-2-0/overview/]: http://www.odata.org/documentation/odata-version-2-0/overview/ 
[Faceting on Azure Search forum post]: ../faceting-on-azure-search.md?forum=azuresearch
[Search Documents (Azure Search API)]: https://docs.microsoft.com/rest/api/searchservice/Search-Documents

