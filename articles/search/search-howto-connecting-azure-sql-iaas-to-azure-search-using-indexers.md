---
title: Подключение виртуальной машины SQL к Поиску Azure | Документация Майкрософт
description: Активируйте зашифрованные подключения и настройте брандмауэр, чтобы разрешить подключения к SQL Server на виртуальной машине Azure из индексатора Поиска Azure.
author: HeidiSteen
manager: cgronlun
services: search
ms.service: search
ms.topic: conceptual
ms.date: 01/23/2017
ms.author: heidist
ms.openlocfilehash: 7800e83891cb336bb896299b8fd4d6b3ba590178
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
ms.locfileid: "34366466"
---
# <a name="configure-a-connection-from-an-azure-search-indexer-to-sql-server-on-an-azure-vm"></a>Настройка подключения из индексатора Поиска Azure к SQL Server на виртуальной машине Azure
Как было отмечено в статье [Подключение базы данных SQL Azure к Поиску Azure с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md#faq), служба поиска Azure поддерживает создание индексаторов для **SQL Server на виртуальных машинах Azure** (или **виртуальных машинах SQL Azure** для краткости), но существует несколько требований безопасности, которые необходимо выполнить. 

**Длительность выполнения задачи:** около 30 минут, если на виртуальной машине уже установлен сертификат.

## <a name="enable-encrypted-connections"></a>Активация зашифрованных подключений
Для службы поиска Azure требуется зашифрованный канал для всех запросов индексатора, выполняемых через общедоступное Интернет-подключение. В данном разделе перечислены действия, необходимые для выполнения этого требования.

1. Проверьте свойства сертификата, чтобы убедиться, что имя субъекта является полным доменным именем (FQDN) виртуальной машины Azure. Чтобы просмотреть свойства, можно воспользоваться инструментом, таким как CertUtils, или оснасткой диспетчера сертификатов. Полное доменное имя можно найти на **портале Azure** в колонке служб виртуальных машин (в разделе "Основные сведения" в поле [Общедоступный IP-адрес/Метка DNS-имени](https://portal.azure.com/)).
   
   * Для виртуальных машин, созданных с помощью более нового шаблона **Resource Manager**, полное доменное имя имеет формат `<your-VM-name>.<region>.cloudapp.azure.com`. 
   * Для более старых виртуальных машин, созданных как **классические** виртуальные машины, полное доменное имя имеет формат `<your-cloud-service-name.cloudapp.net>`. 
2. С помощью редактора реестра (regedit) настройте SQL Server для использования сертификата. 
   
    Несмотря на то, что диспетчер конфигурации SQL Server часто используется для данной задачи, его нельзя использовать в этом сценарии. Он не найдет импортированный сертификат, так как полное доменное имя виртуальной машины в Azure не соответствует полному доменному имени, определенному виртуальной машиной (он определяет домен как локальный компьютер или как сетевой домен, к которому он присоединен). Если имена не совпадают, воспользуйтесь редактором реестра, чтобы указать сертификат.
   
   * В редакторе реестра перейдите к разделу реестра: `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft SQL Server\[MSSQL13.MSSQLSERVER]\MSSQLServer\SuperSocketNetLib\Certificate`.
     
     Часть `[MSSQL13.MSSQLSERVER]` зависит от версии и имени экземпляра. 
   * В качестве значения ключа **сертификата** задайте **отпечаток** SSL-сертификата, импортированный в виртуальную машину.
     
     Есть несколько способов получить это значение отпечатка, из которых некоторые удобнее других. Если скопировать его из оснастки **диспетчера сертификатов** в MMC, то вероятно вы также скопируете невидимый начальный знак, как описано в [этой справочной статье](https://support.microsoft.com/kb/2023869/), что приведет к ошибке при попытке подключения. Для этой проблемы существует несколько обходных решений. Самый простой способ — это стереть клавишей BACKSPACE, а затем повторно ввести первый знак отпечатка, чтобы удалить начальный знак в поле значения ключа в редакторе реестра. Также для копирования отпечатка можно воспользоваться другим инструментом.
3. Предоставьте разрешения учетной записи службы. 
   
    Убедитесь, что учетной записи службы SQL Server предоставлено необходимое разрешение для закрытого ключа SSL-сертификата. Если пренебречь этим шагом, то SQL Server не запустится. Для выполнения этой задачи можно использовать оснастку **сертификатов** или инструмент **CertUtils**.
4. Перезапустите службу SQL Server.

## <a name="configure-sql-server-connectivity-in-the-vm"></a>Настройка подключения к SQL Server на виртуальной машине
После настройки зашифрованного соединения, которое требуется для службы поиска Azure, необходимо выполнить дополнительные шаги, обязательные для настройки SQL Server на виртуальных машинах Azure. Если это еще не было сделано, то следующий шаг позволит вам завершить настройку. Воспользуйтесь одной из следующих статей:

* Если вы используете виртуальную машину **Resource Manager** , то ознакомьтесь с разделом [Подключение к виртуальной машине SQL Server в Azure (диспетчер ресурсов)](../virtual-machines/windows/sql/virtual-machines-windows-sql-connect.md). 
* Если вы используете **классическую** виртуальную машину, см. статью [Подключение к виртуальной машине SQL Server в Azure (классическое развертывание)](../virtual-machines/windows/classic/sql-connect.md).

В частности, в каждой из этих статей ознакомьтесь с разделом "Подключение к SQL Server через Интернет".

## <a name="configure-the-network-security-group-nsg"></a>Настройка группы безопасности сети (NSG)
Обычной практикой является настройка группы безопасности сети и соответствующей конечной точки Azure или списка управления доступом (ACL) таким образом, чтобы виртуальная машина Azure стала доступной для других сторон. Есть вероятность, что вы уже выполнили эту настройку, чтобы разрешить логике своего приложения подключаться к виртуальной машине SQL Azure. Такой же принцип применяется для подключения службы поиска Azure к виртуальной машине SQL Azure. 

Приведенные ниже ссылки содержат инструкции по настройке групп безопасности сети для развертывания виртуальной машины. Воспользуйтесь этими инструкциями для внесения конечной точки службы поиска Azure в список управления доступом на основе ее IP-адреса.

> [!NOTE]
> Основные сведения см. в статье [Группа безопасности сети](../virtual-network/security-overview.md).
> 
> 

* Если вы используете виртуальную машину **Resource Manager**, см. статью [Как управлять сетевыми группами безопасности с помощью портала предварительной версии](../virtual-network/tutorial-filter-network-traffic.md). 
* Если вы используете **классическую** виртуальную машину, см. статью [Как создать группы безопасности сети (классические) в PowerShell](../virtual-network/virtual-networks-create-nsg-classic-ps.md).

Назначение IP-адресов может создать некоторые сложности, но их можно легко преодолеть, если знать о проблеме и о возможных путях ее решения. В дальнейших разделах приводятся рекомендации по устранению проблем, связанных с IP-адресами в списке управления доступом.

#### <a name="restrict-access-to-the-search-service-ip-address"></a>Ограничение доступа к IP-адресу службы поиска
Настоятельно рекомендуется ограничить доступ к IP-адресу службы поиска с помощью списка управления доступом (ACL), а не оставлять виртуальные машины SQL Azure открытыми для любых запросов на подключение. Вы можете легко узнать этот IP-адрес, выполнив проверку связи с полным доменным именем (например: `<your-search-service-name>.search.windows.net`) своей службы поиска.

#### <a name="managing-ip-address-fluctuations"></a>Управление колебаниями IP-адреса
Если служба поиска имеет только одну единицу поиска (то есть одну реплику и одну секцию), то IP-адрес может меняться во время перезагрузки службы, аннулируя существующий список управления доступом с вашим IP-адресом службы поиска.

Одним из способов избежать последующих ошибок при подключении является использование в службе поиска Azure более одной реплики и одной секции. Это увеличивает затраты, но решает проблему с IP-адресами. В службе поиска Azure IP-адреса не меняются при наличии более чем одной единицы поиска.

Второй подход заключается в том, чтобы позволить подключению завершиться сбоем, а затем перенастроить списки управления доступом в группе безопасности сети. Как правило, IP-адреса меняются раз в несколько недель. Для пользователей, которые нечасто выполняют управляемую индексацию, этот подход может быть эффективным.

Третьим эффективным (но не самым безопасным) подходом является указание диапазона IP-адресов в регионе Azure, в котором выполняется подготовка службы поиска. Список диапазонов IP-адресов, из которых общедоступные IP-адреса назначаются ресурсам Azure, опубликован в файле с [диапазонами IP-адресов центров обработки данных Azure](https://www.microsoft.com/download/details.aspx?id=41653). 

#### <a name="include-the-azure-search-portal-ip-addresses"></a>Включение IP-адресов портала Поиска Azure
Если для создания индексатора используется портал Azure, то в процессе создания логике портала службы поиска Azure также необходим доступ к виртуальной машине SQL Azure. Чтобы найти IP-адреса портала службы поиска Azure, можно выполнить проверку связи с `stamp2.search.ext.azure.com`.

## <a name="next-steps"></a>Дополнительная информация
Когда настройка выполнена, SQL Server на виртуальной машине Azure можно указать в качестве источника данных для индексатора службы поиска Azure. Дополнительные сведения см. в статье [Подключение базы данных SQL Azure к Поиску Azure с помощью индексаторов](search-howto-connecting-azure-sql-database-to-azure-search-using-indexers.md).

