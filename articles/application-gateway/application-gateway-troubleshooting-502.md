---
title: Устранение ошибок "Недопустимый шлюз (502)" шлюза приложений Azure | Документация Майкрософт
description: Из этой статьи вы узнаете, как устранять ошибки 502 шлюза приложений.
services: application-gateway
documentationcenter: na
author: amitsriva
manager: rossort
editor: ''
tags: azure-resource-manager
ms.assetid: 1d431ead-d318-47d8-b3ad-9c69f7e08813
ms.service: application-gateway
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/09/2017
ms.author: amsriva
ms.openlocfilehash: 4eca6a588d2c95189f0ba995b8db195907e9dc39
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
ms.locfileid: "34356041"
---
# <a name="troubleshooting-bad-gateway-errors-in-application-gateway"></a>Устранение ошибок "Недопустимый шлюз" в шлюзе приложений

В этой статье приведены сведения об устранении ошибок "Недопустимый шлюз (502)" шлюза приложений.

## <a name="overview"></a>Обзор

После настройки шлюза приложений может появиться сообщение об ошибке "Ошибка сервера 502: веб-сервер, выполняющий роль шлюза или прокси-сервера, получил недопустимый ответ". Такая ошибка происходит по следующим причинам:

* NSG, UDR или пользовательская служба DNS блокирует доступ к участникам серверного пула;
* серверные виртуальные машины или экземпляры масштабируемого набора виртуальных машин [не отвечают на стандартную пробу работоспособности](#problems-with-default-health-probe.md);
* недопустимая или неправильная [конфигурация пользовательских проб работоспособности](#problems-with-custom-health-probe.md);
* [серверный пул шлюза приложений Azure не настроен или пуст](#empty-backendaddresspool);
* в [наборе масштабирования виртуальных машин нет работоспособных](#unhealthy-instances-in-backendaddresspool) экземпляров или виртуальных машин;
* для пользовательских запросов [истекло время ожидания или возникли проблемы с подключением](#request-time-out).

## <a name="network-security-group-user-defined-route-or-custom-dns-issue"></a>Проблема группы безопасности сети, определенного пользователем маршрута или пользовательской службы DNS

### <a name="cause"></a>Причина:

Если доступ к серверной части заблокирован из-за наличия NSG, UDR или пользовательской службы DNS, экземпляры шлюза приложений не смогут подключиться к серверному пулу. Это приведет к сбоям проверки, вызывающим ошибки 502. Обратите внимание, что NSG/UDR может присутствовать либо в подсети шлюза приложений, либо в той подсети, где развернуты виртуальные машины приложений. Аналогично, наличие пользовательской службы DNS в виртуальной сети может также вызывать проблемы, если полное доменное имя используется для участников серверного пула, и настроенный пользователем DNS-сервер для виртуальной сети не разрешает его правильно.

### <a name="solution"></a>Решение

Проверьте конфигурацию NSG, UDR и DNS, сделав следующее:
* Проверьте группы безопасности сети (NSG), связанные с подсетью шлюза приложений. Убедиться, что связь с серверной частью не заблокирована.
* Проверьте определенный пользователем маршрут (UDR), связанный с подсетью шлюза приложений. Убедитесь, что UDR не направляет трафик в сторону от серверной подсети. Например, проверьте маршрутизацию к виртуальным устройствам сети или маршруты по умолчанию, объявляемые для подсети шлюза приложений через ExpressRoute или VPN.

```powershell
$vnet = Get-AzureRmVirtualNetwork -Name vnetName -ResourceGroupName rgName
Get-AzureRmVirtualNetworkSubnetConfig -Name appGwSubnet -VirtualNetwork $vnet
```

* Проверьте действующую NSG и маршрут с серверной виртуальной машиной.

```powershell
Get-AzureRmEffectiveNetworkSecurityGroup -NetworkInterfaceName nic1 -ResourceGroupName testrg
Get-AzureRmEffectiveRouteTable -NetworkInterfaceName nic1 -ResourceGroupName testrg
```

* Проверьте наличие пользовательской службы DNS в виртуальной сети. Службу DNS можно проверить, просмотрев подробности свойств виртуальной сети в выходных данных.

```json
Get-AzureRmVirtualNetwork -Name vnetName -ResourceGroupName rgName 
DhcpOptions            : {
                           "DnsServers": [
                             "x.x.x.x"
                           ]
                         }
```
При ее наличии убедитесь, что DNS-сервер способен правильно разрешить полное доменное имя участника серверного пула.

## <a name="problems-with-default-health-probe"></a>Проблемы со стандартной пробой работоспособности

### <a name="cause"></a>Причина:

Ошибки 502 часто указывают на то, что стандартная проба работоспособности не может связаться с виртуальными машинами серверной части. Подготовленный экземпляр шлюза приложений автоматически настраивает стандартную пробу работоспособности для каждого серверного пула адресов. Для этого он использует свойства параметра BackendHttpSetting. Пользователю ничего не нужно вводить для настройки этой пробы. В частности, при настройке правила балансировки нагрузки создается связь между параметром BackendHttpSetting и серверным пулом адресов. Стандартная проба настраивается для каждой такой связи. Шлюз приложений периодически проверяет работоспособность каждого экземпляра в серверном пуле адресов. Для этого он подключается к нужным экземплярам, пользуясь портом, заданным в параметре BackendHttpSetting. Ниже приведены значения, связанные со стандартной пробой работоспособности.

| Свойства проверки | Значение | ОПИСАНИЕ |
| --- | --- | --- |
| URL-адрес проверки |http://127.0.0.1/ |URL-адрес |
| Интервал |30 |Интервал проверки в секундах |
| Время ожидания |30 |Время ожидания проверки в секундах |
| Пороговое значение сбоя |3 |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

* Убедитесь, что стандартный сайт настроен и ожидает передачи данных по адресу 127.0.0.1.
* Если в параметре BackendHttpSetting задан порт, отличный от 80, на стандартном сайте нужно настроить ожидание передачи данных через этот порт.
* Вызов к http://127.0.0.1:port должен вернуть код результата HTTP 200. (в течении 30-секундного периода ожидания).
* Откройте настроенный порт и удалите правила брандмауэра и группы безопасности сети Azure. Иначе они будут блокировать входящий и исходящий трафик через настроенный порт.
* Если классические виртуальные машины Azure или облачная служба используются с полным доменным именем или общедоступным IP-адресом, откройте соответствующую [конечную точку](../virtual-machines/windows/classic/setup-endpoints.md?toc=%2fazure%2fapplication-gateway%2ftoc.json) .
* Если виртуальная машина настроена с помощью Azure Resource Manager и находится за пределами виртуальной сети, в которой развернут шлюз приложений, настройте в [группе безопасности сети](../virtual-network/security-overview.md) доступ через нужный порт.

## <a name="problems-with-custom-health-probe"></a>Проблемы с пользовательскими пробами работоспособности

### <a name="cause"></a>Причина:

Пользовательские пробы работоспособности более гибкие по сравнению со стандартными. Для пользовательских проб можно настроить интервал, URL-адрес и путь к ним (для тестирования), а также число неудачных откликов, после которых экземпляр пула внутренних серверов будет считаться неработоспособным. Добавляются приведенные ниже дополнительные свойства.

| Свойства проверки | ОПИСАНИЕ |
| --- | --- |
| ИМЯ |Имя проверки. Это имя используется для указания проверки в параметрах HTTP внутреннего сервера |
| Протокол |Протокол, используемый для проверки. Проба использует протокол, определенный в параметрах HTTP серверной части. |
| Узел |Имя узла для проверки. Применяется только тогда, когда в шлюзе приложений настроено многосайтовое подключение. (То есть указывается не имя узла виртуальной машины.) |
| Путь |Относительный путь проверки. Путь должен начинаться с "/". Проба отправляется по адресу \<протокол\>://\<узел\>:\<порт\>\<путь\>. |
| Интервал |Интервал проверки в секундах. Интервал времени между двумя последовательными проверками. |
| Время ожидания |Время ожидания проверки в секундах. Если ответ о работоспособности не получен в течение этого времени ожидания, то проба считается неудачной. |
| Пороговое значение сбоя |Количество повторных попыток проверки. Сервер внутреннего пула считается неисправным, когда количество повторных неудачных попыток проверки достигает порогового значения сбоя. |

### <a name="solution"></a>Решение

Настройте пользовательскую пробу производительности правильно, как описано в таблице выше. Кроме действий по устранению неполадок, описанных выше, требуется соблюдение следующих условий:

* проба указана правильно, согласно [руководству](application-gateway-create-probe-ps.md);
* если шлюз приложений настроен для одного сайта, нужно указать стандартное имя узла 127.0.0.1, если только другое имя не задано в пользовательской пробе;
* Убедитесь, что вызов к http://\<узел\>:\<порт\>\<путь\> возвращает HTTP-код результата 200.
* значения "Интервал", "Время ожидания" и "Порог работоспособности" должны находиться в допустимом диапазоне.
* При использовании зонда HTTPS убедитесь, что внутренний сервер не требует SNI путем настройки резервного сертификата.

## <a name="request-time-out"></a>Время ожидания запроса

### <a name="cause"></a>Причина:

При получении запроса пользователя шлюз приложений применяет настроенные правила к запросу и направляет его экземпляру серверного пула. Затем в течение указанного интервала он ожидает отклик от серверного экземпляра. По умолчанию этот интервал составляет **30 секунд**. Если шлюз приложений не получает отклик от серверного приложения в течение этого времени, для пользовательского запроса отображается ошибка 502.

### <a name="solution"></a>Решение

Шлюз приложений позволяет пользователям настроить этот параметр с помощью параметра BackendHttpSetting, который затем можно применить к разным пулам. Для разных серверных пулов могут быть установлены разные настройки BackendHttpSetting, следовательно, — и разное время ожидания запроса.

```powershell
    New-AzureRmApplicationGatewayBackendHttpSettings -Name 'Setting01' -Port 80 -Protocol Http -CookieBasedAffinity Enabled -RequestTimeout 60
```

## <a name="empty-backendaddresspool"></a>Пустой серверный пул адресов

### <a name="cause"></a>Причина:

Если для шлюза приложений в серверном пуле адресов не настроены виртуальные машины или масштабируемый набор виртуальных машин, шлюз не сможет отправлять запросы клиентов, выдавая ошибку недопустимого шлюза.

### <a name="solution"></a>Решение

Убедитесь, что серверный пул адресов не пуст. Это можно сделать с помощью PowerShell, интерфейса командной строки или на портале.

```powershell
Get-AzureRmApplicationGateway -Name "SampleGateway" -ResourceGroupName "ExampleResourceGroup"
```

Выходные данные командлета, приведенного выше, должны содержать непустой серверный пул адресов. В примере ниже возвращаются два пула, в которых для серверных виртуальных машин указано полное доменное имя или IP-адрес. Состояние подготовки серверного пула адресов должно быть "Выполнено".

BackendAddressPoolsText:

```json
[{
    "BackendAddresses": [{
        "ipAddress": "10.0.0.10",
        "ipAddress": "10.0.0.11"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool01",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool01"
}, {
    "BackendAddresses": [{
        "Fqdn": "xyx.cloudapp.net",
        "Fqdn": "abc.cloudapp.net"
    }],
    "BackendIpConfigurations": [],
    "ProvisioningState": "Succeeded",
    "Name": "Pool02",
    "Etag": "W/\"00000000-0000-0000-0000-000000000000\"",
    "Id": "/subscriptions/<subscription id>/resourceGroups/<resource group name>/providers/Microsoft.Network/applicationGateways/<application gateway name>/backendAddressPools/pool02"
}]
```

## <a name="unhealthy-instances-in-backendaddresspool"></a>Неработоспособные экземпляры в серверном пуле адресов

### <a name="cause"></a>Причина:

Если неработоспособными являются все экземпляры серверного пула адресов, шлюзу приложений некуда отправлять запросы пользователей. То же самое происходит, когда серверные экземпляры работоспособны, но в них не развернуто требуемое приложение.

### <a name="solution"></a>Решение

Сделайте экземпляры работоспособными и правильно настройте приложение. Проверьте, могут ли серверные экземпляры отвечать на запрос при проверке связи от другой виртуальной машины в виртуальной сети. Если настроена общая конечная точка, убедитесь, что запрос браузера к веб-приложению подлежит обслуживанию.

## <a name="next-steps"></a>Дополнительная информация

Если описанные выше шаги не устранят проблему, отправьте [запрос в службу поддержки](https://azure.microsoft.com/support/options/).

