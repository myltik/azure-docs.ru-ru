---
title: Настройка постоянного хранения для кэша Redis для Azure уровня Премиум
description: Узнайте, как настроить постоянное хранение и управлять им для экземпляров кэша Redis для Azure уровня Премиум
services: redis-cache
documentationcenter: ''
author: wesmc7777
manager: cfowler
editor: ''
ms.assetid: b01cf279-60a0-4711-8c5f-af22d9540d38
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache-redis
ms.devlang: na
ms.topic: article
ms.date: 08/24/2017
ms.author: wesmc
ms.openlocfilehash: 270158bbf85a58a48a367a091ad2b09a9d114b2b
ms.sourcegitcommit: 2a70752d0987585d480f374c3e2dba0cd5097880
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2018
ms.locfileid: "27910855"
---
# <a name="how-to-configure-data-persistence-for-a-premium-azure-redis-cache"></a>Настройка постоянного хранения для кэша Redis для Azure уровня Премиум
Кэш Redis для Azure предлагает разные варианты кэша, которые обеспечивают гибкость в выборе размера и функций кэша, включая функции уровня "Премиум", такие как кластеризация, постоянное хранение данных и поддержка виртуальной сети. В этой статье описывается настройка постоянного хранения в экземпляре кэша Redis для Azure уровня Премиум.

Сведения о других функциях кэша уровня "Премиум" см. в статье [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md).

## <a name="what-is-data-persistence"></a>Что такое постоянное хранение?
Функция [Сохраняемость Redis](https://redis.io/topics/persistence) позволяет постоянно хранить данные, размещенные в Redis. Также можно создавать моментальные снимки и архивировать данные, которые можно будет восстановить в случае сбоя оборудования. Это огромное преимущество по сравнению с уровнями Базовый и Стандартный, в которых все данные хранятся в памяти, и при сбое, когда узлы кэша становятся недоступными, может произойти потеря данных. 

Кэш Redis для Azure обеспечивает сохраняемость Redis на основе следующих моделей:

* **Сохраняемость RDB.** Если настроена сохраняемость RDB (база данных Redis), кэш Redis для Azure сохраняет моментальный снимок кэша Redis на диске в двоичном формате Redis в соответствии с настроенной частотой резервного копирования. В случае аварии, при которой становятся недоступными как основной экземпляр кэша, так и реплика кэша, кэш воссоздается на основе последнего моментального снимка. Узнайте больше о [преимуществах](https://redis.io/topics/persistence#rdb-advantages) и [недостатках](https://redis.io/topics/persistence#rdb-disadvantages) сохраняемости RDB.
* **Сохраняемость AOF.** Если настроена сохраняемость AOF (файл только для добавления), кэш Redis для Azure сохраняет каждую операцию записи в журнал, который сохраняется по крайней мере один раз в секунду в учетную запись хранения Azure. В случае аварии, при которой становятся недоступными основной экземпляр и реплика кэша, кэш воссоздается на основе сохраненных операций записи. Узнайте больше о [преимуществах](https://redis.io/topics/persistence#aof-advantages) и [недостатках](https://redis.io/topics/persistence#aof-disadvantages) сохраняемости AOF.

При создании кэша сохраняемость можно настроить в колонке **Новый кэш Redis**, а для существующего кэша уровня "Премиум" используйте **меню ресурсов**.

[!INCLUDE [redis-cache-create](../../includes/redis-cache-premium-create.md)]

Выбрав ценовую категорию Премиум, щелкните **Сохраняемость Redis**.

![Сохраняемость Redis][redis-cache-persistence]

В следующем разделе описана процедура настройки сохраняемости Redis для нового кэша уровня "Премиум". Настроив сохраняемость Redis, нажмите кнопку **Создать** , чтобы создать новый кэш Премиум с сохраняемостью Redis.

## <a name="enable-redis-persistence"></a>Включение сохраняемости Redis

Сохраняемость Redis можно включить в колонке **Сохраняемость данных Redis**, выбрав один из доступных параметров: **RDB** или **AOF**. Для новых кэшей доступ к этой колонке осуществляется при создании кэша, как описано в предыдущем разделе. Колонка **Сохраняемость данных Redis** для существующих кэшей открывается из **меню ресурсов** соответствующего кэша.

![Параметры Redis][redis-cache-settings]


## <a name="configure-rdb-persistence"></a>Настройка сохраняемости RDB

Чтобы включить сохраняемость RDB, щелкните **RDB**. Чтобы отключить сохраняемость Redis во включенном ранее кэше уровня "Премиум", щелкните **Отключено**.

![Сохраняемость RDB Redis][redis-cache-rdb-persistence]

Чтобы настроить интервал архивации, выберите **частоту архивации** из раскрывающегося списка. Вы можете выбрать **15 минут**, **30 минут**, **60 минут**, **6 часов**, **12 часов** или **24 часа**. Отсчет этого интервала начинается после успешного завершения предыдущей операции резервного копирования. По истечении этого интервала запускается новое резервное копирование.

Выберите нужную **учетную запись хранения** и щелкните **Первичный ключ** или **Вторичный ключ** из раскрывающегося списка **Storage Key** (Ключ к хранилищу данных). Необходимо выбрать учетную запись хранения в том же регионе, где находится кэш. Рекомендуется учетная запись **хранилища класса Premium**, так как указанное хранилище отличается более высокой пропускной способностью. 

> [!IMPORTANT]
> Если ключ к хранилищу данных для учетной записи сохраняемости создается заново, то необходимо повторно настроить желаемый ключ в раскрывающемся списке **Ключ к хранилищу данных**.
> 
> 

Щелкните **ОК** для сохранения конфигурации постоянного хранения.

Следующая (а если кэш новый, то первая) резервная копия создается по окончании интервала резервного копирования.

## <a name="configure-aof-persistence"></a>Настройка сохраняемости AOF

Чтобы включить сохраняемость RDB, щелкните **RDB**. Чтобы отключить сохраняемость AOF во включенном ранее кэше уровня "Премиум", выберите параметр **Отключено**.

![Сохраняемость AOF Redis][redis-cache-aof-persistence]

Чтобы настроить сохраняемость AOF, укажите **первую учетную запись хранения**. Необходимо выбрать учетную запись хранения в том же регионе, где находится кэш. Мы советуем использовать учетную запись **хранения класса "Премиум"**, так как она отличается более высокой пропускной способностью. При необходимости можно настроить дополнительную учетную запись хранения с именем **Вторичная учетная запись хранения**. Если настроена вторичная учетная запись хранения, операции записи в кэш реплики сохраняются в нее. Для каждой настроенной учетной записи хранения в раскрывающемся списке **Ключ хранилища** выберите значение **Первичный ключ** или **Вторичный ключ**. 

> [!IMPORTANT]
> Если ключ к хранилищу данных для учетной записи сохраняемости создается заново, то необходимо повторно настроить желаемый ключ в раскрывающемся списке **Ключ к хранилищу данных**.
> 
> 

Если включена сохраняемость AOF, операции записи в кэш сохраняются в указанную учетную запись хранения (или учетные записи, если вы настроили вторичную учетную запись хранения). В случае масштабного сбоя, в результате которого выходят из строя основной экземпляр и реплика кэша, кэш восстанавливается на основе сохраненного журнала AOF.

## <a name="persistence-faq"></a>Часто задаваемые вопросы о постоянном хранении
Следующий список содержит ответы на часто задаваемые вопросы о постоянном хранении кэша Redis для Azure.

* [Можно ли включить постоянное хранение для ранее созданного кэша?](#can-i-enable-persistence-on-a-previously-created-cache)
* [Можно ли одновременно активировать сохраняемость AOF и RDB?](#can-i-enable-aof-and-rdb-persistence-at-the-same-time)
* [Какую модель сохраняемости следует выбрать?](#which-persistence-model-should-i-choose)
* [Что произойдет, если выполнено масштабирование до другого размера, а резервная копия была создана до этой операции?](#what-happens-if-i-have-scaled-to-a-different-size-and-a-backup-is-restored-that-was-made-before-the-scaling-operation)


### <a name="rdb-persistence"></a>Сохраняемость RDB
* [Можно ли изменить частоту резервного копирования RDB после создания кэша?](#can-i-change-the-rdb-backup-frequency-after-i-create-the-cache)
* [Почему при установленной частоте резервного копирования RDB в 60 минут между созданием резервных копий проходит больше времени?](#why-if-i-have-an-rdb-backup-frequency-of-60-minutes-there-is-more-than-60-minutes-between-backups)
* [Что происходит со старыми резервными копиями RDB при создании другой?](#what-happens-to-the-old-rdb-backups-when-a-new-backup-is-made)

### <a name="aof-persistence"></a>Сохраняемость AOF
* [Когда следует использовать вторичную учетную запись хранения?](#when-should-i-use-a-second-storage-account)
* [Влияет ли сохраняемость AOF на пропускную способность, задержку или производительность кэша?](#does-aof-persistence-affect-throughout-latency-or-performance-of-my-cache)
* [Как удалить вторичную учетную запись хранения?](#how-can-i-remove-the-second-storage-account)
* [Что такое перезапись и как она влияет на кэш?](#what-is-a-rewrite-and-how-does-it-affect-my-cache)
* [Что следует ожидать при масштабировании кэша с включенной сохраняемостью AOF?](#what-should-i-expect-when-scaling-a-cache-with-aof-enabled)
* [Как организованы данные AOF в хранилище?](#how-is-my-aof-data-organized-in-storage)


### <a name="can-i-enable-persistence-on-a-previously-created-cache"></a>Можно ли включить постоянное хранение для ранее созданного кэша?
Да, вы можете настроить сохраняемость Redis как при создании кэша, так и в уже существующем кэше Премиум.

### <a name="can-i-enable-aof-and-rdb-persistence-at-the-same-time"></a>Можно ли одновременно активировать сохраняемость AOF и RDB?

Нет. Вы можете включить только сохраняемость RDB или AOF.

### <a name="which-persistence-model-should-i-choose"></a>Какую модель сохраняемости следует выбрать?

Сохраняемость AOF сохраняет каждую запись в журнал, что влияет на пропускную способность, а сохраняемость RDB сохраняет резервные копии на основе настроенного интервала резервного копирования, что оказывает минимальное влияние на производительность. Выберите сохраняемость AOF, если основная цель заключается в минимизации потери данных, а уменьшение пропускной способности кэша не является проблемой. Используйте сохраняемость RDB, если вы хотите поддерживать оптимальную пропускную способность в кэше, но при этом необходим механизм восстановления данных.

* Узнайте больше о [преимуществах](https://redis.io/topics/persistence#rdb-advantages) и [недостатках](https://redis.io/topics/persistence#rdb-disadvantages) сохраняемости RDB.
* Узнайте больше о [преимуществах](https://redis.io/topics/persistence#aof-advantages) и [недостатках](https://redis.io/topics/persistence#aof-disadvantages) сохраняемости AOF.

Дополнительные сведения о производительности при использовании сохраняемости AOF см. в разделе [Влияет ли сохраняемость AOF на пропускную способность, задержку или производительность кэша?](#does-aof-persistence-affect-throughout-latency-or-performance-of-my-cache)

### <a name="what-happens-if-i-have-scaled-to-a-different-size-and-a-backup-is-restored-that-was-made-before-the-scaling-operation"></a>Что произойдет, если выполнено масштабирование до другого размера, а резервная копия была создана до этой операции?

Сохраняемость RDB и AOF:

* Если выполнено масштабирование до большего размера, то ничего не произойдет.
* Если выполнено масштабирование до меньшего размера, а значение существующего пользовательского параметра [databases](cache-configure.md#databases) превышает значение [databases limit](cache-configure.md#databases) для нового размера, то данные в этих базах данных не будут восстановлены. Дополнительные сведения см. в разделе [Что происходит с пользовательским параметром databases при масштабировании?](cache-how-to-scale.md#is-my-custom-databases-setting-affected-during-scaling)
* Если выполнено масштабирование до меньшего размера, и вам не хватает места для хранения всех данных из последнего архива, то при восстановлении ключи будут исключены. Обычно для этого используется политика вытеснения [allkeys-lru](http://redis.io/topics/lru-cache).

### <a name="can-i-change-the-rdb-backup-frequency-after-i-create-the-cache"></a>Можно ли изменить частоту резервного копирования RDB после создания кэша?
Да. Вы можете изменить частоту резервного копирования сохраняемости RDB в колонке **Сохраняемость данных Redis**. Инструкции см. в разделе [Настройка сохраняемости Redis](#configure-redis-persistence).

### <a name="why-if-i-have-an-rdb-backup-frequency-of-60-minutes-there-is-more-than-60-minutes-between-backups"></a>Почему при установленной частоте резервного копирования RDB в 60 минут между созданием резервных копий проходит больше времени?
Интервал резервного копирования сохраняемости RDB не начинается, пока не завершится процесс предыдущего резервного копирования. Если интервал резервного копирования 60 минут и на процесс резервного копирования уходит 15 минут, следующее резервное копирование начнется не ранее чем через 75 минут после начала предыдущего резервного копирования.

### <a name="what-happens-to-the-old-rdb-backups-when-a-new-backup-is-made"></a>Что происходит со старыми резервными копиями RDB при создании другой?
Все резервные копии сохраняемости RDB, за исключением последней, автоматически удаляются. Это удаление может происходить не сразу, но старые резервные копии не хранятся в течение неограниченного периода времени.


### <a name="when-should-i-use-a-second-storage-account"></a>Когда следует использовать вторичную учетную запись хранения?

Вторичную учетную запись хранения для сохраняемости AOF следует использовать, если вы считаете, что в кэше выполняется больше операций над множеством, чем ожидалось.  Это гарантирует, что ваш кеш не достигнет ограничений пропускной способности.

### <a name="does-aof-persistence-affect-throughout-latency-or-performance-of-my-cache"></a>Влияет ли сохраняемость AOF на пропускную способность, задержку или производительность кэша?

Сохраняемость AOF влияет на пропускную способность примерно на 15–20% при нагрузке кэша ниже максимальной (при нагрузке ЦП и сервера менее 90%). Если кэш остается в рамках этих ограничений, проблемы с задержками не должны возникать. Однако если включена сохраняемость AOF, кэш достигнет этих ограничений быстрее.

### <a name="how-can-i-remove-the-second-storage-account"></a>Как удалить вторичную учетную запись хранения?

Чтобы удалить вторичную учетную запись хранения сохраняемости AOF, установите одну учетную запись хранения в качестве основной и вторичной. Инструкции см. в разделе [Настройка сохраняемости AOF](#configure-aof-persistence).

### <a name="what-is-a-rewrite-and-how-does-it-affect-my-cache"></a>Что такое перезапись и как она влияет на кэш?

Если файл AOF достигает достаточно большого размера, перезапись автоматически ставится в очередь кэша. Этот процесс изменяет размер файла AOF с минимальным набором операций, необходимых для создания текущего набора данных. Во время операций перезаписи следует ожидать быстрого достижения ограничения производительности, особенно при работе с большими наборами данных. Операции перезаписи возникают реже по мере увеличения файла AOF, но при этом занимают значительное количество времени.

### <a name="what-should-i-expect-when-scaling-a-cache-with-aof-enabled"></a>Что следует ожидать при масштабировании кэша с включенной сохраняемостью AOF?

Если файл AOF во время масштабирования значительно увеличивается в размере, следует ожидать, что операция масштабирования займет больше времени, чем ожидалось, так как после завершения масштабирования файл перезагружается.

Дополнительные сведения см. в разделе [Что произойдет, если выполнено масштабирование до другого размера, а резервная копия была создана до этой операции?](#what-happens-if-i-have-scaled-to-a-different-size-and-a-backup-is-restored-that-was-made-before-the-scaling-operation)

### <a name="how-is-my-aof-data-organized-in-storage"></a>Как организованы данные AOF в хранилище?

Данные, хранящиеся в файлах AOF, делятся на несколько страничных BLOB-объектов на узел. Это позволяет увеличить производительность сохранения данных в хранилище. В таблице ниже показано, сколько страничных BLOB-объектов используются в каждой ценовой категории.

| Уровень Premium | BLOB-объекты |
|--------------|-------|
| P1           | 4 на сегмент    |
| P2           | 8 на сегмент    |
| P3           | 16 на сегмент   |
| P4           | 20 на сегмент   |

Если включена кластеризация, каждый сегмент в кэше имеет свой собственный набор страничных BLOB-объектов, как показано в предыдущей таблице. Например, кэш P2 с тремя сегментами распределяет файл AOF по 24 страничным BLOB-объектам (8 BLOB-объектов на сегмент, 3 сегменты).

После перезаписи в хранилище создается два набора файлов AOF. Операции перезаписи выполняются в фоновом режиме и добавляются к первому набору файлов, а операции над множеством, которые отправляются в кэш во время перезаписи, добавляются ко второму набору. Во время перезаписи на случай сбоя временно сохраняется резервная копия, которая сразу же удаляется после завершения перезаписи.


## <a name="next-steps"></a>Дополнительная информация
Узнайте, как использовать расширенные функции кэша.

* [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md)

<!-- IMAGES -->

[redis-cache-premium-pricing-tier]: ./media/cache-how-to-premium-persistence/redis-cache-premium-pricing-tier.png

[redis-cache-persistence]: ./media/cache-how-to-premium-persistence/redis-cache-persistence.png

[redis-cache-rdb-persistence]: ./media/cache-how-to-premium-persistence/redis-cache-rdb-persistence.png

[redis-cache-aof-persistence]: ./media/cache-how-to-premium-persistence/redis-cache-aof-persistence.png

[redis-cache-settings]: ./media/cache-how-to-premium-persistence/redis-cache-settings.png
