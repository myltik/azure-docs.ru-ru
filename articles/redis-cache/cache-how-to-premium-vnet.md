---
title: Настройка виртуальной сети для кэша Redis для Azure уровня "Премиум" | Документация Майкрософт
description: Узнайте, как настроить поддержку виртуальной сети и управлять ей для экземпляров кэша Redis для Azure уровня Премиум
services: redis-cache
documentationcenter: ''
author: wesmc7777
manager: cfowler
editor: ''
ms.assetid: 8b1e43a0-a70e-41e6-8994-0ac246d8bf7f
ms.service: cache
ms.workload: tbd
ms.tgt_pltfrm: cache-redis
ms.devlang: na
ms.topic: article
ms.date: 05/15/2017
ms.author: wesmc
ms.openlocfilehash: 250c66c3a39519a6eddc1ecb51259ec1944c88a9
ms.sourcegitcommit: 1362e3d6961bdeaebed7fb342c7b0b34f6f6417a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2018
---
# <a name="how-to-configure-virtual-network-support-for-a-premium-azure-redis-cache"></a>Настройка поддержки виртуальной сети для кэша Redis для Azure уровня Премиум
Кэш Redis для Azure предлагает разные варианты кэша, которые обеспечивают гибкость в выборе размера и функций кэша, включая функции уровня "Премиум", такие как кластеризация, постоянное хранение данных и поддержка виртуальной сети. Виртуальная сеть — это частная сеть в облаке. В случае настройки экземпляра кэша Redis для Azure в виртуальной сети он не является общедоступным, а доступен только для виртуальных машин и приложений в этой виртуальной сети. В этой статье описана настройка поддержки виртуальной сети для экземпляра кэша Redis для Azure уровня "Премиум".

> [!NOTE]
> Кэш Redis для Azure поддерживает классические виртуальные сети и виртуальные сети Resource Manager.
> 
> 

Сведения о других функциях кэша уровня "Премиум" см. в статье [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md).

## <a name="why-vnet"></a>Зачем использовать виртуальные сети?
Развертывание [виртуальной сети Azure (VNet)](https://azure.microsoft.com/services/virtual-network/) обеспечивает улучшенную безопасность и изоляцию для кэша Redis для Azure. Такие развертывания позволяют определять подсети, настраивать политики контроля доступа и использовать другие функции ограничения доступа.

## <a name="virtual-network-support"></a>Поддержка виртуальной сети
Поддержка виртуальной сети настраивается во время создания кэша в колонке **Новый кэш Redis** . 

[!INCLUDE [redis-cache-create](../../includes/redis-cache-premium-create.md)]

После выбора ценовой категории "Премиум" можно настроить интеграцию виртуальной сети Redis, выбрав виртуальную сеть, которая находится в той же подписке и расположении, что и кэш. Чтобы использовать новую виртуальную сеть, сначала создайте ее, выполнив действия, описанные в статье [Создание виртуальной сети с помощью портала Azure](../virtual-network/manage-virtual-network.md#create-a-virtual-network) или [Создание (классической) виртуальной сети с помощью портала Azure](../virtual-network/virtual-networks-create-vnet-classic-pportal.md), а затем вернитесь в колонку **Новый кэш Redis**, чтобы создать и настроить кэш уровня "Премиум".

Чтобы настроить виртуальную сеть для нового кэша, в колонке **Новый кэш Redis** щелкните **Виртуальная сеть** и в раскрывающемся списке выберите нужную виртуальную сеть.

![Виртуальная сеть][redis-cache-vnet]

Выберите нужную подсеть в раскрывающемся списке **Подсети** и укажите необходимый **статический IP-адрес**. При использовании классической виртуальной сети заполнять поле **Статический IP-адрес** не обязательно, а если этот адрес не задан, то он выбирается из указанной подсети.

> [!IMPORTANT]
> При развертывании кэша Redis для Azure в виртуальной сети Resource Manager он должен размещаться в выделенной подсети, которая не содержит других ресурсов, кроме экземпляров кэша Redis для Azure. Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, то это приведет к сбою операции.
> 
> 

![Виртуальная сеть][redis-cache-vnet-ip]

> [!IMPORTANT]
> Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)
> 
> Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается имеющим один сегмент.
> 
> 

Создав кэш, конфигурацию виртуальной сети можно просмотреть, щелкнув **Виртуальная сеть** в **меню ресурсов**.

![Виртуальная сеть][redis-cache-vnet-info]

Чтобы подключиться к экземпляру кэша Redis для Azure при использовании виртуальной сети, укажите имя узла кэша в строке подключения, как показано в приведенном ниже примере.

    private static Lazy<ConnectionMultiplexer> lazyConnection = new Lazy<ConnectionMultiplexer>(() =>
    {
        return ConnectionMultiplexer.Connect("contoso5premium.redis.cache.windows.net,abortConnect=false,ssl=true,password=password");
    });

    public static ConnectionMultiplexer Connection
    {
        get
        {
            return lazyConnection.Value;
        }
    }

## <a name="azure-redis-cache-vnet-faq"></a>Часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure
Следующий список содержит ответы на часто задаваемые вопросы о виртуальных сетях кэша Redis для Azure.

* [Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?](#what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets)
* [Как проверить, что кэш работает в виртуальной сети?](#how-can-i-verify-that-my-cache-is-working-in-a-vnet)
* [Почему при попытке подключения к моему кэшу Redis в виртуальной сети происходит ошибка и появляется сообщение о том, что удаленный сертификат недействителен?](#when-trying-to-connect-to-my-redis-cache-in-a-vnet-why-am-i-getting-an-error-stating-the-remote-certificate-is-invalid)
* [Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?](#can-i-use-vnets-with-a-standard-or-basic-cache)
* [Почему в одних подсетях не удается создать кэш Redis, а в других удается?](#why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others)
* [Каковы требования к адресному пространству подсети?](#what-are-the-subnet-address-space-requirements)
* [Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)](#do-all-cache-features-work-when-hosting-a-cache-in-a-vnet)

### <a name="what-are-some-common-misconfiguration-issues-with-azure-redis-cache-and-vnets"></a>Каковы распространенные ошибки конфигурации кэша Redis для Azure и виртуальных сетей?
При размещении кэша Redis для Azure в виртуальной сети используются порты, указанные в следующих таблицах. 

>[!IMPORTANT]
>Если эти порты заблокированы, кэш может работать неправильно. Блокировка одного или нескольких из этих портов является самой распространенной проблемой неправильной настройки при использовании кэша Redis для Azure в виртуальной сети.
> 
> 

- [Обязательные порты для исходящего трафика](#outbound-port-requirements)
- [Обязательные порты для входящего трафика](#inbound-port-requirements)

#### <a name="outbound-port-requirements"></a>Обязательные порты для исходящего трафика

Существует семь обязательных портов для исходящего трафика.

- При необходимости все исходящие подключения к Интернету осуществляются через устройство аудита в локальной среде клиента.
- Три порта направляют трафик к конечным точкам Azure, обслуживающим службу хранилища Azure и Azure DNS.
- Остальные диапазоны портов предназначены для внутреннего обмена данными в подсети Redis. Для внутреннего обмена данными в подсети Redis не требуются правила группы безопасности сети в подсети.

| Порты | Направление | Транспортный протокол | Назначение | Локальный IP-адрес | Удаленный IP-адрес |
| --- | --- | --- | --- | --- | --- |
| 80, 443 |Исходящие |TCP |Зависимости Redis в службе хранилища Azure или PKI (Интернет) | (Подсеть Redis) |* |
| 53 |Исходящие |TCP/UDP |Зависимости Redis в DNS (Интернет/виртуальная сеть) | (Подсеть Redis) |* |
| 8443 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) | (Подсеть Redis) |
| 10221-10231 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) | (Подсеть Redis) |
| 20226 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 13000-13999 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 15000-15999 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 6379-6380 |Исходящие |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |


#### <a name="inbound-port-requirements"></a>Обязательные порты для входящего трафика

Существует восемь обязательных диапазонов портов для входящего трафика. Входящие запросы в этих диапазонах исходят от других служб, размещенных в той же виртуальной сети, или являются результатом внутреннего обмена данными в подсети Redis.

| Порты | Направление | Транспортный протокол | Назначение | Локальный IP-адрес | Удаленный IP-адрес |
| --- | --- | --- | --- | --- | --- |
| 6379, 6380 |Входящий трафик |TCP |Обмен данными между клиентом и Redis, балансировка нагрузки Azure | (Подсеть Redis) | (Подсеть Redis), виртуальная сеть, Azure Load Balancer |
| 8443 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |
| 8500 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure | (Подсеть Redis) |Azure Load Balancer |
| 10221-10231 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) Azure Load Balancer |
| 13000-13999 |Входящий трафик |TCP |Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure | (Подсеть Redis) |Виртуальная сеть, Azure Load Balancer |
| 15000-15999 |Входящий трафик |TCP |Обмен данными между клиентом и кластерами Redis, балансировка нагрузки Azure | (Подсеть Redis) |Виртуальная сеть, Azure Load Balancer |
| 16001 |Входящий трафик |TCP/UDP |Балансировка нагрузки Azure | (Подсеть Redis) |Azure Load Balancer |
| 20226 |Входящий трафик |TCP |Внутренний обмен данными для Redis | (Подсеть Redis) |(Подсеть Redis) |

#### <a name="additional-vnet-network-connectivity-requirements"></a>Дополнительные требования к подключению к виртуальной сети

Существуют требования к сетевому подключению кэша Redis для Azure, которым виртуальная сеть изначально может не соответствовать. Для правильной работы кэша Redis для Azure в виртуальной сети нужно выполнить все требования, перечисленные ниже.

* Исходящие сетевые подключения к конечным точкам хранилища Azure по всему миру. Это относится к конечным точкам, находящимся в одном регионе с экземпляром кэша Redis для Azure, а также к конечным точкам хранилища, расположенным в **других** регионах Azure. Конечные точки службы хранилища Azure разрешаются в следующих DNS-доменах: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net* и *file.core.windows.net*. 
* Исходящие сетевые подключения к *ocsp.msocsp.com*, *mscrl.microsoft.com* и *crl.microsoft.com*. Такое подключение необходимо для поддержки функций протокола SSL.
* Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках. Эти требования DNS обеспечиваются за счет настройки допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.
* Исходящие сетевые подключения к следующим конечным точкам мониторинга Azure, которые разрешаются в таких DNS-доменах: shoebox2-black.shoebox2.metrics.nsatc.net, north-prod2.prod2.metrics.nsatc.net, azglobal-black.azglobal.metrics.nsatc.net, shoebox2-red.shoebox2.metrics.nsatc.net, east-prod2.prod2.metrics.nsatc.net, azglobal-red.azglobal.metrics.nsatc.net.

### <a name="how-can-i-verify-that-my-cache-is-working-in-a-vnet"></a>Как проверить, что кэш работает в виртуальной сети?

>[!IMPORTANT]
>При подключении к экземпляру кэша Redis для Azure, размещенному в виртуальной сети, клиенты кэша должны находиться в той же виртуальной сети или в виртуальной сети, в которой включен пиринг виртуальных сетей. Сюда входят все тестовые приложения и средства диагностики для проверки связи. Независимо от того, где размещено клиентское приложение, сетевые группы безопасности необходимо настроить таким образом, чтобы сетевой трафик клиента достигал экземпляра Redis.
>
>

Когда обязательные порты настроены, как описано в предыдущем разделе, можно проверить работу кэша, выполнив следующие действия.

- [Перезагрузите](cache-administration.md#reboot) все узлы кэша. Если не установить все необходимые зависимости кэша (как описано в разделах [Обязательные порты для входящего трафика](cache-how-to-premium-vnet.md#inbound-port-requirements) и [Обязательные порты для исходящего трафика](cache-how-to-premium-vnet.md#outbound-port-requirements)), то кэш не сможет перезапускаться.
- После перезапуска узлов кэша (по данным о состоянии кэша на портале Azure) можно выполнить следующие поверки:
  - проверить связь с конечной точкой кэша (через порт 6380) с компьютера, который находится с кэшем в одной виртуальной сети, используя инструмент [tcping](https://www.elifulkerson.com/projects/tcping.php). Например: 
    
    `tcping.exe contosocache.redis.cache.windows.net 6380`
    
    Если инструмент `tcping` сообщает, что порт открыт, то кэш доступен для подключения с клиентов в виртуальной сети.

  - Другой способ проверки — создать тестовый клиент кэша (это может быть простое консольное приложение, использующее StackExchange.Redis), который подключается к кэшу и добавляет какие-то элементы в кэш или извлекает их из него. Установите пример клиентского приложения на виртуальную машину, которая находится с кэшем в одной виртуальной сети, и запустите его, чтобы проверить подключение к кэшу.


### <a name="when-trying-to-connect-to-my-redis-cache-in-a-vnet-why-am-i-getting-an-error-stating-the-remote-certificate-is-invalid"></a>Почему при попытке подключения к моему кэшу Redis в виртуальной сети происходит ошибка и появляется сообщение о том, что удаленный сертификат недействителен?

При попытке подключения к кэшу Redis в виртуальной сети появляется такое сообщение об ошибке проверки сертификатов:

`{"No connection is available to service this operation: SET mykey; The remote certificate is invalid according to the validation procedure.; …"}`

Причина может заключаться в том, что вы подключаетесь к узлу по IP-адресу. Мы рекомендуем использовать имя узла. Другими словами, используйте следующее:     

`[mycachename].redis.windows.net:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False`

Не используйте IP-адрес, похожий на следующую строку подключения:

`10.128.2.84:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False`

Если не удается разрешить имя DNS, некоторые клиентские библиотеки содержат параметры конфигурации, например `sslHost`, которые предоставляет клиент StackExchange.Redis. Это позволяет переопределить имя узла, используемое для проверки сертификата. Например: 

`10.128.2.84:6380,password=xxxxxxxxxxxxxxxxxxxx,ssl=True,abortConnect=False;sslHost=[mycachename].redis.windows.net`

### <a name="can-i-use-vnets-with-a-standard-or-basic-cache"></a>Можно ли использовать виртуальные сети в кэше уровня "Стандартный" или "Базовый"?
Виртуальные сети доступны только для кэшей уровня "Премиум".

### <a name="why-does-creating-a-redis-cache-fail-in-some-subnets-but-not-others"></a>Почему в одних подсетях не удается создать кэш Redis, а в других удается?
При развертывании кэша Redis для Azure в виртуальной сети Resource Manager он должен размещаться в выделенной подсети, которая не содержит ресурсов другого типа. Если попытаться развернуть кэш Redis для Azure в подсети виртуальной сети Resource Manager, содержащей другие ресурсы, то это приведет к сбою операции. Прежде чем создать новый кэш Redis, необходимо удалить существующие ресурсы из подсети.

В классической виртуальной сети можно развернуть ресурсы нескольких типов, пока для них имеется достаточно доступных IP-адресов.

### <a name="what-are-the-subnet-address-space-requirements"></a>Каковы требования к адресному пространству подсети?
Azure резервирует некоторые IP-адреса в каждой подсети, которые нельзя использовать. Зарезервированы первый и последний IP-адреса подсетей (для соответствия требованиям протокола), а также еще три адреса, используемые для служб Azure. Дополнительные сведения см. в разделе [Существуют ли ограничения на использование IP-адресов в пределах этих подсетей?](../virtual-network/virtual-networks-faq.md#are-there-any-restrictions-on-using-ip-addresses-within-these-subnets)

Помимо IP-адресов, используемых инфраструктурой виртуальной сети Azure, каждый экземпляр Redis в подсети использует два IP-адреса на сегмент и еще один IP-адрес для балансировщика нагрузки. Некластеризованный кэш считается имеющим один сегмент.

### <a name="do-all-cache-features-work-when-hosting-a-cache-in-a-vnet"></a>Do all cache features work when hosting a cache in a VNET? (Все ли функции кэша работают, когда он размещен в виртуальной сети?)
Если кэш является частью виртуальной сети, то к нему могут обращаться только клиенты в этой виртуальной сети. Поэтому следующие функции управления кэшем в данный момент не работают.

* Консоль Redis. Так как консоль Redis работает в локальном браузере вне виртуальной сети, она не может подключиться к кэшу.


## <a name="use-expressroute-with-azure-redis-cache"></a>Использование ExpressRoute с кэшем Redis для Azure

Клиенты могут подключить канал [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/) к своей инфраструктуре виртуальной сети, расширяя таким образом свою локальную сеть в Azure. 

По умолчанию только что созданный канал ExpressRoute не выполняет принудительное туннелирование (объявление маршрута по умолчанию, 0.0.0.0/0) в виртуальной сети. В результате исходящие подключения к Интернету выполняются напрямую из виртуальной сети, а клиентские приложения могут подключаться к другим конечным точкам Azure, включая кэш Redis для Azure.

Тем не менее типовой клиентской конфигурацией является использование принудительного туннелирования (объявление маршрута по умолчанию), которое вместо этого направляет исходящий интернет-трафик в локальную среду. Этот поток трафика прерывает подключение к кэшу Redis для Azure, если исходящий трафик затем блокируется локально, так что экземпляр кэша Redis для Azure не может связаться со своими зависимыми компонентами.

Чтобы устранить эту проблему, следует указать один (или несколько) определяемый пользователем маршрут в подсети, которая содержит кэш Redis для Azure. Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.

При возможности рекомендуется использовать следующую конфигурацию:

* Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.
* Определяемый пользователем маршрут, примененный к подсети, содержащей кэш Redis для Azure, задает рабочий маршрут 0.0.0.0/0 для трафика TCP/IP, направляемого в общедоступный Интернет. Для этого может задаваться, например, следующий переход типа "Интернет".

В результате этих действий определяемый пользователем маршрут уровня подсети получает приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из кэша Redis для Azure.

Подключение к экземпляру кэша Redis для Azure из локального приложения с помощью ExpressRoute — нетипичная ситуация по соображениям производительности (для повышения производительности клиенты кэша Redis для Azure должны быть в том же регионе, что и кэш Redis для Azure).

>[!IMPORTANT] 
>Маршруты, указанные в UDR, **должны** быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute. В приведенном ниже примере используется широкий диапазон адресов 0.0.0.0/0, и, таким образом, он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.

>[!WARNING]  
>Кэш Redis для Azure не поддерживается с конфигурациями ExpressRoute, которые **неправильно осуществляют перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**. Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure. Если эти диапазоны адресов неправильно перекрестно объявляются по пути частного пиринга, то все исходящие сетевые пакеты из подсети экземпляра кэша Redis для Azure неправильно принудительно туннелируются в локальную сетевую инфраструктуру клиента. Этот сетевой поток нарушает работу кэша Redis для Azure. Решением этой проблемы является остановка перекрестного объявления маршрутов между путем общедоступного и закрытого пиринга.


Справочные сведения об определяемых пользователем маршрутах см. в этом [обзоре](../virtual-network/virtual-networks-udr-overview.md).

Дополнительные сведения об ExpressRoute см. в статье [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).

## <a name="next-steps"></a>Дополнительная информация
Узнайте, как использовать расширенные функции кэша.

* [Знакомство с кэшем Redis для Azure уровня Премиум](cache-premium-tier-intro.md)

<!-- IMAGES -->

[redis-cache-vnet]: ./media/cache-how-to-premium-vnet/redis-cache-vnet.png

[redis-cache-vnet-ip]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-ip.png

[redis-cache-vnet-info]: ./media/cache-how-to-premium-vnet/redis-cache-vnet-info.png

