<properties 
	pageTitle="Кэш Redis для Azure. Вопросы и ответы | Microsoft Azure" 
	description="Ответы на часто задаваемые вопросы, шаблоны и рекомендации для кэша Redis для Azure." 
	services="redis-cache" 
	documentationCenter="" 
	authors="steved0x" 
	manager="douge" 
	editor=""/>

<tags 
	ms.service="cache" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="cache-redis" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="09/21/2016" 
	ms.author="sdanie"/>

# Кэш Redis для Azure. Вопросы и ответы

Ответы на часто задаваемые вопросы, шаблоны и рекомендации для кэша Redis для Azure.


## Мне не удалось найти ответ на свой вопрос. Что делать?

Если вашего вопроса нет в списке, сообщите нам об этом, и мы поможем найти ответ.

-	Можно опубликовать вопрос в [дискуссии Disqus](#comments), указанной в конце раздела часто задаваемых вопросов, и обсудить данную статью с командой разработчиков кэша Azure и другими участниками сообщества.
-	Чтобы охватить большую аудиторию, можно опубликовать вопрос на [форуме MSDN по кэшу Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=azurecache) и обсудить его с командой разработчиков кэша Azure и другими участниками сообщества.
-	Если вы хотите сделать запрос на функцию, то можете отправить свои запросы и предложения на [форуме пользователей кэша Redis для Azure](https://feedback.azure.com/forums/169382-cache).
-	Можно также [отправить нам внешний отзыв о кэше Azure](mailto:azurecache@microsoft.com) по электронной почте.

## Основные сведения о кэше Redis для Azure

Часто задаваемые вопросы в этом разделе охватывают некоторые основные сведения о кэше Redis для Azure.

-    [Описание кэша Redis для Azure](#what-is-azure-redis-cache)
-    [Как приступить к работе с кэшем Redis для Azure?](#how-can-i-get-started-with-azure-redis-cache)

Ниже приведены часто задаваемые вопросы об основных понятиях и использовании кэша Redis для Azure, ответы на которые даны в других разделах часто задаваемых вопросов.

-	[Какое предложение и размер кэша Redis мне следует использовать?](#what-redis-cache-offering-and-size-should-i-use)
-	[Какие клиенты кэша Redis можно использовать?](#what-redis-cache-clients-can-i-use)
-	[Существует локальный эмулятор кэша Redis для Azure?](#is-there-a-local-emulator-for-azure-redis-cache)
-	[Как отслеживать работоспособность и производительность моего кэша?](#how-do-i-monitor-the-health-and-performance-of-my-cache)



## Часто задаваемые вопросы о планировании

-	[Какое предложение и размер кэша Redis мне следует использовать?](#what-redis-cache-offering-and-size-should-i-use)
-	[Производительность кэша Redis для Azure](#azure-redis-cache-performance)
-	[В каком регионе следует размещать мой кэш?](#in-what-region-should-i-locate-my-cache)
-	[Как выставляются счета за использование кэша Redis для Azure?](#how-am-i-billed-for-azure-redis-cache)



## Часто задаваемые вопросы о разработке

-	[Что делают параметры конфигурации StackExchange.Redis?](#what-do-the-stackexchangeredis-configuration-options-do)
-	[Какие клиенты кэша Redis можно использовать?](#what-redis-cache-clients-can-i-use)
-	[Существует локальный эмулятор кэша Redis для Azure?](#is-there-a-local-emulator-for-azure-redis-cache)
-	[Как выполнять команды Redis?](#how-can-i-run-redis-commands)
-	[Почему в кэше Redis для Azure отсутствует ссылка на библиотеку классов MSDN, как в некоторых других службах Azure?](#why-doesnt-azure-redis-cache-have-an-msdn-class-library-reference-like-some-of-the-other-azure-services)
-	[Можно ли использовать кэш Redis для Azure как кэш сеанса PHP?](#can-i-use-azure-redis-cache-as-a-php-session-cache)


## Часто задаваемые вопросы о безопасности

-	[Когда следует включать порт, не являющийся портом SSL, для подключения к Redis?](#when-should-i-enable-the-non-ssl-port-for-connecting-to-redis)


## Часто задаваемые вопросы о рабочей среде

-	[Какие рекомендации следует учитывать для рабочей среды?](#what-are-some-production-best-practices)
-	[Какие факторы следует учитывать при использовании общих команд Redis?](#what-are-some-of-the-considerations-whru-RUing-common-redis-commands)
-	[Как измерить и протестировать производительность моего кэша?](#how-can-i-benchmark-and-test-the-performance-of-my-cache)
-	[Важные сведения о росте пула потоков ThreadPool](#important-details-about-threadpool-growth)
-	[Включение сборки мусора сервера для получения более высокой пропускной способности на стороне клиента при использовании StackExchange.Redis](#enable-server-gc-to-get-more-throughput-on-the-client-whru-RUing-stackexchangeredis)


## Часто задаваемые вопросы о мониторинге и устранении неполадок

Вопросы, обсуждаемые в этом разделе, посвящены общим проблемам мониторинга и устранения неполадок. Дополнительные сведения о мониторинге и устранении неполадок, связанных с экземплярами кэша Redis для Azure, см. в статьях [Как отслеживать кэш Redis для Azure](cache-how-to-monitor.md) и [Способы устранения проблем с кэшем Redis для Azure](cache-how-to-troubleshoot.md).

-	[Как отслеживать работоспособность и производительность моего кэша?](#how-do-i-monitor-the-health-and-performance-of-my-cache)
-	[Почему изменились настройки учетной записи хранения диагностики кэша?](#my-cache-diagnostics-storage-account-settings-changed-what-happened)
-	[Почему диагностика включена для некоторых новых кэшей, но не включена для других?](#why-is-diagnostics-enabled-for-some-new-caches-but-not-others)
-	[Почему я наблюдаю простои?](#why-am-i-seeing-timeouts)
-	[Почему мой клиент был отключен от кэша?](#why-was-my-client-disconnected-from-the-cache)


## Часто задаваемые вопросы о предыдущих предложениях кэша

-	[Какой кэш Azure подходит мне?](#which-azure-cache-offering-is-right-for-me)


### Описание кэша Redis для Azure

Кэш Redis для Azure основан на популярном [кэше с открытым кодом Redis](http://redis.io). Он предоставляет вам доступ к безопасному выделенному кэшу Redis, управляемому корпорацией Майкрософт и доступному из любых приложений в Azure. Более подробный обзор представлен на странице [кэша Redis для Azure](https://azure.microsoft.com/services/cache/) на сайте Azure.com.


### Как приступить к работе с кэшем Redis для Azure?

Существует несколько способов приступить к работе с кэшем Redis для Azure.

-    Вы можете ознакомиться с одним из наших учебников, доступных для [.NET](cache-dotnet-how-to-use-azure-redis-cache.md), [ASP.NET](cache-web-app-howto.md), [Java](cache-java-get-started.md), [Node.js](cache-nodejs-get-started.md), и [Python](cache-python-get-started.md).
-    Вы можете посмотреть, [как создавать высокопроизводительные приложения с помощью кэша Redis для Microsoft Azure](https://azure.microsoft.com/documentation/videos/how-to-build-high-performance-apps-using-microsoft-azure-cache/).
-    Можно ознакомиться с документацией по клиентам, которые поддерживают язык, используемый при разработке проекта, чтобы узнать, как использовать Redis. Существует множество клиентов Redis, которые можно использовать с кэшем Redis для Azure. Список клиентов Redis доступен на странице [http://redis.io/clients](http://redis.io/clients).


Если у вас нет учетной записи Azure, то вы можете сделать следующее.

-    [Открыть бесплатную учетную запись Azure](/pricing/free-trial/?WT.mc_id=redis_cache_hero). Вы получаете кредиты, которые можно использовать, чтобы попробовать платные службы Azure. После израсходования кредитов ваша учетная запись не исчезнет. Вы сможете использовать ее для работы с бесплатными службами и функциями Azure.
-    [Активировать преимущества подписчика Visual Studio](/pricing/member-offers/msdn-benefits-details/?WT.mc_id=redis_cache_hero). Ваша подписка MSDN каждый месяц приносит вам кредиты, которые можно использовать для оплаты использования служб Azure.


<a name="cache-size"></a>
### Какое предложение и размер кэша Redis мне следует использовать?
Все предложения кэша Redis для Azure обеспечивают разные уровни параметров **размера**, **пропускной способности**, **высокой доступности** и **соглашения об уровне обслуживания**.

Ниже приведены рекомендации по выбору предложения кэша.

-	**Память**: уровни Базовый и Стандартный предлагают от 250 МБ до 53 ГБ. Уровень Премиум предлагает 530 ГБ с возможностью увеличения объема [по запросу](mailto:wapteams@microsoft.com?subject=Redis%20Cache%20quota%20increase). Подробнее см. в разделе [Цены на кэш Redis для Azure](https://azure.microsoft.com/pricing/details/cache/).
-	**Производительность сети**: если у вас есть рабочая нагрузка, которая требует высокой пропускной способности, то уровень Премиум предоставит большую пропускную способность по сравнению с уровнями Стандартный или Базовый. Также в рамках каждого уровня пропускная способность для кэшей большего размера выше из-за виртуальной машины, на которой размещен кэш. Дополнительные сведения приведены в [следующей таблице](#cache-performance).
-	**Пропускная способность**: уровень Премиум предлагает максимальную доступную пропускную способность. При достижении кэшем сервера или клиента пределов пропускной способности на стороне клиента возникнут простои. Дополнительные сведения приведены в таблице ниже.
-	**Высокая доступность/SLA**: кэш Redis для Azure гарантирует, что кэш "Стандартный" и "Премиум" будет доступен не меньше 99,9 % времени. Дополнительные сведения о соглашении об уровне обслуживания см. в разделе [Цены на кэш Redis для Azure](https://azure.microsoft.com/support/legal/sla/cache/v1_0/). Соглашение об уровне обслуживания распространяется только на подключения к конечным точкам кэша. Соглашение об уровне обслуживания не включает защиту от потери данных. Для повышения устойчивости к потере данных рекомендуется использовать функцию постоянного хранения данных Redis уровня Премиум.
-	**Постоянное хранение данных Redis**: уровень Премиум позволяет постоянно хранить данные кэша в учетной записи хранения Azure. В кэше Базовый и Стандартный все данные хранятся только в памяти. При возникновении проблем с базовой инфраструктурой это может привести к потере данных. Для повышения устойчивости к потере данных рекомендуется использовать функцию постоянного хранения данных Redis уровня Премиум. Кэш Redis для Azure предлагает варианты постоянного хранения данных RDB и AOF (ожидается в ближайшее время). Дополнительные сведения см. в разделе [Настройка постоянного хранения для кэша Redis для Azure уровня Премиум](cache-how-to-premium-persistence.md).
-	**Кластер Redis**: для создания кэша размером более 53 ГБ или сегментации данных по нескольким узлам Redis можно воспользоваться кластеризацией Redis, которая доступна на уровне "Премиум". Каждый узел состоит из пары кэшей (основной кэш и реплика) для обеспечения высокой доступности. Дополнительные сведения см. в разделе [Настройка кластеризации для кэша Redis для Azure уровня Премиум](cache-how-to-premium-clustering.md).
-	**Улучшенная безопасность и сетевая изоляция**: развертывание виртуальной сети Azure обеспечивает улучшенную безопасность и изоляцию для кэша Redis для Azure, а также подсети, политики контроля доступа и другие функции для дальнейшего ограничения доступа. Дополнительные сведения см. в разделе [Настройка поддержки виртуальной сети для кэша Redis для Azure уровня Премиум](cache-how-to-premium-vnet.md).
-	**Настройка Redis**: на уровнях "Стандартный" и "Премиум" вы можете настроить уведомления пространства ключей в Redis.
-	**Максимальное число подключений клиентов**: уровень Премиум обеспечивает максимальное число клиентов, которые могут подключаться к Redis, причем чем больше размер кэша, тем больше число подключений. [Подробные сведения приведены на странице с ценами](https://azure.microsoft.com/pricing/details/cache/).
-	**Выделенное ядро для сервера Redis**: на уровне Премиум для всех размеров кэша для Redis выделяется отдельное ядро. На уровнях Базовый и Стандартный отдельное ядро выделяется для размера C1 и выше.
-	**Redis является однопоточным**, поэтому наличие более двух ядер не предоставляет дополнительных преимуществ по сравнению с двумя ядрами, но виртуальные машины большего размера обычно имеют большую пропускную способность, чем виртуальные машины меньшего размера. Если кэш сервера или клиента достигает пределов пропускной способности, вы получите простои на стороне клиента.
-	**Повышение производительности**: кэши на уровне "Премиум" разворачиваются на оборудовании с более быстрыми процессорами и обеспечивают повышенную производительность по сравнению с уровнями "Базовый" и "Стандартный". Кэши уровня Премиум обладают более высокой пропускной способностью и меньшей задержкой.

<a name="cache-performance"></a>
### Производительность кэша Redis для Azure

В следующей таблице показаны максимальные значения пропускной способности, наблюдаемые при тестировании разных размеров кэша уровней Стандартный или Премиум с помощью `redis-benchmark.exe` из виртуальной машины Iaas для конечной точки кэша Redis для Azure. Обратите внимание, что эти значения не гарантируются и для них не предусмотрено соглашение об уровне обслуживания, однако они должны быть типичными. Чтобы определить подходящий объем кэша для вашего приложения, вам следует загрузить его тестирование.

Из этой таблицы можно сделать следующие выводы.

-	Пропускная способность кэшей равного размера для уровня "Премиум" выше, чем для уровня "Стандартный". Например, для кэша размером в 6 ГБ пропускная способность P1 составляет 140 тыс. запросов в секунду, в то время как пропускная способность C3 — 49 тыс..
-	С кластеризацией Redis пропускная способность линейно увеличивается по мере увеличения числа сегментов (узлов) в кластере. Например, если создать кластер P4 из 10 сегментов, то доступная пропускная способность будет составлять 250 тыс. * 10 = 2,5 млн запросов в секунду.
-	Пропускная способность для ключей большего размера для уровня "Премиум" выше, чем для уровня "Стандартный".

| Ценовой уровень | Размер | Ядра ЦП | Доступная пропускная способность | Размер ключа 1 КБ |
|--------------------------|--------|-----------|--------------------------------------------------------|------------------------------------------|
| **Размеры кэша уровня Стандартный** | | | **Мегабит в секунду (Мбит/с) или Мегабайт в секунду (МБ/с)** | **Запросов в секунду** |
| C0 | 250 МБ | Совмещаемая блокировка | 5 / 0,625 | 600 |
| C1 | 1 GB | 1 | 100 / 12,5 | 12 200 |
| C2 | 2,5 ГБ | 2 | 200 / 25 | 24 000 |
| C3 | 6 ГБ | 4\. | 400 / 50 | 49 000 |
| C4 | 13 ГБ | 2 | 500 / 62,5 | 61 000 |
| C5 | 26 ГБ | 4\. | 1000 / 125 | 115 000 |
| C6 | 53 ГБ | 8 | 2000 / 250 | 150 000 |
| **Размеры кэша уровня Премиум** | | **Число ядер ЦП на сегмент** | | **Запросов в секунду для каждого сегмента** |
| P1 | 6 ГБ | 2 | 1000 / 125 | 140 000 |
| P2 | 13 ГБ | 4\. | 2000 / 250 | 220 000 |
| P3 | 26 ГБ | 4\. | 2000 / 250 | 220 000 |
| P4 | 53 ГБ | 8 | 4000 / 500 | 250 000 |


Инструкции по загрузке инструментов Redis, таких как `redis-benchmark.exe`, см. в разделе [Как выполнять команды Redis?](#cache-commands).

<a name="cache-region"></a>
### В каком регионе следует размещать мой кэш?

Для лучшей производительности и минимальной задержки размещайте свой кэш Redis для Azure в одном регионе с вашим кэшируемым клиентским приложением.

<a name="cache-billing"></a>
### Как выставляются счета за использование кэша Redis для Azure?

Цены на кэш Redis для Azure можно посмотреть [здесь](https://azure.microsoft.com/pricing/details/cache/). На странице указаны расценки в виде почасового тарифа. Выставляемые счета за использование кэшей рассчитываются на поминутной основе. Они охватывают интервал времени между созданием кэшей и их удалением. Остановить или приостановить выставление счета за использование кэша нельзя.


<a name="cache-configuration"></a>
### Что делают параметры конфигурации StackExchange.Redis?

StackExchange.Redis имеет много параметров. В этом разделе рассказывается о некоторых распространенных параметрах. Более подробные сведения о параметрах StackExchange.Redis см. в статье [Конфигурация StackExchange.Redis](https://github.com/StackExchange/StackExchange.Redis/blob/master/Docs/Configuration.md).

Параметры конфигурации|Описание|Рекомендации
---|---|---
AbortOnConnectFail|Если задано значение true, соединение не будет восстанавливаться после сбоя сети.|Установите значение false и позвольте StackExchange.Redis автоматически восстанавливать соединение.
ConnectRetry|Количество повторных попыток подключения во время первоначального подключения.| Руководствуйтесь следующими примечаниями. |
ConnectTimeout|Время ожидания в миллисекундах для операций подключения.| Руководствуйтесь следующими примечаниями. |

В большинстве случаев подходят значения по умолчанию для клиента. Вы можете точнее настроить параметры в зависимости от своей рабочей нагрузки.

-	**Повторы**
	-	Общая рекомендация для ConnectRetry и ConnectTimeout — быстрое прекращение и повторение попытки. Это зависит от вашей рабочей нагрузки и от того, сколько времени в среднем занимает в вашем клиенте выдача команды Redis и получение ответа.
	-	Вам не нужно проверять состояние и подключаться самостоятельно — StackExchange.Redis переподключается автоматически. **Избегайте использования свойства ConnectionMultiplexer.IsConnected**.
	-	Снежный ком — иногда возникает проблема, когда вы повторяете снова и снова, это нарастает и никогда не исправляется. В этом случае следует использовать алгоритм экспоненциальной отсрочки повтора, как описано в [общем руководстве по повторам](best-practices-retry-general.md), опубликованном группой Microsoft Patterns & Practices.
-	**Значения времени ожидания**
	-	Исследуйте вашу рабочую нагрузку и установите соответствующие значения. Если вы храните большие значения, установите более высокое значение времени ожидания.
	-	Установите для `AbortOnConnectFail` значение false и позвольте StackExchange.Redis восстанавливать подключение.
	-	Используйте один экземпляр ConnectionMultiplexer для приложения. Вы можете применять LazyConnection, чтобы создать один экземпляр, который возвращается свойством Connection, как показано в разделе [Подключение к кэшу с использованием класса ConnectionMultiplexer](cache-dotnet-how-to-use-azure-redis-cache.md#connect-to-the-cache).
	-	Задайте в свойстве `ConnectionMultiplexer.ClientName` уникальное имя экземпляра приложения в целях диагностики.
	-	Используйте несколько экземпляров `ConnectionMultiplexer` для пользовательских рабочих нагрузок.
	-	Вы можете следовать этой модели, если в приложении имеется меняющаяся нагрузка. Например:
	-	можно иметь один мультиплексор для работы с большими ключами;
	-	можно иметь один мультиплексор для работы с небольшими ключами;
	-	можно задать разные значения времени ожидания подключения и логики повторов для каждого используемого ConnectionMultiplexer.
	-	Установите свойство `ClientName` в каждом мультиплексоре для облегчения диагностики.
	-	Это обеспечит более оптимизированную задержку на каждый класс `ConnectionMultiplexer`.

### Какие клиенты кэша Redis можно использовать?

Одним из основных преимуществ Redis является то, что существует множество клиентов, поддерживающих множество языков разработки. Текущий список клиентов Redis см. [здесь](http://redis.io/clients). Учебники для нескольких различных языков и клиентов см. в статье [Как использовать кэш Redis для Azure](cache-dotnet-how-to-use-azure-redis-cache.md). Выберите нужный язык, используя переключатель языков в верхней части статьи.

[AZURE.INCLUDE [redis-cache-create](../../includes/redis-cache-access-keys.md)]

<a name="cache-emulator"></a>
### Существует локальный эмулятор кэша Redis для Azure?

Локального эмулятора кэша Redis для Azure нет, но можно запустить версию MSOpenTech redis-server.exe из [программ командной строки Redis](https://github.com/MSOpenTech/redis/releases/) на локальном компьютере и подключиться к нему, чтобы получить возможности, аналогичные локальному эмулятору кэша, как показано в следующем примере.


	private static Lazy<ConnectionMultiplexer>
  		lazyConnection = new Lazy<ConnectionMultiplexer>
	    (() =>
	    {
		    // Connect to a locally running instance of Redis to simulate a local cache emulator experience.
		    return ConnectionMultiplexer.Connect("127.0.0.1:6379");
	    });
	
	    public static ConnectionMultiplexer Connection
	    {
		    get
		    {
			    return lazyConnection.Value;
		    }
	    }


При необходимости можно настроить файл [redis.conf](http://redis.io/topics/config) для более точного соответствия [параметрам кэша по умолчанию](cache-configure.md#default-redis-server-configuration) для подключенного к сети кэша Redis для Azure.

<a name="cache-commands"></a>
### Как выполнять команды Redis?

Можно использовать любую из команд, перечисленных в [командах Redis](http://redis.io/commands#), за исключением команд, указанных в перечне [команд, не поддерживаемых в кэше Redis для Azure](cache-configure.md#redis-commands-not-supported-in-azure-redis-cache). Выполнять команды Redis можно несколькими способами.

-	При наличии кэша уровня "Стандартный" или "Премиум" вы можете запускать команды Redis с помощью [консоли Redis](cache-configure.md#redis-console). Это — защищенный способ выполнения команд Redis на портале Azure.
-	Также можно использовать средства командной строки Redis. Чтобы воспользоваться ими, выполните следующие действия.
-	Загрузите [программы командной строки Redis](https://github.com/MSOpenTech/redis/releases/).
-	Подключитесь к кэшу с помощью `redis-cli.exe`. Передайте конечную точку кэша, используя параметр -h и ключ с параметром -a, как показано в следующем примере.
-	`redis-cli -h <your cache="" name="">
.redis.cache.windows.net -a <key>
  `
  -	Обратите внимание, что программы командной строки Redis не работают с портом SSL, но можно использовать программу, такую как `stunnel`, для безопасного подключения этих программ к порту SSL в соответствии с указаниями в записи блога [Объявление о поставщике состояний сеансов ASP.NET для предварительной версии Redis](http://blogs.msdn.com/b/webdev/archive/2014/05/12/announcing-asp-net-session-state-provider-for-redis-preview-release.aspx).

<a name="cache-reference"></a>
### Почему в кэше Redis для Azure отсутствует ссылка на библиотеку классов MSDN, как в некоторых других службах Azure?

Кэш Redis для Microsoft Azure основывается на популярном продукте с открытым кодом — кэше Redis. Воспользоваться им можно из самых разнообразных [клиентов Redis](http://redis.io/clients), доступных для многих языков программирования. Каждый клиент имеет собственный API, который вызывает экземпляр кэша Redis с помощью [команд Redis](http://redis.io/commands).

Поскольку все клиенты разные, отсутствует одна централизованная ссылка на классы в MSDN; вместо этого каждый клиент поддерживает свою собственную справочную документацию. Помимо справочной документации имеется несколько учебников, показывающих, как приступить к работе с кэшем Redis для Azure, используя разные языки и клиенты кэша. Для доступа к этим учебникам перейдите к статье [Как использовать кэш Redis для Azure](cache-dotnet-how-to-use-azure-redis-cache.md) и выберите нужный язык, используя переключатель языков в верхней части статьи.


### Можно ли использовать кэш Redis для Azure как кэш сеанса PHP?

Да. Для использования кэша Redis для Azure в качестве кэша сеанса PHP укажите строку подключения к экземпляру кэша Redis для Azure в пути `session.save_path`.

>[AZURE.IMPORTANT] При использовании кэша Redis для Azure в качестве кэша сеанса PHP необходимо кодировать в URL-адресе ключ безопасности, используемый для подключения к кэшу, как показано в следующем примере.
>
>`session.save_path = "tcp://mycache.redis.cache.windows.net:6379?auth=<url encoded primary or secondary key here>";`
>
>Если ключ не кодирован в URL-адресе, то может появляться сообщение об исключении, подобное этому: `Failed to parse session.save_path`.

Дополнительные сведения об использовании кэша Redis в качестве кэша сеанса PHP с клиентом PhpRedis см. в разделе [PHP Session handler](https://github.com/phpredis/phpredis#php-session-handler) (Обработчик сеанса PHP).



<a name="cache-ssl"></a>
### Когда следует включать порт, не являющийся портом SSL, для подключения к Redis?

Сервер Redis не имеет встроенной поддержки SSL, но кэш Redis для Azure имеет. Если вы подключаетесь к кэшу Redis для Azure и ваш клиент поддерживает протокол SSL, например StackExchange.Redis, то следует использовать SSL.

Обратите внимание, что для новых экземпляров кэша Redis для Azure все порты, кроме SSL, отключены по умолчанию. Если ваш клиент не поддерживает SSL, то необходимо включить порт, не являющийся портом SSL, следуя указаниям, приведенным в разделе [Порты доступа](cache-configure.md#access-ports) статьи [Настройка кэша в кэше Redis для Azure](cache-configure.md).

Инструменты Redis, такие как `redis-cli`, не работают с портом SSL, но можно использовать программу, например `stunnel`, для безопасного подключения инструментов к порту SSL в соответствии с указаниями в записи блога [Объявление о поставщике состояний сеансов ASP.NET для предварительной версии Redis](http://blogs.msdn.com/b/webdev/archive/2014/05/12/announcing-asp-net-session-state-provider-for-redis-preview-release.aspx).

Инструкции по загрузке инструментов Redis см. в разделе [Как выполнять команды Redis?](#cache-commands).



### Какие рекомендации следует учитывать для рабочей среды?

-	[Рекомендации для StackExchange.Redis](#stackexchangeredis-best-practices)
-	[Конфигурация и основные понятия](#configuration-and-concepts)
-	[Тестирование производительности](#performance-testing)

#### Рекомендации для StackExchange.Redis

-	Задайте для `AbortConnect` значение false, подождите, пока ConnectionMultiplexer автоматически восстановит подключение. [Щелкните здесь, чтобы узнать больше](https://gist.github.com/JonCole/36ba6f60c274e89014dd#file-se-redis-setabortconnecttofalse-md).
-	Повторно используйте ConnectionMultiplexer — не создавайте новый экземпляр для каждого запроса. Настоятельно рекомендуется использовать шаблон `Lazy<ConnectionMultiplexer>`, [показанный здесь](cache-dotnet-how-to-use-azure-redis-cache.md#connect-to-the-cache).
-	Лучше всего Redis работает с меньшими значениями, поэтому рассмотрите возможность разделения больших данных на несколько ключей. В [этом обсуждении Redis](https://groups.google.com/forum/#!searchin/redis-db/size/redis-db/n7aa2A4DZDs/3OeEPHSQBAAJ) размер в 100 КБ признан "большим". Прочитайте [эту статью](https://gist.github.com/JonCole/db0e90bedeb3fc4823c2#large-requestresponse-size), чтобы ознакомиться с примером проблемы, вызванной большими значениями.
-	Настройте [параметры ThreadPool](#important-details-about-threadpool-growth), чтобы избежать тайм-аутов.
-	Используйте по крайней мере значение connectTimeout по умолчанию, равное 5 секундам. Это даст StackExchange.Redis достаточно времени, чтобы повторно установить подключение в случае кратковременного сбоя сети.
-	Учтите расходы на производительность, связанные с другими операциями, которые вы выполняете. Например, команда `KEYS` является операцией O(n), т. е. операцией, длительность которой линейно зависит от размера входных данных. Таких операций следует избегать. [Сайт redis.io](http://redis.io/commands/) содержит сведения о временной сложности каждой поддерживаемой операции. Щелкните каждую команду, чтобы просмотреть сведения о сложности операции.

#### Конфигурация и основные понятия

-	Для систем в рабочей среде используйте уровень "Стандартный" или "Премиум". Уровень "Базовый" — это система с одним узлом без репликации данных, которая не регулируется соглашением об уровне обслуживания. Кроме того, используйте по крайней мере кэш C1. Кэши C0 действительно предназначены для простых сценариев разработки и тестирования .
-	Помните, что Redis — это хранилище данных **в памяти**. Прочитайте [эту статью](https://gist.github.com/JonCole/b6354d92a2d51c141490f10142884ea4#file-whathappenedtomydatainredis-md), чтобы ознакомиться со случаями, в которых может произойти потеря данных.
-	Создайте свою систему таким образом, чтобы она могла справляться с кратковременными сбоями подключения, [связанными с установкой исправлений и отработкой отказа](https://gist.github.com/JonCole/317fe03805d5802e31cfa37e646e419d#file-azureredis-patchingexplained-md).

#### Тестирование производительности

-	Начните с запуска `redis-benchmark.exe`, чтобы определить возможную пропускную способность перед созданием собственных тестов производительности. Обратите внимание, что redis-benchmark не поддерживает протокол SSL, поэтому перед запуском теста необходимо [включить порт без SSL посредством портала Azure](cache-configure.md#access-ports). Примеры приведены в разделе [Как измерить и протестировать производительность моего кэша?](#how-can-i-benchmark-and-test-the-performance-of-my-cache).
-	Клиентская виртуальная машина, используемая для тестирования, должна находиться в том же регионе, что и экземпляр кэша Redis.
-	В качестве клиента рекомендуется использовать виртуальные машины серии Dv2, так как в них используется более производительное оборудование и они выдают лучшие результаты.
-	Убедитесь, что у выбранной клиентской виртуальной машины как минимум такая же емкость вычислительных ресурсов и пропускной способности, что и у тестируемого кэша.
-	Включите VRSS на клиентском компьютере, если используется среда Windows. [Щелкните здесь, чтобы узнать больше](https://technet.microsoft.com/library/dn383582.aspx).
-	Экземпляры Redis уровня "Премиум" обеспечат меньшие сетевые задержки и большую пропускную способность, так как используют более производительные ЦП и сетевое оборудование.

<a name="cache-redis-commands"></a>
### Какие факторы следует учитывать при использовании общих команд Redis?

-	Прежде чем запускать определенные команды Redis, которые выполняются слишком долго, необходимо понять влияние этих команд.
	-	Например, не выполняйте команду [KEYS](http://redis.io/commands/keys) в рабочей среде, поскольку ее выполнение может занять очень много времени, в зависимости от количества ключей. Redis является однопотоковым сервером и обрабатывает команды по одной. Если вы выдадите после KEYS другие команды, они не будут обрабатываться, пока Redis обрабатывает команду KEYS. [Сайт redis.io](http://redis.io/commands/) содержит сведения о временной сложности каждой поддерживаемой операции. Щелкните каждую команду, чтобы просмотреть сведения о сложности операции.
-	Размеры ключей — следует использовать пары "ключ-значение" небольшого или большого размера? В целом это зависит от сценария. Если в сценарии требуются большие ключи, то можно настроить значения повторов и ConnectionTimeout, а также настроить логику повторов. С точки зрения сервера Redis чем меньше значения, тем лучше производительность.
-	Это не означает, что в Redis нельзя хранить большие значения; вы должны учитывать следующие факторы. Задержки будут выше. Если имеется один большой и один небольшой набор данных, можно использовать несколько экземпляров ConnectionMultiplexer, настроенных с разным набором значений времени ожидания и повторов, как описано в предыдущем разделе [Что делают параметры конфигурации StackExchange.Redis](#cache-configuration).



<a name="cache-benchmarking"></a>
### Как измерить и протестировать производительность моего кэша?

-	[Включите диагностику кэша](cache-how-to-monitor.md#enable-cache-diagnostics), чтобы можно было [наблюдать](cache-how-to-monitor.md) за работоспособностью кэша. Вы можете просмотреть метрики на портале Azure. Кроме того, их можно [скачать и просмотреть](https://github.com/rustd/RedisSamples/tree/master/CustomMonitoring) с помощью привычных вам инструментов.
-	Для нагрузочного теста сервера Redis можно использовать benchmark.exe.
-	Убедитесь, что клиент нагрузочного тестирования и кэш Redis находятся в одном регионе.
-	Используйте redis-cli.exe и наблюдайте за кэшем с помощью команды INFO.
-	Если ваша нагрузка приводит к высокой степени фрагментации памяти, то необходимо масштабирование до большего размера кэша.
-	Инструкции по загрузке инструментов Redis см. в разделе [Как выполнять команды Redis?](#cache-commands).

Далее приведен пример использования redis-benchmark.exe. Чтобы получить точные результаты, выполните приведенную ниже команду на виртуальной машине, размещенной в том же регионе, что и кэш.

-	Тестирование конвейерных запросов SET с полезными данными размером в 1 КБ.

    redis-benchmark.exe -h **yourcache**.redis.cache.windows.net -a **yourAccesskey** -t SET -n 1000000 -d 1024 -P 50
	
-	Тестирование конвейерных запросов GET с полезными данными размером в 1 КБ. Примечание. Сначала выполните приведенный выше тест SET, чтобы заполнить кэш.
	
    redis-benchmark.exe -h **yourcache**.redis.cache.windows.net -a **yourAccesskey** -t GET -n 1000000 -d 1024 -P 50

<a name="threadpool"></a>
### Важные сведения о росте пула потоков ThreadPool

В CLR ThreadPool существует два типа потоков — "Рабочий поток" и "Порт завершения ввода-вывода" (также называемый IOCP).

-	Рабочие потоки используются, например, для обработки методов `Task.Run(…)` или `ThreadPool.QueueUserWorkItem(…)`. Эти потоки также используются различными компонентами в среде CLR, когда работа должна быть выполнена в фоновом потоке.
-	Потоки IOCP используются в случае асинхронного ввода-вывода (например чтение из сети).

Пул потоков предоставляет новые рабочие потоки или потоки завершения ввода-вывода по запросу (без регулирования), пока не будет достигнут параметр "Минимум" для каждого типа потока. По умолчанию минимальное количество потоков равно количеству процессоров в системе.

Когда количество существующих (занятых) потоков достигает "минимального" количества потоков, ThreadPool изменяет частоту внедрения новых потоков до величины в один поток за 500 миллисекунд. Это означает, что если нагрузка системы достигает величины, для которой необходим поток IOCP, эта работа будет сделана очень быстро. Однако если величина нагрузки больше настроенного параметра "Минимум", при обработке некоторых операций возникнет некоторая задержка, так как ThreadPool будет ожидать возникновения одного из двух событий.

1. Освобождение существующего потока для выполнения работы.
1. Создание нового потока из-за того, что ни один из существующих потоков не стал доступным в течение 500 мс.

По сути, это означает, что если количество занятых потоков превышает минимальное количество потоков, вы скорее всего столкнетесь с задержкой в 500 мс перед обработкой сетевого трафика приложением. Кроме того, важно обратить внимание, что если существующий поток простаивает более 15 секунд (на основе моих наблюдений), он будет удален, и этот цикл наращивания и уменьшения количества потоков может повториться.

Если взглянуть на пример сообщения об ошибке от StackExchange.Redis (сборка 1.0.450 или более поздней версии), вы увидите, что теперь оно содержит статистику ThreadPool (подробности о рабочих потоках и потоках IOCP см. ниже).

	System.TimeoutException: Timeout performing GET MyKey, inst: 2, mgr: Inactive, 
	queue: 6, qu: 0, qs: 6, qc: 0, wr: 0, wq: 0, in: 0, ar: 0, 
	IOCP: (Busy=6,Free=994,Min=4,Max=1000), 
	WORKER: (Busy=3,Free=997,Min=4,Max=1000)

В приведенном выше примере можно увидеть, что для потока IOCP существует 6 занятых потоков, а минимальное количество потоков — 4. В этом случае клиент скорее всего столкнется с двумя задержками по 500 мс, так как 6 больше 4.

Обратите внимание, что StackExchange.Redis может достигнуть времени ожидания, если происходит регулирование количества рабочих потоков или потоков IOCP.

### Рекомендации

С учетом этой информации мы настоятельно рекомендуем клиентам устанавливать значение параметра "Минимум" для рабочих потоков и потоков IOCP так, чтобы оно превышало значение по умолчанию. Мы не можем дать универсальных рекомендаций для этого значения, так как подходящее значение для одного приложения будет слишком высоким или низким для другого приложения. Этот параметр также может повлиять на производительность других компонентов сложных приложений, поэтому каждый клиент должен точно настроить этот параметр в соответствии со своими потребностями. Хорошей отправной точкой является 200 или 300, после чего нужно проверить и изменить этот параметр в соответствии с результатом.

Как настроить этот параметр:

-	В ASP.NET используйте [параметр конфигурации minIoThreads][] в разделе элемента конфигурации `<processModel>` в файле web.config. Внутри веб-сайтов Azure этот параметр недоступен для настройки. Тем не менее, его можно установить программно (см. ниже) из метода Application\_Start в файле global.asax.cs.

> **Важное замечание**. В этом элементе конфигурации задается параметр *per-core*. Например, если у вас 4-ядерный компьютер и вы хотите установить для параметра minIOThreads значение 200 во время выполнения, то можно использовать `<processModel minIoThreads="50"/>`.

-	За пределами ASP.NET используйте API [ThreadPool.SetMinThreads(…)](https://msdn.microsoft.com/library/system.threading.threadpool.setminthreads.aspx).

<a name="server-gc"></a>
### Включение сборки мусора сервера для получения более высокой пропускной способности на стороне клиента при использовании StackExchange.Redis

Включение сборки мусора сервера может оптимизировать работу клиента и улучшить производительность и пропускную способность при использовании StackExchange.Redis. Дополнительные сведения о сборке мусора сервера и о том, как ее включить, можно найти в приведенных ниже статьях.

-	[Включение сборки мусора сервера](https://msdn.microsoft.com/library/ms229357.aspx)
-	[Основные сведения о сборке мусора](https://msdn.microsoft.com/library/ee787088.aspx)
-	[Сборка мусора и производительность](https://msdn.microsoft.com/library/ee851764.aspx)







<a name="cache-monitor"></a>
### Как отслеживать работоспособность и производительность моего кэша?

За экземплярами кэша Redis для Microsoft Azure можно наблюдать на [портале Azure](https://portal.azure.com). Вы можете просматривать метрики, закреплять диаграммы метрик на начальной панели, настраивать диапазоны дат и времени для диаграмм мониторинга, добавлять и удалять метрики в диаграммах, а также настраивать отправку оповещений при выполнении определенных условий. Дополнительные сведения см. в статье [Как отслеживать кэш Redis для Azure](cache-how-to-monitor.md).

В разделе **Поддержка и устранение неполадок** колонки **Параметры** кэша Redis также содержится несколько инструментов для мониторинга и устранения неполадок кэшей.

-	Щелкните **Устранение неполадок**, чтобы узнать об основных проблемах и способах их устранения.
-	Щелкните **Журналы аудита**, чтобы узнать о действиях с кэшем. Также можно использовать фильтрацию, чтобы развернуть это представление, включив в него другие ресурсы.
-	Служба **работоспособности ресурсов** отслеживает ресурс и сообщает, работает ли он как ожидалось. Дополнительные сведения о службе работоспособности ресурсов Azure см. в разделе [Обзор службы работоспособности ресурсов Azure](../resource-health/resource-health-overview.md).
-	Щелкнув **Новый запрос на поддержку**, можно создать запрос по своему кэшу.

Эти инструменты позволяют наблюдать за работоспособностью экземпляров кэша Redis для Azure и помогают управлять кэшируемыми приложениями. Дополнительные сведения см. в разделе [Настройки поддержки и устранения неполадок](cache-configure.md#support-amp-troubleshooting-settings).

### Почему изменились настройки учетной записи хранения диагностики кэша?

Для экземпляров кэша в одном регионе и в рамках одной подписки используются одни и те же параметры хранилища диагностики. Если изменяется конфигурация (включается или отключается диагностика либо изменяется учетная запись хранения), то новые настройки применяются ко всем кэшам в подписке, входящим в данный регион. Если параметры диагностики для кэша изменились, проверьте, не изменились ли параметры диагностики для другого кэша в той же подписке и в том же регионе. Один из способов сделать это — проверить журналы аудита для кэша на наличие в них события `Write DiagnosticSettings`. Дополнительные сведения о работе с журналами аудита см. в статьях [Просмотр журналов событий и аудита](../azure-portal/insights-debugging-with-events.md) и [Операции аудита с помощью диспетчера ресурсов](../resource-group-audit.md). Дополнительные сведения о мониторинге событий кэша Redis для Azure см. в разделе [Операции и оповещения](cache-how-to-monitor.md#operations-and-alerts).

### Почему диагностика включена для некоторых новых кэшей, но не включена для других?

Для экземпляров кэша в одном регионе и в рамках одной подписки используются одни и те же параметры хранилища диагностики. Если новый кэш создается в том же регионе и в рамках той же подписки, где уже есть кэш с включенной диагностикой, то в новом кэше диагностика включается с такими же параметрами.


<a name="cache-timeouts"></a>
### Почему я наблюдаю простои?

Простои происходят на клиенте, который вы используете для обращения к Redis. В основном сервер Redis не простаивает. Когда команда отправляется на сервер Redis, она помещается в очередь, и со временем сервер Redis выбирает команду и выполняет его. Однако во время этого процесса клиент может простаивать, и в этом случае на вызывающей стороне возникает исключение. Дополнительные сведения об устранении проблем с тайм-аутами см. в разделах [Устранение проблем на стороне клиента](cache-how-to-troubleshoot.md#client-side-troubleshooting) и [Исключения времени ожидания StackExchange.Redis](cache-how-to-troubleshoot.md#stackexchangeredis-timeout-exceptions).


<a name="cache-disconnect"></a>
### Почему мой клиент был отключен от кэша?

Ниже приведены некоторые распространенные причины отключения кэша.

-	Причины на стороне клиента
	-	Клиентское приложение было развернуто повторно.
	-	Клиентское приложение выполняло операцию масштабирования.
		-	В случае облачных служб или веб-приложений это может быть следствием автоматического масштабирования.
	-	Изменен сетевой уровень на стороне клиента.
	-	Возникла временная ошибка на клиенте или в узлах сети между клиентом и сервером.
	-	Было достигнуто предельное пороговое значение пропускной способности.
	-	Выполнение операций, связанных с ЦП, заняло слишком много времени.
-	Причины на стороне сервера
	-	В предложении кэша Standard служба кэша Redis для Azure инициировала отработку отказа с переходом с основного узла на вторичный узел.
	-	В Azure было выполнено исправление экземпляра, в котором был развернут кэш.
		-	Это могли быть обновления сервера Redis или обычное обслуживание ВМ.







### Какой кэш Azure подходит мне?

>[AZURE.IMPORTANT]Согласно прошлогоднему [объявлению](https://azure.microsoft.com/blog/azure-managed-cache-and-in-role-cache-services-to-be-retired-on-11-30-2016/), использование управляемой службы кэша Azure и службы кэша роли Azure будет прекращено 30 ноября 2016 года. Рекомендуется использовать [кэш Redis для Azure](https://azure.microsoft.com/services/cache/). Дополнительные сведения о переходе на новую службу см. в разделе [Перенос из управляемой службы кэша в кэш Redis для Azure](cache-migrate-to-redis.md).

### кэш Azure Redis
Кэш Redis для Azure, как правило, доступен в размере до 53 ГБ, а доступность по соглашению об уровне обслуживания составляет 99,9 %. Новый [уровень "Премиум"](cache-premium-tier-intro.md) доступен в предварительной версии: предлагается до 530 ГБ и поддержка кластеризации, виртуальной сети и сохраняемости в соответствии с соглашением об уровне обслуживания 99,9 %.

Кэш Redis для Azure позволяет клиентам использовать безопасный выделенный кэш Redis, управляемый Майкрософт. В рамках этого предложения вам доступны широкий набор функций и экосистема от Redis, а также надежное размещение и мониторинг от Майкрософт.

В отличие от обычных кэшей, работающих только с парами «ключ — значение», Redis популярен благодаря его высокоэффективным типам данных. Redis также поддерживает выполнение атомарных операций с этими типами, включая добавление в строку, инкрементное увеличение значения в хэше, публикация в список, вычисление пересечения, объединения и разницы в наборе; получение элемента с наивысшим рейтингом в сохраненном наборе. К другим функциям относится поддержка транзакций, публикации и подписок, скрипты Lua, ключи с ограниченным сроком жизни и параметры конфигурации, настройка которых обеспечивает схожее с традиционным кэшем поведение Redis.

Другой важный фактор успеха Redis — это жизнеспособная, активно развивающаяся экосистема с открытым исходным кодом, построенная вокруг него. Это отражено в различных наборах клиентов Redis, доступных на разных языках. Поэтому его можно использовать почти для любой рабочей нагрузки, создаваемой в Azure.

Дополнительные сведения о начале работы с кэшем Redis для Azure см. в разделе [Как использовать кэш Redis для Azure](cache-dotnet-how-to-use-azure-redis-cache.md) и [документации по кэшу Redis для Azure](https://azure.microsoft.com/documentation/services/redis-cache/).

### Управляемая служба кэша
[Управляемая служба кэша прекращает свою работу 30 ноября 2016 года.](https://azure.microsoft.com/blog/azure-managed-cache-and-in-role-cache-services-to-be-retired-on-11-30-2016/)

### Кэш в роли
[Кэш роли прекращает свою работу 30 ноября 2016 года.](https://azure.microsoft.com/blog/azure-managed-cache-and-in-role-cache-services-to-be-retired-on-11-30-2016/)





[параметр конфигурации minIoThreads]: https://msdn.microsoft.com/library/vstudio/7w2sway1(v=vs.100).aspx

<!---HONumber=AcomDC_0921_2016-->