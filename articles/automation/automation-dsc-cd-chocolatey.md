---
title: Непрерывное развертывание с помощью Azure Automation DSC и Chocolatey
description: Непрерывное развертывание DevOps с помощью Automation DSC Azure и диспетчера пакетов Chocolatey.  Пример с полным шаблоном ARM в формате JSON и исходным кодом PowerShell.
services: automation
ms.service: automation
ms.component: dsc
author: georgewallace
ms.author: gwallace
ms.date: 03/16/2018
ms.topic: conceptual
manager: carmonm
ms.openlocfilehash: f695eaadc0aa2d01473262c478a3b184d89d882c
ms.sourcegitcommit: eb75f177fc59d90b1b667afcfe64ac51936e2638
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/16/2018
ms.locfileid: "34195273"
---
# <a name="usage-example-continuous-deployment-to-virtual-machines-using-automation-dsc-and-chocolatey"></a>Пример использования. Непрерывное развертывание на виртуальных машинах с помощью Automation DSC и Chocolatey
В среде DevOps существует множество средств, которые упрощают различные аспекты процесса непрерывной интеграции.  Платформа для настройки требуемого состояния службы автоматизации Azure (далее — Automation DSC Azure) — это долгожданная новая функция, которую могут использовать команды разработчиков DevOps.  В этой статье показана настройка непрерывного развертывания для компьютера Windows.  Применение этого метода можно легко расширить, включив любое количество компьютеров Windows, необходимое для роли (например, веб-сайта), а также дополнительные роли.

![Непрерывное развертывание для виртуальных машин IaaS](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## <a name="at-a-high-level"></a>На высоком уровне
Эта схема включает немало действий, но, к счастью, их можно разбить на два основных процесса: 

* написание и тестирование кода, после чего следуют создание и публикация пакетов установки для основной и вспомогательной версий системы; 
* создание виртуальных машин, которые установят и выполнят код в пакетах, и управление этими виртуальными машинами.  

Выполнив эти основные процессы, можно переходить к автоматическому обновлению пакета, который выполняется на любой отдельно взятой виртуальной машине, по мере создания и развертывания новых версий.

## <a name="component-overview"></a>Обзор компонентов
Диспетчеры пакетов, такие как [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) , хорошо известны среди разработчиков Linux и гораздо меньше — среди тех, кто работает с Windows.  К таким диспетчерам пакетов относится [Chocolatey](https://chocolatey.org/), общие сведения о котором изложены в записи [блога](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) Скотта Ханселмана (Scott Hanselman).  В двух словах, Chocolatey позволяет устанавливать пакеты из центрального репозитория пакетов в системе Windows с помощью командной строки.  Вы можете создать собственный репозиторий и управлять им, а Chocolatey будет устанавливать пакеты из любого указанного вами количества репозиториев.

Настройка требуемого состояния (DSC) ([обзор](https://technet.microsoft.com/library/dn249912.aspx)) — это средство PowerShell, которое позволяет объявить конфигурацию, необходимую для компьютера.  Например, вы можете указать, что нужно установить Chocolatey и IIS, открыть порт 80 и установить версию 1.0.0 вашего веб-сайта.  Локальный диспетчер конфигураций DSC реализует эту конфигурацию. Опрашивающий сервер DSC содержит хранилище конфигураций для компьютеров. Локальный диспетчер конфигураций на каждом компьютере периодически проверяет, совпадает ли его конфигурация с сохраненной конфигурацией. Он либо сообщает о состоянии, либо пытается привести компьютер в соответствие с сохраненной конфигурацией. Сохраненную конфигурацию на опрашивающем сервере можно изменить, чтобы привести компьютер или набор компьютеров в соответствие с измененной конфигурацией.

Служба автоматизации Azure — это управляемая служба в Microsoft Azure, которая позволяет автоматизировать различные задачи с помощью модулей Runbook, узлов, учетных данных, ресурсов и активов, таких как расписания и глобальные переменные. Automation DSC Azure расширяет возможности автоматизации, которые теперь включают средства DSC PowerShell.  Вот прекрасный [обзор](automation-dsc-overview.md)на эту тему.

Ресурс DSC — это модуль кода, который имеет определенные возможности, такие как управление сетевыми подключениями, Active Directory или SQL Server.  Ресурс DSC Chocolatey может получать доступ к серверу NuGet, загружать и устанавливать пакеты и т. д.  Имеется также множество других ресурсов DSC, доступных в [коллекции PowerShell](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).  Эти модули установлены на опрашивающем сервере Automation DSC Azure (вручную), поэтому их можно использовать в ваших конфигурациях.

Шаблоны Resource Manager предоставляют декларативный способ создания инфраструктуры с помощью сетей, подсетей, сетевой безопасности и маршрутизации, подсистем балансировки нагрузки, сетевых карт, виртуальных машин и т. д.  В этой [статье](../azure-resource-manager/resource-manager-deployment-model.md) сравнивается декларативная модель развертывания с помощью Resource Manager и принудительная модель развертывания управления службами Azure (ASM или классическая). Кроме того, в этой статье рассматриваются основные поставщики ресурсов, вычислительные ресурсы, ресурсы хранилища и сетевые ресурсы.

Одна из ключевых особенностей шаблона Resource Manager заключается в возможности установить на виртуальной машине расширение виртуальной машины во время подготовки.  Расширение VM предоставляет определенные возможности, такие как выполнение пользовательского сценария, установка антивирусного программного обеспечения или выполнение сценария конфигурации DSC.  Существует много других типов расширений VM.

## <a name="quick-trip-around-the-diagram"></a>Краткий обзор схемы
Если начинать сначала, вы пишете код, выполняете сборку и тестирование, а затем создаете пакет установки.  Chocolatey может обрабатывать пакеты установки различных типов, например MSI, MSU и ZIP.  Кроме того, в вашем распоряжении имеются все возможности PowerShell для фактической установки, если возможностей Chocolatey недостаточно.  Поместите пакет в легкодоступное место — репозиторий пакетов.  Он может располагаться где угодно. Например, в этом примере используется общая папка в учетной записи хранилища больших двоичных объектов Azure.  Chocolatey работает непосредственно с серверами NuGet и некоторыми другими серверами в рамках управления метаданными пакета.  Возможные варианты описаны в [этой статье](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed).  В этом примере используется NuGet.  Nuspec — это метаданные о пакетах.  Метаданные Nuspec «компилируются» в файлы NuPkg и хранятся на сервере NuGet.  Когда конфигурация запрашивает пакет по имени и ссылается на сервер NuGet, ресурс DSC Chocolatey (установленный на виртуальной машине) извлекает пакет и устанавливает его автоматически.  Можно также запросить определенную версию пакета.

В левой нижней части схемы упоминается шаблон диспетчера ресурсов Azure (ARM).  В этом примере расширение VM регистрирует виртуальную машину на опрашивающем сервере Automation DSC Azure как узел.  Конфигурация хранится на опрашивающем сервере.  На самом деле это двойное хранение: в виде обычного текста и в виде компиляции в MOF-файле (для тех, кто имеет опыт работы с такими файлами).  На портале MOF-файл указывается как «конфигурация узла» (а не просто «конфигурация»).  Это связанный с узлом артефакт, сообщающий узлу его конфигурацию.  Ниже объясняется, как назначить узлу конфигурацию узла.

Скорее всего, вы уже выполнили действия в верхней части схемы или большую их часть.  Создание метаданных Nuspec, их компиляция и сохранение на сервере NuGet — несложная задача.  Кроме того, вы уже управляете виртуальными машинами.  Чтобы выполнить следующий шаг для непрерывного развертывания, необходимо настроить опрашивающий сервер (один раз), зарегистрировать на нем узлы (один раз), а также создать и сохранить на нем конфигурацию (первоначально).  Затем, по мере обновления и развертывания пакетов в репозитории, обновляйте конфигурацию и конфигурацию узлов на опрашивающем сервере (повторяйте при необходимости).

Начинать работу с шаблона ARM не обязательно.  Существуют командлеты PowerShell, которые помогут вам зарегистрировать виртуальные машины на опрашивающем сервере и выполнить все остальные действия. Дополнительные сведения см. в статье [Подключение компьютеров для управления с помощью Azure Automation DSC](automation-dsc-onboarding.md).

## <a name="step-1-setting-up-the-pull-server-and-automation-account"></a>Шаг 1. Настройка опрашивающего сервера и учетной записи службы автоматизации
В командной строке PowerShell с аутентификацией (Connect-AzureRmAccount) выполните следующую команду (настройка опрашивающего сервера может занять несколько минут).

    New-AzureRmResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
    New-AzureRmAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT 

Учетная запись службы автоматизации может располагаться в любом регионе (расположении) из следующего списка: восточная часть США 2, юго-центральный регион США, Виргиния (для обслуживания государственных организаций США), Западная Европа, Юго-Восточная Азия, восточная Япония, центральная Индия, юго-восточная Австралия, Центральная Канада и Северная Европа.

## <a name="step-2-vm-extension-tweaks-to-the-arm-template"></a>Шаг 2. Оптимизация расширения VM в шаблоне ARM
Сведения о регистрации виртуальных машин (с помощью расширения VM PowerShell DSC) можно найти в этом [кратком руководстве по шаблонам Azure](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).  На этом шаге новая виртуальная машина регистрируется на опрашивающем сервере в списке узлов DSC.  В рамках этой регистрации указывается конфигурация узла, применяемая к узлу.  Эта конфигурация узла может пока отсутствовать на опрашивающем сервере, поэтому вполне нормально, что впервые она указывается на шаге 4.  Однако на данном шаге 2 нужно принять решение об имени узла и имени конфигурации.  В этом примере использования узел называется isvbox, а конфигурация — ISVBoxConfig.  Поэтому имя конфигурации узла (указываемое в DeploymentTemplate.json) имеет значение ISVBoxConfig.isvbox.  

## <a name="step-3-adding-required-dsc-resources-to-the-pull-server"></a>Шаг 3. Добавление требуемых ресурсов DSC на опрашивающий сервер
Коллекция PowerShell содержит средства для установки ресурсов DSC в учетной записи службы автоматизации Azure.  Перейдите к нужному ресурсу и нажмите кнопку «Развернуть в службе автоматизации Azure».

![Пример из коллекции PowerShell](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

Недавно на портал Azure добавлена возможность получать новые модули и обновлять имеющиеся. Щелкните ресурс учетной записи службы автоматизации, плитку "Ресурсы" и, наконец, плитку "Модули".  Значок "Обзор коллекции" позволяет просмотреть список модулей в коллекции, перейти к подробным сведениям и в конечном итоге импортировать модуль в учетную запись службы автоматизации. Это отличный способ периодически обновлять модули. Кроме того, во время импорта проверяется наличие зависимостей от других модулей, чтобы обеспечить полную синхронизацию.

Также это можно сделать вручную.  Структура папок модуля интеграции PowerShell для компьютеров Windows немного отличается от структуры папок, ожидаемой службой автоматизации Azure.  Некоторые параметры вам придется настроить самостоятельно.  Но эту процедуру нужно выполнить только один раз для каждого ресурса (если вы не планируете обновлять его в будущем), и в ней нет ничего сложного.  Дополнительные сведения о разработке модулей интеграции PowerShell см. в статье [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/) (Разработка модулей интеграции для службы автоматизации Azure).

* Установите модуль, необходимый на рабочей станции, следующим образом:
  * Установите [Windows Management Framework 5](http://aka.ms/wmf5latest) (не требуется для Windows 10).
  * `Install-Module –Name MODULE-NAME` <— извлекает модуль из коллекции PowerShell. 
* Скопируйте папку модуля из `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` во временную папку. 
* Удалите примеры и документацию из основной папки. 
* Упакуйте основную папку, присвоив ZIP-файлу такое же имя, как у папки. 
* Поместите ZIP-файл в легкодоступное расположение HTTP, например хранилище BLOB-объектов в учетной записи службы хранилища Azure.
* Выполните эту команду PowerShell:
  
      New-AzureRmAutomationModule `
          -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
          -Name MODULE-NAME –ContentLink "https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip"

Приведенный здесь пример выполняет эти действия для cChoco и xNetworking. Ознакомьтесь с [примечаниями](#notes) по особенностям работы с cChoco.

## <a name="step-4-adding-the-node-configuration-to-the-pull-server"></a>Шаг 4. Добавление конфигурации узла к опрашивающему серверу
В первоначальном импорте конфигурации на опрашивающий сервер и ее компиляции нет ничего особенного.  Все последующие операции импорта и компиляции с этой конфигурацией выполняются аналогичным образом.  Каждый раз, когда вам нужно обновить пакет и передать его в рабочую среду, выполняйте этот шаг, предварительно проверив правильность файла конфигурации (включая новую версию пакета).  Вот файл конфигурации и команда PowerShell:

ISVBoxConfig.ps1:

    Configuration ISVBoxConfig 
    { 
        Import-DscResource -ModuleName cChoco 
        Import-DscResource -ModuleName xNetworking

        Node "isvbox" {   

            cChocoInstaller installChoco 
            { 
                InstallDir = "C:\choco" 
            }

            WindowsFeature installIIS 
            { 
                Ensure="Present" 
                Name="Web-Server" 
            }

            xFirewall WebFirewallRule 
            { 
                Direction = "Inbound" 
                Name = "Web-Server-TCP-In" 
                DisplayName = "Web Server (TCP-In)" 
                Description = "IIS allow incoming web site traffic." 
                DisplayGroup = "IIS Incoming Traffic" 
                State = "Enabled" 
                Access = "Allow" 
                Protocol = "TCP" 
                LocalPort = "80" 
                Ensure = "Present" 
            }

            cChocoPackageInstaller trivialWeb 
            {            
                Name = "trivialweb" 
                Version = "1.0.0" 
                Source = “MY-NUGET-V2-SERVER-ADDRESS” 
                DependsOn = "[cChocoInstaller]installChoco", 
                "[WindowsFeature]installIIS" 
            } 
        }    
    }

New-ConfigurationScript.ps1:

    Import-AzureRmAutomationDscConfiguration ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 ` 
        -Published –Force

    $jobData = Start-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -ConfigurationName ISVBoxConfig 

    $compilationJobId = $jobData.Id

    Get-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -Id $compilationJobId

В результате этих действий на опрашивающем сервере будет создана новая конфигурация узла с именем ISVBoxConfig.isvbox.  Имя конфигурации узла задается в формате «имя_конфигурации.имя_узла».

## <a name="step-5-creating-and-maintaining-package-metadata"></a>Шаг 5. Создание и поддержка метаданных пакета
Для описания каждого пакета, который помещается в репозиторий пакетов, необходимы метаданные Nuspec.  Эти метаданные Nuspec следует компилировать и хранить на сервере NuGet. Этот процесс описан [здесь](http://docs.nuget.org/create/creating-and-publishing-a-package).  В качестве сервера NuGet можно использовать сайт MyGet.org.  Это платная служба, но начальные единицы хранения предоставляются бесплатно.  На сайте NuGet.org вы найдете инструкции по установке сервера NuGet для закрытых пакетов.

## <a name="step-6-tying-it-all-together"></a>Шаг 6. Сборка
Каждый раз, когда версия проходит контроль качества и утверждается для развертывания, создается пакет, а nuspec и nupkg обновляются и развертываются на сервере NuGet.  Кроме того, чтобы обеспечить согласованность с новым номером версии, необходимо обновить конфигурацию (описанный выше шаг 4).  Ее необходимо отправить на опрашивающий сервер и скомпилировать.  С этого момента именно виртуальные машины, зависящие от этой конфигурации, отвечают за получение обновления и его установку.  Каждое такое обновление довольно просто и представляет собой одну-две строки кода PowerShell.  В случае с Visual Studio Team Services некоторые из них инкапсулированы в задачи сборки, которые могут быть соединены в цепочку внутри сборки.  Дополнительные сведения см. в [этой статье](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery).  В этом [репозитории GitHub](https://github.com/Microsoft/vso-agent-tasks) описаны различные доступные задачи сборки.

## <a name="notes"></a>Заметки
В начале этого примера создается виртуальная машина с помощью универсального образа Windows Server 2012 R2 из коллекции Azure.  Ее можно запустить из любого сохраненного образа, а затем настроить, используя конфигурацию DSC.  Однако изменение конфигурации, встроенной в образ, требует гораздо больше усилий, чем динамическое обновление конфигурации с помощью DSC.

Для использования этого метода на виртуальных машинах не обязательно использовать шаблон ARM и расширение VM.  Кроме того, виртуальные машины на которых должно выполняться непрерывное развертывание, не обязательно должны размещаться Azure.  На виртуальной машине достаточно установить Chocolatey и настроить локальный диспетчер конфигураций, чтобы указать для нее расположение опрашивающего сервера.  

Конечно, на время обновления пакета на виртуальной машине в рабочей среде эту виртуальную машину придется вывести из эксплуатации.  Это можно сделать разными способами.  Например, на виртуальной машине, которая находится под контролем балансировщика нагрузки Azure, можно добавить настраиваемый зонд.  При обновлении виртуальной машины конечная точка зонда должна возвращать значение 400.  Настройка, необходимая для этого изменения, может содержаться в вашей конфигурации, и после завершения обновления вы сможете снова переключиться на возвращение значения 200.

Полный исходный код для этого примера хранится в [этом проекте Visual Studio](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) на сайте GitHub.

## <a name="related-articles"></a>Связанные статьи
* [Обзор DSC службы автоматизации Azure](automation-dsc-overview.md)
* [Командлеты Automation DSC Azure](https://msdn.microsoft.com/library/mt244122.aspx)
* [Подключение компьютеров для управления с помощью Azure Automation DSC](automation-dsc-onboarding.md)

