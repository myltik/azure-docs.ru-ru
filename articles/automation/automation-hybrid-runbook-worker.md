---
title: Гибридные компоненты Runbook Worker в службе автоматизации Azure
description: В этой статье содержатся сведения об установке и использовании гибридной рабочей роли Runbook, которая является компонентом службы автоматизации Azure, позволяющим запускать модули runbook на компьютерах в локальном центре обработки данных или поставщике облачных решений.
services: automation
ms.service: automation
author: georgewallace
ms.author: gwallace
ms.date: 04/04/2018
ms.topic: article
manager: carmonm
ms.openlocfilehash: 7065ec97e1e02dfb4ee873993caac584f6a63ba6
ms.sourcegitcommit: fa493b66552af11260db48d89e3ddfcdcb5e3152
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2018
---
# <a name="automate-resources-in-your-data-center-or-cloud-with-hybrid-runbook-worker"></a>Автоматизация ресурсов в центре обработки данных или облаке с помощью гибридной рабочей роли Runbook

Модули runbook в службе автоматизации Azure не могут получить доступ к ресурсам в других облаках или локальной среде, так как они выполняются в облаке Azure. Гибридная рабочая роль Runbook службы автоматизации Azure позволяет выполнять модули runbook непосредственно на компьютере, размещающем роль, для работы с ресурсами в среде, что позволяет управлять этими локальными ресурсами. Для хранения модулей runbook и управления ими используется служба автоматизации Azure, затем они передаются на один или несколько целевых компьютеров.

Эта функция проиллюстрирована на рисунке ниже.

![Обзор гибридного компонента Runbook Worker](media/automation-hybrid-runbook-worker/automation.png)

Технический обзор гибридной рабочей роли Runbook и рекомендации по развертыванию приведены в разделе [Общие сведения об архитектуре автоматизации](automation-offering-get-started.md#automation-architecture-overview).

## <a name="hybrid-runbook-worker-groups"></a>Группы гибридных компонентов Runbook Worker

Каждый гибридный компонент Runbook Worker является членом группы гибридных компонентов Runbook Worker, которая указывается при установке агента. Группа может включать одного агента, но в нее можно установить несколько агентов для обеспечения высокого уровня доступности.

Когда вы запускаете модуль runbook в гибридной рабочей роли Runbook, вы выбираете группу для его выполнения. Члены группы самостоятельно определят, какая из служб рабочей роли будет обслуживать этот запрос. Указание конкретного компонента Worker для выполнения конкретной задачи не предусмотрено.

## <a name="relationship-to-service-management-automation"></a>Связь с автоматизацией управления службами

[Service Management Automation (SMA)](https://technet.microsoft.com/library/dn469260.aspx) позволяет запускать в локальном центре обработки данных любые модули Runbook, поддерживаемые службой автоматизации Azure. Компонент SMA развертывается вместе с Windows Azure Pack, так как Windows Azure Pack содержит графический интерфейс для управления SMA. В отличие от службы автоматизации Azure, компоненту SMA требуется локальная установка, которая включает в себя веб-серверы для размещения API, базу данных, содержащую модули Runbook и конфигурацию SMA, и рабочие роли runbook для выполнения заданий Runbook. Служба автоматизации Azure предоставляет эти службы в облаке, для чего необходимо поддерживать гибридные компоненты Runbook Worker в локальной среде.

Если вы являетесь пользователем SMA, то вы можете переместить модули runbook в службу автоматизации Azure, чтобы затем использовать их в гибридной рабочей роли Runbook без изменений, если, конечно, они используют собственную аутентификацию для доступа к ресурсам, как это описано в разделе [Запуск модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md). Модули runbook в SMA выполняются в контексте учетной записи службы на сервере компонентов рабочих ролей, который может обеспечивать аутентификацию для модулей runbook.

Вы можете воспользоваться следующими критериями, чтобы определить, что больше подходит под ваши требования: служба автоматизации Azure с гибридным компонентом Runbook Worker или автоматизация управления службами (SMA).

* Если требуется графический интерфейс управления SMA, то нужно локально установить его базовые компоненты, связанные с Windows Azure Pack. По сравнению со службой автоматизации Azure, для которой необходим только агент, установленный в локальных рабочих ролях Runbook, требуется больше локальных ресурсов и более высокие затраты на обслуживание. Агенты управляются при помощи Azure, что позволяет дополнительно снизить затраты на обслуживание.
* Служба автоматизации Azure сохраняет свои модули Runbook в облаке и предоставляет их локальным гибридным рабочим ролям Runbook. Если ваша политика безопасности не допускает развертывания такой модели, тогда необходимо использовать SMA.
* Компонент SMA входит в состав System Center. Следовательно, для его использования требуется лицензия System Center 2012 R2. Служба автоматизации Azure основана на модели многоуровневой подписки.
* Служба автоматизации Azure обладает дополнительными функциями, такими как создание графических модулей Runbook, которые недоступны в SMA.

## <a name="installing-the-windows-hybrid-runbook-worker"></a>Установка гибридной рабочей роли Runbook Windows

Ниже описаны два метода установки и настройки гибридной рабочей роли Runbook Windows. Мы рекомендуем использовать модуль runbook службы автоматизации для полностью автоматической настройки компьютера Windows. Второй метод заключается в пошаговом выполнении инструкций по ручной установке и настройке роли.

> [!NOTE]
> Чтобы управлять конфигурацией серверов, поддерживающих гибридную рабочую роль Runbook с настройкой требуемого состояния (DSC), добавьте такие серверы в качестве узлов DSC. Дополнительные сведения о развертывании этих узлов для управления с помощью DSC см. в статье [Подключение компьютеров для управления с помощью Azure Automation DSC](automation-dsc-onboarding.md).
>
>Если вы включите [решение по управлению обновлениями](../operations-management-suite/oms-solution-update-management.md), любой подключенный к рабочей области Log Analytics компьютер Windows будет автоматически настроен в качестве гибридной рабочей роли Runbook для поддержки модулей runbook, которые входят в это решение. Но он не регистрируется в группах гибридных рабочих ролей, которые уже определены в вашей учетной записи службы автоматизации. Его можно добавить в группу гибридных рабочих ролей Runbook в учетной записи службы автоматизации, чтобы обеспечить поддержку модулей Runbook службы автоматизации при условии, что вы используете одну и ту же учетную запись для решения и для членства в группе гибридных рабочих ролей Runbook. Эта функция добавлена в версии 7.2.12024.0 гибридной рабочей роли Runbook.

Перед началом развертывания гибридной рабочей роли Runbook ознакомьтесь со следующими сведениями о [требованиях к оборудованию и программному обеспечению](automation-offering-get-started.md#hybrid-runbook-worker) и [сведениями о подготовке сети](automation-offering-get-started.md#network-planning). После успешного развертывания рабочей роли Runbook ознакомьтесь с [запуском модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md), чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде.

### <a name="automated-deployment"></a>Автоматизированное развертывание

Выполните следующие действия для автоматизации установки и настройки гибридной рабочей роли Windows.

1. Скачайте сценарий *New-OnPremiseHybridWorker.ps1* из [коллекции PowerShell](https://www.powershellgallery.com/packages/New-OnPremiseHybridWorker/DisplayScript) непосредственно на компьютер, на котором выполняется гибридная рабочая роль Runbook, или на другой компьютер в вашей среде, после чего скопируйте этот сценарий в рабочую роль.

   Для выполнения сценария *New-OnPremiseHybridWorker.ps1* необходимо задать следующие параметры.

   * *AutomationAccountName* (обязательный) — имя учетной записи службы автоматизации.
   * *AAResourceGroupName* (обязательный) — имя группы ресурсов, связанной с вашей учетной записью автоматизации.
   * *OMSResourceGroupName* (необязательный) — имя группы ресурсов для рабочей области OMS. Если не указано, используется AAResourceGroupName.
   * *HybridGroupName* (обязательный) — имя группы гибридных рабочих ролей Runbook, которую вы указываете в качестве целевой для модулей runbook, поддерживающих этот сценарий.
   * *SubscriptionID* (обязательный) — идентификатор подписки Azure, которая используется для учетной записи автоматизации.
   * *WorkspaceName* (необязательный) — имя рабочей области Log Analytics. Если у вас нет рабочей области Log Analytics, скрипт создаст и настроит ее.

     > [!NOTE]
     > Сейчас интеграция с Log Analytics поддерживается только для следующих регионов службы автоматизации: **Юго-восточная Австралия**, **Восточная часть США 2**, **Юго-Восточная Азия** и **Западная Европа**. Если ваша учетная запись службы автоматизации не находится в одном из этих регионов, скрипт все равно создаст рабочую область Log Analytics, но предупредит, что связывание невозможно.

2. На своем компьютере запустите **Windows PowerShell** на **начальном** экране в режиме администратора.
3. В оболочке командной строки PowerShell перейдите к папке, которая содержит скачанный скрипт, и выполните его, изменив значения параметров *-AutomationAccountName*, *-AAResourceGroupName*, *-OMSResourceGroupName*, *-HybridGroupName*, *-SubscriptionId* и *-WorkspaceName*.

     > [!NOTE]
     > После выполнения скрипта вы увидите запрос на аутентификацию в Azure. Для входа **необходимо** использовать учетную запись, которая является участником роли администраторов подписки и соадминистратором подписки.

   ```powershell-interactive
   .\New-OnPremiseHybridWorker.ps1 -AutomationAccountName <NameofAutomationAccount> -AAResourceGroupName <NameofResourceGroup>`
   -OMSResourceGroupName <NameofOResourceGroup> -HybridGroupName <NameofHRWGroup> `
   -SubscriptionId <AzureSubscriptionId> -WorkspaceName <NameOfLogAnalyticsWorkspace>
   ```

4. Также вы получите предложение подтвердить установку пакета **NuGet** и указать учетные данные Azure для аутентификации.

5. После завершения сценария в колонке "Группы гибридных рабочих ролей" отобразится новая группа и число элементов в ней с учетом только что добавленных. Вы можете выбрать группу из списка на вкладке **Группы гибридных рабочих ролей** и щелкнуть колонку **Гибридные рабочие роли**. В колонке **Гибридные рабочие роли** отображается список элементов группы.

### <a name="manual-deployment"></a>Развертывание вручную

Выполните первые два шага для среды автоматизации, а затем повторите остальные шаги для каждого компьютера с компонентом Worker.

#### <a name="1-create-log-analytics-workspace"></a>1. Создание рабочей области Log Analytics

Если у вас еще нет рабочей области Log Analytics, [создайте](../log-analytics/log-analytics-manage-access.md) ее. Если у вас уже есть рабочая область, вы можете использовать ее.

#### <a name="2-add-automation-solution-to-log-analytics-workspace"></a>2. Добавление решения для автоматизации в рабочую область Log Analytics

Решения добавляют функциональные возможности в службу Log Analytics. Решение автоматизации расширяет функциональные возможности службы автоматизации Azure, включая поддержку гибридных компонентов Runbook Worker. Когда вы добавляете решение в рабочую область, она автоматически загружает компоненты рабочей роли на компьютер агента (вы установите его на следующем этапе).

Выполните инструкции в статье [Добавление решений для управления Azure Log Analytics в рабочую область](../log-analytics/log-analytics-add-solutions.md), чтобы добавить решение **автоматизации** в рабочую область Log Analytics.

#### <a name="3-install-the-microsoft-monitoring-agent"></a>3. Установка Microsoft Monitoring Agent

Microsoft Monitoring Agent подключает компьютеры к Log Analytics. Когда агент устанавливается на локальный компьютер и подключается к рабочей области, он автоматически скачивает компоненты, необходимые для гибридной рабочей роли Runbook.

Установите агент на локальный компьютер, следуя инструкциям в статье [Подключение компьютеров Windows к Log Analytics](../log-analytics/log-analytics-windows-agent.md). Выполните эту процедуру на нескольких компьютерах, чтобы добавить в среду несколько компонентов Worker.

Если агент скачал решение службы автоматизации правильно, в каталоге C:\Program Files\Microsoft Monitoring Agent\Agent появится папка **AzureAutomationFiles**. Чтобы проверить версию гибридной рабочей роли Runbook, откройте папку C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\ и найдите вложенную папку \\*version*.  

#### <a name="4-install-the-runbook-environment-and-connect-to-azure-automation"></a>4. Установите среду модулей Runbook и выполните подключение к службе автоматизации Azure

При добавлении агента в Log Analytics решение автоматизации устанавливает модуль PowerShell **HybridRegistration**, который содержит командлет **Add-HybridRunbookWorker**. Этот командлет используется для установки среды модулей Runbook на компьютере и ее регистрации в службе автоматизации Azure.

Чтобы импортировать модуль, откройте сеанс PowerShell в режиме администратора и выполните следующие команды:

```powershell-interactive
cd "C:\Program Files\Microsoft Monitoring Agent\Agent\AzureAutomation\<version>\HybridRegistration"
Import-Module HybridRegistration.psd1
```

После этого запустите командлет **Add-HybridRunbookWorker** , используя следующий синтаксис:

```powershell-interactive
Add-HybridRunbookWorker –GroupName <String> -EndPoint <Url> -Token <String>
```

Чтобы получить сведения, необходимые для этого командлета, щелкните параметр **Ключи** в разделе **Параметры учетной записи** своей учетной записи службы автоматизации.

* **Имя группы** — это имя группы гибридных рабочих ролей Runbook. Если эта группа уже существует в учетной записи автоматизации, то к ней добавляется текущий компьютер. Если она еще не существует, то выполняется ее добавление.
* **Конечная точка** — это значение поля **URL-адрес** на странице **Ключи**.
* **Токен** — это **первичный ключ доступа** на странице **Управление ключами**.

Для получения подробных сведений об установке используйте параметр **-Verbose** с командлетом **Add-HybridRunbookWorker**.

#### <a name="5-install-powershell-modules"></a>5. Установка модулей PowerShell

Модули Runbook могут использовать любые из действий и командлетов, которые определены в модулях, установленных в вашей среде службы автоматизации Azure. Эти модули не разворачиваются на локальных компьютерах автоматически, поэтому их необходимо устанавливать вручную. Исключением является модуль Azure, который устанавливается по умолчанию и предоставляет доступ к командлетам для всех служб и действий службы автоматизации Azure.

Так как главной целью функции гибридной рабочей роли Runbook является управление локальными ресурсами, вам могут потребоваться модули, которые поддерживают эти ресурсы. Сведения об установке модулей Windows PowerShell можно найти в разделе [Установка модулей](http://msdn.microsoft.com/library/dd878350.aspx) . Устанавливаемые модули должны находиться в расположении, указанном в переменной среды PSModulePath, чтобы гибридная рабочая роль автоматически импортировала их. Дополнительные сведения см. в статье об [изменении пути установки PSModulePath](https://msdn.microsoft.com/library/dd878326%28v=vs.85%29.aspx).

## <a name="removing-hybrid-runbook-worker"></a>Удаление гибридного компонента Runbook Worker

Можно удалить одну или несколько гибридных рабочих ролей Runbook из группы либо удалить группу, в зависимости ваших целей. Чтобы удалить гибридную рабочую роль Runbook на локальном компьютере, выполните следующие действия.

1. На портале Azure перейдите к учетной записи службы автоматизации.
2. В колонке **Параметры** щелкните **Ключи** и запишите значения полей **URL-адрес** и **Первичный ключ доступа**. Эти сведения потребуются для выполнения следующего шага.
3. Откройте сеанс PowerShell в режиме администратора и выполните команду `Remove-HybridRunbookWorker -url <URL> -key <PrimaryAccessKey>`. Получить подробный журнал процедуры удаления можно с помощью параметра **-Verbose** .

Чтобы удалить устаревшие машины из группы гибридной рабочей роли, используйте необязательный параметр `machineName`.

```powershell-interactive
Remove-HybridRunbookWorker -url <URL> -key <PrimaryAccessKey> -machineName <ComputerName>
```

> [!NOTE]
> Агент мониторинга Майкрософт не удаляется с компьютера, удаляются только функциональные возможности и настройки гибридной рабочей роли Runbook.

## <a name="remove-hybrid-worker-groups"></a>Удаление групп гибридных рабочих ролей

Чтобы удалить группу, необходимо сначала удалить гибридную рабочую роль Runbook с каждого компьютера, который является участником этой группы, с помощью приведенной выше процедуры, а затем выполнить приведенные ниже инструкции по удалению группы.

1. На портале Azure откройте учетную запись службы автоматизации.
1. В разделе **Автоматизация процессов** выберите пункт **Группы гибридных рабочих ролей**. Выберите группу, которую необходимо удалить. После выбора конкретной группы отобразится колонка свойств **гибридной рабочей роли**.

   ![Колонка группы гибридных рабочих ролей Runbook](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-group-properties.png)

1. В колонке свойств выбранной группы щелкните **Удалить**. Появится запрос на подтверждение этого действия. Выберите **Да**, если вы уверены, что хотите продолжить.

   ![Диалоговое окно подтверждения удаления группы](media/automation-hybrid-runbook-worker/automation-hybrid-runbook-worker-confirm-delete.png)

   Этот процесс может занять несколько секунд. Ход его выполнения можно просмотреть в разделе **Уведомления** в меню.

## <a name="troubleshooting"></a>Устранение неполадок

Гибридная рабочая роль Runbook зависит от службы Microsoft Monitoring Agent, которая используется для взаимодействия с учетной записью автоматизации для регистрации рабочей роли, получения заданий runbook и сообщения о состоянии. Если при регистрации рабочей роли произошла ошибка, ознакомьтесь с некоторыми возможными причинами ниже.

1. Гибридная рабочая роль находится за прокси-сервером или брандмауэром.

   Проверьте, имеет ли компьютер исходящий доступ к *.azure-automation.net на порту 443.

2. Компьютер, на котором выполняется гибридная рабочая роль, не соответствует минимальным [требованиям](automation-offering-get-started.md#hybrid-runbook-worker) к оборудованию.

   Прежде чем назначать компьютеры, на которых будет выполняться гибридная рабочая роль Runbook, необходимо выполнить на них соответствующие минимальные требования к оборудованию. Иначе в зависимости от использования ресурсов других фоновых процессов и возникновения конфликтов, вызванных модулями runbook во время выполнения, компьютер становится чрезмерно загруженным. Из-за этого при выполнении задания runbook возникают задержки и простои.

   Убедитесь, что компьютер, предназначенный для выполнения гибридной рабочей роли Runbook, соответствует минимальным требованиям к оборудованию. Если требования выполнены, отследите использование ЦП и памяти, чтобы определить корреляцию между производительностью процессов гибридной рабочей роли Runbook и Windows. Если есть нагрузка на память или ЦП, возможно, необходимо обновить или добавить дополнительные процессоры либо увеличить объем памяти, чтобы устранить ошибку и проблему нехватки ресурсов. Как вариант, выберите другой вычислительный ресурс, который соответствует минимальным требованиям и масштабируется в соответствии с требованиями рабочей нагрузки.

3. Служба Microsoft Monitoring Agent не работает.

   Если не запущена служба Windows Microsoft Monitoring Agent, то гибридная рабочая роль Runbook не может взаимодействовать со службой автоматизации Azure. Проверьте, запущен ли агент, введя в PowerShell команду `get-service healthservice`. Если служба остановлена, введите в PowerShell команду `start-service healthservice`, чтобы запустить эту службу.

4. В журнале событий в папке **Application and Services Logs\Operations Manager** отображается событие 4502 и EventMessage с **Microsoft.EnterpriseManagement.HealthService.AzureAutomation.HybridAgent** со следующим описанием: *Сертификат, представленный службой \<wsid\>.oms.opinsights.azure.com, не был выдан центром сертификации для служб Майкрософт. Обратитесь к администратору сети, чтобы узнать, использует ли он прокси-сервер, перехватывающий связь по протоколам TLS и SSL. Дополнительные сведения об устранении неполадок, связанных с подключением, содержатся в статье базы знаний KB3126513.*
    Это может быть вызвано тем, что прокси-сервер или сетевой брандмауэр блокируют подключение к Microsoft Azure. Проверьте, имеет ли компьютер исходящий доступ к *.azure-automation.net на порту 443.

Журналы сохраняются локально в каждом гибридном компоненте Worker по адресу C:\ProgramData\Microsoft\System Center\Orchestrator\7.2\SMA\Sandboxes. Можно проверить, зарегистрированы ли в журналах событий в папках **Application and Services Logs\Microsoft-SMA\Operations** и **Application and Services Logs\Operations Manager** какие-либо предупреждения или ошибки, которые указывают на проблемы подключения или другие проблемы, связанные с адаптацией роли службы автоматизации Azure, либо на проблемы во время выполнения обычных операций.

## <a name="next-steps"></a>Дополнительная информация

Ознакомьтесь с [запуском модулей runbook в гибридной рабочей роли Runbook](automation-hrw-run-runbooks.md), чтобы узнать, как настроить модули runbook для автоматизации процессов в локальном центре обработки данных или другой облачной среде.
