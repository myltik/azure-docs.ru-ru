---
title: Мониторинг операций, событий и счетчиков для балансировки нагрузки | Документация Майкрософт
description: Узнайте, как включить ведение журналов событий оповещений и проверки работоспособности для балансировщика нагрузки Azure
services: load-balancer
documentationcenter: na
author: KumudD
manager: timlt
tags: azure-resource-manager
ms.assetid: 56656d74-0241-4096-88c8-aa88515d676d
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/25/2017
ms.author: kumud
ms.openlocfilehash: dabf4bcae957559978e731636bb13554f1a68b73
ms.sourcegitcommit: 48ab1b6526ce290316b9da4d18de00c77526a541
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2018
ms.locfileid: "30179061"
---
# <a name="log-analytics-for-azure-load-balancer"></a>Служба анализа журналов для балансировщика нагрузки Azure

>[!NOTE] 
>Azure Load Balancer поддерживает два типа: категории "Базовый" и "Стандартный". В этой статье рассматривается Azure Load Balancer категории "Базовый". См. дополнительные сведения в статье [Обзор Azure Load Balancer уровня "Стандартный" (предварительная версия)](load-balancer-standard-overview.md).

В Azure можно использовать различные виды журналов для управления балансировщиками нагрузки и устранения возникающих в них неполадок. Доступ к некоторым из этих журналов можно получить через портал. Также все журналы можно извлечь из хранилища BLOB-объектов Azure, чтобы просматривать их с помощью таких средств, как Excel и Power BI. В списке ниже приведены дополнительные сведения о различных типах журналов.

* **Журналы аудита.** В [журналах аудита Azure](../monitoring-and-diagnostics/insights-debugging-with-events.md) (прежнее название — операционные журналы) можно просмотреть все операции, отправляемые в ваши подписки Azure, и состояние этих операций. По умолчанию журналы аудита включены, и их можно просмотреть на портале Azure.
* **Журналы событий оповещений.** Эти журналы можно использовать для просмотра оповещений, создаваемых для подсистемы балансировки нагрузки. Данные о состоянии балансировщика нагрузки собираются каждые пять минут. В этом журнале делается запись, только если возникает событие оповещения балансировщика нагрузки.
* **Журналы проверки работоспособности**. Эти журналы можно использовать для просмотра проблем, обнаруженных при проверке работоспособности, включая сведения о числе экземпляров во внутреннем пуле, которые не получают запросы от подсистемы балансировки нагрузки из-за ошибок проверки работоспособности. Эти журналы записываются при изменении состояния в ходе проверки работоспособности.

> [!IMPORTANT]
> Служба Log Analytics в настоящее время работает только для подсистем балансировки нагрузки с выходом в Интернет. Журналы доступны только для ресурсов, развернутых в модели развертывания диспетчера ресурсов. Журналы нельзя использовать для ресурсов в классической модели развертывания. Дополнительные сведения о моделях развертывания см. в статье, посвященной [развертыванию с помощью Resource Manager и классическому развертыванию](../azure-resource-manager/resource-manager-deployment-model.md).

## <a name="enable-logging"></a>Включение ведения журналов

Ведение журналов автоматически включается для каждого ресурса Resource Manager. Чтобы начать сбор соответствующих данных, необходимо включить ведение журналов событий и проверки работоспособности. Вот как можно включить ведение журнала:

Войдите на [портал Azure](http://portal.azure.com). Если у вас еще нет балансировщика нагрузки, [создайте балансировщик нагрузки](load-balancer-get-started-internet-arm-ps.md) перед продолжением.

1. На портале нажмите кнопку **Обзор**.
2. Выберите элемент **Подсистемы балансировки нагрузки**.

    ![портал — балансировщик нагрузки](./media/load-balancer-monitor-log/load-balancer-browse.png)

3. Выберите существующую подсистему балансировки нагрузки, затем щелкните **Все параметры**.
4. В правой части диалогового окна, под названием подсистемы балансировки нагрузки, прокрутите до элемента **Мониторинг** и щелкните **Диагностика**.

    ![портал — балансировщик нагрузки — параметры](./media/load-balancer-monitor-log/load-balancer-settings.png)

5. На панели **Диагностика** в разделе **Состояние** щелкните **Вкл**.
6. Щелкните элемент **Учетная запись хранения**.
7. В разделе **Журналы** выберите существующую учетную запись хранения или создайте новую. С помощью ползунка определите, сколько дней данные о событиях будут храниться в журналах событий. 
8. Выберите команду **Сохранить**.

    ![Портал — журналы диагностики](./media/load-balancer-monitor-log/load-balancer-diagnostics.png)

> [!NOTE]
> Для журналов аудита отдельная учетная запись хранения не требуется. За использование хранилища для журналов событий и проверки работоспособности взимается плата.

## <a name="audit-log"></a>Журнал аудита

Журнал аудита создается по умолчанию. Журналы хранятся в течение 90 дней в хранилище журналов событий Azure. Дополнительные сведения об этих журналах см. в статье [Просмотр журналов событий и аудита](../monitoring-and-diagnostics/insights-debugging-with-events.md).

## <a name="alert-event-log"></a>Журнал событий оповещений

Этот журнал создается только в том случае, если он включен для конкретной подсистемы балансировки нагрузки. События регистрируются в формате JSON и хранятся в учетной записи хранения, указанной при включении ведения журнала. Ниже приведен пример события.

```json
{
    "time": "2016-01-26T10:37:46.6024215Z",
    "systemId": "32077926-b9c4-42fb-94c1-762e528b5b27",
    "category": "LoadBalancerAlertEvent",
    "resourceId": "/SUBSCRIPTIONS/XXXXXXXXXXXXXXXXX-XXXX-XXXX-XXXXXXXXX/RESOURCEGROUPS/RG7/PROVIDERS/MICROSOFT.NETWORK/LOADBALANCERS/WWEBLB",
    "operationName": "LoadBalancerProbeHealthStatus",
    "properties": {
        "eventName": "Resource Limits Hit",
        "eventDescription": "Ports exhausted",
        "eventProperties": {
            "public ip address": "40.117.227.32"
        }
    }
}
```

В выходных данных JSON отображается свойство *eventname* , описывающее причину создания оповещения балансировщиком нагрузки. В этом случае оповещение было создано из-за нехватки порта TCP, вызванной ограничениями преобразования исходных сетевых адресов (SNAT).

## <a name="health-probe-log"></a>Журнал проверки работоспособности

Этот журнал создается только в том случае, если он включен для конкретного балансировщика нагрузки, как описано выше. Данные хранятся в учетной записи хранения, указанной при включении ведения журнала. Создается контейнер с именем insights-logs-loadbalancerprobehealthstatus, и в журнал записываются следующие данные.

```json
{
    "records":[
    {
        "time": "2016-01-26T10:37:46.6024215Z",
        "systemId": "32077926-b9c4-42fb-94c1-762e528b5b27",
        "category": "LoadBalancerProbeHealthStatus",
        "resourceId": "/SUBSCRIPTIONS/XXXXXXXXXXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXX/RESOURCEGROUPS/RG7/PROVIDERS/MICROSOFT.NETWORK/LOADBALANCERS/WWEBLB",
        "operationName": "LoadBalancerProbeHealthStatus",
        "properties": {
            "publicIpAddress": "40.83.190.158",
            "port": "81",
            "totalDipCount": 2,
            "dipDownCount": 1,
            "healthPercentage": 50.000000
        }
    },
    {
        "time": "2016-01-26T10:37:46.6024215Z",
        "systemId": "32077926-b9c4-42fb-94c1-762e528b5b27",
        "category": "LoadBalancerProbeHealthStatus",
        "resourceId": "/SUBSCRIPTIONS/XXXXXXXXXXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXX/RESOURCEGROUPS/RG7/PROVIDERS/MICROSOFT.NETWORK/LOADBALANCERS/WWEBLB",
        "operationName": "LoadBalancerProbeHealthStatus",
        "properties": {
            "publicIpAddress": "40.83.190.158",
            "port": "81",
            "totalDipCount": 2,
            "dipDownCount": 0,
            "healthPercentage": 100.000000
        }
    }]
}
```

В выходных данных JSON в поле свойств отображаются основные сведения о состоянии проверки работоспособности. Свойство *DipDownCount* показывает общее количество экземпляров в серверной части, которые не получают сетевой трафик из-за неудачных ответов проверки.

## <a name="view-and-analyze-the-audit-log"></a>Просмотр и анализ журнала аудита

Данные журнала аудита можно просматривать и анализировать с помощью любого из следующих методов.

* **Средства Azure.** Информацию из журналов аудита можно получать с помощью Azure PowerShell, интерфейса командной строки (CLI) Azure, интерфейса REST API Azure или портала предварительной версии Azure. Пошаговые инструкции для каждого метода подробно описаны в статье [Операции аудита с помощью диспетчера ресурсов](../azure-resource-manager/resource-group-audit.md) .
* **Power BI.** Если у вас еще нет учетной записи [Power BI](https://powerbi.microsoft.com/pricing), вы можете использовать бесплатную пробную версию. Используя [пакет содержимого "Журналы аудита Azure" для Power BI](https://powerbi.microsoft.com/documentation/powerbi-content-pack-azure-audit-logs), можно анализировать данные с помощью предварительно настроенных панелей мониторинга или дополнительно настроить представление данных в зависимости от своих потребностей.

## <a name="view-and-analyze-the-health-probe-and-event-log"></a>Просмотр и анализ журналов событий и проверки работоспособности

Вам потребуется подключиться к учетной записи хранения и извлечь записи журнала JSON для журналов событий и проверки работоспособности. После загрузки JSON-файлов их можно преобразовать в формат CSV и просматривать в Excel, PowerBI или другом средстве визуализации данных.

> [!TIP]
> Если вы знакомы с Visual Studio и основными понятиями изменения значений констант и переменных в C#, можно использовать [инструменты преобразования журналов](https://github.com/Azure-Samples/networking-dotnet-log-converter), доступные на сайте GitHub.

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Визуализация журналов аудита Azure с помощью Power BI](http://blogs.msdn.com/b/powerbi/archive/2015/09/30/monitor-azure-audit-logs-with-power-bi.aspx) .
* [Просмотр и анализ журналов аудита Azure с помощью Power BI и других средств](https://azure.microsoft.com/blog/analyze-azure-audit-logs-in-powerbi-more/) .

## <a name="next-steps"></a>Дополнительная информация

[Проверки балансировщика нагрузки](load-balancer-custom-probe-overview.md)
