---
title: Диагностика Azure Load Balancer уровня "Стандартный" | Документация Майкрософт
description: Использование доступных метрик и информации о работоспособности для диагностики Azure Load Balancer уровня "Стандартный".
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/21/2018
ms.author: Kumud
ms.openlocfilehash: 9d5d596254f673b86650e8d9754dacdb70be0666
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32179800"
---
# <a name="metrics-and-health-diagnostics-for-standard-load-balancer"></a>Диагностика Load Balancer уровня "Стандартный" на основе метрик и сведений о работоспособности

Azure Load Balancer уровня "Стандартный" предоставляет следующие возможности диагностики для ресурсов:
* **Многомерные метрики.** Предоставляются новые возможности многомерной диагностики конфигураций общедоступной и внутренней подсистем балансировки нагрузки. Можно отслеживать ресурсы подсистемы балансировки нагрузки, управлять ими и устранять связанные с ними неполадки.

* **Служба "Работоспособность ресурсов".** На странице Load Balancer на портале Azure и странице службы работоспособности ресурсов Azure (в разделе "Мониторинг") представлен раздел "Работоспособность ресурсов" для конфигурации общедоступной подсистемы балансировки нагрузки в службе Load Balancer уровня "Стандартный".

Эта статья содержит краткий обзор этих возможностей и способов их использования для Load Balancer уровня "Стандартный".

## <a name = "MultiDimensionalMetrics"></a>Многомерные метрики

Azure Load Balancer предоставляет новые многомерные метрики посредством решения "Метрики Azure" (предварительная версия) на портале Azure и позволяет получить сведения для диагностики ресурсов подсистемы балансировки нагрузки в режиме реального времени. 

Различные конфигурации Load Balancer уровня "Стандартный" предоставляют следующие метрики:

| Метрика | Тип ресурса | ОПИСАНИЕ | Рекомендуемая статистическая обработка |
| --- | --- | --- | --- |
| Доступность виртуального IP-адреса (доступность пути к данным) | Общедоступная подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" непрерывно использует путь к данным из региона к внешнему интерфейсу подсистемы балансировки нагрузки, а затем в стек SDN, поддерживающий виртуальную машину. Пока остаются работоспособные экземпляры, измерение выполняется по тому же пути, что и трафик приложения с балансировкой нагрузки. Проверяется также путь к данным, который используют ваши клиенты. Измерение является невидимым для приложения и не влияет на работоспособность других операций.| Средняя |
| Доступность выделенного IP-адреса (состояние пробы работоспособности) |  Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" использует распределенную службу проверки работоспособности, которая контролирует состояние конечной точки приложения в соответствии с параметрами конфигурации. Эта метрика обеспечивает агрегированное или отфильтрованное представление для каждой конечной точки экземпляра в пуле подсистемы балансировки нагрузки. Вы можете посмотреть, как в службе Load Balancer исследуется работоспособность вашего приложения в соответствии с заданными настройками проверки. |  Средняя |
| Пакеты SYN (синхронизация) |  Общедоступная подсистема балансировки нагрузки | Load Balancer уровня "Стандартный" не прерывает TCP-подключения и не взаимодействует с потоками пакетов TCP и UDP. Потоки и их подтверждения всегда происходят между источником и экземпляром виртуальной машины. Чтобы оптимизировать устранение неполадок для всех сценариев протокола TCP, вы можете использовать счетчики пакетов SYN. С их помощью можно определить число попыток подключения TCP. Эта метрика указывает количество принятых пакетов TCP SYN.| Средняя |
| Подключения SNAT |  Общедоступная подсистема балансировки нагрузки |Load Balancer уровня "Стандартный" передает число замаскированных исходящих потоков на общедоступный интерфейсный IP-адрес. Количество портов преобразования исходных сетевых адресов (SNAT) ограничено. Эта метрика может дать представление о том, насколько сильно ваше приложение зависит от SNAT для исходящих потоков. Выводятся данные счетчиков для успешного и неудачного выполнения исходящих потоков SNAT. Эти данные помогают устранять неполадки и определять работоспособность исходящих потоков.| Средняя |
| Счетчики байтов |  Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" передает количество данных, обработанных каждым внешним интерфейсом.| Средняя |
| Счетчики пакетов |  Общедоступная и внутренняя подсистемы балансировки нагрузки | Load Balancer уровня "Стандартный" передает количество пакетов, обработанных каждым внешним интерфейсом.| Средняя |

### <a name="view-your-load-balancer-metrics-in-the-azure-portal"></a>Просмотр метрик подсистемы балансировки нагрузки на портале Azure

На странице решения "Метрики" (предварительная версия) на портале Azure предоставляются метрики подсистемы балансировки нагрузки. Эти данные доступны на странице ресурсов подсистемы балансировки нагрузки для конкретного ресурса и на странице Azure Monitor. 

Чтобы просмотреть метрики для ресурсов Load Balancer уровня "Стандартный", сделайте следующее:
1. Перейдите к странице решения "Метрики" (предварительная версия) и выполните одно из следующих действий:
   * На странице ресурсов подсистемы балансировки нагрузки выберите тип метрики в раскрывающемся списке.
   * На странице Azure Monitor выберите ресурс подсистемы балансировки нагрузки.
2. Выберите соответствующий тип агрегирования.
3. При необходимости настройте требуемые фильтрацию и группирование.

![Предварительная версия решения "Метрики" для Load Balancer уровня "Стандартный"](./media/load-balancer-standard-diagnostics/LBMetrics1.png)

*Рисунок. Метрики доступности выделенного IP-адреса и состояния пробы работоспособности в Load Balancer уровня "Стандартный"*

### <a name="retrieve-multi-dimensional-metrics-programmatically-via-apis"></a>Получение многомерных метрик через API-интерфейсы программным образом

Инструкции по получению определений и значений многомерных метрик с помощью API см. в статье [Azure Monitoring REST API walkthrough](https://docs.microsoft.com/azure/monitoring-and-diagnostics/monitoring-rest-api-walkthrough#retrieve-metric-definitions-multi-dimensional-api) (Пошаговое руководство по REST API Azure Monitor).

### <a name = "DiagnosticScenarios"></a>Распространенные сценарии диагностики и рекомендуемые представления

#### <a name="is-the-data-path-up-and-available-for-my-load-balancer-vip"></a>Доступен ли путь к данным для виртуального IP-адреса подсистемы балансировки нагрузки?

Метрика доступности виртуального IP-адреса предоставляет сведения о работоспособности пути к данным из региона к вычислительному узлу, где размещены виртуальные машины. Эта метрика отражает работоспособность инфраструктуры Azure. Используя эту метрику, можно:
- отслеживать внешнюю доступность вашей службы;
- получить более подробную информацию о том, нормально ли функционирует платформа, на которой развернута служба, и узнать состояние работоспособности гостевой ОС или экземпляра приложения;
- определить, к чему относится событие: к службе или к базовой плоскости данных. Не путайте эту метрику с состоянием пробы работоспособности (метрика доступности выделенного IP-адреса).

Чтобы получить метрику доступности виртуальных IP-адресов для ресурсов Load Balancer уровня "Стандартный", сделайте следующее.
1. Убедитесь, что выбран правильный ресурс подсистемы балансировки нагрузки. 
2. В раскрывающемся списке **Метрика** выберите **VIP Availability** (Доступность виртуального IP-адреса). 
3. В раскрывающемся списке **Агрегирование** выберите **Среднее**. 
4. Кроме того, добавьте фильтр по виртуальному IP-адресу или порту виртуального IP-адреса в качестве измерения с необходимым внешним IP-адресом или портом, а затем сгруппируйте их по выбранному измерению.

![Проверка виртуального IP-адреса](./media/load-balancer-standard-diagnostics/LBMetrics-VIPProbing.png)

*Рисунок. Сведения о проверке виртуального IP-адреса Load Balancer*

Метрика создается с помощью активного внутриполосного измерения. Служба проверки формирует трафик для измерения в пределах региона. Служба активируется сразу после создания развертывания с общедоступным интерфейсом и продолжает работу, пока этот интерфейс не будет удален. 

>[!NOTE]
>Сейчас внутренние интерфейсы не поддерживаются. 

Периодически создается пакет, соответствующий внешнему интерфейсу и правилу развертывания. Он направляет трафик в регионе от источника к узлу, где расположена виртуальная машина в серверном пуле. Инфраструктура подсистемы балансировки нагрузки выполняет те же операции балансировки нагрузки и преобразования, что и для остального трафика. Эта проба находится в сети внутри конечной точки с балансировкой нагрузки. После того как проба поступит на узел вычислений, где находится работоспособная виртуальная машина в серверном пуле, узел вычислений генерирует ответ для службы проверки работоспособности. Ваша виртуальная машина не видит этот трафик.

Сбой доступности виртуального IP-адреса возникает по следующим причинам:
- в серверном пуле вашего развертывания не осталось исправных виртуальных машин; 
- произошел сбой инфраструктуры.

В целях диагностики можно использовать [метрику доступности виртуального IP-адреса и сведения о состоянии пробы работоспособности](#vipavailabilityandhealthprobes).

Для большинства сценариев используйте тип статистического вычисления **Среднее**.

#### <a name="are-the-back-end-instances-for-my-vip-responding-to-probes"></a>Отвечают ли на пробы серверные экземпляры для виртуального IP-адреса?

Метрика состояния для пробы работоспособности предоставляет сведения о работоспособности развертывания приложения. Параметры задаются при настройке проверки работоспособности для подсистемы балансировки нагрузки. Подсистема балансировки нагрузки использует состояние пробы работоспособности, чтобы определить, куда отправлять новые потоки. Пробы работоспособности исходят из адреса инфраструктуры Azure и видны в гостевой ОС виртуальной машины.

Чтобы получить сведения о доступности выделенного IP-адреса для ресурсов Load Balancer уровня "Стандартный", сделайте следующее:
1. Выберите метрику **DIP Availability** (Доступность выделенного IP-адреса) с типом агрегирования **Среднее**. 
2. Примените фильтр для необходимого виртуального IP-адреса или порта виртуального IP-адреса (или для обоих).

![Доступность выделенного IP-адреса (DIP)](./media/load-balancer-standard-diagnostics/LBMetrics-DIPAvailability.png)

*Рисунок. Доступность виртуального IP-адреса Load Balancer*

Пробы работоспособности завершаются ошибками по следующим причинам:
- Вы настроили проверку работоспособности для порта, который не ожидает передачи данных, не отвечает или же использует неправильный протокол. Если ваша служба использует правила прямого ответа от сервера (DSR или плавающий IP-адрес), убедитесь в том, что она ожидает передачи данных по IP-адресу IP-конфигурации сети сетевого интерфейса, а не только через интерфейс замыкания на себя, который настроен с внешним IP-адресом.
- Ваша проверка не разрешена группой безопасности сети, брандмауэром гостевой ОС виртуальной машины или фильтрами прикладного уровня.

Для большинства сценариев используйте тип статистического вычисления **Среднее**.

#### <a name="how-do-i-check-my-outbound-connection-statistics"></a>Как проверить статистику исходящего подключения? 

Метрика подключений SNAT предоставляет сведения о числе успешных и неудачных подключений для [исходящих потоков](https://aka.ms/lboutbound).

Число подключений со сбоями, превышающее нуль, указывает на нехватку портов SNAT. Нужно продолжить исследование, чтобы определить, что может вызвать эти сбои. При нехватке портов SNAT нельзя установить [исходящие потоки](https://aka.ms/lboutbound). Просмотрите статью об исходящих подключениях, чтобы составить представление о сценариях и механизмах работы, а также узнать, как уменьшить риск и избежать нехватки портов SNAT. 

Чтобы получить статистику по подключениям SNAT, сделайте следующее:
1. Выберите тип метрики **SNAT Connections** (Подключения SNAT) и тип агрегирования **Сумма**. 
2. Сгруппируйте подключения SNAT по **состоянию** (успешные и неудачные). Подключения в каждом состоянии будут представлены разными линиями. 

![Подключение SNAT](./media/load-balancer-standard-diagnostics/LBMetrics-SNATConnection.png)

*Рисунок. Количество подключений SNAT для Load Balancer*


#### <a name="how-do-i-check-inboundoutbound-connection-attempts-for-my-service"></a>Как проверить попытки входящих и исходящих подключений для службы?

Метрика пакетов SYN предоставляет сведения о числе принятых или отправленных пакетов TCP SYN (для [исходящих потоков](https://aka.ms/lboutbound)), связанных с определенным внешним интерфейсом. Эта метрика позволяет проанализировать попытки подключения TCP к вашей службе.

Для большинства сценариев используйте тип статистической обработки **Всего**.

![Подключение SYN](./media/load-balancer-standard-diagnostics/LBMetrics-SYNCount.png)

*Рисунок. Количество подключений SYN для Load Balancer*


#### <a name="how-do-i-check-my-network-bandwidth-consumption"></a>Как проверить потребление пропускной способности сети? 

Метрика счетчиков байтов и пакетов предоставляет сведения о числе байтов и пакетов, отправленных или полученных вашей службой для каждого внешнего интерфейса.

Для большинства сценариев используйте тип статистической обработки **Всего**.

Чтобы получить статистику количества байтов или пакетов, сделайте следующее:
1. Выберите тип метрики **Bytes Count** (Количество байтов) и (или) **Packet Count** (Количество пакетов), а также тип агрегирования **Среднее**. 
2. Выполните одно из приведенных ниже действий.
   * Примените фильтр к определенному интерфейсному IP-адресу, интерфейсному порту, IP-адресу серверной части или порту серверной части.
   * Получите общую статистику для ресурсов подсистемы балансировки нагрузки без какой-либо фильтрации.

![Количество байтов](./media/load-balancer-standard-diagnostics/LBMetrics-ByteCount.png)

*Рисунок. Количество байтов Load Balancer*

#### <a name = "vipavailabilityandhealthprobes"></a>Как выполнить диагностику развертывания подсистемы балансировки нагрузки?

Сочетание метрик доступности виртуального IP-адреса и пробы работоспособности на одной диаграмме позволяет определить причину и решение проблемы. Благодаря этой информации вы можете удостовериться в том, что Azure работает правильно. Кроме того, с помощью этих сведений можно достоверно определить, что является первопричиной проблемы: конфигурация или приложение.

Вы можете использовать метрики пробы работоспособности, чтобы понять, как Azure рассматривает работоспособность вашего развертывания в соответствии с предоставленной вами конфигурацией. Просмотр проб работоспособности — отличный первый шаг при мониторинге или определении причины.

Вы можете перейти к следующему этапу и использовать метрики доступности виртуального IP-адреса, чтобы получить представление о том, как в Azure исследуется работоспособность базовой плоскости данных, отвечающей за конкретное развертывание. Если вы объедините обе метрики, можно будет определить, где возникла ошибка, как показано в этом примере:

![Диагностика по метрике виртуального IP-адреса](./media/load-balancer-standard-diagnostics/LBMetrics-DIPnVIPAvailability.png)

*Рисунок. Объединение метрик доступности выделенного и виртуального IP-адресов*

На диаграмме представлена следующая информация:
- Сама инфраструктура была работоспособной, инфраструктура, в которой размещались виртуальные машины, была доступна, и на сервере было размещено несколько виртуальных машин. Об этом свидетельствует синяя линия доступности виртуального IP-адреса, которая составляет 100 %. 
- Но состояние пробы работоспособности (доступность выделенного IP-адреса) в начале диаграммы соответствует 0 %. На это указывает оранжевая линия. Кругом зеленого цвета отмечен период, когда система стала работоспособной (выделенный IP-адрес стал доступным). В этот момент развертывание клиента смогло принять новые потоки.

Благодаря диаграмме клиенты могут самостоятельно устранять проблемы с развертыванием без необходимости обращаться в службу поддержки или угадывать, были ли другие проблемы. При проверках работоспособности служба была недоступна по причине сбоев из-за неправильной конфигурации или неисправности приложения.

### <a name = "Limitations"></a>Ограничения

Сейчас метрика доступности виртуального IP-адреса поддерживается только для общедоступных внешних интерфейсов.

## <a name = "ResourceHealth"></a>Состояние работоспособности ресурсов

Состояние работоспособности ресурсов Load Balancer уровня "Стандартный" можно узнать на странице **Работоспособность ресурсов** в разделе **Мониторинг > Работоспособность служб**.

>[!NOTE]
>Сейчас возможность узнать состояние работоспособности ресурсов поддерживается только в общедоступной конфигурации Load Balancer уровня "Стандартный". Ресурсы внутренней подсистемы балансировки нагрузки или SKU уровня "Базовый" ресурсов Load Balancer не предоставляют сведения о работоспособности ресурсов.

Чтобы просмотреть работоспособность ресурсов общедоступной службы Load Balancer уровня "Стандартный", сделайте следующее:
1. Выберите **Мониторинг** > **Работоспособность службы**.

   ![Страница мониторинга](./media/load-balancer-standard-diagnostics/LBHealth1.png)

   *Рисунок. Ссылка "Работоспособность службы" в Azure Monitor*

2. Выберите **Работоспособность ресурсов** и убедитесь, что выбран **идентификатор подписки**, а **для типа ресурса установлено значение Load Balancer**.

   ![Состояние работоспособности ресурсов](./media/load-balancer-standard-diagnostics/LBHealth3.png)

   *Рисунок. Выбор ресурса для представления работоспособности*

3. В списке щелкните ресурс Load Balancer, чтобы просмотреть историю его состояния работоспособности.

    ![Состояние работоспособности Load Balancer](./media/load-balancer-standard-diagnostics/LBHealth4.png)

   *Рисунок. Представление работоспособности ресурса Load Balancer*
 
В следующей таблице перечислены различные состояния работоспособности ресурсов и их описания: 

| Состояние работоспособности ресурсов | ОПИСАНИЕ |
| --- | --- |
| Доступна | Ресурс общедоступной подсистемы балансировки нагрузки уровня "Стандартный" работоспособен и доступен. |
| Рекомендации недоступны | Ресурс общедоступной подсистемы балансировки нагрузки уровня "Стандартный" неработоспособен. Проведите диагностику работоспособности, последовательно выбрав **Azure Monitor** > **Метрики**<br>(состояние *Недоступно* также может означать, что ресурс не подключен к общедоступной подсистеме балансировки нагрузки уровня "Стандартный"). |
| Unknown | Состояние работоспособности ресурсов для общедоступной подсистемы балансировки нагрузки уровня "Стандартный" еще не обновлено<br>(состояние *Неизвестно* также может означать, что ресурс не подключен к общедоступной подсистеме балансировки нагрузки уровня "Стандартный").  |

## <a name="next-steps"></a>Дополнительная информация

- Узнайте больше об [Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).
- Узнайте больше об [исходящих подключениях подсистемы балансировки нагрузки](https://aka.ms/lboutbound).


