---
title: Обзор Azure Load Balancer | Документация Майкрософт
description: Обзор функций балансировщика нагрузки Azure, его архитектуры и реализации. Узнайте, как работает балансировщик нагрузки, и применяйте его в облаке.
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
ms.assetid: ''
ms.service: load-balancer
Customer intent: As an IT administrator, I want to learn more about the Azure Load Balancer service and what I can use it for.
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/03/2018
ms.author: kumud
ms.custom: mvc
ms.openlocfilehash: 8a3eedb5a3d96eedd1a64d85afdb58f8961df272
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
ms.locfileid: "33775219"
---
# <a name="what-is-azure-load-balancer"></a>Что такое Azure Load Balancer

C помощью Azure Load Balancer можно масштабировать приложения и обеспечивать высокий уровень доступности служб. Load Balancer поддерживает входящие и исходящие сценарии, обеспечивает низкую задержку и высокую пропускную способность, а также увеличение масштаба до миллионов потоков для всех приложений, которые используют протоколы TCP и UDP.  

Load Balancer распределяет новые входящие потоки, поступающие на внешний интерфейс подсистемы балансировки нагрузки, в экземпляры серверных пулов в соответствии с правилами и проверками работоспособности. 

Кроме того, общедоступный Load Balancer может предоставить исходящие подключения для виртуальных машин в рамках виртуальной сети путем преобразования их частных IP-адресов в общедоступные IP-адреса.

Доступно два типа SKU Azure Load Balancer: уровня "Базовый" и "Стандартный". В них есть различия по масштабу, возможностям и цене. Любой сценарий, который можно выполнить в рамках Load Balancer уровня "Базовый", также можно создать с помощью Load Balancer уровня "Стандартный", хотя подход может несколько отличаться. По мере получения дополнительных сведений о Load Balancer, необходимо ознакомиться с основами и различиями в SKU.

## <a name="why-use-load-balancer"></a>Преимущества Load Balancer 

Azure Load Balancer можно использовать для следующих целей:

* Балансировка нагрузки входящего интернет-трафика виртуальных машин. Такая конфигурация называется [общедоступным балансировщиком нагрузки](#publicloadbalancer).
* Балансировка нагрузки трафика между виртуальными машинами внутри виртуальной сети. Кроме того, можно подключиться к внешнему интерфейсу Load Balancer из локальной сети в гибридном сценарии. В обоих сценариях используется конфигурация, известная как [внутренняя подсистема балансировки нагрузки](#internalloadbalancer).
* Перенаправление трафика на определенный порт в определенных виртуальных машинах с правилами преобразования входящих сетевых адресов (NAT).
* Обеспечение [исходящего подключения](load-balancer-outbound-connections.md) для виртуальных машин в виртуальной сети путем использования общедоступной подсистемы балансировки нагрузки.


>[!NOTE]
> Azure предоставляет набор полностью управляемых решений балансировки нагрузки для пользовательских сценариев. Если вам необходима обработка подключений по протоколу TLS (разгрузка SSL) или обработка прикладного уровня HTTP- или HTTPS-запросов, ознакомьтесь со статьей [Обзор шлюза приложений](../application-gateway/application-gateway-introduction.md). Если вам нужна глобальная балансировка нагрузки DNS, ознакомьтесь со статьей о [диспетчере трафика](../traffic-manager/traffic-manager-overview.md). В комплексных сценариях может быть целесообразно объединить эти решения.

## <a name="what-are-load-balancer-resources"></a>Ресурсы подсистемы балансировки нагрузки

Ресурс подсистемы балансировки нагрузки может существовать как общедоступная или внутренняя подсистема балансировки нагрузки. Функции ресурса подсистемы балансировки нагрузки выражаются в виде внешнего интерфейса, правила, проверки работоспособности и определения внутреннего пула. Поместите виртуальные машины в серверный пул, указав серверный пул из виртуальной машины.

Ресурсы подсистемы балансировки нагрузки представляют собой объекты, в которых можно выразить, как служба Azure должна запрограммировать свою мультитенантную инфраструктуру, чтобы получить сценарий, который необходимо создать. Между ресурсами подсистемы балансировки нагрузки и фактической инфраструктурой нет прямой связи. Создание подсистемы балансировки нагрузки не приводит к созданию экземпляра, а емкость доступна всегда. 

## <a name="fundamental-load-balancer-features"></a>Основные функции Load Balancer

Load Balancer предоставляет следующие основные возможности для приложений TCP и UDP:

* **Балансировка нагрузки**

    С помощью Azure Load Balancer можно создать правило балансировки нагрузки, чтобы распределять входящий трафик внешнего интерфейса между экземплярами внутреннего пула. Load Balancer использует алгоритм на основе хэша для распределения входящих потоков и соответствующим образом перезапишет заголовки потоков экземпляров внутреннего пула. Сервер может получать новые потоки, когда в результате проверки работоспособности получается работоспособная серверная конечная точка.
    
    По умолчанию для сопоставления трафика с доступными серверами Load Balancer использует хэш с 5 кортежами (исходный IP-адрес, порт источника, IP-адрес назначения, порт назначения и тип протокола). Вы можете создать сходство с определенным исходным IP-адресом путем включения 2- или 3-кортежного хэша для данного правила. Все пакеты из одного потока пакетов поступают на один и тот же экземпляр за внешним интерфейсом с балансировкой нагрузки. Когда клиент инициирует новый поток из того же исходного IP-адреса, исходный порт изменяется. В результате использование 5 кортежей может привести к тому, что трафик перейдет к другой конечной точке сервера.

    Дополнительные сведения см. в статье [Настройка режима распределения для Azure Load Balancer](load-balancer-distribution-mode.md). На представленном ниже рисунке показано распределение на основе хэша.

    ![Распространение на основе хэша](./media/load-balancer-overview/load-balancer-distribution.png)

    *Рис. Распределение на основе хэша*

* **Перенаправление портов**

    С помощью Load Balancer можно создать правило преобразования сетевых адресов для входящих подключений для перенаправления трафика из определенного порта определенного IP-адреса внешнего интерфейса на определенный порт определенного серверного экземпляра в виртуальной сети. Кроме того, это также достигается за счет того же распространения на основе хэша, что и при балансировке нагрузки. Распространенными сценариями этой возможности являются сеансы протокола удаленного рабочего стола или Secure Shell для отдельных экземпляров виртуальной машины в виртуальной сети Azure. Несколько внутренних конечных точек можно сопоставить с различными портами в том же интерфейсном IP-адресе. Их можно использовать для удаленного администрирования виртуальных машин через Интернет без необходимости дополнительных переходов.

* **Независимые и прозрачные приложения**

    Load Balancer напрямую не взаимодействует с TCP, UDP или со слоем приложения, поэтому можно реализовать поддержку любого сценария приложения.  Load Balancer не завершает и не создает потоки, не взаимодействует с полезными данными потока, не предоставляет функции шлюза на уровне приложения, а подтверждения протоколов всегда происходят непосредственно между клиентом и экземпляром внутреннего пула.  Ответом на входящий поток всегда является ответ от виртуальной машины.  Когда поток поступает в виртуальную машину, исходный IP-адрес источника также сохраняется.  Рассмотрим несколько примеров, которые более подробно иллюстрируют прозрачность:
    - На каждый запрос конечной точки поступает ответ только от виртуальной машины.  Например, подтверждение TCP всегда возникает между клиентом и выбранной серверной виртуальной машиной.  Ответ на запрос к внешнему интерфейсу — это ответ, созданный серверной виртуальной машиной. При успешной проверке связи с внешним интерфейсом вы проверяете сквозное соединение по крайней мере с одной серверной виртуальной машиной.
    - Полезные данные приложений прозрачны для Load Balancer, и поддерживается любое приложение UDP или TCP. Для рабочих нагрузок, которые требуют обработку полезных данных на уровне приложения (например, синтаксический анализ URL-адресов HTTP) для HTTP-запроса, следует использовать подсистему балансировки нагрузки уровня 7, например, [шлюз приложений](https://azure.microsoft.com/en-us/services/application-gateway).
    - Так как Load Balancer не зависит от полезных данных TCP и разгрузка TLS ("SSL") не предоставляется, вы можете создать комплексные зашифрованные сценарии, в которых используется Load Balancer, и обеспечить увеличение масштаба приложений TLS путем завершения подключений TLS на виртуальной машине.  Например, емкости ключей в сеансах TLS ограничиваются только типом и числом виртуальных машин, добавленных в серверный пул.  Если требуется выполнить разгрузку SSL, обработку на уровне приложения или делегировать управление сертификатами Azure, следует использовать подсистему балансировки нагрузки уровня 7 Azure в виде [шлюза приложений](https://azure.microsoft.com/en-us/services/application-gateway).
        

* **Автоматическая перенастройка**

    Load Balancer мгновенно перенастраивает сам себя при горизонтальном и вертикальном масштабировании экземпляров. Добавление или удаление виртуальных машин из серверного пула перенастраивает подсистему балансировки нагрузки без дополнительных операций в ресурсе подсистемы балансировки нагрузки.

* **Проверки работоспособности**

     Load Balancer использует заданные проверки работоспособности, чтобы определить работоспособность экземпляров в серверном пуле. Если проверка не отвечает, балансировщик нагрузки Azure прекращает отправлять новое подключение неработоспособным экземплярам. Имеющиеся подключения не затрагиваются и будут работать, пока приложение не завершит работу потока, не истечет время ожидания перед переходом в режим простоя или работа виртуальной машины не завершится.

    Существует три типа проверки:

    - **Пользовательская проверка HTTP**. Эту проверку можно использовать для создания собственной настраиваемой логики для определения работоспособности экземпляра серверного пула. Подсистема балансировки нагрузки по умолчанию регулярно проверяет конечную точку каждые 15 секунд. Экземпляр считается работоспособным, если он возвращает ответ с кодом HTTP 200 за определенное время ожидания (по умолчанию 31 секунда). Все состояния, отличающиеся от HTTP 200, приведут к сбою проверки работоспособности. Эта проверка также полезна для реализации собственной логики удаления экземпляров из ротации подсистемы балансировки нагрузки. Например, можно настроить экземпляр для возвращения состояния, отличного от 200, если загрузка ЦП экземпляра превышает 90 %.  Эта проверка переопределяет проверку гостевого агента по умолчанию.

    - **Пользовательская проверка TCP.** Проверка зависит от успешности установки сеанса TCP к определенному порту проверки. Пока существует определенный слушатель на виртуальной машине, проверка работоспособности будет выполняться успешно. Если в соединении отказано, проверка работоспособности завершится с ошибкой. Эта проверка переопределяет проверку гостевого агента по умолчанию.

    - **Проверка гостевого агента (только на виртуальных машинах PaaS).** Подсистема балансировки нагрузки также может использовать гостевой агент внутри виртуальной машины. Затем она ожидает передачу данных и передает ответ HTTP с кодом 200 (ОК) только в том случае, если экземпляр находится в состоянии готовности. Если агент не отправляет ответ "HTTP 200 (OK)", то балансировщик нагрузки отмечает экземпляр как неработоспособный и перестает отправлять ему трафик. Подсистема балансировки нагрузки продолжает попытку связаться с экземпляром. Если гостевой агент отправляет ответ HTTP с кодом 200 (ОК), подсистема балансировки нагрузки снова начинает отправлять трафик к этому экземпляру. Проверка работоспособности гостевого агента является последним средством, и ее не рекомендуется выполнять, когда возможна конфигурация пользовательских проверок HTTP или TCP. 
    
* **Исходящие подключения (SNAT)**.

    Все исходящие потоки из частных IP-адресов в виртуальной сети к общедоступным IP-адресам в Интернете можно преобразовать во внешние IP-адреса Load Balancer. Если общедоступный внешний интерфейс привязан к серверной виртуальной машине с помощью правила балансировки нагрузки, Azure настраивает автоматическое преобразование исходящих подключений в общедоступный интерфейсный IP-адрес.

    * Упрощение обновления и аварийного восстановления служб, так как внешний интерфейс можно динамически сопоставить с другим экземпляром службы.
    * Упрощение управления списком управления доступом (ACL). С точки зрения интерфейсных IP-адресов списки управления доступом не меняются при масштабировании или повторном развертывании служб.  Преобразование исходящих подключений для получения меньшего числа IP-адресов, чем количество компьютеров, может упростить ведение списка разрешений.

    Дополнительные сведения см. в статье [об исходящих подключениях](load-balancer-outbound-connections.md).

Load Balancer уровня "Стандартный" имеет дополнительные возможности, связанные со SKU, которые не относятся к этим принципам. Ознакомьтесь со сведениями, приведенными в остальной части этой статьи.

## <a name="skus"></a>Сравнение SKU Load Balancer

Load Balancer поддерживает SKU уровня "Базовый" и "Стандартный", которые отличаются в возможностях масштабирования, функциях и ценах. Любой сценарий, который можно выполнить в рамках Load Balancer уровня "Базовый", также можно создать с помощью Load Balancer уровня "Стандартный". На самом деле API обоих SKU аналогичны и вызываются через спецификацию SKU. API для поддержки SKU Load Balancer и общедоступного IP-адреса доступны, начиная с API 2017-08-01. Оба SKU имеют один общий API и структуру.

Однако, в зависимости от того, какой SKU выбран, полный сценарий конфигурации может несколько отличаться. Документация Load Balancer вызывается, когда статья применима только к определенному SKU. Ознакомьтесь со следующей таблицей, чтобы сравнить сведения и понять различия. Дополнительные сведения см. в статье [Обзор Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).

>[!NOTE]
> При использовании нового сценария проектирования рассмотрите возможность использования Load Balancer уровня "Стандартный". 

Изолированные виртуальные машины, наборы доступности и масштабируемые наборы виртуальных машин можно подключить только к одному SKU, но никогда к обоим. При использовании общедоступных IP-адресов номера SKU Load Balancer и IP-адреса должны совпадать. SKU Load Balancer и общедоступные IP-адреса неизменяемы.

_Рекомендуется явно указать SKU, даже если это необязательно._  В настоящее время требуемые изменения сведены к минимуму. Если SKU не указан, это интерпретируется как намерение использовать SKU "Базовый" в версии API 2017-08-01.

>[!IMPORTANT]
>Load Balancer уровня "Стандартный" — новый продукт в серии Load Balancer, который во многом подобен супермножеству Load Balancer уровня "Базовый". Между двумя продуктами есть значительные и намеренные различия. Любой комплексный сценарий, который можно выполнить в рамках Load Balancer уровня "Базовый", также можно создать с помощью Load Balancer уровня "Стандартный". Если вы уже используете Load Balancer уровня "Базовый", следует ознакомиться с Load Balancer уровня "Стандартный", чтобы понять критические изменения в поведении между этими уровнями и их влиянием. Внимательно просмотрите этот раздел.

| | [SKU "Стандартный"](load-balancer-standard-overview.md) | SKU "Базовый" |
| --- | --- | --- |
| Размер серверного пула | До 1000 экземпляров. | До 100 экземпляров. |
| Конечные точки серверного пула | Любые виртуальные машины в одной виртуальной сети, включая смешение виртуальных машин, групп доступности и масштабируемых наборов виртуальных машин. | Виртуальные машины в одной группе доступности или масштабируемом наборе виртуальных машин. |
| Зоны доступности Azure | Избыточные в пределах зоны и зональные внешние интерфейсы для входящего и исходящего трафика, сопоставления потоков исходящего трафика выдерживают сбой зоны, межзональная балансировка нагрузки. | / |
| Диагностика | Azure Monitor, многомерные метрики, включающие счетчики пакетов и байтов, состояние проверки работоспособности, попытки подключения (TCP SYN), работоспособность исходящего подключения (успешные и завершившиеся со сбоем потоки SNAT), активные измерения в плоскости данных. | Azure Log Analytics только для общедоступной подсистемы балансировки нагрузки, оповещение о нехватке SNAT, счетчик работоспособности серверного пула. |
| Порты HA | Внутренний балансировщик нагрузки. | / |
| Обеспечение безопасности по умолчанию | По умолчанию закрыто для общедоступных IP-адресов и конечных точек подсистемы балансировки нагрузки. Группа безопасности сети должна использоваться, чтобы явно указать в списке разрешений источники для прохождения трафика. | Открыто по умолчанию, группа безопасности сети необязательна. |
| Исходящие подключения | Несколько внешних интерфейсов с условиями для каждого правила. Чтобы виртуальная машина могла использовать исходящие подключения, _необходимо_ явно создать сценарий для исходящих подключений. К [конечным точкам службы виртуальной сети](../virtual-network/virtual-network-service-endpoints-overview.md) можно получить доступ без исходящего подключения, и они не считаются обработанными данными. Любые общедоступные IP-адреса, включая службы Azure PaaS, недоступные в качестве конечных точек службы виртуальной сети, должны быть доступны посредством исходящего подключения и учитываются как обработанные данные. Когда только внутренний Load Balancer обслуживает виртуальную машину, исходящие подключения через SNAT по умолчанию недоступны. Программирование исходящих SNAT-подключений осуществляется для конкретного транспортного протокола из правила балансировки нагрузки входящего трафика. | Один внешний интерфейс, который выбирается случайно при наличии нескольких внешних интерфейсов. Когда только внутренняя подсистема балансировки нагрузки обслуживает виртуальную машину, используется SNAT по умолчанию. |
| Несколько внешних интерфейсов | Исходящий и входящий. | Только входящий. |
| Операции управления | Большинство операций длятся менее 30 секунд. | Обычно 60–90 и более секунд. |
| Соглашение об уровне обслуживания | 99,99 % для пути данных с двумя работоспособными виртуальными машинами. | Неявно в Соглашении об уровне обслуживания виртуальной машины. | 
| Цены | Цены основаны на количестве правил и обработанных входящих и исходящих данных, связанных с ресурсом.  | Бесплатно. |

Дополнительные сведения см. в статье [об ограничениях службы для Load Balancer](https://aka.ms/lblimits). Для Load Balancer уровня "Стандартный" см. [общие сведения](load-balancer-standard-overview.md), а также [сведения о ценах](https://aka.ms/lbpricing) и [Соглашении об уровне обслуживания](https://aka.ms/lbsla).

## <a name="concepts"></a>Основные понятия

### <a name = "publicloadbalancer"></a>Общедоступная подсистема балансировки нагрузки

Общедоступная подсистема балансировки нагрузки сопоставляет общедоступный IP-адрес и номер порта для входящего трафика с частным IP-адресом и номером порта виртуальной машины и наоборот для ответного трафика из виртуальной машины. Применяя правила балансировки нагрузки, можно распределять определенные типы трафика между несколькими различными виртуальными машинами или службами. Например, можно распределить нагрузку от трафика веб-запросов на несколько веб-серверов.

На следующем рисунке показана конечная точка с балансировкой нагрузки для веб-трафика, которая является общей для трех виртуальных машин на общедоступном и частном TCP-портах 80. Эти три виртуальные машины находятся в наборе балансировки нагрузки.

![Пример общедоступной подсистемы балансировки нагрузки](./media/load-balancer-overview/IC727496.png)

*Рисунок. Балансировка нагрузки веб-трафика с помощью общедоступной подсистемы балансировки нагрузки*

Когда интернет-клиенты отправляют запросы к веб-страницам на общедоступный IP-адрес веб-приложения в TCP-порт 80, Azure Load Balancer распределяет эти запросы между тремя виртуальными машинами в наборе балансировки нагрузки. Дополнительные сведения об алгоритме балансировщика нагрузки см. на [странице обзора балансировщика нагрузки](load-balancer-overview.md#load-balancer-features).

По умолчанию Azure Load Balancer распределяет сетевой трафик между несколькими экземплярами виртуальных машин. Кроме того, можно настроить сходство сеансов. Дополнительные сведения см. в статье [Настройка режима распределения для Azure Load Balancer](load-balancer-distribution-mode.md).

### <a name = "internalloadbalancer"></a>Внутренний балансировщик нагрузки

Внутренняя подсистема балансировки нагрузки направляет трафик к тем ресурсам, которые находятся внутри виртуальной сети или используют VPN для доступа к инфраструктуре Azure. В этом отношении внутренняя подсистема балансировки нагрузки отличается от общедоступной. Инфраструктура Azure ограничивает доступ к интерфейсным IP-адресам (с балансировкой нагрузки) виртуальной сети. Интерфейсные IP-адреса и виртуальные сети никогда не предоставляются напрямую конечной точке Интернета. Внутренние бизнес-приложения выполняются в Azure и доступны из Azure или из локальных ресурсов.

Внутренний Load Balancer реализует следующие типы балансировки нагрузки:

* **В виртуальной сети**. Распределение нагрузки между виртуальными машинами в виртуальной сети и набором виртуальных машин, размещенных в той же виртуальной сети.
* **Для распределенной виртуальной сети**. Балансировка нагрузки локальных компьютеров к набору виртуальных машин, размещенных в той же виртуальной сети. 
* **Для многоуровневых приложений**. Балансировка нагрузки для многоуровневых приложений с доступом в Интернет, где серверные уровни не имеют доступа к Интернету. Серверные уровни требуют балансировки нагрузки трафика уровня с выходом в Интернет (см. следующий рисунок).
* **Для бизнес-приложений**. Балансировка нагрузки для бизнес-приложений, размещенных в Azure без дополнительного оборудования или программного обеспечения подсистемы балансировки нагрузки. Сценарий включает в себя локальные серверы в наборе компьютеров, чей трафик балансируется.

![Пример внутренней подсистемы балансировки нагрузки](./media/load-balancer-overview/IC744147.png)

*Рисунок. Балансировка нагрузки многоуровневых приложений с помощью общедоступных и внутренних подсистем балансировки нагрузки*

## <a name="pricing"></a>Цены
Плата за использование Load Balancer уровня "Стандартный" взымается на основе количества настроенных правил балансировки нагрузки и количества обработанных входящих и исходящих данных. Сведения о ценах на Load Balancer уровня "Стандартный" см. на [странице цен](https://azure.microsoft.com/pricing/details/load-balancer/).

Load Balancer уровня "Базовый" предоставляется бесплатно.

## <a name="sla"></a>Соглашение об уровне обслуживания

Дополнительные сведения о Соглашении об уровне обслуживания Load Balancer уровня "Стандартный" см. на [этой странице](https://aka.ms/lbsla). 

## <a name="limitations"></a>Ограничения

- Load Balancer — это продукт TCP или UDP для балансировки нагрузки и перенаправления портов для этих протоколов IP.  Правила балансировки нагрузки и правила NAT для входящих подключений поддерживаются для TCP и UDP, но не поддерживаются для других протоколов IP, в том числе ICMP. Load Balancer не завершает полезные данные потока UDP или TCP, не отвечает на них и не взаимодействует с ними каким-либо другим способом. Это не прокси-сервер. Успешная проверка подключения к внешнему интерфейсу должна проходить через канал по тому же протоколу, который используется в правиле балансировки нагрузки или NAT для входящих подключений (TCP или UDP), _и_ по крайней мере одна из ваших виртуальных машин должна генерировать ответ внешнего интерфейса для клиента.  Если ответ по каналу от внешнего интерфейса Load Balancer не получен, это означает, что никакие виртуальные машины не могли дать ответ.  С внешним интерфейсом Load Balancer невозможно взаимодействовать, если виртуальная машина не может отвечать.  Это также применимо к исходящим подключениям, в которых [SNAT с маскировкой портов](load-balancer-outbound-connections.md#snat) поддерживается только для TCP и UDP. Использование любых других протоколов IP, включая ICMP, также приведет к сбою.  Назначьте общедоступный IP-адрес на уровне экземпляра для обхода проблемы.
- В отличие от общедоступных Load Balancer, предоставляющих [исходящие подключения](load-balancer-outbound-connections.md) при переходе с частных IP-адресов виртуальной сети на общедоступные, внутренний Load Balancer не передает исходящие подключения на внешний интерфейс внутреннего Load Balancer, так как они оба расположены в частном диапазоне IP-адресов.  Это исключает вероятность возникновения нехватки SNAT внутри уникального частного пространства IP-адресов, когда преобразование не требуется.  Побочным эффектом является то, что если исходящий поток из виртуальной машины в серверном пуле направляется к внешнему интерфейсу внутреннего балансировщика нагрузки, в пуле которого она находится, _и_ сопоставляется с собой, оба маршрута потока не совпадают и поток не будет передан.  Если поток не сопоставляется с той же виртуальной машиной в серверном пуле, которая создала поток к внешнему интерфейсу, поток будет успешно передан.   Когда поток сопоставляется с собой, получается, что исходящий поток передается из виртуальной машины на внешний интерфейс, а соответствующий входящий поток поступает от виртуальной машины к себе. С точки зрения гостевой ОС входящие и исходящие части того же потока не совпадают в виртуальной машине. Стек TCP не будет распознавать эти половины одного потока как часть того же потока, так как источник и получатель не совпадают.  При сопоставлении потока с любой другой виртуальной машиной в серверном пуле, половины потоков будут соответствовать, и виртуальная машина может успешно реагировать на поток.  Симптомом этого сценария является периодическое истечение времени ожидания подключения. Имеется несколько общих обходных решений для надежной реализации этого сценария (отправка исходящих потоков из серверного пула в серверные пулы, соответствующие внешнему интерфейсу внутреннего Load Balancer), которые включают либо размещение стороннего прокси-сервера за внутренним Load Balancer или [использование правил стиля DSR](load-balancer-multivip-overview.md).  Хотя вы можете использовать общедоступный Load Balancer в качестве обходного решения, полученный сценарий подвержен [исчерпанию SNAT](load-balancer-outbound-connections.md#snat) и без тщательного управления его следует избегать.

## <a name="next-steps"></a>Дополнительная информация

Вы ознакомились с общими сведениями об Azure Load Balancer. Чтобы приступить к работе с подсистемой балансировки нагрузки, создайте ее, создайте виртуальные машины с установленным пользовательским расширением IIS и распределяйте нагрузку веб-приложения между виртуальными машинами. Дополнительные сведения см. в кратком руководстве по [созданию общедоступной подсистемы балансировки нагрузки уровня "Базовый" с помощью портала Azure](quickstart-create-basic-load-balancer-portal.md).
