---
title: "Несколько виртуальных IP-адресов для Azure Load Balancer | Документация Майкрософт"
description: "Обзор функции нескольких виртуальных IP-адресов для Azure Load Balancer"
services: load-balancer
documentationcenter: na
author: chkuhtz
manager: narayan
editor: 
ms.assetid: 748e50cd-3087-4c2e-a9e1-ac0ecce4f869
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/25/2017
ms.author: chkuhtz
ms.openlocfilehash: 1045a18f5fd9739a6028198deea129e9e621f127
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
---
# <a name="multiple-vips-for-azure-load-balancer"></a>Несколько виртуальных IP-адресов для Azure Load Balancer

[!INCLUDE [load-balancer-basic-sku-include.md](../../includes/load-balancer-basic-sku-include.md)]

Azure Load Balancer позволяет выполнять балансировку нагрузки между службами на нескольких портах, нескольких IP-адресах или обоими этими способами. Вы можете воспользоваться определениями общедоступного и внутреннего балансировщика нагрузки для выполнения балансировки потоков в наборе виртуальных машин.

В этой статье описываются основные принципы данной функции, важные понятия и ограничения. Если вы собираетесь размещать службы только на одном IP-адресе, то см. упрощенные инструкции для настройки [общедоступного](load-balancer-get-started-internet-portal.md) или [внутреннего](load-balancer-get-started-ilb-arm-portal.md) балансировщика нагрузки. Добавление нескольких виртуальных IP-адресов является действием, дополняющим конфигурацию с одним виртуальным IP-адресом. С помощью принципов, изложенных в этой статье, можно в любой момент расширить упрощенную конфигурацию.

При определении Azure Load Balancer интерфейсная и внутренняя конфигурации связываются правилами. Проба работоспособности, на которую ссылается правило, позволяет определить, как новые потоки направляются на узел во внутреннем пуле. Внешний интерфейс определяется с помощью виртуального IP-адреса, который является сочетанием 3 кортежей: IP-адреса (общедоступного или внутреннего), транспортного протокола (UDP или TCP) и номера порта. Выделенный IP-адрес (DIP) — это IP-адрес в виртуальной сетевой карте Azure, подключенной к виртуальной машине во внутреннем пуле.

В следующей таблице приведены некоторые примеры интерфейсных конфигураций:

| Виртуальный IP-адрес | IP-адрес | protocol | порт |
| --- | --- | --- | --- |
| 1 |65.52.0.1 |TCP |80 |
| 2 |65.52.0.1 |TCP |*8080* |
| 3 |65.52.0.1 |*UDP* |80 |
| 4. |*65.52.0.2* |TCP |80 |

В таблице представлены четыре разных внешних интерфейса. Внешние интерфейсы 1, 2 и 3 — это один виртуальный IP-адрес с несколькими правилами. Используется один IP-адрес, но порт или протокол отличаются для каждого внешнего интерфейса. Внешние интерфейсы 1 и 4 являются примерами нескольких виртуальных IP-адресов, так как в них один интерфейсный протокол и один порт повторно используются для разных виртуальных IP-адресов.

Azure Load Balancer обеспечивает гибкость при определении правил балансировки нагрузки. Правило объявляет, каким образом адрес и порт во внешнем интерфейсе сопоставляются с адресом и портом назначения в серверной части. Будут ли внутренние порты повторно использоваться в нескольких правилах зависит от типа правил. Каждый тип правил имеет определенные требования, которые могут повлиять на конфигурацию узла и конструкцию пробы. Существует два типа правил:

1. Правило по умолчанию, в котором внутренние порты повторно не используются.
2. Правило плавающего IP-адреса, в котором внутренние порты используются повторно.

Azure Load Balancer позволяет сочетать оба типа правил в одной конфигурации балансировщика нагрузки. Балансировщик нагрузки может использовать их одновременно для определенной виртуальной машины или в любой комбинации; главное, чтобы соблюдались ограничения правила. Выбор типа правил зависит от требований вашего приложения и сложности поддержки созданной конфигурации. Следует оценить, какие типы правил лучше подходят для конкретного сценария.

Мы рассмотрим возможные сценарии далее в этой статье, а начнем с поведения по умолчанию.

## <a name="rule-type-1-no-backend-port-reuse"></a>Тип правил 1: внутренние порты повторно не используются

![Иллюстрация нескольких виртуальных IP-адресов](./media/load-balancer-multivip-overview/load-balancer-multivip.png)

В этом сценарии интерфейсные виртуальные IP-адреса настроены следующим образом:

| Виртуальный IP-адрес | IP-адрес | protocol | порт |
| --- | --- | --- | --- |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) 1 |65.52.0.1 |TCP |80 |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) 2 |*65.52.0.2* |TCP |80 |

Выделенный IP-адрес (DIP) — это назначение входящего потока. Во внутреннем пуле каждая виртуальная машина размещает нужную службу на уникальном порте в DIP. Эта служба связывается с внешним интерфейсом посредством определения правил.

Мы определим два правила:

| правило; | Сопоставить внешний интерфейс | С внутренним пулом |
| --- | --- | --- |
| 1 |![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) VIP1:80 |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) DIP1:80, ![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) DIP2:80 |
| 2 |![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) VIP2:80 |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) DIP1:81, ![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) DIP2:81 |

Полное сопоставление в Azure Load Balancer теперь выглядит следующим образом:

| правило; | Виртуальный IP-адрес (VIP) | protocol | порт | Место назначения | порт |
| --- | --- | --- | --- | --- | --- |
| ![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) 1 |65.52.0.1 |TCP |80 |Выделенный IP-адрес (DIP) |80 |
| ![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) 2 |65.52.0.2 |TCP |80 |Выделенный IP-адрес (DIP) |81 |

Каждое правило должно создавать поток с уникальным сочетанием конечного IP-адреса и конечного порта. Изменив конечный порт потока, можно с помощью нескольких правил направить потоки на один DIP на разных портах.

Пробы работоспособности всегда направлены на DIP виртуальной машины. Убедитесь, что проба отражает состояние работоспособности виртуальной машины.

## <a name="rule-type-2-backend-port-reuse-by-using-floating-ip"></a>Тип правил 2: внутренние порты используются повторно с помощью плавающего IP-адреса

Azure Load Balancer обеспечивает гибкость, позволяя повторно использовать интерфейсный порт на нескольких виртуальных IP-адресах независимо от того, какой тип правил используется. Кроме того, в некоторых сценариях приложений использование одного порта несколькими экземплярами приложения на одной виртуальной машине во внутреннем пуле является предпочтительным или обязательным. К распространенным примерам повторного использования портов относятся виртуальные сетевые устройства, кластеризация для обеспечения высокой доступности и размещение нескольких конечных точек TLS без повторного шифрования.

Если вы хотите, чтобы внутренний порт повторно использовался в нескольких правилах, то в определении правила необходимо активировать плавающий IP-адрес.

Плавающий IP-адрес — это часть метода, известного как прямой ответ от сервера (DSR). DSR состоит из двух частей: топологии потока и схемы сопоставления IP-адресов. На уровне платформы Azure Load Balancer всегда работает в топологии потока DSR независимо от того, активирован ли плавающий IP-адрес. Это означает, что исходящая часть потока всегда правильно перезаписывается в поток непосредственно обратно в источник.

Для удобства применения Azure предоставляет традиционную схему сопоставления IP-адресов балансировки нагрузки, используя тип правил по умолчанию. Активация плавающего IP-адреса изменяет схему сопоставления IP-адресов для обеспечения дополнительной гибкости, как описано ниже.

Эта конфигурация представлена на следующей схеме:

![Иллюстрация нескольких виртуальных IP-адресов](./media/load-balancer-multivip-overview/load-balancer-multivip-dsr.png)

В этом сценарии каждая виртуальная машина во внутреннем пуле имеет три сетевых интерфейса:

* DIP: виртуальная сетевая карта, связанная с виртуальной машиной (IP-конфигурация ресурса сетевой карты Azure).
* VIP1: интерфейс замыкания на себя в гостевой ОС, настроенной с IP-адресом VIP1.
* VIP2: интерфейс замыкания на себя в гостевой ОС, настроенной с IP-адресом VIP2.

> [!IMPORTANT]
> Настройка логических интерфейсов выполняется в гостевой ОС. Эта настройка не выполняется и не управляется Azure. Без данной настройки правила не будут функционировать. Определения проб работоспособности используют выделенный IP-адрес (DIP) виртуальной машины, а не логический виртуальный IP-адрес (VIP). Поэтому служба должна предоставлять на порте DIP ответы проб, которые отражают состояние службы, предлагаемое на логическом виртуальном IP-адресе.

Предположим, что интерфейсная конфигурация такая же, как в предыдущем сценарии:

| Виртуальный IP-адрес | IP-адрес | protocol | порт |
| --- | --- | --- | --- |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) 1 |65.52.0.1 |TCP |80 |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) 2 |*65.52.0.2* |TCP |80 |

Мы определим два правила:

| правило; | Сопоставить внешний интерфейс | С внутренним пулом |
| --- | --- | --- |
| 1 |![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) VIP1:80 |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) VIP1:80 (на виртуальной машине 1 и виртуальной машине 2) |
| 2 |![правило;](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) VIP2:80 |![серверная часть](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) VIP2:80 (на виртуальной машине 1 и виртуальной машине 2) |

Следующая таблица демонстрирует полное сопоставление в балансировщике нагрузки:

| правило; | Виртуальный IP-адрес (VIP) | protocol | порт | Место назначения | порт |
| --- | --- | --- | --- | --- | --- |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) 1 |65.52.0.1 |TCP |80 |совпадает с виртуальным IP-адресом (65.52.0.1) |совпадает с виртуальным IP-адресом (80) |
| ![Виртуальный IP-адрес](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) 2 |65.52.0.2 |TCP |80 |совпадает с виртуальным IP-адресом (65.52.0.2) |совпадает с виртуальным IP-адресом (80) |

Местом назначения входящего потока является виртуальный IP-адрес в интерфейсе замыкания на себя на виртуальной машине. Каждое правило должно создавать поток с уникальным сочетанием конечного IP-адреса и конечного порта. Изменив конечный IP-адрес потока, можно разрешить повторное использование портов на одной виртуальной машине. Служба предоставляется балансировщику нагрузки через привязку к виртуальному IP-адресу и порту соответствующего интерфейса замыкания на себя.

Обратите внимание, что в этом примере не изменяется конечный порт. Несмотря на то, что этот сценарий использует плавающий IP-адрес, Azure Load Balancer также поддерживает определение правила, которое перезаписывает внутренний конечный порт и делает его отличным от интерфейсного конечного порта.

Тип правил с плавающим IP-адресом лежит в основе нескольких шаблонов конфигураций балансировщика нагрузки. Одним из примеров, доступных в данный момент, является конфигурация [SQL AlwaysOn with Multiple Listeners](../virtual-machines/windows/sql/virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md) (SQL AlwaysOn с несколькими прослушивателями). В будущем мы опишем больше сценариев.

## <a name="limitations"></a>Ограничения

* Конфигурации с несколькими виртуальными IP-адресами поддерживаются только при использовании виртуальных машин IaaS.
* Если применяется правило с плавающим IP-адресом, то для исходящих потоков в приложении должен использоваться выделенный IP-адрес (DIP). Если приложение имеет привязку к виртуальному IP-адресу, настроенному в интерфейсе замыкания на себя в гостевой ОС, то функция SNAT недоступна для перезаписи исходящего потока, и поэтому поток завершается сбоем.
* Общедоступные IP-адреса оказывают влияние на выставление счетов. Дополнительные сведения см. в статье [Цены на IP-адреса](https://azure.microsoft.com/pricing/details/ip-addresses/).
* Действуют ограничения подписки. Дополнительные сведения см. в разделе [Ограничения определенных служб](../azure-subscription-service-limits.md#networking-limits).
