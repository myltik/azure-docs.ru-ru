---
title: Исходящие подключения в Azure | Документация Майкрософт
description: В этой статье рассказывается о том, как Azure обеспечивает взаимодействие виртуальных машин с общедоступными службами Интернета.
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/08/2018
ms.author: kumud
ms.openlocfilehash: 2e6b8dd5e0ec0ae73fff4a25ad79045e3414e9cc
ms.sourcegitcommit: 3017211a7d51efd6cd87e8210ee13d57585c7e3b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/06/2018
ms.locfileid: "34825005"
---
# <a name="outbound-connections-in-azure"></a>Исходящие подключения в Azure

Azure предусматривает несколько различных механизмов установки исходящих подключений для клиентских развертываний. В этой статье описаны соответствующие сценарии, а также то, когда их применять, как они работают и как ими управлять.

>[!NOTE] 
>Эта статья относится только к модели развертывания с помощью Resource Manager. Рекомендации по использованию классической модели развертывания в Azure можно найти в [этой статье](load-balancer-outbound-connections-classic.md).

Развертывания в Azure могут взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов. Когда экземпляр инициирует исходящий поток к месту назначения в пространстве общедоступных IP-адресов, Azure динамически сопоставляет частный IP-адрес виртуальной машины с общедоступным IP-адресом. После создания этого сопоставления обратный трафик исходящего потока можно также направлять по частному IP-адресу, с которого изначально отправлен поток.

Для этого Azure использует преобразование адресов исходной сети (SNAT). Если несколько частных IP-адресов маскируются под одним общедоступным IP-адресом, Azure использует [преобразование адресов портов (PAT)](#pat), чтобы замаскировать частные IP-адреса. Для PAT используются временные порты, которые [предварительно выделяются](#preallocatedports) в зависимости от размера пула.

Есть несколько [сценариев для исходящих подключений](#scenarios). При необходимости их можно объединять. Тщательно ознакомьтесь с этими сценариями, чтобы узнать о возможностях, ограничениях и шаблонах, применимых к вашей модели развертывания и сценарию приложения. Просмотрите руководство по [управлению этими сценариями](#snatexhaust).

>[!IMPORTANT] 
>Load Balancer категории "Стандартный" вводит новые возможности и различные расширения функциональности для исходящего подключения.   Например, когда присутствует внутренний Load Balancer категории "Стандартный", то [сценарий 3](#defaultsnat) не существует и необходимо выполнить другие шаги.   Внимательно просмотрите весь этот документ, чтобы понять общие концепции и различия между номерами SKU.

## <a name="scenarios"></a>Обзор сценариев

При использовании [Azure Resource Manager](#arm) Azure Load Balancer и связанные ресурсы определяются явно.  Сейчас в Azure доступны три разных способа реализации исходящих подключений для ресурсов Azure Resource Manager. 

| Сценарий | Метод | Протоколы IP | ОПИСАНИЕ |
| --- | --- | --- | --- |
| [1. Виртуальная машина с общедоступным IP-адресом уровня экземпляра (с подсистемой балансировки нагрузки или без нее)](#ilpip) | SNAT, маскировка портов не используется | TCP, UDP, ICMP, ESP | Azure использует общедоступный IP-адрес, назначенный IP-конфигурации сетевой карты в экземпляре. Доступны все временные порты экземпляра. |
| [2. Общедоступная подсистема балансировки нагрузки, связанная с виртуальной машиной (без общедоступного IP-адреса уровня экземпляра на экземпляре)](#lb) | SNAT с маскировкой портов (PAT) с использованием подсистем балансировки нагрузки | TCP, UDP |Azure предоставляет общедоступные IP-адреса общедоступных подсистем балансировки нагрузки нескольким частным IP-адресам. Кроме того, Azure использует временные порты этих подсистем для PAT. |
| [3. Автономная виртуальная машина (без подсистемы балансировки нагрузки, без общедоступного IP-адреса уровня экземпляра)](#defaultsnat) | SNAT с маскировкой портов (PAT) | TCP, UDP | Azure автоматически назначает общедоступный IP-адрес для SNAT, предоставляет его нескольким частным IP-адресам в группе доступности и использует временные порты общедоступного адреса. Это резервный сценарий для первых двух. Мы не рекомендуем его использовать, если необходимо контролировать использование адресов и управлять им. |

Если виртуальная машина не должна взаимодействовать с конечными точками за пределами Azure в пространстве общедоступных IP-адресов, можно использовать группы безопасности сети (NSG), чтобы блокировать доступ. Дополнительные сведения об использовании NSG см. в разделе [Запрет исходящих подключений](#preventoutbound). Эта статья не охватывает рекомендации по проектированию или практические сведения о том, как создать виртуальную сеть и управлять ею без доступа ко внешней сети.

### <a name="ilpip"></a>Сценарий 1. Виртуальная машина с общедоступным IP-адресом на уровне экземпляра

В этом случае виртуальной машине назначен общедоступный IP-адрес уровня экземпляра (ILPIP). Так как здесь рассматриваются исходящие подключения, балансировка нагрузки виртуальной машины не имеет значения. Этот сценарий приоритетнее остальных. Виртуальная машина использует ILPIP-адрес для всех исходящих потоков.  

Общедоступный IP-адрес назначается виртуальной машине в соотношении "один к одному" (а не "один ко многим") через NAT типа "один к одному" без отслеживания состояния.  Маскировка портов (PAT) не используется, и виртуальная машина может использовать все временные порты.

Если приложение инициирует большое количество исходящих потоков и возникает нехватка портов для SNAT, назначьте [ILPIP-адрес, чтобы устранить ограничения SNAT](#assignilpip). Сведения о проблеме см. в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

### <a name="lb"></a>Сценарий 2. Виртуальная машина с подсистемой балансировки нагрузки без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина — часть внутреннего пула Load Balancer. Виртуальной машине не назначен общедоступный IP-адрес. Для ресурса Load Balancer необходимо настроить правило балансировки нагрузки для связывания общедоступного IP-адреса внешнего интерфейса с внутренним пулом.

Если не выполнить эту настройку, поведение будет таким, как описано в сценарии для [автономной виртуальной машины без общедоступного IP-адреса уровня экземпляра](#defaultsnat). Для правильной работы правила не обязательно, чтобы был прослушиватель во внутреннем пуле для успешной проверки работоспособности.

Когда виртуальная машина с балансировкой нагрузки создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный IP-адрес интерфейса общедоступной подсистемы балансировки нагрузки. Azure использует SNAT, чтобы выполнять эту функцию, а [PAT](#pat) — чтобы выдать несколько частных IP-адресов за один общедоступный. 

Для определения отдельных потоков, исходящих от виртуальной машины, используются временные порты интерфейсного общедоступного IP-адреса подсистемы балансировки нагрузки. При создании исходящих потоков в ходе SNAT динамически используются [предварительно выделенные временные порты](#preallocatedports). В этом контексте временные порты, используемые для SNAT, называются портами SNAT.

Порты SNAT выделяются предварительно, как описано в разделе [Основные сведения о SNAT и PAT](#snat). Они представляют собой ограниченный ресурс, который можно исчерпать. Важно понимать, как они [используются](#pat). Чтобы понять, как спроектировать архитектуру и избежать этой проблемы, см. сведения в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

Если [несколько (общедоступных) IP-адресов связаны с Load Balancer категории "Базовый"](load-balancer-multivip-overview.md), то любой из них, [но только один, можно использовать для исходящих потоков](#multivipsnat).  

Для отслеживания работоспособности исходящих подключений с помощью Load Balancer категории "Базовый" можно использовать [Log Analytics для Load Balancer](load-balancer-monitor-log.md), а для просмотра сообщений о нехватке портов при SNAT — [журналы оповещений о событиях](load-balancer-monitor-log.md#alert-event-log).

### <a name="defaultsnat"></a>Сценарий 3. Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра

В этом сценарии виртуальная машина не является частью общего пула Load Balancer (и внутреннего пула Load Balancer категории "Стандартный") и не имеет назначенного ILPIP-адреса. Когда виртуальная машина создает исходящий поток, Azure преобразует частный исходный IP-адрес исходящего потока в общедоступный исходный IP-адрес. Общедоступный IP-адрес, используемый для этого исходящего потока, настроить нельзя, и он не учитывается в ограничениях подписки на ресурсы общедоступного IP-адреса.

>[!IMPORTANT] 
>Этот сценарий также применяется, когда подключен __только__ внутренний Load Balancer категории "Базовый". Сценарий 3 __недоступен__, если к виртуальной машине подключен внутренний Load Balancer категории "Стандартный".  Нужно явно создать [сценарий 1](#ilpip) или [сценарий 2](#lb) в дополнение к использованию внутреннего Load Balancer категории "Стандартный".

Для выполнения этой функции Azure использует SNAT с маскировкой портов ([PAT](#pat)). Эта ситуация аналогична [сценарию 2](#lb), кроме того, что нельзя управлять использованием IP-адреса. Это резервный сценарий, на случай если не исполняются сценарии 1 и 2. Мы не рекомендуем использовать этот сценарий, если необходим контроль над исходящими адресами. Если исходящие подключения являются важной частью приложения, необходимо выбрать другой сценарий.

Порты SNAT выделяются предварительно, как описано в разделе [Основные сведения о SNAT и PAT](#snat).  Количество виртуальных машин, совместно использующих группу доступности, определяет применяемый уровень предварительного выделения.  Изолированная виртуальная машина без группы доступности фактически представляет собой пул с 1 экземпляром для целей определения предварительного выделения (1024 порта SNAT). Порты SNAT представляют собой ограниченный ресурс, который может быть исчерпан. Важно понимать, как они [используются](#pat). Чтобы понять, как спроектировать архитектуру и избежать этой проблемы, см. сведения в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

### <a name="combinations"></a>Несколько объединенных сценариев

Сценарии, описанные в разделах выше, можно объединять для достижения определенного результата. При наличии нескольких сценариев применяется такая очередность: [сценарий 1](#ilpip) имеет приоритет над [сценарием 2](#lb) и [3](#defaultsnat). [Сценарий 2](#lb) имеет приоритет над [сценарием 3](#defaultsnat).

Например, в развертывании Azure Resource Manager приложение в большей степени использует исходящие подключения к ограниченному числу мест назначения, но также принимает входящие потоки через интерфейс подсистемы балансировки нагрузки. В этом случае можно объединить сценарии 1 и 2, чтобы оптимизировать нагрузку. Дополнительные шаблоны см. в разделе об [управлении при нехватке в ходе SNAT](#snatexhaust).

### <a name="multife"></a>Несколько интерфейсов для исходящих потоков

#### <a name="load-balancer-standard"></a>Load Balancer категории "Стандартный"

Load Balancer категории "Стандартный" использует всех кандидатов на исходящие потоки одновременно, когда присутствует [множество (общедоступных) IP-интерфейсов](load-balancer-multivip-overview.md). Каждый внешний интерфейс увеличивает количество доступных выделенных портов SNAT, если для исходящих соединений включено правило балансировки нагрузки.

Можно заблокировать использование внешнего IP-адреса для исходящих подключений с помощью нового параметра правила балансировки нагрузки.

```json    
      "loadBalancingRules": [
        {
          "disableOutboundSnat": false
        }
      ]
```

Обычно этот параметр по умолчанию имеет значение _false_. Это означает, что это правило программирует исходящий SNAT для связанных виртуальных машин в серверном пуле правила балансировки нагрузки.  Значение можно изменить на _true_, чтобы предотвратить использование в Load Balancer связанного с ним внешнего IP-адреса для исходящих соединений виртуальных машин в серверном пуле этого правила балансировки нагрузки.  Также можно назначить определенный IP-адрес для исходящего потока, как описано в подразделе об [объединении сценариев](#combinations).

#### <a name="load-balancer-basic"></a>Load Balancer категории "Базовый"

Если есть [несколько интерфейсов (общедоступных) IP-адресов](load-balancer-multivip-overview.md), которые можно использовать для исходящих потоков, Load Balancer категории "Базовый" выберет один интерфейс. Выбор нельзя настроить, а его алгоритм следует рассматривать как случайный. Вы можете указать определенный IP-адрес для исходящего потока, как описано в подразделе об [объединении сценариев](#combinations).

### <a name="az"></a> Зоны доступности

При использовании [Load Balancer категории "Стандартный" с зонами доступности](load-balancer-standard-availability-zones.md) избыточные в пределах зоны интерфейсы могут обеспечивать избыточные в пределах зоны исходящие SNAT-соединения, а SNAT-программирование сохраняется при сбое зоны.  Когда используются зональные интерфейсы, исходящие SNAT-соединения подвергаются тем же действиям, что и зона, к которой они принадлежат.

## <a name="snat"></a>Основные сведения о SNAT и PAT

### <a name="pat"></a>SNAT с маскировкой портов (PAT)

Когда общедоступный ресурс Load Balancer связан с экземплярами виртуальной машины, источник каждого исходящего подключения перезаписывается. Источник перезаписывается из частного IP-адреса виртуальной сети в общедоступный IP-адрес внешнего интерфейса Load Balancer. В пространстве общедоступных IP-адресов поток из 5 кортежей (исходного IP-адреса, исходного порта, транспортного IP-протокола, конечного IP-адреса, конечного порта) должен быть уникальным.  SNAT, маскирующий порты, может использоваться с протоколами TCP или UDP IP.

Для обеспечения этого используются временные порты (порты SNAT) после перезаписи частного исходного IP-адреса, так как из одного общедоступного IP-адреса исходят несколько потоков. 

Для одного потока к конечным IP-адресу, порту и протоколу используется один порт SNAT. При наличии нескольких потоков к одним и тем же конечным IP-адресу, порту и протоколу каждый поток использует отдельный порт SNAT. Это гарантирует уникальность потоков, отправляемых с одного и того же общедоступного IP-адреса к одним и тем же конечным IP-адресу, порту и протоколу. 

Несколько потоков, каждый из которых направляется к разным конечным IP-адресу, порту и протоколу, используют отдельный порт SNAT. Конечный IP-адрес, порт и протокол делают потоки уникальными, устраняя необходимость в дополнительных портах источника, чтобы различать потоки в пространстве общедоступных IP-адресов.

Если ресурс портов SNAT исчерпан, исходящие потоки прекращаются, пока имеющиеся потоки не освободят порты SNAT. Когда поток закрывается, подсистема балансировки нагрузки освобождает порты SNAT. Для их освобождения от простаивающих потоков используется [4-минутный период ожидания простоя](#idletimeout).

Шаблоны, позволяющие уменьшить риски возникновения условий, которые обычно приводят к нехватке портов, см. в разделе [Управление нехваткой портов SNAT (PAT)](#snatexhaust).

### <a name="preallocatedports"></a>Предварительное выделение временных портов для SNAT с маскировкой портов (PAT)

При SNAT с маскировкой портов ([PAT](#pat)) Azure использует алгоритм, определяющий количество предварительно выделяемых доступных портов SNAT в зависимости от размера внутреннего пула. Порты SNAT — это временные порты, доступные для конкретного общедоступного исходного IP-адреса.

Для UDP и TCP заранее выделяется одинаковое число портов SNAT. Они потребляются независимо для каждого транспортного протокола IP. 

>[!IMPORTANT]
>SNAT категории SKU "Стандартный" программируются отдельно для разных транспортных протоколов IP с применением правил балансировки нагрузки.  Если правило балансировки нагрузки определено только для TCP, порты SNAT предоставляются только для TCP. Если правило балансировки нагрузки определено только для TCP, но вы хотите использовать исходящие порты SNAT для UDP, создайте правило балансировки нагрузки для UDP в том же интерфейсе и для того же пула серверной части.  Это позволит начать программирование SNAT для протокола UDP.  Применять рабочие правила и проверки работоспособности не нужно.  Порты SNAT категории SKU "Базовый" всегда программируются для обоих транспортных протоколов IP независимо от того, какие из них указаны в правиле балансировки нагрузки.

Azure предварительно выделяет эти порты для конфигурации IP-адресов сетевой карты в каждой виртуальной машине. При добавлении конфигурации IP-адресов в пул порты SNAT уже выделены для нее, исходя из размера внутреннего пула. Когда создаются исходящие потоки, эти порты динамически используются в [PAT](#pat) вплоть до предела выделения, а освобождаются они, когда поток закрывается или [истекает время ожидания простоя](#idletimeout).

В таблице ниже указаны предварительно выделяемые порты SNAT для уровней размера внутреннего пула.

| Размер пула (экземпляры виртуальных машин) | Предварительно выделяемые порты SNAT на каждую конфигурацию IP-адресов|
| --- | --- |
| 1–50 | 1024 |
| 51–100 | 512 |
| 101–200 | 256 |
| 201–400 | 128 |
| 401–800 | 64 |
| 801–1000 | 32 |

>[!NOTE]
> При использовании Load Balancer категории "Стандартный" с [множеством интерфейсов](load-balancer-multivip-overview.md) [каждый внешний IP-адрес увеличивает количество доступных портов SNAT](#multivipsnat) в предыдущей таблице. Например, серверный пул из 50 виртуальных машин с 2 правилами балансировки нагрузки, каждый с отдельными внешними IP-адресами, будет использовать 2048 (2 x 1024) SNAT-портов для каждой конфигурации IP. См. подробности в разделе [Несколько интерфейсов для исходящих потоков](#multife).

Помните, что количество доступных портов SNAT не преобразуется автоматически в количество потоков. Один порт SNAT можно использовать повторно для нескольких уникальных назначений. Порты используются, только если это необходимо, чтобы сделать поток уникальным. Советы по проектированию и уменьшению рисков см. [в разделе об управлении этим исчерпаемым ресурсом](#snatexhaust), а описание PAT — в разделе [SNAT с маскировкой портов (PAT)](#pat).

Изменение размера пула может повлиять на передачу некоторых имеющихся потоков. Если размер внутреннего пула увеличивается и он переходит на следующий уровень. Половина предварительно выделенных портов освобождается при переходе. Время ожидания потоков, связанных с освобожденным портом SNAT, истечет, и их нужно будет отправить повторно. Если предварительно выделенные порты доступны, новые потоки сразу успешно передаются.

Если размер серверного пула уменьшается с размера одного уровня до следующего размера, количество доступных портов SNAT растет. В этом случае имеющиеся выделенные порты SNAT и их потоки не будут затронуты.

Порты SNAT выделяются для конкретного транспортного протокола IP (то есть отдельно для TCP и UDP) и освобождаются при следующих условиях:

### <a name="tcp-snat-port-release"></a>Освобождение TCP-порта SNAT

- Если клиент и сервер отправляют флаги FIN и ACK, порт SNAT освобождается через 240 секунд.
- Если получен сегмент с флагом RST, порт SNAT освобождается через 15 секунд.
- Если достигнуто время ожидания в режиме простоя.

### <a name="udp-snat-port-release"></a>Освобождение UDP-порта SNAT

- Если достигнуто время ожидания в режиме простоя.

## <a name="problemsolving"></a> Решение проблем 

Этот раздел предназначен, чтобы помочь устранить нехватку портов SNAT и другие проблемы, которые могут возникнуть с исходящими подключениями в Azure.

### <a name="snatexhaust"></a>Управление нехваткой портов SNAT (PAT)
[Временные порты](#preallocatedports) для [PAT](#pat) — ограниченный ресурс. Это описано в разделах [Автономная виртуальная машина без общедоступного IP-адреса уровня экземпляра](#defaultsnat) и [Виртуальная машина с подсистемой балансировки нагрузки без общедоступного IP-адреса уровня экземпляра](#lb).

При инициировании множества исходящих TCP- или UDP-подключений к одним и тем же конечным IP-адресу и порту подключения будут завершаться сбоем или же вы будете получать уведомления от службы поддержки о нехватке SNAT (выделенных [временных портов](#preallocatedports), используемых для [PAT](#pat)). У вас есть несколько вариантов устранения этой проблемы. Ознакомьтесь с ними, чтобы выбрать доступный и подходящий вариант для своего сценария. Возможно, один или несколько вариантов помогут вам решить проблему.

Если вам непонятно поведение исходящих подключений, можно использовать статистику распределения IP-адресов (netstat) или записывать пакеты. Такую запись можно выполнять в гостевой ОС экземпляра или с помощью [Наблюдателя за сетями](../network-watcher/network-watcher-packet-capture-manage-portal.md).

#### <a name="connectionreuse"></a>Изменение приложения для повторного использования подключений 
Вы можете снизить потребность во временных портах, используемых для SNAT, повторно используя подключения в приложении. Это особенно касается таких протоколов, как HTTP/1.1, в которых подключения используются повторно по умолчанию. В свою очередь, это может положительно повлиять на другие протоколы, использующие HTTP в качестве транспортировки (например, REST). 

Повторное использование всегда лучше, чем отдельные, атомарные TCP-подключения для каждого запроса. Оно позволяет повысить производительность и эффективность транзакций TCP.

#### <a name="connection pooling"></a>Изменение приложения для использования пулов подключений
Можно использовать в приложении схему пула подключений, при которой внутренний механизм распределяет запросы по фиксированному набору подключений (каждое из которых повторно используется, если это возможно). Эта схема ограничивает количество используемых временных портов и делает среду более предсказуемой. Кроме того, она может повысить пропускную способность запросов, позволяя одновременно выполнять несколько операций, когда отдельное подключение блокируется, ожидая результата операции.  

Возможно, пулы подключений уже существуют в платформе, которая используется вами для разработки приложения или параметров конфигурации приложения. Их можно объединить с повторным использованием подключений. В этом случае для обработки нескольких запросов можно будет использовать фиксированное, прогнозируемое число портов для одних и тех же конечных IP-адреса и порта. Кроме того, вы можете воспользоваться преимуществами повышенной эффективности транзакций TCP, сокращающей задержки и использование ресурсов. Транзакции UDP также могут предоставлять преимущества, так как возможность изменить число потоков UDP позволяет избежать нехватки и управлять использованием портов SNAT.

#### <a name="retry logic"></a>Изменение приложения для использования менее "жесткой" логики повторных попыток
При нехватке [предварительно выделенных временных портов](#preallocatedports) для [PAT](#pat) или сбоях приложения строгая логика повтора или логика повтора методом подбора без логики отхода и времени сохранения не позволяет устранить проблему. Вы можете снизить потребность во временных портах, используя менее "жесткую" логику повторных попыток. 

Для временных портов установлено время ожидания простоя 4 минуты (не регулируется). Если повторные попытки слишком частые, нехватка будет наблюдаться в любом случае. Поэтому знать, как и как часто приложение повторяет транзакции, очень важно для проектирования.

#### <a name="assignilpip"></a>Назначение общедоступного IP-адреса на уровне экземпляра для каждой виртуальной машины
Назначение ILPIP изменяет сценарий на первый: [назначение общедоступного IP-адреса на уровне экземпляра для виртуальной машины](#ilpip). Все временные порты общедоступного IP-адреса, используемые для каждой виртуальной машины, доступны для каждой из них. (В отличие от сценариев, где временные порты общедоступного IP-адреса используются совместно всеми виртуальными машинами, связанными с соответствующим внутренним пулом.) Существуют преимущества и недостатки, которые необходимо учитывать, например дополнительные затраты на общедоступные IP-адреса и возможное влияние добавления в список разрешений большого количества отдельных IP-адресов.

>[!NOTE] 
>Такая возможность недоступна для рабочих ролей.

#### <a name="multifesnat"></a>Использование нескольких внешних интерфейсов

При использовании общедоступного Load Balancer категории "Стандартный" назначаются [несколько внешних IP-адресов для исходящих подключений](#multife) и [количество доступных портов SNAT увеличивается](#preallocatedports).  Необходимо создать внешнюю IP-конфигурацию, правило и внутренний пул для активации программирования SNAT для общедоступного IP-адреса интерфейса.  Правило не должно функционировать, и проверка работоспособности не должна завершиться успешно.  Если используются несколько внешних интерфейсов для входящих подключений (а не только для исходящих), нужно использовать специальные проверки работоспособности, чтобы обеспечить надежность.

>[!NOTE]
>В большинстве случаев нехватка портов SNAT является признаком плохой конфигурации.  Прежде чем использовать больше интерфейсов для добавления портов SNAT, убедитесь, что вы понимаете, почему не хватает портов.  Возможно, где-то прячется проблема, которая может привести к сбою позже.

#### <a name="scaleout"></a>Горизонтальное масштабирование

[Предварительно выделенные порты](#preallocatedports) назначаются в соответствии с размером внутреннего пула и группируются по уровням. Это позволяет минимизировать нарушения работы, когда нужно перераспределить несколько портов для размещения следующего более крупного уровня пула серверной части.  Вы можете увеличить интенсивность использования портов SNAT для определенного интерфейса, масштабируя пул серверной части до максимального размера для заданного уровня.  Это важное условие для эффективного масштабирования приложения.

Например, для двух виртуальных машин в пуле серверной части выделяется 1024 порта SNAT на каждую конфигурацию IP, что позволяет использовать в общей сложности 2048 портов SNAT в этом развертывании.  Если вы увеличите это развертывание до 50 виртуальных машин, сохраняя прежнее число выделяемых портов на виртуальную машину, развертывание сможет использовать в общей сложности 51 200 портов SNAT (50 x 1024).  Если вы хотите масштабировать развертывание, проверьте число [предварительно выделяемых портов](#preallocatedports) для соответствующего уровня, чтобы правильно настроить масштабирование в соответствии с максимальными возможностями уровня.  Если в описанном выше развертывании вы увеличите число экземпляров до 51 (вместо 50), вы перейдете на следующий уровень, и число портов SNAT окажется меньшим как для каждой виртуальной машины, так и суммарно.

И наоборот, масштабирование до следующего более крупного уровня пула серверной части имеет смысл применять, когда требуется перераспределить порты.  Если же перераспределение нежелательно, выбирайте параметры развертывания в соответствии с текущим уровнем.  В качестве альтернативного решения можно реализовать в приложении логику отслеживания и повторных попыток.  Проверка активности TCP поможет определять, когда порты SNAT теряют работоспособность из-за перераспределения.

### <a name="idletimeout"></a>Использование проверки активности для сброса времени ожидания простоя исходящих подключений

Для исходящих подключений задано время ожидания простоя 4 минуты. Это время не регулируется. Тем не менее вы можете использовать проверку активности транспортного уровня (например, TCP-подключений) или уровня приложения, чтобы обновлять простаивающие потоки и сбрасывать время ожидания, если необходимо.  

Если вы решите использовать проверку активности TCP, ее достаточно организовать на одной стороне соединения. Например, проверка активности со стороны сервера будет успешно сбрасывать таймер ожидания для последовательности, избавляя от необходимости поддерживать активность TCP-соединения с обеих сторон.  Этот же подход применим и для уровня приложений, в том числе в системах баз данных "клиент — сервер".  Выясните, какие средства на стороне сервера позволяют поддерживать активность для конкретного приложения.

## <a name="discoveroutbound"></a>Обнаружение общедоступного IP-адреса, используемого виртуальной машиной
Существует много способов определить общедоступный исходный IP-адрес исходящего подключения. OpenDNS — это служба, которая может показать общедоступный IP-адрес виртуальной машины. 

С помощью команды nslookup можно отправить к сопоставителю OpenDNS запрос DNS для имени myip.opendns.com. Служба возвращает исходный IP-адрес, который был использован для отправки запроса. При выполнении следующего запроса, поступившего с виртуальной машины, ответ будет содержать общедоступный IP-адрес, используемый для этой виртуальной машины.

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a>Запрет исходящих подключений
Иногда создание виртуальной машиной исходящих потоков может быть нежелательным. Кроме того, вам может понадобиться ограничить пункты назначения, доступные для исходящих потоков или назначений, инициирующих входящие потоки. В таком случае можно использовать [группы безопасности сети](../virtual-network/security-overview.md), чтобы управлять пунктами назначений, доступными для виртуальной машины. Кроме того, с их помощью можно выбирать общедоступные назначения, способные инициировать входящие потоки.

При использовании NSG для виртуальной машины с балансировкой нагрузки обратите внимание на [теги службы](../virtual-network/security-overview.md#service-tags) и [правила безопасности по умолчанию](../virtual-network/security-overview.md#default-security-rules). Следует убедиться, что виртуальная машина может получать запросы проверки состояния работоспособности из Azure Load Balancer. 

Если NSG блокирует такие запросы от тега по умолчанию AZURE_LOADBALANCER, запрос завершается сбоем, а виртуальная машина помечается как отключенная. Подсистема балансировки нагрузки прекращает отправку новых потоков на эту виртуальную машину.

## <a name="limitations"></a>Ограничения
- DisableOutboundSnat недоступен в качестве параметра при настройке правила балансировки нагрузки на портале.  Вместо этого используйте REST, шаблон или средства клиента.
- Рабочие веб-роли без виртуальной сети и другие службы платформы Майкрософт могут быть доступны при использовании только внутренней подсистемы Load Balancer уровня "Стандартный" из-за побочного эффекта от того, как работают службы, созданные до использования виртуальной сети, и другие функции служб платформы. Вы не должны полагаться на этот побочный эффект, так как соответствующая служба или базовая платформа могут измениться без уведомления. Вы всегда должны предполагать, что вам при необходимости нужно явно создать исходящее подключение при использовании только Load Balancer уровня "Стандартный". Сценарий 3 [SNAT](#defaultsnat) по умолчанию, описанный в этой статье, недоступен.

## <a name="next-steps"></a>Дополнительная информация

- [Обзор Azure Load Balancer](load-balancer-overview.md)
- Узнайте больше об [Azure Load Balancer уровня "Стандартный"](load-balancer-standard-overview.md).
- Дополнительные сведения о группах безопасности сети см. в статье [Фильтрация сетевого трафика с помощью групп безопасности сети](../virtual-network/security-overview.md).
- Дополнительные сведения о некоторых других ключевых [сетевых возможностях](../networking/networking-overview.md) Azure.
