---
title: Создание и использование внутренней подсистемы балансировки нагрузки с использованием среды Службы приложений Azure
description: Сведения о создании и использовании изолированной от Интернета среды Службы приложений Azure
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 0f4c1fa4-e344-46e7-8d24-a25e247ae138
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: quickstart
ms.date: 03/20/2018
ms.author: ccompy
ms.custom: mvc
ms.openlocfilehash: 61a454ffb36865d4e1bc6b7ae5622fa4d4e85fd2
ms.sourcegitcommit: 6fcd9e220b9cd4cb2d4365de0299bf48fbb18c17
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2018
---
# <a name="create-and-use-an-internal-load-balancer-with-an-app-service-environment"></a>Создание и использование внутренней подсистемы балансировки нагрузки с использованием среды службы приложений #

 Среда службы приложений — это развернутая служба приложений Azure в подсети виртуальной сети Azure. Существует два способа развертывания среды службы приложений (ASE): 

- с виртуальным IP-адресом на основе внешнего IP-адреса, что часто называют внешней средой ASE;
- с виртуальным IP-адресом на основе внутреннего IP-адреса, что часто называют средой службы приложений с внутренним балансировщиком нагрузки, так как внутренней конечной точкой является внутренний балансировщик нагрузки (ILB). 

В этой статье показано, как создать ASE с внутренним балансировщиком нагрузки. См. [дополнительные сведения о среде службы приложений][Intro]. Сведения о создании внешней среды ASE см. в статье[Создание внешней среды службы приложений][MakeExternalASE].

## <a name="overview"></a>Обзор ##

Вы можете развернуть ASE с конечной точкой, доступной из Интернета, или IP-адресом в вашей виртуальной сети. Чтобы задать IP-адрес виртуальной сети, среду службы приложений необходимо развернуть с внутренним балансировщиком нагрузки. При развертывании среды службы приложений с внутренним балансировщиком нагрузки необходимо наличие следующих компонентов:

-   Ваш собственный домен, в котором создаются приложения.
-   Сертификат, используемый для HTTPS.
-   Управление службой DNS для домена.

Это дает следующие возможности:

-   Безопасное размещение в облаке приложений из интрасети, доступ к которым осуществляется через VPN типа "сеть — сеть" или Azure ExpressRoute.
-   Размещение в облаке приложений, которые не указаны на общедоступных DNS-серверах.
-   Создание изолированных от Интернета внутренних приложений, с которыми можно безопасно интегрировать свои внешние приложения.

### <a name="disabled-functionality"></a>Отключенные функциональные возможности ###

Существуют некоторые функции, недоступные при использовании ASE с внутренним балансировщиком нагрузки.

-   Использование SSL на основе IP-адреса.
-   Назначение IP-адресов конкретным приложениям.
-   Приобретение и использование сертификата с приложением на портале Azure. Вы можете получить сертификаты непосредственно в центре сертификации и использовать их вместе со своими приложениями. Их нельзя получить на портале Azure.

## <a name="create-an-ilb-ase"></a>Создание среды службы приложений с внутренней подсистемой балансировки нагрузки ##

Чтобы создать ASE с внутренним балансировщиком нагрузки, выполните следующее.

1. На портале Azure выберите **Создать ресурс** > **Интернет и мобильные устройства** > **Среда службы приложений**.

2. Выберите свою подписку.

3. Выберите или создайте группу ресурсов.

4. Выберите или создайте виртуальную сеть.

5. При выборе существующей виртуальной сети необходимо создать подсеть для размещения ASE. Задайте для подсети достаточно большой размер с учетом увеличения среды службы приложений в будущем. Рекомендуемый размер — `/25`. Такая подсеть содержит 128 адресов и может обслуживать среду службы приложений максимального размера. Минимальный размер составляет `/28`. В соответствии с потребностями инфраструктуры этот размер может масштабироваться максимум до 3 экземпляров.

    * Можно превысить максимальное количество в 100 экземпляров в планах службы приложений.

    * Можно выполнить масштабирование примерно до 100 экземпляров, но путем более быстрого масштабирования внешнего интерфейса.

6. Выберите **Виртуальная сеть/расположение** > **Конфигурация виртуальной сети**. Задайте для параметра **Тип VIP** значение **Внутренний**.

7. Введите имя домена. Указанный домен будет использоваться для приложений, создаваемых в этой среде службы приложений. Существуют некоторые ограничения. Нельзя использовать такие имена:

    * net;   

    * azurewebsites.net;

    * p.azurewebsites.net;

    * &lt;имя_ASE&gt;.p.azurewebsites.net.

   Пользовательские доменные имена позволяют сопоставить существующее имя DNS с вашим веб-приложением. См. дополнительные сведения о [сопоставлении существующего имени DNS с веб-приложением][customdomain]. Пользовательское имя домена, используемое для приложений, и имя домена, используемое средой ASE, не должны перекрываться. В среде ASE с внутренним балансировщиком нагрузки с доменным именем _contoso.com_ нельзя использовать следующие пользовательские доменные имена для приложений:

    * www.contoso.com;

    * abcd.def.contoso.com;

    * abcd.contoso.com.

   Если вы знаете, какие пользовательские доменные имена будете использовать для приложений, выберите для среды ASE с ILB домен, который не будет конфликтовать с этими именами. В этом примере для домена ASE можно использовать такое имя, как *contoso-internal.com*, так как оно не конфликтует с пользовательскими доменными именами, которые заканчиваются на *.contoso.com*.

8. Щелкните **ОК**, а затем выберите **Создать**.

    ![создание ASE][1]

В колонке **Виртуальная сеть** есть параметр **Конфигурация виртуальной сети**. Он позволяет выбрать внешний или внутренний виртуальный IP-адрес. По умолчанию используется значение **Внешний**. Если выбрать значение **Внешний**, для среды службы приложений будет использоваться виртуальный IP-адрес, доступный из Интернета. Если выбрать **внутренний** виртуальный IP-адрес, то для ASE будет настроена внутренний балансировщик нагрузки с IP-адресом в виртуальной сети.

После выбора варианта **Внутренний** возможность добавлять дополнительные IP-адреса для среды службы приложений исчезнет. Вместо этого необходимо будет указать домен ASE. В ASE с внешним виртуальным IP-адресом имя среды указывается в домене для приложений, создаваемых в этой среде.

Если указан **Внутренний** **виртуальный IP-адрес**, имя среды ASE не используется в имени домена для этой среды. В этом случае домен указывается явным образом. Если используется домен *contoso.corp.net* и вы создали в этой среде ASE приложение с именем *timereporting*, URL-адрес этого приложения будет выглядеть так: timereporting.contoso.corp.net.


## <a name="create-an-app-in-an-ilb-ase"></a>Создание приложения в ASE с внутренним балансировщиком нагрузки ##

Создание приложения в обычной среде ASE и в ASE с внутренним балансировщиком нагрузки ничем не отличается.

1. На портале Azure выберите **Создать ресурс** > **Интернет и мобильные устройства** > **Интернет** или **Mobile** (Мобильные устройства) либо **Приложение API**.

2. Введите имя приложения.

3. Выберите подписку.

4. Выберите или создайте группу ресурсов.

5. Выбор или создание плана службы приложений Если необходимо создать план службы приложений, выберите свою среду ASE в качестве расположения. Выберите рабочий пул, в котором будет создан этот план. При создании плана службы приложений следует выбрать ASE в качестве расположения и рабочий пул. При указании имени приложения домен в имени вашего приложения заменяется доменом ASE.

6. Нажмите кнопку **Создать**. Если требуется отобразить приложение на панели мониторинга, следует установить флажок **Закрепить на панели мониторинга**.

    ![Создание плана служб приложений][2]

    Доменное имя в **имени приложения** обновится с учетом домена ASE.

## <a name="post-ilb-ase-creation-validation"></a>Проверка после создания ASE с внутренним балансировщиком нагрузки ##

ASE с внутренним балансировщиком нагрузки немного отличается от ASE без такового. Как уже было сказано, вам нужно управлять собственной службой DNS. Также необходимо предоставить собственный сертификат для подключений по протоколу HTTPS.

После создания среды ASE вы заметите, что в доменном имени отображается указанный вами домен. В меню **Параметры** появился новый пункт **Сертификат ILB**. ASE создается с сертификатом, в котором не указан домен ASE с ILB. Если использовать ASE с этим сертификатом, в браузере отобразится сообщение о том, что указан недопустимый сертификат. Этот сертификат упрощает тестирование протокола HTTPS. Но вам необходимо отправить собственный сертификат, связанный с доменом ASE с внутренним балансировщиком нагрузки. Этот шаг является обязательным независимо от типа сертификата: самозаверяющий или получен из ЦС.

![Имя домена ASE с ILB][3]

Для ASE с внутренним балансировщиком нагрузки требуется допустимый сертификат SSL. Можно получить сертификат от внутреннего центра сертификации, приобрести его у внешнего поставщика и использовать самозаверяющий сертификат. Независимо от источника SSL-сертификата для него необходимо соответствующим образом настроить следующие атрибуты:

* **Subject** — для этого атрибута необходимо задать значение *.имя_корневого_домена.
* **Subject Alternative Name** — этот атрибут должен содержать два значения: **.имя_корневого_домена* и **.scm.имя_корневого_домена*. Для SSL-соединения с сайтом SCM или Kudu, связанным с каждым приложением, будет использоваться адрес в формате *имя_приложения.scm.имя_корневого_домена*.

SSL-сертификат необходимо преобразовать в PFX-файл и сохранить в таком формате. PFX-файл должен содержать все промежуточные и корневые сертификаты. Защитите его паролем.

Чтобы создать собственный сертификат, можно использовать приведенные ниже команды PowerShell. Обязательно укажите доменное имя среды ASE с ILB вместо *internal.contoso.com*. 

    $certificate = New-SelfSignedCertificate -certstorelocation cert:\localmachine\my -dnsname "*.internal-contoso.com","*.scm.internal-contoso.com"
    
    $certThumbprint = "cert:\localMachine\my\" +$certificate.Thumbprint
    $password = ConvertTo-SecureString -String "CHANGETHISPASSWORD" -Force -AsPlainText
    
    $fileName = "exportedcert.pfx" 
    Export-PfxCertificate -cert $certThumbprint -FilePath $fileName -Password $password

Сертификат, созданный с помощью этих команд PowerShell, по-прежнему будет вызывать ошибку в браузерах, так как он не был создан ЦС из цепочки сертификатов браузера. Чтобы получить сертификат, которому доверяет браузер, необходимо приобрести его в коммерческом ЦС из цепочки сертификатов браузера. 

![Задание сертификата ILB][4]

Чтобы отправить сертификаты и протестировать доступ, сделайте следующее:

1. Перейдите к пользовательскому интерфейсу среды ASE после ее создания. Выберите **ASE** > **Параметры** > **Сертификат ILB**.

2. Задайте сертификат ILB, выбрав PFX-файл сертификата, и введите пароль. На выполнение этой операции потребуется некоторое время. Появится сообщение о том, что выполняется отправка.

3. Получите адрес ILB для ASE. Выберите **ASE** > **Свойства** > **Виртуальный IP-адрес**.

4. Создайте веб-приложение в среде ASE после ее создания.

5. Создайте виртуальную машину в этой виртуальной сети (если вы этого еще не сделали).

    > [!NOTE] 
    > Не создавайте виртуальную машину в одной подсети с ASE. В противном случае настройка будет прервана или возникнут проблемы.
    >
    >

6. Задайте DNS для домена среды ASE. Можно указать в DNS подстановочные знаки с именем домена. Чтобы выполнить несколько простых проверок, можно изменить файл hosts на виртуальной машине, чтобы в качестве имени веб-приложения задать виртуальный IP-адрес.

    a. Если доменное имя вашей среды ASE — _.ilbase.com_ и вы создали веб-приложение с именем _mytestapp_, его адрес — _mytestapp.ilbase.com_. Позднее вы настроите разрешение имени _mytestapp.ilbase.com_ в адрес ILB. (В Windows файл hosts находится в папке C:\Windows\System32\drivers\…\_)

    Б. Чтобы протестировать публикацию веб-развертывания или доступ к расширенной консоли, создайте запись для _mytestapp.scm.ilbase.com_.

7. Воспользуйтесь браузером на этой виртуальной машине и перейдите по адресу http://mytestapp.ilbase.com. (Или перейдите к любому имени веб-приложения в вашем домене.)

8. Воспользуйтесь браузером на этой виртуальной машине и перейдите по адресу https://mytestapp.ilbase.com. Если используется самозаверяющий сертификат, учтите, что уровень безопасности будет снижен.

    IP-адрес ILB указан в разделе **IP-адреса**. В нем также указаны внешние виртуальные IP-адреса и IP-адреса для входящего трафика управления.

    ![IP-адрес ILB][5]

## <a name="web-jobs-functions-and-the-ilb-ase"></a>Веб-задания, функции и ASE с ILB ##

Функции и веб-задания поддерживаются в ASE с ILB, но чтобы работать с ними на портале, необходимо иметь сетевой доступ к сайту диспетчера служб.  Это означает, что браузер должен быть запущен на узле, который либо находится в виртуальной сети, либо подключен к ней.  

При использовании Функций Azure в среде ASE с ILB может возникнуть сообщение об ошибке "Сейчас не удается извлечь ваши функции. Повторите попытку позже". Эта ошибка возникает, так как пользовательский интерфейс функций использует сайт диспетчера служб через протокол HTTPS, а корневой сертификат не находится цепочке сертификатов браузера. Веб-задания могут вызывать подобную проблему. Чтобы избежать этой проблемы, выполните одно из следующих действий.

- Добавьте сертификат в хранилище доверенных сертификатов. Это позволит разблокировать Edge и Internet Explorer.
- Сначала в Chrome перейдите на сайт диспетчера служб, примите недоверенный сертификат, а затем перейти на портал.
- Используйте коммерческий сертификат, который находится в цепочке сертификатов браузера.  Это наилучший вариант.  

## <a name="dns-configuration"></a>Настройка DNS ##

При использовании внешнего виртуального IP-адреса службой DNS управляет Azure. Любое приложение, созданное в ASE, автоматически добавляется в службу DNS Azure, которая является общедоступной. В ASE с ILB необходимо управлять собственной службой DNS. Для заданного домена, например _contoso.net_, необходимо создать записи А в DNS, указывающие на адрес ILB, для:

- *.contoso.net;
- *.scm.contoso.net.

Если домен среды ASE с ILB используется для нескольких операций за пределами этой среды, может потребоваться управлять службой DNS для каждого имени приложения. Это усложняет задачу, так как необходимо добавлять имя каждого нового приложения в службу DNS при его создании. По этой причине рекомендуется использовать выделенный домен.

## <a name="publish-with-an-ilb-ase"></a>Публикация с использованием ASE с внутренним балансировщиком нагрузки ##

Для каждого создаваемого приложения предоставляются две конечные точки. В ASE с ILB это *&lt;имя_приложения>.&lt;домен_ASE_с_ILB>* и *&lt;имя_приложения>.scm.&lt;домен_ASE_с_ILB>*. 

Если выбрать имя сайта SCM, вы перейдете в консоль Kudu, которая называется **расширенным порталом**, на портале Azure. Консоль Kudu позволяет просматривать переменные среды, просматривать данные диска, использовать консоль и многое другое. Дополнительные сведения см. на странице, посвященной [консоли Kudu для службы приложений Azure][Kudu]. 

В мультитенантной службе приложений и внешней среде ASE применяется единый вход между порталом Azure и консолью Kudu. Тем не менее в среде ASE с ILB необходимо использовать учетные данные публикации для входа в консоль Kudu.

Веб-системы непрерывной интеграции, такие как GitHub и Visual Studio Team Services, не работают со средой ASE с ILB, так как конечная точка публикации недоступна через Интернет. Вместо этого необходимо использовать систему непрерывной интеграции, в которой применяется модель полного извлечения, например Dropbox.

Для конечных точек публикации приложений в среде ASE с ILB используется домен, созданный вместе со средой. Этот домен можно увидеть в профиле публикации приложения и в колонке приложения на портале (в разделе **Обзор** > **Основное** и в разделе **Свойства**). При наличии среды ASE с ILB с поддоменом *contoso.net* и приложения с именем *mytest* вы перейдете по протоколу FTP по адресу *mytest.contoso.net* и выполните веб-развертывание по адресу *mytest.scm.contoso.net*.

## <a name="couple-an-ilb-ase-with-a-waf-device"></a>Взаимозависимость среды ASE с внутренним балансировщиком нагрузки и устройства WAF ##

Служба приложений Azure предоставляет множество мер безопасности для защиты системы. Она также помогает определить, было ли взломано приложение. Лучший способ защиты веб-приложения — создание зависимости между платформой размещения, например службой приложений Azure, и брандмауэром веб-приложения (WAF). Так как конечная точка приложения в среде ASE с ILB изолирована от сети, этот способ подойдет идеально.

Дополнительные сведения о настройке ASE с ILB и устройства WAF см. в статье [Настройка брандмауэра веб-приложения (WAF) для среды службы приложений][ASEWAF]. В этой статье объясняется, как использовать виртуальный модуль Barracuda со средой ASE. Другой способ — использовать шлюз приложений Azure. Шлюз приложений использует основные правила OWASP для защиты всех приложений, размещенных за этим шлюзом. Дополнительные сведения о шлюзе приложений см. в статье [Брандмауэр веб-приложения (WAF)][AppGW].

## <a name="get-started"></a>Начало работы ##

* Сведения о том, как начать работу со средами службы приложений, см. в статье [Общие сведения о среде службы приложений][Intro].
 
<!--Image references-->
[1]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-network.png
[2]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-webapp.png
[3]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-certificate.png
[4]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-certificate2.png
[5]: ./media/creating_and_using_an_internal_load_balancer_with_app_service_environment/createilbase-ipaddresses.png

<!--Links-->
[Intro]: ./intro.md
[MakeExternalASE]: ./create-external-ase.md
[MakeASEfromTemplate]: ./create-from-template.md
[MakeILBASE]: ./create-ilb-ase.md
[ASENetwork]: ./network-info.md
[UsingASE]: ./using-an-ase.md
[UDRs]: ../../virtual-network/virtual-networks-udr-overview.md
[NSGs]: ../../virtual-network/virtual-networks-nsg.md
[ConfigureASEv1]: app-service-web-configure-an-app-service-environment.md
[ASEv1Intro]: app-service-app-service-environment-intro.md
[webapps]: ../app-service-web-overview.md
[mobileapps]: ../../app-service-mobile/app-service-mobile-value-prop.md
[Functions]: ../../azure-functions/index.yml
[Pricing]: http://azure.microsoft.com/pricing/details/app-service/
[ARMOverview]: ../../azure-resource-manager/resource-group-overview.md
[ConfigureSSL]: ../web-sites-purchase-ssl-web-site.md
[Kudu]: http://azure.microsoft.com/resources/videos/super-secret-kudu-debug-console-for-azure-web-sites/
[ASEWAF]: app-service-app-service-environment-web-application-firewall.md
[AppGW]: ../../application-gateway/application-gateway-web-application-firewall-overview.md
[customdomain]: ../app-service-web-tutorial-custom-domain.md
