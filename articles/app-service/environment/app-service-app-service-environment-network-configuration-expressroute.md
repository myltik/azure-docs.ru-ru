---
title: Сведения о настройке сети для работы с Express Route
description: Сведения о настройке сети для выполнения сред службы приложений в виртуальных сетях, подключенных к каналу ExpressRoute.
services: app-service
documentationcenter: ''
author: stefsch
manager: nirma
editor: ''
ms.assetid: 34b49178-2595-4d32-9b41-110c96dde6bf
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/14/2016
ms.author: stefsch
ms.openlocfilehash: fcb9fa9004039205fa49f63c50d5907a8029a079
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32153224"
---
# <a name="network-configuration-details-for-app-service-environments-with-expressroute"></a>Сведения о конфигурации сети для сред службы приложений с ExpressRoute
## <a name="overview"></a>Обзор
Клиенты могут подключить канал [Azure ExpressRoute][ExpressRoute] к своей инфраструктуре виртуальной сети, расширяя таким образом локальную сеть в Azure.  Среду службы приложений можно создать в подсети этой инфраструктуры [виртуальной сети][virtualnetwork].  Затем с помощью приложений, работающих в среде службы приложений, можно установить безопасное подключение к серверным ресурсам, доступным только через соединение ExpressRoute.  

Среду службы приложений можно создать **либо** в виртуальной сети Azure Resource Manager, **либо** в виртуальной сети, использующей классическую модель развертывания.  В связи с последним изменением от июня 2016 г. среды ASE теперь можно также развертывать в виртуальных сетях, использующих либо диапазоны общедоступных адресов, либо адресные пространства RFC1918 (т. е. частные адреса). 

[!INCLUDE [app-service-web-to-api-and-mobile](../../../includes/app-service-web-to-api-and-mobile.md)]

## <a name="required-network-connectivity"></a>Необходимое сетевое подключение
Существуют требования к сетевому подключению для среды службы приложений, которым изначально может не соответствовать виртуальная сеть, подключенная к ExpressRoute.  Для правильной работы среды службы приложений необходимы следующие компоненты.

* Исходящие сетевые подключения к конечным точкам службы хранилища Azure по всему миру на портах 80 и 443.  Сюда входят конечные точки, находящиеся в одном регионе со средой службы приложений, а также конечные точки хранилища, расположенные в **других** регионах Azure.  Конечные точки службы хранилища Azure разрешаются в следующих DNS-доменах: *table.core.windows.net*, *blob.core.windows.net*, *queue.core.windows.net* и *file.core.windows.net*.  
* Исходящее сетевое подключение к службе файлов Azure через порт 445.
* Исходящие сетевые подключения к конечным точкам баз данных SQL, которые находятся в одном регионе со средой службы приложений.  Конечные точки баз данных SQL разрешаются в следующем домене: *database.windows.net*.  Для этого необходимо открыть доступ к портам 1433, 11000–11999 и 14000–14999.  Дополнительные сведения см. в статье, посвященной [использованию порта базы данных SQL версии 12](../../sql-database/sql-database-develop-direct-route-ports-adonet-v12.md).
* Исходящие сетевые подключения к конечным точкам плоскости управления Azure (конечные точки ASM и ARM).  В том числе исходящие подключения к *management.core.windows.net* и *management.azure.com*. 
* Исходящие сетевые подключения к *ocsp.msocsp.com*, *mscrl.microsoft.com* и *crl.microsoft.com*.  Это необходимо для поддержки функций протокола SSL.
* Конфигурация DNS для виртуальной сети должна поддерживать разрешение всех конечных точек и доменов, указанных в предыдущих точках.  Если эти конечные точки разрешить нельзя, попытка создания среды службы приложений завершится ошибкой, а существующие среды службы приложений будут помечены как неработоспособные.
* Исходящий доступ через порт 53 необходим для обмена данными с DNS-серверами.
* Если на другой стороне VPN-шлюза имеется пользовательский DNS-сервер, этот сервер должен быть доступен из подсети, в которой находится среда службы приложений. 
* Путь для исходящих сетевых подключений не может проходить через внутренние корпоративные прокси и не может принудительно туннелироваться в локальную среду,  потому что в этом случае меняется действующий адрес NAT для исходящего сетевого трафика из среды службы приложений.  Изменение адреса NAT для исходящего сетевого трафика среды службы приложений приведет к появлению проблем подключения ко многим указанным выше конечным точкам.  Это приведет к неудачным попыткам создания среды службы приложений, а также присвоению ранее работоспособной среде службы приложений статуса неработоспособной.  
* Необходимо предоставить разрешения для входящих сетевых подключений на нужных портах для сред службы приложений согласно процедуре, описанной в этой [статье][requiredports].

Требования DNS обеспечиваются за счет создания допустимой инфраструктуры DNS и ее поддержания для виртуальной сети.  Если после создания среды службы приложений по какой-либо причине меняется конфигурация DNS, разработчик может принудительно задать выбор новой конфигурации DNS в среде службы приложений.  Если перезагрузить разворачиваемую среду, используя значок "Перезапуск", расположенный в верхней части колонки управления средой службы приложений на [классическом портале Azure][NewPortal], будет выбрана новая конфигурация DNS в среде.

Требования ко входящим сетевым подключениям можно выполнить, настроив [группу безопасности сети][NetworkSecurityGroups] в подсети среды службы приложений. Дополнительные сведения о предоставлении необходимого доступа см. в этой [статье][requiredports].

## <a name="enabling-outbound-network-connectivity-for-an-app-service-environment"></a>Активация исходящего сетевого подключения для среды службы приложений
По умолчанию только что созданный канал ExpressRoute объявляет основной маршрут, который позволяет создавать исходящее подключение к Интернету.  С такой конфигурацией среда службы приложений сможет подключаться к другим конечным точкам Azure.

Тем не менее в типовой клиентской конфигурации определяется собственный основной маршрут (0.0.0.0/0), который вместо этого направляет исходящий интернет-трафик в локальную среду.  Этот поток трафика постоянно прерывает среды службы приложений, поскольку исходящий трафик заблокирован локально или транслирован с помощью NAT в нераспознаваемый набор адресов, которые больше не относятся к различным конечным точкам Azure.

Чтобы решить проблему, следует указать один или несколько определяемых пользователем маршрутов в подсети, которая содержит среду службы приложений.  Определяемые пользователем маршруты задают маршруты для подсети, которые будут использоваться вместо основного маршрута.

При возможности рекомендуется использовать следующую конфигурацию:

* Конфигурация ExpressRoute объявляет маршрут 0.0.0.0/0 и по умолчанию организует принудительное туннелирование всех исходящих подключений в локальную среду.
* UDR, примененный к подсети, содержащей среду службы приложений, задает маршрут 0.0.0.0/0 со следующим переходом типа «Интернет» (пример см. ниже в этой статье).

В результате этих действий UDR уровня подсети будет иметь приоритет над принудительным туннелированием ExpressRoute, обеспечивая исходящий интернет-доступ из среды службы приложений.

> [!IMPORTANT]
> Маршруты, указанные в UDR, **должны** быть достаточно конкретными, чтобы иметь приоритет над всеми маршрутами, объявленными в конфигурации ExpressRoute.  В приведенном ниже примере используется широкий диапазон адресов 0.0.0.0/0, и, таким образом, он может быть случайно заменен объявлениями маршрутов с более узкими диапазонами адресов.
> 
> Среды службы приложений с конфигурациями ExpressRoute, **осуществляющие перекрестное объявление маршрутов из пути общедоступного пиринга в путь частного пиринга**, не поддерживаются.  Конфигурации ExpressRoute, для которых настроен общедоступный пиринг, будут получать объявления маршрутов от корпорации Майкрософт для большого набора диапазонов IP-адресов Microsoft Azure.  Если эти диапазоны адресов перекрестно объявляются по пути закрытого пиринга, то все исходящие сетевые пакеты из подсети среды службы приложений будут принудительно туннелироваться в локальную сетевую инфраструктуру клиента.  В настоящее время этот сетевой поток не поддерживается в среде службы приложений.  Чтобы решить эту проблему, необходимо остановить перекрестное объявление маршрутов между путем общедоступного и закрытого пиринга.
> 
> 

Справочные сведения об определяемых пользователем маршрутах см. в этом [обзоре][UDROverview].  

Сведения о создании и настройке определяемых пользователем маршрутов см. в этом [руководстве][UDRHowTo].

## <a name="example-udr-configuration-for-an-app-service-environment"></a>Пример настройки UDR для среды службы приложений
**Предварительные требования**

1. Скачайте Azure Powershell на [странице загружаемых файлов Azure][AzureDownloads] (за июнь 2015 г. или позже).  В разделе "Средства командной строки" выберите ссылку "Установка" в разделе Windows Powershell, чтобы установить последние командлеты Powershell.
2. Мы рекомендуем создать уникальную подсеть для монопольного использования средой службы приложений.  В этом случае маршруты UDR, используемые в подсети, будут открывать только исходящий трафик для среды службы приложений.
3. **Важно!** Не развертывайте среду службы приложений, **не** выполнив следующих действий по настройке.  Это гарантирует наличие исходящего сетевого подключения до развертывания среды службы приложений.

**Шаг 1. Создание именованной таблицы маршрутов**

Следующий фрагмент кода создает таблицу маршрутов с именем DirectInternetRouteTable в регионе Azure Запад США.

    New-AzureRouteTable -Name 'DirectInternetRouteTable' -Location uswest

**Шаг 2. Создание одного или нескольких маршрутов в таблице**

Чтобы включить исходящий доступ к Интернету, в таблицу необходимо добавить один или несколько маршрутов.  

При настройке исходящих интернет-подключений рекомендуется задать маршрут 0.0.0.0/0, как показано ниже.

    Get-AzureRouteTable -Name 'DirectInternetRouteTable' | Set-AzureRoute -RouteName 'Direct Internet Range 0' -AddressPrefix 0.0.0.0/0 -NextHopType Internet

Помните, что 0.0.0.0/0 — это широкий диапазон адресов, поэтому он будет замещен более узкими диапазонами адресов, объявленными в ExpressRoute.  Повторим уже упоминавшуюся рекомендацию: UDR с маршрутом 0.0.0.0/0 следует использовать вместе с конфигурацией ExressRoute, которая также объявляет лишь 0.0.0.0/0. 

В качестве альтернативы можно загрузить полный и обновленный список диапазонов CIDR, используемый Azure.  XML-файл, содержащий все диапазоны IP-адресов Azure, доступен в [Центре загрузки Майкрософт][DownloadCenterAddressRanges].  

Тем не менее обратите внимание, что эти диапазоны иногда меняются, поэтому определяемые пользователем маршруты нужно периодически обновлять вручную.  Кроме того, в одном определяемом пользователем маршруте верхний предел по умолчанию составляет 100 маршрутов, поэтому потребуется "объединить" диапазоны IP-адресов Azure в соответствии с ограничением на 100 маршрутов, не забывая о том, что маршруты, определенные в UDR, должны быть более точными, чем маршруты, объявленные в ExpressRoute.  

**Шаг 3. Привязка таблицы маршрутов к подсети, содержащей среду службы приложений**

В последнем шаге настройки таблицу маршрутов необходимо привязать к подсети, в которой будет развернута среда службы приложений.  Следующая команда привязывает DirectInternetRouteTable к ASESubnet, которая в конечном итоге будет содержать среду службы приложений.

    Set-AzureSubnetRouteTable -VirtualNetworkName 'YourVirtualNetworkNameHere' -SubnetName 'ASESubnet' -RouteTableName 'DirectInternetRouteTable'


**Шаг 4. Заключительные действия**

После привязки таблицы маршрутов к подсети мы рекомендуем сначала выполнить тестирование и убедиться в требуемом результате.  Например, разверните виртуальную машину в подсети и убедитесь в следующем, что следующие утверждения верны.

* Исходящий трафик на конечные точки Azure и другие, указанные выше в этой статье, **не** проходит по кругу ExpressRoute.  Очень важно убедиться, что это так, поскольку, если исходящий трафик из подсети по-прежнему принудительно туннелируется в локальную среду, все попытки создать среду службы приложений завершатся неудачей. 
* Все уточняющие запросы DNS для конечных точек, упомянутых выше, разрешаются правильно. 

После подтверждения описанных выше действий нужно будет удалить виртуальную машину, поскольку подсеть должна быть «пустой» во время создания среды службы приложений.

После этого продолжите создание среды службы приложений.

## <a name="getting-started"></a>Приступая к работе
Сведения о том, как начать работу со средами службы приложений, см. в статье [Введение в среду службы приложений][IntroToAppServiceEnvironment].

<!-- LINKS -->
[virtualnetwork]: http://azure.microsoft.com/services/virtual-network/
[ExpressRoute]: http://azure.microsoft.com/services/expressroute/
[requiredports]: app-service-app-service-environment-control-inbound-traffic.md
[NetworkSecurityGroups]: http://azure.microsoft.com/documentation/articles/virtual-networks-nsg/
[UDROverview]: http://azure.microsoft.com/documentation/articles/virtual-networks-udr-overview/
[UDRHowTo]: http://azure.microsoft.com/documentation/articles/virtual-networks-udr-how-to/
[HowToCreateAnAppServiceEnvironment]: app-service-web-how-to-create-an-app-service-environment.md
[AzureDownloads]: http://azure.microsoft.com/downloads/ 
[DownloadCenterAddressRanges]: http://www.microsoft.com/download/details.aspx?id=41653  
[NetworkSecurityGroups]: https://azure.microsoft.com/documentation/articles/virtual-networks-nsg/
[IntroToAppServiceEnvironment]:  app-service-app-service-environment-intro.md
[NewPortal]:  https://portal.azure.com


<!-- IMAGES -->
