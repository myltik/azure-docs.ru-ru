---
title: Рекомендации по работе с сетями при помощи среды службы приложений Azure
description: Сведения о трафике в среде ASE, а также установке групп NSG и определяемых пользователем маршрутов при ее помощи
services: app-service
documentationcenter: na
author: ccompy
manager: stefsch
ms.assetid: 955a4d84-94ca-418d-aa79-b57a5eb8cb85
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/20/2018
ms.author: ccompy
ms.openlocfilehash: d099163cdc34624afd8f01b8f1978c5ee902d1ff
ms.sourcegitcommit: b6319f1a87d9316122f96769aab0d92b46a6879a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2018
---
# <a name="networking-considerations-for-an-app-service-environment"></a>Рекомендации по работе с сетями в среде службы приложений #

## <a name="overview"></a>Обзор ##

 [Среда службы приложений][Intro] — это развернутая служба приложений Azure в подсети виртуальной сети Azure. Есть два типа развертывания для среды службы приложений (ASE):

- **Внешняя ASE** — предоставляет приложения, размещенные в ASE, по доступному в Интернете IP-адресу. Дополнительные сведения см. в разделе о [создании внешней среды ASE][MakeExternalASE].
- **ASE с ILB** — предоставляет приложения в ASE по IP-адресу в вашей виртуальной сети Azure. Внутренняя конечная точка является внутренним балансировщиком нагрузки (ILB). Поэтому среда называется ASE с ILB. Дополнительные сведения см. в статье о [создании и использовании ILB для ASE][MakeILBASE].

В настоящее время существует две версии среды службы приложений: ASEv1 и ASEv2. Сведения об ASEv1 см. в статье [Введение в среду службы приложения][ASEv1Intro]. ASEv1 можно развернуть в классической виртуальной сети или в виртуальной сети Resource Manager. ASEv2 можно развернуть только в виртуальной сети Resource Manager.

Все вызовы из ASE поступают в Интернет через виртуальный IP-адрес виртуальной сети, присвоенный ASE. Общедоступным IP-адресом этого виртуального IP-адреса является исходный IP-адрес для всех вызовов из ASE, поступающих в Интернет. Если приложения в вашей среде ASE отправляют вызовы к ресурсам в виртуальной сети или в VPN, то исходный IP-адрес является одним из IP-адресов в подсети, используемой ASE. Среда ASE размещена в виртуальной сети, и ее ресурсы доступны для ASE без дополнительной настройки. Если виртуальная сеть подключена к локальной сети, то ее ресурсы также доступны для приложений в среде ASE. Дополнительно настраивать ASE или приложения не требуется.

![Внешняя среда ASE][1] 

При использовании внешней ASE общедоступный виртуальный IP-адрес также является конечной точкой, с которой приложения ASE сопоставляют данные для:

* HTTP/S; 
* FTP/S; 
* веб-развертывания;
* удаленной отладки.

![Среда ASE с ILB][2]

При использовании ASE с ILB конечной точкой для HTTP/S, FTP/S, веб-развертывания и удаленной отладки является IP-адрес ILB.

Стандартные порты доступа для приложения:

| Использование | Из | Кому |
|----------|---------|-------------|
|  HTTP/HTTPS  | Настраивается пользователем |  80, 443 |
|  FTP/FTPS    | Настраивается пользователем |  21, 990, 10001-10020 |
|  Удаленная отладка в Visual Studio  |  Настраивается пользователем |  4016, 4018, 4020, 4022 |

Эти порты применимы, если используется внешняя среда ASE или ASE с ILB. Во внешней ASE переход к этим портам осуществляется по общедоступному виртуальному IP-адресу. В среде ASE с ILB переход к этим портам осуществляется в ILB. Блокировка порта 443 может повлиять на некоторые возможности, предоставляемые на портале. Дополнительные сведения см. в разделе [Зависимости портала](#portaldep).

## <a name="ase-subnet-size"></a>Размер подсети ASE ##

После развертывания ASE нельзя изменять размер подсети, используемой для размещения ASE.  В ASE используется адрес для каждой роли инфраструктуры и каждого изолированного экземпляра плана службы приложений.  Кроме того, есть 5 адресов, используемых для каждой создаваемой подсети в категории служб "Сеть Azure".  В ASE без планов службы приложений перед созданием приложения будут использоваться 12 адресов.  В ILB ASE перед созданием приложения будут использоваться 13 адресов. При масштабировании планов службы приложений потребуются дополнительные адреса для каждого добавленного внешнего интерфейса.  По умолчанию серверы переднего плана добавляются для каждых 15 общих экземпляров плана службы приложений. 

   > [!NOTE]
   > В подсети должна размещаться исключительно среда ASE. Обязательно выберите достаточно большое адресное пространство для будущего расширения. Впоследствии этот параметр уже нельзя изменить. Рекомендуемый размер — `/25` с 128 адресами.

## <a name="ase-dependencies"></a>Зависимости ASE ##

Зависимости ASE для входящего трафика:

| Использование | Из | Кому |
|-----|------|----|
| управления | Адреса управления службой приложений | Подсеть ASE: 454, 455 |
|  Внутренний обмен данными ASE | Подсеть ASE: все порты | Подсеть ASE: все порты
|  Разрешение входящего трафика Azure Load Balancer | Azure Load Balancer | Подсеть ASE: все порты
|  IP-адреса, присвоенные приложению | Адреса, присвоенные приложению | Подсеть ASE: все порты

Помимо системы мониторинга, входящий трафик обеспечивает контроль и управление ASE. Исходные IP-адреса для этого трафика перечислены в документе [Адреса управления среды службы приложений][ASEManagement]. В конфигурации безопасности сети необходимо разрешить доступ со всех IP-адресов через порты 454 и 455.

В подсети ASE существует много портов, используемых для внутреннего взаимодействия компонентов, которые можно изменять.  Для этого необходимо, чтобы все порты в подсети ASE были доступны из нее. 

Для взаимодействия между балансировщиком нагрузки Azure и подсетью ASE необходимо открыть как минимум порты 454, 455 и 16001. Порт 16001 используется для трафика проверки активности между балансировщиком нагрузки и ASE. Используя ASE с ILB, можно ограничить трафик портами 454, 455 и 16001.  При использовании внешней среды ASE необходимо учесть обычные порты доступа к приложениям.  Если вы используете адреса, присвоенные приложению, необходимо открыть его для всех портов.  Если адрес присваивается определенному приложению, балансировщик нагрузки будет заранее использовать неизвестные порты для отправки трафика HTTP и HTTPS в ASE.

Если вы используете IP-адреса, присвоенные приложению, необходимо разрешить передачу трафика с этих адресов в подсеть ASE.

Что касается доступа исходящего трафика, среда ASE зависит от различных внешних систем. Эти зависимости системы определяются при помощи DNS-имен и не сопоставляются с фиксированным набором IP-адресов. Среде ASE требуется доступ исходящего трафика из подсети ASE для всех внешних IP-адресов через различные порты. Зависимости ASE для исходящего трафика:

| Использование | Из | Кому |
|-----|------|----|
| Хранилище Azure | Подсеть ASE | table.core.windows.net, blob.core.windows.net, queue.core.windows.net, file.core.windows.net: 80, 443, 445 (445 необходим только для ASEv1) |
| Базы данных SQL Azure | Подсеть ASE | database.windows.net: 1433, 11000-11999, 14000-14999 (дополнительные сведения см. в статье об [использовании портов Базы данных SQL версии 12](../../sql-database/sql-database-develop-direct-route-ports-adonet-v12.md))|
| Управление Azure | Подсеть ASE | management.core.windows.net, management.azure.com: 443 
| Проверка сертификатов SSL |  Подсеть ASE            |  ocsp.msocsp.com, mscrl.microsoft.com, crl.microsoft.com: 443
| Azure Active Directory        | Подсеть ASE            |  Интернет: 443
| Управление службой приложений        | Подсеть ASE            |  Интернет: 443
| Azure DNS                     | Подсеть ASE            |  Интернет: 53
| Внутренний обмен данными ASE    | Подсеть ASE: все порты |  Подсеть ASE: все порты

Если у ASE нет доступа к этим зависимостям, среда прекращает работу. Если это происходит достаточно долго, ASE переходит в состояние приостановки.

### <a name="customer-dns"></a>DNS пользователя ###

Если в виртуальной сети настроен определенный пользователем DNS-сервер, то она используется для рабочих нагрузок клиента. ASE по-прежнему необходим обмен данными со службой DNS Azure в целях управления. 

Если виртуальная сеть настроена с помощью DNS пользователя на другом конце VPN, то DNS-сервер должен быть доступен из подсети, в которой размещена ASE.

<a name="portaldep"></a>

## <a name="portal-dependencies"></a>Зависимости портала ##

Помимо функциональных зависимостей ASE есть несколько дополнительных элементов, относящихся к интерфейсу портала. Некоторые возможности на портале Azure зависят от прямого доступа к _сайту диспетчера служб_. Для каждого приложения в службе приложений Azure предусмотрено два URL-адреса. Первый URL-адрес предназначен для доступа к вашему приложению. Второй URL-адрес предназначен для доступа к сайту диспетчера служб, который также называется _Консоль Kudu_. Ниже перечислены компоненты, использующие сайт диспетчера служб.

-   Веб-задания
-   Функции Azure
-   Потоковая передача журналов
-   Kudu
-   расширения.
-   Обозреватель процессов
-   Консоль

При использовании среды ASE с ILB сайт диспетчера служб недоступен через Интернет вне виртуальной сети. Если приложение размещается на ILB ASE, некоторые возможности не будут работать с портала.  

Многие возможности, зависящих от доступа к сайту диспетчера служб, доступны непосредственно в консоли Kudu. Можно подключиться к ней напрямую, не используя портал. Если приложение размещено в ASE с ILB, то войдите в систему с помощью учетных данных для публикации. Формат URL-адреса для доступа к сайту диспетчера служб из приложения, размещенного в ASE с ILB: 

```
<appname>.scm.<domain name the ILB ASE was created with> 
```

Если доменное имя вашей среды ASE с ILB — *contoso.net*, а имя приложения — *testapp*, то приложение доступно по адресу *testapp.contoso.net*. Связанный с ним сайт диспетчера служб доступен по адресу *testapp.scm.contoso.net*.

## <a name="functions-and-web-jobs"></a>Служба "Функции" и "Веб-задания" ##

Службы "Функции" и "Веб-задания" зависят от сайта SCM, но поддерживаются для использования на портале, если браузер может подключиться к сайту SCM, даже если приложения находятся в среде ASE с ILB.  При использовании самозаверяющего сертификата со средой ASE с ILB необходимо, чтобы браузер доверял этому сертификату.  Для IE и Edge это означает, что сертификат должен находиться в доверенном хранилище компьютера.  Если вы используете Chrome, то это означает, что вы приняли сертификат в браузере ранее, предположительно непосредственно на сайте SCM.  Лучше всего использовать коммерческий сертификат, который находится в цепочке доверия браузера.  

## <a name="ase-ip-addresses"></a>IP-адреса ASE ##

В среде ASE есть несколько IP-адресов, на которые следует обратить внимание. К ним относятся:

- **Общедоступный IP-адрес для входящего трафика**. Используется для трафика приложений во внешней среде ASE и трафика управления в обоих средах (внешняя ASE и ASE с ILB).
- **Общедоступный IP-адрес для исходящего трафика**. Используется в качестве IP-адреса для исходящих подключений ASE из виртуальной сети, которым не назначен маршрут VPN.
- **IP-адрес ILB**. Применяется при использовании среды ASE с ILB.
- **Присвоенные приложению адреса с SSL на основе IP**. Могут применяться, только если используется внешняя ASE и настроен SSL на основе IP-адреса.

Все эти IP-адреса можно просмотреть в ASEv2 на портале Azure в пользовательском интерфейсе ASE. Если вы используете ASE с ILB, то отображается IP-адрес для ILB.

![IP-адреса;][3]

### <a name="app-assigned-ip-addresses"></a>Присвоенные приложению IP-адреса ###

Внешняя ASE позволяет назначать IP-адреса отдельным приложениям. В ASE с ILB такая возможность не предусмотрена. Дополнительные сведения о настройке приложения для получения собственного IP-адреса см. в статье [Привязывание существующего настраиваемого SSL-сертификата к веб-приложениям Azure](../app-service-web-tutorial-custom-ssl.md).

Если у приложения есть собственный адрес с SSL на основе IP, ASE резервирует два порта для сопоставления с этим IP-адресом. Один порт используется для трафика HTTP, а другой — для трафика HTTPS. Эти порты указаны в разделе IP-адресов пользовательского интерфейса ASE. Порты должны быть открыты для трафика, поступающего с виртуального IP-адреса, иначе приложения будут недоступны. Это требование важно помнить при настройке групп безопасности сети (NSG).

## <a name="network-security-groups"></a>группы сетевой безопасности; ##

[Группы безопасности сети][NSGs] дают возможность управлять сетевым доступом в виртуальной сети. При использовании портала действует неявное правило всеобщего запрета с самым низким приоритетом. Поэтому необходимо создать правила разрешения.

В среде ASE нет доступа к виртуальным машинам, используемым для ее размещения. Они входят в подписку, управляемую корпорацией Майкрософт. Чтобы ограничить доступ к приложениям в ASE, задайте в подсети ASE группы безопасности сети. При этом обратите особое внимание на зависимости ASE. Блокировка любой зависимости останавливает работу ASE.

Группы NSG можно настроить на портале Azure или с помощью PowerShell. Здесь описана настройка на портале Azure. Группы NSG создаются и управляются на портале в разделе **Сеть** как ресурс верхнего уровня.

Когда учтены требования к входящему и исходящему трафику, группы безопасности сети должны быть оформлены, как показано в этом примере. Диапазон адресов в виртуальной сети — _192.168.250.0/23_, а диапазон адресов в подсети с ASE — _192.168.251.128/25_.

Первые два требования к входящему трафику для работы ASE показаны в верхней части примера. Они отвечают за управление и внутренний обмен данными в ASE. Другие записи можно настроить во всех клиентах и использовать для управления сетевым доступом к приложениям в ASE. 

![Правила безопасности для входящего трафика][4]

Правило по умолчанию активирует обмен данными между IP-адресами в виртуальной сети и подсетью ASE. Другое правило по умолчанию позволяет балансировщику нагрузки, который также называют общедоступным виртуальным IP-адресом, обмениваться данными с ASE. Чтобы просмотреть правила по умолчанию, щелкните **Правила по умолчанию** рядом со значком **Добавить**. Если поместить правило всеобщего запрета после приведенных правил группы безопасности сети, то это будет препятствовать трафику между виртуальным IP-адресом и ASE. Чтобы запретить трафик, поступающий из виртуальной сети, добавьте собственное правило для разрешения входящего трафика. Укажите для источника значение AzureLoadBalancer, для назначения — значение **Any** (Любое), а для диапазона портов — **\***. Поскольку правило группы безопасности сети применяется к подсети ASE, указывать конкретное назначение не требуется.

Если приложению присвоен IP-адрес, то убедитесь, что порты остаются открытыми. Чтобы просмотреть порты, последовательно выберите **Среда службы приложений** > **IP-адреса**.  

Требуются все элементы, показанные в следующих правилах для исходящего трафика, за исключением последнего элемента. Они обеспечивают доступ к сети для зависимостей ASE, которые упоминались ранее в этой статье. При блокировке любого из этих элементов ASE прекратит работу. Последний элемент в списке позволяет среде ASE обмениваться данными с другими ресурсами в виртуальной сети.

![Правила безопасности для исходящего трафика][5]

Определив группы безопасности сети, присвойте их подсети, в которой размещена ASE. Если вы не помните название виртуальной сети или подсети ASE, можно найти его на странице портала ASE. Чтобы присвоить подсети группу NSG, перейдите к пользовательскому интерфейсу подсети и выберите NSG.

## <a name="routes"></a>Маршруты ##

Принудительное туннелирование применяется при настройке маршрутов в виртуальной сети, чтобы исходящий трафик не направлялся не в Интернет, а куда-то еще, например в шлюз ExpressRoute или на виртуальное устройство.  Если вам нужно настроить вашей ASE таким образом, см. руководство по [настройке среды службы приложений с помощью принудительного туннелирования][forcedtunnel].  Этот документ поможет определить параметры, доступные для работы с ExpressRoute и применения принудительного туннелирования.

При создании ASE на портале мы также создадим набор таблиц маршрутов для подсети, создаваемой с использованием ASE.  По этим маршрутам исходящий трафик отправляется непосредственно в Интернет.  
Чтобы создать эти маршруты вручную, сделайте следующее:

1. Перейдите на портал Azure. Последовательно выберите **Cети** > **Таблицы маршрутов**.

2. Создайте таблицу маршрутов в том же регионе, где находится виртуальная сеть.

3. В пользовательском интерфейсе таблицы маршрутов последовательно выберите **Маршруты** > **Добавить**.

4. Задайте для параметра **Тип следующего прыжка** значение **Интернет**, а для параметра **Префикс адреса** — значение **0.0.0.0/0**. Щелкните **Сохранить**.

    Отобразится примерно следующее:

    ![Функциональные маршруты][6]

5. Создав таблицу маршрутов, перейдите к подсети со средой ASE. Выберите свою таблицу маршрутов из списка на портале. После сохранения изменений отобразится список групп безопасности сети и маршрутов, указанных в подсети.

    ![Группы безопасности сети и маршруты][7]

## <a name="service-endpoints"></a>Конечные точки службы ##

Конечные точки службы позволяют ограничить доступ к мультитенантным службам для набора виртуальных сетей и подсетей. Дополнительные сведения о конечных точках службы см. в статье [Конечные точки службы виртуальной сети][serviceendpoints]. 

При включении конечных точек службы в ресурс создаются маршруты с более высоким приоритетом. Если вы используете конечные точки службы с принудительным туннелированием ASE, трафик управления Azure SQL и хранилища Azure принудительно не туннелируется. 

Если конечные точки службы включены в подсеть с экземпляром Azure SQL, все экземпляры Azure SQL, подключенные к этой подсети, должны содержать конечные точки службы. Если вы хотите получить доступ к нескольким экземплярам Azure SQL в той же подсети, нельзя включать конечные точки службы только в один экземпляр Azure SQL. Работа хранилища Azure отличается от Azure SQL. При включении конечных точек службы в хранилище Azure, доступ к этому ресурсу из подсети блокируется, но он по-прежнему доступен для других учетных записей хранилища Azure, даже если они не содержат конечных точек службы.  

![Конечные точки службы][8]

<!--Image references-->
[1]: ./media/network_considerations_with_an_app_service_environment/networkase-overflow.png
[2]: ./media/network_considerations_with_an_app_service_environment/networkase-overflow2.png
[3]: ./media/network_considerations_with_an_app_service_environment/networkase-ipaddresses.png
[4]: ./media/network_considerations_with_an_app_service_environment/networkase-inboundnsg.png
[5]: ./media/network_considerations_with_an_app_service_environment/networkase-outboundnsg.png
[6]: ./media/network_considerations_with_an_app_service_environment/networkase-udr.png
[7]: ./media/network_considerations_with_an_app_service_environment/networkase-subnet.png
[8]: ./media/network_considerations_with_an_app_service_environment/serviceendpoint.png

<!--Links-->
[Intro]: ./intro.md
[MakeExternalASE]: ./create-external-ase.md
[MakeASEfromTemplate]: ./create-from-template.md
[MakeILBASE]: ./create-ilb-ase.md
[ASENetwork]: ./network-info.md
[UsingASE]: ./using-an-ase.md
[UDRs]: ../../virtual-network/virtual-networks-udr-overview.md
[NSGs]: ../../virtual-network/security-overview.md
[ConfigureASEv1]: app-service-web-configure-an-app-service-environment.md
[ASEv1Intro]: app-service-app-service-environment-intro.md
[mobileapps]: ../../app-service-mobile/app-service-mobile-value-prop.md
[Functions]: ../../azure-functions/index.yml
[Pricing]: http://azure.microsoft.com/pricing/details/app-service/
[ARMOverview]: ../../azure-resource-manager/resource-group-overview.md
[ConfigureSSL]: ../web-sites-purchase-ssl-web-site.md
[Kudu]: http://azure.microsoft.com/resources/videos/super-secret-kudu-debug-console-for-azure-web-sites/
[ASEWAF]: app-service-app-service-environment-web-application-firewall.md
[AppGW]: ../../application-gateway/application-gateway-web-application-firewall-overview.md
[ASEManagement]: ./management-addresses.md
[serviceendpoints]: ../../virtual-network/virtual-network-service-endpoints-overview.md
[forcedtunnel]: ./forced-tunnel-support.md
[serviceendpoints]: ../../virtual-network/virtual-network-service-endpoints-overview.md
