---
title: Создание и использование внутренней подсистемы балансировки нагрузки в среде службы приложений | Документация Майкрософт
description: Создание и использование ASE с внутренним балансировщиком нагрузки.
services: app-service
documentationcenter: ''
author: ccompy
manager: stefsch
editor: ''
ms.assetid: ad9a1e00-d5e5-413e-be47-e21e5b285dbf
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: ccompy
ms.openlocfilehash: f7c94b790c6aa7c75c62fd05671f016b7185b2a2
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2018
ms.locfileid: "29388821"
---
# <a name="using-an-internal-load-balancer-with-an-app-service-environment"></a>Использование внутреннего балансировщика нагрузки в среде службы приложений

> [!NOTE] 
> Эта статья посвящена среде службы приложений версии 1. Имеется более новая версия среды службы приложений, которая проще в использовании и которая работает на более мощной инфраструктуре. Чтобы узнать больше о новой версии, начните с изучения статьи [Введение в среду службы приложения](intro.md).
>

Среда службы приложений (ASE) — это функция службы приложений Azure уровня служб "Премиум", которая предоставляет возможность расширенной настройки, недоступную в мультитенантных метках. Функция ASE фактически развертывает службу приложений Azure в виртуальной сети Azure. Чтобы узнать больше о возможностях, доступных в средах службы приложений, см. сведения в статье [Введение в среду службы приложения][WhatisASE]. Если вам неизвестны преимущества работы в виртуальной сети, прочитайте статью [Часто задаваемые вопросы о виртуальной сети Azure][virtualnetwork]. 

## <a name="overview"></a>Обзор
ASE может развертываться с конечной точкой, доступной из Интернета, или IP-адресом в вашей виртуальной сети. Чтобы в качестве адреса виртуальной сети задать IP-адрес, необходимо развернуть ASE с внутренним балансировщиком нагрузки (ILB). Настройка среды ASE с внутренним балансировщиком нагрузки обеспечивает следующие возможности.

* Ваш собственный домен или поддомен. Чтобы упростить процесс, в данном документе предполагается поддомен, но вы можете настроить и домен. 
* Сертификат, используемый для HTTPS.
* Управление DNS для поддомена. 

Это дает следующие возможности:

* безопасное размещение в облаке приложений из интрасети, например бизнес-приложений, доступ к которым осуществляется через VPN-подключение "сеть — сеть" или ExpressRoute;
* размещение в облаке приложений, которые не указаны на общедоступных DNS-серверах;
* создание изолированных от Интернета внутренних приложений, с которыми можно безопасно интегрировать свои внешние приложения.

#### <a name="disabled-functionality"></a>Отключенные функциональные возможности
Существуют некоторые функции, недоступные при использовании ASE с внутренним балансировщиком нагрузки. К ним относятся:

* использование SSL на основе IP;
* назначение IP-адресов конкретным приложениям;
* приобретение и использование сертификата с приложением на портале. Разумеется, по-прежнему можно получить сертификаты непосредственно в центре сертификации и использовать их с приложениями, но не на портале Azure.

## <a name="creating-an-ilb-ase"></a>Создание ASE с внутренним балансировщиком нагрузки
Создание ASE с внутренним балансировщиком нагрузки не сильно отличается от создания ASE обычным образом. Более подробно создание ASE рассматривается в статье [Как создать среду службы приложений версии 1][HowtoCreateASE]. В процессе создания ASE с внутренним балансировщиком нагрузки точно так же создается новая или выбирается существующая виртуальная сеть. Чтобы создать ASE с внутренним балансировщиком нагрузки, выполните следующее. 

1. На портале Azure выберите **Создать ресурс -> Интернет и мобильные устройства -> Среда службы приложений**.
2. Выберите свою подписку.
3. Выберите или создайте группу ресурсов.
4. Выберите или создайте виртуальную сеть.
5. Создайте подсеть, если была выбрана виртуальная сеть.
6. Выберите **Виртуальная сеть/Расположение > Конфигурация виртуальной сети** и задайте тип виртуального IP-адреса "Внутренний".
7. Введите имя поддомена (он будет использоваться для приложений, созданных в этой ASE).
8. Нажмите кнопку **ОК**, а затем — **Создать**.

![][1]

В области виртуальной сети находится параметр конфигурации виртуальной сети, который позволяет выбрать между внешним и внутренним виртуальными IP-адресами. По умолчанию используется внешний виртуальный IP-адрес. Если выбрать значение "Внешний", для среды службы приложений будет использоваться виртуальный IP-адрес, доступный из Интернета. Если выбрать внутренний виртуальный IP-адрес, то для ASE будет настроен внутренний балансировщик нагрузки с IP-адресом в виртуальной сети. 

После выбора внутреннего виртуального IP-адреса возможность добавлять дополнительные IP-адреса для ASE исчезнет, и вместо этого необходимо будет предоставить поддомен ASE. В ASE с внешним виртуальным IP-адресом имя среды службы приложений указывается в поддомене для приложений, создаваемых в этой среде. Например, если ASE присвоено имя ***contosotest***, а приложению в ASE — ***mytest***, поддомен будет иметь вид ***contosotest.p.azurewebsites.net***, а URL-адресом этого приложения будет ***mytest.contosotest.p.azurewebsites.net***. Если указать внутренний виртуальный IP-адрес, то имя среды ASE не используется в ее поддомене. В этом случае поддомен указывается явным образом. Если используется поддомен ***contoso.corp.net*** и вы создали в этой среде ASE приложение с именем ***timereporting***, URL-адресом этого приложения будет ***timereporting.contoso.corp.net***.

## <a name="apps-in-an-ilb-ase"></a>Приложения в ASE с внутренним балансировщиком нагрузки
Создание приложения в ASE и ASE с внутренним балансировщиком нагрузки не отличается. 

1. На портале Azure выберите **Создать ресурс -> Интернет и мобильные устройства -> Интернет** или **Mobile** (Мобильные устройства) либо **Приложение API**.
2. Введите имя приложения.
3. Выберите свою подписку.
4. Выберите или создайте группу ресурсов.
5. Выберите или создайте план службы приложений (ASP). В случае создания плана службы приложений выберите свою среду ASE в качестве расположения, а также выберите рабочий пул, в котором будет создан этот план. При создании плана службы приложений следует выбрать ASE в качестве расположения и рабочий пул. При указании имени приложения вы увидите, что поддомен в имени вашего приложения заменяется поддоменом ASE. 
6. Нажмите кнопку **Создать**. Установите флажок **Закрепить на панели мониторинга**, чтобы отобразить приложение на панели мониторинга. 

![][2]

Поддомен в имени приложения обновится с учетом поддомена ASE. 

## <a name="post-ilb-ase-creation-validation"></a>Проверка после создания ASE с внутренним балансировщиком нагрузки
ASE с внутренним балансировщиком нагрузки немного отличается от ASE без такового. Как уже сказано, в ней нужно управлять собственной службой DNS, а также необходимо предоставлять собственный сертификат для подключений по протоколу HTTPS. 

После создания среды ASE вы обратите внимание, что отображается указанный вами поддомен, а в меню **Параметры** появился новый элемент **Сертификат ILB**. Среда ASE создается с самозаверяющим сертификатом, что упрощает тестирование протокола HTTPS. Портал сообщит о необходимости предоставить собственный сертификат для протокола HTTPS, который соответствует поддомену. 

![][3]

Если вы просто изучаете возможности и не знаете, как создать сертификат, то вы можете использовать консольное приложение IIS MMC, чтобы создать самозаверяющий сертификат. После создания сертификат можно экспортировать как PFX-файл, а затем передать его в пользовательский интерфейс сертификата ILB. При подключении к сайту, защищенному с помощью самозаверяющего сертификата, в браузере отобразится предупреждение о том, что сайт, к которому вы подключаетесь, не является безопасным из-за невозможности проверить сертификат. Чтобы предотвратить появление этого предупреждения, нужен должным образом подписанный сертификат, который соответствует вашему поддомену и имеет цепочку сертификатов, распознаваемую браузером.

![][6]

Если вы хотите использовать собственный сертификат, а также проверить доступ к ASE по протоколам HTTP и HTTPS, выполните следующее:

1. Перейдите в пользовательский интерфейс среды ASE после ее создания **ASE > Параметры > Сертификаты ILB**.
2. Задайте сертификат ILB, выбрав PFX-файл сертификата, и введите пароль. На выполнение этой операции потребуется некоторое время, после чего отобразится сообщение о том, что выполняется операция масштабирования.
3. Получите адрес внутреннего балансировщика нагрузки для среды ASE (**ASE > Свойства > Виртуальный IP-адрес**).
4. Создайте веб-приложение в среде ASE после ее создания. 
5. Создайте виртуальную машину, если в виртуальной сети нет ни одной (но не в той же подсети, что и ASE, иначе операция будет прервана).
6. Задайте DNS для поддомена. Можно указать в DNS подстановочные знаки с поддоменом или, если вы хотите выполнить несколько простых проверок, можно изменить файл hosts на виртуальной машине, чтобы в качестве имени веб-приложения задать виртуальный IP-адрес. Если имя поддомена вашей ASE — .ilbase.com и вы создали веб-приложение mytestapp, которое доступно по адресу mytestapp.ilbase.com, то укажите это в файле hosts. (В Windows файл hosts находится в папке C:\Windows\System32\drivers\etc\).)
7. Откройте браузер на этой виртуальной машине и перейдите по адресу http://mytestapp.ilbase.com (или по имени своего веб-приложения с поддоменом).
8. Откройте браузер на этой виртуальной машине и перейдите по адресу https://mytestapp.ilbase.com. Если используется самозаверяющий сертификат, учтите, что уровень безопасности будет снижен. 

IP-адрес вашего внутреннего балансировщика нагрузки указан в свойствах как виртуальный IP-адрес.

![][4]

## <a name="using-an-ilb-ase"></a>Использование ASE с внутренним балансировщиком нагрузки
#### <a name="network-security-groups"></a>группы сетевой безопасности;
Среда ASE с внутренним балансировщиком нагрузки обеспечивает сетевую изоляцию приложений. К приложениям нет доступа через Интернет, благодаря чему можно размещать сайты интрасети, например бизнес-приложения. Если необходимо еще строже ограничить доступ, то можно по-прежнему использовать группы безопасности сети для управления доступом на уровне сети. 

Если вы хотите использовать группы безопасности сети, чтобы еще больше ограничить доступ, то необходимо убедиться, что это не нарушает обмен данными, необходимый для работы ASE. Несмотря на то что доступ по протоколам HTTP и HTTPS осуществляется только через внутренний балансировщик нагрузки, используемый средой ASE, она по-прежнему зависит от ресурсов за пределами виртуальной сети. Чтобы узнать, какой доступ к сети по-прежнему необходим, просмотрите сведения в статьях [Как управлять входящим трафиком в среде службы приложений][ControlInbound] и [Сведения о конфигурации сети для сред службы приложений с ExpressRoute][ExpressRoute]. 

Для настройки групп безопасности сети необходимо знать IP-адрес, используемый Azure для управления средой ASE. Этот IP-адрес также является исходящим IP-адресом среды ASE, если она отправляет запросы через Интернет. Исходящий IP-адрес для ASE будет оставаться статическим в течение времени существования ASE. Если вы удалите и повторно создадите ASE, будет получен новый IP-адрес. Чтобы найти этот IP-адрес, выберите **Параметры > Свойства** и найдите параметр **Исходящий IP-адрес**. 

![][5]

#### <a name="general-ilb-ase-management"></a>Общее управление ASE с внутренним балансировщиком нагрузки
Управление ASE и ASE с внутренним балансировщиком нагрузки во многом одинаково. Необходимо увеличивать масштаб рабочих пулов для размещения дополнительных экземпляров плана службы приложений и увеличивать масштаб серверов переднего плана для обработки возрастающего объема трафика HTTP и HTTPS. Общие сведения об управлении конфигурацией ASE см. в статье [Настройка среды службы приложений версии 1][ASEConfig]. 

Дополнительными элементами управления являются управление сертификатами и управление DNS. После создания ASE с внутренним балансировщиком нагрузки необходимо получить и передать сертификат, используемый для подключений HTTPS, а затем заменить его, пока срок его действия не истек. Так как Azure принадлежит базовый домен, Azure может предоставлять сертификаты для сред ASE с внешним виртуальным IP-адресом. Так как поддомен, используемый ASE с внутренним балансировщиком нагрузки, может быть любым, необходимо предоставить собственный сертификат для подключений по протоколу HTTPS. 

#### <a name="dns-configuration"></a>Настройка DNS
При использовании внешнего виртуального IP-адреса службой DNS управляет Azure. Любое приложение, созданное в ASE, автоматически добавляется в службу DNS Azure, которая является общедоступной. В ASE с ILB необходимо управлять собственной службой DNS. Для заданного поддомена, например contoso.corp.net, необходимо создать записи А DNS, указывающие на адрес внутреннего балансировщика нагрузки:

    * 
    *.scm ftp publish 


## <a name="getting-started"></a>Приступая к работе
Сведения о том, как начать работу со средами службы приложений, см. в статье [Введение в среду службы приложений][WhatisASE].

[!INCLUDE [app-service-web-try-app-service](../../../includes/app-service-web-try-app-service.md)]

<!--Image references-->
[1]: ./media/app-service-environment-with-internal-load-balancer/ilbase-createilbase.png
[2]: ./media/app-service-environment-with-internal-load-balancer/ilbase-createapp.png
[3]: ./media/app-service-environment-with-internal-load-balancer/ilbase-newase.png
[4]: ./media/app-service-environment-with-internal-load-balancer/ilbase-vip.png
[5]: ./media/app-service-environment-with-internal-load-balancer/ilbase-externalvip.png
[6]: ./media/app-service-environment-with-internal-load-balancer/ilbase-ilbcertificate.png

<!--Links-->
[WhatisASE]: app-service-app-service-environment-intro.md
[HowtoCreateASE]: app-service-web-how-to-create-an-app-service-environment.md
[ControlInbound]: app-service-app-service-environment-control-inbound-traffic.md
[virtualnetwork]: https://azure.microsoft.com/documentation/articles/virtual-networks-faq/
[AppServicePricing]: http://azure.microsoft.com/pricing/details/app-service/
[ASEAutoscale]: app-service-environment-auto-scale.md
[ExpressRoute]: app-service-app-service-environment-network-configuration-expressroute.md
[vnetnsgs]: http://azure.microsoft.com/documentation/articles/virtual-networks-nsg/
[ASEConfig]: app-service-web-configure-an-app-service-environment.md
