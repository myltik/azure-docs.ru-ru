---
title: Проверка подлинности и авторизация в службе приложений Azure | Документация Майкрософт
description: Принципы использования и обзор функции проверки подлинности и авторизации в службе приложений Azure
services: app-service
documentationcenter: ''
author: mattchenderson
manager: erikre
editor: ''
ms.assetid: b7151b57-09e5-4c77-a10c-375a262f17e5
ms.service: app-service
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: multiple
ms.topic: article
ms.date: 08/29/2016
ms.author: mahender
ms.openlocfilehash: 342aeee25a7cb9f6a0f5af055d04e67d0c52db80
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="authentication-and-authorization-in-azure-app-service"></a>Проверка подлинности и авторизация в службе приложений Azure

Служба приложений Azure обеспечивает встроенную поддержку проверки подлинности и авторизации, поэтому для входа пользователей в систему и предоставления доступа к данным необходимо написать (или не писать) минимальный код в веб-приложении, API и серверной части мобильных приложений, а также в [Функциях Azure](../azure-functions/functions-overview.md). В этой статье описывается, как служба приложений помогает упростить проверку подлинности и авторизацию для вашего приложения. 

Безопасные проверка подлинности и авторизация требуют глубокого понимания средств обеспечения безопасности, в том числе федерации, шифрования, управления [токенами JWT](https://wikipedia.org/wiki/JSON_Web_Token), [типов предоставления разрешений](https://oauth.net/2/grant-types/) и т. д. Служба приложений предоставляет эти служебные программы, чтобы вы могли уделять больше времени предоставлению бизнес-преимуществ для своего клиента.

> [!NOTE]
> Вам не нужно использовать службу приложений для проверки подлинности и авторизации. Многие веб-платформы оснащены функциями безопасности, и при необходимости вы можете использовать их. Если требуется больше гибкости, чем предоставляет служба приложений, можно также написать собственные служебные программы.  
>

Сведения для собственных мобильных приложений см. в статье [Проверка подлинности и авторизация в мобильных приложениях Azure](../app-service-mobile/app-service-mobile-auth.md).

## <a name="how-it-works"></a>Принцип работы

Модуль проверки подлинности и авторизации выполняется в той же песочнице, что и код приложения. Если он включен, каждый входящий HTTP-запрос проходит через него перед обработкой кодом вашего приложения.

![](media/app-service-authentication-overview/architecture.png)

Этот модуль выполняет следующие операции для вашего приложения:

- проверку подлинности пользователей с указанным поставщиком;
- проверку, хранение и обновление токенов;
- управление сеансом с проверкой подлинности;
- вставка сведений об удостоверении в заголовки запросов.

Модуль работает отдельно от кода приложения и настраивается с помощью параметров приложения. Для кода приложения не нужны пакеты SDK, определенные языки или изменения. 

### <a name="user-claims"></a>Утверждения пользователя

Для всех языковых платформ служба приложений делает утверждения пользователя доступными для вашего кода, вставляя их в заголовки запросов. Для приложений ASP.NET 4.6 служба приложений заполняет свойство [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) утверждениями пользователя, прошедшими проверку подлинности, поэтому вы можете следовать стандартным шаблонам кода .NET, включая атрибут `[Authorize]`. Аналогичным образом для приложений PHP служба приложений заполняет переменную `_SERVER['REMOTE_USER']`.

В [Функциях Azure](../azure-functions/functions-overview.md) утверждения `ClaimsPrincipal.Current` не расконсервированы для кода .NET, но вы все равно можете найти утверждения пользователей в заголовках запросов.

Дополнительные сведения см. в разделе [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя).

### <a name="token-store"></a>Хранилище токенов

Служба приложений предоставляет встроенное хранилище токенов, которое представляет собой репозиторий токенов, связанных с пользователями ваших веб-приложений, API или собственных мобильных приложений. При включении проверки подлинности с помощью любого поставщика это хранилище токенов немедленно становится доступным для вашего приложения. Если для кода вашего приложения требуется доступ к данным из этих поставщиков от имени пользователя, чтобы: 

- опубликовать запись в ленте Facebook прошедшего проверку подлинности пользователя;
- прочитать корпоративные данные пользователя из API Graph Azure Active Directory или даже Microsoft Graph.

Токены идентификатора, доступа и обновления кэшируются для проверенного сеанса. Они доступны только соответствующему пользователю.  

Как правило, вам необходимо писать код для сбора, хранения и обновления этих токенов в своем приложении. В хранилище токенов при необходимости вы просто [извлекаете токены](app-service-authentication-how-to.md#retrieve-tokens-in-app-code) и [указываете службе приложений обновить их](app-service-authentication-how-to.md#refresh-access-tokens), если они становятся недопустимыми. 

Если вам не нужно использовать токены в приложении, вы можете отключить хранилище токенов.

### <a name="logging-and-tracing"></a>Ведение журнала и трассировка

Если вы [включите ведение журнала приложений](web-sites-enable-diagnostic-log.md), вы увидите трассировку проверки подлинности и авторизации непосредственно в файлах журналов. Если появится неожиданная ошибка проверки подлинности, вы можете легко найти все сведения, просмотрев имеющиеся журналы приложений. Если вы включили [трассировку неудачно завершенных запросов](web-sites-enable-diagnostic-log.md), вы можете точно определить, какую роль мог выполнять модуль проверки подлинности и авторизации в неудавшемся запросе. Найдите ссылки на модуль с именем `EasyAuthModule_32/64` в журналах трассировки. 

## <a name="identity-providers"></a>Поставщики удостоверений

Служба приложений использует [федеративную идентификацию](https://en.wikipedia.org/wiki/Federated_identity), при которой сторонний поставщик управляет удостоверениями пользователей и потоком проверки подлинности. По умолчанию доступны пять поставщиков удостоверений. 

| Поставщик | Конечная точка входа |
| - | - |
| [Azure Active Directory](../active-directory/active-directory-whatis.md) | `/.auth/login/aad` |
| [Учетная запись Майкрософт](../active-directory/develop/active-directory-appmodel-v2-overview.md) | `/.auth/login/microsoft` |
| [Facebook](https://developers.facebook.com/docs/facebook-login) | `/.auth/login/facebook` |
| [Google](https://developers.google.com/+/web/api/rest/oauth) | `/.auth/login/google` |
| [Twitter](https://developer.twitter.com/docs/basics/authentication) | `/.auth/login/twitter` |

При включении проверки подлинности и авторизации с помощью одного из этих поставщиков конечная точка входа станет доступной для проверки подлинности пользователя и для проверки токенов проверки подлинности от поставщика. Вы можете легко предоставить своим пользователям любое количество этих вариантов входа. Кроме того, вы можете добавить другого поставщика удостоверений или [собственное настраиваемое решение для идентификации][custom-auth].

## <a name="authentication-flow"></a>Поток проверки подлинности

Поток проверки подлинности одинаков для всех поставщиков, но отличается в зависимости от выбора способа входа в систему: с использованием пакета SDK поставщика или без.

- Без использования пакета SDK поставщика. Приложение делегирует федеративный вход в службу приложений. Обычно это относится к приложениям браузера, которые могут предоставить пользователю страницу входа поставщика. Код сервера управляет процессом входа, поэтому он также называется _управляемым сервером потоком_ или _потоком сервера_. Этот вариант применяется к веб-приложениям. Он также относится к собственным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK для клиента мобильных приложений. Пакет SDK открывает веб-представление, в котором пользователи выполняют вход с помощью проверки подлинности службы приложений. 
- С использованием пакета SDK поставщика. Вход пользователя в приложение выполняется вручную, а затем приложение отправляет токен проверки подлинности в службу приложений для проверки. Обычно это относится к внебраузерным приложениям, которые не могут предоставить пользователю страницу входа в систему. Код приложения управляет процессом входа, поэтому его также называют _управляемым клиентом потоком_ или _потоком клиента_. Этот случай применяется к REST API, [Функциям Azure](../azure-functions/functions-overview.md) и клиентам браузера JavaScript, а также к веб-приложениям, которым требуется больше гибкости при входе в систему. Это также относится к собственным мобильным приложениям, в которых вход пользователей в систему выполняется с помощью пакета SDK поставщика.

> [!NOTE]
> При осуществлении вызовов из доверенного приложения браузера в службе приложений другой REST API в службе приложений или [Функциях Azure](../azure-functions/functions-overview.md) может пройти проверку подлинности с помощью управляемого сервером потока. Дополнительные сведения см. в статье [Проверка подлинности и авторизация в службе приложений Azure]().
>

В приведенной ниже таблице показаны шаги выполнения потока проверки подлинности.

| Шаг | Без использования пакета SDK поставщика | С использованием пакета SDK поставщика |
| - | - | - |
| 1. Вход пользователя | Перенаправляет клиента к `/.auth/login/<provider>`. | Код клиента выполняет вход пользователя непосредственно через пакет SDK поставщика и получает токен проверки подлинности. Дополнительные сведения см. в документации поставщика. |
| 2. Действия после проверки подлинности | Поставщик перенаправляет клиент к `/.auth/login/<provider>/callback`. | Код клиента отправляет токен от поставщика к `/.auth/login/<provider>` для проверки. |
| 3. Установка проверенного сеанса | Служба приложений добавляет файлы cookie, прошедшие проверку подлинности, в ответ. | Служба приложений возвращает собственный токен проверки подлинности в код клиента. |
| 4. Обработка содержимого, прошедшего проверку подлинности | Клиент включает файлы cookie, прошедшие проверку подлинности, в последующие запросы (автоматически обрабатываются браузером). | Код клиента предоставляет токен проверки подлинности в заголовке `X-ZUMO-AUTH` (автоматически обрабатывается пакетами SDK для клиента мобильных приложений). |

Для клиентских браузеров служба приложений может автоматически перенаправлять всех не прошедших проверку пользователей к `/.auth/login/<provider>`. Вы также можете отправить пользователям одну или несколько ссылок `/.auth/login/<provider>`, чтобы они вошли в ваше приложение с использованием поставщика по выбору.

<a name="authorization"></a>

## <a name="authorization-behavior"></a>Поведение авторизации

На [портале Azure](https://portal.azure.com) вы можете настроить авторизацию службы приложений с помощью нескольких способов поведения.

![](media/app-service-authentication-overview/authorization-flow.png)

Ниже описаны возможные варианты.

### <a name="allow-all-requests-default"></a>Разрешить все запросы (по умолчанию)

Служба приложений не управляет проверкой подлинности и авторизацией (отключено). 

Выберите этот вариант, если вам не нужна проверка подлинности и авторизация или если вы хотите написать собственный код для проверки подлинности и авторизации.

### <a name="allow-only-authenticated-requests"></a>Разрешить только запросы, прошедшие проверку подлинности

Параметр — **Войти с помощью \<поставщик>**. Служба приложений перенаправляет все анонимные запросы к `/.auth/login/<provider>` для выбранного вами поставщика. Если анонимный запрос поступает из собственного мобильного приложения, возвращаемый ответ `HTTP 401 Unauthorized`.

В этом случае в клиентском приложении не нужен код для проверки подлинности. Более точная авторизация, например авторизация для конкретной роли, может выполняться путем проверки утверждений пользователя (см. раздел [Access user claims](app-service-authentication-how-to.md#access-user-claims) (Доступ к утверждениям пользователя)).

### <a name="allow-all-requests-but-validate-authenticated-requests"></a>Разрешить все запросы, но проверять запросы, прошедшие проверку подлинности

Параметр — **Разрешить анонимные запросы**. Этот параметр включает проверку подлинности и авторизацию в службе приложений, но отменяет решения авторизации для кода приложения. Для запросов, прошедших проверку подлинности, служба приложений также передает сведения о проверке подлинности в заголовках HTTP. 

Такой вариант обеспечивает большую гибкость в обработке анонимных запросов. Например, он позволяет [предоставлять несколько вариантов входа](app-service-authentication-how-to.md#configure-multiple-sign-in-options) пользователям. Однако необходимо написать код. 

## <a name="more-resources"></a>Дополнительные ресурсы

[Руководство по сквозной проверке подлинности и авторизации в службе приложений Azure](app-service-web-tutorial-auth-aad.md)  
[Customize authentication and authorization in Azure App Service](app-service-authentication-how-to.md) (Настройка проверки подлинности и авторизации в Службе приложений Azure)

Практические руководства для поставщика:

* [Настройка приложения службы приложений для использования службы входа Azure Active Directory][AAD]
* [Как настроить приложение службы приложений для использования имени для входа Facebook][Facebook]
* [Как настроить приложение службы приложений для использования имени для входа Google][Google]
* [Настройка приложения службы приложений для использования входа по учетной записи Майкрософт][MSA]
* [Как настроить приложение службы приложений для использования имени для входа Twitter][Twitter]
* [Практическое руководство. Использование пользовательской проверки подлинности для приложения][custom-auth]

[AAD]: app-service-mobile-how-to-configure-active-directory-authentication.md
[Facebook]: app-service-mobile-how-to-configure-facebook-authentication.md
[Google]: app-service-mobile-how-to-configure-google-authentication.md
[MSA]: app-service-mobile-how-to-configure-microsoft-authentication.md
[Twitter]: app-service-mobile-how-to-configure-twitter-authentication.md

[custom-auth]: ../app-service-mobile/app-service-mobile-dotnet-backend-how-to-use-server-sdk.md#custom-auth

[ADAL-Android]: ../app-service-mobile/app-service-mobile-android-how-to-use-client-library.md#adal
[ADAL-iOS]: ../app-service-mobile/app-service-mobile-ios-how-to-use-client-library.md#adal
[ADAL-dotnet]: ../app-service-mobile/app-service-mobile-dotnet-how-to-use-client-library.md#adal
