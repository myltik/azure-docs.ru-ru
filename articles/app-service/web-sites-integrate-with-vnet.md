---
title: Интеграция приложения с виртуальной сетью Azure
description: В этой статье показано, как подключить приложение к новой или существующей виртуальной сети Azure.
services: app-service
documentationcenter: ''
author: ccompy
manager: erikre
editor: cephalin
ms.assetid: 90bc6ec6-133d-4d87-a867-fcf77da75f5a
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: ccompy
ms.openlocfilehash: 83f5c64926eb9b718463c415a5478af374245f31
ms.sourcegitcommit: fa493b66552af11260db48d89e3ddfcdcb5e3152
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2018
ms.locfileid: "31789213"
---
# <a name="integrate-your-app-with-an-azure-virtual-network"></a>Интеграция приложения с виртуальной сетью Azure
В этом документе описана функция службы приложений Azure — интеграция с виртуальной сетью. Кроме того, приведены инструкции по ее настройке для приложений в [службе приложений Azure](http://go.microsoft.com/fwlink/?LinkId=529714). Если вы не знакомы с виртуальными сетями Azure, вот краткое описание. Эта функция позволяет размещать множество ресурсов Azure в сети, недоступной из Интернета, а также самостоятельно управлять доступом к ним. Эти сети можно подключать к локальным сетям с помощью разных технологий VPN. Начать изучение виртуальных сетей Azure лучше всего со статьи [Обзор виртуальной сети][VNETOverview]. 

Служба приложений Azure реализована в виде двух моделей. 

1. Мультитенантные системы с поддержкой всей линейки тарифных планов
2. Среда службы приложений (ASE), которая развертывается в виртуальной сети клиента и предоставляет более широкие возможности. 

В этом документе рассматривается интеграция с виртуальной сетью, а не среда службы приложений. Если вы хотите узнать больше о функции ASE, то начните ее изучение со статьи [Введение в среду службы приложений][ASEintro].

Интеграция с виртуальной сетью предоставляет веб-приложению доступ к ресурсам виртуальной сети, при этом само приложение остается для этой сети недоступным. Доступ к частным сайтам подразумевает доступность приложения только из частной сети, например из виртуальной сети Azure. Доступ к частным сайтам возможен, только если для ASE настроен внутренний балансировщик нагрузки (ILB). Дополнительные сведения об использовании ILB ASE см. в статье [Использование внутреннего балансировщика нагрузки в среде службы приложений][ILBASE]. 

Обычно интеграция с виртуальной сетью используется, чтобы предоставить веб-приложению доступ к базе данных или веб-службе, которые выполняются на виртуальной машине в виртуальной сети Azure. Благодаря интеграции с виртуальной сетью вам не нужно предоставлять общедоступную конечную точку приложениям, запущенным на виртуальной машине. Вместо этого будут использоваться частные адреса, недоступные из Интернета. 

Интеграция с виртуальной сетью связана со следующими особенностями:

* требуется тарифный план "Стандартный", "Премиум" или "Isolated"; 
* работает с классической виртуальной сетью или с виртуальной сетью Resource Manager; 
* поддерживает TCP и UDP;
* работает с Интернетом, мобильными приложениями, приложениями API и приложениями-функциями;
* позволяет приложению в один момент времени подключаться только к одной виртуальной сети;
* позволяет интегрировать до пяти виртуальных сетей в рамках плана службы приложений; 
* позволяет нескольким приложениям использовать одну виртуальную сеть в рамках плана службы приложений;
* гарантирует практически постоянную доступность ресурсов (99,9 % согласно соглашению об уровне обслуживания) благодаря использованию шлюза виртуальной сети.

Функции, не поддерживаемые при интеграции с виртуальной сетью:

* подключение диска;
* интеграция с AD; 
* NetBios;
* доступ к частным сайтам.

### <a name="getting-started"></a>Приступая к работе
Перед подключением веб-приложения к виртуальной сети обратите внимание на следующие моменты.

* К виртуальной сети можно подключить только приложения тарифного плана **Стандартный**, **Премиум** или **Isolated**. Если вы включите функцию, а затем перейдете на план службы приложений, который не поддерживается, то существующие подключения между приложениями и виртуальными сетями будут разорваны. 
* Если необходимая виртуальная сеть уже существует, перед подключением приложения в ней необходимо активировать VPN-подключение типа «точка-сеть», использующее шлюз с динамической маршрутизацией. Если для шлюза настроена статическая маршрутизация, то подключение виртуальной частной сети типа "точка — сеть" (VPN) невозможно активировать.
* Виртуальная сеть должна относиться к той же подписке, что и план службы приложений (ASP).
* Если шлюз с установленным подключением типа "точка — сеть" уже существует (с номером SKU уровня, отличного от уровня "Базовый"), в конфигурации "точка — сеть" нужно отключить IKEV2.
* Приложения, которые интегрируются с виртуальной сетью, используют DNS-сервер, указанный для этой виртуальной сети.
* По умолчанию трафик от подключаемых приложений направляется в виртуальную сеть только по тем маршрутам, которые определены в виртуальной сети. 

## <a name="enabling-vnet-integration"></a>Включение интеграции с виртуальной сетью

Вы можете подключить приложение к имеющейся виртуальной сети или создать новую. Во время создания новой сети в рамках интеграции с виртуальной сетью автоматически настраивается шлюз с динамической маршрутизацией и активируется VPN-подключение типа "точка — сеть". 

> [!NOTE]
> Настройка интеграции с новой виртуальной сетью может занять несколько минут. 
> 
> 

Чтобы включить интеграцию с виртуальной сетью, в параметрах приложения выберите элемент "Сеть". Вы увидите интерфейс с тремя вариантами доступа к сети. В этом руководстве подробно описывается только интеграция с виртуальной сетью. Использование гибридных подключений и сред службы приложений вкратце рассматривается в конце документа. 

Если тарифный план приложения не поддерживает эту функцию, то пользовательский интерфейс позволяет изменить его на более высокий.

![][1]

### <a name="enabling-vnet-integration-with-a-pre-existing-vnet"></a>Включение интеграции с существующей виртуальной сетью
Пользовательский интерфейс интеграции с виртуальной сетью позволяет делать выбор в списке виртуальных сетей. Классические виртуальные сети обозначены словом Classic (классическая) в скобках рядом с именем виртуальной сети. Список отсортирован так, что сначала указаны виртуальные сети Resource Manager. На рисунке ниже показано, что можно выбрать только одну виртуальную сеть. Виртуальные сети могут быть неактивными в этом списке по разным причинам, например:

* виртуальная сеть относится к другой подписке, к которой имеет доступ ваша учетная запись;
* для виртуальной сети не активировано подключение типа "точка — сеть";
* для виртуальной сети не настроен шлюз с динамической маршрутизацией.

![][2]

Чтобы включить интеграцию, просто щелкните нужную виртуальную сеть. После выбора виртуальной сети приложение автоматически перезапускается, чтобы изменения вступили в силу. 

##### <a name="enable-point-to-site-in-a-classic-vnet"></a>Включение подключения типа "точка — сеть" в классической виртуальной сети
Если для виртуальной сети не настроен шлюз или не активировано подключение типа "точка — сеть", то это нужно сделать до интеграции. Чтобы выполнить эту задачу для классической виртуальной сети, перейдите на [портал Azure][AzurePortal] и откройте список "Виртуальные сети (классика)". Выберите сети для интеграции, а затем в разделе "Основные компоненты" щелкните поле "VPN-подключения". Здесь вы можете создать VPN-подключение типа "точка — сеть" и настроить шлюз. Активация созданного подключения типа "точка — сеть" и шлюза занимает около 30 минут. 

![][8]

##### <a name="enabling-point-to-site-in-a-resource-manager-vnet"></a>Включение подключения типа "точка — сеть" в виртуальной сети Resource Manager
Чтобы настроить виртуальную сеть Resource Manager со шлюзом и подключением типа "точка — сеть", можно использовать PowerShell, как описано в статье [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью PowerShell][V2VNETP2S], или использовать портал Azure, как описано в статье [Настройка подключения типа "точка — сеть" к виртуальной сети с помощью портала Azure][V2VNETPortal]. Пользовательский интерфейс для выполнения этой процедуры пока недоступен. Обратите внимание, что создавать сертификаты для конфигурации "точка — сеть" не требуется. Она настраивается автоматически при подключении веб-приложения к виртуальной сети. 

### <a name="creating-a-pre-configured-vnet"></a>Создание предварительно настроенной виртуальной сети
Если вы хотите создать виртуальную сеть, для которой настроен шлюз и подключение "точка — сеть", то можно воспользоваться сетевым пользовательским интерфейсом службы приложений. Но в нем вы можете создать только виртуальную сеть Resource Manager. Если вы хотите создать классическую виртуальную сеть со шлюзом и подключением "точка — сеть", это придется сделать вручную с помощью сетевого пользовательского интерфейса. 

Чтобы создать виртуальную сеть Resource Manager с помощью интерфейса интеграции с виртуальной сетью, просто выберите пункт **Создать виртуальную сеть** и укажите следующие сведения:

* имя виртуальной сети;
* блок адресов виртуальной сети;
* Имя подсети
* блок адресов подсети;
* блок адресов шлюза;
* блок адресов подключения "точка-сеть".

Если вы хотите подключать эту виртуальную сеть к любым другим сетям, то постарайтесь избежать пересечения пространств IP-адресов этих сетей. 

> [!NOTE]
> Создание виртуальной сети Resource Manager со шлюзом занимает около 30 минут. В настоящее время интеграция виртуальной сети с приложением не поддерживается. После создания виртуальной сети со шлюзом необходимо вернуться в пользовательский интерфейс интеграции с виртуальной сетью и выбрать новую виртуальную сеть.
> 
> 

![][3]

Виртуальные сети Azure обычно создаются с адресами, принадлежащими к диапазону частных сетей. По умолчанию интеграция с виртуальной сетью направляет в виртуальную сеть весь трафик, предназначенный для этого диапазона. Ниже перечислены диапазоны частных IP-адресов:

* 10.0.0.0/8 — соответствует диапазону 10.0.0.0–10.255.255.255;
* 172.16.0.0/12 — соответствует диапазону 172.16.0.0–172.31.255.255; 
* 192.168.0.0/16 — соответствует диапазону 192.168.0.0–192.168.255.255.

Адресное пространство виртуальной сети определяется в нотации CIDR. Если вы не знакомы с нотацией CIDR, это метод определения блоков адресов с использованием IP-адреса и целого числа, представляющего маску подсети. Например, запись 10.1.0.0/24 представляет 256 адресов, а запись 10.1.0.0/25 — 128 адресов. Для протокола IPv4 маска /32 представляет только один адрес. 

Здесь вы можете указать сведения о DNS-сервере, чтобы настроить его для своей виртуальной сети. После создания виртуальной сети вы сможете изменить эти данные через пользовательский интерфейс сети. Если изменить DNS виртуальной сети, то необходимо выполнить операцию "Синхронизировать сеть".

Классическая виртуальная сеть, созданная через интерфейс интеграции с виртуальной сетью, включается в ту же группу ресурсов, что и ваше приложение. 

## <a name="how-the-system-works"></a>Принципы работы системы
Эта функция подключает ваше приложение к виртуальной сети, используя технологию VPN "точка — сеть". Приложения в службе приложений Azure имеют мультитенантную архитектуру, которая не позволяет подготовить приложение непосредственно в виртуальной сети, как это происходит с виртуальными машинами. Технология «точка-сеть» ограничивает доступ к сети средой виртуальной машины, на которой размещено веб-приложение. В дальнейшем доступ к сети ограничивается этими узлами приложений. Приложения получат доступ только к тем сетям, которые вы укажете в настройках. 

![][4]

Если в виртуальной сети не настроен DNS-сервер, то для доступа к ресурсу в виртуальной сети приложению придется использовать IP-адреса. Помните, что основное преимущество интеграции с виртуальной сетью представлено возможностью использовать частные адреса, выделенные в частной сети. Если настройки приложения позволяют ему обращаться к любой из виртуальных машин по общедоступным IP-адресам, это значит, что обмен данными происходит через Интернет, а не с помощью интеграции с виртуальной сетью.

## <a name="managing-the-vnet-integrations"></a>Управление интеграцией с виртуальной сетью
Возможность подключаться к виртуальной сети и отключаться от нее реализуется на уровне приложения. Операции, которые могут повлиять на интеграцию нескольких приложений с виртуальной сетью, выполняются на уровне плана ASP. Пользовательский интерфейс на уровне приложения предоставляет информацию о виртуальной сети. Большая часть этой информации доступна и на уровне плана ASP. 

![][5]

На странице состояния сетевых компонентов вы можете отследить, подключено ли приложение к виртуальной сети. Если шлюз виртуальной сети по какой-либо причине не работает, здесь будет указано, что подключение не установлено. 

Теперь в пользовательском интерфейсе интеграции с виртуальной сетью на уровне приложения отображаются те же сведения, что и на уровне ASP. Они представлены ниже.

* Имя виртуальной сети. Эта ссылка открывает окно пользовательского интерфейса виртуальной сети Azure.
* Расположение. Здесь указано расположение виртуальной сети. Вы можете подключиться к сети в другом расположении.
* Состояние сертификата. Для защиты VPN-подключения между приложением и виртуальной сетью используются сертификаты. Здесь вы можете проверить, синхронизированы ли они.
* Состояние шлюза. Если по какой-либо причине шлюз не работает, приложение не сможет получить доступ к ресурсам в виртуальной сети. 
* Адресное пространство виртуальной сети. Здесь указаны IP-адреса, которые используются в виртуальной сети. 
* Адресное пространство "точка — сеть". Здесь указаны IP-адреса, которые используются при подключении типа "точка — сеть" к виртуальной сети. Для обмена данными приложение использует один из IP-адресов этого адресного пространства. 
* Адресное пространство "сеть — сеть". VPN-подключение типа "сеть — сеть" можно использовать для подключения виртуальной сети к ресурсам в локальной сети или к другим виртуальным сетям. Если вы используете эту функцию, то здесь отображаются диапазоны IP-адресов, определенные для этого VPN-подключения.
* DNS-серверы. Здесь перечислены DNS-серверы, настроенные для виртуальной сети.
* IP-адреса маршрутизации в виртуальную сеть. Для некоторых IP-адресов в виртуальной сети можно определить маршрутизацию. Такие адреса отображаются здесь. 

В представлении интеграции с виртуальной сетью на уровне приложения можно выполнить только одну операцию — отключить приложение от той виртуальной сети, к которой оно сейчас подключено. Для этого щелкните вверху значок «Отключить». Это действие не изменяет настройки виртуальной сети. Конфигурация виртуальной сети, включая настроенные шлюзы, останется неизменной. Если вы хотите удалить виртуальную сеть, необходимо сначала удалить все ее ресурсы, включая шлюзы. 

В представлении плана службы приложений доступны несколько дополнительных операций. Доступ к этому представлению осуществляется не через приложение. Чтобы открыть сетевой пользовательский интерфейс ASP, зайдите в основной пользовательский интерфейс ASP и прокрутите страницу вниз. Здесь вы увидите элемент интерфейса «Состояние компонентов сети». Он содержит некоторые краткие сведения, имеющие отношение к интеграции с виртуальной сетью. Щелкнув этот элемент, вы откроете пользовательский интерфейс состояния компонентов сети. Ссылка "Щелкните здесь для управления" открывает раздел со списком подключений к виртуальным сетям в рамках плана ASP.

![][6]

Оценивая расположение виртуальных сетей, с которыми осуществляется обмен данными, важно помнить о расположении самого плана ASP. Подключение к виртуальной сети в другом расположении может сопровождаться задержками. 

Список подключенных виртуальных сетей позволяет отслеживать текущее количество виртуальных сетей, к которым подключены приложения в рамках плана ASP, а также максимально возможное количество таких подключений. 

Дополнительную информацию о каждой виртуальной сети можно получить, щелкнув ее имя. Помимо описанных выше сведений вы можете увидеть список приложений, которые подключены к этой сети в рамках плана ASP. 

Здесь вы можете выполнить два действия. Во-первых, вы можете добавлять маршруты, по которым трафик от приложения будет направляться к виртуальной сети. Во-вторых, вы можете синхронизировать сертификаты и сведения о сети.

![][7]

**Маршрутизация**. Как указано выше, для перенаправления трафика от приложения к виртуальной сети используются маршруты, которые определены в виртуальной сети. В некоторых случаях пользователям нужно отправлять из приложения в виртуальную сеть дополнительный исходящий трафик. Маршрутизация позволяет решить эту задачу. Дальнейшие действия с трафиком зависят от того, как пользователь настроил виртуальную сеть. 

**Сертификаты**. Состояние сертификатов отображает результаты проверки, которую выполняет служба приложений. Цель этой проверки — оценка пригодности сертификатов, используемых для VPN-подключения. При первой интеграции любого приложения в рамках ASP с виртуальной сетью происходит обязательный обмен сертификатами для обеспечения безопасности подключения. Одновременно с сертификатами мы получаем конфигурацию DNS, маршруты и другую полезную информацию о сети.
Если сертификаты или сведения о сети изменились, то щелкните элемент "Синхронизировать сеть". **Примечание**. Выполнение синхронизации с сетью сопровождается кратковременной потерей подключения между приложением и виртуальной сетью. Хотя приложение не перезапускается, потеря подключения может привести к нарушению его работоспособности. 

## <a name="accessing-on-premises-resources"></a>Доступ к локальным ресурсам
Одним из преимуществ использования интеграции с виртуальной сетью является возможность подключения виртуальной сети к локальной сети через VPN-подключение типа "сеть — сеть". Благодаря этому приложение получает доступ к локальным ресурсам. Для слаженной работы вам может понадобиться обновить маршруты для диапазона адресов "точка — сеть" в локальном VPN-шлюзе. При первой настройке VPN-подключения «сеть-сеть» с использованием скриптов нужно настроить маршруты, в том числе для VPN-подключения «точка-сеть». Если VPN-подключение типа "точка — сеть" добавлено после создания VPN-подключения типа "сеть — сеть", то маршруты нужно обновить вручную. Эта процедура отличается для разных типов шлюзов, поэтому здесь мы ее не рассматриваем. 

> [!NOTE]
> Функция интеграции c виртуальной сетью не предусматривает интеграции приложения с виртуальной сетью, в которой установлен шлюз ExpressRoute. Даже если шлюз ExpressRoute настроен в [режиме сосуществования][VPNERCoex], функция интеграции c виртуальной сетью работать не будет. Если требуется получить доступ к ресурсам через соединение ExpressRoute, можно использовать [среду службы приложений][ASE], которая работает в виртуальной сети.
> 
> 

## <a name="pricing-details"></a>Сведения о тарифах
Есть несколько нюансов тарификации, которые следует учитывать при использовании интеграции с виртуальной сетью. Использование этой функции связано со следующими расходами:

* требования к ценовой категории плана ASP;
* расходы, связанные с передачей данных;
* расходы, связанные с использованием VPN-шлюза.

Использовать эту функцию могут только те приложения, которые входят в план службы приложений класса «Стандартный» или «Премиум». Дополнительные сведения о ценах на планы см. на странице [цен на службу приложений][ASPricing]. 

Из-за особенностей VPN-подключения типа "точка — сеть" трафик всегда тарифицируется как исходящий при подключении к виртуальной сети, даже если виртуальная сеть находится в том же центре обработки данных. Узнать соответствующие расценки можно на странице [Сведения о ценах — передача данных][DataPricing]. 

И последний компонент, определяющий стоимость услуги, — это расходы, связанные с использованием шлюзов виртуальной сети. Если шлюзы не используются для других целей, например для VPN-подключения типа "сеть — сеть", то вы платите только за использование шлюзов в рамках поддержки интеграции с виртуальной сетью. Сведения о связанных расценках см. на странице [Цены — VPN-шлюзы][VNETPricing]. 

## <a name="troubleshooting"></a>Устранение неполадок
Простота настройки этой функции не гарантирует отсутствия проблем при ее использовании. При проблемах с доступом к нужной конечной точке можно воспользоваться некоторыми служебными программами для проверки подключения из консоли приложения. Есть два варианта использования консоли: консоль Kudu и консоль на портале Azure. Чтобы открыть консоль Kudu из приложения, щелкните "Сервис" -> "Kudu". Этот же интерфейс доступен по адресу [имя_сайта].scm.azurewebsites.net. В консоли перейдите на вкладку отладки. Чтобы воспользоваться консолью на портале Azure, откройте меню «Сервис» -> «Консоль». 

#### <a name="tools"></a>Средства
Средства ping, nslookup и tracert нельзя использовать в консоли из-за ограничений безопасности. Чтобы компенсировать это, добавлены два других средства. Для проверки работоспособности DNS мы добавили средство nameresolver.exe. Синтаксис:

    nameresolver.exe hostname [optional: DNS Server]

Nameresolver можно использовать для проверки имен узлов, которые использует ваше приложение. Так вы сможете обнаружить ошибки в настройке DNS-сервера или проблемы с доступом к DNS-серверу.

Следующее средство позволяет проверить подключение к комбинации «узел:порт» по протоколу TCP. Это средство называется tcpping.exe и имеет следующий синтаксис:

    tcpping.exe hostname [optional: port]

Служебная программа tcpping сообщает, возможно ли получить доступ к определенному узлу и порту. Сообщение об успешном выполнении отображается только с том случае, когда приложение ожидает передачи данных от комбинации "узел:порт", а также есть доступ по сети из приложения к указанным узлу и порту.

#### <a name="debugging-access-to-vnet-hosted-resources"></a>Доступ к ресурсам виртуальной сети для отладки
У приложения могут возникнуть проблемы с доступом к определенной комбинации «узел:порт». Это происходит по многим причинам. Вот три наиболее распространенные причины:

* **В пути есть брандмауэр**. Если вы используете брандмауэр, то может быть превышено время ожидания TCP. В нашем случае это 21 секунда. Проверьте подключение с помощью средства tcpping. Время ожидания TCP может превышаться и по многим другим причинам, но начать стоит именно с этой. 
* **Служба DNS недоступна**. Время ожидания для DNS составляет три секунды на каждый DNS-сервер. Если у вас два DNS-сервера, то время ожидания составляет 6 секунд. Используйте средство nameresolver для проверки работы DNS. Помните, что средство nslookup не подходит для проверки, так как оно игнорирует настройки DNS для виртуальной сети.
* **Недопустимый диапазон IP-адресов P2S**. Диапазон IP-адресов для подключения "точка — сеть" должен находиться в диапазоне частных IP-адресов согласно RFC 1918 (10.0.0.0–10.255.255.255, 172.16.0.0–172.31.255.255, 192.168.0.0–192.168.255.255). Если использовать IP-адреса вне этих диапазонов, то подключение не будет работать. 

Если эти рекомендации не помогут вам решить проблему, проверьте еще несколько простых вещей. 

* Отображается ли на портале шлюз в рабочем состоянии?
* Синхронизированы ли сертификаты?
* Менялась ли конфигурация сети после последнего выполнения синхронизации с сетью для соответствующих планов ASP? 

Если шлюз не работает, восстановите его работоспособность. Если сертификаты не синхронизированы, перейдите к представлению интеграции с виртуальной сетью на уровне ASP и нажмите "Синхронизировать сеть". Если вы подозреваете, что конфигурация виртуальной сети была изменена без синхронизации в рамках планов ASP, то перейдите к представлению интеграции с виртуальной сетью на уровне ASP и щелкните "Синхронизировать сеть". Напоминаем, что это вызовет кратковременную потерю подключения к виртуальной сети, что скажется на работе приложений. 

Если все описанные выше пункты в порядке, вам нужно провести расширенную проверку.

* Существуют ли другие приложения, которые используют интеграцию с виртуальной сетью для доступа к ресурсам в той же виртуальной сети? 
* Можете ли вы открыть консоль приложений и обратиться к другим ресурсам виртуальной сети с помощью средства tcpping? 

Если на любой из этих вопросов ответ будет положительным, то интеграция с виртуальной сетью выполнена. Причина проблемы в другом. Это сложная ситуация, так как простых методов, которые позволяют определить причину проблем с доступом к комбинации «узел:порт», не существует. Ниже представлено несколько возможных причин этой проблемы.

* На нужном узле запущен брандмауэр, который блокирует доступ к порту приложения для диапазона IP-адресов "точка — сеть". Для подключения между подсетями часто требуется разрешить общий доступ.
* Целевой узел не работает.
* Целевое приложение не работает.
* Указан неверный IP-адрес или неверное имя узла.
* Приложение ожидает передачи данных не по тому порту, который предполагается. Это можно проверить, войдя на нужный узел и выполнив команду netstat -aon из командной строки. Вы видите идентификаторы процессов и прослушиваемые ими порты. 
* Группы безопасности сети настроены на блокирование доступа к узлу и порту приложения для диапазона IP-адресов «точка-сеть».

Помните о том, что у вас нет возможности определить точный IP-адрес, используемый приложением. Поэтому вам нужно разрешить доступ для всего диапазона адресов «точка-сеть». 

Можно выполнить дополнительные действия по отладке.

* Войдите на другую виртуальную машину в этой виртуальной сети и попробуйте с нее обратиться к нужной комбинации "узел:порт". Это можно сделать с помощью любых служебных программ на основе TCP ping или средства telnet. Вам нужно поверить возможность подключения с другой виртуальной машины. 
* Откройте приложение на другой виртуальной машине и проверьте из консоли приложения доступ к узлу и порту.

#### <a name="on-premises-resources"></a>Локальные ресурсы ####
Если ваше приложение не может получить доступ к ресурсам в локальной среде, то первым делом следует проверить доступ к ресурсу в виртуальной сети. Если это работает, то попробуйте обратиться к локальному приложению с виртуальной машины, входящей в виртуальную сеть. Для этого используйте служебную программу telnet или TCP ping. Если получить доступ к локальному ресурсу с этой виртуальной машины не удастся, проверьте состояние VPN-подключения типа "сеть — сеть". Если подключение установлено, проверьте описанные выше пункты, а также конфигурацию и состояние локального шлюза. 

Теперь, если размещенная в виртуальной сети виртуальная машина может взаимодействовать с локальной системой, а приложение не может, то возможна одна из следующих причин этого:

* для маршрутов в локальном шлюзе не настроены диапазоны IP-адресов подключений "точка — сеть";
* ваши группы безопасности сети блокируют доступ к диапазону IP-адресов подключений "точка-сеть";
* локальные брандмауэры блокируют трафик из диапазона IP-адресов подключений "точка — сеть";
* в виртуальной сети задан определенный пользователем маршрут, который не дает трафику подключений "точка — сеть" попасть в локальную сеть.

## <a name="powershell-automation"></a>Автоматизация PowerShell

Службу приложений можно интегрировать с виртуальной сетью Azure с помощью PowerShell. Готовый к использованию скрипт см. в статье [Connect an app in Azure App Service to an Azure Virtual Network](https://gallery.technet.microsoft.com/scriptcenter/Connect-an-app-in-Azure-ab7527e3) (Подключение приложения в службе приложений Azure к виртуальной сети Azure).

## <a name="hybrid-connections-and-app-service-environments"></a>Гибридные подключения и среда службы приложений
Доступ к ресурсам виртуальной сети осуществляется тремя способами. К ним относятся:

* интеграция с виртуальной сетью;
* через гибридные подключения
* среда службы приложений.

Для гибридных подключений необходимо установить в сети агент ретрансляции, который называется диспетчером гибридного подключения. Диспетчер должен иметь возможность подключаться к Azure и к вашему приложению. Это решение особенно удобно для доступа из удаленной сети (локальной или другой облачной сети), так как для него не требуется конечная точка, доступная из Интернета. Диспетчер гибридного подключения работает только на платформе Windows. Можно запустить до пяти его экземпляров, чтобы обеспечить высокую доступность. Гибридные подключения поддерживают только протокол TCP, поэтому для каждой конечной точки должна быть определена комбинация «узел:порт». 

Среда службы приложений (ASE) позволяет запустить в виртуальной сети экземпляр службы приложений Azure. Приложение получает доступ к ресурсам виртуальной сети без каких-либо дополнительных действий. У среды службы приложений есть и другие преимущества. Например, вы можете использовать рабочие роли на основе Dv2 с 14 ГБ ОЗУ. Также вы получаете возможность масштабировать систему по мере необходимости. В отличие от мультитенантных сред, где размер плана ASP ограничен 20 экземплярами, в среде ASE можно выполнить масштабирование до 100 экземпляров ASP. Среда ASE, в отличие от функции интеграции с виртуальной сетью, поддерживает VPN ExpressRoute. 

Хотя эти решения используются в сходных сценариях, они не являются взаимозаменяемыми. Выбор подходящего способа подключения напрямую зависит от понимания своих задач. Например: 

* Если вы разработчик и просто хотите запустить сайт в Azure, который будет обращаться к базе данных на вашем настольном компьютере, проще всего использовать гибридные подключения. 
* Если вы представляете большую организацию, которой нужно поместить большое количество веб-свойств в общедоступное облако для управления из своей сети, вам подойдет среда службы приложений. 
* Если у вас есть несколько приложений, размещенных в службе приложений, которым нужно предоставить доступ к ресурсам виртуальной сети, выберите интеграцию с виртуальной сетью. 

Еще одним фактором, кроме соответствия решения определенным задачам, является простота его реализации. Если ваша виртуальная сеть уже подключена к локальной сети, использование интеграции с виртуальной сетью или среды службы приложений будет более простым способом доступа к локальным ресурсам. С другой стороны, если виртуальная сеть не подключена к локальной сети, то настройка VPN-подключения типа "сеть — сеть" окажется гораздо более затратным мероприятием по сравнению с установкой диспетчера гибридных подключений. 

Помимо функциональных различий учитывайте также разницу в стоимости решений. Среда службы приложений — это предложение класса «Премиум», которое предоставляет расширенные возможности настройки и множество других полезных функций. Интеграция с виртуальной сетью поддерживается в планах ASP уровня "Стандартный" или "Премиум". Эта функция идеально подходит для безопасного использования ресурсов в виртуальной сети из мультитенантной службы приложений. Для гибридных подключений сейчас требуется учетная запись BizTalk, которая доступна в виде бесплатной версии, а также в виде предложения, которое тарифицируется на основе используемых ресурсов. Если вам нужно работать с большим количеством сетей, лучшее решение — это гибридные подключения. Эта функция позволяет получить доступ к ресурсам, содержащимся более чем в 100 отдельных сетях. 

<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-upgradeplan.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-existingvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-createvnet.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-appmanage.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-aspmanage.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-aspmanagedetail.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-vnetp2s.png

<!--Links-->
[VNETOverview]: http://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[AzurePortal]: http://portal.azure.com/
[ASPricing]: http://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: http://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: http://azure.microsoft.com/pricing/details/data-transfers/
[V2VNETP2S]: http://azure.microsoft.com/documentation/articles/vpn-gateway-howto-point-to-site-rm-ps/
[ASEintro]: environment/intro.md
[ILBASE]: environment/create-ilb-ase.md
[V2VNETPortal]: ../vpn-gateway/vpn-gateway-howto-point-to-site-resource-manager-portal.md
[VPNERCoex]: ../expressroute/expressroute-howto-coexist-resource-manager.md
[ASE]: environment/intro.md
