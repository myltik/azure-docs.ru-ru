---
title: Настройка промежуточных сред для веб-приложений в службе приложений Azure | Документация Майкрософт
description: Узнайте, как использовать промежуточную публикацию для веб-приложений в службе приложений Azure.
services: app-service
documentationcenter: ''
author: cephalin
writer: cephalin
manager: erikre
editor: mollybos
ms.assetid: e224fc4f-800d-469a-8d6a-72bcde612450
ms.service: app-service
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/16/2016
ms.author: cephalin
ms.openlocfilehash: 2fabf0d61ffd2f526fab49816eab36a86497a358
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
ms.locfileid: "33764712"
---
# <a name="set-up-staging-environments-in-azure-app-service"></a>Настройка промежуточных сред в службе приложений Azure
<a name="Overview"></a>

Уровни плана службы приложений **Стандартный** и **Премиум** позволяют развертывать веб-приложения, веб-приложения в Linux, серверные части мобильных приложений и приложения API в [службе приложений](http://go.microsoft.com/fwlink/?LinkId=529714) в отдельный слот развертывания вместо рабочего слота по умолчанию. Слоты развертывания фактически являются динамическими приложениями со своими собственными именами узлов. Содержимое приложений и элементы конфигурации можно переключать между двумя слотами развертывания (включая рабочий слот). Развертывание приложения в области развертывания дает следующие преимущества:

* Внеся изменения в приложение, вы можете проверить их в промежуточном слоте развертывания, прежде чем переключать в рабочий слот.
* Развертывание приложения в промежуточном слоте и последующее переключение в рабочий слот позволяет подготовить все экземпляры слота до того, как они будут переключены в рабочую среду. Это позволит вам избежать простоя при развертывании приложения. Перенаправление трафика не вызывает затруднений, а запросы не теряются в результате операций подкачки. Весь этот рабочий процесс можно автоматизировать, настроив функцию [автоматического переноса](#Auto-Swap) , когда проверка перед переносом не требуется.
* После переключения в слоте, где ранее находилась промежуточная версия приложения, будет размещено приложение, которое до этого было рабочим. Если изменения в производственной области не соответствуют вашим ожиданиям, вы можете мгновенно переключиться назад к своему "последнему удачному сайту".

Каждый уровень плана службы приложений поддерживает разное количество слотов развертывания. Чтобы узнать, сколько слотов поддерживает уровень вашего приложения, ознакомьтесь с ограничениями службы приложений в следующей [статье](https://docs.microsoft.com/azure/azure-subscription-service-limits#app-service-limits). Чтобы масштабировать приложение на другой уровень, целевой уровень должен поддерживать такое число слотов, которое использует ваше приложение. Например, если приложение уже имеет более 5 слотов, вы не сможете уменьшить его масштаб до уровня **Стандартный**, на котором поддерживается только 5 слотов развертывания.

<a name="Add"></a>

## <a name="add-a-deployment-slot"></a>Добавление слота развертывания
Чтобы включить несколько слотов развертывания, приложение должно работать на уровне **Стандартный** или **Премиум**.

1. Откройте [колонку ресурсов](../azure-resource-manager/resource-group-portal.md#manage-resources) приложения на [портале Azure](https://portal.azure.com/).
2. Выберите параметр **Слоты развертывания** и щелкните **Добавить слот**.
   
    ![Добавить новый слот развернутого приложения][QGAddNewDeploymentSlot]
   
   > [!NOTE]
   > Если приложение не работает на уровне **Стандартный** или **Премиум**, появится сообщение со списком поддерживаемых уровней, которые позволяют использовать промежуточную публикацию. На этом этапе вы можете выбрать команду **Обновить** и перейти на вкладку **Масштаб** приложения, а затем продолжить процесс.
   > 
   > 
3. В колонке **Добавить слот** присвойте слоту имя и укажите, следует ли клонировать конфигурацию приложения из другого существующего слота развертывания. Установите флажок для продолжения.
   
    ![Источник конфигурации][ConfigurationSource1]
   
    При первом добавлении слота у вас есть только два варианта: клонировать конфигурацию рабочего слота по умолчанию или не делать этого.
    После создания нескольких областей у вас уже будет выбор для копирования конфигураций помимо производственной области:
   
    ![Источники конфигураций][MultipleConfigurationSources]
4. В колонке ресурсов приложения щелкните **Слот развертывания**, затем щелкните нужный слот развертывания. Откроется колонка ресурсов с набором метрик и настроек, как у любого другого приложения. В верхней части колонки отображается имя слота, напоминающее о том, что вы просматриваете слот развертывания.
   
    ![Название области развертывания][StagingTitle]
5. Щелкните URL-адрес приложения в колонке слота. Обратите внимание, что слот развертывания имеет собственное имя узла и также является динамическим приложением. Сведения о том, как запретить общий доступ к слоту развертывания, см. в статье [Веб-приложения в службе приложений — блокирование веб-доступа к непроизводственным слотам развертывания](http://ruslany.net/2014/04/azure-web-sites-block-web-access-to-non-production-deployment-slots/).

В созданном слоте развертывания изначально нет содержимого. Вы можете выполнить развертывание в область из другой ветви репозитория или вообще из другого репозитория. Вы также можете изменить конфигурацию области. Для обновлений содержимого используйте профиль публикации или учетные данные развертывания, связанные с областью развертывания.  Например, вы можете выполнить [публикацию в эту область с помощью Git](app-service-deploy-local-git.md).

<a name="AboutConfiguration"></a>

## <a name="which-settings-are-swapped"></a>Какие параметры переносятся?
При клонировании конфигурации из другой области развертывания вы можете изменять клонированную конфигурацию. Кроме того, некоторые элементы конфигурации будут перенесены вместе с содержимым в другой слот (элементы, которые не определяются слотом), тогда как другие элементы останутся на месте (определяемые слотом элементы). Ниже приведен список параметров, которые изменяются при переключении слотов.

**Переносимые параметры**:

* Общие параметры, например версия платформы, 32/64-разрядная версия, веб-сокеты
* Параметры приложения (их также можно привязать к слоту)
* Строки подключения (их также можно привязать к слоту)
* Сопоставления обработчиков
* Настройки диагностики и мониторинга
* Содержимое веб-заданий

**Непереносимые параметры**:

* Конечные точки публикации
* Имена пользовательских доменов
* SSL-сертификаты и SSL-привязки
* Параметры масштабирования
* Планировщики веб-заданий

Чтобы привязать параметры приложения или строку подключения к слоту (запретить их перенос в другой слот), откройте для нужного слота колонку **Параметры приложения** и установите флажок **Параметр слота** для всех элементов конфигурации, которые не нужно переносить в другой слот. Установка привязки к слоту для определенного элемента конфигурации означает, что этот элемент нельзя будет перенести в другие слоты развертывания, связанные с этим веб-приложением.

![Параметры слота][SlotSettings]

<a name="Swap"></a>

## <a name="swap-deployment-slots"></a>Переключение слотов развертывания 
Слоты развертывания вы можете переключить в представлении **Обзор** или **Слоты развертывания** в колонке ресурсов приложения.

> [!IMPORTANT]
> Перед переключением приложения из слота развертывания в рабочий слот убедитесь, что все параметры, которые не определяются слотом, настроены так, как нужно для рабочего слота.
> 
> 

1. Чтобы переключить слоты развертывания, нажмите кнопку **Перенести** на панели команд веб-приложения или на панели команд слота развертывания.
   
    ![Кнопка "Переключить"][SwapButtonBar]

2. Убедитесь, что исходный и целевой слоты указаны правильно. Как правило, в качестве целевого используется рабочий слот. Нажмите кнопку **ОК** , чтобы завершить операцию. После завершения операции содержимое слотов развертывания поменяется местами.

    ![Полное переключение](./media/web-sites-staged-publishing/SwapImmediately.png)

    Вариант **переключения с предварительным просмотром** описан в разделе [Переключение с предварительным просмотром (многофазное переключение)](#Multi-Phase).  

<a name="Multi-Phase"></a>

## <a name="swap-with-preview-multi-phase-swap"></a>Переключение с предварительным просмотром (многофазное переключение)

Переключение с предварительным просмотром, называемое также многофазным переключением, упрощает проверку настроек, определяемых слотами, таких как строки подключения.
Для критически важных рабочих нагрузок необходимо убедиться, что приложение при переключении в рабочий слот работает ожидаемым образом. Кроме того, такую проверку крайне желательно проводить *до* фактического переключения приложения в рабочую среду. Для этого используется переключение с предварительным просмотром.

> [!NOTE]
> Переключения с предварительным просмотром не поддерживаются в веб-приложениях Linux.

Когда вы используете вариант **Переключить с предварительным просмотром** (см. раздел [Переключение слотов развертывания](#Swap)), служба приложений выполняет следующие действия.

- Сохраняет целевой слот в неизменном виде, чтобы не влиять на текущую рабочую нагрузку в этом слоте (например, если это рабочий слот).
- Применяет элементы настройки из целевого слота к исходному слоту, в том числе строки соединения и параметры приложения, определяемые слотом.
- Перезапускает процессы рабочей роли в исходном слоте, используя указанные выше элементы настройки.
- После завершения переключения: перемещает уже подготовленный исходный слот на место целевого слота. Целевой слот перемещается на место исходного слота, как и при переключении вручную.
- При отмене переключения: возвращает в исходный слот все исходные элементы конфигурации.

Вы сможете увидеть, как приложение будет работать в конфигурации целевого слота. После завершения проверки выполните отдельное действие подтверждения переноса. Этот шаг дает еще одно преимущество: исходный слот будет заранее подготовлен в требуемой конфигурации, и клиентам не грозит простой приложения.  

Примеры командлетов Azure PowerShell, доступных для многофазного переключения, включены в раздел командлетов Azure PowerShell для слотов развертывания.

<a name="Auto-Swap"></a>

## <a name="configure-auto-swap"></a>Настройка автоматического переключения
Функция автоматического переключения упрощает сценарии DevOps, в рамках которых требуется регулярно разворачивать приложение с нулевым временем холодного запуска и нулевым временем простоя для конечных пользователей этого приложения. Для слота развертывания можно настроить автоматическое переключение в рабочую среду, и тогда при каждом обновлении кода в этом слоте служба приложений будет автоматически переключать приложение в рабочий слот, как только завершит подготовку приложения в слоте развертывания.

> [!IMPORTANT]
> Прежде чем включить автоматический перенос, убедитесь, что конфигурация слота точно соответствует конфигурации целевого слота (обычно производственного).
> 
> 

> [!NOTE]
> Автоматическое переключение не поддерживается в веб-приложениях Linux.

Настроить автоматический перенос для слота очень просто. Выполните следующие действия.

1. В списке **слотов развертывания** выберите слот, не являющийся рабочим, и выберите **Параметры приложения** в колонке ресурсов этого слота.  
   
    ![][Autoswap1]
2. Установите переключатель **Автоматическое переключение** в положение **Включено**, выберите из списка **Слот автоматического переключения** целевой слот и на панели команд щелкните **Сохранить**. Убедитесь, что конфигурация слота точно соответствует конфигурации, которую должен иметь целевой слот.
   
    После завершения операции на вкладке **Уведомления** появится зеленая мигающая надпись **Выполнено**.
   
    ![][Autoswap2]
   
   > [!NOTE]
   > Чтобы проверить функцию автоматического переключения приложения и ознакомиться с ее работой, сначала выберите в списке **Слот автоматического переключения** целевой слот, не являющийся рабочим.  
   > 
   > 
3. Передайте код в этот слот развертывания. Вскоре произойдет автоматическое переключение и эти изменения отразятся в URL-адресе целевого слота.

<a name="Rollback"></a>

## <a name="roll-back-a-production-app-after-swap"></a>Откат рабочего приложения после переключения
В случае обнаружения ошибок в производственной области вы можете выполнить откат сайтов до состояния, предшествующего их переключению, выполнив мгновенное обратное переключение тех же двух областей.

<a name="Warm-up"></a>

## <a name="custom-warm-up-before-swap"></a>Пользовательский прогрев перед заменой
Некоторые приложения могут потребовать пользовательских действий прогрева перед заменой. В элементе конфигурации `applicationInitialization` в файле web.config можно указать пользовательские действия инициализации, которые должны быть выполнены до получения запроса. Операция переключения ожидает, пока завершатся эти пользовательские действия подготовки. Ниже приведен пример фрагмента файла web.config.

    <applicationInitialization>
        <add initializationPage="/" hostName="[app hostname]" />
        <add initializationPage="/Home/About" hostname="[app hostname]" />
    </applicationInitialization>

## <a name="monitor-swap-progress"></a>Отслеживание переключения

В некоторых случаях операция переключения требует значительного времени, например, если переключаемое приложение долго подготавливается к запуску. Дополнительные сведения об операциях переключения вы можете получить из [журнала действий](../monitoring-and-diagnostics/monitoring-overview-activity-logs.md) на [портале Azure](https://portal.azure.com).

На странице портала со сведениями о приложении выберите **Журнал действий** в меню навигации слева.

Операция переключения отображается в запросах журнала в виде `Slotsswap`. Вы можете развернуть этот элемент и выбрать вложенные операции или ошибки, чтобы увидеть подробные сведения о них.

![Журнал действий для переключения слотов](media/web-sites-staged-publishing/activity-log.png)

<a name="Delete"></a>

## <a name="delete-a-deployment-slot"></a>Удаление слота развертывания
Откройте колонку слота развертывания, щелкните **Обзор** (эта страница открывается по умолчанию) и нажмите кнопку **Удалить** на панели команд.  

![Удаление слота развертывания][DeleteStagingSiteButton]

<!-- ======== AZURE POWERSHELL CMDLETS =========== -->

<a name="PowerShell"></a>

## <a name="automate-with-azure-powershell"></a>Автоматизация с помощью Azure PowerShell

Azure PowerShell — это модуль, который предоставляет командлеты для управления Azure с помощью Windows PowerShell, а также поддерживает управление слотами развертывания в службе приложений Azure.

* Сведения об установке и настройке Azure PowerShell и об аутентификации Azure PowerShell с использованием подписки Azure см. в разделе [Установка и настройка Microsoft Azure PowerShell](/powershell/azure/overview).  

- - -
### <a name="create-a-web-app"></a>Создание веб-приложения
```PowerShell
New-AzureRmWebApp -ResourceGroupName [resource group name] -Name [app name] -Location [location] -AppServicePlan [app service plan name]
```

- - -
### <a name="create-a-deployment-slot"></a>Создание слота развертывания
```PowerShell
New-AzureRmWebAppSlot -ResourceGroupName [resource group name] -Name [app name] -Slot [deployment slot name] -AppServicePlan [app service plan name]
```

- - -
### <a name="initiate-a-swap-with-preview-multi-phase-swap-and-apply-destination-slot-configuration-to-source-slot"></a>Запуск переключения с предварительным просмотром (многофазное переключение) и применение конфигурации целевого слота к исходному слоту
```PowerShell
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzureRmResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action applySlotConfig -Parameters $ParametersObject -ApiVersion 2015-07-01
```

- - -
### <a name="cancel-a-pending-swap-swap-with-review-and-restore-source-slot-configuration"></a>Отмена промежуточного переключения (переключения с предварительным просмотром) и восстановление конфигурации исходного слота
```PowerShell
Invoke-AzureRmResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action resetSlotConfig -ApiVersion 2015-07-01
```

- - -
### <a name="swap-deployment-slots"></a>Переключение слотов развертывания
```PowerShell
$ParametersObject = @{targetSlot  = "[slot name – e.g. “production”]"}
Invoke-AzureRmResourceAction -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots -ResourceName [app name]/[slot name] -Action slotsswap -Parameters $ParametersObject -ApiVersion 2015-07-01
```

### <a name="monitor-swap-events-in-the-activity-log"></a>Просмотр событий переключения в журнале действий
```PowerShell
Get-AzureRmLog -ResourceGroup [resource group name] -StartTime 2018-03-07 -Caller SlotSwapJobProcessor  
```

- - -
### <a name="delete-deployment-slot"></a>Удаление слота развертывания
```
Remove-AzureRmResource -ResourceGroupName [resource group name] -ResourceType Microsoft.Web/sites/slots –Name [app name]/[slot name] -ApiVersion 2015-07-01
```

- - -
<!-- ======== Azure CLI =========== -->

<a name="CLI"></a>

## <a name="automate-with-azure-cli"></a>Автоматизация с помощью Azure CLI

Чтобы ознакомиться с командами [Azure CLI](https://github.com/Azure/azure-cli) для слотов развертывания, изучите описание команды [az webapp deployment slot](/cli/azure/webapp/deployment/slot).

## <a name="next-steps"></a>Дополнительная информация
[Веб-приложения в службе приложений — блокирование веб-доступа к непроизводственным слотам развертывания](http://ruslany.net/2014/04/azure-web-sites-block-web-access-to-non-production-deployment-slots/)  
[Вводные сведения о службе приложений на платформе Linux](../app-service/containers/app-service-linux-intro.md)  
[Бесплатная пробная версия Microsoft Azure](https://azure.microsoft.com/pricing/free-trial/)

<!-- IMAGES -->
[QGAddNewDeploymentSlot]:  ./media/web-sites-staged-publishing/QGAddNewDeploymentSlot.png
[AddNewDeploymentSlotDialog]: ./media/web-sites-staged-publishing/AddNewDeploymentSlotDialog.png
[ConfigurationSource1]: ./media/web-sites-staged-publishing/ConfigurationSource1.png
[MultipleConfigurationSources]: ./media/web-sites-staged-publishing/MultipleConfigurationSources.png
[SiteListWithStagedSite]: ./media/web-sites-staged-publishing/SiteListWithStagedSite.png
[StagingTitle]: ./media/web-sites-staged-publishing/StagingTitle.png
[SwapButtonBar]: ./media/web-sites-staged-publishing/SwapButtonBar.png
[SwapConfirmationDialog]:  ./media/web-sites-staged-publishing/SwapConfirmationDialog.png
[DeleteStagingSiteButton]: ./media/web-sites-staged-publishing/DeleteStagingSiteButton.png
[SwapDeploymentsDialog]: ./media/web-sites-staged-publishing/SwapDeploymentsDialog.png
[Autoswap1]: ./media/web-sites-staged-publishing/AutoSwap01.png
[Autoswap2]: ./media/web-sites-staged-publishing/AutoSwap02.png
[SlotSettings]: ./media/web-sites-staged-publishing/SlotSetting.png

