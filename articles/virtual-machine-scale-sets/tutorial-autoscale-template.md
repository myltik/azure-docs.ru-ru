---
title: Руководство. Автомасштабирование масштабируемого набора с помощью шаблонов Azure | Документация Майкрософт
description: Сведения об использовании шаблонов Azure Resource Manager для автомасштабирования масштабируемого набора виртуальных машин по мере увеличения и уменьшения нагрузки на ЦП.
services: virtual-machine-scale-sets
documentationcenter: ''
author: iainfoulds
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 03/27/2018
ms.author: iainfou
ms.custom: mvc
ms.openlocfilehash: 7ca037a6aec8516d9656b3389da67b9b02a906d8
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="tutorial-automatically-scale-a-virtual-machine-scale-set-with-an-azure-template"></a>Руководство. Автомасштабирование масштабируемого набора виртуальных машин с помощью шаблона Azure
При создании масштабируемого набора вы определяете количество экземпляров виртуальных машин для запуска. По мере изменения потребностей приложения можно автоматически увеличивать или уменьшать это количество. Возможность автоматического масштабирования позволяет удовлетворить пользовательский спрос или среагировать на изменения производительности приложения на протяжении его жизненного цикла. Из этого руководства вы узнали, как выполнять такие задачи:

> [!div class="checklist"]
> * автомасштабирование масштабируемого набора;
> * создание и использование правил автомасштабирования;
> * нагрузочное тестирование экземпляров виртуальных машин и активация правил автомасштабирования;
> * обратное автомасштабирование при уменьшении потребности в ресурсах.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

[!INCLUDE [cloud-shell-try-it.md](../../includes/cloud-shell-try-it.md)]

Если вы решили установить и использовать интерфейс командной строки локально, для работы с этим руководством вам понадобится Azure CLI 2.0.29 или более поздней версии. Чтобы узнать версию, выполните команду `az --version`. Если вам необходимо выполнить установку или обновление, см. статью [Установка Azure CLI 2.0]( /cli/azure/install-azure-cli). 


## <a name="define-an-autoscale-profile"></a>Определение профиля автомасштабирования
Определите в шаблоне Azure профиль автомасштабирования с поставщиком ресурсов *Microsoft.insights/autoscalesettings*. В *профиле* содержатся сведения о емкости масштабируемого набора и связанных с ним правилах. В следующем примере определяется профиль с именем *Autoscale by percentage based on CPU usage* (Автомасштабирование в процентах на основе использования ЦП) и задается значение емкости по умолчанию экземпляров виртуальной машины, а также минимальная (*2*) и максимальная емкость (*10*).

```json
{
"type": "Microsoft.insights/autoscalesettings",
"name": "Autoscale",
"apiVersion": "2014-04-01",
"location": "[variables('location')]",
"scale": null,
"properties": {
  "profiles": [
    {
      "name": "Autoscale by percentage based on CPU usage",
      "capacity": {
        "minimum": "2",
        "maximum": "10",
        "default": "2"
      }
    }
  ]
}
```


## <a name="define-a-rule-to-autoscale-out"></a>Определение правила для автоматического развертывания
При увеличении потребностей приложения в масштабируемом наборе увеличивается нагрузка на экземпляры виртуальной машины. Если такая увеличенная нагрузка представляет собой не просто краткий спрос, а является согласованной, можно настроить правила автомасштабирования, чтобы увеличить число экземпляров виртуальной машины в масштабируемом наборе. После создания этих экземпляров виртуальных машин и развертывания приложений масштабируемые наборы запускают распределение трафика между ними через подсистему балансировки нагрузки. Вы можете контролировать, какие метрики отслеживать, например ЦП или диск, продолжительность соответствия нагрузки приложения заданному пороговому значению, а также количество экземпляров виртуальной машины для добавления в масштабируемый набор.

В следующем примере определяется правило, в соответствии с которым количество экземпляров виртуальных машин в масштабируемом наборе увеличивается, когда средняя загрузка ЦП превышает 70 % в течение 5 минут. При активации правила количество экземпляров виртуальных машин увеличивается до трех.

Ниже приведены параметры, используемые для этого правила.

| Параметр         | Пояснение                                                                                                         | Значение           |
|-------------------|---------------------------------------------------------------------------------------------------------------------|-----------------|
| *metricName*      | Метрика производительности для мониторинга и применения действий в масштабируемом наборе.                                                   | Percentage CPU  |
| *timegrain*       | Определяет, как часто собираются показатели для анализа.                                                                   | 1 минута        |
| *timeAggregation* | Определяет способ вычисления собранных метрик для анализа.                                                | Средняя         |
| *timeWindow*      | Количество времени, в течение которого выполняется отслеживание перед сравнением значений метрик и пороговых значений.                                   | 5 мин       |
| *operator*        | Оператор для сравнения данных метрики с пороговым значением.                                                     | Больше чем    |
| *threshold*       | Значение, при достижении которого правило автомасштабирования запускает действие.                                                      | 70 %             |
| *direction*       | Определяет действие, применяемое к масштабируемому набору при выполнении условий правила: увеличение или уменьшение числа экземпляров.                                              | Увеличить        |
| *type*            | Указывает, что количество экземпляров виртуальных машин необходимо изменить, использовав определенное значение.                                    | Изменение количества    |
| *значение*           | Указывает, сколько экземпляров виртуальных машин следует добавить или удалить, когда применяется правило.                                             | 3               |
| *cooldown*        | Время ожидания перед повторным применением правила, чтобы обеспечить время для активации действий автомасштабирования. | 5 мин       |

Следующее правило будет добавлено в раздел профиля поставщика ресурсов *Microsoft.insights/autoscalesettings* из предыдущего раздела.

```json
"rules": [
  {
    "metricTrigger": {
      "metricName": "Percentage CPU",
      "metricNamespace": "",
      "metricResourceUri": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/',  resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/', variables('vmssName'))]",
      "metricResourceLocation": "[variables('location')]",
      "timeGrain": "PT1M",
      "statistic": "Average",
      "timeWindow": "PT5M",
      "timeAggregation": "Average",
      "operator": "GreaterThan",
      "threshold": 70
    },
    "scaleAction": {
      "direction": "Increase",
      "type": "ChangeCount",
      "value": "3",
      "cooldown": "PT5M"
    }
  }
]
```


## <a name="define-a-rule-to-autoscale-in"></a>Определение правила для автоматического свертывания
В вечерние часы или выходные дни потребность в приложении может снизиться. Если такая сниженная нагрузка является согласованной в течение некоторого периода времени, можно настроить правила автомасштабирования, чтобы уменьшить число экземпляров виртуальных машин в масштабируемом наборе. Это действие снижает стоимость запуска масштабируемого набора, так как вы запускаете только то количество экземпляров, которое необходимо для удовлетворения текущего спроса.

В следующем примере определяется правило, в соответствии с которым количество экземпляров виртуальной машины уменьшается на один, когда средняя загрузка ЦП не превышает 30 % в течение 5 минут. Это правило будет добавлено в профиль автомасштабирования после предыдущего.

```json
{
  "metricTrigger": {
    "metricName": "Percentage CPU",
    "metricNamespace": "",
    "metricResourceUri": "[concat('/subscriptions/',subscription().subscriptionId, '/resourceGroups/',  resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/', variables('vmssName'))]",
    "metricResourceLocation": "[variables('location')]",
    "timeGrain": "PT1M",
    "statistic": "Average",
    "timeWindow": "PT5M",
    "timeAggregation": "Average",
    "operator": "LessThan",
    "threshold": 30
  },
  "scaleAction": {
    "direction": "Decrease",
    "type": "ChangeCount",
    "value": "1",
    "cooldown": "PT5M"
  }
}
```


## <a name="create-an-autoscaling-scale-set"></a>Создание масштабируемого набора автомасштабирования
Мы используем пример шаблона для создания масштабируемого набора и применения правил автомасштабирования. См. [полный шаблон](https://raw.githubusercontent.com/Azure-Samples/compute-automation-configurations/master/scale_sets/autoscale.json) или [раздел *шаблона о поставщике ресурсов* Microsoft.insights/autoscalesettings](https://github.com/Azure-Samples/compute-automation-configurations/blob/master/scale_sets/autoscale.json#L220).

Сначала создайте группу ресурсов с помощью команды [az group create](/cli/azure/group#az_group_create). В следующем примере создается группа ресурсов с именем *myResourceGroup* в расположении *eastus*.

```azurecli-interactive
az group create --name myResourceGroup --location eastus
```

Создайте масштабируемый набор виртуальных машин с помощью команды [az group deployment create](/cli/azure/group/deployment#az_group_deployment_create). При появлении запроса укажите имя пользователя, например *azureuser*, и пароль, используемые в качестве учетных данных для каждого экземпляра виртуальной машины.

```azurecli-interactive
az group deployment create \
  --resource-group myResourceGroup \
  --template-uri https://raw.githubusercontent.com/Azure-Samples/compute-automation-configurations/master/scale_sets/autoscale.json
```

Создание и настройка всех ресурсов и виртуальных машин масштабируемого набора занимает несколько минут.


## <a name="generate-cpu-load-on-scale-set"></a>Создание нагрузки на ЦП в масштабируемом наборе
Чтобы проверить правила автомасштабирования, создайте нагрузку на ЦП в экземплярах виртуальных машин в масштабируемом наборе. В результате этой имитации нагрузки на ЦП происходит автомасштабирование и увеличение числа экземпляров виртуальных машин. Когда имитированная нагрузка на ЦП снижается, в соответствии с правилами автомасштабирования выполняется уменьшение числа экземпляров виртуальных машин.

Сначала нужно получить список адресов и портов для подключения к экземплярам виртуальных машин в масштабируемом наборе. Для этого введите команду [az vmss list-instance-connection-info](/cli/azure/vmss#az_vmss_list_instance_connection_info):

```azurecli-interactive
az vmss list-instance-connection-info \
  --resource-group myResourceGroup \
  --name myScaleSet
```

В следующем примере выходных данных показано имя экземпляра, общедоступный IP-адрес подсистемы балансировки нагрузки и номер порта, на который правила преобразования сетевых адресов перенаправляют трафик.

```json
{
  "instance 1": "13.92.224.66:50001",
  "instance 3": "13.92.224.66:50003"
}
```

Установите SSH-подключение к первому экземпляру виртуальной машины. Укажите собственный общедоступный IP-адрес и номер порта с помощью параметра `-p`, как показано в предыдущей команде.

```azurecli-interactive
ssh azureuser@13.92.224.66 -p 50001
```

После входа в систему установите служебную программу **stress**. Запустите *10* **нагрузочных** рабочих процессов, которые создают нагрузку на ЦП. Эти рабочие процессы выполняются на протяжении *420* секунд. Этого достаточно, чтобы активировать правила автомасштабирования для реализации нужного действия.

```azurecli-interactive
sudo apt-get -y install stress
sudo stress --cpu 10 --timeout 420 &
```

Когда в служебной программе **stress** отобразятся выходные данные, аналогичные *stress: info: [2688] dispatching hogs: 10 cpu, 0 io, 0 vm, 0 hdd*, нажмите клавишу *ВВОД*, чтобы вернуться к командной строке.

Чтобы убедиться, что программа **stress** создает нагрузку на ЦП, проверьте активную нагрузку на систему с помощью служебной программы **top**.

```azuecli-interactive
top
```

Выйдите из программы **top** и разорвите подключение к экземпляру виртуальной машины. Служебная программа **stress** продолжает работать на экземпляре виртуальной машины.

```azurecli-interactive
Ctrl-c
exit
```

Подключитесь ко второму экземпляру виртуальной машины, используя номер порта, указанный в предыдущей команде [az vmss list-instance-connection-info](/cli/azure/vmss#az_vmss_list_instance_connection_info).

```azurecli-interactive
ssh azureuser@13.92.224.66 -p 50003
```

Установите и запустите служебную программу **stress**, затем запустите десять рабочих процессов на втором экземпляре виртуальной машины.

```azurecli-interactive
sudo apt-get -y install stress
sudo stress --cpu 10 --timeout 420 &
```

Опять-таки, когда в служебной программе **stress** отобразятся выходные данные, аналогичные *stress: info: [2713] dispatching hogs: 10 cpu, 0 io, 0 vm, 0 hdd*, нажмите клавишу *ВВОД*, чтобы вернуться к командной строке.

Разорвите подключение ко второму экземпляру виртуальной машины. Служебная программа **stress** продолжает работать на экземпляре виртуальной машины.

```azurecli-interactive
exit
```

## <a name="monitor-the-active-autoscale-rules"></a>Мониторинг активных правил автомасштабирования
Чтобы отслеживать количество экземпляров виртуальных машин в масштабируемом наборе, используйте **watch**. Потребуется 5 минут, чтобы в соответствии с правилами автомасштабирования началось увеличение масштаба с учетом нагрузки на ЦП, созданной программой **stress** на каждом экземпляре виртуальной машины.

```azurecli-interactive
watch az vmss list-instances \
  --resource-group myResourceGroup \
  --name myScaleSet \
  --output table
```

Когда достигается порог нагрузки на ЦП, в соответствии с правилами автомасштабирования увеличивается число экземпляров виртуальных машин в масштабируемом наборе. В следующих выходных данных показано, что при автомасштабировании масштабируемого набора создано три виртуальные машины.

```bash
Every 2.0s: az vmss list-instances --resource-group myResourceGroup --name myScaleSet --output table

  InstanceId  LatestModelApplied    Location    Name          ProvisioningState    ResourceGroup    VmId
------------  --------------------  ----------  ------------  -------------------  ---------------  ------------------------------------
           1  True                  eastus      myScaleSet_1  Succeeded            MYRESOURCEGROUP  4f92f350-2b68-464f-8a01-e5e590557955
           2  True                  eastus      myScaleSet_2  Succeeded            MYRESOURCEGROUP  d734cd3d-fb38-4302-817c-cfe35655d48e
           4  True                  eastus      myScaleSet_4  Creating             MYRESOURCEGROUP  061b4c90-0d73-49fc-a066-19eab0b3d95c
           5  True                  eastus      myScaleSet_5  Creating             MYRESOURCEGROUP  4beff8b9-4e65-40cb-9652-43899309da27
           6  True                  eastus      myScaleSet_6  Creating             MYRESOURCEGROUP  9e4133dd-2c57-490e-ae45-90513ce3b336
```

После остановки служебной программы **stress** на начальных экземплярах виртуальной машины восстанавливается нормальная нагрузка на ЦП. На протяжении следующих 5 минут в соответствии с правилами автомасштабирования уменьшается число экземпляров виртуальных машин. При таком свертывании сначала удаляются экземпляры виртуальных машин с более высокими значениями идентификатора. Если в масштабируемом наборе используются группы доступности или зоны доступности, действия свертывания равномерно распределяются между экземплярами виртуальных машин. В следующем примере выходных данных показано удаление одного экземпляра виртуальной машины при автоматическом уменьшении масштаба масштабируемого набора:

```bash
           6  True                  eastus      myScaleSet_6  Deleting             MYRESOURCEGROUP  9e4133dd-2c57-490e-ae45-90513ce3b336
```

Выйдите из программы *watch* с помощью команды `Ctrl-c`. Каждые 5 минут будет происходить уменьшение масштаба масштабируемого набора с удалением одного экземпляра виртуальной машины, пока не будет достигнуто минимальное число экземпляров (2 экземпляра).


## <a name="clean-up-resources"></a>Очистка ресурсов
Чтобы удалить масштабируемый набор и дополнительные ресурсы, удалите группу ресурсов и все входящие в нее ресурсы с помощью команды [az group delete](/cli/azure/group#az_group_delete).

```azurecli-interactive
az group delete --name myResourceGroup --yes --no-wait
```


## <a name="next-steps"></a>Дополнительная информация
Из этого руководства вы узнали, как выполнять автомасштабирование масштабируемого набора с помощью Azure CLI 2.0.

> [!div class="checklist"]
> * автомасштабирование масштабируемого набора;
> * создание и использование правил автомасштабирования;
> * нагрузочное тестирование экземпляров виртуальных машин и активация правил автомасштабирования;
> * обратное автомасштабирование при уменьшении потребности в ресурсах.

Дополнительные примеры использования масштабируемых наборов виртуальных машин см. в следующих примерах скриптов для Azure CLI 2.0:

> [!div class="nextstepaction"]
> [Примеры скриптов Azure CLI 2.0 для масштабируемых наборов](cli-samples.md)