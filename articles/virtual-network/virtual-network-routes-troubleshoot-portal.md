---
title: Устранение проблем с маршрутами на портале | Документация Майкрософт
description: Узнайте, как устранять проблемы с маршрутами в модели развертывания с помощью Azure Resource Manager на портале Azure.
services: virtual-network
documentationcenter: na
author: AnithaAdusumilli
manager: narayan
editor: ''
tags: azure-resource-manager
ms.assetid: bdd8b6dc-02fb-4057-bb23-8289caa9de89
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/23/2016
ms.author: anithaa
ms.openlocfilehash: 7c9d49a4135860bce317cd5808d3430af6b49fbd
ms.sourcegitcommit: e14229bb94d61172046335972cfb1a708c8a97a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
---
# <a name="troubleshoot-routes-using-the-azure-portal"></a>Устранение проблем с маршрутами на портале Azure
> [!div class="op_single_selector"]
> * [портал Azure](virtual-network-routes-troubleshoot-portal.md)
> * [PowerShell](virtual-network-routes-troubleshoot-powershell.md)
>
>

Если возникают проблемы с входящим или исходящим сетевым соединением виртуальной машины Azure, возможно, на потоки трафика ВМ влияют маршруты. Эта статья содержит обзор возможностей диагностики маршрутов для дальнейшего устранения неполадок.

Таблицы маршрутов связаны с подсетями и действуют во всех сетевых интерфейсах в подсети. Для каждого сетевого интерфейса могут применяться указанные далее типы маршрутов.

* **Системные маршруты.** По умолчанию каждая подсеть, созданная в виртуальной сети Azure, содержит таблицы системных маршрутов. Они разрешают локальный трафик виртуальной сети, локальный трафик через VPN-шлюзы и интернет-трафик. Кроме того, существуют системные маршруты для пиринговых виртуальных сетей.
* **Маршруты BGP.** Распространяются на сетевые интерфейсы через ExpressRoute или VPN-подключения типа "сеть — сеть". Дополнительные сведения о маршрутизации BGP см. в статьях [Обзор использования BGP с VPN-шлюзами Azure](../vpn-gateway/vpn-gateway-bgp-overview.md) и [Технический обзор ExpressRoute](../expressroute/expressroute-introduction.md).
* **Определяемые пользователем маршруты (UDR).** Если вы используете виртуальные сетевые устройства или принудительное туннелирование трафика в локальную сеть через VPN-подключение типа "сеть — сеть", вы можете использовать определяемые пользователем маршруты, связанные с таблицей маршрутов подсети. Если вы не знакомы с этими маршрутами, прочтите статью [Что такое определяемые пользователем маршруты и IP-пересылка](virtual-networks-udr-overview.md#user-defined) .

Когда в сетевом интерфейсе применяются различные маршруты, может быть сложно определить, какие агрегированные маршруты эффективны. Просмотрите все эффективные маршруты сетевого интерфейса в модели развертывания с помощью Azure Resource Manager, чтобы получить информацию, которая поможет устранить неполадки сетевого подключения виртуальной машины.

## <a name="using-effective-routes-to-troubleshoot-vm-traffic-flow"></a>Использование эффективных маршрутов для устранения неполадок с передачей трафика в виртуальной машине
В этой статье для иллюстрации устранения неполадок эффективных маршрутов сетевого интерфейса в качестве примера используется указанный далее сценарий.

Виртуальной машине (*VM1*), подключенной к виртуальной сети (*VNet1*, префикс 10.9.0.0/16), не удается подключиться к ВМ (VM3) в виртуальной сети, для которой недавно был осуществлен пиринг (*VNet3*, префикс 10.10.0.0/16). К сетевому интерфейсу VM1-NIC1, подключенному к виртуальной машине, не применяются маршруты UDR или BGP. Применяются только системные маршруты.

В этой статье объясняется, как определить причину сбоя подключения с помощью эффективных маршрутов в модели развертывания Azure Resource Manager.
Хотя в этом примере используются только системные маршруты, описанные в нем действия помогут определить, почему происходит сбой входящего и исходящего подключения для любого типа маршрута.

> [!NOTE]
> Если к виртуальной машине подключены несколько сетевых адаптеров, проверьте эффективные маршруты для каждого из них. Это поможет диагностировать проблемы с входящим и исходящим сетевым соединением виртуальной машины.
>
>

### <a name="view-effective-routes-for-a-virtual-machine"></a>Просмотр эффективных маршрутов виртуальной машины
Чтобы просмотреть агрегированные маршруты, которые применяются к виртуальной машине, сделайте следующее:

1. Войдите на портал Azure: https://portal.azure.com. Необходимо назначить вашей учетной записи операцию *Microsoft.Network/networkInterfaces/effectiveRouteTable/action* для сетевого интерфейса. Дополнительные сведения о назначении операций для учетных записей см. в статье [Создание пользовательских ролей для управления доступом на основе ролей в Azure](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).
2. Выберите **Все службы**, а затем из появившегося списка выберите **Виртуальные машины**.
3. Откроется список, где необходимо выбрать виртуальную машину для устранения проблем, после чего отобразится колонка параметров виртуальной машины.
4. Выберите **Диагностика и решение проблем**, а затем распространенную проблему. В этом примере — **Я не могу подключиться к виртуальной машине Windows** .

    ![](./media/virtual-network-routes-troubleshoot-portal/image1.png)
5. Под проблемой отобразятся действия по устранению, как показано на следующем рисунке.

    ![](./media/virtual-network-routes-troubleshoot-portal/image2.png)

    Щелкните ссылку *effective routes* (эффективные маршруты) в списке рекомендуемых шагов.
6. Откроется колонка **Effective routes** (Эффективные маршруты), как показано на следующем рисунке.

    ![](./media/virtual-network-routes-troubleshoot-portal/image3.png)

    Если ваша виртуальная машина содержит только один сетевой интерфейс, он выбирается по умолчанию. При наличии нескольких сетевых интерфейсов выберите тот, для которого нужно просмотреть эффективные маршруты.

   > [!NOTE]
   > Если виртуальная машина, связанная с сетевым интерфейсом, не запущена, эффективные маршруты не отображаются. На портале отображаются только первые 200 эффективных маршрутов. Чтобы просмотреть весь список, щелкните **Скачать**. В скачанном CSV-файле результаты можно отфильтровать.
   >
   >

    В выходных данных обратите внимание на следующие параметры:

   * **Источник**— тип маршрута. Для системных маршрутов задано значение *По умолчанию*, для определяемых пользователем маршрутов — *Пользователь*, а для маршрутов шлюза — *VPNGateway*.
   * **State**— указывает состояние эффективного маршрута. Возможные значения: *Active* (Активный) или *Invalid* (Недействительный).
   * **AddressPrefixes**— указывает префикс адреса эффективного маршрута в нотации CIDR.
   * **nextHopType**— указывает следующий прыжок для указанного маршрута. Возможные значения: *VirtualAppliance*, *Internet*, *VNetLocal*, *VNetPeering* или *Null*. Значение *Null* для **nextHopType** в UDR может означать недействительный маршрут. Например, если для **nextHopType** задано значение *VirtualAppliance* и виртуальная машина с виртуальным сетевым устройством не находится в состоянии подготовки или выполнения. Если для **nextHopType** задано значение *VPNGateway* и в указанной виртуальной сети не подготавливается и не выполняется ни один шлюз, маршрут может стать недопустимым.
7. В результатах, полученных на предыдущем шаге, отсутствует маршрут для виртуальной сети *WestUS-VNET3* (префикс 10.10.0.0/16) из *WestUS-VNet1* (префикс 10.9.0.0/16). На следующем рисунке пиринговое соединение находится в состоянии *Отключено* .

    ![](./media/virtual-network-routes-troubleshoot-portal/image4.png)

    Двунаправленная связь для пиринга разорвана, что объясняет, почему VM1 не удалось подключиться к VM3 в виртуальной сети *WestUS-VNet3* .
8. На следующем рисунке показаны маршруты после установки двунаправленной пиринговой связи.

    ![](./media/virtual-network-routes-troubleshoot-portal/image5.png)

Дополнительные сведения об устранении неполадок, связанных с принудительным туннелированием и оценкой маршрута, см. в разделе [Рекомендации](virtual-network-routes-troubleshoot-portal.md#considerations) этой статьи.

### <a name="view-effective-routes-for-a-network-interface"></a>Просмотр эффективных маршрутов сетевого интерфейса
Если сетевой трафик относится к определенному сетевому интерфейсу, список всех эффективных маршрутов можно просмотреть непосредственно в сетевом интерфейсе. Чтобы просмотреть агрегированные маршруты, которые применяются к сетевому интерфейсу, сделайте следующее:

1. Войдите на портал Azure: https://portal.azure.com.
2. Выберите **Все службы**, а затем выберите **Сетевые интерфейсы**.
3. Найдите в списке имя сетевого интерфейса или выберите его из появившегося списка. В этом примере — **VM1-NIC1** .
4. В колонке **Сетевой интерфейс** выберите **Эффективные маршруты**.

       ![](./media/virtual-network-routes-troubleshoot-portal/image6.png)

    Для значения параметра **Область действия** по умолчанию задается выбранный сетевой интерфейс.

      ![](./media/virtual-network-routes-troubleshoot-portal/image7.png)

### <a name="view-effective-routes-for-a-route-table"></a>Просмотр эффективных маршрутов таблицы маршрутов
При изменении определяемых пользователем маршрутов в таблице маршрутов можно также просмотреть влияние добавляемых маршрутов на определенную виртуальную машину. Таблицу маршрутов можно связать с любым количеством подсетей. Теперь вы можете просмотреть полный список эффективных маршрутов для всех сетевых интерфейсов, к которым применяется эта таблица маршрутов, не переключая контекст текущей колонки таблицы маршрутов.

В нашем примере в таблице маршрутов (*UDRouteTable*) указан определяемый пользователем маршрут (*UDRoute*). Этот маршрут отправляет весь интернет-трафик из *Subnet1* в виртуальную сеть *WestUS-VNet1* через виртуальное сетевое устройство в подсети *Subnet2* той же виртуальной сети. Этот маршрут показан на следующем снимке экрана.

![](./media/virtual-network-routes-troubleshoot-portal/image8.png)

Чтобы просмотреть агрегированные маршруты для таблицы маршрутов, сделайте следующее:

1. Войдите на портал Azure: https://portal.azure.com.
2. Выберите **Все службы**, а затем выберите **Таблицы маршрутов**.
3. Найдите в списке таблицу маршрутов, для которой нужно просмотреть агрегированные маршруты, и выберите ее. В этом примере — **UDRouteTable** . Откроется колонка выбранной таблицы маршрутов, как показано на следующем снимке экрана.

    ![](./media/virtual-network-routes-troubleshoot-portal/image9.png)
4. В колонке **Таблица маршрутов** выберите **Эффективные маршруты**. Для значения параметра **Область действия** будет задана выбранная таблица маршрутов.
5. Таблицу маршрутов можно применить к нескольким подсетям. Выберите в списке **подсеть** , которую нужно просмотреть. В этом примере — **Subnet1** .
6. Выберите **Сетевой интерфейс**. В списке содержатся все сетевые интерфейсы, подключенные к выбранной подсети. В этом примере — **VM1-NIC1** .

    ![](./media/virtual-network-routes-troubleshoot-portal/image10.png)

   > [!NOTE]
   > Если сетевой интерфейс связан с виртуальной машиной, которая не запущена, эффективные маршруты не отображаются.
   >
   >

## <a name="considerations"></a>Рекомендации
Ниже приведено несколько аспектов, которые следует учитывать при просмотре списка маршрутов.

* Маршрутизация основана на совпадении самого длинного префикса (LPM) среди маршрутов UDR, BGP и системных маршрутов. При наличии нескольких маршрутов с одинаковыми совпадающими значениями LPM маршрут выбирается по источнику в следующем порядке:

  * определяемый пользователем маршрут;
  * маршрут BGP;
  * системный (стандартный) маршрут.

    Функция эффективных маршрутов позволяет просмотреть только эффективные маршруты, выделенные из доступных маршрутов при помощи совпадающего значения LPM. Отображение фактического способа вычисления маршрутов для отдельного сетевого адаптера упрощает устранение неполадок в определенных маршрутах, которые могут повлиять на входящее и исходящее соединение виртуальной машины.
* Если вы используете маршруты UDR и отправляете трафик на виртуальное сетевое устройство и при этом для параметра *VirtualAppliance* установлено значение **nextHopType**, обязательно включите IP-пересылку на принимающем трафик виртуальном сетевом устройстве, иначе пакеты будут пропускаться.
* Если включено принудительное туннелирование, весь исходящий интернет-трафик будет перенаправлен в локальную систему. Если этот параметр включен, доступ RDP или SSH из Интернета к виртуальной машине может не работать. Это зависит от способа обработки трафика локальной системой.
  Принудительное туннелирование можно включить:
  * если используется VPN-подключение типа "сеть — сеть" (задайте определяемый пользователем маршрут и укажите для параметра nextHopType значение VPN-шлюза);
  * если маршрут по умолчанию объявляется через BGP.
* Для правильной работы пирингового трафика виртуальной сети системный маршрут, в котором для **nextHopType** *VNetPeering* , должен действовать в диапазоне префиксов пиринговой виртуальной сети. Если такого маршрута не существует и пиринговая связь сети действует нормально, возможны два сценария действий.
  * Подождите несколько секунд и повторите попытку, если пиринговая связь установлена недавно. Иногда требуется больше времени, чтобы распространить маршруты для всех сетевых интерфейсов в подсети.
  * Правила групп безопасности сети (NSG) могут влиять на потоки трафика. Дополнительные сведения см. в статье, посвященной [устранению неполадок с группами безопасности сети](virtual-network-nsg-troubleshoot-portal.md).
