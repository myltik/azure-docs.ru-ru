---
title: Устранение проблем групп безопасности сети на портале | Документация Майкрософт
description: Узнайте, как устранять проблемы с группами безопасности сети в модели развертывания с помощью Azure Resource Manager, используя портал Azure.
services: virtual-network
documentationcenter: na
author: AnithaAdusumilli
manager: narayan
editor: ''
tags: azure-resource-manager
ms.assetid: a54feccf-0123-4e49-a743-eb8d0bdd1ebc
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 09/23/2016
ms.author: anithaa
ms.openlocfilehash: be400d674068d89f60d3c999006bc9291944ab1c
ms.sourcegitcommit: e14229bb94d61172046335972cfb1a708c8a97a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2018
---
# <a name="troubleshoot-network-security-groups-using-the-azure-portal"></a>Устранение проблем с группами безопасности сети на портале Azure
> [!div class="op_single_selector"]
> * [портал Azure](virtual-network-nsg-troubleshoot-portal.md)
> * [PowerShell](virtual-network-nsg-troubleshoot-powershell.md)
> 
> 

Если вы настроили группы безопасности сети (NSG) на виртуальной машине, но возникают проблемы с подключением к ней, эта статья поможет вам устранить их, так как здесь приводятся возможности диагностики NSG.

NSG позволяют управлять типом трафика, передаваемого в виртуальные машины и из них. NSG можно применять к подсетям в виртуальной сети Azure и сетевым интерфейсам или и к тем, и к другим. Действующие правила сетевого интерфейса — это совокупность правил в NSG, применяемых к сетевому интерфейсу и подсети, к которой он подключен. Правила в этих NSG иногда конфликтуют друг с другом и влияют на возможность сетевого подключения к виртуальной машине.  

Вы можете просмотреть все действующие правила безопасности в NSG, применяемые к сетевым интерфейсам виртуальной машины. В этой статье показано, как устранить проблемы с сетевым подключением к виртуальной машине, используя эти правила в модели развертывания с помощью Azure Resource Manager. Если вы не знакомы с понятиями виртуальной сети и группы безопасности сети, см. обзорные статьи [Обзор виртуальной сети](virtual-networks-overview.md) и [Группа безопасности сети](virtual-networks-nsg.md).

## <a name="using-effective-security-rules-to-troubleshoot-vm-traffic-flow"></a>Использование действующих правил безопасности для устранения проблем с потоком трафика в виртуальной машине
Сценарий ниже является распространенным примером проблемы с подключением.

Виртуальная машина с именем *VM1* принадлежит к подсети *Subnet1* в виртуальной сети *WestUS-VNet1*. При попытке подключения к виртуальной машине по протоколу RDP через TCP-порт 3389 происходит сбой. И к сетевому интерфейсу *VM1-NIC1*, и к подсети *Subnet1* применены группы безопасности сети. Передача трафика через TCP-порт 3389 разрешена в NSG, связанной с сетевым интерфейсом *VM1-NIC1*, но происходит сбой проверки связи с TCP-портом 3389 виртуальной машины VM1.

В этом примере используется TCP-порт 3389, но описанные ниже шаги можно использовать для анализа сбоев входящего или исходящего подключения через любой порт.

### <a name="vm"></a>Просмотр действующих правил безопасности виртуальной машины
Выполните шаги ниже, чтобы устранить проблемы с NSG для виртуальной машины.

Вы можете просмотреть полный список действующих правил безопасности для сетевого интерфейса в самой виртуальной машине. Можно также добавить, изменить и удалить правила NSG сетевого интерфейса и подсети в колонке действующих правил, если у вас есть разрешения на выполнение этих операций.

1. Войдите на портал Azure по адресу https://portal.azure.com с учетной записью Azure. Необходимо назначить вашей учетной записи операцию *Microsoft.Network/networkInterfaces/effectiveNetworkSecurityGroups/action* для сетевого интерфейса. Дополнительные сведения о назначении операций для учетных записей см. в статье [Создание пользовательских ролей для управления доступом на основе ролей в Azure](../role-based-access-control/custom-roles.md?toc=%2fazure%2fvirtual-network%2ftoc.json).
2. Выберите **Все службы**, а затем из появившегося списка выберите **Виртуальные машины**.
3. Откроется список, где необходимо выбрать виртуальную машину для устранения проблем, после чего отобразится колонка параметров виртуальной машины.
4. Выберите **Диагностика и решение проблем**, а затем распространенную проблему. В этом примере — **Я не могу подключиться к виртуальной машине Windows** . 
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image1.png)
5. Под проблемой отобразятся действия по устранению, как показано на следующем рисунке. 
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image2.png)
   
    Щелкните ссылку *effective security group rules* (действующие правила групп безопасности) в списке рекомендуемых шагов.
6. Отобразится колонка **Get effective security rules** (Получить действующие правила безопасности), как показано на следующем рисунке.
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image3.png)
   
    На этом рисунке обратите внимание на следующие разделы:
   
   * **Область действия** — здесь указано значение *VM1*, т. е. задана виртуальная машина, выбранная на третьем шаге.
   * **Сетевой интерфейс** *VM1-NIC1* . У виртуальной машины может быть несколько сетевых интерфейсов. У каждого из них могут быть уникальные действующие правила безопасности. При устранении неполадок может потребоваться просмотреть действующие правила безопасности каждого сетевого интерфейса.
   * **Связанные NSG** — NSG, применяемые к сетевому интерфейсу и подключенной к нему подсети. На рисунке показано, что NSG применена и к сетевому интерфейсу, и к подсети, к которой он подключен. Чтобы напрямую изменить правила NSG, можно щелкнуть ее имя.
   * Вкладка **VM1-nsg** — на рисунке показан список правил для NSG, применяемой к сетевому интерфейсу. При создании каждой NSG в Azure создаются несколько правил по умолчанию. Правила по умолчанию нельзя удалить, но их можно переопределить с помощью правил с высшим приоритетом. Дополнительные сведения о правилах по умолчанию см. в статье [Группа безопасности сети](virtual-networks-nsg.md#default-rules).
   * **Назначение** — для одних правил здесь указывается текст, тогда как для других — префиксы адресов. Этот текст — имена тегов по умолчанию, применяемых к правилу безопасности при создании. Теги являются системными идентификаторами, которые представляют несколько префиксов. Если выбрать правило с тегом, такое как *AllowInternetOutBound*, в колонке **Address prefixes** (Префиксы адресов) отобразится список соответствующих префиксов.
   * **Загрузить** — список правил может быть длинным. Вы можете скачать CSV-файл с правилами, чтобы просмотреть его в автономном режиме. Для этого выберите **Загрузить** и сохраните файл.
   * **AllowRDP** — это правило предусматривает разрешение на подключение к виртуальной машине по протоколу RDP.
7. Щелкните вкладку **Subnet1-NSG** , чтобы просмотреть действующие правила NSG, применяемой к подсети, как показано на следующем рисунке. 
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image4.png)
   
    Обратите внимание на правило для *входящего трафика* **denyRDP** . Правила для входящего трафика, применяемые к подсети, проверяются перед правилами для сетевого интерфейса. Так как это правило отклонения применяется к подсети, запрос на подключение к TCP-порту 3389 завершится сбоем, потому что разрешающее правило сетевого интерфейса рассматриваться не будет. 
   
    Правило *denyRDP* — причина сбоев подключений по протоколу RDP. Его удаление должно устранить эту проблему.
   
   > [!NOTE]
   > Если виртуальная машина, связанная с сетевым интерфейсом, не работает или к сетевому интерфейсу или подсети не применены NSG, правила отображаться не будут.
   > 
   > 
8. Чтобы изменить правила NSG, щелкните *Subnet1-NSG* в разделе **Associated NSGs** (Связанные NSG).
   Откроется колонка **Subnet1-NSG** . Правила можно редактировать напрямую, щелкнув **Правила безопасности для входящего трафика**.
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image7.png)
9. После удаления правила для входящего трафика *denyRDP* из **Subnet1-NSG** и добавления *allowRDP* список действующих правил будет выглядеть, как показано на следующем рисунке.
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image8.png)
   
    Убедитесь, что TCP-порт 3389 открыт. Для этого установите подключение к виртуальной машине по протоколу RDP или используйте средство PsPing. Дополнительные сведения о PsPing см. на [странице загрузки PsPing](https://technet.microsoft.com/sysinternals/psping.aspx).

### <a name="nic"></a>Просмотр действующих правил безопасности сетевого интерфейса
Если на поток трафика конкретного сетевого интерфейса виртуальной машины что-то влияет, вы можете просмотреть полный список правил, действующих для этого интерфейса, в контексте сетевых интерфейсов, выполнив следующие шаги:

1. Войдите на портал Azure: https://portal.azure.com.
2. Выберите **Все службы**, а затем из появившегося списка выберите **Сетевые интерфейсы**.
3. Выберите сетевой интерфейс. На следующем рисунке выбран сетевой интерфейс с именем *VM1-NIC1* .
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image5.png)
   
    Обратите внимание, что для значения параметра **Область действия** задан сетевой интерфейс. Дополнительные сведения о показанной подробной информации см. на 6-м шаге в разделе об **устранении проблем с группой безопасности сети для виртуальной машины** в этой статье.
   
   > [!NOTE]
   > Если удалить NSG сетевого интерфейса, к нему будет применяться NSG подсети. В этом случае будут отображаться только правила подсети NSG. Правила будут показаны, только если сетевой интерфейс подключен к виртуальной машине.
   > 
   > 
4. Правила для NSG, связанных с сетевым интерфейсом и подсетью, можно изменить напрямую. Чтобы узнать, как это сделать, см. 8-й шаг в разделе **Просмотр действующих правил безопасности виртуальной машины** этой статьи.

## <a name="nsg"></a>Просмотр действующих правил безопасности NSG
При изменении правил NSG может понадобиться узнать, как добавляемые правила влияют на определенную виртуальную машину. Вы можете просмотреть полный список действующих правил безопасности всех сетевых интерфейсов, к которым применяется эта NSG, не переключая контекст текущей колонки NSG. Чтобы устранить проблемы с действующими правилами NSG, выполните следующее:

1. Войдите на портал Azure: https://portal.azure.com.
2. Щелкните **Все службы**, а затем из появившегося списка выберите **Группы безопасности сети**.
3. Выберите NSG. На следующем рисунке выбрана NSG с именем VM1-nsg.
   
    ![](./media/virtual-network-nsg-troubleshoot-portal/image6.png)
   
    На рисунке обратите внимание на следующие разделы:
   
   * **Область действия** — выбранная NSG.
   * **Виртуальная машина** — если к подсети применяется NSG, она применяется ко всем сетевым интерфейсам всех виртуальных машин, подключенных к этой подсети. В этом списке содержатся все виртуальные машины, к которым применяется эта NSG. В нем можно выбрать любую виртуальную машину.
     
     > [!NOTE]
     > Если NSG применяется только к пустой подсети, в списке не будет виртуальных машин. Если NSG применяется к сетевым интерфейсам, не связанным с виртуальной машиной, такие интерфейсы также не будут отображаться. 
     > 
     > 
   * **Сетевой интерфейс** — у виртуальной машины может быть несколько сетевых интерфейсов. Вы можете выбрать сетевой интерфейс, подключенный к выбранной виртуальной машине.
   * **Связанные группы безопасности сети** — у сетевого интерфейса всегда может быть до двух действующих групп безопасности сети, одна из которых применяется к сетевому интерфейсу, а вторая — к подсети. Хотя в качестве области действия и выбрана VM1-nsg, если у сетевого интерфейса есть действующая NSG подсети, будут показаны результаты обоих NSG.
4. Правила для NSG, связанных с сетевым интерфейсом или подсетью, можно изменить напрямую. Чтобы узнать, как это сделать, см. 8-й шаг в разделе **Просмотр действующих правил безопасности виртуальной машины** этой статьи.

Дополнительные сведения о показанной подробной информации см. на 6-м шаге в разделе **Просмотр действующих правил безопасности виртуальной машины** этой статьи.

> [!NOTE]
> Хотя к подсети и сетевому интерфейсу может применяться только по одной NSG, она может быть связана с несколькими сетевыми интерфейсами и несколькими подсетями.
> 
> 

## <a name="considerations"></a>Рекомендации
При устранении проблем с подключением необходимо учитывать следующие аспекты:

* Правила NSG по умолчанию будут блокировать входящий доступ из Интернета. Будет разрешен только входящий трафик виртуальной сети. Если вам нужно разрешить доступ из Интернета, следует явным образом добавить соответствующие правила.
* Если ни одно из правил безопасности NSG не является причиной сбоя подключения к виртуальной машине, проблема может быть связана со следующими компонентами:
  * Брандмауэр, запущенный в операционной системе виртуальной машины.
  * Маршруты, настроенные для виртуальных устройств или локального трафика. Интернет-трафик перенаправляется в локальную сеть путем принудительного туннелирования. В этом случае подключение по протоколу RDP или SSH из Интернета к виртуальной машине может не работать (это будет зависеть от того, как оборудование локальной сети обрабатывает трафик). Дополнительные сведения о том, как определять причины проблем с маршрутизацией, которые могут препятствовать поступлению трафика из виртуальной машины или в нее, см. в [этой статье](virtual-network-routes-troubleshoot-powershell.md). 
* Если вы используете одноранговые виртуальные сети, для них тег VIRTUAL_NETWORK по умолчанию автоматически включает префиксы. Эти префиксы можно просмотреть в списке **ExpandedAddressPrefix** , что поможет в диагностике проблем с одноранговыми подключениями к виртуальной сети. 
* Действующие правила безопасности отображаются, только если с сетевым интерфейсом и (или) подсетью виртуальной машины связана определенная группа безопасности сети. 
* Если с сетевым интерфейсом или подсетью виртуальной машины не связана группа NSG и машине назначен общедоступный IP-адрес, все порты будут открыты для входящего и исходящего трафика. Если у виртуальной машины есть общедоступный IP-адрес, настоятельно рекомендуем применить NSG к сетевому интерфейсу или подсети.

