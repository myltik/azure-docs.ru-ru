---
title: Пример сети периметра. Создание сети периметра для защиты сетей с брандмауэром, определяемыми пользователем маршрутами и группами безопасности сети | Документация Майкрософт
description: Построение сети периметра с брандмауэром, определяемыми пользователем маршрутами и группами безопасности сети.
services: virtual-network
documentationcenter: na
author: tracsman
manager: rossort
editor: ''
ms.assetid: dc01ccfb-27b0-4887-8f0b-2792f770ffff
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/01/2016
ms.author: jonor;sivae
ms.openlocfilehash: fdb3c5cbd3acee90386352c6f180a71aa81f54fe
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/11/2017
ms.locfileid: "23127162"
---
# <a name="example-3--build-a-dmz-to-protect-networks-with-a-firewall-udr-and-nsg"></a>Пример 3 — защита сетей. Построение сети периметра с брандмауэром, определяемым пользователем маршрутом и группой безопасности сети
[Вернуться на страницу с советами и рекомендациями по построению периметра безопасности][HOME]

В этом примере будет создана сеть периметра (которая называется также DMZ, демилитаризованной зоной, или промежуточной подсетью) с брандмауэром, четырьмя серверами Windows Server, определяемыми пользователем маршрутами, IP-пересылкой и группами безопасности сети. В нем также будут рассмотрены все используемые команды для более глубокого понимания каждого этапа. В разделе «Сценарий прохождения трафика» также подробно описано поэтапное прохождение трафика через уровни защиты в сети периметра. Наконец, в разделе ссылок содержится весь код и приведены инструкции по созданию этой среды для тестирования и экспериментов с различными сценариями. 

![Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами][1]

## <a name="environment-setup"></a>Настройка среды
В этом примере используется подписка, которая содержит такие компоненты:

* три облачные службы: SecSvc001, FrontEnd001 и BackEnd001;
* виртуальная сеть CorpNetwork с тремя подсетями (SecNet, FrontEnd и BackEnd);
* виртуальное сетевое устройство, которое в этом примере является брандмауэром, подключенным к подсети SecNet;
* сервер Windows Server, который представляет веб-сервер приложений (IIS01);
* два сервера Windows Server, представляющих тыловые серверы приложений (AppVM01, AppVM02);
* сервер Windows Server, который представляет DNS-сервер (DNS01).

В разделе справочной информации приведен сценарий PowerShell, который создает большую часть описанной выше среды. Сценарий создает также виртуальные машины и сети, но подробного описания этого процесса нет в этом документе.

Чтобы создать среду, сделайте следующее.

1. Сохраните XML-файл конфигурации сети, который можно найти в разделе справочной информации (предварительно укажите в файле имена, расположение и IP-адреса в соответствии с нужным сценарием).
2. Измените пользовательские переменные в сценарии в соответствии со средой, в которой он будет выполняться (подписки, имена служб и т. д.).
3. Запустите сценарий в PowerShell.

**Примечание.** Регион, указанный в сценарии PowerShell, должен соответствовать региону, указанному в XML-файле конфигурации сети.

После успешного выполнения сценария можно выполнить следующие действия.

1. Настройте правила брандмауэра (см. раздел «Описание правил брандмауэра» ниже).
2. В разделе справочной информации приведены два сценария для настройки веб-сервера и сервера приложений с простым веб-приложением, с помощью которых можно протестировать эту конфигурацию сети периметра.

После успешного выполнения сценария необходимо выполнить правила брандмауэра. Как это сделать, см. в разделе «Правила брандмауэра».

## <a name="user-defined-routing-udr"></a>Определяемые пользователем маршруты
По умолчанию следующие системные маршруты определяются так:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

VNETLocal всегда является префиксом адресов виртуальной сети для конкретной сети (т. е. он будет изменяться для каждой виртуальной сети в зависимости от способа ее определения). Остальные системные маршруты статические и заданы по умолчанию, как указано в таблице выше.

Приоритетность определяется так: маршруты обрабатываются с помощью метода совпадения самого длинного префикса (LPM). Так для данного целевого адреса будет использоваться наиболее подходящий маршрут в таблице.

Следовательно, трафик (например, на сервер DNS01, 10.0.2.4), предназначенный для локальной сети (10.0.0.0/16), будет направляться через виртуальную сеть в узел назначения по маршруту 10.0.0.0/16. Другими словами, для 10.0.2.4 наиболее подходящим является маршрут 10.0.0.0/16, несмотря на то, что 10.0.0.0/8 и 0.0.0.0/0 также можно применить. Так как эти маршруты подходят меньше, трафик через них не проходит. Так трафик к 10.0.2.4 проделает следующий прыжок в виртуальной локальной сети и просто направится к узлу назначения.

Если трафик предназначен, к примеру, для 10.1.1.1, маршрут 10.0.0.0/16 не будет использоваться, а 10.0.0.0/8 будет наиболее подходящим. Это означает, что трафик будет отброшен (направлен в «черную дыру»), так как следующий прыжок имеет значение Null. 

Если узлу назначения не подходят маршруты с префиксами Null или VNETLocal, будет выбран наименее подходящий маршрут 0.0.0.0/0. Тогда трафик следующим прыжком будет направлен в Интернет, таким образом выходя за границы Azure.

При наличии двух одинаковых префиксов в таблице маршрутизации, порядок приоритета определяется на основе атрибута «источник» маршрутов, как приведено ниже.

1. VirtualAppliance — определяемый пользователем маршрут, добавленный в таблицу вручную.
2. «VPNGateway» — динамический маршрут (BGP при использовании с гибридными сетями), добавленный динамическим сетевым протоколом. Со временем эти маршруты могут меняться, так как динамический протокол автоматически отражает изменения в одноранговой сети.
3. «Default» — системные маршруты. Это маршруты виртуальной локальной сети и статические маршруты, как показано в приведенной выше таблице маршрутизации.

> [!NOTE]
> Теперь можно использовать определяемую пользователем маршрутизацию (UDR) с ExpressRoute и VPN-шлюзами, чтобы принудительно перенаправлять распределенный входящий и исходящий трафик на виртуальное сетевое устройство (NVA).
> 
> 

#### <a name="creating-the-local-routes"></a>Создание локальных маршрутов
В этом примере нам понадобится две таблицы маршрутизации: для подсети Frontend и подсети Backend. В каждую таблицу загружены статические маршруты для данной подсети. В нашем примере каждая таблица содержит по три маршрута:

1. Для трафика локальной подсети значение следующего прыжка не указано, что позволяет трафику локальной подсети обходить брандмауэр.
2. Для трафика виртуальной сети значением следующего прыжка установлен адрес брандмауэра. Это значение переопределяет правило по умолчанию, которое разрешает прямое прохождение трафика виртуальной локальной сети.
3. Для всего остального трафика (0/0) значением следующего прыжка задан адрес брандмауэра.

После создания таблиц маршрутизации они привязываются к соответствующим подсетям. После создания и привязки к подсети таблица маршрутизации подсети Frontend будет выглядеть так:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active 
         {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active


В этом примере приведены команды для построения таблицы маршрутизации, добавления определяемого пользователем маршрута и привязки таблицы маршрутизации к подсети. (Обратите внимание, что все указанные ниже элементы со знаком доллара в начале (например, $BESubnet) являются переменными, определяемыми пользователем с помощью скрипта, который содержится в разделе справочной информации этого документа).

1. Сначала необходимо создать базовую таблицу маршрутизации. Приведенный ниже фрагмент кода создает таблицу для подсети Backend. Этот же скрипт создает соответствующую таблицу для подсети Frontend.
   
     New-AzureRouteTable -Name $BERouteTableName `
   
         -Location $DeploymentLocation `
         -Label "Route table for $BESubnet subnet"
2. После создания таблицы маршрутизации можно добавить определяемые пользователем маршруты. В этом фрагменте весь трафик (0.0.0.0/0) будет проходить через виртуальное устройство (переменная $VMIP [0] используется для передачи IP-адреса, назначенного при создании виртуального устройства ранее в этом скрипте). Кроме того, этот скрипт создает соответствующее правило в таблице подсети Frontend.
   
     Get-AzureRouteTable $BERouteTableName | `
   
         Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
         -NextHopType VirtualAppliance `
         -NextHopIpAddress $VMIP[0]
3. Приведенное выше значение маршрута переопределит маршрут по умолчанию 0.0.0.0/0. Тем не менее правило по умолчанию 10.0.0.0/16 все еще существует и будет разрешать трафику в виртуальной сети направляться непосредственно к назначению, а не к виртуальному сетевому устройству. Такое поведение можно исправить, добавив необходимое правило.
   
        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
4. На этом этапе вам предстоит сделать выбор. С двумя указанными маршрутами весь трафик будет направляться на брандмауэр для оценки, даже трафик внутри одной подсети. Это хорошо, но, чтобы разрешить локальную маршрутизацию трафика в подсети без использования брандмауэра, нужно добавить третье, особое правило. Оно будет указывать, что любой адрес назначения из локальной подсети может направляться напрямую (NextHopType = VNETLocal).
   
        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal
5. И наконец, после создания таблицы маршрутизации и заполнения определяемыми пользователем маршрутами ее нужно привязать к подсети. Кроме того, в скрипте таблица маршрутизации для подсети переднего плана привязана к подсети Frontend. Ниже приведен скрипт привязки для внутренней подсети.
   
     Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
   
        -SubnetName $BESubnet `
        -RouteTableName $BERouteTableName

## <a name="ip-forwarding"></a>IP-пересылку
Определяемые пользователем маршруты всегда используются вместе с функцией IP-пересылки. Это параметр для виртуального устройства, который позволяет принимать не адресованный устройству трафик и пересылать его конечному получателю.

Например, если поступает трафик от AppVM01 с запросом к серверу DNS01, определяемый пользователем маршрут направит такой трафик на брандмауэр. При включенной IP-пересылке трафик с указанным назначением DNS01 (10.0.2.4) будет принят устройством (10.0.0.4) и затем передан конечному получателю (10.0.2.4). Если IP-пересылка на брандмауэре не разрешена, такой трафик не будет принят устройством, даже если в качестве следующего прыжка в таблице маршрутизации указан брандмауэр. 

> [!IMPORTANT]
> Не забудьте вместе с определяемыми пользователем маршрутами обязательно включить IP-пересылку.
> 
> 

IP-пересылка настраивается с помощью единственной команды. Настройку можно выполнить во время создания виртуальной машины. В этом примере фрагмент кода находится в конце скрипта и группируется с командами UDR:

1. Вызовите экземпляр виртуальной машины, которая является вашим виртуальным устройством и брандмауэром в данном случае, и включите IP-пересылку. Обратите внимание, что все элементы, обозначенные красным, со знаком доллара в начале (например, $VMName[0]) являются переменными, определяемыми пользователем в скрипте, который приведен в разделе справочной информации этого документа. Ноль в квадратных скобках, [0], представляет первую виртуальную машину в массиве виртуальных машин. Чтобы пример скрипта работал без изменений, первая виртуальная машина (VM 0) должна быть брандмауэром.
   
     Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] | `
   
        Set-AzureIPForwarding -Enable

## <a name="network-security-groups-nsg"></a>Группы безопасности сети
В этом примере создается группа безопасности сети, после чего в нее загружается одно правило. Затем эта группа привязывается только к подсетям Frontend и Backend (не SecNet). Декларативно создается следующее правило:

1. Весь трафик (все порты) из Интернета ко всей виртуальной сети (все подсети) запрещается.

В этом примере используются группы безопасности сети, но его основной целью является создание дополнительного уровня защиты от неправильной настройки вручную. Нам нужно заблокировать весь входящий трафик из Интернета к подсетям Frontend и Backend. Трафик должен проходить только через подсеть SecNet к брандмауэру (а затем — в подсеть Frontend или Backend, при наличии таковых). Кроме того, если установлены правила определяемых пользователем маршрутов, любой трафик, поступивший в подсети Frontend и Backend, будет направляться на брандмауэр (благодаря наличию определяемых пользователем маршрутов). Брандмауэр воспримет это как асимметричный поток и отбросит исходящий трафик. Следовательно, существует три уровня безопасности для защиты подсетей Frontend и Backend: 1) отсутствие открытых конечных точек в облачных службах FrontEnd001 и BackEnd001, 2) группы безопасности сети, запрещающие трафик из Интернета, 3) брандмауэр, отбрасывающий асимметричный трафик.

В приведенном ниже примере есть интересная особенность, касающаяся сетевой группы безопасности. В нем содержится только одно правило (указанное ниже), которое запрещает Интернет-трафик ко всей виртуальной сети, включая подсеть безопасности. 

    Get-AzureNetworkSecurityGroup -Name $NSGName | `
        Set-AzureNetworkSecurityRule -Name "Isolate the $VNetName VNet `
        from the Internet" `
        -Type Inbound -Priority 100 -Action Deny `
        -SourceAddressPrefix INTERNET -SourcePortRange '*' `
        -DestinationAddressPrefix VIRTUAL_NETWORK `
        -DestinationPortRange '*' `
        -Protocol *

Однако, так как сетевая группа безопасности привязана только к подсети переднего плана и внутренней подсети, это правило не применяется к входящему трафику подсети безопасности. В результате трафик будет попадать в подсеть безопасности, поскольку правило сетевой группы безопасности, запрещающее интернет-трафик на любой адрес виртуальной сети, не было привязано к подсети безопасности.

    Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
        -SubnetName $FESubnet -VirtualNetworkName $VNetName

    Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
        -SubnetName $BESubnet -VirtualNetworkName $VNetName

## <a name="firewall-rules"></a>Правила брандмауэра
В брандмауэре необходимо создать правила пересылки. Так как брандмауэр блокирует или пересылает весь входящий, исходящий и внутренний трафик виртуальной сети, требуется много правил брандмауэра. Кроме того, весь входящий трафик будет попадать на общедоступный IP-адрес службы безопасности (на разных портах) для последующей обработки брандмауэром. Прежде чем настраивать подсети и правила брандмауэра, рекомендуем составить схему логических потоков, чтобы избежать переделывания позже. Следующий рисунок является логическим представлением правил брандмауэра для этого примера.

![Логическое представление правил брандмауэра][2]

> [!NOTE]
> Порты управления будут различными в зависимости от используемого виртуального сетевого устройства. В этом примере брандмауэр Barracuda NextGen Firewall использует порты 22, 801 и 807. Обратитесь к документации поставщика устройства, чтобы точно знать, какие порты используются для управления устройством.
> 
> 

### <a name="logical-rule-description"></a>Описание логического правила
На приведенной выше логической схеме не отображена подсеть безопасности, так как брандмауэр является единственным ресурсом в этой подсети. Кроме того, вместо фактического пути маршрутизации на схеме показаны правила брандмауэра и логика разрешения или запрета трафика. Кроме того, внешние порты, выбранные для трафика RDP, являются портами высшего диапазона (8014–8026) и выбраны для совмещения с последними двумя октетами локального IP-адреса для облегчения чтения (например, адрес локального сервера 10.0.1.4 связан с внешним портом 8014). Тем не менее можно использовать любые неконфликтующие порты высшего диапазона.

В этом примере нам нужно 7 типов правил. Их описание приведено ниже.

* Внешние правила (для входящего трафика):
  1. Правило управления брандмауэром. Это правило перенаправления приложения разрешает пересылать трафик на порты управления виртуального сетевого устройства.
  2. Правила RDP (для каждого сервера Windows Server). Эти четыре правила (по одному для каждого сервера) позволяют управлять серверами через RDP. Эти правила можно объединить в одно, если виртуальное сетевое устройство поддерживает такую возможность.
  3. Правила трафика приложений. Существует два правила трафика приложений: первое — для веб-трафика подсети переднего плана, а второе — для трафика внутренней подсети (например, от веб-сервера к уровню данных). Параметры этих правил будут зависеть от архитектуры сети размещения серверов и характеристик потоков трафика (направление потока и используемые порты).
     * Первое правило позволяет фактическому трафику приложения достигать сервера приложений. Другие правила нужны для безопасности, управления и т. д., а правила приложений позволяют внешним пользователям и службам взаимодействовать с приложениями. В этом примере используется один веб-сервер на порту 80, поэтому на брандмауэре потребуется одно правило приложения. Оно принимает трафик, поступающий на внешний IP-адрес, и переправляет его на внутренний IP-адрес веб-серверов. Затем этот трафик обрабатывается службой NAT (преобразование сетевых адресов) и передается на внутренний сервер.
     * Второе правило трафика приложения используется для внутренней подсети. Оно разрешает веб-серверу обращаться к серверу AppVM01 (но не AppVM02) через любой порт.
* Внутренние правила (для внутреннего трафика виртуальной сети)
  1. Правило трафика, исходящего в Интернет. Это правило разрешает передачу трафика из любой сети в указанные сети. Обычно это правило является заданным в брандмауэре по умолчанию и при этом отключенным. В нашем примере это правило следует активировать.
  2. Правило DNS. Это правило разрешает передавать на DNS-сервер только трафик DNS (на порт 53). Для этой среды блокируется почти весь трафик от подсети Frontend к Backend, а это правило отдельно разрешает трафик DNS из любой локальной подсети.
  3. Правило трафика между подсетями. Это правило позволяет любому серверу внутренней подсети подключаться к любому серверу в подсети переднего плана (но не наоборот).
* Резервное правило (для трафика, который не соответствует указанным выше правилам).
  1. Правило запрета любого трафика. Это правило всегда должно быть последним (по приоритету). Если трафик не соответствует ни одному из предыдущих правил, этим правилом он будет отброшен. Это правило обычно уже установлено по умолчанию и активировано, поэтому не требует дополнительных действий.

> [!TIP]
> Второе правило трафика приложения разрешает трафик на любой порт (для упрощения примера). В реальной системе следует использовать как можно более узкие диапазоны портов и адресов, чтобы снизить площадь поражения от атак, обусловленных применением этого правила.
> 
> 

<br />

> [!IMPORTANT]
> После создания всех приведенных выше правил обязательно проверьте приоритет каждого правила, чтобы разрешения и запреты трафика выполнялись надлежащим образом. В нашем примере правила расположены в порядке приоритета. Очень просто заблокировать брандмауэр из-за неправильного порядка правил. Поэтому следите за тем, чтобы управление брандмауэром всегда было правилом наивысшего приоритета.
> 
> 

### <a name="rule-prerequisites"></a>Предварительные требования для правил
Предварительным требованием для виртуальной машины, на которой включен брандмауэр, являются общедоступные конечные точки. Чтобы брандмауэр мог обрабатывать трафик, соответствующие общедоступные конечные точки должны быть открыты. В этом примере используется три типа трафика: 1) трафик управления брандмауэром и правилами брандмауэра, 2) трафик RDP для управления серверами Windows Server и 3) трафик приложения. Эти типы трафика представлены в виде трех колонок в верхней части логического представления правил брандмауэра, которое приведено выше.

> [!IMPORTANT]
> Основное, что следует запомнить: **весь** трафик будет проходить через брандмауэр. Так, для подключения к удаленному рабочему столу сервера IIS01, даже если он находится в облачной службе Front End, и, соответственно, для доступа к подсети Front End необходимо подключиться с помощью RDP к порту 8014 брандмауэра, а затем разрешить брандмауэру отправить запрос RDP внутри сети на порт RDP IIS01. Кнопка «Подключиться» на портале Azure не будет работать из-за отсутствия прямого пути RDP к IIS01 (с точки зрения портала). Это означает, что все подключения из Интернета будут поступать в службу безопасности и на порт, например secscv001.cloudapp.net:xxxx (см. схему выше для сопоставления внешних портов и внутренних IP-адресов и портов).
> 
> 

Конечную точку можно открыть во время создания виртуальной машины или после сборки, как показано ниже в примере скрипта в этом фрагменте кода. (Обратите внимание, что все элементы со знаком доллара в начале (например, $VMName[$i]) являются переменными, определяемыми пользователем в скрипте, который приведен в разделе справочной информации этого документа. «$I» в квадратных скобках, [$i], является номером массива определенной виртуальной машины в массиве виртуальных машин.)

    Add-AzureEndpoint -Name "HTTP" -Protocol tcp -PublicPort 80 -LocalPort 80 `
        -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | `
        Update-AzureVM

Конечные точки открываются **только** в облачной службе безопасности, хотя здесь это не показано явно из-за использования переменных. Это гарантирует, что весь входящий трафик будет обрабатываться (маршрутизироваться, транслироваться с помощью NAT или отбрасываться) брандмауэром.

Для управления брандмауэром и создания необходимых конфигураций на компьютер необходимо установить клиент управления. Инструкции по управлению устройством см. в документации брандмауэра (или другого виртуального сетевого устройства). В оставшейся части этого раздела и следующем разделе «Создание правил брандмауэра» описывается конфигурация брандмауэра с помощью клиента управления поставщика (т. е. без использования портала Azure или PowerShell).

Инструкции по загрузке клиента и подключению к брандмауэру Barracuda, который используется в этом примере, см в статье [Администрирование Barracuda NG](https://techlib.barracuda.com/NG61/NGAdmin)

После входа в брандмауэр можно упростить процесс создания правил с помощью двух предварительно созданных классов объектов — сетевых и служебных (но делать это нужно до создания правил).

В этом примере нам нужно определить три именованных сетевых объекта (по одному для подсетей Frontend и Backend, а также сетевой объект для IP-адреса DNS-сервера). Чтобы создать именованную сеть, откройте панель мониторинга администратора Barracuda NG, перейдите на вкладку «Конфигурация», в разделе «Рабочая конфигурация» щелкните пункт «Набор правил», затем в меню «Объекты брандмауэра» выберите «Сети» и щелкните «Создать» в меню «Изменение сетей». Теперь можно создать сетевой объект, добавив имя и префикс.

![Создание сетевого объекта FrontEnd][3]

В результате будет создана именованная сеть для подсети FrontEnd. Для подсети BackEnd следует создать такой же объект. Теперь, когда у подсетей есть имена, их проще использовать в правилах брандмауэра.

Для объекта «DNS-сервер»:

![Создание объекта сервера DNS][4]

Мы будем ссылаться на этот IP-адрес в правиле DNS позднее в этом документе.

Вторым предварительным требованием является наличие служебных объектов. Они будут представлять порты подключения RDP для каждого сервера. Так как существующий служебный объект RDP привязан к порту RDP по умолчанию 3389, можно создать новые службы для разрешения трафика от внешних портов (8014–8026). Кроме того, в существующую службу RDP можно добавить новые порты, но для удобства демонстрации создадим для каждого сервера отдельное правило. Чтобы создать новое правило RDP, откройте панель мониторинга администратора Barracuda NG, перейдите на вкладку «Конфигурация», в разделе «Рабочая конфигурация» щелкните пункт «Набор правил» и в меню «Объекты брандмауэра» выберите «Службы», затем прокрутите список служб вниз и выберите службу RDP. Щелкните правой кнопкой мыши и выберите копию, затем щелкните правой кнопкой мыши и выберите команду «Вставить». Теперь у нас есть объект службы RDP-Copy1, который можно редактировать. Щелкните правой кнопкой мыши RDP-Copy1 и выберите «Изменить». После этого отобразится окно «Изменение объекта службы», приведенное ниже.

![Копия правила RDP по умолчанию][5]

Значения можно будет изменять для представления службы RDP определенному серверу. Для AppVM01 указанное выше правило RDP по умолчанию необходимо отредактировать в соответствии с новым именем службы, описанием и внешним портом RDP, который используется в схеме на рисунке 8. (Обратите внимание, что порт RDP по умолчанию 3389 меняется на внешний порт, используемый для этого сервера. В случае AppVM01 таковым является внешний порт 8025.) Измененная служба приведена ниже.

![Правило AppVM01][6]

Повторите этот процесс для создания служб RDP для остальных серверов: AppVM02, DNS01 и IIS01. После создания этих служб создавать правила станет проще. Вы убедитесь в этом в следующем разделе.

> [!NOTE]
> Служба RDP не нужна для брандмауэра по двум причинам: во-первых, брандмауэр является виртуальной машиной на основе Linux, поэтому для управления им будет использоваться SSH на порте 22, а не RDP; во-вторых, порт 22 и два других порта управления разрешены в первом правиле управления, описанном ниже, для управления подключением.
> 
> 

### <a name="firewall-rules-creation"></a>Создание правил брандмауэра
В этом примере используется три типа правил брандмауэра. Все они имеют собственные значки.

Правило перенаправления приложения: ![Значок перенаправления приложения][7]

Правило NAT назначения: ![Значок NAT назначения][8]

Разрешающее правило: ![Значок передачи][9]

Дополнительные сведения об этих правилах можно найти на веб-сайте Barracuda.

Создать следующие правила (или проверить существующие правила по умолчанию) можно так: откройте панель мониторинга администратора Barracuda NG, перейдите на вкладку «Конфигурация» и в разделе «Рабочая конфигурация» щелкните «Набор правил». Откроется сетка «Основные правила», на которой будут отображаться существующие активные и неактивные правила брандмауэра. В правом верхнем углу этой сетки расположена небольшая зеленая кнопка «+». Нажмите ее, чтобы создать новое правило. (Примечание. Брандмауэр может быть «заблокирован» для внесения изменений. Если вы видите кнопку «Заблокировано» и не можете создать или изменить правила, нажмите эту кнопку, чтобы «разблокировать» набор правил и разрешить редактирование.) Если вы хотите изменить существующее правило, выберите его, щелкните правой кнопкой мыши и выберите «Изменить правило».

После создания или изменения правила необходимо отправить в брандмауэр и затем активировать. Без этого правило не будет действовать. Процесс отправки и активации приведен после описания правил.

Ниже описаны особенности правил, которые используются в нашем примере.

* **Правило управления брандмауэром.** Это правило перенаправления приложения разрешает пересылать трафик на порты управления виртуального сетевого устройства (в нашем примере это брандмауэр Barracuda NextGen Firewall). Портами управления являются 801, 807 и, при необходимости, порт 22. Внешние и внутренние порты совпадают (т. е. преобразование портов не используется). SETUP-MGMT-ACCESS является правилом по умолчанию и включено по умолчанию (в брандмауэре Barracuda NextGen Firewall версии 6.1).
  
    ![Правило управления брандмауэром][10]

> [!TIP]
> Адресное пространство источника в этом правиле — Any, если известны диапазоны IP-адресов управления. Сократите диапазоны, чтобы уменьшить возможность атак на портах управления.
> 
> 

* **Правила RDP.** Эти правила NAT назначения будут разрешать управление отдельными серверами по протоколу RDP.
  Создание этого правила предусматривает заполнение четырех важных полей.
  
  1. Источник: чтобы разрешать RDP из любого места, в поле источника необходимо установить значение «Any».
  2. Служба: используйте соответствующий объект службы, созданный ранее, в данном случае — AppVM01 RDP. Трафик, который поступает на внешние порты, перенаправляется на локальный IP-адрес сервера и порт 3389 (порт RDP по умолчанию). Это правило предназначено для доступа к AppVM01 по протоколу RDP.
  3. "Назначение". В этом поле следует указать *локальный порт на брандмауэре*, а именно DCHP 1 Local IP или eth0 при использовании статических IP-адресов. Порядковый номер (eth0, eth1, и т. д.) может отличаться, если сетевое устройство имеет несколько локальных интерфейсов. Это порт, из которого брандмауэр отправляет трафик (может быть таким же, как принимающий порт). Фактическое назначение указано в поле «Целевой список».
  4. Перенаправление: в этом разделе указано назначение, в которое виртуальное устройство должно в конечном счете перенаправить трафик. Примером самого простого перенаправления может быть задание IP-адреса и порта (необязательно) в поле «Целевой список». Если порт не указан, для входящего запроса будет использоваться порт назначения (т. е. без трансляции). Если порт указан, он будет транслирован с помощью NAT вместе с IP-адресом.
     
     ![Правило RDP брандмауэра][11]
     
     Необходимо создать четыре правила RDP: 
     
     | Имя правила | сервер; | Service | Целевой список |
     | --- | --- | --- | --- |
     | RDP-to-IIS01 |IIS01 |IIS01 RDP |10.0.1.4:3389 |
     | RDP-to-DNS01 |DNS01 |DNS01 RDP |10.0.2.4:3389 |
     | RDP-to-AppVM01 |AppVM01 |AppVM01 RDP |10.0.2.5:3389 |
     | RDP-to-AppVM02 |AppVM02 |AppVm02 RDP |10.0.2.6:3389 |

> [!TIP]
> Сужение диапазонов в полях «Источник» и «Служба» позволит снизить возможность атак. Следует использовать диапазоны как можно уже, которые будут обеспечивать лишь необходимую функциональность.
> 
> 

* **Правила трафика приложений.** Доступно два правила трафика приложений: первое — для веб-трафика подсети переднего плана, а второе — для трафика внутренней подсети (например, от веб-сервера к уровню данных). Эти правила зависят от архитектуры сети (размещения серверов) и потоков трафика (их направления и используемых портов).
  
    Сначала рассмотрим правило веб-трафика в подсети переднего плана.
  
    ![Веб-правило брандмауэра][12]
  
    Правило NAT назначения позволяет фактическому трафику приложения получать доступ к серверу приложений. Другие правила нужны для безопасности, управления и т. д., а правила приложений позволяют внешним пользователям и службам взаимодействовать с приложениями. В этом примере используется один веб-сервер на порте 80. Соответственно, одно правило приложения брандмауэра будет перенаправлять входящий трафик на внешний IP-адрес, на внутренний IP-адрес веб-серверов.
  
    **Примечание.** В поле "Целевой список" не указан порт, поэтому для перенаправления трафика от веб-сервера будет использоваться входящий порт 80 (или порт 443 для выбранной службы). Если веб-сервер прослушивает другой порт, к примеру порт 8080, в поле "Целевой список" можно указать значение 10.0.1.4:8080, чтобы разрешить перенаправление портов.
  
    Следующее правило трафика приложения используется для внутренней подсети. Оно разрешает веб-серверу обращаться к серверу AppVM01 (но не AppVM02) через любую службу (Any).
  
    ![Правило AppVM01 брандмауэра][13]
  
    Это разрешающее правило разрешает любому серверу IIS подсети Frontend получать доступ к AppVM01 (IP-адрес 10.0.2.5) на любом порте (Any), с использованием любого протокола для доступа к данным, которые требуются веб-приложению.
  
    На этом снимке экрана в поле "Назначение" выбрано значение \<explicit-dest\> для обозначения IP-адреса 10.0.2.5 в качестве IP-адреса назначения. Оно может быть либо явно указанным, как показано выше, либо называться «Сетевой объект» (как в предварительных требованиях для DNS-сервера). Администратор брандмауэра выбирает, какой способ использовать. Чтобы добавить IP-адрес 10.0.2.5 в качестве явного назначения, дважды щелкните первую пустую строку под значением \<explicit-dest\> и в открывшемся окне введите адрес.
  
    Для этого разрешающего правила не требуется NAT (преобразование сетевых адресов), так как это внутренний трафик, поэтому в поле «Способ подключения» можно установить значение «No SNAT».
  
    **Примечание.** В этом правиле в качестве исходной сети используется любой ресурс подсети FrontEnd. При наличии одного или определенного количества веб-серверов для большей точности можно создать ресурс "Сетевой объект" и указать конкретные IP-адреса вместо целой подсети переднего плана.

> [!TIP]
> В этом правиле используется служба «Any» для упрощения настройки и использования примера приложения. Кроме этого разрешается ICMPv4 (проверка связи) в одном правиле. Однако так делать не рекомендуется. Порты и протоколы («службы») следует сузить до минимально возможного уровня, необходимого для работы приложения, чтобы снизить возможность атак на периметре.
> 
> 

<br />

> [!TIP]
> Хотя это правило явно указывает, какое назначение используется, при настройке брандмауэра следует быть последовательными. Рекомендуем всегда использовать именованные сетевые объекты для удобства чтения и технической поддержки. explicit-dest используется здесь только для отображения альтернативного метода ссылки. В общем, так делать не рекомендуется (особенно в сложных конфигурациях).
> 
> 

* **Правило исходящего трафика в Интернет.** Это правило разрешает передачу трафика из исходной сети в указанные сети назначения. Обычно это правило уже указано на брандмауэре Barracuda NextGen Firewall по умолчанию, но оно отключено. Доступ к команде «Активировать правило» можно.получить, щелкнув этой правило правой кнопкой мыши. Приведенное здесь правило изменено с целью добавления двух локальных подсетей, которые созданы для примера в разделе предварительных требований этого документа для атрибута «Источник» этого правила.
  
    ![Правило исходящего трафика брандмауэра][14]
* **Правило DNS.** Это правило разрешает передавать на DNS-сервер только трафик DNS (на порт 53). Для этой среды блокируется почти весь трафик от подсети FrontEnd к BackEnd, а это правило отдельно разрешает трафик DNS.
  
    ![Правило DNS брандмауэра][15]
  
    **Примечание.** На этом снимке экрана содержится поле "Способ подключения". Так как это правило применяется для трафика между внутренними IP-адресами, трансляция с помощью NAT не нужна. Соответственно, в поле «Способ подключения» установлено значение «No SNAT» для этого разрешающего правила.
* **Правило прохождения трафика между подсетями.** Это разрешающее правило установлено по умолчанию и активировано. Оно изменено для разрешения любому серверу во внутренней подсети подключаться к любому серверу в подсети переднего плана. Это правило регулирует только внутренний трафик, поэтому для способа подключения можно установить значение «No SNAT».
  
    ![Правило брандмауэра для внутреннего трафика виртуальной сети][16]
  
    **Примечание.** Двунаправленный флажок не установлен (как для большинства правил). Это важно для правила, так как оно применяется только к одному направлению, т. е. соединение может быть инициировано от внутренней подсети к подсети переднего плана, но не наоборот. Если установить флажок, правило будет разрешать двунаправленный трафик, а в нашей логической схеме это не требуется.
* **Правило запрета любого трафика.** Это правило всегда должно быть последним (по приоритету). Если трафик не соответствует ни одному из предыдущих правил, он будет отброшен этим правилом. Это правило обычно уже установлено по умолчанию и активировано, поэтому не требует дополнительных действий. 
  
    ![Правило запрета брандмауэра][17]

> [!IMPORTANT]
> После создания всех приведенных выше правил обязательно проверьте приоритет каждого правила, чтобы разрешения и запреты трафика выполнялись надлежащим образом. В этом примере правила расположены в том порядке, в котором они должны отображаться в основной сетке правил пересылки на клиенте управления Barracuda.
> 
> 

## <a name="rule-activation"></a>Активация правил
Набор правил, после изменения в соответствии с логической схемой, необходимо отправить в брандмауэр, а затем активировать.

![Активация правила брандмауэра][18]

В правом верхнем углу клиента управления расположена группа кнопок. Нажмите кнопку "Отправить изменения", чтобы отправить измененные правила в брандмауэр, а затем нажмите кнопку "Активировать".

После активации набора правил брандмауэра создание среды в этом примере завершено.

## <a name="traffic-scenarios"></a>Сценарии прохождения трафика
> [!IMPORTANT]
> Основное, что следует запомнить: **весь** трафик будет проходить через брандмауэр. Так, для подключения к удаленному рабочему столу сервера IIS01, даже если он находится в облачной службе Front End, и, соответственно, для доступа к подсети Front End необходимо подключиться с помощью RDP к порту 8014 брандмауэра, а затем разрешить брандмауэру отправить запрос RDP внутри сети на порт RDP IIS01. Кнопка «Подключиться» на портале Azure не будет работать из-за отсутствия прямого пути RDP к IIS01 (с точки зрения портала). Это означает, что все подключения из Интернета будут поступать в службу безопасности и на порт, например secscv001.cloudapp.net:xxxx.
> 
> 

В этих сценариях должны соблюдаться приведенные ниже правила брандмауэра.

1. Управление брандмауэром.
2. Запрос через RDP к IIS01.
3. Запрос через RDP к DNS01.
4. Запрос через RDP к AppVM01.
5. Запрос через RDP к AppVM02.
6. Трафик приложения в Интернет.
7. Трафик приложения на AppVM01.
8. Исходящий трафик в Интернет.
9. Трафик из внутренней подсети на DNS01.
10. Трафик внутри подсети (только из внутренней подсети в подсеть переднего плана).
11. Запрет любого трафика.

В фактическом наборе правил, скорее всего, кроме этих будет присутствовать много других правил. К тому же порядок приоритета этих правил для каждого отдельного брандмауэра будет отличаться от приведенного здесь. Приведенный выше нумерованный список демонстрирует соответствие между одиннадцатью правилами и их приоритетом (который определяется номерами). Иными словами, в реальном брандмауэре «RDP на IIS01» может быть правилом номер 5, но пока оно находится ниже правила «Управление брандмауэром» и выше «RDP на DNS01», оно будет соответствовать целям этого списка. Кроме того, список будет использоваться в приведенных ниже сценариях, которые разрешают подобные сокращения. Например: правило 9 брандмауэра (DNS) (FW Rule 9 (DNS)). Кроме этого, для краткости четыре правила RDP будут называться «правилами RDP», если сценарий трафика не связан с RDP.

Помните также, что для входящего Интернет-трафика в подсетях Frontend и Backend должны быть установлены группы безопасности сети.

#### <a name="allowed-internet-to-web-server"></a>Запрос из Интернета к веб-серверу (разрешено)
1. Интернет-пользователь запрашивает страницу HTTP из службы SecSvc001.CloudApp.Net (облачная служба с выходом в Интернет).
2. Облачная служба передает трафик через открытую конечную точку на порте 80 на интерфейс брандмауэра 10.0.0.4:80.
3. Подсети безопасности не назначены группе безопасности сети, поэтому правила группы безопасности сети системы разрешают трафик к брандмауэру.
4. Трафик достигает внутреннего IP-адреса брандмауэра (10.0.1.4).
5. Брандмауэр начинает обработку правил.
   1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
   2. Правила 2–5 брандмауэра (правила RDP) не применяются — переход к следующему правилу.
   3. Правило 6 брандмауэра (приложение: Интернет) применяется — трафик разрешается, брандмауэр транслирует его с помощью NAT на 10.0.1.4 (IIS01).
6. Подсеть FrontEnd начинает обработку правила для входящего трафика.
   1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется (этот трафик транслирован с помощью NAT брандмауэром. В результате адресом источника теперь является брандмауэр, который находится в подсети безопасности. Он воспринимается группой безопасности подсети Frontend как «локальный» трафик и поэтому разрешается). Переход к следующему правилу.
   2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
7. IIS01 ожидает передачу данных из Интернета, получает этот запрос и начинает его обработку.
8. IIS01 пытается инициировать сеанс FTP для AppVM01 в подсети Backend.
9. Определяемый пользователем маршрут в подсети Frontend следующим прыжком задает брандмауэр.
10. В подсети Frontend нет правил для обработки исходящего трафика — трафик разрешается.
11. Брандмауэр начинает обработку правил.
    1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
    2. Правила 2–5 брандмауэра (правила RDP) не применяются — переход к следующему правилу.
    3. Правило 6 брандмауэра (приложение: Интернет) не применяется — переход к следующему правилу.
    4. Правила 7 брандмауэра (приложение: Backend) применяется, трафик разрешается — брандмауэр перенаправляет трафик на 10.0.2.5 (AppVM01).
12. Подсеть BackEnd начинает обработку правил для входящего трафика.
    1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
    2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
13. AppVM01 получает запрос, запускает сеанс и отвечает.
14. Определяемый пользователем маршрут в подсети Backend следующим прыжком задает брандмауэр.
15. Так как правил для исходящего трафика в подсети Backend нет, отправка ответа разрешается.
16. Так как это обратный трафик в активном сеансе, брандмауэр возвращает ответ веб-серверу (IIS01).
17. Подсеть Frontend начинает обработку правила для входящего трафика.
    1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
    2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
18. Сервер IIS получает ответ, завершает транзакцию с AppVM01 и затем завершает создание HTTP-ответа. Этот ответ отправляется запрашивающей стороне.
19. Так как правил для исходящего трафика в подсети Frontend нет, отправка ответа разрешается.
20. HTTP-ответ попадает в брандмауэр. Так как это ответ активному сеансу NAT, брандмауэр его принимает.
21. Затем брандмауэр перенаправляет ответ обратно Интернет-пользователю.
22. Так как в подсети FrontEnd нет правил для исходящего трафика групп безопасности сети и прыжков определяемых пользователем маршрутов, отправленный ответ пропускается и Интернет-пользователь получает запрашиваемую веб-страницу.

#### <a name="allowed-internet-rdp-to-backend"></a>Запрос через Интернет-протокол RDP к подсети Backend (разрешено) 
1. Администратор сервера в Интернете запрашивает сеанс RDP с AppVM01 через SecSvc001.CloudApp.Net:8025 8025 — это номер порта, назначенный для правила брандмауэра «Запрос через RDP к AppVM01».
2. Облачная служба передает трафик через открытую конечную точку на порте 8025 на интерфейс брандмауэра 10.0.0.4:8025.
3. Подсети безопасности не назначены группе безопасности сети, поэтому правила группы безопасности сети системы разрешают трафик к брандмауэру.
4. Брандмауэр начинает обработку правил.
   1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
   2. Правило 2 брандмауэра (RDP IIS) не применяется — переход к следующему правилу.
   3. Правило 3 брандмауэра (RDP DNS01) не применяется — переход к следующему правилу.
   4. Правило 4 брандмауэра (RDP AppVM01) не применяется — трафик разрешен, брандмауэр транслирует его с помощью NAT в 10.0.2.5:3389 (порт протокола RDP на AppVM01).
5. Подсеть BackEnd начинает обработку правил для входящего трафика.
   1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется (этот трафик транслирован с помощью NAT брандмауэром. В результате адресом источника теперь является брандмауэр, который находится в подсети безопасности. Он воспринимается группой безопасности подсети Backend как «локальный» трафик и поэтому разрешается). Переход к следующему правилу.
   2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
6. AppVM01 прослушивает трафик RDP и отвечает.
7. Правил для исходящего трафика групп безопасности сети нет, поэтому применяются правила по умолчанию и обратный трафик разрешается.
8. Определяемые пользователем маршруты направляют исходящий трафик в брандмауэр следующим прыжком.
9. Так как это обратный трафик в активном сеансе, брандмауэр возвращает ответ пользователю Интернета.
10. Начинается сеанс RDP.
11. Сервер AppVM01 запрашивает имя пользователя и пароль.

#### <a name="allowed-web-server-dns-lookup-on-dns-server"></a>DNS-запрос веб-сервера к серверу DNS (разрешено) 
1. Веб-серверу IIS01 нужен веб-канал данных с сайта www.data.gov, но ему необходимо разрешить адрес.
2. В конфигурации виртуальной сети в качестве основного DNS-сервера указан сервер DNS01 (10.0.2.4 в подсети Backend). Веб-сервер IIS01 отправляет DNS-запрос серверу DNS01.
3. Определяемые пользователем маршруты направляют исходящий трафик в брандмауэр следующим прыжком.
4. Так как правил для исходящего трафика в подсети Frontend для групп безопасности сети нет, трафик разрешается.
5. Брандмауэр начинает обработку правил.
   1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
   2. Правила 2–5 брандмауэра (правила RDP) не применяются — переход к следующему правилу.
   3. Правила 6–7 брандмауэра (правила приложений) не применяются — переход к следующему правилу.
   4. Правило 8 брандмауэра (к Интернету) не применяется — переход к следующему правилу.
   5. Правило 9 брандмауэра (DNS) применяется, трафик разрешается — брандмауэр перенаправляет трафик на 10.0.2.4 (DNS01).
6. Подсеть BackEnd начинает обработку правил для входящего трафика.
   1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
   2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
7. DNS-сервер получает запрос.
8. Указанный адрес отсутствует в кэше DNS-сервера, поэтому он отправляет запрос к корневому DNS-серверу в Интернете.
9. Определяемые пользователем маршруты направляют исходящий трафик в брандмауэр следующим прыжком.
10. В подсети Backend нет правил для исходящего трафика групп безопасности сети, поэтому трафик разрешается.
11. Брандмауэр начинает обработку правил.
    1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
    2. Правила 2–5 брандмауэра (правила RDP) не применяются — переход к следующему правилу.
    3. Правила 6–7 брандмауэра (правила приложений) не применяются — переход к следующему правилу.
    4. Правило 8 брандмауэра (правила приложений) применяется — трафик разрешается, сеанс направляется посредством SNAT к корневому DNS-серверу в Интернете.
12. DNS-сервер в Интернете отправляет ответ. Так как этот сеанс инициирован брандмауэром, он принимает ответ.
13. Так как это активный сеанс, брандмауэр перенаправляет ответ на инициирующий сервер DNS01.
14. Подсеть BackEnd начинает обработку правил для входящего трафика.
    1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
    2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
15. DNS-сервер получает ответ, кэширует его, а затем отправляет ответ на исходный запрос на сервер IIS01.
16. Определяемый пользователем маршрут в подсети Backend следующим прыжком задает брандмауэр.
17. В подсети Backend нет правил для исходящего трафика групп безопасности сети, поэтому трафик разрешается.
18. Это активный сеанс на брандмауэре, ответ перенаправляется брандмауэром на сервер IIS.
19. Подсеть Frontend начинает обработку правила для входящего трафика.
    1. Так как в группе безопасности сети нет правил, которые могут применяться ко входящему трафику из подсети Backend в подсеть Frontend, все правила группы безопасности игнорируются.
    2. Системное правило по умолчанию, которое разрешает трафик между подсетями, разрешает прохождение этого трафика, поэтому трафик разрешается.
20. Сервер IIS01 получает ответ от сервера DNS01.

#### <a name="allowed-backend-server-to-frontend-server"></a>Запрос от тылового сервера к серверу переднего плана (разрешено)
1. Администратор вошел на AppVM02 через RDP и запрашивает файл непосредственно на сервере IIS01 через проводник.
2. Определяемый пользователем маршрут в подсети Backend следующим прыжком задает брандмауэр.
3. Так как правил для исходящего трафика в подсети Backend нет, отправка ответа разрешается.
4. Брандмауэр начинает обработку правил.
   1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
   2. Правила 2–5 брандмауэра (правила RDP) не применяются — переход к следующему правилу.
   3. Правила 6–7 брандмауэра (правила приложений) не применяются — переход к следующему правилу.
   4. Правило 8 брандмауэра (к Интернету) не применяется — переход к следующему правилу.
   5. Правило 9 брандмауэра (DNS) не применяется — переход к следующему правилу.
   6. Правило 10 брандмауэра (внутри подсети) не применяется —трафик разрешается, брандмауэр передает трафик на 10.0.1.4 (IIS01).
5. Подсеть Frontend начинает обработку правила для входящего трафика.
   1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
   2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
6. После аутентификации и авторизации IIS01 принимает запрос и отправляет ответ.
7. Определяемый пользователем маршрут в подсети Frontend следующим прыжком задает брандмауэр.
8. Так как правил для исходящего трафика в подсети Frontend нет, отправка ответа разрешается.
9. Так как это активный сеанс в брандмауэре, этот ответ разрешен и брандмауэр возвращает ответ AppVM02.
10. Подсеть BackEnd начинает обработку правила для входящего трафика:
    1. Правило 1 группы безопасности сети (блокирование доступа к Интернету) не применяется — переход к следующему правилу.
    2. Правила группы безопасности сети по умолчанию разрешают трафик между подсетями — трафик разрешается, дальнейшая обработка правила группы безопасности сети прекращается.
11. AppVM02 получает ответ.

#### <a name="denied-internet-direct-to-web-server"></a>(Запрещено) Запрос из Интернета напрямую к веб-серверу
1. Интернет-пользователь пытается получить доступ к веб-серверу IIS01 через службу FrontEnd001.CloudApp.Net.
2. Так как для HTTP-трафика не открыты конечные точки, этот запрос не будет передан через облачную службу к серверу.
3. Если бы по какой-то причине конечные точки оказались открытыми, группа безопасности сети (блокирование доступа к Интернету) в подсети Frontend заблокировала бы этот трафик.
4. И наконец, определяемый пользователем маршрут в подсети Frontend следующим прыжком отправит весь исходящий трафик от IIS01 на брандмауэр. Брандмауэр примет его как асимметричный и отбросит исходящий трафик. Существует по крайней мере три независимых уровня защиты между Интернетом и IIS01 через облачную службу, которые предотвращают несанкционированный и несоответствующий доступ.

#### <a name="denied-internet-to-backend-server"></a>Запрос из Интернета к тыловому серверу (запрещено)
1. Интернет-пользователь пытается получить доступ к файлу на AppVM01 через службу BackEnd001.CloudApp.Net
2. Так как для файлового ресурса конечные точки не открыты, этот запрос не будет передан облачной службе и не поступит на сервер.
3. Если бы по какой-то причине конечные точки оказались открытыми, группа безопасности сети (блокирование доступа к Интернету) заблокировала бы этот трафик.
4. Наконец, определяемый пользователем маршрут следующим прыжком отправит любой исходящий трафик от AppVM01 в брандмауэр. Брандмауэр примет его как асимметричный и отбросит исходящий трафик. Таким образом, существует по крайней мере три независимых уровня защиты между Интернетом и AppVM01 через облачную службу, которые предотвращают несанкционированный и несоответствующий доступ.

#### <a name="denied-frontend-server-to-backend-server"></a>Запрос от сервера переднего плана к тыловому серверу (запрещено) 
1. Предположим, что IIS01 взломан и на нем выполняется вредоносный код, который пытается просканировать все серверы подсети Backend.
2. Определяемый пользователем маршрут подсети Frontend следующим прыжком отправит весь исходящий трафик от IIS01 на брандмауэр. Взломанная виртуальная машина не может это изменить.
3. Брандмауэр будет обрабатывать трафик, если запрос отправлен к AppVM01 или DNS-серверу для проверки с помощью DNS-запросов, что трафик потенциально может быть разрешен брандмауэром (из-за правил брандмауэра 7 и 9). Весь остальной трафик будет заблокирован (запрет любого трафика) правилом 11 брандмауэра.
4. В брандмауэре может быть включено обнаружение дополнительных угроз (эта тема не рассматривается в данном документе, сведения о расширенных возможностях противостояния угрозам см. в документации поставщика своего сетевого устройства). В таком случае даже трафик, который разрешен основными правилами пересылки, описанными в этом документе, может быть запрещен, если он содержит известные подписи или шаблоны, вызывающие правило дополнительных угроз.

#### <a name="denied-internet-dns-lookup-on-dns-server"></a>DNS-запрос из Интернета к серверу DNS (запрещено)
1. Пользователь Интернета пытается получить внутреннюю запись DNS на сервере DNS01 через службу BackEnd001.CloudApp.Net. 
2. Так как для DNS-трафика не открыты конечные точки, этот запрос не будет передан через облачную службу к серверу.
3. Если бы по какой-то причине конечные точки оказались открытыми, правило группы безопасности сети (блокирование доступа к Интернету) в подсети Frontend заблокировало бы этот трафик.
4. И наконец, определяемый пользователем маршрут в подсети Backend следующим прыжком отправит весь исходящий трафик от DNS01 на брандмауэр. Брандмауэр примет его как асимметричный и отбросит исходящий трафик. Существует по крайней мере три независимых уровня защиты между Интернетом и DNS01 через облачную службу, которые предотвращают несанкционированный и несоответствующий доступ.

#### <a name="denied-internet-to-sql-access-through-firewall"></a>Запрос данных SQL из Интернета через брандмауэр (запрещено)
1. Интернет-пользователь запрашивает данные SQL из службы SecSvc001.CloudApp.Net (облачная служба с выходом в Интернет).
2. Так как для данных SQL не открыты конечные точки, этот запрос не будет передан облачной службе и не достигнет брандмауэра.
3. Если конечные точки SQL открыты по какой-то причине, брандмауэр начнет обработку правила:
   1. Правило 1 брандмауэра (FW Mgmt) не применяется — переход к следующему правилу.
   2. Правила 2–5 брандмауэра (правила RDP) не применяются — переход к следующему правилу.
   3. Правила 6 и 7 брандмауэра (правила приложения) не применяются — переход к следующему правилу.
   4. Правило 8 брандмауэра (к Интернету) не применяется — переход к следующему правилу.
   5. Правило 9 брандмауэра (DNS) не применяется — переход к следующему правилу.
   6. Правило 10 брандмауэра (внутри подсети) не применяется — переход к следующему правилу.
   7. Правило 11 брандмауэра (запрет любого трафика) применяется — трафик блокируется, дальнейшая обработка правил прекращается.

## <a name="references"></a>Ссылки
### <a name="main-script-and-network-config"></a>Основной сценарий и конфигурация сети
Сохраните полный сценарий в файл сценария PowerShell. Сохраните конфигурацию сети в файле с именем NetworkConf2.xml.
При необходимости измените определенные пользователем переменные. Запустите сценарий, а затем следуйте инструкциям по настройке правил брандмауэра, приведенным выше.

#### <a name="full-script"></a>Полный сценарий
Используя определенные пользователем переменные, этот сценарий выполнит следующие действия.

1. Подключение к подписке Azure
2. Создание новой учетной записи хранения
3. Создаст виртуальную сеть и три подсети, которые указаны в файле конфигурации сети.
4. Соберет пять виртуальных машин: 1 брандмауэр и 4 виртуальных машины с Windows Server.
5. Настроит определяемые пользователем маршруты, включая следующее:
   1. Создание двух новых таблиц маршрутизации.
   2. Добавление маршрутов в таблицы.
   3. Привязка таблиц к соответствующим подсетям.
6. Включит IP-пересылку на виртуальном сетевом устройстве.
7. Настроит группу безопасности сети:
   1. Создаст группу безопасности сети.
   2. Добавит правило.
   3. привяжет группу безопасности сети к соответствующим подсетям.

Этот сценарий PowerShell должен запускаться локально на ПК или сервере, подключенном к Интернету.

> [!IMPORTANT]
> При запуске этого сценария могут выдаваться предупреждения и другие информационные сообщения PowerShell. Обращать внимание следует только на сообщения об ошибках, выделенные красным цветом.
> 
> 

    <# 
     .SYNOPSIS
      Example of DMZ and User Defined Routing in an isolated network (Azure only, no hybrid connections)

     .DESCRIPTION
      This script will build out a sample DMZ setup containing:
       - A default storage account for VM disks
       - Three new cloud services
       - Three Subnets (SecNet, FrontEnd, and BackEnd subnets)
       - A Network Virtual Appliance (NVA), in this case a Barracuda NextGen Firewall
       - One server on the FrontEnd Subnet
       - Three Servers on the BackEnd Subnet
       - IP Forwading from the FireWall out to the internet
       - User Defined Routing FrontEnd and BackEnd Subnets to the NVA

      Before running script, ensure the network configuration file is created in
      the directory referenced by $NetworkConfigFile variable (or update the
      variable to reflect the path and file name of the config file being used).

     .Notes
      Everyone's security requirements are different and can be addressed in a myriad of ways.
      Please be sure that any sensitive data or applications are behind the appropriate
      layer(s) of protection. This script serves as an example of some of the techniques
      that can be used, but should not be used for all scenarios. You are responsible to
      assess your security needs and the appropriate protections needed, and then effectively
      implement those protections.

      Security Service (SecNet subnet 10.0.0.0/24)
       myFirewall - 10.0.0.4

      FrontEnd Service (FrontEnd subnet 10.0.1.0/24)
       IIS01      - 10.0.1.4

      BackEnd Service (BackEnd subnet 10.0.2.0/24)
       DNS01      - 10.0.2.4
       AppVM01    - 10.0.2.5
       AppVM02    - 10.0.2.6

    #>

    # Fixed Variables
        $LocalAdminPwd = Read-Host -Prompt "Enter Local Admin Password to be used for all VMs"
        $VMName = @()
        $ServiceName = @()
        $VMFamily = @()
        $img = @()
        $size = @()
        $SubnetName = @()
        $VMIP = @()

    # User Defined Global Variables
      # These should be changes to reflect your subscription and services
      # Invalid options will fail in the validation section

      # Subscription Access Details
        $subID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

      # VM Account, Location, and Storage Details
        $LocalAdmin = "theAdmin"
        $DeploymentLocation = "Central US"
        $StorageAccountName = "vmstore02"

      # Service Details
        $SecureService = "SecSvc001"
        $FrontEndService = "FrontEnd001"
        $BackEndService = "BackEnd001"

      # Network Details
        $VNetName = "CorpNetwork"
        $VNetPrefix = "10.0.0.0/16"
        $SecNet = "SecNet"
        $FESubnet = "FrontEnd"
        $FEPrefix = "10.0.1.0/24"
        $BESubnet = "BackEnd"
        $BEPrefix = "10.0.2.0/24"
        $NetworkConfigFile = "C:\Scripts\NetworkConf3.xml"

      # VM Base Disk Image Details
        $SrvImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Windows Server 2012 R2 Datacenter'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}
        $FWImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Barracuda NextGen Firewall'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}

      # UDR Details
        $FERouteTableName = "FrontEndSubnetRouteTable"
        $BERouteTableName = "BackEndSubnetRouteTable"

      # NSG Details
        $NSGName = "MyVNetSG"

    # User Defined VM Specific Config
        # Note: To ensure UDR and IP forwarding is setup
        # properly this script requires VM 0 be the NVA.

        # VM 0 - The Network Virtual Appliance (NVA)
          $VMName += "myFirewall"
          $ServiceName += $SecureService
          $VMFamily += "Firewall"
          $img += $FWImg
          $size += "Small"
          $SubnetName += $SecNet
          $VMIP += "10.0.0.4"

        # VM 1 - The Web Server
          $VMName += "IIS01"
          $ServiceName += $FrontEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $FESubnet
          $VMIP += "10.0.1.4"

        # VM 2 - The First Appliaction Server
          $VMName += "AppVM01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.5"

        # VM 3 - The Second Appliaction Server
          $VMName += "AppVM02"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.6"

        # VM 4 - The DNS Server
          $VMName += "DNS01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.4"

    # ----------------------------- #
    # No User Defined Varibles or   #
    # Configuration past this point #
    # ----------------------------- #

      # Get your Azure accounts
        Add-AzureAccount
        Set-AzureSubscription –SubscriptionId $subID -ErrorAction Stop
        Select-AzureSubscription -SubscriptionId $subID -Current -ErrorAction Stop

      # Create Storage Account
        If (Test-AzureName -Storage -Name $StorageAccountName) { 
            Write-Host "Fatal Error: This storage account name is already in use, please pick a diffrent name." -ForegroundColor Red
            Return}
        Else {Write-Host "Creating Storage Account" -ForegroundColor Cyan 
              New-AzureStorageAccount -Location $DeploymentLocation -StorageAccountName $StorageAccountName}

      # Update Subscription Pointer to New Storage Account
        Write-Host "Updating Subscription Pointer to New Storage Account" -ForegroundColor Cyan 
        Set-AzureSubscription –SubscriptionId $subID -CurrentStorageAccountName $StorageAccountName -ErrorAction Stop

    # Validation
    $FatalError = $false

    If (-Not (Get-AzureLocation | Where {$_.DisplayName -eq $DeploymentLocation})) {
         Write-Host "This Azure Location was not found or available for use" -ForegroundColor Yellow
         $FatalError = $true}

    If (Test-AzureName -Service -Name $SecureService) { 
        Write-Host "The SecureService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The FrontEndService service name is valid for use." -ForegroundColor Green}

    If (Test-AzureName -Service -Name $FrontEndService) { 
        Write-Host "The FrontEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The FrontEndService service name is valid for use" -ForegroundColor Green}

    If (Test-AzureName -Service -Name $BackEndService) { 
        Write-Host "The BackEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The BackEndService service name is valid for use." -ForegroundColor Green}

    If (-Not (Test-Path $NetworkConfigFile)) { 
        Write-Host 'The network config file was not found, please update the $NetworkConfigFile variable to point to the network config xml file.' -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The network config file was found" -ForegroundColor Green
            If (-Not (Select-String -Pattern $DeploymentLocation -Path $NetworkConfigFile)) {
                Write-Host 'The deployment location was not found in the network config file, please check the network config file to ensure the $DeploymentLocation varible is correct and the netowrk config file matches.' -ForegroundColor Yellow
                $FatalError = $true}
            Else { Write-Host "The deployment location was found in the network config file." -ForegroundColor Green}}

    If ($FatalError) {
        Write-Host "A fatal error has occured, please see the above messages for more information." -ForegroundColor Red
        Return}
    Else { Write-Host "Validation passed, now building the environment." -ForegroundColor Green}

    # Create VNET
        Write-Host "Creating VNET" -ForegroundColor Cyan 
        Set-AzureVNetConfig -ConfigurationPath $NetworkConfigFile -ErrorAction Stop

    # Create Services
        Write-Host "Creating Services" -ForegroundColor Cyan
        New-AzureService -Location $DeploymentLocation -ServiceName $SecureService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $FrontEndService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $BackEndService -ErrorAction Stop

    # Build VMs
        $i=0
        $VMName | Foreach {
            Write-Host "Building $($VMName[$i])" -ForegroundColor Cyan
            If ($VMFamily[$i] -eq "Firewall") 
                { 
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Linux -LinuxUser $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                # Set up all the EndPoints we'll need once we're up and running
                # Note: All traffic goes through the firewall, so we'll need to set up all ports here.
                #       Also, the firewall will be redirecting traffic to a new IP and Port in a forwarding
                #       rule, so all of these endpoint have the same public and local port and the firewall
                #       will do the mapping, NATing, and/or redirection as declared in the firewall rules.
                Add-AzureEndpoint -Name "MgmtPort1" -Protocol tcp -PublicPort 801  -LocalPort 801  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "MgmtPort2" -Protocol tcp -PublicPort 807  -LocalPort 807  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "HTTP"      -Protocol tcp -PublicPort 80   -LocalPort 80   -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPWeb"    -Protocol tcp -PublicPort 8014 -LocalPort 8014 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp1"   -Protocol tcp -PublicPort 8025 -LocalPort 8025 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp2"   -Protocol tcp -PublicPort 8026 -LocalPort 8026 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPDNS01"  -Protocol tcp -PublicPort 8024 -LocalPort 8024 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                # Note: A SSH endpoint is automatically created on port 22 when the appliance is created.
                }
            Else
                {
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Windows -AdminUsername $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    Set-AzureVMMicrosoftAntimalwareExtension -AntimalwareConfiguration '{"AntimalwareEnabled" : true}' | `
                    Remove-AzureEndpoint -Name "RemoteDesktop" | `
                    Remove-AzureEndpoint -Name "PowerShell" | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                }
            $i++
        }

    # Configure UDR and IP Forwarding
        Write-Host "Configuring UDR" -ForegroundColor Cyan

      # Create the Route Tables
        Write-Host "Creating the Route Tables" -ForegroundColor Cyan 
        New-AzureRouteTable -Name $BERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $BESubnet subnet"
        New-AzureRouteTable -Name $FERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $FESubnet subnet"

      # Add Routes to Route Tables
        Write-Host "Adding Routes to the Route Tables" -ForegroundColor Cyan 
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $FEPrefix `
            -NextHopType VNETLocal

      # Assoicate the Route Tables with the Subnets
        Write-Host "Binding Route Tables to the Subnets" -ForegroundColor Cyan 
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $BESubnet `
            -RouteTableName $BERouteTableName
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $FESubnet `
            -RouteTableName $FERouteTableName

     # Enable IP Forwarding on the Virtual Appliance
        Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] `
            |Set-AzureIPForwarding -Enable

    # Configure NSG
        Write-Host "Configuring the Network Security Group (NSG)" -ForegroundColor Cyan

      # Build the NSG
        Write-Host "Building the NSG" -ForegroundColor Cyan
        New-AzureNetworkSecurityGroup -Name $NSGName -Location $DeploymentLocation -Label "Security group for $VNetName subnets in $DeploymentLocation"

      # Add NSG Rule
        Write-Host "Writing rules into the NSG" -ForegroundColor Cyan
        Get-AzureNetworkSecurityGroup -Name $NSGName | Set-AzureNetworkSecurityRule -Name "Isolate the $VNetName VNet from the Internet" -Type Inbound -Priority 100 -Action Deny `
            -SourceAddressPrefix INTERNET -SourcePortRange '*' `
            -DestinationAddressPrefix VIRTUAL_NETWORK -DestinationPortRange '*' `
            -Protocol *

      # Assign the NSG to two Subnets
        # The NSG is *not* bound to the Security Subnet. The result
        # is that internet traffic flows only to the Security subnet
        # since the NSG bound to the Frontend and Backback subnets
        # will Deny internet traffic to those subnets.
        Write-Host "Binding the NSG to two subnets" -ForegroundColor Cyan
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $FESubnet -VirtualNetworkName $VNetName
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $BESubnet -VirtualNetworkName $VNetName

    # Optional Post-script Manual Configuration
      # Configure Firewall
      # Install Test Web App (Run Post-Build Script on the IIS Server)
      # Install Backend resource (Run Post-Build Script on the AppVM01)
      Write-Host
      Write-Host "Build Complete!" -ForegroundColor Green
      Write-Host
      Write-Host "Optional Post-script Manual Configuration Steps" -ForegroundColor Gray
      Write-Host " - Configure Firewall" -ForegroundColor Gray
      Write-Host " - Install Test Web App (Run Post-Build Script on the IIS Server)" -ForegroundColor Gray
      Write-Host " - Install Backend resource (Run Post-Build Script on the AppVM01)" -ForegroundColor Gray
      Write-Host


#### <a name="network-config-file"></a>Файл конфигурации сети
Измените в этом XML-файле расположение и сохраните его. Затем добавьте ссылку на файл в переменную $NetworkConfigFile в приведенном выше сценарии.

    <NetworkConfiguration xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration">
      <VirtualNetworkConfiguration>
        <Dns>
          <DnsServers>
            <DnsServer name="DNS01" IPAddress="10.0.2.4" />
            <DnsServer name="Level3" IPAddress="209.244.0.3" />
          </DnsServers>
        </Dns>
        <VirtualNetworkSites>
          <VirtualNetworkSite name="CorpNetwork" Location="Central US">
            <AddressSpace>
              <AddressPrefix>10.0.0.0/16</AddressPrefix>
            </AddressSpace>
            <Subnets>
              <Subnet name="SecNet">
                <AddressPrefix>10.0.0.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="FrontEnd">
                <AddressPrefix>10.0.1.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="BackEnd">
                <AddressPrefix>10.0.2.0/24</AddressPrefix>
              </Subnet>
            </Subnets>
            <DnsServersRef>
              <DnsServerRef name="DNS01" />
              <DnsServerRef name="Level3" />
            </DnsServersRef>
          </VirtualNetworkSite>
        </VirtualNetworkSites>
      </VirtualNetworkConfiguration>
    </NetworkConfiguration>

#### <a name="sample-application-scripts"></a>Сценарии примера приложения
Пример приложения для этого и других примеров сети периметра можно скачать по [этой ссылке][SampleApp].

<!--Image References-->
[1]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3design.png "Двунаправленная сеть периметра с виртуальным сетевым устройством, группой безопасности сети и определяемыми пользователем маршрутами"
[2]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3firewalllogical.png "Логическое представление правил брандмауэра"
[3]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectfrontend.png "Создание сетевого объекта FrontEnd"
[4]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectdns.png "Создание объекта DNS-сервера"
[5]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpa.png "Копия правила RDP по умолчанию"
[6]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpb.png "Правило AppVM01"
[7]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconapplicationredirect.png "Значок перенаправления приложения"
[8]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/icondestinationnat.png "Значок NAT назначения"
[9]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconpass.png "Значок передачи"
[10]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulefirewall.png "Правило управления брандмауэром"
[11]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulerdp.png "Правило RDP брандмауэра"
[12]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleweb.png "Правило Интернета брандмауэра"
[13]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleappvm01.png "Правило AppVM01 брандмауэра"
[14]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleoutbound.png "Правило исходящего трафика брандмауэра"
[15]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledns.png "Правило DNS брандмауэра"
[16]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleintravnet.png "Правило брандмауэра для внутреннего трафика виртуальной сети"
[17]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledeny.png "Правило запрета брандмауэра"
[18]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/firewallruleactivate.png "Активация правила брандмауэра"

<!--Link References-->
[HOME]: ../best-practices-network-security.md
[SampleApp]: ./virtual-networks-sample-app.md
