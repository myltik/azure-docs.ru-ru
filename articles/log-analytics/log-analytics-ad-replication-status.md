---
title: Мониторинг состояния репликации Active Directory с помощью Azure Log Analytics | Документация Майкрософт
description: Пакет решения "Состояние репликации Active Directory" регулярно отслеживает среду Active Directory на наличие ошибок репликации.
services: log-analytics
documentationcenter: ''
author: MGoedtel
manager: carmonm
editor: ''
ms.assetid: 1b988972-8e01-4f83-a7f4-87f62778f91d
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/24/2018
ms.author: magoedte
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 7707c4a1afdc42ef44a7b6f761ceb03b7e7da2f0
ms.sourcegitcommit: b32d6948033e7f85e3362e13347a664c0aaa04c1
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/13/2018
ms.locfileid: "29179340"
---
# <a name="monitor-active-directory-replication-status-with-log-analytics"></a>Мониторинг состояния репликации Active Directory с помощью Log Analytics

![Символ "Состояние репликации AD"](./media/log-analytics-ad-replication-status/ad-replication-status-symbol.png)

Active Directory является ключевым компонентом в корпоративной ИТ-среде. Чтобы обеспечить высокий уровень доступности и высокую производительность, каждый контроллер домена использует собственную копию базы данных Active Directory. Контроллеры домена реплицируют данные между собой, чтобы распространять изменения на предприятии. Сбои этого процесса репликации могут вызывать различные проблемы на предприятии.

Пакет решения "Состояние репликации AD" регулярно отслеживает среду Active Directory на наличие ошибок репликации.

## <a name="installing-and-configuring-the-solution"></a>Установка и настройка решения
Для установки и настройки решений используйте указанные ниже данные.

* Агенты необходимо установить на контроллерах домена, являющихся членами домена, который будет оцениваться. Или агенты нужно установить на рядовых серверах и настроить для отправки данных репликации AD в Log Analytics. Чтобы понять, как подключить компьютеры Windows к Log Analytics, ознакомьтесь со статьей [Connect Windows computers to the Log Analytics service in Azure](log-analytics-windows-agent.md) (Подключение компьютеров Windows к службе Log Analytics в Azure). Если контроллер домена уже является частью существующей среды System Center Operations Manager, которую вы хотите подключить к Log Analytics, см. статью [Connect Operations Manager to Log Analytics](log-analytics-om-agents.md) (Подключение Operations Manager к Log Analytics).
* Добавьте решение для контроля состояния репликации Active Directory в рабочую область Log Analytics, как описано в статье [Добавление решений для управления Azure Log Analytics в рабочую область](log-analytics-add-solutions.md).  Дополнительная настройка не требуется.

## <a name="ad-replication-status-data-collection-details"></a>Сведения о сборе данных состояния репликации AD
В следующей таблице приведены методы сбора данных и другие сведения о сборе данных для решения для контроля состояния репликации AD.

| платформа | Direct Agent | Агент SCOM | Хранилище Azure | Нужен ли SCOM? | Отправка данных агента SCOM через группу управления | Частота сбора |
| --- | --- | --- | --- | --- | --- | --- |
| Windows |&#8226; |&#8226; |  |  |&#8226; |Каждые пять дней |

## <a name="optionally-enable-a-non-domain-controller-to-send-ad-data-to-log-analytics"></a>Включение отправки данных AD в Log Analytics на компьютере, не являющемся контроллером домена (необязательно)
Если вы не хотите подключать напрямую какой-либо из контроллеров домена к Log Analytics, то можете использовать любой другой компьютер в вашем домене, который подключен к Log Analytics, для сбора данных для пакета решения для контроля состояния репликации AD и их отправки.

### <a name="to-enable-a-non-domain-controller-to-send-ad-data-to-log-analytics"></a>Как включить отправку данных AD в Log Analytics на компьютере, не являющемся контроллером домена
1. Убедитесь, что компьютер является участником домена, который вы хотите отслеживать с помощью решения для контроля состояния репликации AD.
2. [Подключите компьютер Windows к Log Analytics](log-analytics-windows-agent.md) или [подключите его к Log Analytics с помощью существующей среды Operations Manager](log-analytics-om-agents.md), если он еще не подключен.
3. На этом компьютере настройте следующий раздел реестра.

   * Раздел: **HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\HealthService\Parameters\Management Groups\<ManagementGroupName>\Solutions\ADReplication**
   * Значение: **IsTarget**.
   * Данные значения: **true**

   > [!NOTE]
   > Эти изменения не вступят в силу, пока вы не перезапустите службу Microsoft Monitoring Agent (HealthService.exe).
   >
   >

## <a name="understanding-replication-errors"></a>Основные сведения об ошибках репликации
Настроив отправку данных о состоянии репликации AD в Log Analytics, вы увидите в Log Analytics элемент, аналогичный приведенному ниже, в котором указывается, сколько ошибок репликации обнаружено в настоящее время.  
![Элемент состояния репликации AD](./media/log-analytics-ad-replication-status/oms-ad-replication-tile.png)

**Критические ошибки репликации** — это ошибки, существующие не меньше 75 % от [времени существования отметки полного удаления](https://technet.microsoft.com/library/cc784932%28v=ws.10%29.aspx) для леса Active Directory.

Если щелкнуть элемент, можно просмотреть дополнительные сведения об ошибках.
![Панель мониторинга состояния репликации AD](./media/log-analytics-ad-replication-status/oms-ad-replication-dash.png)

### <a name="destination-server-status-and-source-server-status"></a>Состояния сервера назначения и исходного сервера
В этих столбцах отображается состояние серверов назначения и исходных серверов, на которых возникают ошибки репликации. Число после каждого имени контроллера домена означает количество ошибок репликации на этом контроллере домена.

Ошибки на исходных серверах и серверах назначения отображаются потому, что одни проблемы проще устранить, рассматривая исходный сервер, а другие — рассматривая сервер назначения.

В этом примере можно видеть, что на многих серверах назначения приблизительно одинаковое количество ошибок, но на одном исходном сервере (ADDC35) ошибок больше, чем на всех остальных. Скорее всего на ADDC35 возникла проблема, вызвавшая сбой при отправке данных в соответствующие партнеры репликации. Устранение проблем на ADDC35, вероятнее всего, устранит многие из ошибок, которые отображаются в области сервера назначения.

### <a name="replication-error-types"></a>Типы ошибок репликации
Эта область содержит сведения о типах ошибок, обнаруженных на предприятии. Каждая ошибка имеет уникальный числовой код и сообщение, которое может помочь определить первопричину ошибки.

Кольцевая диаграмма вверху позволяет понять, какие ошибки возникают в вашей среде чаще, а какие реже.

С ее помощью можно определить, когда в нескольких контроллерах домена возникает одна и та же ошибка репликации. В этом случае можно обнаружить или определить решение для одного контроллера домена, а затем повторить его на других контроллерах домена с такой же ошибкой.

### <a name="tombstone-lifetime"></a>Время существования отметки полного удаления
Время существования отметки полного удаления определяет, как долго удаленный объект, называемый отметкой полного удаления, сохраняется в базе данных Active Directory. Когда время существования отметки полного удаления удаленного объекта истекает, процесс сбора мусора автоматически удаляет его из базы данных Active Directory.

Время существования отметки полного удаления по умолчанию составляет 180 дней в последних версиях Windows, но в старых версиях оно составляло 60 дней. Администратор Active Directory может изменить его явным образом.

Важно знать, существуют ли возникающие ошибки репликации меньше или больше времени существования отметки полного удаления. Если в двух контроллерах домена возникают ошибки репликации, существующие больше времени существования отметки полного удаления, то репликация между этими двумя контроллерами домена будет отключена, даже если базовая ошибка репликации была устранена.

С помощью области времени существования отметки полного удаления можно определить, где существует риск отключения репликации. Каждая ошибка в категории **Over 100% TSL** (Больше 100 % времени существования отметки полного удаления) представляет секцию, которая не была реплицирована между исходным сервером и сервером назначения по крайней мере в течение времени существования отметки полного удаления, заданного для леса.

В этом случае просто устранить ошибку репликации будет недостаточно. Как минимум потребуется вручную выявить и очистить устаревшие объекты, прежде чем можно будет перезапустить репликацию. Возможно даже придется списать контроллер домена.

Помимо выявления ошибок репликации, которые существовали дольше времени существования отметки полного удаления, также следует уделить внимание ошибкам, попавшим в категорию **50-75% TSL** (50–75 % времени существования отметки полного удаления) или **75-100% TSL** (75–100 % времени существования отметки полного удаления).

Это явно устойчивые, не временные ошибки, поэтому для их устранения, скорее всего, потребуется ваше вмешательство. Хорошая новость состоит в том, что их время существования еще не достигло времени существования отметки полного удаления. Если вы быстро устраните эти проблемы *до* того, как их продолжительность достигнет времени существования отметки полного удаления, репликацию можно будет перезапустить с минимальным ручным вмешательством.

Как уже отмечалось, в элементе панели мониторинга решения для контроля состояния репликации AD показано число *критических* ошибок репликации в среде. Это ошибки, существующие больше 75 % времени существования отметки полного удаления (включая ошибки, которые существуют больше 100 % этого времени). Старайтесь, чтобы это количество было равно 0.

> [!NOTE]
> Все проценты от времени существования отметки полного удаления вычисляются от фактического времени существования отметки полного удаления, заданном для леса Active Directory. Поэтому вы можете полагать эти проценты верными, даже если задали пользовательское значение времени существования отметки полного удаления.
>
>

### <a name="ad-replication-status-details"></a>Сведения о состоянии репликации AD
Если щелкнуть любой элемент в одном из списков, вы увидите дополнительные сведения о нем с помощью поиска по журналам. Результаты будут отфильтрованы по элементу, чтобы показать только ошибки, относящиеся к нему. Например, если щелкнуть первый контроллер домена в списке **Destination Server Status (ADDC02)** (Состояние сервера назначения (ADDC02)), вы увидите отфильтрованные результаты поиска, содержащие только ошибки, в которых в качестве сервера назначения указан этот контроллер домена.

![Ошибки состояния репликации AD в результатах поиска](./media/log-analytics-ad-replication-status/oms-ad-replication-search-details.png)

Здесь можно применить дополнительные фильтры, изменить запрос поиска и так далее. Дополнительные сведения об использовании поиска по журналам см. в статье [Поиск по журналам в Log Analytics](log-analytics-log-searches.md).

В поле **HelpLink** отображается URL-адрес страницы TechNet с дополнительными сведениями об этой конкретной ошибке. Можно скопировать эту ссылку и вставить ее в окно браузера, чтобы просмотреть сведения об диагностике и устранении ошибки.

Кроме того, вы можете экспортировать результаты в Excel, щелкнув **Экспортировать** . Экспорт позволяет визуализировать данные об ошибках репликации любым способом на ваш выбор.

![Экспортированные ошибки состояния репликации AD в Excel](./media/log-analytics-ad-replication-status/oms-ad-replication-export.png)

## <a name="ad-replication-status-faq"></a>Вопросы и ответы о состоянии репликации AD
**Вопрос. Как часто обновляются данные о состоянии репликации AD?**
Ответ. Данные обновляются каждые пять дней.

**Вопрос. Можно ли настроить частоту обновления данных?**
Ответ. На данный момент нет.

**Вопрос. Необходимо ли добавить все контроллеры домена в мою рабочую область Log Analytics, чтобы просмотреть состояние репликации?**
Ответ. Нет, нужно добавить только один контроллер домена. Если у вас несколько контроллеров домена в рабочей области Log Analytics, в Log Analytics отправляются данные со всех контроллеров.

**Вопрос. Я не хочу добавлять какие-либо контроллеры домена в мою рабочую область Log Analytics. Смогу ли я тогда использовать решения для контроля состояния репликации AD?**
Ответ. Да. Для этого вы можете задать значение раздела реестра. Ознакомьтесь с разделом [Как включить отправку данных AD в Log Analytics на компьютере, не являющемся контроллером домена](#to-enable-a-non-domain-controller-to-send-ad-data-to-oms).

**Вопрос. Как называется процесс, который собирает данные?**
Ответ. AdvisorAssessment.exe.

**Вопрос. Сколько времени требуется для сбора данных?**
Ответ. Время сбора данных зависит от размера среды Active Directory, но обычно это менее 15 минут.

**Вопрос. Какие данные какого типа собираются?**
Ответ. Сведения о репликации собираются по протоколу LDAP.

**Вопрос. Можно ли настроить время сбора данных?**
Ответ. На данный момент нет.

**Вопрос. Какие разрешения требуются для сбора данных?**
Ответ. Разрешений обычного пользователя в Active Directory будет достаточно.

## <a name="troubleshoot-data-collection-problems"></a>Устранение неполадок при сборе данных
Для сбора данных пакету решения для контроля состояния репликации AD требуется, чтобы к рабочей области Log Analytics был подключен по крайней мере один контроллер домена. Пока вы не подключите контроллер домена, будет отображаться сообщение о том, что **сбор данных по-прежнему выполняется**.

Если вам требуется помощь при подключении одного из контроллеров домена, вы можете ознакомиться с документацией по [подключению компьютеров Windows к Log Analytics](log-analytics-windows-agent.md). Кроме того, если ваш контроллер домена уже подключен к существующей среде System Center Operations Manager, вы можете ознакомиться с документацией по [подключению System Center Operations Manager к Log Analytics](log-analytics-om-agents.md).

Если вы не хотите подключать контроллеры домена напрямую к Log Analytics или System Center Operations Manager, см. статью [Как включить отправку данных AD в Log Analytics на компьютере, не являющемся контроллером домена](#to-enable-a-non-domain-controller-to-send-ad-data-to-oms).

## <a name="next-steps"></a>Дополнительная информация
* Используйте [поиск по журналам в Log Analytics](log-analytics-log-searches.md) , чтобы просматривать подробные данные о состоянии репликации Active Directory.
