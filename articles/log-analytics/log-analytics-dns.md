---
title: Решение "Аналитика DNS" в Azure Log Analytics | Документация Майкрософт
description: Узнайте, как настроить и использовать решение аналитики DNS в Log Analytics, чтобы собрать сведения об инфраструктуре DNS — безопасности, производительности и операциях.
services: log-analytics
documentationcenter: ''
author: MGoedtel
manager: carmonm
editor: ''
ms.assetid: f44a40c4-820a-406e-8c40-70bd8dc67ae7
ms.service: log-analytics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/20/2018
ms.author: magoedte
ms.openlocfilehash: 6a59cf8b9444fe7cb197501c51d10dae81acb027
ms.sourcegitcommit: d74657d1926467210454f58970c45b2fd3ca088d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/28/2018
---
# <a name="gather-insights-about-your-dns-infrastructure-with-the-dns-analytics-preview-solution"></a>Сбор сведений об инфраструктуре DNS с помощью решения аналитики DNS (предварительной версии)

![Символ "Аналитика DNS"](./media/log-analytics-dns/dns-analytics-symbol.png)

В этой статье описывается, как настроить и использовать решение аналитики DNS Azure в службе Azure Log Analytics, чтобы собрать сведения об инфраструктуре DNS — безопасности, производительности и операциях.

Решение аналитики DNS помогает выполнить следующие задачи:

- определить клиенты, которые пытаются разрешить вредоносные доменные имена;
- определить устаревшие записи ресурсов;
- определить часто запрашиваемые доменные имена и "разговорчивые" DNS-клиенты;
- просмотреть нагрузку запросов на DNS-серверы;
- просмотреть ошибки при регистрации динамических DNS.

Это решение собирает, анализирует и сопоставляет данные журналов аналитики и аудита Windows DNS, а также другие связанные данные с DNS-серверов.

## <a name="connected-sources"></a>Подключенные источники

В следующей таблице описаны подключенные источники, поддерживаемые этим решением.

| **Подключенный источник** | **Поддержка** | **Описание** |
| --- | --- | --- |
| [Агенты Windows](log-analytics-windows-agent.md) | Yes | Решение собирает сведения о DNS из агентов Windows. |
| [Агенты Linux](log-analytics-linux-agents.md) | Нет  | Решение не собирает сведения о DNS из прямых агентов Linux. |
| [Группа управления System Center Operations Manager](log-analytics-om-agents.md) | Yes | Решение собирает сведения о DNS из агентов в подключенной группе управления Operations Manager. Прямое подключение из агента Operations Manager к Operations Management Suite не требуется. Данные пересылаются из группы управления в репозиторий Operations Management Suite. |
| [Учетная запись хранения Azure](log-analytics-azure-storage.md) | Нет  | Решение не использует службу хранилища Azure. |

### <a name="data-collection-details"></a>Сведения о сборе данных

Решение собирает данные, связанные с инвентаризацией и событиями DNS, с DNS-серверов, на которых установлен агент Log Analytics. Затем эти данные передаются в службу Log Analytics и отображаются на панели мониторинга решения. Данные, связанные с инвентаризацией, такие как количество DNS-серверов, зон и записей ресурсов, собираются с помощью командлетов PowerShell для DNS. Эти данные обновляются каждые два дня. Данные, связанные с событиями, собираются практически в реальном времени из [журналов аналитики и аудита](https://technet.microsoft.com/library/dn800669.aspx#enhanc), которые обеспечиваются расширенными функциями диагностики и ведения журнала DNS в Windows Server 2012 R2.

## <a name="configuration"></a>Параметр Configuration

Для настройки решения используйте указанные ниже данные.

- Агент [Windows](log-analytics-windows-agent.md) или [Operations Manager](log-analytics-om-agents.md) должен быть установлен на каждом DNS-сервере, который вы хотите отслеживать.
- Вы можете добавить решение аналитики DNS в рабочую область Operations Management Suite из [Azure Marketplace](https://aka.ms/dnsanalyticsazuremarketplace). Вы также можете использовать процесс, описанный в статье [Добавление решений для управления Azure Log Analytics в рабочую область](log-analytics-add-solutions.md).

Чтобы решение начало сбор данных, никакие дополнительные настройки не требуются. Однако можно использовать описанные ниже действия, чтобы настроить процесс сбора данных.

### <a name="configure-the-solution"></a>Настройка решения

На панели мониторинга решения щелкните **Конфигурация**, чтобы открыть страницу "Конфигурация аналитики DNS". В конфигурацию можно внести два типа изменений:

- **Разрешенные доменные имена**. Это решение не обрабатывает все запросы поиска. Для этого используется список разрешенных суффиксов доменного имени. Если результатом запроса поиска является доменное имя, которое соответствует суффиксу доменного имени из этого списка, то такой запрос не обрабатывается решением. Возможность не обрабатывать разрешенные доменные имена помогает оптимизировать данные, отправляемые в Log Analytics. Список разрешенных имен по умолчанию включает в себя популярные общедоступные доменные имена, такие как www.google.com и www.facebook.com. Используя полосу прокрутки, можно просмотреть полный список по умолчанию.

 Вы можете изменить этот список, добавив любые суффиксы доменных имен, для которых необходимо просмотреть сведения о поиске. Вы также можете удалить любые суффиксы доменных имен, если не хотите просматривать сведения о поиске.

- **Порог на "разговорчивых" клиентов**. DNS-клиенты, которые превышают пороговое значение для числа запросов поиска, будут выделены в колонке **DNS-клиенты**. Пороговое значение по умолчанию — 1000. Это значение можно изменить.

    ![Разрешенные доменные имена](./media/log-analytics-dns/dns-config.png)

## <a name="management-packs"></a>Пакеты управления

Если для подключения к рабочей области OMS используется Microsoft Monitoring Agent, то устанавливается следующий пакет управления:

- Пакет сбора данных Microsoft DNS (Microsft.IntelligencePacks.Dns)

Если группа управления Operations Manager подключена к рабочей области OMS, при добавлении этого решения в Operations Manager будут установлены следующие пакеты. Для этих пакетов управления не требуется никакая настройка или обслуживание:

- Пакет сбора данных Microsoft DNS (Microsft.IntelligencePacks.Dns)
- Конфигурация аналитики DNS для Microsoft System Center Advisor (Microsoft.IntelligencePack.Dns.Configuration)

Дополнительные сведения об обновлении пакетов управления для решений см. в статье [Подключение Operations Manager к Log Analytics](log-analytics-om-agents.md).

## <a name="use-the-dns-analytics-solution"></a>Использование решения аналитики DNS

В этом разделе описываются функции панели мониторинга и способы их использования.

После добавления решения в рабочую область в элементе решения на странице обзора OMS отобразится краткая сводка сведений об инфраструктуре DNS. Здесь можно просмотреть количество DNS-серверов, с которых собираются данные, а также количество запросов, выполненных за последние 24 часа клиентами для разрешения вредоносных доменов. Щелкните плитку, чтобы открылась панель мониторинга решения.

![Элемент "Аналитика DNS"](./media/log-analytics-dns/dns-tile.png)

### <a name="solution-dashboard"></a>Панель мониторинга решения

На панели мониторинга решения отображаются сводные данные для различных компонентов решения. Здесь также есть ссылки на подробное представление для ретроспективного анализа и диагностики. По умолчанию данные отображаются за последние семь дней. Вы можете изменить диапазон дат и времени с помощью **элемента управления для выбора даты и времени**, как показано на изображении ниже.

![Элемент управления для выбора времени](./media/log-analytics-dns/dns-time.png)

На панели мониторинга решения отображаются следующие колонки:

**Безопасность DNS**. Сообщает о DNS-клиентах, которые пытаются обмениваться данными с вредоносными доменами. Используя каналы корпорации Майкрософт для аналитики угроз, решение аналитики DNS может обнаруживать IP-адреса клиентов, которые пытаются получить доступ к вредоносным доменам. Во многих случаях устройства, инфицированные вредоносными программами, "дозваниваются" в центр "команд и управления" вредоносного домена, разрешая вредоносное доменное имя.

![Колонка "Безопасность DNS"](./media/log-analytics-dns/dns-security-blade.png)

При выборе IP-адреса клиента из списка откроется колонка поиска по журналу, в которой отобразятся сведения о соответствующем запросе поиска. В следующем примере решение аналитики DNS обнаружило, что обмен данными выполнялся с программой-трояном [IRCbot](https://www.microsoft.com/security/portal/threat/encyclopedia/entry.aspx?Name=Win32/IRCbot).

![Результаты поиска по журналу, показывающие ircbot](./media/log-analytics-dns/ircbot.png)

Эти сведения помогут вам определить следующее:

- IP-адрес клиента, инициировавший обмен данными;
- доменное имя, разрешающееся во вредоносный IP-адрес;
- IP-адреса, в которые разрешается доменное имя;
- вредоносный IP-адрес;
- степень серьезности проблемы;
- причину для добавления вредоносного IP-адреса в список блокировок;
- время обнаружения.

**Запрошенные домены**. Отображает доменные имена, которые чаще всего запрашиваются DNS-клиентами в вашей среде. Вы можете просмотреть список всех запрошенных доменных имен. Вы также можете детальнее просмотреть сведения о запросе поиска конкретного доменного имени в поиске по журналу.

![колонка "Запрошенные домены"](./media/log-analytics-dns/domains-queried-blade.png)

**DNS-клиенты**. Сообщает о клиентах, которые *превышают пороговое значение* для числа запросов в указанный период времени. Список всех DNS-клиентов и сведения о запросах, выполненных ими, можно просмотреть в колонке "Поиск по журналу".

![Колонка "DNS-клиенты"](./media/log-analytics-dns/dns-clients-blade.png)

**Динамические регистрации DNS**. Сообщает об ошибках при регистрации имени. В этой колонке выделяются все ошибки регистрации [записей ресурсов](https://en.wikipedia.org/wiki/List_of_DNS_record_types) адресов (типов A и AAAA), а также IP-адреса клиентов, выполнившие эти запросы на регистрацию. Эти сведения затем можно использовать для поиска основной причины сбоя регистрации:

1. Найдите зону, заслуживающую доверия для имени, которое клиент пытается обновить.

2. Используйте решение для проверки данных инвентаризации из этой зоны.

3. Убедитесь, что для этой зоны включено динамическое обновление.

4. Проверьте, настроена ли зона для выполнения безопасного динамического обновления.

    ![Колонка "Динамические регистрации DNS"](./media/log-analytics-dns/dynamic-dns-reg-blade.png)

**Запросы на регистрацию имени**. В верхнем элементе отображается линия тренда, демонстрирующая число успешных и невыполненных запросов на динамическое обновление DNS. В нижнем элементе отображается список первых 10 клиентов с наибольшим числом невыполненных запросов на обновление DNS, отправленных на DNS-серверы. Клиенты отсортированы по числу ошибок.

![Колонка "Запросы на регистрацию имени" ](./media/log-analytics-dns/name-reg-req-blade.png)

**Примеры запросов аналитики DDI**. Содержит список наиболее распространенных поисковых запросов, которые напрямую извлекают необработанные данные аналитики.


![Примеры запросов](./media/log-analytics-dns/queries.png)

Эти запросы можно использовать как отправную точку для создания собственных запросов для настраиваемых отчетов. Эти запросы открывают страницу поиска по журналам аналитики DNS, где отображаются следующие результаты:

- **Список DNS-серверов**. Отображает список всех DNS-серверов со связанными с ними полным доменным именем (FQDN), доменным именем, именем леса и IP-адресами серверов.
- **Список зон DNS**. Отображает список всех зон DNS со связанными с ними именем зоны, состоянием динамического обновления, серверами имен и состоянием подписания DNSSEC.
- **Записи неиспользованных ресурсов**. Отображает список всех неиспользованных или устаревших записей ресурсов. Этот список содержит имя записи ресурса, тип записи ресурса, связанный DNS-сервер, время создания записи и имя зоны. С помощью этого списка можно определить записи ресурсов DNS, которые больше не используются. Затем на основании этой информации вы можете удалить эти записи с DNS-серверов.
- **Нагрузка от запросов на DNS-серверы**. Позволяет просмотреть нагрузку DNS на DNS-серверы в перспективе. Учитывая эти сведения, вы можете правильно спланировать емкость серверов. Вы можете перейти на вкладку **метрик**, чтобы изменить представление на графическую визуализацию. Это представление позволяет лучше понять, как нагрузка DNS распределяется между DNS-серверами. Для каждого сервера показаны тенденции изменения числа запросов DNS.

    ![Запросы к DNS-серверам: результаты поиска по журналу](./media/log-analytics-dns/dns-servers-query-load.png)

- **Нагрузка от запросов на зоны DNS**. Показывает статистику количества запросов в секунду для всех зон DNS на DNS-серверах, управляемых решением. Щелкните вкладку **Метрики**, чтобы заменить представление подробных записей графической визуализацией.
- **События настройки**. Показывает все события изменения конфигурации DNS и связанные сообщения. Затем эти события можно отфильтровать по времени события, идентификатору события, DNS-серверу или категории задачи. С помощью этих данных можно отслеживать изменения, внесенные на определенных DNS-серверах в определенное время.
- **Журнал аналитики по DNS**. Показывает все события аналитики на всех DNS-серверах, управляемых решением. Затем эти события можно отфильтровать по времени события, идентификатору события, DNS-серверу, IP-адресу клиента, выполнившему запрос поиска, а также запросить категорию задачи типа. События аналитики DNS-сервера позволяют отслеживать действия на DNS-сервере. Событие аналитики записывается в журнал каждый раз, когда сервер отправляет или получает сведения о DNS.

### <a name="search-by-using-dns-analytics-log-search"></a>Поиск с помощью поиска по журналам аналитики DNS

На странице поиска по журналам можно создать запрос. Результаты поиска можно фильтровать с помощью элементов управления аспектами. Можно создать сложные запросы для преобразования и фильтрации результатов, а также для формирования соответствующих отчетов. Начните с помощью следующих запросов:

1. В **поле поискового запроса** введите `DnsEvents`, чтобы просмотреть все события DNS, создаваемые DNS-серверами под управлением решения. В результатах отобразятся данные журнала для всех событий, связанных с запросами поиска, динамическими регистрациями и изменениями конфигурации.

    ![Поиск по журналу событий DNS](./media/log-analytics-dns/log-search-dnsevents.png)  

    a. Чтобы просмотреть данные журнала о запросах поиска, отфильтруйте **подтип** по значению **LookUpQuery**, используя элемент управления в левой части экрана. Отобразится таблица, содержащая все события запросов поиска за выбранный период времени.

    Б. Чтобы просмотреть данные журнала о динамических регистрациях, отфильтруйте **подтип** по значению **DynamicRegistration**, используя элемент управления в левой части экрана. Отобразится таблица, содержащая все события динамической регистрации за выбранный период времени.

    c. Чтобы просмотреть данные журнала об изменениях конфигурации, отфильтруйте **подтип** по значению **ConfigurationChange**, используя элемент управления в левой части экрана. Отобразится таблица, содержащая все события изменения конфигурации за выбранный период времени.

2. В **поле поискового запроса** введите `DnsInventory`, чтобы просмотреть все данные, относящиеся к инвентаризации DNS, для DNS-серверов под управлением решения. В списке результатов отобразятся данные журнала о DNS-серверах, зонах DNS и записях ресурсов.

    ![Поиск по журналу инвентаризации DNS](./media/log-analytics-dns/log-search-dnsinventory.png)

## <a name="feedback"></a>Отзыв

Вы можете отправить отзыв двумя способами.

- **UserVoice**. Напишите свои предложения по улучшению функций решения аналитики DNS. Перейдите на страницу [Azure Log Analytics (OMS)](https://aka.ms/dnsanalyticsuservoice).
- **Присоединиться к когорте наших клиентов**. Мы всегда заинтересованы в новых клиентах. Получайте доступ к новым функциям и помогайте нам улучшать решение аналитики DNS. Если вы хотите присоединиться к когорте, пройдите этот [быстрый опрос](https://aka.ms/dnsanalyticssurvey).

## <a name="next-steps"></a>Дополнительная информация

[Выполните поиск по журналам](log-analytics-log-searches.md), чтобы просмотреть подробные записи журналов DNS.
