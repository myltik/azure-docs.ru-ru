<properties 
    pageTitle="Рекомендации по повышению производительности с помощью служебной шины | Microsoft Azure"
    description="В этой статье описывается использование служебной шины Azure для оптимизации производительности при обмене сообщениями через брокер."
    services="service-bus"
    documentationCenter="na"
    authors="sethmanheim"
    manager="timlt"
    editor="" /> 
<tags 
    ms.service="service-bus"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="na"
    ms.date="07/08/2016"
    ms.author="sethm" />

# Рекомендации по повышению производительности с помощью обмена сообщениями через брокер в служебной шине

В этой статье описывается использование служебной шины Azure для оптимизации производительности при обмене сообщениями через брокер. В первой части статьи описываются различные механизмы, которые можно использовать для повышения производительности. Во второй части приведены инструкции по эффективному использованию служебной шины для достижения максимальной производительности при определенных условиях.

В этой статье термин «клиент» означает любую сущность, которая обращается к служебной шине. Клиент может быть как отправителем, так и получателем. Термин «отправитель» используется в отношении клиента очереди или раздела служебной шины, который отправляет сообщения в очередь или раздел служебной шины. Термин «получатель» используется в отношении клиента очереди или подписки служебной шины, который получает сообщения из очереди или подписки служебной шины.

В разделах ниже описывается ряд способов, которые используются служебной шиной для повышения производительности.

## Протоколы

Служебная шина позволяет клиентам отправлять и получать сообщения через два протокола — протокол клиента служебной шины и HTTP (REST). Протокол клиента служебной шины более эффективен, так как поддерживает подключение к службе служебной шины на протяжении всего периода существования фабрики обмена сообщениями. Он также реализует функции пакетной обработки и предварительной выборки. Протокол клиента служебной шины доступен для приложений .NET через интерфейсы API .NET.

Если явно не указано иное, в этой статье предполагается использование протокола клиента служебной шины.

## Повторное использование фабрик и клиентов

Клиентские объекты служебной шины, такие как [QueueClient][] или [MessageSender][], создаются с помощью объекта [MessagingFactory][]. Помимо прочего, этот объект обладает функциями внутреннего управления подключениями. Не следует закрывать фабрики обмена сообщениями или клиенты очередей, разделов и подписок после отправки сообщения, а затем повторно создавать их при отправке следующего сообщения. При закрытии фабрики обмена сообщениями удаляется подключение к службе служебной шины, а при повторном создании фабрики устанавливается новое подключение. Установка подключения является ресурсоемкой операцией, которую можно исключить, если повторно использовать одну и ту же фабрику и клиентские объекты для нескольких операций. Можно безопасно использовать объект [QueueClient][] для отправки сообщений из параллельных асинхронных операций и нескольких потоков.

## Параллельные операции

Выполнение любой операции (отправка, получение, удаление и т. д.) занимает определенное время. В это время входит обработка операции службой Service Bus, а также задержка запроса и ответа. Чтобы увеличить количество операций в единицу времени, необходимо выполнять их параллельно. Это можно сделать несколькими способами.

-   **Асинхронные операции**. Клиент планирует действия за счет асинхронных операций. Следующий запрос запускается до завершения предыдущего запроса. Вот пример асинхронной операции отправки:

	```
	BrokeredMessage m1 = new BrokeredMessage(body);
	BrokeredMessage m2 = new BrokeredMessage(body);
	
	Task send1 = queueClient.SendAsync(m1).ContinueWith((t) => 
	  {
	    Console.WriteLine("Sent message #1");
	  });
	Task send2 = queueClient.SendAsync(m2).ContinueWith((t) => 
	  {
	    Console.WriteLine("Sent message #2");
	  });
	Task.WaitAll(send1, send2);
	Console.WriteLine("All messages sent");
	```

	Вот пример асинхронной операции получения:
	
	```
	Task receive1 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
	Task receive2 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
	
	Task.WaitAll(receive1, receive2);
	Console.WriteLine("All messages received");
	
	async void ProcessReceivedMessage(Task<BrokeredMessage> t)
	{
	  BrokeredMessage m = t.Result;
	  Console.WriteLine("{0} received", m.Label);
	  await m.CompleteAsync();
	  Console.WriteLine("{0} complete", m.Label);
	}
	```

-   **Несколько фабрик**. Все клиенты (отправители и получатели), созданные одной фабрикой, используют одно TCP-подключение. Максимальная пропускная способность для сообщений ограничена числом операций, проходящих через это TCP-подключение. Пропускная способность отдельной фабрики в значительной степени зависит от времени кругового пути TCP и размера сообщения. Чтобы увеличить пропускную способность, следует использовать несколько фабрик обмена сообщениями.

## Режим получения

При создании клиента очереди или подписки вы можете выбрать режим получения — *блокировка для просмотра* или *получение и удаление*. По умолчанию используется режим [блокировки для просмотра][]. В этом режиме клиент отправляет запрос на получение сообщения из служебной шины. После получения сообщения клиент отправляет запрос на завершение сообщения.

Если установить режим [получения и удаления][], оба этих действия объединяются в один запрос. В результате уменьшается общее количество операций, что может повысить общую пропускную способность для сообщений. Однако такое повышение производительности сопряжено с риском потери сообщений.

Служебная шина не поддерживает транзакции для операций получения и удаления. Кроме того, иногда требуется семантика блокировки для просмотра (например, если клиенту необходимо отложить сообщение или [пометить его как недоставленное](service-bus-dead-letter-queues.md)).

## Пакетная обработка на стороне клиента

Пакетная обработка на стороне клиента позволяет клиенту очереди или раздела задержать отправку сообщения на определенный период времени. Если в течение этого времени клиент будет отправлять дополнительные сообщения, они будут переданы в одном пакете. Пакетная обработка на стороне клиента очереди или подписки также позволяет объединить несколько запросов типа **Завершение** в один. Пакетная обработка возможна только для асинхронных операций **отправки** и **завершения**. Синхронные операции отправляются в службу служебной шины незамедлительно. Пакетная обработка недоступна для операций просмотра или получения. Также пакетную обработку нельзя использовать для объединения операций нескольких клиентов.

Если размер пакета превышает максимальный размер сообщения, из него удаляется последнее сообщение и клиент немедленно отправляет пакет. Последнее сообщение становится первым сообщением следующего пакета. По умолчанию интервал пакетной обработки в клиенте составляет 20 мс. Интервал пакетной обработки можно изменить с помощью свойства [BatchFlushInterval][], которое задается перед созданием фабрики обмена сообщениями. Этот параметр влияет на все клиенты, создаваемые этой фабрикой.

Чтобы отключить пакетную обработку, задайте для свойства [BatchFlushInterval][] значение **TimeSpan.Zero**. Например:

```
MessagingFactorySettings mfs = new MessagingFactorySettings();
mfs.TokenProvider = tokenProvider;
mfs.NetMessagingTransportSettings.BatchFlushInterval = TimeSpan.FromSeconds(0.05);
MessagingFactory messagingFactory = MessagingFactory.Create(namespaceUri, mfs);
```

Пакетная обработка не влияет на количество оплачиваемых операций обмена сообщениями и доступна только для протокола клиента служебной шины. Протокол HTTP не поддерживает пакетную обработку.

## Пакетный доступ к хранилищу

Чтобы увеличить пропускную способность очереди, раздела или подписки, служебная шина объединяет несколько сообщений в пакеты, когда записывает их в свое внутреннее хранилище. Если эта функция включена для очереди или раздела, сообщения записываются в хранилище в пакетном режиме. Если эта функция включена для очереди или подписки, сообщения будут удаляться из хранилища в пакетном режиме. Если пакетный доступ к хранилищу включен для сущности, служебная шина будет задерживать операцию записи для этой сущности на период до 20 мс. Последующие операции с хранилищем, выполняемые в течение этого периода, добавляются в пакет. Пакетный доступ к хранилищу влияет только на операции **отправки** и **завершения**. Операции получения не затрагиваются. Пакетный доступ к хранилищу является свойством сущности. Пакетная обработка применяется ко всем сущностям, для которых включен пакетный доступ к хранилищу.

При создании новой очереди, раздела или подписки пакетный доступ к хранилищу включен по умолчанию. Чтобы отключить пакетный доступ к хранилищу, задайте для свойства [EnableBatchedOperations][] значение **false** перед созданием сущности. Например:

```
QueueDescription qd = new QueueDescription();
qd.EnableBatchedOperations = false;
Queue q = namespaceManager.CreateQueue(qd);
```

Пакетный доступ к хранилищу не влияет на количество оплачиваемых операций обмена сообщениями и является свойством очереди, раздела или подписки. Он не зависит от режима получения и протокола, используемого для подключения между клиентом и службой служебной шины.

## Предварительная выборка

Предварительная выборка позволяет клиенту очереди или подписки загружать дополнительные сообщения из службы при выполнении операции получения. Клиент сохраняет эти сообщения в локальном кэше. Размер кэша определяется свойствами [QueueClient.PrefetchCount][] и [SubscriptionClient.PrefetchCount][]. В каждом клиенте с включенной предварительной выборкой создается собственный кэш. Кэш не может использоваться одновременно несколькими клиентами. Если клиент инициирует операцию получения и его кэш пуст, служба передает пакет сообщений. Размер пакета равен размеру кэша или 256 КБ (в зависимости от того, какое значение меньше). Если клиент инициирует операцию получения и в кэше имеется сообщение, это сообщение извлекается из кэша.

При использовании предварительной выборки сообщений служба блокирует выбранное сообщение. В результате это сообщение не может быть получено другим получателем. Если получатель не может завершить сообщение до истечения периода блокировки, сообщение станет доступным другим получателям. Копия предварительно выбранного сообщения остается в кэше. Если получатель обратится к кэшированной копии, срок действия которой истек, то при попытке завершить это сообщение будет создано исключение. По умолчанию период блокировки сообщения составляет 60 секунд. Это значение можно увеличить до 5 минут. Во избежание использования сообщений с истекшим сроком действия размер кэша всегда должен быть меньше, чем количество сообщений, которые могут быть использованы клиентом в течение периода блокировки.

Если не менять стандартный период блокировки (60 секунд), то для свойства [SubscriptionClient.PrefetchCount][] рекомендуется установить значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Например, фабрика создает трех получателей, каждый из которых может обработать до 10 сообщений в секунду. Количество объектов предварительной выборки не должно превышать 20*3*10 = 600. По умолчанию свойство [QueueClient.PrefetchCount][] имеет значение 0. Это означает, что предварительная выборка сообщений из службы отключена.

Предварительная выборка сообщений увеличивает совокупную пропускную способность очереди или подписки, так как уменьшает общее количество операций с сообщениями (так называемых круговых путей). Тем не менее предварительная выборка первого сообщения займет больше времени (из-за увеличенного размера сообщения). Получение предварительно выбранных сообщений будет выполняться быстрее, так как эти сообщения уже загружены клиентом.

Свойство срока жизни сообщения проверяется сервером в момент отправки сообщения клиенту. При получении сообщения клиент не проверяет свойство срока жизни сообщения. Сообщение может быть получено клиентом во время кэширования, даже если срок жизни сообщения истек.

Предварительная выборка не влияет на количество оплачиваемых операций обмена сообщениями и доступна только для протокола клиента служебной шины. Протокол HTTP не поддерживает предварительную выборку. Предварительная выборка доступна как для синхронных, так и для асинхронных операций получения.

## Экспресс-очереди и экспресс-разделы

Экспресс-сущности обеспечивают высокую пропускную способность и уменьшают частоту задержек. Если сообщение отправляется в очередь или раздел, оно не помещается сразу же в хранилище сообщений. Вместо этого оно сохраняется в кэше, расположенном в памяти. Если сообщение остается в очереди больше нескольких секунд, оно автоматически записывается в постоянное хранилище. Это делается для защиты от потери данных в случае сбоя. Запись сообщения в кэш памяти повышает пропускную способность и сокращает задержки, так как в этом случае во время отправки сообщения исключается доступ к постоянному хранилищу. Сообщения, обработанные в течение нескольких секунд, не записываются в хранилище обмена сообщениями. В следующем примере создается экспресс-раздел.

```
TopicDescription td = new TopicDescription(TopicName);
td.EnableExpress = true;
namespaceManager.CreateTopic(td);
```

Если в экспресс-сущность отправляется сообщение с критически важной информацией, которая не должна быть потеряна, отправитель может дать команду служебной шине принудительно записать сообщение в постоянное хранилище. Для этого свойству [ForcePersistence][] задается значение **true**.

## Использование секционированных очередей или разделов

Для обработки и хранения всех сообщений для сущности сообщений (очереди или раздела) внутри служебной шины используется один узел и хранилище обмена сообщениями. С другой стороны, секционирование очередей или разделов позволяет распределять их между несколькими узлами и хранилищами обмена сообщениями. Секционированные очереди и разделы не только повышают пропускную способность в сравнении с обычными очередями и разделами, но также обеспечивают высочайший уровень доступности. Чтобы создать секционированную сущность, задайте свойству [EnablePartitioning][] значение **true**, как показано в следующем примере. Дополнительные сведения о секционированных сущностях см. в статье [Секционированные сущности обмена сообщениями][].

```
// Create partitioned queue.
QueueDescription qd = new QueueDescription(QueueName);
qd.EnablePartitioning = true;
namespaceManager.CreateQueue(qd);
```

## Использование нескольких очередей

Если использование секционированной очереди или раздела невозможно либо ожидаемую нагрузку невозможно будет обработать с помощью одной секционированной очереди или раздела, необходимо использовать несколько сущностей обмена сообщениями. При использовании нескольких сущностей создайте выделенный клиент для каждой сущности. Не используйте один клиент для всех сущностей.

## Сценарии

Далее описываются стандартные сценарии обмена сообщениями и приводятся рекомендации по настройкам служебной шины. Пропускная способность бывает небольшой (менее 1 сообщения в секунду), средней (1 сообщение в секунду или больше, но не более 100 сообщений в секунду) и высокой (100 сообщений в секунду или больше). Количество клиентов бывает небольшим (5 и меньше), средним (более 5, но не более 20) и большим (более 20).

### Очередь с высокой пропускной способностью

Цель: максимально повысить пропускную способность одной очереди. Количество отправителей и получателей: небольшое.

-   Используйте секционированную очередь для повышения производительности и доступности.

-   Чтобы увеличить общую скорость отправки сообщений в очередь, используйте несколько фабрик обмена сообщениями для создания отправителей. Для каждого отправителя используйте асинхронные операции или разделение на потоки.

-   Чтобы увеличить общую скорость получения сообщений из очереди, используйте несколько фабрик обмена сообщениями для создания получателей.

-   Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.

-   Установите интервал пакетной обработки на 50 мс, чтобы уменьшить число передач по протоколу клиента служебной шины. Если используется несколько отправителей, увеличьте интервал пакетной обработки до 100 мс.

-   Не отключайте пакетный доступ к хранилищу. Это повысит общую скорость записи сообщений в очередь.

-   Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Это снизит число передач по протоколу клиента служебной шины.

### Несколько очередей с высокой пропускной способностью

Цель: максимально повысить общую пропускную способность нескольких очередей. Пропускная способность одной очереди: средняя или высокая.

Чтобы максимально повысить пропускную способность нескольких очередей, примените настройки, максимально повышающие пропускную способность одной очереди. Кроме того, используйте несколько фабрик для создания клиентов, которые отправляют или получают сообщения из разных очередей.

### Очередь с небольшой задержкой

Цель: минимизировать общее время задержки в очереди или разделе. Количество отправителей и получателей: небольшое. Пропускная способность очереди: низкая или средняя.

-   Используйте секционированную очередь для повышения доступности.

-   Отключите пакетную обработку на стороне клиента. Клиент будет немедленно отправлять сообщения.

-   Отключите пакетный доступ к хранилищу. Служба будет немедленно записывать сообщения в хранилище.

-   При использовании одного клиента измените количество элементов предварительной выборки на значение, в 20 раз превышающее скорость обработки получателя. Если в очередь одновременно поступает несколько сообщений, протокол клиента служебной шины передаст их все одновременно. Когда клиент получит следующее сообщение, оно уже будет в локальном кэше. Размер кэша должен быть небольшим.

-   При использовании нескольких клиентов установите количество элементов предварительной выборки на 0. В результате второй клиент сможет получить второе сообщение, пока первый клиент будет обрабатывать первое сообщение.

### Очередь с большим числом отправителей

Цель: максимально повысить пропускную способность очереди или раздела с большим числом отправителей. Каждый отправитель отправляет сообщения со средней скоростью. Количество получателей: небольшое.

В служебной шине можно открыть до 1000 параллельных подключений к сущности обмена сообщениями (или до 5000 при использовании протокола AMQP). Это ограничение установлено на уровне пространства имен. Очереди, разделы и подписки ограничены максимальным числом параллельных подключений для соответствующего пространства имен. В случае очередей это значение распределяется между отправителями и получателями. Если отправителям требуются все 1000 подключений, то вам следует заменить очередь на раздел и одну подписку. Раздел допускает до 1000 параллельных подключений от отправителей, тогда как подписка допускает 1000 дополнительных параллельных подключений от получателей. Если количество параллельных отправителей превышает 1000, то они должны отправлять сообщения на протокол служебной шины по протоколу HTTP.

Чтобы максимально повысить пропускную способность, выполните следующие действия.

-   Используйте секционированную очередь для повышения производительности и доступности.

-   Если каждый отправитель размещается в отдельном процессе, используйте одну фабрику для этого процесса.

-   Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.

-   Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.

-   Не отключайте пакетный доступ к хранилищу. Это повысит общую скорость записи сообщений в очередь или раздел.

-   Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Это снизит число передач по протоколу клиента служебной шины.

### Очередь с большим числом получателей

Цель: максимально повысить скорость получения в очереди или подписке с большим числом получателей. Каждый получатель получает сообщения со средней скоростью. Количество отправителей: небольшое.

В служебной шине можно открыть до 1000 параллельных подключений к сущности. Если для очереди требуется более 1000 получателей, замените очередь на раздел и несколько подписок. Каждая подписка поддерживает до 1000 параллельных подключений. Кроме того, получатели могут обращаться к очереди через протокол HTTP.

Чтобы максимально повысить пропускную способность, выполните следующие действия.

-   Используйте секционированную очередь для повышения производительности и доступности.

-   Если каждый получатель размещается в отдельном процессе, используйте одну фабрику для этого процесса.

-   Получатели могут использовать синхронные и асинхронные операции. Учитывая среднюю скорость получения отдельного получателя, пакетная обработка на стороне клиента в отношении запросов на завершение не повлияет на пропускную способность получателя.

-   Не отключайте пакетный доступ к хранилищу. Это снизит общую нагрузку на сущность. Также это повысит общую скорость записи сообщений в очередь или раздел.

-   Для количества элементов предварительной выборки установите небольшое значение (например, PrefetchCount = 10). Это позволит избежать ситуации, когда одни получатели простаивают, а другие получают множество кэшированных сообщений.

### Раздел с небольшим количеством подписок

Цель: максимально повысить пропускную способность раздела с небольшим количеством подписок. Сообщение направляется нескольким подпискам. Это означает, что общая скорость получения во всех подписках будет больше, чем скорость отправки. Количество отправителей: небольшое. Количество получателей в каждой подписке: небольшое.

Чтобы максимально повысить пропускную способность, выполните следующие действия.

-   Используйте секционированный раздел для повышения производительности и доступности.

-   Чтобы увеличить общую скорость отправки сообщений в раздел, используйте несколько фабрик обмена сообщениями для создания отправителей. Для каждого отправителя используйте асинхронные операции или разделение на потоки.

-   Чтобы увеличить общую скорость получения сообщений из раздела, используйте несколько фабрик обмена сообщениями для создания получателей. Для каждого получателя используйте асинхронные операции или разделение на потоки.

-   Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.

-   Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.

-   Не отключайте пакетный доступ к хранилищу. Это повысит общую скорость записи сообщений в раздел.

-   Для количества элементов предварительной выборки установите значение, в 20 раз превышающее максимальную скорость обработки всех получателей фабрики. Это снизит число передач по протоколу клиента служебной шины.

### Раздел с большим количеством подписок

Цель: максимально повысить пропускную способность раздела с большим количеством подписок. Сообщение направляется нескольким подпискам. Это означает, что общая скорость получения во всех подписках будет значительно больше, чем скорость отправки. Количество отправителей: небольшое. Количество получателей в каждой подписке: небольшое.

Разделы с большим количеством подписок обычно обеспечивают низкую пропускную способность, если все сообщения направляются во все подписки. Это связано с тем, что получение каждого сообщения выполняется много раз, а все содержащиеся в разделе сообщения и все подписки раздела хранятся в одном хранилище. Предполагается, что количество отправителей и получателей в каждой подписке небольшое. Служебная шина поддерживает до 2000 подписок на раздел.

Чтобы максимально повысить пропускную способность, выполните следующие действия.

-   Используйте секционированный раздел для повышения производительности и доступности.

-   Используйте асинхронные операции, чтобы воспользоваться преимуществами пакетной обработки на стороне клиента.

-   Установите интервал пакетной обработки на 20 мс, чтобы уменьшить число передач по протоколу клиента служебной шины.

-   Не отключайте пакетный доступ к хранилищу. Это повысит общую скорость записи сообщений в раздел.

-   Для количества элементов предварительной выборки установите значение, в 20 раз превышающее ожидаемую скорость получения в секундах. Это снизит число передач по протоколу клиента служебной шины.

## Дальнейшие действия

Дополнительные сведения об оптимизации производительности служебной шины см. в статье [Секционированные сущности обмена сообщениями][].

  [QueueClient]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queueclient.aspx
  [MessageSender]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagesender.aspx
  [MessagingFactory]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.messagingfactory.aspx
  [блокировки для просмотра]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.receivemode.aspx
  [получения и удаления]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.receivemode.aspx
  [BatchFlushInterval]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.netmessagingtransportsettings.batchflushinterval.aspx
  [EnableBatchedOperations]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queuedescription.enablebatchedoperations.aspx
  [QueueClient.PrefetchCount]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queueclient.prefetchcount.aspx
  [SubscriptionClient.PrefetchCount]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.subscriptionclient.prefetchcount.aspx
  [ForcePersistence]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.forcepersistence.aspx
  [EnablePartitioning]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.queuedescription.enablepartitioning.aspx
  [Секционированные сущности обмена сообщениями]: service-bus-partitioning.md
  

<!---HONumber=AcomDC_0713_2016-->