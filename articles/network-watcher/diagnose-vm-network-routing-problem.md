---
title: Руководство по диагностике проблемы с маршрутизацией в сети виртуальной машины с помощью портала Azure | Документация Майкрософт
description: Из этого руководства вы узнаете, как диагностировать проблему с маршрутизацией на виртуальной машине с помощью возможности следующего прыжка в Наблюдателе за сетями Azure.
services: network-watcher
documentationcenter: network-watcher
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: I need to diagnose virtual machine (VM) network routing problem that prevents communication to different destinations.
ms.assetid: ''
ms.service: network-watcher
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: network-watcher
ms.workload: infrastructure
ms.date: 04/20/2018
ms.author: jdial
ms.custom: mvc
ms.openlocfilehash: ea64c93726c3bc5c5d60f35790bb337333d4d47a
ms.sourcegitcommit: 6e43006c88d5e1b9461e65a73b8888340077e8a2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/01/2018
ms.locfileid: "32312201"
---
# <a name="tutorial-diagnose-a-virtual-machine-network-routing-problem-using-the-azure-portal"></a>Руководство по диагностике проблемы с маршрутизацией в сети виртуальной машины с помощью портала Azure

При развертывании виртуальной машины Azure создает для нее несколько маршрутов по умолчанию. Вы можете создавать настраиваемые маршруты для переопределения маршрутов по умолчанию Azure. В некоторых случаях пользовательский маршрут может привести к тому, что виртуальная машина не сможет взаимодействовать с другими ресурсами. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Создание виртуальной машины
> * Проверка связи с URL-адресом, используя функцию следующего прыжка Наблюдателя за сетями.
> * Проверка связи с IP-адресом.
> * Диагностика проблемы с маршрутизацией и определение способа ее устранения.

При необходимости можно диагностировать проблемы с маршрутизацией в сети виртуальной машины с помощью [Azure CLI](diagnose-vm-network-routing-problem-cli.md) или [портала Azure](diagnose-vm-network-routing-problem-powershell.md).

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="create-a-vm"></a>Создание виртуальной машины

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисление**, а затем — **Windows Server 2016 Datacenter** или виртуальную машину **Ubuntu Server 17.10**.
3. Введите или выберите следующие значения, примите значения по умолчанию для остальных параметров и нажмите кнопку **ОК**:

    |Параметр|Значение|
    |---|---|
    |ИМЯ|myVm|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Выберите **Создать новую**, а затем введите **myResourceGroup**.|
    |Расположение| Выберите **Восточная часть США**.|

4. Выберите размер виртуальной машины и щелкните **Выбрать**.
5. На странице **Параметры** примите все значения по умолчанию и нажмите кнопку **ОК**.
6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины. Развертывание виртуальной машины занимает несколько минут. Дождитесь окончания развертывания виртуальной машины, прежде чем приступить к выполнению следующих шагов.

## <a name="test-network-communication"></a>Тестирование взаимодействия по сети

Чтобы проверить сетевое подключение с помощью Наблюдателя за сетями, прежде всего необходимо включить Наблюдатель за сетями хотя бы в одном регионе Azure, а затем применить в Наблюдателе за сетями функцию следующего прыжка для проверки связи.

### <a name="enable-network-watcher"></a>Включение Наблюдателя за сетями

Если в хотя бы одном регионе "Восточная часть США" уже включена служба "Наблюдатель за сетями", перейдите к разделу по [использованию следующего прыжка](#use-next-hop).

1. На портале выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах появится **Наблюдатель за сетями**, выберите его.
2. Выберите раздел **Регионы**, чтобы развернуть его, а затем щелкните **...** справа от региона **Восточная часть США**, как показано на следующем изображении:

    ![Включение Наблюдателя за сетями](./media/diagnose-vm-network-traffic-filtering-problem/enable-network-watcher.png)

3. Выберите **Включить Наблюдатель за сетями**.

### <a name="use-next-hop"></a>Использование следующего прыжка

Azure автоматически создает маршруты к пунктам назначения по умолчанию. Вы можете создать настраиваемые маршруты, которые переопределяют маршруты по умолчанию. В некоторых случаях настраиваемые маршруты могут привести к сбою связи. Используйте функцию следующего прыжка Наблюдателя за сетями для определения маршрутов Azure, которые используются для маршрутизации трафика.

1. На портале Azure в разделе **Наблюдатель за сетями** выберите **Следующий прыжок**.
2. Выберите подписку, введите или выберите следующие значения, а затем щелкните **Следующий прыжок**, как показано на рисунке ниже:

    |Параметр                  |Значение                                                   |
    |---------                |---------                                               |
    | Группа ресурсов          | Выберите myResourceGroup                                 |
    | Виртуальная машина.         | Выберите myVm                                            |
    | сетевому интерфейсу       | myvm — ваше имя сетевого интерфейса может отличаться   |
    | Исходный IP-адрес       | 10.0.0.4                                               |
    | Конечный IP-адрес  | 13.107.21.200 — один из адресов для www.bing.com |

    ![Следующий прыжок](./media/diagnose-vm-network-routing-problem/next-hop.png)

    Через несколько секунд вы получите результат, где указано, что следующий тип прыжка — **Интернет** и что **идентификатор таблицы маршрутов** такой: **Системный маршрут**. Из этого результата мы узнаем, что существует допустимый системный маршрут к назначению.

3. Измените **конечный IP-адрес** на *172.31.0.100* и снова выберите **Следующий прыжок**. Возвращенный результат сообщает, что **следующий тип прыжка** — **Нет**, а **идентификатор таблицы маршрутов** — **Системный маршрут**. Так мы узнаем, что, хотя есть допустимый системный маршрут к месту назначения, следующий прыжок для маршрутизации трафика в пункт назначения отсутствует.

## <a name="view-details-of-a-route"></a>Просмотр сведений о маршруте

1. Чтобы тщательнее проанализировать маршрутизацию, просмотрите действующие маршруты сетевого интерфейса. В поле поиска в верхней части портала введите *myvm* (или любое имя отмеченного сетевого интерфейса). Когда виртуальная машина **myvm** появится в результатах поиска, выберите ее.
2. В разделе **Поддержка и устранение неполадок** выберите **Действующие маршруты**, как показано на следующем рисунке:

    ![Действующие маршруты](./media/diagnose-vm-network-routing-problem/effective-routes.png)

    При выполнении теста с IP-адресом 13.107.21.200 в разделе [использование следующего прыжка](#use-next-hop) маршрут с префиксом 0.0.0.0/0 использовался для маршрутизации трафика на адрес, так как другие маршруты не включали адрес. По умолчанию все адреса, не указанные в префиксе адреса другого маршрута, маршрутизируются в Интернет.

    Однако, когда вы выполняли тест с использованием IP-адреса 172.31.0.100 в возвращенном результате было указано, что следующий тип прыжка отсутствует. Как можно увидеть на предыдущем изображении, хотя есть маршрут по умолчанию к префиксу 172.16.0.0/12, который включает адрес 172.31.0.100, **тип следующего прыжка** — **Нет**. Azure создает маршрут по умолчанию 172.16.0.0/12, но не указывает тип следующего прыжка, пока для этого не возникнут основания. Если, например, добавить диапазон адресов 172.16.0.0/12 в адресное пространство виртуальной сети, Azure изменит **тип следующего прыжка** для маршрута на **Виртуальная сеть**. Затем проверка отобразит **виртуальную сеть** в качестве **типа следующего прыжка**.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы создали виртуальную машину и выполнили диагностику сетевой маршрутизации из виртуальной машины. Вы узнали, что Azure создает несколько маршрутов по умолчанию и тестирует маршрутизацию в два разные пункта назначения. Узнайте о [маршрутизации в Azure](../virtual-network/virtual-networks-udr-overview.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json) и способах [создания пользовательских маршрутов](../virtual-network/manage-route-table.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#create-a-route).

Для исходящих подключений виртуальной машины можно определить задержку, разрешенный и запрещенный сетевой трафик между виртуальной машиной и конечной точкой, а также маршрут, используемый для конечной точки, с помощью функции [устранения неполадок с подключениями](network-watcher-connectivity-portal.md) Наблюдателя за сетями. Узнайте, как можно отслеживать обмен данными между виртуальной машиной и конечной точкой, представленных IP-адресом или URL-адресом, с течением времени, используя возможность мониторинга подключения Наблюдателя за сетями.

> [!div class="nextstepaction"]
> [Мониторинг сетевых подключений с помощью службы "Наблюдатель за сетями Azure" с использованием портала Azure](connection-monitor.md)