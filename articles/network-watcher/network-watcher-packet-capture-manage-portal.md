---
title: 'Наблюдатель за сетями Azure: управление записью пакетов с помощью портала Azure | Документация Майкрософт'
description: На этой странице объясняется, как управлять функцией записи пакетов в службе наблюдения за сетями с помощью портала Azure.
services: network-watcher
documentationcenter: na
author: jimdial
manager: timlt
editor: ''
ms.assetid: 59edd945-34ad-4008-809e-ea904781d918
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/22/2017
ms.author: jdial
ms.openlocfilehash: 508b9e7eef757277d4bc0e93a26f3a63045f31e4
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32187537"
---
# <a name="manage-packet-captures-with-azure-network-watcher-using-the-portal"></a>Управление записью пакетов с помощью Наблюдателя за сетями Azure на портале Azure

> [!div class="op_single_selector"]
> - [портал Azure](network-watcher-packet-capture-manage-portal.md)
> - [PowerShell](network-watcher-packet-capture-manage-powershell.md)
> - [Интерфейс командной строки 1.0](network-watcher-packet-capture-manage-cli-nodejs.md)
> - [CLI 2.0](network-watcher-packet-capture-manage-cli.md)
> - [Azure REST API](network-watcher-packet-capture-manage-rest.md)

Возможность записи пакетов Наблюдателя за сетями позволяет создавать сеансы записи для отслеживания входящего и исходящего трафика виртуальной машины. Для сеанса записи предоставляются фильтры, которые позволяют убедиться, что записывается только требуемый трафик. Записи пакетов помогают выявить аномалии в работе сети по факту или заранее. Они также помогают выполнять сбор сетевой статистики, получать сведения о сетевых вторжениях, выполнять отладку передачи данных между клиентом и сервером и многое другое. Так как запись пакетов активируется удаленно, ее не нужно запускать вручную. К тому же она сразу выполняется на требуемой виртуальной машине, что также позволяет сэкономить ценное время.

В этой статье вы ознакомитесь с разными задачами управления, доступными в настоящее время для записи пакетов.

- [**Запуск записи пакета**](#start-a-packet-capture)
- [**Прекращение записи пакета**](#stop-a-packet-capture)
- [**Удаление записи пакета**](#delete-a-packet-capture)
- [**Скачивание записи пакета**](#download-a-packet-capture)

## <a name="before-you-begin"></a>Перед началом работы

В этой статье предполагается, что у вас есть следующие ресурсы:

- экземпляр Наблюдателя за сетями в регионе, в котором нужно создать запись пакетов;
- виртуальная машина с включенным расширением для записи пакетов.

> [!IMPORTANT]
> Для записи пакетов необходимо расширение виртуальной машины `AzureNetworkWatcherExtension`. Информацию об установке расширения для виртуальной машины Windows см. в статье [Расширение виртуальной машины агента Наблюдателя за сетями для Windows](../virtual-machines/windows/extensions-nwa.md), а для виртуальной машины Linux — в статье [Расширение виртуальной машины агента Наблюдателя за сетями для Linux](../virtual-machines/linux/extensions-nwa.md).

### <a name="packet-capture-agent-extension-through-the-portal"></a>Расширение агента для записи пакетов через портал

Чтобы установить агент виртуальной машины для записи пакетов на портале, перейдите к нужной виртуальной машине, щелкните **Расширения** > **Добавить** и найдите **агент Наблюдателя за сетями для Windows**.

![Представление агента][agent]

## <a name="packet-capture-overview"></a>Обзор записи пакетов

На [портале Azure](https://portal.azure.com) щелкните **Сети** > **Наблюдатель за сетями** > **Запись пакетов**

На странице общих сведений представлен список со всеми существующими операциями записи пакетов, независимо от их состояния.

> [!NOTE]
> Для записи пакетов требуются следующие подключения.
> * Исходящее подключение к учетной записи хранения через порт 443.
> * Входящее и исходящее подключение через адрес 169.254.169.254.
> * Входящее и исходящее подключение через адрес 168.63.129.16.

![Страница обзора записи пакетов][1]

## <a name="start-a-packet-capture"></a>Запуск записи пакета

Щелкните **Добавить** для создания записи пакетов.

Ниже перечислены свойства, которые могут быть определены для записи пакетов.

**Основные параметры**

- **Подписки**. Это значение представляет используемую подписку. В каждой подписке должен существовать экземпляр Наблюдателя за сетями.
- **Группа ресурсов**. Это группа ресурсов, в которую входит целевая виртуальная машина.
- **Целевая виртуальная машина**. Это сама виртуальная машина, на которой выполняется запись пакетов
- **Имя записи пакетов**. Это значение будет использовано как имя для записи пакетов.

**Параметры записи**

- **Путь к локальному файлу** — это локальный путь на виртуальной машине, где сохранена запись пакетов (является допустимым, только если выбран **[файл]**). Необходимо указать допустимый путь. Для виртуальной машины Linux путь должен начинаться с / var / captures.
- **Учетная запись хранения**. Определяет, нужно ли сохранять запись пакетов в учетной записи хранения.
- **Файл**. Определяет, нужно ли сохранять запись пакетов локально на виртуальной машине.
- **Учетные записи хранения**. Указывает учетную запись хранения, в которой следует сохранять запись пакетов. По умолчанию используется расположение такого вида: https://{имя_учетной_записи_хранения}.blob.core.windows.net/network-watcher-logs/subscriptions/{идентификатор_подписки}/resourcegroups/{имя_группы_ресурсов}/providers/microsoft.compute/virtualmachines/{имя_виртуальной_машины}/{ГГ}/{ММ}/{ДД}/packetcapture_{ЧЧ}_{ММ}_{ММ}_{XXX}.cap. (Этот параметр доступен, только если выбран параметр **Хранилище**.)
- **Локальный путь к файлу**. Локальный путь на виртуальной машине для сохранения записи пакетов. (Этот параметр доступен, только если выбран параметр **Файл**.) Необходимо указать допустимый путь. Для виртуальной машины Linux путь должен начинаться с */var/captures*.
- **Максимальное число байтов на пакет**. Число записываемых байтов из каждого пакета. Если поле остается пустым, записываются все байты.
- **Максимальное число байтов за сеанс**. Общее число записываемых байтов. Запись пакетов прекратится, когда будет достигнуто указанное значение.
- **Ограничение по времени (в секундах)**. Задает ограничение на время записи пакетов. По умолчанию это 18000 секунд.

> [!NOTE]
> Учетные записи хранения класса Premium сейчас не поддерживаются для сохранения записи пакетов.

**Фильтрация (необязательно)**

- **Протокол**. Протокол, по которому фильтруются пакеты для записи. Возможны такие значения: "TCP", "UDP" и "Любой".
- **Локальный IP-адрес**. Это значение фильтрует запись пакетов по указанному локальному IP-адресу.
- **Локальный порт**. Это значение фильтрует запись пакетов по указанному локальному порту.
- **Удаленный IP-адрес**. Это значение фильтрует запись пакетов по указанному удаленному IP-адресу.
- **Удаленный порт**. Это значение фильтрует запись пакетов по указанному удаленному порту.

> [!NOTE]
> Для портов и IP-адресов можно указать одно значение, диапазон значений или набор. (Например, диапазон 80-1024 для значений портов.) Можно определить любое число фильтров.

Когда вы заполните все нужные значения, щелкните **ОК** для создания записи пакетов.

![Создание записи пакетов][2]

По достижении ограничения на время записи пакетов, процесс будет остановлен и можно будет просмотреть результаты. Также сеансы записи пакетов можно останавливать вручную.

## <a name="delete-a-packet-capture"></a>Удаление записи пакета

Чтобы удалить запись пакетов, в представлении записи пакетов щелкните **контекстное меню** (...) или щелкните объект правой кнопкой мыши и выберите **Удалить**.

![Удаление записи пакета][3]

> [!NOTE]
> При удалении записи пакетов файл в учетной записи хранения не удаляется.

Вам будет предложено подтвердить удаление записи пакетов нажатием кнопки **Да**.

![Подтверждение][4]

## <a name="stop-a-packet-capture"></a>Остановка записи пакетов

Чтобы остановить запись пакетов, в представлении записи пакетов щелкните **контекстное меню** (...) или щелкните объект правой кнопкой мыши и выберите **Остановить**.

## <a name="download-a-packet-capture"></a>Скачивание записи пакета

Когда сеанс записи пакетов завершится, файл записи передается в хранилище BLOB-объектов или сохраняется в локальный файл на виртуальной машине. Место хранения записи пакетов определяется при создании сеанса. Удобное средство для доступа к этим файлам записи, сохраненным в учетной записи хранения, — обозреватель службы хранилища Microsoft Azure, который можно скачать по адресу http://storageexplorer.com/

При указании учетной записи хранения файлы записи пакетов сохраняются в ней по следующему адресу:
```
https://{storageAccountName}.blob.core.windows.net/network-watcher-logs/subscriptions/{subscriptionId}/resourcegroups/{storageAccountResourceGroup}/providers/microsoft.compute/virtualmachines/{VMName}/{year}/{month}/{day}/packetCapture_{creationTime}.cap
```

## <a name="next-steps"></a>Дополнительная информация

Дополнительные сведения об автоматизации записи пакетов с помощью оповещений на виртуальной машине см. в статье, посвященной [созданию записи пакетов, активируемой с использованием оповещений](network-watcher-alert-triggered-packet-capture.md).

Сведения о состоянии (разрешен или запрещен) входящего и исходящего трафика виртуальной машины см. в статье, посвященной [проверке потока IP-адресов](diagnose-vm-network-traffic-filtering-problem.md).

<!-- Image references -->
[1]: ./media/network-watcher-packet-capture-manage-portal/figure1.png
[2]: ./media/network-watcher-packet-capture-manage-portal/figure2.png
[3]: ./media/network-watcher-packet-capture-manage-portal/figure3.png
[4]: ./media/network-watcher-packet-capture-manage-portal/figure4.png
[agent]: ./media/network-watcher-packet-capture-manage-portal/agent.png













