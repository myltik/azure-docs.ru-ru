---
title: Руководство по диагностике проблем с обменом данными между сетями на портале Azure | Документация Майкрософт
description: Дополнительные сведения о диагностике проблем с обменом данными между виртуальной сетью Azure, подключенной к локальной или другой виртуальной сети через шлюз виртуальной сети Azure, с помощью функции диагностики VPN службы "Наблюдатель за сетями".
services: network-watcher
documentationcenter: na
author: jimdial
manager: jeconnoc
editor: ''
Customer intent: I need to determine why resources in a virtual network can't communicate with resources in a different network.
ms.service: network-watcher
ms.devlang: na
ms.topic: tutorial
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/27/2018
ms.author: jdial
ms.custom: mvc
ms.openlocfilehash: d89c5a3f2545edd7c02b67fa9d2e2b78937a9791
ms.sourcegitcommit: ca05dd10784c0651da12c4d58fb9ad40fdcd9b10
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
ms.locfileid: "32779576"
---
# <a name="tutorial-diagnose-a-communication-problem-between-networks-using-the-azure-portal"></a>Руководство по диагностике проблем с обменом данными между сетями на портале Azure

Шлюз виртуальной сети соединяет виртуальную сеть Azure с локальной или другой виртуальной сетью. Из этого руководства вы узнаете, как выполнять такие задачи:

> [!div class="checklist"]
> * Выполнение диагностики проблемы с помощью шлюза виртуальной сети с возможностью диагностики VPN службы "Наблюдатель за сетями".
> * Выполнение диагностики проблем путем подключения шлюза.
> * Устранение проблемы со шлюзом.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="prerequisites"></a>предварительным требованиям

Чтобы использовать диагностику VPN, необходимо наличие работающего VPN-шлюза. Если у вас нет VPN-шлюза для диагностики, вы можете развернуть его, используя [скрипт PowerShell](../vpn-gateway/scripts/vpn-gateway-sample-site-to-site-powershell.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json). Вы можете запустить скрипт PowerShell из:
    - **Локальной установки PowerShell**. Для выполнения этого скрипта вам понадобится модуль AzureRM PowerShell 5.7.0 или более поздней версии. Выполните командлет `Get-Module -ListAvailable AzureRM`, чтобы узнать установленную версию. Если вам необходимо выполнить обновление, ознакомьтесь со статьей, посвященной [установке Azure PowerShell](/powershell/azure/install-azurerm-ps). Если модуль PowerShell запущен локально, необходимо также выполнить командлет `Login-AzureRmAccount`, чтобы создать подключение к Azure.
    - **Azure Cloud Shell**. В [Azure Cloud Shell](https://shell.azure.com/powershell) установлена и настроена последняя версия PowerShell. Эта служба позволяет выполнить вход в Azure.

С помощью этого скрипта VPN-шлюз можно создать приблизительно за час. В последующих шагах предполагается, что диагностика выполняется для шлюза, развернутого с помощью этого скрипта. Если вместо этого выполнить диагностику для имеющегося шлюза, результаты будут отличаться.

## <a name="sign-in-to-azure"></a>Вход в Azure

Войдите на [портале Azure](https://portal.azure.com).

## <a name="enable-network-watcher"></a>Включение Наблюдателя за сетями

Если в регионе "Восточная часть США" уже включена служба "Наблюдатель за сетями", перейдите к разделу о [диагностике шлюза](#diagnose-a-gateway).

1. На портале выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах появится **Наблюдатель за сетями**, выберите его.
2. Выберите раздел **Регионы**, чтобы развернуть его, а затем щелкните **...** справа от региона **Восточная часть США**, как показано на следующем изображении:

    ![Включение Наблюдателя за сетями](./media/diagnose-communication-problem-between-networks/enable-network-watcher.png)

3. Выберите **Включить Наблюдатель за сетями**.

## <a name="diagnose-a-gateway"></a>Диагностика шлюза

1. В левой области портала выберите **Все службы**.
2. Начните вводить *наблюдатель за сетями* в поле **Фильтр**. Когда в результатах поиска появится **Наблюдатель за сетями**, выберите его.
3. В разделе **Средства диагностики сети** выберите **Диагностика VPN**.
4. Щелкните **Учетная запись хранения**, а затем выберите учетную запись хранения, в которую необходимо записывать диагностические данные.
5. В списке **учетных записей хранения** выберите учетную запись хранения, которую необходимо использовать. При отсутствии имеющейся учетной записи хранения выберите **+ Storage account** (+ Учетная запись хранения), введите или выберите необходимые данные, а затем щелкните **Создать**, чтобы создать ее. Если VPN-шлюз создан с помощью скрипта, указанного в разделе [предварительных требований](#prerequisites), вам может понадобиться создать учетную запись хранения в той же группе ресурсов (*TestRG1*), что и шлюз.
6. В списке **Контейнеры** выберите контейнер, который вы хотите использовать, а затем щелкните **Выбрать**. Если у вас нет контейнера, щелкните **+ Container** (+ Контейнер), введите имя контейнера, а затем выберите **ОК**.
7. Выберите шлюз, а затем щелкните **Начать устранение неполадок**. Как показано на следующем изображении, тест выполняется для шлюза с именем **Vnet1GW**.

    ![Диагностика VPN](./media/diagnose-communication-problem-between-networks/vpn-diagnostics.png)

8. Во время выполнения теста отображается состояние **Выполняется** в столбце **Состояние устранения неполадок** (где на предыдущем изображении отображалось состояние **Не запущено**). Выполнение этого теста может занять несколько минут.
9. Просмотрите состояние завершенного теста. На следующем изображении показаны результаты состояния завершенного теста диагностики.

    ![Status](./media/diagnose-communication-problem-between-networks/status.png)

    На изображении видно, что в столбце **Состояние устранения неполадок** отображается значение **Неработоспособно**, а также **сводка** и **сведения** о проблеме на вкладке **Status** (Состояние).
10. Если перейти на вкладку **Действие**, диагностика VPN предоставит дополнительные сведения. В примере, показанном на следующем изображении, из VPN-диагностики можно понять, что следует проверить работоспособность каждого подключения.

  ![Действие](./media/diagnose-communication-problem-between-networks/action.png)

## <a name="diagnose-a-gateway-connection"></a>Диагностика подключения шлюза

Шлюз подключен к другим сетям через подключение шлюза. Для успешного обмена данными между виртуальной и подключенной сетями шлюз и подключения шлюза должны быть работоспособными.

1. Выполите шаг 7 из раздела о [диагностике шлюза](#diagnose-a-gateway) еще раз. На этот раз выберите подключение. В следующем примере тестируется подключение с именем **VNet1toSite1**.

    ![Подключение](./media/diagnose-communication-problem-between-networks/connection.png)

    Выполнение теста занимает несколько минут.
2. После завершения тестирования подключения появляются результаты, аналогичные результатам, показанным на следующих изображениях вкладок **Состояние** и **Действие**.

    ![Состояние подключения](./media/diagnose-communication-problem-between-networks/connection-status.png)

    ![Действие подключения](./media/diagnose-communication-problem-between-networks/connection-action.png)

    С помощью диагностики VPN можно узнать об ошибке на вкладке **Состояние**, а также несколько возможных причин возникновения ошибки (на вкладке **Действие**).

    Если для тестирования использовался шлюз, развернутый с помощью [скрипта](../vpn-gateway/scripts/vpn-gateway-sample-site-to-site-powershell.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json) из раздела [предварительных требований](#prerequisites), то проблему на вкладке **Состояние** можно решить, используя первые два варианта на вкладке **Действия**. Этот скрипт настраивает IP-адрес заполнителя 23.99.221.164 для устройства локального шлюза VPN.

    Чтобы устранить эту проблему, необходимо удостовериться в том, что локальный шлюз VPN [настроен должным образом](../vpn-gateway/vpn-gateway-about-vpn-devices.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json), и изменить IP-адрес, настроенный с помощью скрипта для локального сетевого шлюза, на фактический общедоступный адрес локального шлюза VPN.

## <a name="clean-up-resources"></a>Очистка ресурсов

Если вы создали VPN-шлюз, используя скрипт из раздела [предварительных требований](#prerequisites), исключительно для выполнения заданий данного руководства и он больше не нужен, удалите группу ресурсов и все содержащиеся в ней ресурсы.

1. В поле **Поиск** в верхней части портала введите *TestRG1*. Выберите **TestRG1** в результатах поиска.
2. Выберите **Удалить группу ресурсов**.
3. Введите *TestRG1* в поле **Введите имя группы ресурсов:** и щелкните **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить диагностику проблемы с помощью шлюза виртуальной сети. Вы можете сделать запись о сетевом обмене данными с виртуальной машиной, чтобы иметь возможность проверить журнал на наличие аномалий. Чтобы узнать, как сделать это, перейдите к изучению следующего руководства.

> [!div class="nextstepaction"]
> [Запись сетевого входящего и исходящего трафика виртуальной машины в журнал](network-watcher-nsg-flow-logging-portal.md)