---
title: Краткое руководство. Диагностика проблемы с фильтром сетевого трафика на виртуальной машине с помощью портала Azure | Документация Майкрософт
description: В этом кратком руководстве вы узнаете, как диагностировать проблему с фильтром трафика на виртуальной машине с помощью функции проверки IP-потока в Наблюдателе за сетями Azure.
services: network-watcher
documentationcenter: network-watcher
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
Customer intent: I need to diagnose a virtual machine (VM) network traffic filter problem that prevents communication to and from a VM.
ms.assetid: ''
ms.service: network-watcher
ms.devlang: na
ms.topic: quickstart
ms.tgt_pltfrm: network-watcher
ms.workload: infrastructure
ms.date: 04/20/2018
ms.author: jdial
ms.custom: mvc
ms.openlocfilehash: 1802df4e6cbe77b4bc7ee2ee49f24d8dc51de015
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32180527"
---
# <a name="quickstart-diagnose-a-virtual-machine-network-traffic-filter-problem-using-the-azure-portal"></a>Краткое руководство. Диагностика проблемы с фильтром трафика на виртуальной машине с помощью портала Azure

С помощью этого краткого руководства вы развернете виртуальную машину (VM) и проверите доступ к IP-адресу и URL-адресу, а также доступ с IP-адреса. Затем вы определите причину проблемы с подключением и найдете способ ее устранения.

Если у вас еще нет подписки Azure, [создайте бесплатную учетную запись Azure](https://azure.microsoft.com/free/?WT.mc_id=A261C142F), прежде чем начинать работу.

## <a name="log-in-to-azure"></a>Вход в Azure

Войдите на портал Azure по адресу https://portal.azure.com.

## <a name="create-a-vm"></a>Создание виртуальной машины

1. Выберите **+ Создать ресурс** в верхнем левом углу окна портала Azure.
2. Выберите **Вычисление**, а затем — **Windows Server 2016 Datacenter** или виртуальную машину **Ubuntu Server 17.10**.
3. Введите или выберите следующие значения, примите значения по умолчанию для остальных параметров и нажмите кнопку **ОК**:

    |Параметр|Значение|
    |---|---|
    |ИМЯ|myVm|
    |Имя пользователя| Введите выбранное имя пользователя.|
    |Пароль| Введите выбранный пароль. Пароль должен включать минимум 12 символов и соответствовать [определенным требованиям к сложности](../virtual-machines/windows/faq.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm).|
    |Подписка| Выберите свою подписку.|
    |Группа ресурсов| Выберите **Создать новую**, а затем введите **myResourceGroup**.|
    |Расположение| Выберите **Восточная часть США**.|

4. Выберите размер виртуальной машины и щелкните **Выбрать**.
5. На странице **Параметры** примите все значения по умолчанию и нажмите кнопку **ОК**.
6. В разделе **создания** на странице **Сводка** выберите **Создать**, чтобы начать развертывание виртуальной машины. Развертывание виртуальной машины занимает несколько минут. Дождитесь окончания развертывания виртуальной машины, прежде чем приступить к выполнению следующих шагов.

## <a name="test-network-communication"></a>Тестирование взаимодействия по сети

Чтобы проверить сетевое подключение с помощью Наблюдателя за сетями, прежде всего необходимо включить Наблюдатель за сетями хотя бы в одном регионе Azure, а затем применить в Наблюдателе за сетями функцию проверки IP-потока.

### <a name="enable-network-watcher"></a>Включение Наблюдателя за сетями

Если в хотя бы одном регионе "Восточная часть США" уже включена служба "Наблюдатель за сетями", перейдите к разделу по [проверке IP-потока](#use-ip-flow-verify).

1. На портале выберите **Все службы**. В текстовом поле **Фильтр** введите *Наблюдатель за сетями*. Когда в результатах появится **Наблюдатель за сетями**, выберите его.
2. Включите "Наблюдатель за сетями" в регионе "Восточная часть США", так как это регион, куда была развернута виртуальная машина на предыдущем шаге. Выберите раздел **Регионы**, чтобы развернуть его, а затем щелкните **...** справа от региона **Восточная часть США**, как показано на следующем изображении:

    ![Включение Наблюдателя за сетями](./media/diagnose-vm-network-traffic-filtering-problem/enable-network-watcher.png)

3. Выберите **Включить Наблюдатель за сетями**.

### <a name="use-ip-flow-verify"></a>Применение проверки IP-потока

При создании виртуальной машины Azure применяет к ней стандартные правила разрешений и запретов трафика. Вы можете позже переопределить эти значения по умолчанию, чтобы разрешить или запретить дополнительные типы трафика.

1. На портале выберите **Все службы**. В поле *Фильтр* раздела **Все службы** введите *Наблюдатель за сетями*. Когда в результатах появится **Наблюдатель за сетями**, выберите его.
2. В разделе **Средства диагностики сети** выберите **Проверка IP-потока**.
3. Выберите подписку, введите или выберите следующие значения и щелкните **Проверка**, как показано на изображении ниже:

    |Параметр            |Значение                                                                                              |
    |---------          |---------                                                                                          |
    | Группа ресурсов    | Выберите myResourceGroup                                                                            |
    | Виртуальная машина.   | Выберите myVm                                                                                       |
    | сетевому интерфейсу | myvm — имя сетевого интерфейса, созданного на портале при создании виртуальной машины отличается |
    | Протокол          | TCP                                                                                               |
    | Направление         | Исходящие                                                                                          |
    | Локальный IP-адрес  | 10.0.0.4                                                                                          |
    | Локальный порт      | 60 000                                                                                                |
    | Удаленный IP-адрес | 13.107.21.200 — один из адресов для www.bing.com                                             |
    | Удаленный порт       | 80                                                                                                |

    ![Проверка IP-потока](./media/diagnose-vm-network-traffic-filtering-problem/ip-flow-verify-outbound.png)

    Через несколько секунд вы получите результат, извещающий о том, что такой доступ разрешается правилом безопасности с именем **AllowInternetOutbound**. При выполнении проверки Наблюдатель за сетями автоматически создается в регионе "Восточная часть США", если существующий Наблюдатель за сетями был расположен в другом регионе до запуска проверки.
4. Выполните шаг 3 еще раз, но измените значение **удаленного IP-адреса** на **172.31.0.100**. Вернется результат со сведениями о том, что такой доступ запрещается правилом безопасности с именем **DefaultOutboundDenyAll**.
5. Выполните шаг 3 еще раз, но укажите для **направления** значение **Входящие**, **локальный порт** **80** и **удаленный порт** **60000**. Вернется результат со сведениями о том, что такой доступ запрещается правилом безопасности с именем **DefaultInboundDenyAll**.

Теперь вы знаете, какие правила безопасности разрешают или запрещают трафик к виртуальной машине или от нее. Это поможет вам решить проблему.

## <a name="view-details-of-a-security-rule"></a>Просмотр сведений о правиле безопасности

1. Чтобы определить, почему правила в шагах 3–5 раздела [Применение проверки IP-потока](#use-ip-flow-verify) разрешают или запрещают обмен данными, проверьте действующие правила безопасности для сетевого интерфейса виртуальной машины. В поле поиска в верхней части портала введите *myvm*. Когда сетевой интерфейс с именем **myvm** (или другим именем) появится в результатах поиска, выберите его.
2. В разделе **Поддержка и устранение неполадок** выберите **Действующие правила безопасности**, как показано на следующем изображении:

    ![Действующие правила безопасности](./media/diagnose-vm-network-traffic-filtering-problem/effective-security-rules.png)

    На шаге 3 в разделе [применения проверки IP-потока](#use-ip-flow-verify) вы узнали, что причиной разрешения обмена данными является правило **AllowInternetOutbound**. На предыдущем изображении можно увидеть, что **назначение** для правила — **Интернет**. Не совсем ясно, почему примененный на шаге 3 в разделе [применения проверки IP-потока](#use-ip-flow-verify) адрес 13.107.21.200 относится к категории **Интернет**.
3. Выберите правило **AllowInternetOutBound**, а затем выберите **Назначение**, как показано на следующем изображении:

    ![Префиксы правила безопасности](./media/diagnose-vm-network-traffic-filtering-problem/security-rule-prefixes.png)

    Один из этих префиксов имеет значение **12.0.0.0/6**, которое охватывает диапазон IP-адресов с 12.0.0.1 по 15.255.255.254. Так как 13.107.21.200 попадает в этот диапазон адресов, правило **AllowInternetOutBound** разрешает исходящий трафик. Кроме того, на изображении в шаге 2 не существует правил с более высоким приоритетом (чем меньше это число, тем выше приоритет), которые переопределяют указанное выше правило. Закройте поле **Префиксы адресов**. Чтобы запретить исходящий трафик по адресу 13.107.21.200, вы можете добавить правило безопасности с более высоким приоритетом, которое запрещает исходящие подключения по этому IP-адресу через порт 80.
4. При выполнении проверки исходящих данных на адрес 172.131.0.100 на шаге 4 раздела [Применение проверки IP-потока](#use-ip-flow-verify) вы узнали, что правило **DefaultOutboundDenyAll** запрещает обмен данными. Это правило соответствует правилу **DenyAllOutBound**, показанному на изображении на шаге 2, где для **Назначения** указано **0.0.0.0/0**. Это правило запрещает исходящие подключения на адрес 172.131.0.100, так как он не входит в диапазон **назначения** любого из **правил для исходящего трафика**,показанных на изображении. Чтобы разрешить исходящий трафик, вы можете добавить правило безопасности с более высоким приоритетом, которое разрешает исходящие соединения для IP-адреса 172.131.0.100 по порту 80.
5. При запуске проверки входящего трафика с адреса 172.131.0.100 на шаге 5 раздела [Применение проверки IP-потока](#use-ip-flow-verify) вы узнали, что правило **DefaultInboundDenyAll** запрещает обмен данными. Это правило соответствует правилу **DenyAllInBound**, показанному на изображении в шаге 2. Правило **DenyAllInBound** применяется принудительно, так как отсутствуют другие правила с высоким приоритетом, разрешающие входящий трафик на виртуальную машину по порту 80 с адреса 172.31.0.100. Чтобы разрешить входящий трафик, вы можете добавить правило безопасности с более высоким приоритетом, которое разрешает входящий трафик на порт 80 с адреса 172.31.0.100.

Проверки в этом кратком руководстве предназначены для тестирования конфигурации Azure. Если все эти проверки возвращают ожидаемые результаты, но сетевые проблемы по-прежнему существуют, проверьте отсутствие брандмауэра между этой виртуальной машиной и конечной точкой, с которой вы взаимодействуете, а также отсутствие брандмауэра, разрешающего или запрещающего обмен данными, в операционной системе самой виртуальной машины.

## <a name="clean-up-resources"></a>Очистка ресурсов

Удалите группу ресурсов и все содержащиеся в ней ресурсы, когда она станет не нужна.

1. В поле **Поиск** в верхней части портала введите *myResourceGroup*. Когда группа ресурсов **myResourceGroup** появится в результатах поиска, выберите ее.
2. Выберите **Удалить группу ресурсов**.
3. Введите *myResourceGroup* в поле **TYPE THE RESOURCE GROUP NAME:** (Введите имя группы ресурсов:) и нажмите кнопку **Удалить**.

## <a name="next-steps"></a>Дополнительная информация

В этом кратком руководстве вы создали виртуальную машину и проверили работу фильтров входящего и исходящего трафика. Вы узнали, что правила групп безопасности сети могут разрешать или запрещать исходящий и входящий трафик виртуальной машины. Изучите дополнительные сведения о [правилах безопасности](../virtual-network/security-overview.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json) и [создании правил безопасности](../virtual-network/manage-network-security-group.md?toc=%2fazure%2fnetwork-watcher%2ftoc.json#create-a-security-rule).

Даже при правильной настройке фильтров трафика обмен данными с виртуальной машиной может завершиться сбоем из-за настроек маршрутизации. Сведения о диагностике проблем с маршрутизацией в сети виртуальной машины вы найдете в [этой статье](diagnose-vm-network-routing-problem.md). Единое средство для диагностики проблем с исходящей маршрутизацией, задержками и фильтрацией описано в статье [об устранении неполадок с подключением](network-watcher-connectivity-portal.md).