---
title: Шлюз управления данными для фабрики данных | Документация Майкрософт
description: Настройка шлюза данных для перемещения данных между локальными узлами и облаком. Используйте шлюз управления данными в фабрике данных Azure для перемещения данных.
services: data-factory
documentationcenter: ''
author: nabhishek
manager: craigg
ms.assetid: b9084537-2e1c-4e96-b5bc-0e2044388ffd
ms.service: data-factory
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/10/2018
ms.author: abnarain
robots: noindex
ms.openlocfilehash: 07d720db85a152f08cfeb278b91cce3b10d73800
ms.sourcegitcommit: 59914a06e1f337399e4db3c6f3bc15c573079832
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2018
---
# <a name="data-management-gateway"></a>Шлюз управления данными
> [!NOTE]
> Статья относится к версии 1 фабрики данных, которая является общедоступной версией. Если вы используете версию 2 службы фабрики данных, которая находится на этапе предварительной версии, прочитайте статью о [локальной среде выполнения интеграции в версии 2](../create-self-hosted-integration-runtime.md). 

> [!NOTE]
> Шлюз управления данными теперь называется локальной средой выполнения интеграции.  

Шлюз управления данными — это агент клиента, который необходимо установить в локальной среде, чтобы обеспечить копирование данных между облачными и локальными хранилищами данных. Перечень локальных хранилищ данных, поддерживаемых фабрикой данных, приведен в разделе [Поддерживаемые хранилища данных и форматы](data-factory-data-movement-activities.md#supported-data-stores-and-formats) .

Эта статья дополняет пошаговое руководство, приведенное в статье [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md) . В руководстве создается конвейер, который использует шлюз для перемещения данных из локальной базы данных SQL Server в большой двоичный объект Azure. В этой статье содержатся подробные сведения об использовании шлюза управления данными. 

Шлюз управления данными можно развернуть, сопоставив с ним несколько локальных компьютеров. Чтобы увеличить масштаб, увеличьте число заданий перемещения данных, которые могут выполняться одновременно на узле. Эта функция также доступна для логического шлюза с одним узлом. Дополнительные сведения см. в статье [Шлюз управления данными: высокий уровень доступности и масштабируемость (предварительная версия)](data-factory-data-management-gateway-high-availability-scalability.md).

> [!NOTE]
> В настоящее время шлюз поддерживает действия копирования и действие хранимой процедуры только в фабрике данных. Невозможно использовать шлюз из настраиваемого действия для доступа к локальным источникам данных.      

## <a name="overview"></a>Обзор
### <a name="capabilities-of-data-management-gateway"></a>Возможности шлюза управления данными
Шлюз управления данными предоставляет следующие возможности.

* Моделирование источников локальных и облачных данных в пределах одной фабрики данных, а также перемещение данных.
* Использование единой панели для мониторинга и управления с возможностью контроля состояния шлюза на странице фабрики данных.
* Безопасное управление доступом к локальным источникам данных.
  * Изменять настройки корпоративного брандмауэра не требуется. Шлюз только пропускает исходящие HTTP-соединения во внешнюю сеть.
  * Учетные данные для ваших локальных хранилищ данных можно шифровать с помощью личного сертификата.
* Эффективное перемещение данных: данные передаются параллельно, благодаря логике автоматического повторения перемещение не зависит от временных сетевых проблем.

### <a name="command-flow-and-data-flow"></a>Поток команд и поток данных
Если для копирования локальных данных в облако либо для передачи данных из облака обратно в локальное хранилище используется действие копирования, то в таких операциях участвует шлюз данных.

Ниже показана обобщенная схема потока данных и этапы копирования через шлюз. ![Поток данных при использовании шлюза](./media/data-factory-data-management-gateway/data-flow-using-gateway.png)

1. Разработчик создает шлюз для фабрики данных Azure, используя [портал Azure](https://portal.azure.com) или [командлет PowerShell](https://msdn.microsoft.com/library/dn820234.aspx).
2. Разработчик создает связанную службу для локального хранилища данных, указывая шлюз. В ходе настройки связанной службы разработчик указывает типы аутентификации и учетные данные в приложении настройки учетных данных.  Приложение настройки учетных данных проверяет подключение к хранилищу данных и шлюзу и сохраняет учетные данные.
3. Перед сохранением учетных данных в облаке шлюз шифрует их при помощи связанного с ним сертификата (указывается разработчиком).
4. Служба фабрики данных взаимодействует со шлюзом, планируя задания и управляя ими через специальный канал. Этот канал управления использует общую очередь служебной шины Azure. Когда нужно начать задание копирования, фабрика данных добавляет в очередь запрос с указанием учетных данных. После опроса очереди шлюз начинает задание.
5. Шлюз расшифровывает учетные данные с помощью того же сертификата, после чего подключается к локальному хранилищу данных, используя соответствующий тип аутентификации и учетные данные.
6. Шлюз копирует данные из локального хранилища в облачное или из облачного обратно в локальное в зависимости от настроек действия копирования в конвейере данных. На этом этапе шлюз напрямую взаимодействует с облачными службами хранилища, такими как хранилище BLOB-объектов Azure, через защищенный канал (HTTPS).

### <a name="considerations-for-using-gateway"></a>Рекомендации по использованию шлюза
* Для нескольких локальных источников данных можно использовать один шлюз управления данными. Однако **каждый экземпляр шлюза связан только с одной фабрикой данных Azure** и не может использоваться совместно с другой.
* На компьютере может быть установлен **только один экземпляр шлюза управления данными**. Предположим, у вас есть две фабрики данных, которым необходимо получить доступ к локальным источникам данных. В этом случае вам необходимо установить шлюзы на двух локальных компьютерах. Другими словами, каждый шлюз связан с отдельной фабрикой данных.
* **Шлюз не обязательно устанавливать на том же компьютере, что и источник данных**. Но, если он расположен вблизи источника данных, это сокращает количество времени, требуемого для подключения шлюза к этому источнику. Рекомендуется установить шлюз на компьютере, отличном от того, на котором размещен локальный источник данных. Когда шлюз и источник данных находятся на разных компьютерах, шлюз не конкурирует за использование ресурсов с источником данных.
* У вас может быть **несколько шлюзов на разных компьютерах, подключенных к одному и тому же локальному источнику данных**. Например, имеется два шлюза, обслуживающие две фабрики данных, однако один и тот же локальный источник данных зарегистрирован в обеих фабриках данных.
* Если вы уже установили шлюз на компьютер, который обслуживает сценарий **Power BI**, установите **отдельный шлюз для фабрики данных Azure** на другой компьютер.
* Шлюз необходимо использовать, даже если используется **ExpressRoute**.
* Источник данных следует считать локальным (то есть защищенным брандмауэром), даже если используется **ExpressRoute**. А для связи между службой и источником данных используется шлюз.
* Необходимо **использовать шлюз**, даже если хранилище данных находится в облаке на **виртуальной машине IaaS Azure**.

## <a name="installation"></a>Установка
### <a name="prerequisites"></a>предварительным требованиям
* Поддерживаемые **операционные системы** : Windows 7, Windows 8, Windows 8.1, Windows 10, Windows Server 2008 R2, Windows Server 2012, Windows Server 2012 R2. В настоящее время установка шлюза управления данными на контроллере домена не поддерживается.
* Требуется .NET Framework 4.5.1 или более поздней версии. При установке шлюза на компьютере под управлением Windows 7 установите .NET Framework 4.5 или более поздней версии. Дополнительные сведения см. в разделе [Требования к системе для .NET Framework](https://msdn.microsoft.com/library/8z6watww.aspx).
* Рекомендуемая **конфигурация** для компьютера шлюза: четырехъядерный процессор с тактовой частотой не менее 2 ГГц, не менее 8 ГБ ОЗУ и 80 ГБ дискового пространства.
* Когда хост-компьютер переходит в спящий режим, шлюз не может отвечать на запросы данных. Поэтому перед установкой шлюза на компьютере следует настроить соответствующую **схему управления питанием** . Если компьютер настроен на использование режима гибернации, во время установки шлюза отобразится соответствующее сообщение.
* Для успешной установки шлюза управления данными и его настройки вы должны обладать правами администратора на компьютере. В локальную группу Windows **Пользователи шлюза управления данными** можно добавить дополнительных пользователей. Участники этой группы могут использовать **диспетчер конфигурации шлюза управления данными** для настройки шлюза.

Так как циклы копирования выполняются с определенной частотой, ресурсы компьютера (ЦП, память) используются нерегулярно: есть пиковые нагрузки и есть время простоя. Использование ресурсов также зависит от объема перемещаемых данных. Когда выполняется несколько заданий копирования, в пиковые периоды уровень использования ресурсов системы повышается.

### <a name="installation-options"></a>Параметры установки
Шлюз управления данными можно установить одним из следующих способов.

* Скачать установочный пакет MSI из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717).  Пакет MSI также может использоваться для обновления имеющегося шлюза управления данными до последней версии с сохранением всех параметров.
* Щелкнуть ссылку **Скачивание и установка шлюза данных** в разделе "Установка вручную" или ссылку **Установка непосредственно на этот компьютер** в разделе "Экспресс-установка". В разделе [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md) приведены пошаговые инструкции по экспресс-установке. В случае ручной установки вы перейдете к центру загрузки.  Инструкции по скачиванию и установке шлюза из центра загрузки приведены в следующем разделе.

### <a name="installation-best-practices"></a>Рекомендации по установке
1. Настройте схему управления питанием на хост-компьютере шлюза, отключив спящий режим. Когда хост-компьютер переходит в спящий режим, шлюз не может отвечать на запросы данных.
2. Создайте резервную копию сертификата, связанного со шлюзом.

### <a name="install-the-gateway-from-download-center"></a>Установка шлюза из центра загрузки
1. Перейдите на [страницу скачивания шлюза управления данными Майкрософт](https://www.microsoft.com/download/details.aspx?id=39717).
2. Щелкните **Скачать**, выберите нужную версию (**32-разрядную** или **64-разрядную**) и нажмите кнопку **Далее**.
3. Сразу запустите **MSI** -файл или сохраните его на жесткий диск и затем запустите.
4. На странице **приветствия** выберите **язык**, после чего нажмите кнопку **Далее**.
5. **Примите** условия лицензионного соглашения и нажмите кнопку **Далее**.
6. Выберите **папку** для установки шлюза, затем нажмите кнопку **Далее**.
7. На странице **Готово к установке** щелкните **Установить**.
8. Нажмите кнопку **Готово** для завершения установки.
9. Получите ключ на портале Azure. Пошаговые инструкции представлены в следующем разделе.
10. Запустите на компьютере **диспетчер конфигурации шлюза управления данными**, затем на странице **Регистрация шлюза** выполните следующие действия.
    1. Вставьте ключ в текст.
    2. При необходимости щелкните **Показать ключ шлюза** , чтобы просмотреть текст ключа.
    3. Щелкните **Зарегистрировать**.

### <a name="register-gateway-using-key"></a>Регистрация шлюза с помощью ключа
#### <a name="if-you-havent-already-created-a-logical-gateway-in-the-portal"></a>Если логический шлюз на портале еще не создан
Чтобы создать шлюз на портале и найти ключ на странице **Настройка**, выполните действия из пошагового руководства в статье [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md).    

#### <a name="if-you-have-already-created-the-logical-gateway-in-the-portal"></a>Если логический шлюз на портале уже создан
1. На портале Azure перейдите к странице **Фабрика данных** и щелкните элемент **Связанные службы**.

    ![Страница "Фабрика данных"](media/data-factory-data-management-gateway/data-factory-blade.png)
2. На странице **Связанные службы** выберите логический **шлюз**, созданный на портале.

    ![Логический шлюз](media/data-factory-data-management-gateway/data-factory-select-gateway.png)  
3. На странице **Шлюз данных** щелкните **Скачивание и установка шлюза данных**.

    ![Ссылка для скачивания на портале](media/data-factory-data-management-gateway/download-and-install-link-on-portal.png)   
4. На странице **Настройка** щелкните **Повторное создание ключа**. Нажмите кнопку "Да" в окне предупреждающего сообщения, внимательно его прочитав.

    ![Повторное создание ключа](media/data-factory-data-management-gateway/recreate-key-button.png)
5. Нажмите кнопку "Копировать" рядом с ключом. Ключ cкопируется в буфер обмена.

    ![Копирование ключа](media/data-factory-data-management-gateway/copy-gateway-key.png)

### <a name="system-tray-icons-notifications"></a>Значки и уведомления в области уведомлений
На следующем рисунке показаны некоторые значки панели задач.

![значки на панели задач](./media/data-factory-data-management-gateway/gateway-tray-icons.png)

Если навести курсор на значок или сообщение уведомления на панели задач, появится всплывающее окно со сведениями о состоянии шлюза или операции обновления.

### <a name="ports-and-firewall"></a>Порты и брандмауэр
Описанные здесь рекомендации относятся к двум брандмауэрам: к **корпоративному брандмауэру**, работающему на центральном маршрутизаторе организации, и к **брандмауэру Windows**, настроенному в качестве управляющей программы на локальном компьютере, на котором установлен шлюз.  

![брандмауэры](./media/data-factory-data-management-gateway/firewalls2.png)

На уровне корпоративного брандмауэра необходимо настроить следующие домены и исходящие порты:

| Имена доменов | порты; | ОПИСАНИЕ |
| --- | --- | --- |
| *.servicebus.windows.net |443, 80 |Используется для связи с серверной частью службы перемещения данных. |
| *.core.windows.net |443 |Используется для промежуточного копирования с помощью большого двоичного объекта Azure (если оно настроено).|
| *.frontend.clouddatahub.net |443 |Используется для связи с серверной частью службы перемещения данных. |
| *.servicebus.windows.net |9350-9354, 5671 |Дополнительная ретрансляция служебной шины по протоколу TCP, используемая мастером копирования |


Эти исходящие порты, как правило, включены на уровне брандмауэра Windows. В противном случае домены и порты можно соответствующим образом настроить на компьютере шлюза.

> [!NOTE]
> 1. В зависимости от того, какие источники и приемники используются, может потребоваться добавить в список разрешений корпоративного брандмауэра или брандмауэра Windows дополнительные домены и исходящие порты.
> 2. Для некоторых баз данных в облаке (например, [База данных SQL Azure](https://docs.microsoft.com/azure/sql-database/sql-database-configure-firewall-settings), [Azure Data Lake](https://docs.microsoft.com/azure/data-lake-store/data-lake-store-secure-data#set-ip-address-range-for-data-access) и т. д.) может потребоваться добавить в список разрешений брандмауэра IP-адрес компьютера шлюза.
>
>


#### <a name="copy-data-from-a-source-data-store-to-a-sink-data-store"></a>Копирование данных из источника данных в приемник данных
Убедитесь, что правила брандмауэра в корпоративном брандмауэре, брандмауэре Windows на компьютере шлюза и в самом хранилище данных активированы надлежащим образом. Активация этих правил позволяет шлюзу успешно подключаться как к источнику, так и к приемнику. Активируйте правила для каждого хранилища данных, задействованного в операции копирования.

Например, при копировании **данных из локального хранилища в приемник базы данных SQL Azure или приемник хранилища данных SQL Azure**выполните следующее.

* Разрешите исходящий трафик **TCP** через порт **1433** для брандмауэра Windows и корпоративного брандмауэра.
* в параметрах брандмауэра Azure SQL Server добавить IP-адрес компьютера шлюза в список разрешенных IP-адресов.

> [!NOTE]
> Если брандмауэр блокирует исходящий порт 1433, то шлюз не сможет напрямую получить доступ к SQL Azure. В этом случае можно использовать [промежуточное копирование](https://docs.microsoft.com/azure/data-factory/data-factory-copy-activity-performance#staged-copy) в базу данных SQL Azure или хранилище данных SQL Azure. Тогда для перемещения данных понадобится только протокол HTTPS (порт 443).
>
>


### <a name="proxy-server-considerations"></a>Рекомендации для прокси-сервера
Если для доступа в Интернет в среде вашей корпоративной сети используется прокси-сервер, настройте шлюз управления данными для применения соответствующих параметров прокси-сервера. Прокси-сервер можно настроить на этапе начальной регистрации.

![Настройка прокси-сервера при регистрации](media/data-factory-data-management-gateway/SetProxyDuringRegistration.png)

Шлюз использует прокси-сервер для подключения к облачной службе. Щелкните ссылку **Изменить** во время начальной настройки. Отобразится диалоговое окно **Proxy setting** (Настройка прокси-сервера).

![Настройка прокси-сервера с помощью диспетчера конфигурации](media/data-factory-data-management-gateway/SetProxySettings.png)

Доступны три варианта конфигурации.

* **Без прокси**: шлюз явно не использует никакой прокси-сервер для подключения к облачным службам.
* **Использовать системный прокси**: шлюз использует параметры прокси-сервера, настроенные в файлах diahost.exe.config и diawp.exe.config.  Если в файлах diahost.exe.config и diawp.exe.config параметры прокси-сервера не настроены, шлюз подключается к облачной службе напрямую, не используя прокси-сервер.
* **Использовать настраиваемый прокси**: шлюз использует параметры HTTP-прокси вместо конфигурации, настроенной в файлах diahost.exe.config и diawp.exe.config.  Необходимо указать адрес и порт.  Имя пользователя и пароль являются необязательными и указываются в зависимости от настроек аутентификации прокси-сервера.  Все параметры шифруются с помощью сертификата учетных данных шлюза и сохраняются локально на хост-компьютере шлюза.

Служба узла шлюза управления данными автоматически перезапускается после сохранения обновленных параметров прокси-сервера.

После успешной регистрации шлюза, если требуется просмотреть или обновить параметры прокси-сервера, используйте диспетчер конфигурации шлюза управления данными.

1. Запустите **диспетчер конфигурации шлюза управления данными**.
2. Переключитесь на вкладку **Параметры** .
3. Щелкните ссылку **Изменить** в разделе **HTTP-прокси**, чтобы открыть диалоговое окно **Указание HTTP-прокси**.  
4. После нажатия кнопки **Далее** появится диалоговое окно предупреждения, запрашивающее разрешение на сохранение настроек прокси-сервера и перезапуск службы узла шлюза.

При помощи диспетчера конфигурации можно просмотреть и обновить HTTP-прокси.

![Настройка прокси-сервера с помощью диспетчера конфигурации](media/data-factory-data-management-gateway/SetProxyConfigManager.png)

> [!NOTE]
> Если настроить на прокси-сервере аутентификацию NTLM, то служба узла шлюза будет запускаться под учетной записью домена. Если через какое-то время вы измените пароль для учетной записи домена, то не забудьте обновить параметры конфигурации службы и перезапустить ее. Учитывая это требование, для доступа к прокси-серверу рекомендуется использовать выделенную учетную запись домена, для которой не требуется часто менять пароль.
>
>

### <a name="configure-proxy-server-settings"></a>Настройка параметров прокси-сервера
Если для HTTP-прокси выбран вариант конфигурации **Использовать системный прокси**, шлюз использует параметры прокси-сервера, заданные в файлах diahost.exe.config и diawp.exe.config.  Если в файлах diahost.exe.config и diawp.exe.config параметры прокси-сервера не заданы, шлюз подключается к облачной службе напрямую, не используя прокси-сервер. Ниже приводится процедура обновления файла конфигурации diahost.exe.config.  

1. В проводнике создайте резервную копию исходного файла C:\Program Files\Microsoft Data Management Gateway\2.0\Shared\diahost.exe.config.
2. Запустите файл Notepad.exe с правами администратора и откройте текстовый файл с путем C:\Program Files\Microsoft Data Management Gateway\2.0\Shared\diahost.exe.config. Найдите тег по умолчанию для system.net, как показано в коде ниже.

         <system.net>
             <defaultProxy useDefaultCredentials="true" />
         </system.net>    

   Затем можно добавить данные прокси-сервера, как показано в следующем примере:

         <system.net>
               <defaultProxy enabled="true">
                     <proxy bypassonlocal="true" proxyaddress="http://proxy.domain.org:8888/" />
               </defaultProxy>
         </system.net>

   Внутри тега прокси-сервера можно указать дополнительные свойства, чтобы задать требуемые параметры, например scriptLocation. Сведения о синтаксисе см. в статье [Элемент <proxy> (параметры сети)](https://msdn.microsoft.com/library/sa91de1e.aspx).

         <proxy autoDetect="true|false|unspecified" bypassonlocal="true|false|unspecified" proxyaddress="uriString" scriptLocation="uriString" usesystemdefault="true|false|unspecified "/>
3. Сохраните файл конфигурации в исходном расположении, а затем перезапустите службу узла шлюза управления данными, которая получает изменения. Чтобы перезапустить службу, воспользуйтесь приложением "Службы" на панели управления или откройте **диспетчер конфигурации шлюза управления данными**, нажмите кнопку **Остановить службу**, а затем щелкните **Запустить службу**. Если служба не запускается, вероятно, в измененном файле конфигурации приложения добавлен неправильный синтаксис тегов XML.

> [!IMPORTANT]
> Не забудьте обновить **оба** файла (diahost.exe.config и diawp.exe.config).  


Кроме того, необходимо также убедиться, что Microsoft Azure входит в белый список в вашей компании. Список допустимых IP-адресов Microsoft Azure можно скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=41653).

#### <a name="possible-symptoms-for-firewall-and-proxy-server-related-issues"></a>Возможные признаки проблем, связанных с брандмауэром и прокси-сервером
Вероятная причина приведенных ниже ошибок — неправильная конфигурация брандмауэра или прокси-сервера, которая блокирует подключение шлюза к фабрике данных для аутентификации. Чтобы настроить брандмауэр и прокси-сервер должным образом, см. предыдущий раздел.

1. При попытке зарегистрировать шлюз появляется следующая ошибка: "Не удалось зарегистрировать ключ шлюза. Перед повторной попыткой регистрации ключа убедитесь, что шлюз управления данными подключен и на хост-компьютере запущена служба шлюза управления данными".
2. При открытии диспетчера конфигурации отображается состояние "Отключено" или "Подключение". В средстве просмотра событий Windows в разделе "Журналы приложения и служб" > "Шлюз управления данными" отображается сообщение об ошибке следующего вида: `Unable to connect to the remote server`
   `A component of Data Management Gateway has become unresponsive and restarts automatically. Component name: Gateway.`

### <a name="open-port-8050-for-credential-encryption"></a>Открытие порта 8050 для шифрования учетных данных
Приложение **настройки учетных данных** использует входящий порт **8050** для ретрансляции учетных данных, которые вы указываете на портале Azure для локальной связанной службы, в шлюз учетных данных. По умолчанию при установке шлюза программа установки открывается на компьютере шлюза.

В случае использования стороннего брандмауэра вы сможете открыть порт 8050 вручную. Если во время установки шлюза возникли проблемы с брандмауэром, попробуйте установить шлюз без настройки брандмауэра, используя следующую команду:

    msiexec /q /i DataManagementGateway.msi NOFIREWALL=1

Если вы не хотите открывать порт 8050 на компьютере шлюза, то настроить учетные данные для хранилища данных с помощью приложения **настройки учетных данных** будет невозможно. Используйте другие механизмы настройки. Например, можно использовать командлет PowerShell [New-AzureRmDataFactoryEncryptValue](https://msdn.microsoft.com/library/mt603802.aspx). Дополнительные сведения о настройке учетных данных хранилища данных см. в разделе [Настройка учетных данных и безопасность](#set-credentials-and-securityy).

## <a name="update"></a>Блокировка изменений
По умолчанию шлюз управления данными автоматически обновляется, если доступна новая версия. Он не будет обновлен, пока не будут выполнены все запланированные задания. До завершения операции обновления в шлюзе не будут обрабатываться какие-либо дополнительные задачи. Если обновление завершится сбоем, для шлюза будет выполнен откат к предыдущей версии.

Время запланированного обновления см. в следующих местах:

* страница свойств шлюза на портале Azure;
* домашняя страница диспетчера конфигурации шлюза управления данными;
* сообщение в области уведомлений.

На вкладке "Главная" диспетчера конфигурации шлюза управления данными отображается расписание обновления, а также время последнего обновления или установки шлюза.

![запланировать обновления](media/data-factory-data-management-gateway/UpdateSection.png)

Вы можете установить обновление сразу или дождаться, пока шлюз не будет автоматически обновлен в запланированное время. На следующем изображении показано сообщение уведомления на странице диспетчера конфигурации шлюза вместе с кнопкой "Обновить", которую можно нажать, чтобы установить обновление немедленно.

![Обновление диспетчера конфигураций DMG](./media/data-factory-data-management-gateway/gateway-auto-update-config-manager.png)

Сообщение уведомления в области уведомлений будет выглядеть следующим образом.

![Сообщение на панели задач](./media/data-factory-data-management-gateway/gateway-auto-update-tray-message.png)

На панели задач отображается состояние операции обновления (выполняемой вручную или автоматически). В следующий раз при запуске диспетчера конфигурации шлюза на панели уведомлений отобразится сообщение об обновлении шлюза и ссылка на [раздел о новых возможностях](data-factory-gateway-release-notes.md).

### <a name="to-disableenable-auto-update-feature"></a>Включение или отключение функции автоматического обновления
Чтобы включить или отключить функцию автоматического обновления, сделайте следующее.

(Для шлюза с одним узлом)
1. Запустите Windows PowerShell на компьютере шлюза.
2. Перейдите в папку C:\Program Files\Microsoft Data Management Gateway\2.0\PowerShellScript.
3. Выполните следующую команду, чтобы отключить функцию автоматического обновления.   

    ```PowerShell
    .\GatewayAutoUpdateToggle.ps1  -off
    ```
4. Чтобы снова включить ее:

    ```PowerShell
    .\GatewayAutoUpdateToggle.ps1  -on  
    ```
[Для предварительной версии высокодоступного и масштабируемого шлюза с несколькими узлами](data-factory-data-management-gateway-high-availability-scalability.md)
1. Запустите Windows PowerShell на компьютере шлюза.
2. Перейдите в папку C:\Program Files\Microsoft Data Management Gateway\2.0\PowerShellScript.
3. Выполните следующую команду, чтобы отключить функцию автоматического обновления.   

    Для шлюза с функцией высокой доступности (предварительная версия) требуется дополнительный параметр AuthKey.
    ```PowerShell
    .\GatewayAutoUpdateToggle.ps1  -off -AuthKey <your auth key>
    ```
4. Чтобы снова включить ее:

    ```PowerShell
    .\GatewayAutoUpdateToggle.ps1  -on -AuthKey <your auth key> 
    ```

## <a name="configuration-manager"></a>Менеджер конфигураций
После установки шлюза вы можете запустить диспетчер конфигурации шлюза управления данными одним из приведенных ниже способов.

1. Для этого введите текст **шлюз управления данными** в окне **Поиск**.
2. Выполните исполняемый файл **ConfigManager.exe** в папке **C:\Program Files\Microsoft Data Management Gateway\2.0\Shared**.

### <a name="home-page"></a>главная страница
Главная страница позволяет выполнить следующие действия:

* Просмотреть состояние шлюза (подключенного к облачной службе и т.д.).
* **Зарегистрировать** с помощью ключа с портала;
* **остановить** и запустить **службу узла шлюза управления данными** на компьютере шлюза;
* **запланировать обновления** на определенное время дня;
* просмотреть дату **последнего обновления**шлюза.

### <a name="settings-page"></a>Страница «Параметры»
Страница "Параметры" позволяет выполнить следующие действия:

* Просмотреть, изменить и экспортировать **сертификат** , который используется шлюзом. Этот сертификат используется для шифрования учетных данных источника данных.
* Изменить **HTTPS-порт** для конечной точки. шлюз открывает порт для настройки учетных данных источника данных;
* **состояние** конечной точки.
* Представление **SSL-сертификат** используется для обмена данными по протоколу SSL между порталом и шлюзом, чтобы задать учетные данные для источников данных.  

### <a name="remote-access-from-intranet"></a>Удаленный доступ из интрасети  
Эта функция будет включена в будущем. В будущих обновленных версиях (3.4 и более поздних версиях) вы сможете включать или отключать все возможности удаленного подключения, которые сейчас реализуются через порт 8050 (см. раздел выше) с использованием PowerShell или приложения "Диспетчер учетных данных" для шифрования учетных данных. 

### <a name="diagnostics-page"></a>Страница "Диагностика"
Страница "Диагностика" позволяет выполнить следующие действия:

* Включить подробное **ведение журнала**, просмотреть журналы в средстве просмотра событий и отправить журналы в корпорацию Майкрософт в случае сбоя.
* **Проверить подключение** к источнику данных.  

### <a name="help-page"></a>Страница справки
На странице "Справка" отображается следующая информация:  

* краткое описание шлюза;
* номер версии;
* ссылки на справку в Интернете, заявление о конфиденциальности и лицензионное соглашение.  

## <a name="monitor-gateway-in-the-portal"></a>Мониторинг шлюза на портале
На портале Azure можно просмотреть моментальный снимок использования ресурсов (ЦП, память, входящий и исходящий трафик сети и т. д.) на компьютере шлюза.  

1. На портале Azure перейдите к домашней странице фабрики данных и щелкните плитку **Связанные службы**. 

    ![Домашняя страница фабрики данных](./media/data-factory-data-management-gateway/monitor-data-factory-home-page.png) 
2. Выберите **шлюз** на странице **Связанные службы**.

    ![Страница "Связанные службы"](./media/data-factory-data-management-gateway/monitor-linked-services-blade.png)
3. На странице **шлюза** можно увидеть использование памяти и ЦП шлюза.

    ![Использование ЦП и памяти шлюза](./media/data-factory-data-management-gateway/gateway-simple-monitoring.png) 
4. Включите **дополнительные параметры** для получения дополнительных сведений, таких как использование сети.
    
    ![Расширенный мониторинг шлюза](./media/data-factory-data-management-gateway/gateway-advanced-monitoring.png)

В следующей таблице приводится описание столбцов в списке **Узлы шлюза**.  

Свойство мониторинга | ОПИСАНИЕ
:------------------ | :---------- 
ИМЯ | Имя логического шлюза и узлов, связанных со шлюзом. Узел — это локальный компьютер с Windows, на котором установлен шлюз. Сведения о настройке нескольких узлов (до четырех) в одном логическом шлюзе см. в статье [Шлюз управления данными: высокий уровень доступности и масштабируемость](data-factory-data-management-gateway-high-availability-scalability.md).    
Status | Состояние логического шлюза и узлов шлюза, например, "В сети", "Автономно", "Ограничено" и т. д. Сведения об этих состояниях см. в разделе [Состояние шлюза](#gateway-status). 
Version (версия) | Указывает версию логического шлюза и каждого узла шлюза. Версия логического шлюза определяется на основе версии большинства узлов в группе. Если в логическом шлюзе настроены узлы с разными версиями, должным образом будут работать только те из них, версия которых совпадает с версией логического шлюза. Другие узлы находятся в ограниченном режиме и их необходимо обновлять вручную (только при сбое автоматического обновления). 
Объем доступной памяти | Объем доступной памяти на узле шлюза. Это значение соответствует моментальному снимку в режиме, близком к реальному времени. 
загрузка ЦП; | Использование ЦП на узле шлюза. Это значение соответствует моментальному снимку в режиме, близком к реальному времени. 
Networking (In/Out) (Сеть (входящий и исходящий трафик)) | Использование сети на узле шлюза. Это значение соответствует моментальному снимку в режиме, близком к реальному времени. 
Concurrent Jobs (Running/Limit) (Одновременные задания (выполняемые и ограниченные)) | Число заданий или задач, выполняющихся на каждом узле. Это значение соответствует моментальному снимку в режиме, близком к реальному времени. Ограничение означает максимальное количество одновременно выполняемых заданий для каждого узла. Это значение определяется на основе размера компьютера. Ограничение можно увеличить, чтобы увеличить масштаб параллельных заданий в сложных сценариях, где ЦП, память или сеть мало используется, но время ожидание действий истекает. Эта возможность также доступна для шлюза с одним узлом (даже если не включена функция масштабируемости и доступности).  
Роль | В многоузловом шлюзе существует два типа ролей — рабочая роль и диспетчер. Все узлы являются рабочими, то есть их можно использовать для выполнения заданий. Только один узел выполняет роль диспетчера, который используется для извлечения задачи или задания из облачных служб и отправки в разные рабочие узлы (включая сам узел-диспетчер).

На этой странице отображаются некоторые параметры, которые больше подходят для шлюзов с двумя и более узлами (сценарий развертывания). Подробные сведения о настройке шлюза с несколькими узлами см. в статье [Шлюз управления данными: высокий уровень доступности и масштабируемость](data-factory-data-management-gateway-high-availability-scalability.md).

### <a name="gateway-status"></a>Состояние шлюза
В следующей таблице представлены сведения о возможных состояниях **узла шлюза**: 

Status  | Комментарии и сценарии
:------- | :------------------
В сети | Узел подключен к службе фабрики данных.
Автономно | Узел находится в автономном режиме.
Обновление | Узел автоматически обновляется.
Ограничено | Это состояние появляется при проблемах с подключением. Возможно, из-за проблем с портом 8050 HTTP, подключением к служебной шине или синхронизацией учетных данных. 
Неактивно | Конфигурация узла отличается от конфигурации большинства других узлов.<br/><br/> Узел может быть неактивным, если он не может подключиться к другим узлам. 


В следующей таблице представлены сведения о возможных состояниях **логического шлюза**: Состояние шлюза зависит от состояния его узлов. 

Status | Комментарии
:----- | :-------
Needs Registration (Требуется регистрация) | В логическом шлюзе не зарегистрированы узлы.
В сети | Узлы шлюза подключены к сети.
Автономно | Узлы не подключены к сети.
Ограничено | Не все узлы в этом шлюзе находятся в работоспособном состоянии. Это состояние является предупреждением, что определенный узел не работает. <br/><br/>Возможно, это произошло из-за проблемы с синхронизацией учетных данных на узле-диспетчера или на рабочем узле. 

## <a name="scale-up-gateway"></a>Увеличение масштаба шлюза
Вы можете настроить количество **одновременных заданий перемещения данных**, которые можно запустить на узле, чтобы расширить возможность перемещения данных между локальными и облачными хранилищами данных. 

Если доступная память и ЦП используются неэффективно, но время простоя равно 0, следует увеличить масштаб, увеличив количество одновременных заданий, которые могут выполняться на узле. Кроме того, масштаб можно увеличить, если время ожидания действия истекает из-за перегрузки шлюза. В дополнительных параметрах узла шлюза можно увеличить максимальную емкость узла. 
  

## <a name="troubleshooting-gateway-issues"></a>Устранение неполадок со шлюзом
Сведения и советы по устранению неполадок с помощью шлюза управления данными см. в статье [Устранение неполадок в работе шлюза управления данными](data-factory-troubleshoot-gateway-issues.md).  

## <a name="move-gateway-from-one-machine-to-another"></a>Перемещение шлюза с одного компьютера на другой
Этот раздел содержит процедуру перемещения клиента шлюза с одного компьютера на другой.

1. На портале перейдите на **главную страницу фабрики данных**, а затем щелкните элемент **Связанные службы**.

    ![Ссылка на шлюзы данных](./media/data-factory-data-management-gateway/DataGatewaysLink.png)
2. Выберите нужный шлюз в разделе **Шлюзы данных** на странице **Связанные службы**.

    ![Страница "Связанные службы" с выбранным шлюзом](./media/data-factory-data-management-gateway/LinkedServiceBladeWithGateway.png)
3. На странице **Шлюз данных** щелкните **Скачивание и установка шлюза данных**.

    ![Ссылка на шлюз загрузки](./media/data-factory-data-management-gateway/DownloadGatewayLink.png)
4. На странице **Настройка** щелкните **Скачивание и установка шлюза данных**, а затем следуйте инструкциям по установке шлюза данных на компьютере.

    ![Страница "Настройка"](./media/data-factory-data-management-gateway/ConfigureBlade.png)
5. Не закрывайте **диспетчер конфигурации шлюза управления данными** .

    ![Менеджер конфигураций](./media/data-factory-data-management-gateway/ConfigurationManager.png)    
6. На странице **Настройка** на портале щелкните **Повторное создание ключа** на панели команд и щелкните **Да** в окне с предупреждением. Скопируйте ключ в буфер обмена с помощью **кнопки копирования** рядом с текстом ключа. Шлюз на старом компьютере прекращает работу сразу же, как только будет повторно создан ключ.  

    ![Повторное создание ключа](./media/data-factory-data-management-gateway/RecreateKey.png)
7. Вставьте **ключ** в соответствующее текстовое поле на странице **Регистрация шлюза** **диспетчера конфигурации шлюза управления данными** на своем компьютере. (Необязательно) Чтобы увидеть текст ключа, установите флажок **Показать ключ шлюза** .

    ![Копирование и регистрация ключа](./media/data-factory-data-management-gateway/CopyKeyAndRegister.png)
8. Щелкните **Зарегистрировать** , чтобы зарегистрировать шлюз в облачной службе.
9. На вкладке **Параметры** щелкните **Изменить**, чтобы выбрать сертификат, который использовался на старом шлюзе, затем введите **пароль** и щелкните **Готово**.

   ![Выбор сертификата](./media/data-factory-data-management-gateway/SpecifyCertificate.png)

   Вы можете экспортировать сертификат из старого шлюза следующим образом. Запустите диспетчер конфигурации шлюза управления данными на старом компьютере, перейдите на вкладку **Сертификат**, нажмите кнопку **Экспорт** и следуйте инструкциям на экране.
10. После успешной регистрации шлюза вы увидите, что на главной странице диспетчера конфигурации шлюза значение параметра **Регистрация** изменилось на **Зарегистрировано**, а параметр **Состояние** получил значение **Запущено**.

## <a name="encrypting-credentials"></a>Шифрование учетных данных
Для шифрования учетных данных в редакторе фабрики данных выполните следующие действия.

1. Запустите веб-браузер на **компьютере шлюза**и перейдите на [портал Azure](http://portal.azure.com). Найдите нужную фабрику данных и откройте ее на странице**Фабрика данных**, а затем выберите **Author & Deploy** (Создать и развернуть), чтобы запустить редактор фабрики данных.   
2. Щелкните имеющуюся **связанную службу** в представлении в виде дерева, чтобы просмотреть определение JSON для этой службы, или создайте связанную службу, которой требуется шлюз управления данными (например, SQL Server или Oracle).
3. В редакторе JSON для свойства **gatewayName** укажите имя шлюза.
4. Введите имя сервера в качестве значения для свойства **Data Source** в строке **connectionString**.
5. Введите имя базы данных в качестве значения для свойства **Initial Catalog** в строке **connectionString**.    
6. Нажмите кнопку **Зашифровать** на панели команд, чтобы запустить ClickOnce-приложение **Диспетчер учетных данных**. Откроется диалоговое окно **Setting Credentials** (Настройка учетных данных).

    ![Диалоговое окно "Настройка учетных данных"](./media/data-factory-data-management-gateway/setting-credentials-dialog.png)
7. В диалоговом окне **Настройка учетных данных** выполните следующие действия.
   1. Выберите тип **проверки подлинности** , который служба фабрики данных будет использовать для подключения к базе данных.
   2. В поле **ИМЯ ПОЛЬЗОВАТЕЛЯ** укажите имя пользователя с доступом к базе данных.
   3. В поле **ПАРОЛЬ** укажите пароль этого пользователя.  
   4. Нажмите кнопку **ОК** , чтобы зашифровать учетные данные и закрыть диалоговое окно.
8. Теперь в **connectionString** должно появиться свойство **encryptedCredential**.

    ```JSON
    {
        "name": "SqlServerLinkedService",
        "properties": {
            "type": "OnPremisesSqlServer",
            "description": "",
            "typeProperties": {
                "connectionString": "data source=myserver;initial catalog=mydatabase;Integrated Security=False;EncryptedCredential=eyJDb25uZWN0aW9uU3R",
                "gatewayName": "adftutorialgateway"
            }
        }
    }
    ```
Если для доступа к порталу используется компьютер, отличный от компьютера шлюза, необходимо убедиться в том, что диспетчер учетных данных может подключиться к компьютеру шлюза. Если приложению не удается подключиться к компьютеру шлюза, вы не сможете задать учетные данные для источника данных и проверить подключение к нему.  

Когда вы используете приложение **настройки учетных данных**, портал шифрует учетные данные с помощью сертификата, который указан на вкладке **Сертификат** в **диспетчере конфигурации шлюза** на компьютере шлюза.

Если вам нужен способ шифрования учетных данных на основе API, используйте командлет PowerShell [New-AzureRmDataFactoryEncryptValue](https://msdn.microsoft.com/library/mt603802.aspx) . Командлет шифрует учетные данные с помощью сертификата, который настроен в шлюзе. Зашифрованные учетные данные добавляются в элемент **EncryptedCredential** в **connectionString** в JSON. JSON используется в командлете [New AzureRmDataFactoryLinkedService](https://msdn.microsoft.com/library/mt603647.aspx) или редакторе фабрики данных.

```JSON
"connectionString": "Data Source=<servername>;Initial Catalog=<databasename>;Integrated Security=True;EncryptedCredential=<encrypted credential>",
```

Для настройки учетных данных при помощи редактора фабрики данных существует еще один способ. Если при помощи редактора создать связанную службу SQL Server и ввести учетные данные в виде обычного текста, то эти учетные данные будут шифроваться с помощью сертификата, который принадлежит службе фабрики данных. Сертификат, который настроен для шлюза, НЕ используется. Хотя этот способ работает быстрее в некоторых случаях, он менее безопасен. Поэтому мы рекомендуем использовать его только для целей разработки и тестирования.

## <a name="powershell-cmdlets"></a>Командлеты PowerShell
В этом разделе описывается, как создать и зарегистрировать шлюз с использованием командлетов Azure PowerShell.

1. Запустите модуль **Azure PowerShell** в режиме администратора.
2. Войдите в учетную запись Azure, выполнив следующую команду и введя свои учетные данные Azure.

    ```PowerShell
    Connect-AzureRmAccount
    ```
3. Используйте командлет **New-AzureRmDataFactoryGateway** для создания логического шлюза следующим образом:

    ```PowerShell
    $MyDMG = New-AzureRmDataFactoryGateway -Name <gatewayName> -DataFactoryName <dataFactoryName> -ResourceGroupName ADF –Description <desc>
    ```
    **Пример команды и выходных данных**:

    ```
    PS C:\> $MyDMG = New-AzureRmDataFactoryGateway -Name MyGateway -DataFactoryName $df -ResourceGroupName ADF –Description “gateway for walkthrough”

    Name              : MyGateway
    Description       : gateway for walkthrough
    Version           :
    Status            : NeedRegistration
    VersionStatus     : None
    CreateTime        : 9/28/2014 10:58:22
    RegisterTime      :
    LastConnectTime   :
    ExpiryTime        :
    ProvisioningState : Succeeded
    Key               : ADF#00000000-0000-4fb8-a867-947877aef6cb@fda06d87-f446-43b1-9485-78af26b8bab0@4707262b-dc25-4fe5-881c-c8a7c3c569fe@wu#nfU4aBlq/heRyYFZ2Xt/CD+7i73PEO521Sj2AFOCmiI
    ```

1. В Azure PowerShell перейдите в папку **C:\Program Files\Microsoft Data Management Gateway\2.0\PowerShellScript\**. Выполните сценарий **RegisterGateway.ps1**, связанный с локальной переменной **$Key**, как показано в следующей команде. Этот сценарий регистрирует агент клиента, установленный на вашем компьютере с логическим шлюзом, созданным ранее.

    ```PowerShell
    PS C:\> .\RegisterGateway.ps1 $MyDMG.Key
    ```
    ```
    Agent registration is successful!
    ```
    С помощью параметра IsRegisterOnRemoteMachine можно зарегистрировать шлюз на удаленном компьютере. Пример:

    ```PowerShell
    .\RegisterGateway.ps1 $MyDMG.Key -IsRegisterOnRemoteMachine true
    ```
2. Вы можете использовать командлет **Get-AzureRmDataFactoryGateway** , чтобы получить список шлюзов своей фабрики данных. Если в поле **Состояние** указано значение **Подключено**, то шлюз готов к использованию.

    ```PowerShell        
    Get-AzureRmDataFactoryGateway -DataFactoryName <dataFactoryName> -ResourceGroupName ADF
    ```
Вы можете удалить шлюз, используя командлет **Remove-AzureRmDataFactoryGateway**, или обновить описание шлюза, используя командлет **Set-AzureRmDataFactoryGateway**. Дополнительную информацию о синтаксисе и другую информацию об этих командлетах см. в "Справочных материалах по командлетам фабрики данных".  

### <a name="list-gateways-using-powershell"></a>Вывод списка шлюзов с помощью PowerShell

```PowerShell
Get-AzureRmDataFactoryGateway -DataFactoryName jasoncopyusingstoredprocedure -ResourceGroupName ADF_ResourceGroup
```

### <a name="remove-gateway-using-powershell"></a>Удаление шлюза с помощью PowerShell

```PowerShell
Remove-AzureRmDataFactoryGateway -Name JasonHDMG_byPSRemote -ResourceGroupName ADF_ResourceGroup -DataFactoryName jasoncopyusingstoredprocedure -Force
```


## <a name="next-steps"></a>Дополнительная информация
* В разделе [Перемещение данных между локальными источниками и облаком с помощью шлюза управления данными](data-factory-move-data-between-onprem-and-cloud.md) . В руководстве создается конвейер, который использует шлюз для перемещения данных из локальной базы данных SQL Server в большой двоичный объект Azure.  
