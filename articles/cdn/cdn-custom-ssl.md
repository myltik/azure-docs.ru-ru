---
title: Руководство по настройке протокола HTTPS для личного домена в Azure CDN | Документация Майкрософт
description: Из этого руководства вы узнаете, как включить и отключить протокол HTTPS для конечной точки Azure CDN, сопоставленной с личным доменом.
services: cdn
documentationcenter: ''
author: dksimpson
manager: akucer
editor: ''
ms.assetid: 10337468-7015-4598-9586-0b66591d939b
ms.service: cdn
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: tutorial
ms.date: 05/01/2018
ms.author: v-deasim
ms.custom: mvc
ms.openlocfilehash: 86b20e0f317a14db415feff68b17aa99e1e42cb4
ms.sourcegitcommit: 96089449d17548263691d40e4f1e8f9557561197
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/17/2018
ms.locfileid: "34258445"
---
# <a name="tutorial-configure-https-on-an-azure-cdn-custom-domain"></a>Руководство по настройке протокола HTTPS для личного домена в сети доставки содержимого Azure

> [!IMPORTANT]
> Эта возможность недоступна в продуктах **Azure CDN уровня "Стандартный" от Akamai**. Сравнение возможностей CDN см. в статье [Характеристики продукта Azure CDN](cdn-features.md).

В этом руководстве показано, как включить протокол HTTPS для личного домена, связанного с конечной точкой в сети доставки содержимого (CDN) Azure. С помощью протокола HTTPS в личном домене (например, https:\//www.contoso.com) вы гарантируете безопасную доставку конфиденциальных данных с SSL-шифрованием при отправке через Интернет. Протокол HTTPS обеспечивает доверие, проверку подлинности и защиту веб-приложений от атак. 

Azure CDN по умолчанию поддерживает HTTPS в имени узла конечной точки CDN. К примеру, при создании конечной точки CDN (скажем, https:\//contoso.azureedge.net) протокол HTTPS включен по умолчанию.  

Ниже приведены некоторые ключевые характеристики настраиваемой функции HTTPS:

- Никаких дополнительных затрат: вам не придется оплачивать приобретение или продление сертификата или платить за трафик, переданный по протоколу HTTPS. Вы платите только за исходящий трафик из CDN.

- Простое включение: на [портале Azure](https://portal.azure.com) доступна подготовка одним щелчком. Для включения этого компонента можно также использовать REST API или другие средства разработки.

- Доступно полноценное управление сертификатами: закупка всех сертификатов и управление ими осуществляется без вашего участия. Сертификаты автоматически подготавливаются и продлеваются до истечения их срока действия, что устраняет риски прерывания работы службы в связи с истечением срока действия сертификата.

Из этого руководства вы узнаете, как выполнять такие задачи:
> [!div class="checklist"]
> - включение протокола HTTPS в личном домене;
> - использование сертификата, управляемого CDN; 
> - использование собственного сертификата;
> - проверка домена;
> - отключение протокола HTTPS в личном домене.

## <a name="prerequisites"></a>предварительным требованиям

Прежде чем перейти к выполнению шагов в этом руководстве, сначала создайте профиль и как минимум одну конечную точку CDN. Дополнительные сведения см. в статье [Начало работы с Azure CDN](cdn-create-new-endpoint.md).

Кроме того, необходимо связать личный домен Azure CDN с конечной точкой CDN. Дополнительные сведения см. в статье [Руководство. Добавление личного домена к конечной точке CDN Azure](cdn-map-content-to-custom-domain.md).

---

## <a name="ssl-certificates"></a>SSL-сертификаты
Чтобы включить протокол HTTPS для безопасной доставки содержимого в личном домене Azure CDN, необходимо использовать SSL-сертификат. Вы можете использовать сертификат под управлением Azure CDN или собственный сертификат.


# <a name="option-1-default-enable-https-with-a-cdn-managed-certificatetaboption-1-default-enable-https-with-a-cdn-managed-certificate"></a>[Вариант 1 (по умолчанию). Включение HTTPS с помощью сертификата под управлением CDN](#tab/option-1-default-enable-https-with-a-cdn-managed-certificate)

При использовании сертификата под управлением CDN функцию HTTPS можно включить несколькими щелчками. Azure CDN полностью управляет задачами управления сертификатами, такими как приобретение и продление. Как только функция будет включена, процесс сразу же запустится. Если личный домен уже сопоставлен с конечной точкой CDN, дальнейших действий не требуется. Azure CDN предпримет нужные действия и автоматически выполнит запрос. Тем не менее, если личный домен сопоставлен в другом месте, используйте электронную почту, чтобы проверить принадлежность домена.

Ниже описана процедура включения протокола HTTPS для личного домена.

1. На [портале Azure](https://portal.azure.com) перейдите к своему профилю **Azure CDN уровня "Стандартный" от Майкрософт**, **Azure CDN уровня "Стандартный" от Verizon** или **Azure CDN уровня "Премиум" от Verizon**.

2. В списке конечных точек CDN выберите ту из них, которая содержит личный домен.

    ![Список конечных точек](./media/cdn-custom-ssl/cdn-select-custom-domain-endpoint.png)

    Откроется страница **Конечная точка**.

3. В списке личных доменов выберите домен, для которого нужно включить протокол HTTPS.

    ![Список личных доменов](./media/cdn-custom-ssl/cdn-custom-domain.png)

    Откроется страница **Пользовательский домен**.

4. В разделе с типом управления сертификатом выберите **Управляемые CDN**.

5. Выберите **Вкл.**, чтобы включить HTTPS.

    ![Состояние HTTPS для личного домена](./media/cdn-custom-ssl/cdn-select-cdn-managed-certificate.png)

6. Перейдите к [проверке домена](#validate-the-domain).


# <a name="option-2-enable-https-with-your-own-certificatetaboption-2-enable-https-with-your-own-certificate"></a>[Вариант 2. Включение HTTPS с помощью собственного сертификата](#tab/option-2-enable-https-with-your-own-certificate)

> [!IMPORTANT]
> Эта возможность доступна только в профилях **Azure CDN уровня "Стандартный" от Майкрософт**. 
>
 
Для включения функции HTTPS можно использовать собственный сертификат. Этот процесс выполняется путем интеграции с Azure Key Vault, что позволяет безопасно хранить сертификаты. Azure CDN использует этот механизм безопасности, чтобы получить сертификат. При этом вам потребуется выполнить ряд дополнительных действий.

### <a name="prepare-your-azure-key-vault-account-and-certificate"></a>Подготовка учетной записи Azure Key Vault и сертификата
 
1. Azure Key Vault. Вам требуется активная учетная запись Azure Key Vault в той же подписке, что и профиль Azure CDN и конечные точки CDN, для которых нужно включить настраиваемый HTTPS. Если у вас ее еще нет, создайте учетную запись Azure Key Vault.
 
2. Сертификаты Azure Key Vault. Если у вас уже есть сертификат, его можно отправить непосредственно в свою учетную запись Azure Key Vault, или же можно создать новый сертификат непосредственно через Azure Key Vault из одного из партнерских центров сертификации, с которыми интегрируется Azure Key Vault. 

### <a name="register-azure-cdn"></a>Регистрация Azure CDN

Зарегистрируйте Azure CDN как приложение в Azure Active Directory с помощью PowerShell.

1. При необходимости установите [Azure PowerShell](https://www.powershellgallery.com/packages/AzureRM/6.0.0) в PowerShell на локальном компьютере.

2. Выполните следующую команду в PowerShell:

     `New-AzureRmADServicePrincipal -ApplicationId "205478c0-bd83-4e1b-a9d6-db63a3e1e1c8"`

    ![Регистрация Azure CDN в PowerShell](./media/cdn-custom-ssl/cdn-register-powershell.png)
              

### <a name="grant-azure-cdn-access-to-your-key-vault"></a>Предоставление Azure CDN доступа к хранилищу ключей
 
Предоставьте Azure CDN разрешение на доступ к сертификатам (секретам) в учетной записи Azure Key Vault.

1. В своей учетной записи хранилища ключей в разделе "Параметры" выберите **Политики доступа**, а затем — **Добавить**, чтобы создать политику.

    ![Создание политики доступа](./media/cdn-custom-ssl/cdn-new-access-policy.png)

    ![Параметры политики доступа](./media/cdn-custom-ssl/cdn-access-policy-settings.png)

2. В разделе **Выбор субъекта** выполните поиск по запросу **Azure CDN** и выберите этот пункт в результатах.

3. В разделе **Разрешения секретов** выберите **Получить**, чтобы разрешить CDN применять эти разрешения для получения сертификатов и их перечисления. 

4. Нажмите кнопку **ОК**. 

    Теперь у Azure CDN будет доступ к этому хранилищу ключей и сертификатам (секретам), которые в нем хранятся.
 
### <a name="select-the-certificate-for-azure-cdn-to-deploy"></a>Выбор сертификата для развертывания в Azure CDN
 
1. Вернитесь на портал Azure CDN и выберите профиль и конечную точку CDN, где необходимо включить настраиваемый HTTPS. 

2. В списке личных доменов выберите домен, для которого нужно включить протокол HTTPS.

    Откроется страница **Пользовательский домен**.

3. В разделе с типом управления сертификатом выберите **Использовать собственный сертификат**. 

    ![Настройка сертификата](./media/cdn-custom-ssl/cdn-configure-your-certificate.png)

4. Выберите хранилище ключей, сертификат (секрет) и версию сертификата.

    Azure CDN выведет следующие сведения: 
    - учетные записи хранилища ключей для идентификатора подписки; 
    - сертификаты (секреты) в выбранном хранилище ключей; 
    - доступные версии сертификатов. 
 
5. Выберите **Вкл.**, чтобы включить HTTPS.
  
6. При использовании собственного сертификата проверка домена не является обязательной. Переходите к разделу [Ожидание распространения](#wait-for-propagation).

---

## <a name="validate-the-domain"></a>проверка домена;

Если вы уже используете настраиваемый домен, сопоставленный с пользовательской конечной точкой с помощью записи CNAME, или используете собственный сертификат, перейдите к разделу  
[Пользовательский домен сопоставлен с конечной точкой CDN](#custom-domain-is-mapped-to-your-cdn-endpoint-by-a-cname-record). Если же запись CNAME для конечной точки больше не существует или содержит поддомен cdnverify, перейдите к разделу [Пользовательский домен не сопоставлен с конечной точкой CDN](#custom-domain-is-not-mapped-to-your-cdn-endpoint).

### <a name="custom-domain-is-mapped-to-your-cdn-endpoint-by-a-cname-record"></a>Пользовательский домен сопоставлен с конечной точкой CDN с помощью записи CNAME

Добавив настраиваемый домен для конечной точки, вы создали в таблице DNS вашего регистратора домена запись CNAME, которая сопоставляет домен с именем узла конечной точки CDN. Если запись CNAME еще существует и не содержит поддомен cdnverify, центр сертификации DigiCert использует ее для автоматической проверки прав владения доменом. 

При использовании собственного сертификата проверка домена не является обязательной.

Запись CNAME должна иметь указанный ниже формат, где *Name* обозначает пользовательское доменное имя, а *Value* — имя узла конечной точки CDN:

| ИМЯ            | type  | Значение                 |
|-----------------|-------|-----------------------|
| www.contoso.com; | CNAME | contoso.azureedge.net |

Дополнительные сведения о записи CNAME см. в разделе [о создании записи CNAME в DNS](https://docs.microsoft.com/azure/cdn/cdn-map-content-to-custom-domain#create-the-cname-dns-records).

Если запись CNAME имеет правильный формат, DigiCert автоматически подтверждает пользовательское доменное имя и добавляет его к сертификату SAN. DigitCert не будет отправлять писем для подтверждения и вам не нужно подтверждать этот запрос. Сертификат будет действителен в течение одного года, а перед истечением срока действия — автоматически продлеваться. Переходите к разделу [Ожидание распространения](#wait-for-propagation). 

Автоматическая проверка обычно занимает несколько минут. Если после проверки домен не отображается в течение часа, отправьте запрос в службу поддержки.

>[!NOTE]
>Если у поставщика DNS имеется запись авторизации центра сертификации, то она должна включать DigiCert как допустимый ЦС. Запись авторизации ЦС позволяет владельцам доменов указывать своим поставщикам DNS, какие ЦС уполномочены выдавать сертификаты безопасности для их домена. Если ЦС получает заказ на сертификат для домена, который имеет запись авторизации ЦС, и этот ЦС не указан как уполномоченный издатель, тогда этому домену или поддомену запрещается выдавать сертификат безопасности. Сведения об управлении записями авторизации ЦС см. в [этой статье](https://support.dnsimple.com/articles/manage-caa-record/). Средство для работы с записями авторизации ЦС доступно [здесь](https://sslmate.com/caa/).

### <a name="custom-domain-is-not-mapped-to-your-cdn-endpoint"></a>Пользовательский домен не сопоставлен с конечной точкой CDN

Если запись CNAME для конечной точки не существует или содержит поддомен cdnverify, следуйте инструкциям в этом шаге.

При включении HTTPS для личного домена центр сертификации DigiCert (ЦС) проверяет право собственности на ваш домен, связавшись с пользователем, выполнившим регистрацию, в соответствии с информацией в базе данных [WHOIS](http://whois.domaintools.com/) для домена. Контакт осуществляется по электронной почте (по умолчанию) или телефону, указанному в базе данных WHOIS. Чтобы поддержка HTTPS стала активной для личного домена, необходимо выполнить его проверку. Для подтверждения домена у вас есть шесть рабочих дней. Запросы, которые не утверждены в течение шести рабочих дней, будут автоматически отменены. 

![Запись WHOIS](./media/cdn-custom-ssl/whois-record.png)

DigiCert также отправляет письмо для подтверждения на дополнительные адреса электронной почты. Если сведения о регистрируемом пользователе в базе данных WHOIS являются частными, убедитесь, что возможно утверждение непосредственно с одного из этих адресов:

admin@&lt;имя_вашего_домена.com&gt;  
administrator@&lt;имя_вашего_домена.com&gt;  
webmaster@&lt;имя_вашего_домена.com&gt;  
hostmaster@&lt;имя_вашего_домена.com&gt;  
postmaster@&lt;имя_вашего_домена.com&gt;  

Через несколько минут должно появиться электронное сообщение, как показано в следующем примере, с просьбой подтвердить запрос. При использовании фильтра нежелательной почты добавьте admin@digicert.com в список разрешений. Если вы не получите электронное сообщение в течение 24 часов, обратитесь в службу поддержки Майкрософт.
    
![Письмо для подтверждения заказа на сертификат](./media/cdn-custom-ssl/domain-validation-email.png)

При щелчке ссылки для подтверждения запроса откроется следующая онлайн-форма: 
    
![Форма подтверждения для домена](./media/cdn-custom-ssl/domain-validation-form.png)

Следуйте инструкциям в форме. Есть два варианта проверки:

- Можно утвердить все будущие заказы, оформленные с использованием одной и той же учетной записи для одного корневого домена, например contoso.com. Этот подход рекомендуется, если планируется добавлять дополнительные пользовательские домены для одного корневого домена.

- Можно просто утвердить конкретное имя узла, которое используется в данном запросе. Для последующих запросов требуются дополнительные утверждения.

После утверждения DigiCert добавляет имя личного домена в сертификат SAN. Сертификат будет действителен в течение года и автоматически продлен до истечения его срока действия.

## <a name="wait-for-propagation"></a>Ожидание распространения

Активация компонента HTTPS для личного домена после проверки доменного имени может занять до 6–8 часов. Когда процесс будет завершен, состояние пользовательского HTTPS на портале Azure будет иметь значение **Вкл.**, а четыре шага в диалоговом окне пользовательского домена будут отмечены как завершенные. Личный домен готов для использования протокола HTTPS.

![Диалоговое окно "Включить HTTPS"](./media/cdn-custom-ssl/cdn-enable-custom-ssl-complete.png)

### <a name="operation-progress"></a>Ход выполнения операции

В следующей таблице показан ход операции, возникающей при включении HTTPS. После включения HTTPS в диалоговом окне личного домена отобразятся четыре шага операции. По мере активации этих шагов в них появляются вложенные шаги со сведениями о ходе выполнения. Не все из вложенных шагов будут выполняться. После успешного завершения шага рядом с ним появится зеленый флажок. 

| Шаг операции | Сведения о вложенном шаге операции | 
| --- | --- |
| 1. Отправка запроса | Отправка запроса |
| | Отправляется HTTP-запрос. |
| | HTTPS-запрос успешно отправлен. |
| 2. Проверка домена | Домен автоматически проходит проверку, если он сопоставлен с конечной точкой CDN с помощью записи CNAME. В противном случае запрос на проверку будет отправляться на адрес электронной почты, указанный в записи регистрации вашего домена (регистрант WHOIS). Как можно скорее проверьте домен. |
| | Владение доменом успешно подтверждено. |
| | Истек срок действия запроса на подтверждение прав владения доменом (клиент, скорее всего, не ответил в течение 6 дней). HTTPS не будет включен в вашем домене. * |
| | Клиент отклонил запрос на подтверждение прав собственности на домен. HTTPS не будет включен в вашем домене. * |
| 3. Подготовка сертификата | В настоящее время центр сертификации выдает сертификат, необходимый для включения HTTPS в вашем домене. |
| | Сертификат был выдан и в настоящее время развертывается в сеть доставки содержимого. Это может занять до 6 часов. |
| | Сертификат успешно развернут в сети доставки содержимого. |
| 4. Завершение | HTTPS успешно включен для вашего домена. |

\* Это сообщение отображается, только если произошла ошибка. 

Если перед отправкой запроса возникает ошибка, появится следующее сообщение об ошибке:

<code>
We encountered an unexpected error while processing your HTTPS request. Please try again and contact support if the issue persists.
</code>



## <a name="clean-up-resources---disable-https"></a>Очистка ресурсов и отключение HTTPS

Выше объяснялось, как включить протокол HTTPS для личного домена. Если вам больше не нужно использовать личный домен с протоколом HTTPS, его можно отключить, сделав следующее.

### <a name="disable-the-https-feature"></a>Отключение компонента HTTPS 

1. На [портале Azure](https://portal.azure.com) перейдите к своему профилю **Azure CDN уровня "Стандартный" от Майкрософт**, **Azure CDN уровня "Стандартный" от Verizon** или **Azure CDN уровня "Премиум" от Verizon**.

2. В списке конечных точек щелкните ту из них, которая содержит личный домен.

3. Щелкните личный домен, для которого требуется отключить HTTPS.

    ![Список личных доменов](./media/cdn-custom-ssl/cdn-custom-domain-HTTPS-enabled.png)

4. Щелкните **Выкл.**, чтобы отключить HTTPS, а затем нажмите кнопку **Применить**.

    ![Диалоговое окно "Настраиваемый HTTPS"](./media/cdn-custom-ssl/cdn-disable-custom-ssl.png)

### <a name="wait-for-propagation"></a>Ожидание распространения

После отключения компонента HTTPS личного домена для вступления изменений в силу может потребоваться до 6–8 часов. Когда процесс будет завершен, состояние пользовательского HTTPS на портале Azure будет иметь значение **Выкл.**, а три шага в диалоговом окне пользовательского домена будут отмечены как завершенные. Личный домен больше не сможет использовать HTTPS.

![Диалоговое окно "Отключить HTTPS"](./media/cdn-custom-ssl/cdn-disable-custom-ssl-complete.png)

#### <a name="operation-progress"></a>Ход выполнения операции

В следующей таблице показан ход операции, возникающей при отключении HTTPS. После отключения HTTPS в диалоговом окне личного домена отобразятся три шага. По мере того, как каждый шаг становится активным, под ним появляются дополнительные сведения. После успешного завершения шага рядом с ним появится зеленый флажок. 

| Ход выполнения операции | Сведения об операции | 
| --- | --- |
| 1. Отправка запроса | Отправка запроса |
| 2. Отзыв сертификата | Удаление сертификата |
| 3. Завершение | Сертификат удален |

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

1. *Кто является поставщиком сертификата и какой тип сертификата используется?*

    **Azure CDN от Verizon** использует сертификат альтернативного имени субъекта (SAN), предоставленный DigiCert. С помощью одного сертификата SAN можно защитить несколько полных доменных имен. **Azure CDN уровня "Стандартный" от Майкрософт** использует один сертификат, предоставленный DigiCert.

2. Какое подключение TLS/SSL используется: на основе IP-адреса или SNI?

    **Azure CDN от Verizon** использует TLS и SSL на основе IP-адреса. **Azure CDN уровня "Стандартный" от Майкрософт** использует TLS и SSL на основе SNI.

3. *Что делать, если я не получу сообщение электронной почты для проверки домена от DigiCert?*

    Если для личного домена существует запись CNAME, которая указывает на имя узла конечной точки (и в домене не существует поддомен cdnverify), вы не получите письмо с запросом на подтверждение домена. Проверка в этом случае проходит автоматически. Если запись CNAME отсутствует и вы не получили сообщение электронной почты в течение 24 часов, обратитесь в службу поддержки Майкрософт.

4. *Не окажется ли сертификат SAN менее безопасным, чем выделенный сертификат?*
    
    Для сертификата SAN используются те же стандарты безопасности и шифрования, что и для выделенного сертификата. Чтобы дополнительно обезопасить сервер, для всех выданных сертификатов SSL используется алгоритм SHA-256.

5. *Можно ли использовать HTTPS для личного домена с Azure CDN от Akamai?*

    В текущее время эта возможность недоступна в профилях **Azure CDN уровня "Стандартный" от Akamai**. Мы работаем над тем, чтобы в ближайшие месяцы обеспечить ее поддержку.

6. *Нужно ли иметь запись авторизации центра сертификации у моего поставщика DNS?*

    Нет, в настоящее время не требуется запись авторизации центра сертификации. Однако если у вас она есть, она должна включать DigiCert в качестве действительного центра сертификации.


## <a name="next-steps"></a>Дополнительная информация

Из этого руководства вы узнали, как выполнить следующие задачи:

> [!div class="checklist"]
> - включение протокола HTTPS в личном домене;
> - использование сертификата, управляемого CDN; 
> - использование собственного сертификата;
> - проверка домена;
> - отключение протокола HTTPS в личном домене.

Перейдите к следующему руководству, чтобы научиться настраивать кэширование в конечной точке CDN.

> [!div class="nextstepaction"]
> [Tutorial: Set Azure CDN caching rules](cdn-caching-rules-tutorial.md) (Руководство. Настройка правил кэширования Azure CDN)

