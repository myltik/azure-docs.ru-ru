<properties 
	pageTitle="Центры уведомлений Azure — рекомендации по диагностике" 
	description="Рекомендации по диагностике распространенных проблем с центрами уведомлений Azure." 
	services="notification-hubs" 
	documentationCenter="Mobile" 
	authors="wesmc7777" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="notification-hubs" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="NA" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.date="10/27/2015" 
	ms.author="wesmc"/>

#Центры уведомлений Azure — рекомендации по диагностике

##Обзор

Один из наиболее распространенных вопросов, которые мы получаем от клиентов центров уведомлений Azure, — как выяснить, почему уведомление, отправленное из серверной части приложения, не отображается на клиентском устройстве, где и почему уведомление было удалено и как это исправить. В этой статье рассматриваются различные причины, по которым уведомления удаляются и не доходят до устройств. Мы также рассмотрим способы, которые позволят проанализировать и выявить основную причину.

Во-первых, важно понимать, как центры уведомлений Azure отправляют уведомления на устройства.
![][0]

В типичном потоке отправленных уведомлений сообщение отправляется из **серверной части приложения** в **центр уведомлений Azure (NH)**, которой в свою очередь обрабатывает все операции регистрации с учетом настроенных тегов и выражений тегов для определения "целей", т. е. всех операций регистрации, которые должны получить push-уведомление. Эти операции регистрации могут распространяться на любые из поддерживаемых нами платформ - iOS, Google, Windows, Windows Phone, Kindle и Baidu для China Android. После установки целей центр уведомлений отправляет push-уведомления, разделенные по нескольким пакетам регистраций, **службе push-уведомлений (PNS)** конкретной платформы, например APNS для Apple, GCM для Google и т. д. Центр уведомлений выполняет проверку подлинности по соответствующей службе PNS исходя из учетных данных, установленных на странице настройки центра уведомлений классического портала Azure. Затем служба PNS пересылает уведомления на соответствующие **клиентские устройства**. Это рекомендуемый способ доставки push-уведомлений для конкретных платформ. Обратите внимание, что последним звеном доставки уведомлений является доставка между PNS платформы и устройством. Таким образом, у нас есть четыре основных компонента: *клиент*, *серверная часть приложения*, *центры уведомлений Azure (NH)* и *службы push-уведомлений (PNS)*, и любой из этих компонентов может стать причиной удаления уведомлений. Дополнительную информацию об этой архитектуре см. в статье [Обзор центров уведомлений].

Сбой доставки уведомлений может произойти во время начального этапа тестирования или работы в промежуточной среде, что может указывать на проблему конфигурации, или во время работы в рабочей среде, где все или некоторые уведомления могут быть удалены, что указывает на некоторые более серьезные проблемы с приложением или шаблоном обмена сообщениями. В разделе ниже будут рассмотрены различные сценарии удаления уведомлений, начиная с распространенных и заканчивая более редкими. Некоторые из них покажутся очевидным, а другие — не совсем.

##Неправильная настройка центров уведомлений Azure 

Центры уведомлений Azure должны проходить аутентификацию в контексте приложения разработчика, чтобы успешно отправлять уведомления в соответствующую службу PNS. Для этого разработчику необходимо создать учетную запись разработчика с соответствующей платформой (Google, Apple, Windows и т. д.) и затем зарегистрировать свое приложение, где он получает учетные данные, которые необходимо настроить на портале в разделе настройки центров уведомлений. Если уведомления не доходят, сначала следует убедиться, что в центре уведомлений настроены правильные учетные данные, сопоставив их с данными приложения, созданного в учетной записи разработчика для конкретной платформы. [Учебники по началу работы] помогут вам шаг за шагом пройти этот процесс. Ниже приведены некоторые распространенные сценарии неправильной настройки.

1. **Общие сведения**
 
	а. Убедитесь, что имя центра уведомлений (без опечаток) соответствует:

	- имени в месте регистрации из клиентского устройства; 
	- имени в месте отправки уведомлений из серверной части;  
	- имени в месте настройки учетных данных PNS; 
	- имени центра уведомлений, учетные данные SAS которого настроены на клиентском устройстве и в серверной части. 
		
	б. Убедитесь, что вы используете правильные строки конфигурации SAS на клиентском устройстве и в серверной части приложения. Как правило, необходимо использовать **DefaultListenSharedAccessSignature** на клиентском устройстве и **DefaultFullSharedAccessSignature** в серверной части приложения (что предоставляет разрешение для отправки уведомлений в центр уведомлений).

2. **Конфигурация службы push-уведомлений Apple (APNS)**
 
	Необходимо использовать два разных центра - один для рабочей среды и другой для тестирования. Это означает, что следует отправлять сертификат, который будет использоваться в изолированной среде, и сертификат, который будет использоваться в рабочей среде, в отдельные центры. Не отправляйте сертификаты разных типов в один и тот же центр, так как это может вызвать сбои уведомлений при их отправке. Если вы случайно отправили сертификаты разных типов в один и тот же центр, мы советуем удалить этот центр и начать все заново. Если по какой-либо причине вам не удается удалить центр, по крайней мере, удалите из него все существующие регистрации.

3. **Конфигурация Google Cloud Messaging (GCM)**

	а. Убедитесь, что в облачном проекте включен параметр "Google Cloud Messaging для Android".
	
	![][2]
	
	б. Убедитесь, что вы выбрали для создания вариант "Ключ сервера" при получении учетных данных, которые центр уведомлений использует для аутентификации в GCM.
	
	![][3]
	
	в. Убедитесь, что вы настроили "Идентификатор проекта" для клиентского устройства. Он является полностью числовой сущностью, которую можно получить на панели мониторинга:
	
	![][1]

##Проблемы с приложением

1) **Теги и выражения тегов**

При использовании тегов или выражений тегов для сегментирования аудитории возможна ситуация, когда при отправке уведомления не удается найти цель на основе тегов и выражений тегов, указанных в вызове отправки. В таком случае при отправке уведомлений мы советуем просмотреть регистрации, чтобы убедиться в наличии совпадающих тегов, и убедиться, что уведомления отправляются только от клиентов с этими регистрациями. Например, если все ваши регистрации с помощью центра уведомлений выполнены с использованием тега «Политика», в случае отправки уведомления с тегом «Спорт», оно не отправится ни на одно устройство. В более сложном случае могут использоваться выражения тегов. Например, вы выполнили регистрацию, указав «Тег A» или «Тег Б», но во время отправки уведомлений используете «Тег А && тег Б». В приведенном ниже разделе советов по самостоятельной диагностике приведены способы, которые вы можете использовать, чтобы просмотреть регистрации и использованные в них теги.

2) **Проблемы с шаблонами**

В случае использования шаблонов убедитесь, что вы следуете рекомендациям, описанным в [Руководстве по использованию шаблонов].

3) **Недопустимые регистрации**

Предполагается, что центр уведомлений настроен правильно, а также, что все теги и выражения тегов использованы правильно, в результате чего найдены допустимые цели, которым необходимо отправить уведомления. В таком случае центр уведомлений параллельно запускает несколько пакетов обработки — каждый пакет отправляет сообщения набору регистраций.

> [AZURE.NOTE]Так как обработка выполняется параллельно, мы не гарантируем, что уведомления будут доставлены по порядку.

Теперь центр уведомлений Azure оптимизирован для модели доставки сообщений «не более одного». Это значит, что мы пытаемся выполнить дедупликацию так, чтобы уведомления доставлялись на устройство по одному разу. Для этого прежде чем отправить сообщение непосредственно в службу PNS, мы просматриваем регистрации, чтобы убедиться, что на каждый идентификатор устройства отправлено только одно сообщение. Каждый пакет отправляется в PNS, которая, в свою очередь, принимает и проверяет регистрации. PNS может обнаружить ошибку одной или нескольких регистраций в пакете. Тогда она возвращает ошибку в центр уведомлений Azure и прекращает обработку, тем самым полностью удаляя такой пакет. Это касается в особенности APNS, которая использует протокол потока TCP. Так как мы оптимизировали доставку с помощью модели «не более одного», следует отметить, что для пакета со сбоем не выполняется повторная попытка передачи, ведь нам не известно точно, как PNS удаляет пакет — полностью или частично. Тем не менее, PNS сообщает в центр уведомлений Azure о том, какая регистрация стала причиной сбоя, после чего на основе отзыва мы удаляем эту регистрацию из нашей базы данных. Из этого следует, что, возможно, один пакет регистраций или его часть не получит уведомление. Тем не менее, так как мы удалили поврежденную регистрацию, при следующей попытке отправки ее успех будет более вероятным. Так как количество целевых устройств увеличивается (некоторые из наших клиентов отправляют уведомление на миллионы устройств), нечастое удаление того или иного нечетного пакета не сильно влияет на общий процент устройств, получающих уведомления. Тем не менее, если вы отправите несколько уведомлений и возникнут какие-либо ошибки PNS, возможно, большинство или ни одно из уведомлений не будет получено. Если такие случаи повторяются, необходимо определить любые поврежденные регистрации и удалить их. Любые регистрации, созданные вручную, следует удалять, так как они чаще всего приводят к удалению уведомлений. При работе в тестовой среде все регистрации можно также удалить напрямую, так как приложения, будучи открытыми на устройствах, попытаются заново отправить уведомление и повторно зарегистрироваться с помощью центра уведомлений, чтобы убедиться, что все существующие регистрации, создаваемые впоследствии, будут допустимыми.

##Проблемы со службой PNS

После получения уведомления соответствующая служба PNS отвечает за его доставку на устройство. На этом этапе от центров уведомлений Azure больше ничего не зависит, и они не могут контролировать время доставки и то, будет ли уведомление доставлено на устройство. Так как службы уведомлений платформы довольно надежны, как правило, уведомления доходят из PNS до устройства за несколько секунд. Однако если PNS регулирует доставку, центры уведомлений Azure применяют стратегию экспоненциальной задержки, и если PNS недоступна в течение 30 минут, применяется политика, управляющая истечением срока действия и окончательным удалением этих сообщений.

Если PNS пытается доставить уведомление на устройство, находящееся в автономном режиме, она хранит уведомление ограниченный период времени и доставляет его на устройство, когда оно становится доступным. Хранится только одно последнее уведомление для конкретного приложения. Если при пребывании устройства в автономном режиме отправляется несколько уведомлений, отправка каждого нового уведомления приводит к предварительному удалению предыдущего. Такое поведение, при котором сохраняются только последние уведомления, называется объединением уведомлений в APNS и разъединением в GCM (с использованием ключа разъединения). Если устройство находится в автономном режиме в течение длительного времени, уведомления, сохраненные для него, удаляются.
Источник — [руководство по APNS] и [руководство по GCM].

С помощью центров уведомлений Azure вы можете передать ключ объединения через заголовок HTTP, используя универсальный интерфейс API `SendNotification` (например, для пакета SDK для.NET — `SendNotificationAsync`), также принимающий заголовки HTTP, которые передаются как есть в соответствующую службу PNS.

##Советы по самостоятельной диагностике

Здесь будут рассмотрены различные способы диагностики и определения главной причины проблем центра уведомлений.

###Проверка учетных данных

1. **Портал разработчиков PNS**

	Проверьте их на соответствующем портале разработчиков PNS (APNS, GCM, WNS и т. д), используя наши [учебники по началу работы].

2. **Классический портал Azure**

	Перейдите на вкладку «Настройка», чтобы просмотреть и сопоставить учетные данные с данными, полученными на портале разработчиков PNS.

	![][4]

###Проверка регистраций

1. **Visual Studio**

	При использовании Visual Studio для разработки вы можете подключиться к Microsoft Azure и просматривать множество различных служб Azure, включая центры уведомлений, а также управлять ими из обозревателя серверов. Это особенно удобно при работе в среде разработки или тестирования.

	![][9]

	В центре можно просматривать все регистрации, а также управлять ими. Они удобно классифицированы по таким категориям, как платформы, собственная или шаблонная регистрация, теги, PNS-идентификаторы, идентификаторы регистрации и сроки действия. Вы также можете изменять регистрации в режиме реального времени, что очень удобно, например, если нужно изменить теги.

	![][8]
 
	> [AZURE.NOTE]Функцию изменения регистраций Visual Studio следует использовать только при разработке или тестировании для ограниченного числа регистраций. Если возникает необходимость массовой правки регистраций, можно воспользоваться функцией экспорта и импорта регистраций, описанной здесь: [Экспорт и импорт регистраций](https://msdn.microsoft.com/library/dn790624.aspx).

2. **Обозреватель служебной шины**

	Многие клиенты используют обозреватель ServiceBus, описанный в разделе [Обозреватель ServiceBus], для просмотра центра уведомлений и управления им. Это проект с открытым исходным кодом, который доступен на странице code.microsoft.com — [Код обозревателя ServiceBus]

###Проверка уведомлений о сообщениях

1. **Классический портал Azure**

	Вы можете перейти на вкладку «Отладка», чтобы отправить клиентам тестовые уведомления без необходимости запуска серверной части службы.

	![][7]

2. **Visual Studio**

	Тестовые уведомления также можно отправлять с помощью Visual Studio.

	![][10]

	Дополнительную информацию о функциях обозревателя Azure центра уведомлений Visual Studio см. здесь:
	
	- [Обзор обозревателя сервера VS]
	- [Запись блога об обозревателе сервера VS — 1]
	- [Запись блога об обозревателе сервера VS — 2]

###Уведомления о сбоях отладки и просмотр результатов уведомлений

**Свойство EnableTestSend**

При отправке уведомления с помощью центра уведомлений сначала оно ставится в очередь, чтобы центр уведомлений выполнил обработку для определения всех его целей, а затем отправляется в PNS. При использовании REST API или любого клиентского пакета SDK удачное возвращение вызова отправки означает только то, что центр уведомлений успешно поставил сообщение в очередь. Из этого не понятно, что происходит после отправки сообщения из центра уведомлений в PNS. Если ваше уведомление не дошло до клиентского устройства, возможно, во время попытки центра уведомлений доставить сообщение в PNS произошла ошибка (например, размер полезных данных превысил максимально допустимый размер таких данных в PNS, настроенные в центре уведомлений учетные данные являются недопустимыми и т. д.).
Мы ввели свойство с именем [функция EnableTestSend], которое позволяет просмотреть информацию об ошибках PNS. Оно автоматически включается при отправке тестового сообщения с портала или клиентского приложения Visual Studio и таким образом позволяет просматривать подробную отладочную информацию. Это свойство можно использовать с помощью интерфейса API, например, в пакете SDK для .NET, где оно сейчас доступно. Со временем это свойство будет добавлено во все клиентские пакеты SDK. Чтобы использовать это свойство с вызовом REST, просто добавьте параметр строки запроса с именем test в конце вызова отправки, например:

	https://mynamespace.servicebus.windows.net/mynotificationhub/messages?api-version=2013-10&test

*Пример (пакет SDK для .NET)*
 
Предположим, что вы используете пакет SDK для .NET для отправки собственного всплывающего уведомления:

    NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName);
    var result = await hub.SendWindowsNativeNotificationAsync(toast);
    Console.WriteLine(result.State);
 
В конце выполнения для параметра `result.State` будет просто установлено значение `Enqueued` без предоставления информации о вашем push-уведомлении. Теперь можно использовать логическое свойство `EnableTestSend` при инициализации `NotificationHubClient`, а также получать подробную информацию об ошибках PNS, возникших при отправке уведомлений. Для возврата вызова отправки потребуется дополнительное время, так как он выполняется только после доставки уведомления из концентратора уведомлений в PNS для определения результата.
 
	bool enableTestSend = true;
	NotificationHubClient hub = NotificationHubClient.CreateClientFromConnectionString(connString, hubName, enableTestSend);
	
	var outcome = await hub.SendWindowsNativeNotificationAsync(toast);
	Console.WriteLine(outcome.State);
	
	foreach (RegistrationResult result in outcome.Results)
	{
	    Console.WriteLine(result.ApplicationPlatform + "\n" + result.RegistrationId + "\n" + result.Outcome);
	}

*Пример выходных данных*

    DetailedStateAvailable
    windows
    7619785862101227384-7840974832647865618-3
    The Token obtained from the Token Provider is wrong
 
Это сообщение указывает на то, что в центре уведомлений настроены недопустимые учетные данные или возникла проблема с регистрацией. В таком случае прежде чем отправлять сообщение, рекомендуется удалить эту регистрацию и дать клиенту создать ее заново.
 
> [AZURE.NOTE]Обратите внимание, что использование этого свойства строго регулируется, и поэтому его необходимо использовать только в среде разработки или тестирования с ограниченным набором регистраций. Мы отправляем уведомления об отладке только на 10 устройств. Кроме этого, у нас есть ограничения на количество обрабатываемых уведомлений об отладке — 10 в минуту.

###Просмотр телеметрии 

1. **Использование классического портала Azure**

	Портал предоставляет краткий обзор всех операций, выполняемых в центре уведомлений.
	
	а. На вкладке "панель мониторинга" можно просмотреть общее представление операций регистрации, уведомлений и ошибок на каждую платформу.
	
	![][5]
	
	б. Вы также можете добавить множество других метрик для конкретных платформ на вкладке "Монитор", чтобы более подробно рассмотреть ошибки, в частности ошибки, касающиеся PNS, которые возвращаются, когда центр уведомлений предпринимает попытку отправить уведомление PNS.
	
	![][6]
	
	в. Следует начать с просмотра **входящих сообщений**, **операций регистрации** и **доставленных уведомлений**, а затем перейти на вкладку с данными для каждой платформы, чтобы просмотреть ошибки, касающиеся PNS.
	
	г. Если для центра уведомлений настроены неправильные параметры аутентификации, будет получена ошибка аутентификации PNS. Это сигнализирует о том, что следует проверить учетные данные PNS.

2\. **Программный доступ**

Дополнительную информацию см. здесь:

- [Программный доступ к телеметрии]
- [Доступ к телеметрии с помощью образца API] 

> [AZURE.NOTE]Несколько функций, связанных с телеметрией, например **экспорт и импорт регистраций**, **доступ к телеметрии с помощью API** и т. д., доступны только для уровня Standard. При попытке использовать эти функции для уровня Free или Basic, используя пакет SDK, отобразится сообщение об исключении, касающееся этого нарушения, а в случае их использования непосредственно из интерфейсов REST API — ошибка «HTTP 403 (запрещено)». Убедитесь, что вы достигли уровня Standard на классическом портале Azure.

<!-- IMAGES -->
[0]: ./media/notification-hubs-diagnosing/Architecture.png
[1]: ./media/notification-hubs-diagnosing/GCMConfigure.png
[2]: ./media/notification-hubs-diagnosing/GCMEnable.png
[3]: ./media/notification-hubs-diagnosing/GCMServerKey.png
[4]: ./media/notification-hubs-diagnosing/PortalConfigure.png
[5]: ./media/notification-hubs-diagnosing/PortalDashboard.png
[6]: ./media/notification-hubs-diagnosing/PortalMonitoring.png
[7]: ./media/notification-hubs-diagnosing/PortalTestNotification.png
[8]: ./media/notification-hubs-diagnosing/VSRegistrations.png
[9]: ./media/notification-hubs-diagnosing/VSServerExplorer.png
[10]: ./media/notification-hubs-diagnosing/VSTestNotification.png
 
<!-- LINKS -->
[Обзор центров уведомлений]: notification-hubs-overview.md
[Учебники по началу работы]: notification-hubs-windows-store-dotnet-get-started.md
[учебники по началу работы]: notification-hubs-windows-store-dotnet-get-started.md
[Руководстве по использованию шаблонов]: https://msdn.microsoft.com/library/dn530748.aspx
[руководство по APNS]: https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html#//apple_ref/doc/uid/TP40008194-CH100-SW4
[руководство по GCM]: http://developer.android.com/google/gcm/adv.html
[Export/Import Registrations]: http://msdn.microsoft.com/library/dn790624.aspx
[Обозреватель ServiceBus]: http://msdn.microsoft.com/library/dn530751.aspx
[Код обозревателя ServiceBus]: https://code.msdn.microsoft.com/windowsazure/Service-Bus-Explorer-f2abca5a
[Обзор обозревателя сервера VS]: http://msdn.microsoft.com/library/windows/apps/xaml/dn792122.aspx
[Запись блога об обозревателе сервера VS — 1]: http://azure.microsoft.com/blog/2014/04/09/deep-dive-visual-studio-2013-update-2-rc-and-azure-sdk-2-3/#NotificationHubs
[Запись блога об обозревателе сервера VS — 2]: http://azure.microsoft.com/blog/2014/08/04/announcing-release-of-visual-studio-2013-update-3-and-azure-sdk-2-4/
[функция EnableTestSend]: http://msdn.microsoft.com/library/microsoft.servicebus.notifications.notificationhubclient.enabletestsend.aspx
[Программный доступ к телеметрии]: http://msdn.microsoft.com/library/azure/dn458823.aspx
[Доступ к телеметрии с помощью образца API]: https://github.com/Azure/azure-notificationhubs-samples/tree/master/FetchNHTelemetryInExcel

 

<!---HONumber=AcomDC_1210_2015-->
