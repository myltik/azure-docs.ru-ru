---
title: Руководство по проектированию реплицированных таблиц — хранилище данных SQL Azure | Документы Майкрософт
description: Рекомендации по проектированию реплицированных таблиц в схеме хранилища данных SQL Azure.
services: sql-data-warehouse
author: ronortloff
manager: craigg-msft
ms.service: sql-data-warehouse
ms.topic: conceptual
ms.component: implement
ms.date: 04/23/2018
ms.author: rortloff
ms.reviewer: igorstan
ms.openlocfilehash: 1cc796061056ff017e3d778ebb2e50e13d55a4c1
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2018
ms.locfileid: "32189570"
---
# <a name="design-guidance-for-using-replicated-tables-in-azure-sql-data-warehouse"></a>Руководство по проектированию для использования реплицированных таблиц в хранилище данных SQL Azure
В данной статье представлены рекомендации по проектированию реплицированных таблиц в схеме хранилища данных SQL Azure. Данные рекомендации позволяют повысить производительность запросов за счет уменьшения перемещения данных и упрощения запросов.

## <a name="prerequisites"></a>предварительным требованиям
В этой статье предполагается, что вы знакомы с распределением данных и основными понятиями перемещения данных в хранилище данных SQL.  Дополнительные сведения см. в статье об [архитектуре](massively-parallel-processing-mpp-architecture.md). 

При проектировании таблиц необходимо максимально четко понять, как устроены данные и как выполняются запросы к данным.  Например, для этого можно использовать следующие вопросы:

- Каков размер таблицы?   
- Как часто она обновляется?   
- Имеются ли в хранилище данных таблицы фактов и таблицы измерений?   

## <a name="what-is-a-replicated-table"></a>Что такое реплицированная таблица?
Реплицированная таблица содержит полную копию таблицы, которая доступна на каждом вычислительном узле. Репликация таблицы устраняет необходимость передавать данные между вычислительными узлами перед операциями соединения или агрегирования. Поскольку в таблице имеется несколько копий, реплицированные таблицы наиболее эффективны, когда размер таблицы в сжатом состоянии менее 2 ГБ.

На схеме ниже показана реплицированная таблица, которая доступна на каждом вычислительном узле. Для хранилища данных SQL реплицируемая таблица полностью копируется в базу данных распространителя на каждом вычислительном узле. 

![Реплицируемая таблица](media/guidance-for-using-replicated-tables/replicated-table.png "Реплицируемая таблица")  

Реплицированные таблицы отлично подходят для небольших таблиц измерения в схеме типа "звезда". Размер таблицы измерений обычно таков, что позволяет хранить и поддерживать несколько копий. В измерениях хранятся описательные данные, которые изменяются редко, например имя и адрес клиента, а также сведения о продукте. Такое свойство данных способствует тому, что перестроение реплицированной таблицы также происходит реже. 

Реплицированные таблицы подходят в ситуациях, когда:

- Размер таблицы на диске менее 2 ГБ, независимо от количества строк. Чтобы определить размер таблицы, можно использовать команду [DBCC PDW_SHOWSPACEUSED](https://docs.microsoft.com/sql/t-sql/database-console-commands/dbcc-pdw-showspaceused-transact-sql): `DBCC PDW_SHOWSPACEUSED('ReplTableCandidate')`. 
- Таблица используется в соединениях, для которых в противном случае требуется перемещение данных. При соединении таблиц, которые не распределены по одному и тому же столбцу, например при объединении хэш-распределенной таблицы с таблицу с распределением методом циклического перебора, для выполнения запроса требуется перемещение данных.  Если одна из таблиц достаточно мала, рассмотрите возможность использования реплицированной таблицы. В большинстве случаев вместо таких таблиц рекомендуется использовать реплицированные таблицы. Чтобы просмотреть операции перемещения данных в планах запросов, используйте [sys.dm_pdw_request_steps](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-pdw-request-steps-transact-sql).  BroadcastMoveOperation является типичной операцией перемещения данных, которую можно устранить, используя реплицированную таблицу.  
 
Реплицированные таблицы не гарантируют лучшую производительность, когда:

- Таблица содержит частые операции вставки, обновления и удаления. Эти операции языка обработки данных (DML) требуют перестроения реплицированной таблицы. Зачастую перестроение приводит к снижению производительности.
- Хранилище данных масштабируется достаточно часто. В ходе масштабирования хранилища данных изменяется количество вычислительных узлов, что влечет за собой повторное построение.
- Таблица содержит много столбцов, однако операции с данными обычно обращаются только к небольшому числу столбцов. В этом случае вместо репликации всей таблицы лучше всего использовать распределение таблицы, а затем создать индекс для часто используемых столбцов. Если запрос требует перемещения данных, хранилище данных SQL перемещает только данные для запрошенных столбцов. 

## <a name="use-replicated-tables-with-simple-query-predicates"></a>Использование реплицированных таблиц с предикатами простого запроса
Прежде чем выбрать распространение или репликацию таблицы, выберите типы запросов, которые планируется выполнять к таблице. Когда это возможно:

- Используйте реплицированные таблицы для запросов с предикатами простого запроса, например равенства или неравенства.
- Используйте распределенные таблицы для запросов с предикатами сложного запроса, например LIKE или NOT LIKE.

Ресурсоемкие запросы лучше всего использовать в случаях, когда работа распределяется по всем вычислительным узлам. Например, запросы, которые запускают вычисления для каждой строки таблицы, выполняются более эффективно в распределенных таблицах, чем реплицированных. Поскольку реплицированные таблицы хранятся в полном объеме на каждом вычислительном узле, ресурсоемкие запросы к реплицированной таблице применяются ко всей таблице на каждом вычислительном узле. Лишние вычисления могут снизить производительность запроса.

Например, в этом запросе содержится сложный предикат.  Он выполняется быстрее, когда в качестве поставщика выступает распределенная таблица вместо реплицированной таблицы. В этом примере поставщик может использовать распределение методом циклического перебора.

```sql

SELECT EnglishProductName 
FROM DimProduct 
WHERE EnglishDescription LIKE '%frame%comfortable%'

```

## <a name="convert-existing-round-robin-tables-to-replicated-tables"></a>Преобразование существующих циклических таблиц в реплицированные таблицы
Если имеются циклические таблицы, их рекомендуется преобразовать в реплицированные таблицы, если они удовлетворяют критериям, обозначенным в этой статье. Реплицированные таблицы эффективнее по сравнению с циклическими таблицами, поскольку они исключают необходимость в перемещении данных.  Для соединений в циклической таблице всегда требуется перемещение данных. 

В этом примере используется функция [CTAS](/sql/t-sql/statements/create-table-as-select-azure-sql-data-warehouse) для изменения таблицы DimSalesTerritory в реплицированную таблицу. В данном примере неважно, была ли таблица DimSalesTerritory хэш-распределена или распределена методом циклического перебора.

```sql
CREATE TABLE [dbo].[DimSalesTerritory_REPLICATE]   
WITH   
  (   
    CLUSTERED COLUMNSTORE INDEX,  
    DISTRIBUTION = REPLICATE  
  )  
AS SELECT * FROM [dbo].[DimSalesTerritory]
OPTION  (LABEL  = 'CTAS : DimSalesTerritory_REPLICATE') 

--Create statistics on new table
CREATE STATISTICS [SalesTerritoryKey] ON [DimSalesTerritory_REPLICATE] ([SalesTerritoryKey]);
CREATE STATISTICS [SalesTerritoryAlternateKey] ON [DimSalesTerritory_REPLICATE] ([SalesTerritoryAlternateKey]);
CREATE STATISTICS [SalesTerritoryRegion] ON [DimSalesTerritory_REPLICATE] ([SalesTerritoryRegion]);
CREATE STATISTICS [SalesTerritoryCountry] ON [DimSalesTerritory_REPLICATE] ([SalesTerritoryCountry]);
CREATE STATISTICS [SalesTerritoryGroup] ON [DimSalesTerritory_REPLICATE] ([SalesTerritoryGroup]);

-- Switch table names
RENAME OBJECT [dbo].[DimSalesTerritory] to [DimSalesTerritory_old];
RENAME OBJECT [dbo].[DimSalesTerritory_REPLICATE] TO [DimSalesTerritory];

DROP TABLE [dbo].[DimSalesTerritory_old];
```  

### <a name="query-performance-example-for-round-robin-versus-replicated"></a>Пример производительности запросов для циклической и реплицированной таблиц 

Поскольку вся таблица уже существует на каждом вычислительном узле, для реплицированной таблицы не требуется перемещать данные для соединений. Если таблицы измерений распределены методом циклического перебора, соединение копирует таблицу измерения в полном объеме на каждом вычислительном узле. Чтобы переместить данные, план запроса содержит операцию, которая называется BroadcastMoveOperation. Операции перемещения данных данного типа снижают производительность запросов. Устранить это можно с помощью реплицированных таблиц. Чтобы просмотреть действия плана запроса, используйте представление системного каталога [sys.dm_pdw_request_steps](/sql/relational-databases/system-dynamic-management-views/sys-dm-pdw-request-steps-transact-sql). 

Например, в следующем запросе к схеме AdventureWorks таблица ` FactInternetSales` хэш-распределена. Таблицы `DimDate` и `DimSalesTerritory` являются таблицами измерений меньшего размера. Этот запрос возвращает общий объем продаж в Северной Америке за 2004 финансовый год:
 
```sql
SELECT [TotalSalesAmount] = SUM(SalesAmount)
FROM dbo.FactInternetSales s
INNER JOIN dbo.DimDate d
  ON d.DateKey = s.OrderDateKey
INNER JOIN dbo.DimSalesTerritory t
  ON t.SalesTerritoryKey = s.SalesTerritoryKey
WHERE d.FiscalYear = 2004
  AND t.SalesTerritoryGroup = 'North America'
```
Мы повторно создали таблицы `DimDate` и `DimSalesTerritory` как циклические таблицы. В результате запрос показал следующий план запроса, в котором имеется несколько операций широковещательного переноса: 
 
![План запроса с циклическим перебором](media/design-guidance-for-replicated-tables/round-robin-tables-query-plan.jpg) 

Мы повторно создали таблицы `DimDate` и `DimSalesTerritory` как в реплицированные таблицы, а затем снова выполнили запрос. Результирующий план запроса намного короче, а также в нем нет широковещательного переноса.

![План запроса с репликацией](media/design-guidance-for-replicated-tables/replicated-tables-query-plan.jpg) 


## <a name="performance-considerations-for-modifying-replicated-tables"></a>Рекомендации по повышению производительности для изменения реплицированных таблиц
Хранилище данных SQL реализует реплицированную таблицу путем сохранения главной версии таблицы. Для этого оно копирует главную версию в одну базу данных распространителя на каждый вычислительный узел. При наличии изменений хранилище данных SQL обновляет сначала главную таблицу. Затем оно перестраивает таблицы на каждом вычислительном узле. Перестроение реплицированной таблицы включает в себя копирование таблицы на каждый вычислительный узел и последующее перестроение индексов.  Например, у реплицированной таблицы на DW400 имеются 5 копий данных.  Мастер-копия и полные копии на каждом вычислительном узле.  Все данные хранятся в базах данных распространителя. Хранилище данных SQL использует эту модель для поддержки более быстрых инструкций изменения данных и гибких операций масштабирования. 

Перестроение требуется после следующего:
- Загрузка или изменение данных
- Масштабирование хранилища данных с использованием другого уровня обслуживания.
- Обновление определения таблицы

Перестроение не требуется после следующего:
- Выполнение операции приостановки
- Выполнение операции возобновления

Перестроение не происходит сразу после изменения данных. Вместо этого оно выполняется при первом выборе запросом данных из таблицы.  Запрос, который активирует перестроение, немедленно считывает данные из основной версии таблицы, пока данные асинхронно копируются на каждый вычислительный узел. До завершения копирования данных последующие запросы будут использовать основную версию таблицы.  В случае, если возникает какое-либо действие с реплицированной таблицей, которое вызывает дополнительное перестроение, копирование данных становится недействительным и следующая инструкция SELECT активирует повторное копирование данных. 

### <a name="use-indexes-conservatively"></a>Консервативный подход к использованию индексов
В отношении реплицированных таблиц применяется стандартный подход к индексированию. В процессе перестроения хранилище данных SQL перестраивает индекс каждой реплицированной таблицы. Индексы следует использовать только в том случае, если для повышения производительности целесообразно перестроить индексы.  
 
### <a name="batch-data-loads"></a>Пакетная загрузка данных
При загрузке данных в реплицированные таблицы попробуйте минимизировать перестроения путем пакетной загрузки. Выполните все пакетные загрузки перед выполнением инструкции SELECT.

Например, ниже представлен шаблон загрузки данных из четырех источников и запуска четырех операций перестроения. 

- Загрузка из источника 1.
- Инструкция SELECT вызывает перестроение 1.
- Загрузка из источника 2.
- Инструкция SELECT вызывает перестроение 2.
- Загрузка из источника 3.
- Инструкция SELECT вызывает перестроение 3.
- Загрузка из источника 4.
- Инструкция SELECT вызывает перестроение 4.

Например, ниже представлен шаблон загрузки данных из четырех источников и запуска только одной операции перестроения.

- Загрузка из источника 1.
- Загрузка из источника 2.
- Загрузка из источника 3.
- Загрузка из источника 4.
- Инструкция SELECT вызывает перестроение.


### <a name="rebuild-a-replicated-table-after-a-batch-load"></a>Перестроение реплицированной таблицы после пакетной загрузки
Чтобы обеспечить согласованное время выполнение запросов, рекомендуется принудительно перестроить реплицированные таблицы после пакетной загрузки. В противном случае для выполнения первого запроса по-прежнему будет использоваться перемещение данных. 

В этом запросе используется динамическое административное представление [sys.pdw_replicated_table_cache_state](/sql/relational-databases/system-catalog-views/sys-pdw-replicated-table-cache-state-transact-sql) для отображения реплицированных таблиц, которые были изменены, но не перестроены.

```sql 
SELECT [ReplicatedTable] = t.[name]
  FROM sys.tables t  
  JOIN sys.pdw_replicated_table_cache_state c  
    ON c.object_id = t.object_id 
  JOIN sys.pdw_table_distribution_properties p 
    ON p.object_id = t.object_id 
  WHERE c.[state] = 'NotReady'
    AND p.[distribution_policy_desc] = 'REPLICATE'
```
 
Чтобы активировать перестроение, выполните следующую инструкцию для каждой таблицы в предыдущих выходных данных. 

```sql
SELECT TOP 1 * FROM [ReplicatedTable]
``` 
 
## <a name="next-steps"></a>Дополнительная информация 
Чтобы создать реплицированную таблицу, воспользуйтесь одной из следующих инструкций:

- [CREATE TABLE (хранилище данных Azure SQL)](/sql/t-sql/statements/create-table-azure-sql-data-warehouse)
- [CREATE TABLE AS SELECT (хранилище данных SQL Azure)](/sql/t-sql/statements/create-table-as-select-azure-sql-data-warehouse)

Обзор распределенных таблиц см. в разделе [Распределенные таблицы](sql-data-warehouse-tables-distribute.md).



