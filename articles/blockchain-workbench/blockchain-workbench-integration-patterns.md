---
title: Шаблоны интеграции смарт-контрактов в Azure Blockchain Workbench
description: Общие сведения о шаблонах интеграции смарт-контрактов в Azure Blockchain Workbench.
services: azure-blockchain
keywords: ''
author: PatAltimore
ms.author: patricka
ms.date: 5/1/2018
ms.topic: article
ms.service: azure-blockchain
ms.reviewer: mmercuri
manager: femila
ms.openlocfilehash: 0fe4816dbafc28974796c7d9cd307b04fdb9d6d4
ms.sourcegitcommit: e221d1a2e0fb245610a6dd886e7e74c362f06467
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2018
---
# <a name="smart-contract-integration-patterns"></a>Шаблоны интеграции смарт-контрактов

Смарт-контракты часто представляют бизнес-процесс, который нужно интегрировать во внешние системы и устройства.

Эти рабочие процессы требуют инициализации транзакций в распределенном реестре, содержащем данные из внешней системы, службы или устройства. Им также нужны реакции внешних систем на события, инициированные смарт-контрактами, в распределенном реестре.

REST API и интеграция службы сообщений позволяют передавать транзакции из внешних систем в смарт-контракты, включенные в приложение Azure Blockchain Workbench, а также отправлять во внешние системы уведомления о событиях, связанных с изменениями, происходящими в приложении.

Для сценариев интеграции данных Azure Blockchain Workbench содержит ряд представлений базы данных, объединяющих транзакционные данные блокчейна с метаданными о приложениях и смарт-контрактах.

Кроме того, в некоторых сценариях, связанных с цепочками поставок или носителями, может потребоваться интеграция документов. Хотя Azure Blockchain Workbench не обеспечивает вызовов API, необходимых для непосредственной обработки документов, документы, тем не менее, могут быть включены в приложение Azure Blockchain. В этом разделе также содержится такой шаблон.

Этот раздел содержит шаблоны, предназначенные для реализации каждого из этих типов интеграции в комплексных решениях.

## <a name="rest-api-based-integration"></a>Интеграция на основе REST API

Возможности созданного Azure Blockchain Workbench веб-приложения предоставляется посредством REST API. Сюда относятся передача Azure Blockchain Workbench, настройка и администрирование приложений, передача транзакций в распределенный реестр, передача запросов на метаданные приложений и данных реестра.

Интерфейс REST API используется в основном для интерактивных клиентов, таких как веб-приложения, мобильные приложения и боты.

В этом разделе рассматриваются шаблоны REST API, отправляющие транзакции в распределенный реестр, а также те, которые запрашивают данные о транзакциях из хранящейся *вне блокчейна* базы данных SQL в Azure Blockchain Workbench.

### <a name="sending-transactions-to-a-distributed-ledger-from-an-external-system"></a>Отправка транзакций в распределенный реестр из внешней системы

Интерфейс REST API Azure Blockchain Workbench предоставляет возможность отправлять аутентифицированные запросы на выполнение транзакций в распределенном реестре.

![Отправка транзакций в распределенный реестр](media/blockchain-workbench-integration-patterns/send-transactions-ledger.png)

В вышеописанном процессе, где происходит следующее:

-   Внешнее приложение аутентифицируется в Azure Active Directory в составе развернутой среды Azure Blockchain Workbench.
-   Авторизованные пользователи получают токен носителя, который может быть отправлен вместе с запросом к API.
-   Внешние приложения выполняют вызовы API REST с помощью токена носителя.
-   REST API упаковывает запрос как сообщение и отправляет его в служебную шину. Далее, он извлекается, подписывается и отправляется в соответствующий распределенный реестр.
-   REST API отправляет запрос в базу данных SQL в Azure Blockchain Workbench, чтобы записать запрос и установить текущий статус подготовки.
-   База данных SQL возвращает статус подготовки, а вызов API возвращает идентификатор внешнему приложению, отправившему вызов.

### <a name="querying-blockchain-workbench-metadata-and-distributed-ledger-transactions"></a>Запрос метаданных Blockchain Workbench и транзакций распределенного реестра

Интерфейс REST API Azure Blockchain Workbench позволяет отправлять аутентифицированные запросы о подробностях выполнения смарт-контрактов в распределенном реестре.

![Запрос метаданных](media/blockchain-workbench-integration-patterns/querying-metadata.png)

В вышеописанном процессе, где происходит следующее:

1. Внешнее приложение аутентифицируется в Azure Active Directory в составе развернутой среды Azure Blockchain Workbench.
2. Авторизованные пользователи получают токен носителя, который может быть отправлен вместе с запросом к API.
3. Внешние приложения выполняют вызовы API REST с помощью токена носителя.
4. REST API извлекает данные из запроса к базе данных SQL и возвращает их в клиент.

## <a name="messaging-integration"></a>Интеграция службы сообщений

Интеграция службы сообщений усиливает взаимодействие с системами, службами и устройствами, для которых интерактивная процедура входа невозможна или нежелательна. При интеграции службы сообщений используются два типа сообщений: запросы о транзакциях, выполняемых в распределенном реестре, и события, созданные реестром в процессе выполнения транзакций.

Интеграция службы сообщений предусматривает выполнение и мониторинг транзакций, связанных с созданием пользователей, контрактов и выполнением транзакций согласно контрактам. Это решение используется в основном в *удаленно управляемых* серверных системах.

В этом разделе рассматриваются шаблоны и основное внимание уделяется разным аспектам использования API на основе сообщений для отправки транзакций в распределенный реестр, а также сообщений о событиях, созданных базовым распределенным реестром.

### <a name="one-way-event-delivery-from-a-smart-contract-to-an-event-consumer"></a>Односторонняя доставка событий от смарт-контракта к потребителю события 

В этом сценарии в смарт-контракте происходит событие, например изменяется состояние или выполняется определенного типа транзакция. Это событие транслируется через сетку событий подчиненным объектам-получателям данных, предпринимающих затем надлежащие действия.

Примером такого сценария может быть ситуация, когда при наступлении события объект-получатель получает оповещения и может предпринять определенные действия, например записать информацию в базу данных SQL или службу Common Data Service. Это тот же шаблон, которому следует Workbench при заполнении своей базы данных SQL *вне блокчейна*.

Результат был бы иным, если бы смарт-контракт перешел в некое конкретное состояние, например, если контракт перешел бы в состояние *OutOfCompliance*. При таком изменении состояния возможна отправка предупреждения на мобильный телефон администратора.

![Односторонняя доставка события](media/blockchain-workbench-integration-patterns/one-way-event-delivery.png)

В вышеописанном процессе, где происходит следующее:

-   Смарт-контракт переходит в новое состояние и отправляет событие в реестр.
-   Реестр получает и доставляет событие в Azure Blockchain Workbench.
-   Azure Blockchain Workbench подписан на события из реестра и получает события.
-   Azure Blockchain Workbench публикует события для подписчиков в сетке событий.
-   Внешние системы подписаны на сетку событий, получают сообщение и выполняют надлежащие действия.

## <a name="one-way-event-delivery-of-a-message-from-an-external-system-to-a-smart-contract"></a>Односторонняя доставка сообщений о событиях из внешней системы в смарт-контракт

Существует также сценарий развертывания событий в противоположном направлении. В этом случае событие генерируется датчиком или внешней системой, а данные о событии должны поступать в смарт-контракт.

Типичным примером может выступить доставка данных с финансовых рынков, например цен на товары, акции и облигации в смарт-контракт.

### <a name="direct-delivery-of-an-azure-blockchain-workbench-in-the-expected-format"></a>Прямая доставка Azure Blockchain Workbench в предусмотренном формате

Некоторые приложения созданы для интеграции с Azure Blockchain Workbench и сразу генерируют и посылают сообщения в требуемых форматах.

![Прямая доставка](media/blockchain-workbench-integration-patterns/direct-delivery.png)

В вышеописанном процессе, где происходит следующее:

-   Событие возникает во внешней системе, которая инициирует создание сообщения для Azure Blockchain Workbench.
-   Во внешней системе есть код, написанный для создания этого сообщения в известном формате и его отправки непосредственно в служебную шину.
-   Azure Blockchain Workbench обладает подпиской на события в служебной шине и извлекает сообщение.
-   Azure Blockchain Workbench инициирует вызов реестра, чтобы переслать данные из внешней системы в определенный контракт.
-   Получив сообщение, контракт переходит в новое состояние.

### <a name="delivery-of-a-message-in-a-format-unknown-to-azure-blockchain-workbench"></a>Доставка сообщения в формате, неизвестном Azure Blockchain Workbench

Некоторые системы невозможно изменить для доставки сообщений в стандартных форматах, используемых в Azure Blockchain Workbench. В таких случаях часто можно использовать существующие механизмы и форматы сообщений в этих системах. В частности, сообщения собственных типов в этих системах можно преобразовать с помощью приложения логики, функции Azure или другого пользовательского кода для сопоставления с одним из ожидаемых стандартных форматов сообщений.

![Неизвестный формат сообщения](media/blockchain-workbench-integration-patterns/unknown-message-format.png)

В вышеописанном процессе, где происходит следующее:

-   Событие возникает во внешней системе, инициирующей создание сообщения.
-   Приложение логики или пользовательский код используются для получения такого сообщения и его преобразования в стандартный формат сообщений Azure Blockchain Workbench.
-   Приложение логики передает преобразованное сообщение непосредственно в служебную шину.
-   Azure Blockchain Workbench обладает подпиской на события в служебной шине и извлекает сообщение.
-   Azure Blockchain Workbench инициирует вызов реестра, пересылая данные из внешней системы в определенную функцию в смарт-контракте.
-   Функция выполняется и обычно изменяет состояние. Изменение состояния продвигает бизнес-процесс, отражаемый в смарт-контракте, позволяя другим функциям выполняться надлежащим образом.

### <a name="transitioning-control-to-an-external-process-and-await-completion"></a>Переход управления к внешнему процессу и ожидание завершения

Существуют сценарии, где смарт-контракт должен остановить внутреннее выполнение и передать управление внешнему процессу. Затем внешний процесс должен завершиться, отправить сообщение в смарт-контракт и продолжить выполнение смарт-контракта.

#### <a name="transition-to-the-external-process"></a>Передача управления внешнему процессу

Этот шаблон обычно реализуется следующим способом:

-   Смарт-контракт переходит в определенное состояние. В этом состоянии, пока во внешней системе не будет выполнено нужное действие, не смогут выполняться либо все функции, либо их часть.
-   Изменение состояния будет представляться подчиненным объектам-получателям в виде события.
-   Подчиненные объекты-получатели принимают событие и инициализируют выполнение внешнего кода.

![Передача управления внешнему процессу](media/blockchain-workbench-integration-patterns/transition-external-process.png)

#### <a name="return-of-control-from-the-smart-contract"></a>Передача управления обратно от смарт-контракта

В зависимости от доступной настройки внешней системы возможности доставки сообщений в одном из стандартных форматов, ожидаемых в Azure Blockchain Workbench, может и не быть. В зависимости от возможности внешних систем создавать одно из таких сообщений выбирают один из двух возможных путей возврата управления.

##### <a name="direct-delivery-of-an-azure-blockchain-workbench-in-the-expected-format"></a>Прямая доставка Azure Blockchain Workbench в предусмотренном формате

![](media/blockchain-workbench-integration-patterns/direct-delivery.png)

В этой модели связь с контрактом и последующее изменение состояния происходят после вышеописанного процесса, где

-   После завершения выполнения кода или достижения определенного промежуточного состояния событие передается в служебную шину, подключенную к Azure Blockchain Workbench.

-   Для систем, которые невозможно напрямую настроить для записи сообщений, соответствующих ожиданиям API, оно будет преобразовано.

-   Содержимое сообщения упаковывается и передается в соответствующую функцию в смарт-контракте. Это делается от имени пользователя, связанного с внешней системой.

-   Функция выполняется и обычно меняет состояние. Изменение состояния продвигает бизнес-процесс, отражаемый в смарт-контракте, позволяя другим функциям выполняться надлежащим образом.

### 

### <a name="delivery-of-a-message-in-a-format-unknown-to-azure-blockchain-workbench"></a>Доставка сообщения в формате, неизвестном Azure Blockchain Workbench

![Неизвестный формат сообщения](media/blockchain-workbench-integration-patterns/unknown-message-format.png)

В этой модели, поскольку сообщение находится в стандартном формате и его невозможно отправить напрямую, связь с контрактом и последующее изменение состояния происходят в описанном выше порядке, где:

1.  После завершения выполнения кода или достижения определенного промежуточного состояния событие передается в служебную шину, подключенную к Azure Blockchain Workbench.
2.  Приложение логики или пользовательский код используются для получения такого сообщения и его преобразования в стандартный формат сообщений Azure Blockchain Workbench.
3.  Приложение логики передает преобразованное сообщение непосредственно в служебную шину.
4.  Azure Blockchain Workbench обладает подпиской на события в служебной шине и извлекает сообщение.
5.  Azure Blockchain Workbench инициирует вызов реестра, чтобы переслать данные из внешней системы в определенный контракт.
6. Содержимое сообщения упаковывается и передается в соответствующую функцию в смарт-контракте. Это делается от имени пользователя, связанного с внешней системой.
7.  Функция выполняется и обычно меняет состояние. Изменение состояния продвигает бизнес-процесс, отражаемый в смарт-контракте, позволяя другим функциям выполняться надлежащим образом.

## <a name="iot-integration"></a>Интеграция IoT

Типичный сценарий интеграции заключается во включении данных телеметрии, полученных от датчиков, в смарт-контракт. На основе данных, поступающих от датчиков, смарт-контракты могут предпринимать обоснованные действия и изменять состояние контракта.

Например, если температура в грузовике, доставляющего грузы медицинского назначения, поднялась до 43 градусов, это может повлиять на сохранность медпрепаратов и создать общественную угрозу, если этот факт не будет вовремя обнаружен и эти медикаменты не будут изъяты из цепочки поставок. Если водитель разогнал автомобиль до 160 км/час, информация с датчиков может привести к аннулированию страховки страховой компанией. Если речь идет о прокатном автомобиле, данные GPS покажут, если водитель выезжал за пределы зоны, оговоренной в его соглашении о прокате, и ему придется заплатить штраф.

Проблема заключается в том, что эти датчики могут поставлять данные смарт-контракту непрерывно, но это не соответствует реальным нуждам потребителей. Типичный подход заключается в том, чтобы ограничить число сообщений, передаваемых в блокчейн, перенаправляя все сообщения во вспомогательное хранилище. Например, доставляются только сообщения, получаемые через фиксированные промежутки времени, допустим, единожды в час, при условии выхода за пределы согласованного для смарт-контракта диапазона значений. Проверка значений, выходящих за пределы допусков, подтверждает, что данные, соответствующие бизнес-логике контрактов, успешно поступают и обрабатываются. Проверка значений за указанные промежутки времени подтверждает, что датчик по-прежнему работает. Все данные передаются во вспомогательное хранилище для создания расширенных отчетов, проведения анализа и использования в машинном обучении. Например, для смарт-контракта ежеминутные данные GPS-датчика могут не понадобиться, но они могут оказаться полезными для создания отчетов или при сопоставлении маршрутов движения.

На платформе Azure интеграция с устройствами обычно производится в Центрах Интернета вещей. Центр Интернета вещей обеспечивает маршрутизацию сообщений в зависимости от содержания и обеспечивает описанный выше тип функциональности.

![Сообщения IoT](media/blockchain-workbench-integration-patterns/iot.png)

Описанный выше процесс представляет собой шаблон такой реализации.

-   Устройство подключается к Центру Интернета вещей напрямую или через полевой шлюз.
-   Центр Интернета вещей получает сообщения и оценивает сообщения согласно назначенных маршрутов, проверяя содержимое сообщений, например. *Сообщает ли датчик о превышении температуры в 10 градусов?*
-   Центр Интернета вещей отправляет удовлетворяющие критериям сообщения в служебную шину для этого маршрута.
-   Приложение логики или другой код ожидает передачи данных в служебную шину, назначенную Центром Интернета вещей для данного маршрута.
-   Приложение логики или другой код извлекают и преобразуют сообщение в известный формат.
-   Преобразованное к стандартному формату сообщение пересылается в служебную шину для Azure Blockchain Workbench.
-   Azure Blockchain Workbench обладает подпиской на события в служебной шине и извлекает сообщение.
-   Azure Blockchain Workbench инициирует вызов реестра, чтобы переслать данные из внешней системы в определенный контракт.
-   После получения сообщения контракт оценивает данные и может изменить состояние на основании результатов оценки, например по причине высокой температуры изменить состояние на *Требования не соблюдены*.

## <a name="data-integration"></a>Интеграция данных

В дополнение к REST API и API на основе сообщений, Azure Blockchain Workbench обеспечивает доступ к базе данных SQL, заполняемой метаданными из приложения и контракта наряду с транзакционными данными из распределенных реестров.

![Интеграция данных](media/blockchain-workbench-integration-patterns/data-integration.png)

Интеграция данных хорошо известна:

-   Azure Blockchain Workbench хранит метаданные о приложениях, рабочих процессах, контрактах и транзакциях в соответствии со своим назначением.
-   Внешние системы или инструменты обеспечивают одно или несколько диалоговых окон для упрощения процесса сбора информации о базе данных, такой как название сервера базы данных, название базы данных, тип аутентификации, учетные данные для входа и используемые представления базы данных.
-   Чтобы облегчить условия получения данных внешними подчиненными системами, службами, отчетами, средствами разработки и корпоративными средствами повышения производительности, пишутся запросы к представлениям базы данных SQL.

## <a name="storage-integration"></a>Интеграция со службой хранилища

Во многих сценариях может возникнуть необходимость добавить файлы, требующие проверки на соответствие требованиям. По множеству причин некоторые файлы не следует помещать в блокчейн. Вместо этого, наиболее распространенный подход заключается в том, чтобы создать односторонний хэш файла и дать к нему общий доступ в распределенном реестре. Повторное хэширование в будущем даст тот же результат. Если файл изменяется, т.е. даже если изменен лишь один пиксель изображения, хэш-функция вернет уже другое значение.

![Интеграция со службой хранилища](media/blockchain-workbench-integration-patterns/storage-integration.png)

Шаблон можно реализовать в следующих ситуациях.

-   Внешняя система сохраняет файл в хранилище, таком как служба хранилища Azure.
-   Хэш создается на основе файла или на основе файла и связанных метаданных, например, идентификатора владельца, URL-адреса места хранения файла и т. д.
-   Хэш и метаданные передаются в функцию в смарт-контракте, такую, как *FileAdded*
-   Впоследствии файлы и метаданные можно хэшировать повторно и сравнить со значениями, хранимыми в реестре.

## <a name="prerequisites-for-implementing-integration-patterns-using-the-rest-and-message-apis"></a>Предварительные условия реализации шаблонов интеграции с помощью REST API и API на основе сообщений

Чтобы упростить возможность взаимодействия внешней системы или устройства со смарт-контрактом посредством REST API или API на основе сообщений, необходимо, чтобы произошло следующее

1. В Azure Active Directory для консорциума создана учетная запись, представляющая внешнюю систему или устройство.
2. Соответствующие смарт-контракты для вашего приложения Azure Blockchain Workbench содержат функции получения событий из внешней системы или устройства.
3. Файл конфигурации приложения для вашего смарт-контракта содержит роль, которой будут назначены система или устройство.
4. Файл конфигурации приложения вашего смарт-контракта определяет, в каких состояниях эту функцию можно вызвать с помощью соответствующей роли.
5. Файл конфигурации приложения и его смарт-контракты передаются в Azure Blockchain Workbench.

После передачи приложения учетная запись Azure Active Directory для внешней системы назначается в контракт и соответствующую роль.

## <a name="testing-external-system-integration-flows-prior-to-writing-integration-code"></a>Тестирование последовательности интеграции внешней системы до написания кода интеграции 

Обеспечение возможности интеграции с внешними системами является основным требованием во многих сценариях. Желательно иметь возможность проверить структуру смарт-контракта до разработки кода интеграции с внешними системами или одновременно с ней.

Использование Azure Active Directory (Azure AD) может значительно ускорить процесс разработки и сократить сроки ввода в эксплуатацию. В частности, интеграция кода с внешней системой может занять довольно долгое время. С помощью Azure AD и автоматического создания механизма пользовательского взаимодействия в Azure Blockchain Workbench разработчики могут входить в Workbench от имени внешней системы и вводить надлежащие значения посредством механизма пользовательского взаимодействия. Это позволяет быстро разрабатывать и проверять идеи в условиях среды опытной эксплуатации либо до, либо параллельно с написанием кода интеграции с внешними системами.
