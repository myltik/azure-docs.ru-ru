---
title: Запрос маркеров доступа в Azure AD B2C | Документация Майкрософт
description: В этой статье описывается, как настроить клиентское приложение и получить маркер доступа.
services: active-directory-b2c
documentationcenter: android
author: davidmu1
manager: mtillman
editor: ''
ms.service: active-directory-b2c
ms.workload: identity
ms.topic: article
ms.date: 08/09/2017
ms.author: davidmu
ms.openlocfilehash: bd919543072a8d2bf5fb0ebba17e69ba2f467218
ms.sourcegitcommit: 48ab1b6526ce290316b9da4d18de00c77526a541
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2018
---
# <a name="azure-ad-b2c-requesting-access-tokens"></a>Azure AD B2C: запрос маркеров доступа

Маркер доступа (в ответах Azure AD B2C обозначается как **access\_token**) является разновидностью маркера безопасности, с помощью которого клиенты могут получить доступ к ресурсам, защищенным [сервером авторизации](https://docs.microsoft.com/azure/active-directory-b2c/active-directory-b2c-reference-protocols#the-basics), таким как веб-API. Они представлены в виде [маркеров JWT](https://docs.microsoft.com/azure/active-directory-b2c/active-directory-b2c-reference-tokens#types-of-tokens) и содержат сведения о целевом сервере ресурсов и предоставленных разрешениях для сервера. При вызове сервера ресурсов маркер доступа должен присутствовать в HTTP-запросе.

В этой статье описывается настройка клиентского приложения и веб-API для получения маркера доступа (**access\_token**).

> [!NOTE]
> **Цепочки веб-API ("от имени") не поддерживаются в Azure AD B2C.**
>
> Многие архитектуры включают в себя веб-API, которому требуется вызывать другой нисходящий веб-API. При этом Azure AD B2C защищает оба интерфейса. Этот сценарий характерен для собственных клиентов с внутренним веб-API, который в свою очередь вызывает службу Microsoft Online, например API Graph Azure AD.
>
> Этот сценарий веб-API с цепочками может поддерживаться с помощью предоставления учетных данных носителя маркера JWT OAuth 2.0 или потока On-Behalf-Of. Однако в Azure AD B2C поток On-Behalf-Of еще не реализован.

## <a name="register-a-web-api-and-publish-permissions"></a>Регистрация веб-API и публикация разрешений

Прежде чем запрашивать маркер доступа, сначала необходимо зарегистрировать веб-API и опубликовать разрешения (области), которые могут быть предоставлены клиентскому приложению.

### <a name="register-a-web-api"></a>Регистрация веб-API

1. В меню функций Azure AD B2C на портале Azure щелкните **Приложения**.
1. Щелкните **+Добавить** в верхней части меню.
1. Введите **имя** приложения, которое будет служить его описанием для пользователей. Например, введите Contoso API.
1. Переведите переключатель **Include web app / web API** (Включить веб-приложение или веб-API) в положение **Да**.
1. Введите произвольное значение для **URL-адресов ответа**. Например, введите `https://localhost:44316/`. Значение не имеет значения, так как API не должен получать маркер непосредственно из Azure AD B2C.
1. Введите **URI идентификатора приложения**. Это идентификатор, используемый для веб-API. Например, введите notes в поле. **URI идентификатора приложения** будет `https://{tenantName}.onmicrosoft.com/notes`.
1. Чтобы зарегистрировать приложение, щелкните **Создать** .
1. Щелкните приложение, которое вы только что создали, и скопируйте глобальный уникальный **идентификатор клиента приложения**. Позже он вам потребуется в коде.

### <a name="publishing-permissions"></a>Публикация разрешений

Области, аналогичные разрешениям, необходимы, если приложение вызывает API. Примеры областей — области чтения или записи. Предположим, нужно, чтобы веб-приложение или собственное приложение могло считывать данные из API. Приложение вызовет Azure AD B2C и запросит маркер доступа, предоставляющий доступ к области чтения. Чтобы среда Azure AD B2C выдала такой маркер доступа, приложению нужно предоставить разрешение на чтение из конкретного API. Для этого сначала API нужно опубликовать область чтения.

1. В меню **Приложения** Azure AD B2C откройте приложение веб-API (API Contoso).
1. Щелкните **Опубликованные области**. Здесь вы определяете разрешения (области), которые могут быть предоставлены другим приложениям.
1. При необходимости добавьте **значения области** (например, read). По умолчанию будут определены области user_impersonation. Их можно игнорировать. Введите описание области в столбце **Имя области**.
1. Выберите команду **Сохранить**.

> [!IMPORTANT]
> **Имя области** является описанием **значения области**. При использовании области обязательно используйте **значение области**.

## <a name="grant-a-native-or-web-app-permissions-to-a-web-api"></a>Предоставление собственному приложению или веб-приложению разрешений для веб-API

Настроив API для публикации областей, вам нужно предоставить эти области клиентскому приложению через портал Azure.

1. Перейдите к меню **Приложения** в меню функций Azure AD B2C.
1. Зарегистрируйте клиентское приложение ([веб-приложение](active-directory-b2c-app-registration.md#register-a-web-app) или [собственный клиент](active-directory-b2c-app-registration.md#register-a-mobile-or-native-app)), если у вас еще его нет. Если вы выбрали это руководство в качестве отправной точки, необходимо зарегистрировать клиентское приложение.
1. Щелкните **Доступ через API**.
1. Щелкните **Добавить**.
1. Выберите веб-API и области (разрешения), которые нужно предоставить.
1. Последовательно выберите **ОК**.

> [!NOTE]
> Для Azure AD B2C не нужно предоставлять согласие пользователей клиентского приложения. Вместо этого требуется согласие администратора, которое определяется на основе разрешений, настроенных для приложений, как описано выше. Если отозвать разрешение для приложения, все пользователи, которые могли получить это разрешение, больше не смогут его использовать.

## <a name="requesting-a-token"></a>Запрос маркера

При запросе маркера доступа клиентскому приложению необходимо указать нужные разрешения в параметре **scope** запроса. Например, чтобы указать **значение области** read для API с **URI идентификатора приложения** `https://contoso.onmicrosoft.com/notes` используется область `https://contoso.onmicrosoft.com/notes/read`. Ниже приведен пример запроса кода авторизации к конечной точке `/authorize`.

> [!NOTE]
> Сейчас пользовательские домены и маркеры доступа не поддерживаются. В URL-адресе запроса следует использовать домен tenantName.onmicrosoft.com.

```
https://login.microsoftonline.com/<tenantName>.onmicrosoft.com/oauth2/v2.0/authorize?p=<yourPolicyId>&client_id=<appID_of_your_client_application>&nonce=anyRandomValue&redirect_uri=<redirect_uri_of_your_client_application>&scope=https%3A%2F%2Fcontoso.onmicrosoft.com%2Fnotes%2Fread&response_type=code 
```

Чтобы получить несколько разрешений в одном запросе, можно добавить несколько записей в одном параметре **scope**, разделив их пробелами. Например: 

Декодированный URL-адрес:

```
scope=https://contoso.onmicrosoft.com/notes/read openid offline_access
```

Закодированный URL-адрес:

```
scope=https%3A%2F%2Fcontoso.onmicrosoft.com%2Fnotes%2Fread%20openid%20offline_access
```

Для ресурса можно запросить больше областей или разрешений, чем предоставлено для клиентского приложения. В таком случае вызов будет успешным, если будет предоставлено хотя бы одно разрешение. Утверждение scp полученного маркера **access\_token** будет заполнено только успешно предоставленными разрешениями.

> [!NOTE] 
> Запросы разрешений для двух разных веб-ресурсов не поддерживаются в одном и том же запросе. Такой запрос завершится ошибкой.

### <a name="special-cases"></a>Особые случаи

Стандартное утверждение OpenID Connect определяет несколько специальных значений scope. Следующие специальные области представляют право доступа к профилю пользователя:

* **openid** — запрашивает маркер идентификатора;
* **offline\_access** — запрашивает маркер обновления (с помощью [потоков кода аутентификации](active-directory-b2c-reference-oauth-code.md)).

Если параметр `response_type` в запросе `/authorize` включает `token`, параметр `scope` должен содержать хотя бы одну область ресурса (отличную от `openid` и `offline_access`), которая будет предоставлена. В противном случае запрос `/authorize` завершится ошибкой.

## <a name="the-returned-token"></a>Возвращаемый маркер

Успешно созданный **access\_token** (из конечной точки `/authorize` или `/token`) будет содержать следующие утверждения:

| ИМЯ | Утверждение | ОПИСАНИЕ |
| --- | --- | --- |
|Аудитория |`aud` |**Идентификатор приложения** одного ресурса, к которому предоставляет доступ маркер. |
|Область |`scp` |Разрешения, предоставляемые ресурсу. Несколько предоставленных разрешений разделяются пробелами. |
|Авторизованная сторона |`azp` |**Идентификатор приложения** клиентского приложения, инициировавшего запрос. |

Когда API получает **access\_token**, он [проверяет маркер](active-directory-b2c-reference-tokens.md), чтобы подтвердить его подлинность и убедиться, что он имеет правильные утверждения.

Мы всегда рады вашим отзывам и предложениям! Если у вас возникли проблемы с этим, опубликуйте их на сайте Stack Overflow, используя тег [azure-ad-b2c](https://stackoverflow.com/questions/tagged/azure-ad-b2c). Запросы функций оставляйте на форуме [UserVoice](https://feedback.azure.com/forums/169401-azure-active-directory/category/160596-b2c).

## <a name="next-steps"></a>Дополнительная информация

* Создайте веб-API с помощью [.NET Core](https://github.com/Azure-Samples/active-directory-b2c-dotnetcore-webapi).
* Создайте веб-API с помощью [Node.js](https://github.com/Azure-Samples/active-directory-b2c-javascript-nodejs-webapi).
