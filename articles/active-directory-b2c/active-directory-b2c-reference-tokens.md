---
title: Справочник по маркерам в Azure AD В2С | Документация Майкрософт
description: В статье описываются типы маркеров, выпускаемых в Azure Active Directory B2C.
services: active-directory-b2c
documentationcenter: ''
author: davidmu1
manager: mtillman
editor: ''
ms.service: active-directory-b2c
ms.workload: identity
ms.topic: article
ms.date: 08/16/2017
ms.author: davidmu
ms.openlocfilehash: 09d776b54941e33979d7969b25c35e67a53cf8f0
ms.sourcegitcommit: 1362e3d6961bdeaebed7fb342c7b0b34f6f6417a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2018
---
# <a name="azure-ad-b2c-token-reference"></a>Azure AD B2C: справочник по маркерам

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

При обработке каждого [потока аутентификации](active-directory-b2c-apps.md) Azure Active Directory B2C (Azure AD B2C) создает маркеры безопасности различных типов. В этом документе описывается формат, характеристики безопасности и содержимое каждого типа маркера.

## <a name="types-of-tokens"></a>Типы маркеров
Служба Azure AD B2C поддерживает [протокол авторизации OAuth 2.0](active-directory-b2c-reference-protocols.md), использующий как маркеры доступа, так и маркеры обновления. Она также поддерживает проверку подлинности и вход с помощью [OpenID Connect](active-directory-b2c-reference-protocols.md), вводя третий тип маркера — маркер идентификации. Каждый из этих маркеров представляется как "токен носителя".

Токен носителя — это упрощенный маркер безопасности, предоставляющий доступ носителю к защищенному ресурсу. В этом смысле носителем является любая сторона, которая может предъявить маркер. Прежде чем получить токен носителя, сторона должна пройти проверку подлинности в Azure AD В2С. Однако если не выполняются действия, необходимые для защиты маркера во время его передачи и хранения, то его может перехватить и использовать несанкционированная сторона. У некоторых маркеров безопасности есть встроенный механизм, который предотвращает их использование несанкционированными сторонами, но токены носителя не имеют такого механизма. Они должны передаваться по защищенному каналу, например по протоколу TLS (HTTPS).

Если токен носителя передается вне зашифрованного канала, злоумышленник может использовать атаку "злоумышленник в середине", чтобы получить токен и использовать его для несанкционированного доступа к защищенному ресурсу. Те же принципы безопасности применяются при сохранении или кэшировании токенов носителя для последующего использования. Необходимо всегда проверять, что приложение передает и сохраняет токены носителя безопасным образом.

Дополнительные сведения о безопасности во время применения токенов носителя см. в документе [RFC 6750 Section 5](http://tools.ietf.org/html/rfc6750) (RFC 6750, раздел 5).

Многие маркеры, которые выпускает служба Azure AD B2C, реализуются как веб-маркеры JSON (JWT). Маркер JWT — это компактное и безопасное для URL-адреса средство передачи информации между двумя сторонами. Маркеры JWT содержат сведения, называемые утверждениями. Это утверждения со сведениями о носителе и о субъекте маркера. Утверждения в маркерах JWT — это объекты JSON, закодированные и сериализованные для передачи. Так как формируемые службой Azure AD B2C маркеры JWT подписываются, но не шифруются, их содержимое можно легко изучить с целью отладки. Это можно сделать с помощью нескольких средств, включая [jwt.ms](https://jwt.ms). Дополнительные сведения о маркерах JWT см. в [спецификациях по маркерам JWT](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html).

### <a name="id-tokens"></a>Маркеры идентификации

Маркеры идентификации — это разновидность маркеров безопасности, которые приложение получает от конечных точек Azure AD B2C `/authorize` и `/token`. Они представлены в виде [маркеров JWT](#types-of-tokens)и содержат утверждения, которые можно использовать для идентификации пользователей приложения. Когда маркеры идентификации поступают из конечной точки `/authorize`, это происходит с помощью [неявного потока](active-directory-b2c-reference-spa.md), который часто используется для входа пользователей веб-приложения на основе JavaScript. Когда маркеры идентификации поступают из конечной точки `/token`, это происходит с помощью [потока кода конфиденциальной информации](active-directory-b2c-reference-oidc.md), который предотвращает доступ браузера к маркеру. Это позволяет безопасно отправлять маркеры в HTTP-запросы для обмена данными между двумя компонентами одного и того же приложения или службы. Утверждения, которые содержит маркер идентификации, вы можете использовать по своему усмотрению. Обычно они отображают сведения учетной записи или на их основе предоставляется доступ к приложению.  

На текущий момент маркеры идентификации подписываются, но не шифруются. Когда приложение или API получает маркер идентификации, они [проверяют его подпись](#token-validation) , чтобы подтвердить подлинность маркера. Приложение или интерфейс API должны также проверить несколько утверждений в маркере, чтобы подтвердить его действительность. Утверждения, которые проверяет приложение, зависят от требований сценария, но некоторые [стандартные проверки утверждений](#token-validation) приложение должно выполнять в каждом сценарии.

#### <a name="sample-id-token"></a>Пример маркера идентификации
```
// Line breaks for display purposes only

eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IklkVG9rZW5TaWduaW5nS2V5Q29udGFpbmVyIn0.
eyJleHAiOjE0NDIzNjAwMzQsIm5iZiI6MTQ0MjM1NjQzNCwidmVyIjoiMS4wIiwiaXNzIjoiaHR0cHM6Ly9s
b2dpbi5taWNyb3NvZnRvbmxpbmUuY29tLzc3NTUyN2ZmLTlhMzctNDMwNy04YjNkLWNjMzExZjU4ZDkyNS92
Mi4wLyIsImFjciI6ImIyY18xX3NpZ25faW5fc3RvY2siLCJzdWIiOiJOb3Qgc3VwcG9ydGVkIGN1cnJlbnRs
eS4gVXNlIG9pZCBjbGFpbS4iLCJhdWQiOiI5MGMwZmU2My1iY2YyLTQ0ZDUtOGZiNy1iOGJiYzBiMjlkYzYi
LCJpYXQiOjE0NDIzNTY0MzQsImF1dGhfdGltZSI6MTQ0MjM1NjQzNCwiaWRwIjoiZmFjZWJvb2suY29tIn0.
h-uiKcrT882pSKUtWCpj-_3b3vPs3bOWsESAhPMrL-iIIacKc6_uZrWxaWvIYkLra5czBcGKWrYwrAC8ZvQe
DJWZ50WXQrZYODEW1OUwzaD_I1f1HE0c2uvaWdGXBpDEVdsD3ExKaFlKGjFR2V7F-fPThkVDdKmkUDQX3bVc
yyj2V2nlCQ9jd7aGnokTPfLfpOjuIrTsAdPcGpe5hfSEuwYDmqOJjGs9Jp1f-eSNEiCDQOaTBSvr479L5ptP
XWeQZyX2SypN05Rjr05bjZh3j70ZUimiocfJzjibeoDCaQTz907yAg91WYuFOrQxb-5BaUoR7K-O7vxr2M-_
CQhoFA

```

### <a name="access-tokens"></a>Маркеры доступа

Маркер доступа — это также разновидность маркеров безопасности, которые приложение получает от конечных точек Azure AD B2C `/authorize` и `/token`. Они представлены в виде [маркеров JWT](#types-of-tokens) и содержат утверждения, которые можно использовать для идентификации предоставленных разрешений в интерфейсах API. На текущий момент маркеры доступа подписываются, но не шифруются. Маркеры доступа следует использовать для предоставления доступа к API и серверам ресурсов. Узнайте больше о том, как [использовать маркеры доступа](active-directory-b2c-access-tokens.md). 

Когда API получает маркер доступа, он [проверяет его подпись](#token-validation) , чтобы подтвердить подлинность маркера. API должен также проверить несколько утверждений в маркере, чтобы подтвердить его действительность. Утверждения, которые проверяет приложение, зависят от требований сценария, но некоторые [стандартные проверки утверждений](#token-validation) приложение должно выполнять в каждом сценарии.

### <a name="claims-in-id-and-access-tokens"></a>Утверждения в маркерах идентификации и доступа

Используя Azure AD B2C, вы можете точно контролировать содержимое маркеров. Вы можете настроить [политики](active-directory-b2c-reference-policies.md) для отправки определенных наборов пользовательских данных в утверждениях, которые необходимы для работы приложения. Эти утверждения могут включать в себя стандартные свойства, например свойства `displayName` и `emailAddress` пользователя. Кроме того, они могут содержать [настраиваемые пользовательские атрибуты](active-directory-b2c-reference-custom-attr.md) , которые вы можете задать в каталоге B2C. Каждый маркер идентификации и доступа, который вы получаете, содержит набор утверждений, связанных с безопасностью. С помощью этих утверждений ваши приложения могут безопасно проверять подлинность пользователей и запросов.

Обратите внимание, что утверждения в маркерах идентификации не возвращаются в определенном порядке. Кроме того, новые утверждения могут появиться в маркерах идентификации в любое время. По мере появления новых утверждений ваше приложение не должно прерывать работу. В таблице приводятся утверждения, содержащиеся в маркерах идентификации и доступа, которые выдает служба Azure AD B2C. Все дополнительные утверждения определяются политиками. Для тренировки попробуйте изучить утверждения в примере маркера идентификации, вставив его в [jwt.ms](https://jwt.ms). Дополнительные сведения можно найти в [спецификации по OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html).

| ИМЯ | Утверждение | Пример значения | ОПИСАНИЕ |
| --- | --- | --- | --- |
| Аудитория |`aud` |`90c0fe63-bcf2-44d5-8fb7-b8bbc0b29dc6` |Утверждение "Аудитория" обозначает целевого получателя маркера. В Azure AD B2C "Аудитория" — это идентификатор приложения, назначенный на портале регистрации приложений. Приложение должно проверить это значение и отклонить маркер, если он ему не соответствует. |
| Издатель |`iss` |`https://login.microsoftonline.com/775527ff-9a37-4307-8b3d-cc311f58d925/v2.0/` |Это утверждение обозначает службу токенов безопасности (STS), которая создает и возвращает маркер. Кроме того, оно определяет, в каком каталоге Azure AD пользователь прошел проверку подлинности. Приложение должно проверить утверждение издателя и убедиться, что маркер пришел от конечной точки Azure Active Directory версии 2.0. |
| Время выдачи |`iat` |`1438535543` |Это утверждение обозначает время выдачи маркера в виде времени эпохи. |
| Время окончания срока действия |`exp` |`1438539443` |Утверждение "Время окончания срока действия" обозначает (в виде времени эпохи) время, когда маркер становится недействительным. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| Не ранее |`nbf` |`1438535543` |Это утверждение обозначает время, когда начинается срок действия маркера (указанное в виде времени эпохи). Оно обычно совпадает со временем выдачи маркера. Приложение должно использовать это утверждение для проверки действительности срока действия маркера. |
| Version (версия) |`ver` |`1.0` |Версия маркера идентификации, заданная службой Azure AD. |
| Хэш-код |`c_hash` |`SGCPtt01wxwfgnYZy2VJtQ` |Хэш-код включается в состав маркеров идентификации, только если маркер выдан вместе с кодом авторизации OAuth 2.0. Хэш-код можно использовать для проверки подлинности кода авторизации. Дополнительные сведения о выполнении этой проверки см. в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html).  |
| Хэш маркера доступа |`at_hash` |`SGCPtt01wxwfgnYZy2VJtQ` |Хэш маркера доступа включается в состав маркеров идентификации, только если этот маркер выдан вместе с маркером доступа OAuth 2.0. Его можно использовать для проверки подлинности маркера доступа. Дополнительные сведения о выполнении этой проверки см. в [спецификации OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html).  |
| Специальное утверждение |`nonce` |`12345` |Nonce — это стратегия, которая используется для предотвращения атак повторного воспроизведения маркера. Приложение может указать специальное утверждение в запросе авторизации с помощью параметра запроса `nonce` . Значение, указанное вами в запросе, будет использовано без изменений только в утверждении `nonce` маркера идентификации. Таким образом приложение проверит это значение на соответствие значению, указанному в запросе, который связывает сеанс приложения с определенным маркером идентификации. Приложение должно выполнять эту проверку во время проверки маркера идентификации. |
| Субъект |`sub` |`884408e1-2918-4cz0-b12d-3aa027d7563b` |Субъект, в отношении которого маркер подтверждает сведения, например пользователь приложения. Это значение является неизменяемым и не может быть переназначено или повторно использовано. Это значение можно использовать для безопасных проверок авторизации, например, когда маркер используется для доступа к ресурсу. По умолчанию утверждение субъекта заполняется идентификатором объекта пользователя в каталоге. Дополнительные сведения см. в статье [Azure Active Directory B2C: конфигурация маркера, сеанса и единого входа](active-directory-b2c-token-session-sso.md). |
| Ссылка на класс контекста проверки подлинности |`acr` |Не применяется |Сейчас не используется, кроме случаев применения старой политики. Дополнительные сведения см. в статье [Azure Active Directory B2C: конфигурация маркера, сеанса и единого входа](active-directory-b2c-token-session-sso.md). |
| Политика инфраструктуры доверия |`tfp` |`b2c_1_sign_in` |Это имя политики, которая использовалась для получения маркера идентификации. |
| Время проверки подлинности |`auth_time` |`1438535543` |Данное утверждение — это время, когда пользователь в последний раз вводил учетные данные. Время отображается виде времени эпохи. |

### <a name="refresh-tokens"></a>Маркеры обновления
Маркеры обновления — это маркеры безопасности, которые приложение может использовать для получения новых маркеров идентификации и маркеров доступа в потоке OAuth 2.0. За счет этого приложение может получить длительный доступ к ресурсам от лица пользователя без участия самого пользователя.

Чтобы получить маркер обновления в ответе маркера, приложение должно запросить область `offline_acesss` . Для получения дополнительных сведений об области `offline_access` обратитесь к [Справочнику по протоколу Azure AD B2C](active-directory-b2c-reference-protocols.md).

Маркеры обновления абсолютно непрозрачны для приложения и всегда будут таковыми. Их выдает служба Azure AD, и только эта служба может их проверять и интерпретировать. Они действительны в течение продолжительного времени, но при создании приложения не следует ожидать, что маркер обновления будет действителен в течение определенного периода времени. Маркеры обновления могут стать недействительными в любое время по разным причинам. Единственный способ, с помощью которого приложение может выяснить, является ли маркер действительным, — попытаться использовать его путем отправки запроса маркера Azure AD.

При обмене маркера обновления на новый маркер (если приложению предоставлена область `offline_access` ) вы получите новый маркер обновления в ответе маркера. Только что выданный маркер обновления следует сохранить. Он должен заменить собой маркер обновления, который вы использовали в запросе в прошлый раз. Такой подход обеспечит максимальный срок действия маркеров обновления.

## <a name="token-validation"></a>Проверка маркеров
Для проверки маркера приложение должно проверить подпись маркера и содержащиеся в нем утверждения.

Для проверки маркеров JWT доступны многие библиотеки с открытым исходным кодом в зависимости от выбранного языка. Мы рекомендуем изучить различные библиотеки, а не реализовывать логику проверки самостоятельно. Из этого руководства вы узнаете, как правильно использовать эти библиотеки.

### <a name="validate-the-signature"></a>проверяют его подпись
Маркер JWT содержит три сегмента, разделенных знаком `.` . Первый сегмент — это *заголовок*, второй — *текст*, а третий — *подпись*. Сегмент подписи можно использовать для проверки подлинности маркера, чтобы приложение доверяло ему.

Маркеры Azure AD B2C подписываются при помощи стандартных отраслевых алгоритмов асимметричного шифрования, таких как RSA 256. Заголовок маркера содержит сведения о ключе и методе шифрования, используемых для подписания маркера:

```
{
        "typ": "JWT",
        "alg": "RS256",
        "kid": "GvnPApfWMdLRi8PDmisFn7bprKg"
}
```

Утверждение `alg` обозначает алгоритм, с помощью которого был подписан маркер. Утверждение `kid` обозначает конкретный открытый ключ, с помощью которого был подписан маркер.

Azure AD может в любой момент времени подписать маркер с использованием любой пары открытого и закрытого ключей из определенного набора пар. Azure AD периодически изменяет возможный набор ключей, поэтому при создании приложения необходимо обеспечить автоматическую обработку подобных изменений ключей. Рекомендуем проверять наличие обновлений открытых ключей, которые использует служба Azure AD, каждые 24 часа.

Служба Azure AD B2C имеет конечную точку метаданных OpenID Connect. Это позволяет приложениям получать сведения об Azure AD B2C во время выполнения. Эти сведения включают конечные точки, содержимое маркеров и ключи подписи маркеров. Для каждой политики в каталоге B2C есть собственный документ метаданных JSON. Например, документ метаданных для политики `b2c_1_sign_in` в `fabrikamb2c.onmicrosoft.com` находится в каталоге:

```
https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/v2.0/.well-known/openid-configuration?p=b2c_1_sign_in
```

`fabrikamb2c.onmicrosoft.com` — это каталог B2C, используемый для проверки подлинности пользователя, а `b2c_1_sign_in` — это политика, используемая для получения маркера. Чтобы определить, какая политика была использована для подписи маркера (а также определить, откуда необходимо получать метаданные), можно воспользоваться одним из двух вариантов. Сначала имя политики включается в утверждение `acr` маркера. Утверждения из тела маркера JWT можно проанализировать, декодировав тело маркера с помощью кодировки base-64 и десериализации полученной строки JSON. Утверждение `acr` будет представлять собой имя политики, которая использовалась для выдачи маркера.  Другой вариант — закодировать политику в значении параметра `state` при отправке запроса и затем декодировать ее, чтобы определить, какая политика была использована. Каждый из этих методов является допустимым.

Документ метаданных является объектом JSON, содержащим важные сведения. К ним относится расположение конечных точек, необходимых для проверки подлинности OpenID Connect. Эти сведения включают в себя также код `jwks_uri`, который указывает расположение набора открытых ключей, использованных для подписания маркеров. Это расположение представлено ниже, но лучше получить его динамически с помощью документа метаданных и анализа `jwks_uri`:

```
https://login.microsoftonline.com/fabrikamb2c.onmicrosoft.com/discovery/v2.0/keys?p=b2c_1_sign_in
```

Документ JSON, расположенный по этому URL-адресу, содержит все сведения об открытых ключах, используемые в конкретный момент времени. Приложение может использовать утверждение `kid` в заголовке маркера JWT, чтобы выбрать открытый ключ в этом документе JSON, использованный для подписания определенного маркера. Затем оно может проверить подпись с использованием правильного открытого ключа и указанного алгоритма.

Описание выполнения проверки выходит за рамки этого документа. Вы можете использовать для выполнения проверки многие библиотеки с открытым исходным кодом.

### <a name="validate-the-claims"></a>Проверка утверждений
Когда приложение или API получает маркер идентификации, они также должны выполнить несколько проверок утверждений в этом маркере. Помимо прочего, к этим утверждениям относятся:

* Утверждение **Аудитория**. Необходимо для подтверждения того, что маркер идентификации действительно должен был быть выдан вашему приложению.
* Утверждения **Не ранее** и **Время окончания срока действия**. Необходимы для подтверждения того, что срок действия маркера идентификации не истек.
* Утверждение **Издатель**. Помогает убедиться в том, что маркер выдала приложению служба Azure AD.
* **Nonce**— это стратегия, с помощью которой можно предотвратить атаки повторного воспроизведения маркера.

Полный список проверок, которые должно выполнять ваше приложение, см. в [спецификации OpenID Connect](https://openid.net). Подробные сведения об ожидаемых значениях для этих утверждений можно найти выше в разделе, посвященном [маркерам](#types-of-tokens).  

## <a name="token-lifetimes"></a>Время существования маркеров
Доступны следующие сроки существования маркеров. Они могут пригодиться при разработке и отладке приложений. Обратите внимание, что при создании приложения не следует ожидать постоянства какого-либо из указанных сроков. Они могут и будут изменяться. Ознакомьтесь с дополнительными сведениями о [настройке времени существования маркеров](active-directory-b2c-token-session-sso.md) в Azure AD B2C.

| по маркеру | Срок действия | ОПИСАНИЕ |
| --- | --- | --- |
| Маркеры идентификации |Один час |Маркеры идентификации обычно действительны в течение часа. В течение этого срока ваше веб-приложение может создать свои сеансы с пользователями (рекомендуется). Кроме того, вы можете выбрать другой срок существования сеанса. Если приложению необходимо получить новый маркер идентификации, оно должно просто создать новый запрос входа в Azure AD. Если в браузере у пользователя есть действительный сеанс Azure AD, то повторный ввод учетных данных может не потребоваться. |
| Маркеры обновления |До 14 дней |Один маркер обновления действителен до 14 дней. Тем не менее маркер обновления может стать недопустимым в любое время и по различным причинам. Приложению следует пытаться использовать маркер обновления до тех пор, пока запрос не завершится ошибкой или приложение не заменит существующий маркер обновления новым. Кроме того, маркер обновления может стать недействительным, если последний раз пользователь вводил учетные данные 90 дней назад. |
| Коды авторизации |5 минут |Коды авторизации специально обладают коротким сроком действия. После получения их следует незамедлительно обменять на маркеры доступа, маркеры идентификации или маркеры обновления. |

