---
title: Архивация данных мониторинга Azure | Документация Майкрософт
description: Архивируйте данные журнала и метрик, созданные в Azure, в учетную запись хранения.
author: johnkemnetz
manager: orenr
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.service: monitoring-and-diagnostics
ms.topic: tutorial
ms.date: 09/25/2017
ms.author: johnkem
ms.custom: mvc
ms.openlocfilehash: b44bbd9cb2f54107d2593b1ab7f07f07fcc41e57
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="archive-azure-monitoring-data"></a>Архивация данных мониторинга Azure

Несколько слоев среды Azure создают данные журнала и метрик, которые можно архивировать в учетную запись хранения Azure. Делать это лучше в том случае, если необходимо сохранить историю мониторинга данных за определенное время в недорогом и недоступном для поиска хранилище, после того как срок хранения данных в Log Analytics или Azure Monitor истек. В этом руководстве описывается процесс настройки среды Azure для архивирования данных в учетную запись хранения.

> [!div class="checklist"]
> * Создание учетной записи хранения для хранения данных мониторинга.
> * Настройка передачи в нее журналов подписки.
> * Настройка передачи в нее данных ресурсов.
> * Настройка передачи в нее данных виртуальной машины (гостевой ОС).
> * Просмотр сохраненных данных мониторинга.
> * Очистка ресурсов

Если у вас еще нет подписки Azure, создайте [бесплатную](https://azure.microsoft.com/free/) учетную запись Azure, прежде чем начинать работу.

## <a name="sign-in-to-the-azure-portal"></a>Выполните вход на портал Azure.

Войдите на [портале Azure](https://portal.azure.com/).

## <a name="create-a-storage-account"></a>Создайте учетную запись хранения.

Сначала необходимо настроить учетную запись хранения, в которую будут архивироваться данные. Для этого [сделайте следующее](../storage/common/storage-create-storage-account.md).

## <a name="route-subscription-logs-to-the-storage-account"></a>Маршрутизация журналов подписки в учетную запись хранения

Теперь можно приступить к настройке среды Azure для маршрутизации данных мониторинга в учетную запись хранения. Сначала настраиваются данные на уровне подписки (содержатся в журнале действий Azure) для маршрутизации к учетной записи хранения. [**Журнал действий Azure**](monitoring-overview-activity-logs.md) содержит события на уровне подписки в Azure. Его можно просмотреть на портале Azure, чтобы определить, *кто* создал, обновил или удалил *ресурсы*, а также *когда* это было сделано.

1. Нажмите кнопку **Монитор** в списке навигации слева, а затем — **Журнал действий**.

   ![Раздел журнала действий](media/monitor-tutorial-archive-monitoring-data/activity-log-home.png)

2. В появившемся разделе журнала действий нажмите кнопку **Экспорт**.

3. В открывшемся разделе **Export activity log** (Экспорт журнала действий) установите флажок **Export to a storage account** (Экспорт в учетную запись хранения) и щелкните **Выбрать учетную запись хранения**.

   ![Экспорт журнала действий](media/monitor-tutorial-archive-monitoring-data/activity-log-export.png)

4. В открывшемся разделе в раскрывающемся списке **Учетная запись хранения** выберите имя учетной записи хранения, созданной на предыдущем шаге (**Создание учетной записи хранения**), а затем нажмите кнопку **ОК**.

   ![Выбор учетной записи хранения](media/monitor-tutorial-archive-monitoring-data/activity-log-storage.png)

5. Задайте для ползунка **Хранение (в днях)** значение 30. Этот ползунок задает количество дней хранения данных мониторинга в учетной записи хранения. Azure Monitor автоматически удаляет данные, которые хранятся дольше заданного количества дней. Нулевое значение для периода хранения означает, что данные будут храниться неограниченно долго.

6. Щелкните **Сохранить** и закройте этот раздел.

Данные мониторинга из подписки теперь поступают в учетную запись хранения.

## <a name="route-resource-data-to-the-storage-account"></a>Маршрутизация данных ресурсов в учетную запись хранения

Теперь мы настроим маршрутизацию данных уровня ресурсов (метрики ресурсов и журналы диагностики) в учетную запись записи хранения, задав **параметры диагностики для ресурса**.

1. Нажмите кнопку **Монитор** в списке переходов слева, а затем — **Параметры диагностики**. Здесь можно увидеть список всех ресурсов в подписке, создающих данные мониторинга с помощью Azure Monitor. Если в этом списке нет никаких ресурсов, прежде чем продолжить, можно [создать приложение логики](../logic-apps/quickstart-create-first-logic-app-workflow.md), чтобы получить ресурс, для которого можно настроить параметры диагностики.

2. Щелкните ресурс в списке, а затем выберите **Включить диагностику**.

   ![Включение диагностики](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-turn-on.png)

   Если параметр уже настроен, будут показаны имеющиеся параметры и кнопка **Add diagnostic setting** (Добавить параметр диагностики). Нажмите эту кнопку.

   Параметр диагностики ресурса — это определение того, *какие* данные мониторинга нужно маршрутизировать из определенного ресурса и *куда* их необходимо отправить.

3. В открывшемся разделе назначьте параметру **имя** и установите флажок **Archive to a storage account** (Архивировать в учетную запись хранения).

   ![Раздел параметров диагностики](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-home.png)

4. В разделе **Archive to a storage account** (Архивировать в учетную запись хранения) нажмите кнопку **Конфигурация** и выберите учетную запись хранения, созданную в предыдущем разделе. Последовательно выберите **ОК**.

   ![Параметры диагностики учетной записи хранения](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-storage.png)

5. Установите все флажки в разделе **Журнал** и **Метрика**. В зависимости от типа ресурса у вас может быть только один из этих вариантов. Эти флажки определяют, какие категории журналов и данных метрик, доступные для этого типа ресурса, отправляются в выбранное место назначения (в данном случае в учетную запись хранения).

   ![Категории параметров диагностики](media/monitor-tutorial-archive-monitoring-data/diagnostic-settings-categories.png)

6. Задайте для ползунка **Хранение (в днях)** значение 30. Этот ползунок задает количество дней хранения данных мониторинга в учетной записи хранения. Azure Monitor автоматически удаляет данные, которые хранятся дольше заданного количества дней. Нулевое значение для периода хранения означает, что данные будут храниться неограниченно долго.

7. Выберите команду **Сохранить**.

Данные мониторинга из ресурса теперь поступают в учетную запись хранения.

> [!NOTE]
> Отправка многомерных метрик с помощью параметров диагностики сейчас не поддерживается. Метрики с измерениями экспортируются как преобразованные в плоскую структуру одномерные метрики, агрегированные по значениям измерений.
>
> *Пример.* Метрику "Входящие сообщения" в концентраторе событий можно изучить и вывести в виде диаграммы на уровне очереди. Но при экспорте с помощью параметров диагностики метрика будет представлена в виде всех входящих сообщений для всех очередей концентратора событий.
>
>

## <a name="route-virtual-machine-guest-os-data-to-the-storage-account"></a>Маршрутизация данных виртуальной машины (гостевая ОС) в учетную запись хранения

1. Если у вас нет виртуальной машины в подписке, [создайте ее](../virtual-machines/windows/quick-create-portal.md).

2. В навигационном списке слева на портале щелкните **Виртуальные машины**.

3. В появившемся списке виртуальных машин щелкните созданную виртуальную машину.

4. В появившемся разделе щелкните **Параметры диагностики** на панели навигации слева. В этом разделе можно настроить готовое расширение мониторинга из Azure Monitor на виртуальной машине и маршрутизировать данные, созданные Windows или Linux, в учетную запись хранения.

   ![Переход к параметрам диагностики](media/monitor-tutorial-archive-monitoring-data/guest-navigation.png)

5. В появившемся разделе щелкните **Enable guest-level monitoring** (Включить мониторинг на гостевом уровне).

   ![Включение параметров диагностики](media/monitor-tutorial-archive-monitoring-data/guest-enable.png)

6. После правильного сохранения параметров диагностики на вкладке **Обзор** будет показан список собираемых данных и расположение, в котором они хранятся. Щелкните раздел **Счетчики производительности**, чтобы проверить набор собираемых счетчиков производительности Windows.

   ![Параметры счетчиков производительности](media/monitor-tutorial-archive-monitoring-data/guest-perf-counters.png)

7. Щелкните вкладку **Журналы** и установите флажки для журналов на уровне **Информация** для журналов приложения и системного журнала.

   ![Параметры журналов](media/monitor-tutorial-archive-monitoring-data/guest-logs.png)

8. Щелкните вкладку **Агент** и в разделе **Учетная запись хранения** щелкните имя указанной учетной записи хранения.

   ![Обновление учетной записи хранения](media/monitor-tutorial-archive-monitoring-data/guest-storage-home.png)

9. В открывшемся разделе выберите учетную запись хранения, созданную на предыдущем шаге (**Создание учетной записи хранения**).

10. Выберите команду **Сохранить**.

Данные мониторинга из виртуальных машин теперь поступают в учетную запись хранения.

## <a name="view-the-monitoring-data-in-the-storage-account"></a>Просмотр данных мониторинга в учетной записи хранения

Если выполнены предыдущие шаги, данные будут поступать в учетную запись хранения.

1. Для некоторых типов данных, например журнала активности, должно быть какое-то действие, создающее событие в учетной записи хранения. Для создания действия в журнале действий выполните [эти инструкции](./monitor-quick-audit-notify-action-in-subscription.md). Событие может появиться в учетной записи через пять минут.

2. На портале перейдите к разделу **Учетные записи хранения**, который можно найти в области навигации слева.

3. Идентифицируйте учетную запись хранения, созданную в предыдущем разделе, и щелкните ее.

4. Щелкните **BLOB-объекты**, а затем контейнер **insights-operational-logs** и **name=default**. В этом контейнере содержится журнал действий. Данные мониторинга разбиты на контейнеры по идентификатору ресурса (только идентификаторы подписки для журнала действий), а затем по дате и времени. Полный формат этих больших двоичных объектов:

   insights-operational-logs/name=default/resourceId=/SUBSCRIPTIONS/{ИД подписки}/y={год в четырехзначном формате}/m={месяц в двухзначном формате}/d={день в двухзначном формате}/h={время в двухзначном 24-часовом формате}/m=00/PT1H.json

5. Перейдите к файлу PT1H.json, щелкнув контейнеры, чтобы получить идентификаторы ресурса, дату и время. Щелкните файл PT1H.json, а затем — **Скачать**. Каждый большой двоичный объект PT1H.json содержит большой двоичный объект JSON с событиями, произошедшими в течение часа, указанного в URL-адресе этого объекта (например, h=12). В течение заданного часа события добавляются в файл PT1H.json по мере возникновения. Значение минуты (m=00) всегда равно 00, так как события журнала разбиваются на отдельные большие двоичные объекты каждый час.

   Теперь можно просмотреть событие JSON, сохраненное в учетной записи хранения. Для диагностических журналов ресурсов формат больших двоичных объектов выглядит следующим образом:

   insights-logs-{имя категории журнала}/resourceId=/{идентификатор подписки}/y={год цифрами, 4 цифры}/m={месяц цифрами, 2 цифры}/d={день цифрами, 2 цифры}/h={время цифрами, 2 цифры, 24-часовой формат}/m=00/PT1H.json

6. Данные мониторинга гостевой ОС хранятся в таблицах. Вернитесь на домашнюю страницу учетной записи хранения и щелкните **Таблицы**. Это таблицы для метрик, счетчиков производительности и журналов событий.

Вы успешно настроили архивацию данных мониторинга в учетную запись хранения.

## <a name="clean-up-resources"></a>Очистка ресурсов

1. Перейдите к разделу **Экспорт журнала действий** из предыдущего шага **Маршрутизация журналов подписки в учетную запись хранения** и щелкните **Сброс**.

2. Перейдите к разделу **Параметры диагностики**, щелкните ресурс, в котором был создан параметр диагностики из предыдущего шага **Маршрутизация данных ресурса в учетную запись хранения**, найдите созданный параметр, нажмите кнопку **Настройка параметра** и щелкните **Удалить**.

3. Перейдите в раздел **Параметры диагностики** на виртуальной машине, настроенной на предыдущем шаге **Маршрутизация данных виртуальной машины (гостевая ОС) в учетную запись хранения**, и на вкладке **Агент** щелкните **Удалить** (под разделом **Remove Azure Diagnostics agent** (Удаление агента диагностики Azure)).

4. Перейдите к учетной записи хранения, созданной на предыдущем шаге **Создать учетную запись хранения**, и щелкните **Удалить учетную запись хранения**. Введите имя учетной записи хранения и щелкните **Удалить**.

5. Если для предыдущих шагов была создана виртуальная машина или приложение логики, удалите их.

## <a name="next-steps"></a>Дополнительная информация

В этом руководстве вы узнали, как настроить архивацию данных мониторинга из среды Azure (подписка, ресурс или гостевая ОС) в учетную запись хранения.


> [!div class="checklist"]
> * Создание учетной записи хранения для хранения данных мониторинга.
> * Настройка передачи в нее журналов подписки.
> * Настройка передачи в нее данных ресурсов.
> * Настройка передачи в нее данных виртуальной машины (гостевой ОС).
> * Просмотр сохраненных данных мониторинга.
> * Очистка ресурсов

Чтобы более эффективно использовать свои данные и получать дополнительную информацию, также отправляйте эти данные в Log Analytics.

> [!div class="nextstepaction"]
> [Начало работы с рабочей областью Log Analytics](../log-analytics/log-analytics-get-started.md)
