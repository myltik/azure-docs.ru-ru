---
title: "Устранение неполадок системы диагностики Azure | Документация Майкрософт"
description: "Устранение неполадок при использовании системы диагностики Azure на виртуальных машинах, в Service Fabric или в облачных службах."
services: monitoring-and-diagnostics
documentationcenter: .net
author: rboucher
manager: carmonm
editor: 
ms.assetid: 66469bce-d457-4d1e-b550-a08d2be4d28c
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 03/28/2017
ms.author: robb
ms.translationtype: Human Translation
ms.sourcegitcommit: ff2fb126905d2a68c5888514262212010e108a3d
ms.openlocfilehash: 0764b9f3ac262b7c65944d6e2c82490daefa54c3
ms.contentlocale: ru-ru
ms.lasthandoff: 06/17/2017


---
# <a name="azure-diagnostics-troubleshooting"></a>Устранение неполадок с помощью системы диагностики Azure
Информация об устранении неполадок с помощью системы диагностики Azure. Дополнительные сведения о системе диагностики Azure см. в [обзоре системы диагностики Azure](azure-diagnostics.md).

## <a name="logical-components"></a>Логические компоненты
**Средство запуска подключаемого модуля системы диагностики (DiagnosticsPluginLauncher.exe).** Запускает расширение системы диагностики Azure. Используется в качестве процесса точки входа.

**Подключаемый модуль системы диагностики (DiagnosticsPlugin.exe)** — основной процесс, который запускается с помощью упомянутого выше средства запуска. Этот модуль настраивает и запускает агент наблюдения, а также управляет его временем существования. 

**Агент наблюдения (процессы MonAgent\*.exe).** Эти процессы выполняют большую часть работы, например наблюдение, сбор и передачу данных диагностики.  

## <a name="logartifact-paths"></a>Пути к журналам и артефактам
В таблицах ниже приведены расположения некоторых важных журналов и артефактов, которые используются в остальной части документа.
### <a name="cloud-services"></a>Облачные службы
| Артефакт | Путь |
| --- | --- |
| **Файл конфигурации системы диагностики Azure** | %SystemDrive%\Packages\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\<версия>\Config.txt |
| **Файлы журналов** | C:\Logs\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\<версия>\ |
| **Локальное хранилище данных диагностики** | C:\Resources\Directory\<CloudServiceDeploymentID>.\<RoleName>.DiagnosticStore\WAD0107\Tables |
| **Файл конфигурации агента мониторинга** | C:\Resources\Directory\<CloudServiceDeploymentID>.\<RoleName>.DiagnosticStore\WAD0107\Configuration\MaConfig.xml |
| **Пакет расширений системы диагностики Azure** | %SystemDrive%\Packages\Plugins\Microsoft.Azure.Diagnostics.PaaSDiagnostics\<версия> |
| **Путь к служебной программе сбора журналов** | %SystemDrive%\Packages\GuestAgent\ |

### <a name="virtual-machines"></a>Виртуальные машины
| Артефакт | Путь |
| --- | --- |
| **Файл конфигурации системы диагностики Azure** | C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия>\RuntimeSettings |
| **Файлы журналов** | C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия>\Logs\ |
| **Локальное хранилище данных диагностики** | C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия_системы_диагностики>\WAD0107\Tables |
| **Файл конфигурации агента мониторинга** | C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия_системы_диагностики>\WAD0107\Configuration\MaConfig.xml |
| **Состояние файла** | C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия>\Status |
| **Пакет расширений системы диагностики Azure** | C:\Packages\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия_системы_диагностики>|
| **Путь к служебной программе сбора журналов** | C:\WindowsAzure\Packages |

## <a name="azure-diagnostics-is-not-starting"></a>Система диагностики Azure не запускается
Сведения о том, почему диагностика не запускается, можно просмотреть в файлах журнала **DiagnosticsPluginLauncher.log** и **DiagnosticsPlugin.log**. Их расположение указано выше.  

В последней строке файлов журнала указан код выхода.  

```
DiagnosticsPluginLauncher.exe Information: 0 : [4/16/2016 6:24:15 AM] DiagnosticPlugin exited with code 0
```
Если код выхода имеет **отрицательное значение**, ознакомьтесь с [таблицей кодов выхода](#azure-diagnostics-plugin-exit-codes) в разделе [Рекомендации](#references).

## <a name="diagnostics-data-is-not-logged-to-azure-storage"></a>Журнал данных диагностики не записывается в службу хранилища Azure
Определите, не отображаются ли все данные или только их часть.

### <a name="diagnostics-infrastructure-logs"></a>Журналы инфраструктуры диагностики
В журналах инфраструктуры диагностики записываются все ошибки системы диагностики Azure. Убедитесь, что вы включили сбор журналов инфраструктуры диагностики в конфигурации и просмотрите соответствующие ошибки в таблице `DiagnosticInfrastructureLogsTable` в настроенной учетной записи хранения. Дополнительные сведения о проверке см. в [этом разделе](#how-to-check-diagnostics-extension-configuration).

### <a name="no-data-is-showing-up"></a>Данные не отображаются
Наиболее распространенная причина отсутствия данных событий — это некорректно определенная информация об учетной записи хранения.

Решение. Исправьте файл конфигурации системы диагностики и переустановите систему диагностики.

Если учетная запись хранения настроена правильно, подключитесь к удаленному рабочему столу виртуальной машины и проверьте, выполняются ли процессы DiagnosticsPlugin.exe и MonAgentCore.exe. Если они не выполняются, см. сведения в разделе [Система диагностики Azure не запускается](#azure-diagnostics-is-not-starting). Если процессы выполняются, проверьте [сохраняются ли собранные данные локально](#is-data-getting-captured-locally).

### <a name="part-of-the-data-is-missing"></a>Отсутствует часть данных
В некоторых случаях вы можете получать не все данные. Это означает, что конвейер сбора и передачи данных настроен правильно. Выполните указания из подразделов ниже, чтобы сузить список возможных проблем.
#### <a name="is-collection-configured"></a>Проверка параметров сбора 
Сбор определенных типов данных указывается в конфигурации системы диагностики. [Проверьте конфигурацию](#how-to-check-diagnostics-extension-configuration) и проверьте, указали ли вы раздел для сбора нужного типа данных.
#### <a name="is-the-host-generating-data"></a>Проверка создания данных узлом
- **Счетчики производительности.** Откройте системный монитор и проверьте значение счетчика.
- **Журналы трассировки.** Подключитесь к удаленному рабочему столу виртуальной машины и добавьте экземпляр TextWriterTraceListener в файл конфигурации приложения.  Сведения о настройке прослушивателя трассировки см. в этой статье: http://msdn.microsoft.com/en-us/library/sk36c28t.aspx.  Проверьте, имеет ли элемент `<trace>` значение `<trace autoflush="true">`.<br />
Если журналы трассировки не создаются, см. сведения в разделе [Подробные сведения об отсутствии журналов трассировки](#more-about-trace-logs-missing).
 - **Трассировка событий Windows.** Подключитесь к удаленному рабочему столу виртуальной машины и установите PerfView.  Откройте средство PerfView и выберите File (Файл) > User Command (Пользовательская команда), а затем выполните команду Listen, указав при этом необходимых поставщиков ETW.  Обратите внимание, что команда Listen учитывает регистр. Поставщиков ETW следует указывать через запятые без пробелов.  Если выполнение этой команды завершилось сбоем, нажмите кнопку Log (Журнал) в правом нижнем углу средства Perfview, чтобы просмотреть попытки и результаты запуска.  Если все входные данные верны, через несколько секунд откроется новое окно с событиями трассировки событий Windows.
- **Журналы событий.** Подключитесь к удаленному рабочему столу виртуальной машины. Откройте `Event Viewer` и проверьте, записаны ли там события.
#### <a name="is-data-getting-captured-locally"></a>Проверка локального сохранения данных
Проверьте, сохраняются ли данные локально.
По умолчанию эти данные хранятся в `*.tsf` файлах TSF в [локальном хранилище данных диагностики](#log-artifacts-path). Каждый тип журнала записывается в разные файлы `.tsf`. Их имена напоминают имена таблиц в службе хранилища Azure. Например, показатели счетчиков `Performance Counters` производительности записываются в файл `PerformanceCountersTable.tsf`, а данные журналов событий — в файл `WindowsEventLogsTable.tsf`. Откройте локальный набор файлов, используя указания в разделе [Извлечение локального журнала](#local-log-extraction), и проверьте, записываются ли они на диск.

Если локальные журналы не сохраняются локально и узел создает данные, скорее всего проблема связана с конфигурацией. Тщательно проверьте соответствующий раздел конфигурации. Кроме того, просмотрите файл конфигурации агента наблюдения ([MaConfig.xml](#log-artifacts-path)) и проверьте, задан ли раздел с описанием соответствующего исходного журнала и не возникают ли сложности с переводом между конфигурацией системы диагностики Azure и конфигурацией агента наблюдения.
#### <a name="is-data-getting-transferred"></a>Проверка передачи данных
Если данные сохраняются локально, но по-прежнему не отображаются в учетной записи хранения, выполните действия ниже. 
- Прежде всего проверьте, указали ли вы правильную учетную запись хранения и не отзывали ли вы ее ключи. Иногда пользователи облачных служб не обновляют раздел `useDevelopmentStorage=true`.
- Если учетная запись хранения указана правильно, проверьте наличие каких-либо ограничений сети, блокирующих доступ компонентов к конечным точкам общедоступного хранилища. Это можно сделать, подключившись к удаленному рабочему столу виртуальной машины и создав запись в той же учетной записи хранения.
- Наконец, вы можете просмотреть ошибки агента наблюдения. Агент наблюдения записывает свои журналы в файл `maeventtable.tsf` в [локальном хранилище данных диагностики](#log-artifacts-path). Откройте этот файл, выполнив указания в разделе [Извлечение локального журнала](#local-log-extraction), и проверьте `errors` чтение локальных файлов или записи в хранилище.

### <a name="capturing--archiving-logs"></a>Архивация и запись журналов
Если действия из предыдущих разделов не позволили определить проблему, возможно, вы захотите обратиться в службу поддержки. Первое, что они могут вас попросить, — это собрать журналы с компьютера. Вы можете сэкономить время, сделав это самостоятельно. Запустите служебную программу `CollectGuestLogs.exe`, расположенную в [этой папке](#log-artifacts-path). В той же папке она создаст ZIP-файл со всеми соответствующими журналами Azure.

## <a name="diagnostics-data-tables-not-found"></a>Таблицы данных диагностики не найдены
Таблицы в службе хранилища Azure, содержащие события трассировки событий Windows, именуются с помощью следующего кода:

```C#
        if (String.IsNullOrEmpty(eventDestination)) {
            if (e == "DefaultEvents")
                tableName = "WADDefault" + MD5(provider);
            else
                tableName = "WADEvent" + MD5(provider) + eventId;
        }
        else
            tableName = "WAD" + eventDestination;
```

Пример:

```XML
        <EtwEventSourceProviderConfiguration provider=”prov1”>
          <Event id=”1” />
          <Event id=”2” eventDestination=”dest1” />
          <DefaultEvents />
        </EtwEventSourceProviderConfiguration>
        <EtwEventSourceProviderConfiguration provider=”prov2”>
          <DefaultEvents eventDestination=”dest2” />
        </EtwEventSourceProviderConfiguration>
```
```JSON
"EtwEventSourceProviderConfiguration": [
    {
        "provider": "prov1",
        "Event": [
            {
                "id": 1
            },
            {
                "id": 2,
                "eventDestination": "dest1"
            }
        ],
        "DefaultEvents": {
            "eventDestination": "DefaultEventDestination",
            "sinks": ""
        }
    },
    {
        "provider": "prov2",
        "DefaultEvents": {
            "eventDestination": "dest2"
        }
    }
]
```
Создается 4 таблицы:

| Событие | Имя таблицы |
| --- | --- |
| provider=”prov1” &lt;Event id=”1” /&gt; |WADEvent+MD5(“prov1”)+”1” |
| provider=”prov1” &lt;Event id=”2” eventDestination=”dest1” /&gt; |WADdest1 |
| provider=”prov1” &lt;DefaultEvents /&gt; |WADDefault+MD5(“prov1”) |
| provider=”prov2” &lt;DefaultEvents eventDestination=”dest2” /&gt; |WADdest2 |

## <a name="references"></a>Ссылки

### <a name="how-to-check-diagnostics-extension-configuration"></a>Как проверить конфигурацию расширения системы диагностики
Самый простой способ проверить конфигурацию расширения — перейти на сайт http://resources.azure.com и выбрать виртуальную машину или облачную службу, где выполняется нужное расширение системы диагностики Azure (IaaSDiagnostics или PaaDiagnostics).

Кроме того, вы можете подключиться к удаленному рабочему столу виртуальной машины и просмотреть файл конфигурации системы диагностики Azure, как описано [здесь](#log-artifacts-path).

В любом случае выполните поиск **Microsoft.Azure.Diagnostics**, а затем найдите поле **xmlCfg** или **WadCfg**. 

Если вы проверяете расширение на виртуальных машинах и видите поле WadCfg, то это означает, что файл конфигурации имеет формат JSON. Если вы видите поле xmlCfg, то это означает, что файл конфигурации имеет формат XML и кодировку Base64. Его необходимо [декодировать](http://www.bing.com/search?q=base64+decoder), чтобы увидеть XML-файл, который был загружен системой диагностики.

Если вы проверяете расширение в облачной службе и открыли файл конфигурации на диске, данные в нем будут в кодировке base64, поэтому необходимо [раскодировать их](http://www.bing.com/search?q=base64+decoder), чтобы просмотреть данные XML, загруженные системой диагностики.

### <a name="azure-diagnostics-plugin-exit-codes"></a>Коды выхода подключаемого модуля системы диагностики Azure
Подключаемый модуль возвращает следующие коды выхода:

| Код выхода | Описание |
| --- | --- |
| 0 |Успешно. |
| -1 |Общая ошибка. |
| -2 |Невозможно загрузить RCF-файл.<p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -3 |Не удалось загрузить файл конфигурации системы диагностики.<p><p>Решение. Это вызвано тем, что файл конфигурации не прошел проверку схемы. Следует предоставить файл конфигурации, соответствующий схеме. |
| -4 |Другой экземпляр системы диагностики агента мониторинга уже использует локальный каталог ресурсов.<p><p>Решение. Укажите другое значение для **LocalResourceDirectory**. |
| -6 |Попытка средства запуска подключаемого модуля гостевого агента запустить систему диагностики с помощью неправильно составленной команды.<p><p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -10 |Подключаемый модуль системы диагностики был завершен с необработанным исключением. |
| -11 |Гостевому агенту не удалось создать процесс, ответственный за запуск и мониторинг агента мониторинга.<p><p>Решение. Убедитесь, что доступных системных ресурсов достаточно для запуска новых процессов.<p> |
| -101 |Недопустимые аргументы при вызове подключаемого модуля системы диагностики.<p><p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -102 |Процесс подключаемого модуля не может инициализироваться.<p><p>Решение. Убедитесь, что доступных системных ресурсов достаточно для запуска новых процессов. |
| -103 |Процесс подключаемого модуля не может инициализироваться. А именно: не удается создать объект средства ведения журнала.<p><p>Решение. Убедитесь, что доступных системных ресурсов достаточно для запуска новых процессов. |
| -104 |Не удалось загрузить RCF-файл, предоставленный гостевым агентом.<p><p>Эта внутренняя ошибка возникает только тогда, когда средство запуска подключаемого модуля гостевого агента вызвано вручную, неправильно и на виртуальной машине. |
| -105 |Подключаемому модулю системы диагностики не удается открыть файл конфигурации системы диагностики.<p><p>Эта внутренняя ошибка возникает только тогда, когда подключаемый модуль системы диагностики вызван вручную, неправильно и на виртуальной машине. |
| -106 |Не удалось прочитать файл конфигурации системы диагностики.<p><p>Решение. Это вызвано тем, что файл конфигурации не прошел проверку схемы. Решением будет предоставить файл конфигурации, соответствующий схеме. Дополнительные сведения см. в разделе [Как проверить конфигурацию расширения системы диагностики](#how-to-check-diagnostics-extension-configuration). |
| -107 |Недопустимая передача каталога ресурсов в агент мониторинга.<p><p>Эта внутренняя ошибка может возникать, только если агент мониторинга вызван вручную, неправильно и на виртуальной машине.</p> |
| -108 |Не удалось преобразовать файл конфигурации системы диагностики в файл конфигурации агента мониторинга.<p><p>Эта внутренняя ошибка может возникать, только если подключаемый модуль системы диагностики вызван с помощью недопустимого файла конфигурации. |
| -110 |Общая ошибка конфигурации системы диагностики.<p><p>Эта внутренняя ошибка может возникать, только если подключаемый модуль системы диагностики вызван с помощью недопустимого файла конфигурации. |
| -111 |Не удалось запустить агент мониторинга.<p><p>Решение. Убедитесь, что доступен достаточный объем системных ресурсов. |
| -112 |Общая ошибка |

### <a name="local-log-extraction"></a>Извлечение локального журнала
Агент наблюдения сохраняет данные журналов и артефактов как `.tsf` файлы TSF. `.tsf` Файл TSF недоступен для чтения, но его можно преобразовать в формат CSV с помощью `.csv` следующей служебной программы: 

```
<Azure diagnostics extension package>\Monitor\x64\table2csv.exe <relevantLogFile>.tsf
```
После этого создается файл `<relevantLogFile>.csv` в том же расположении, что и соответствующий файл TSF. `.tsf`

**Примечание.** С помощью этой служебной программы нужно преобразовать только основной файл TSF (например, PerformanceCountersTable.tsf). Все сопутствующие файлы (например, PerformanceCountersTables_\*\*001.tsf, PerformanceCountersTables_\*\*002.tsf и т. д.) обрабатываются автоматически.

### <a name="more-about-trace-logs-missing"></a>Подробные сведения об отсутствии журналов трассировки

**Примечание.** Этот раздел главным образом относится к облачным службам, если вы не настроили DiagnosticsMonitorTraceListener в приложении, выполняющемся на виртуальной машине IaaS. 

- Проверьте, включен ли класс DiagnosticMonitorTraceListener в файле web.config или app.config.  Этот класс по умолчанию настроен в проектах облачных служб, но некоторые клиенты могут закомментировать его, в результате чего система диагностики не собирает трассировочные операторы. 
- Если журналы не записываются из метода OnStart или Run проверьте наличие класса DiagnosticMonitorTraceListener в файле app.config.  По умолчанию он находится в файле web.config, но применяется только к коду, выполненному в средстве w3wp.exe. Поэтому этот класс также нужно определить в файле app.config, чтобы собирать трассировки, выполненные в средстве WaIISHost.exe.
- Убедитесь, что вы используете Diagnostics.Trace.TraceXXX, а не Diagnostics.Debug.WriteXXX.  Операторы отладки удаляются из конечной сборки.
- Проверьте, имеет ли скомпилированный код строки Diagnostics.Trace (для проверки используйте Reflector, ildasm или ILSpy).  Команды Diagnostics.Trace удаляются из скомпилированного двоичного файла, если не используется символ условной компиляции трассировки.  Если для сборки проекта используется msbuild, это обычная проблема.

## <a name="known-issues-and-mitigations"></a>Известные проблемы и устранения рисков
Ниже приведен список известных проблем и способы их устранения.

**1. Зависимость от .NET 4.5.**

Система диагностики Azure имеет зависимость среды выполнения на платформе .NET 4.5 или более поздней версии. На момент написания этой статьи на всех виртуальных машинах, подготовленных для облачных служб, а также во всех официальных базовых образах виртуальных машин Azure, установлена платформа .NET 4.5 или более поздней версии. Но все же есть вероятность того, что вы можете запустить систему диагностики Azure на виртуальной машине с платформой .NET предыдущих версий. Например, если создаете виртуальную машину на основе старого образа (моментального снимка) или с помощью собственного диска.

В этом случае при запуске DiagnosticsPluginLauncher.exe возвращается код выхода **255**. Сбой происходит из-за необработанного исключения: 
```
System.IO.FileLoadException: Could not load file or assembly 'System.Threading.Tasks, Version=1.5.11.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a' or one of its dependencies
```

**Устранение.** Установите на виртуальной машине платформу .NET 4.5 или более поздней версии.

**2. Данные счетчиков производительности доступные в хранилище, но не отображаются на портале.**

На портале виртуальных машин данные определенных счетчиков производительности отображаются по умолчанию. Иногда эти данные не отображаются на портале, но доступны в хранилище. Убедитесь, что:
- Имена счетчиков в этих данных указаны на английском. В противном случае диаграмма метрик на портале не сможет распознать их.
- Если вы используете подстановочные знаки (\*) в именах счетчиков производительности, портал не сможет отслеживать настроенные и собранные показатели счетчика.

**Устранение.** Изменить язык системных учетных записей виртуальной машины на английский. Для этого откройте панель управления, выберите "Регион > Дополнительно > Настройка копирования" и снимите флажок "Экран приветствия и системные учетные записи". После этого пользовательские параметры языка не будут применяться к системной учетной записи. Кроме того, удалите подстановочные знаки, если хотите, чтобы данные о потреблении отображались на портале.

