---
title: Общие сведения о журнале действий Azure | Документация Майкрософт
description: Узнайте, что такое журнал действий Azure и как его использовать для просмотра событий, происходящих в рамках подписки Azure.
author: johnkemnetz
manager: orenr
editor: ''
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: c274782f-039d-4c28-9ddb-f89ce21052c7
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/04/2018
ms.author: johnkem
ms.openlocfilehash: 9768fd96b8023ac97d8c5711e0c02f2c147e28f6
ms.sourcegitcommit: 5b2ac9e6d8539c11ab0891b686b8afa12441a8f3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
# <a name="monitor-subscription-activity-with-the-azure-activity-log"></a>Мониторинг действий подписки с помощью журнала действий Azure

**Журнал действий Azure** — это журнал подписки с подробными сведениями о событиях на уровне подписки, которые произошли в Azure. Сюда входят различные данные — от операционных данных Azure Resource Manager до обновлений в событиях работоспособности службы. Журнал действий раньше назывался журналом аудита или операционным журналом, так как категория "Административная" содержит связанные с подписками события на уровне управления. С помощью журнала изменений можно ответить на вопросы "что? кто? когда?" о любой операции записи (PUT, POST, DELETE) с ресурсами в вашей подписке. Вы также можете отслеживать состояние операции и другие ее свойства. Журнал действий не содержит операции чтения (GET) или операции с ресурсами, которые используют классическую модель или модель RDFE.

![Журналы действий и другие типы журналов ](./media/monitoring-overview-activity-logs/Activity_Log_vs_other_logs_v5.png)

Рис. 1. Журналы действий и другие типы журналов

Журналы действий отличаются от [журналов диагностики](monitoring-overview-of-diagnostic-logs.md). Журналы действий предоставляют внешние данные об операциях с ресурсами (плоскость управления). Журналы диагностики выдаются ресурсом и содержат данные о его работе (плоскость данных).

> [!WARNING]
> Журнал действий Azure используется главным образом для действий, которые происходят в Azure Resource Manager. Ресурсы, использующие классическую модель или модель RDFE, не отслеживаются. Для некоторых классических типов ресурсов в Azure Resource Manager имеется прокси-поставщик ресурсов (например, Microsoft.ClassicCompute). Если вы взаимодействуете с ресурсом классического типа через Azure Resource Manager с помощью этих прокси-поставщиков ресурсов, то такие операции отображаются в журнале действий. Если вы взаимодействуете с ресурсом классического типа за пределами прокси Azure Resource Manager, ваши действия записываются только в журнал операций. Журнал операций можно просмотреть в отдельном разделе портала.
>
>

События из журнала изменений можно получить с помощью портала Azure, интерфейса командной строки, командлетов PowerShell или REST API Azure Monitor.

> [!NOTE]
>  [Новые оповещения](monitoring-overview-unified-alerts.md) сейчас предоставляют дополнительные возможности для создания и администрирования правил генерации оповещений для журнала действий.  [Узнайте больше](monitoring-activity-log-alerts-new-experience.md).

Просмотрите следующее ознакомительное видео о журнале действий:
> [!VIDEO https://channel9.msdn.com/Blogs/Seth-Juarez/Logs-John-Kemnetz/player]


## <a name="categories-in-the-activity-log"></a>Категории в журнале действий
Журнал действий содержит несколько категорий данных. Подробные сведения о схемах этих категорий см. в [этой статье](monitoring-activity-log-schema.md). в частности такие:
* **Административная**. Эта категория содержит записи всех операций создания, обновления, удаления и других действий, которые выполняются через Resource Manager. В качестве примеров типов событий, которые относятся к этой категории, можно назвать "создание виртуальной машины" или "удаление группы безопасности сети". Каждое действие, выполняемое пользователем или приложением с помощью Resource Manager, моделируется как операция с определенным типом ресурсов. Если тип операции — "запись", "удаление" или "действие", то любые сведения об этой операции (о ее запуске, успешном выполнении или сбое) записываются в категорию "Административная". Категория "Административная" также включает в себя любые изменения в управлении доступом на основе ролей, которые происходят в подписке.
* **Работоспособность службы**. Эта категория содержит записи всех инцидентов, связанных с работоспособностью службы, которые произошли в Azure. В качестве примера типа события из этой категории можно назвать следующее: "В работе SQL Azure в восточной части США наблюдаются простои". Существует шесть разновидностей событий работоспособности службы: "Требуется действие", "Помощь при восстановлении", "Инцидент", "Обслуживание", "Сведения" и "Безопасность". Они отображаются, только если в подписке есть ресурс, на который повлияет данное событие.
* **Оповещение**. Эта категория содержит записи всех активаций оповещений Azure. В качестве примера типа события из этой категории можно назвать следующее: "Процент использования ЦП на виртуальной машине myVM за последние 5 минут превышал 80 %". Различные системы Azure работают по принципу оповещений, то есть вы можете определить какое-то правило, и система будет направлять вам уведомление, когда условия этого правила выполняются. Каждый раз, когда "активируется" поддерживаемый тип оповещения Azure или выполняются условия для создания уведомления, в эту категорию журнала активности также передается запись об активации.
* **Автомасштабирование**. Эта категория содержит записи всех событий, связанных с операциями системы автоматического масштабирования, в основе которой лежат параметры автомасштабирования, определенные в подписке. В качестве примера типа события из этой категории можно назвать следующее: "Не удалось выполнить автоматическое увеличение масштаба". С помощью функции автомасштабирования можно автоматически увеличивать или уменьшать число экземпляров в поддерживаемом типе ресурсов на основе времени суток и (или) загружать данные (метрики), используя параметр автомасштабирования. Когда выполняются условия для увеличения или уменьшения масштаба, в эту категорию записываются соответствующие события (запуск, успешное выполнение или сбой).
* **Рекомендация**. Эта категория содержит события рекомендации из определенных типов ресурсов, таких как веб-сайты и серверы SQL Server. Эти события предоставляют рекомендации о лучшем использовании ресурсов. Вы будете получать события этого типа, только если у вас будут ресурсы, которые генерируют рекомендации.
* **Безопасность**. Эта категория содержит запись любых предупреждений, созданных центром безопасности Azure. Примером типа события в этой категории является "Выполнен подозрительный файл с двойным расширением".
* **Политика и работоспособность ресурсов**. Эти категории не содержат никаких событий. Они зарезервированы для использования в будущем.

## <a name="event-schema-per-category"></a>Схема событий по категориям
[Ознакомьтесь с этой статьей, чтобы понять, как устроена схема событий журнала действий по категориям.](monitoring-activity-log-schema.md)

## <a name="what-you-can-do-with-the-activity-log"></a>Что можно делать с журналом действий
Ниже описано несколько доступных операций с журналом действий.

![Журнал действий Azure](./media/monitoring-overview-activity-logs/Activity_Log_Overview_v3.png)


* Запросы и просмотры журнала на **портале Azure**.
* [Создание оповещения о событии журнала действий Azure.](monitoring-activity-log-alerts.md)
* [Потоковая передача журнала в **концентратор событий**](monitoring-stream-activity-logs-event-hubs.md) для обработки в сторонней службе или пользовательском аналитическом решении, например PowerBI.
* Анализ журнала в PowerBI с помощью [**пакета содержимого PowerBI**](https://powerbi.microsoft.com/documentation/powerbi-content-pack-azure-audit-logs/).
* [Сохранение журнала в **учетную запись хранения** для архивации или проверки вручную](monitoring-archive-activity-log.md). В **профиле журнала** можно задать время хранения (в днях).
* Обращение к журналу с помощью командлетов PowerShell, интерфейса командной строки или REST API.

## <a name="query-the-activity-log-in-the-azure-portal"></a>Запрос журнала действий на портале Azure
На портале Azure журнал действий можно просмотреть в нескольких расположениях:
* В области **Журнал действий**, к которой можно перейти, выполнив поиск журнала действий в разделе **Все службы** на панели навигации слева.
* В области **Монитор**, которая по умолчанию отображается на панели навигации слева. Журнал действий занимает один раздел Azure Monitor.
* В разделе любого **ресурса**, например в колонке конфигурации виртуальной машины. Журнал действий занимает один из разделов в большинстве этих колонок ресурсов, и если щелкнуть его, события будут автоматически отфильтрованы в соответствии с данным ресурсом.

На портале Azure можно отфильтровать журнал действий по приведенным ниже полям.
* "Временной интервал": время начала и окончания событий.
* "Категория": категории событий, как описано выше.
* "Подписка": одно или несколько имен подписок Azure.
* "Группа ресурсов": одна или несколько групп ресурсов в этих подписках.
* "Имя ресурса": имя определенного ресурса.
* "Тип ресурса": тип ресурса, например, Microsoft.Compute/virtualmachines.
* "Имя операции": имя операции Azure Resource Manager, например Microsoft.SQL/servers/Write.
* "Серьезность": уровень серьезности события ("Информационное", "Предупреждение", "Ошибка", "Критическое").
* "Кем инициировано событие": "вызывающая сторона" или пользователь, выполнивший операцию.
* "Открыть поиск": текстовое поле поиска, с помощью которого можно искать указанную строку во всех полях всех событий.

Определив набор фильтров, его можно сохранить как запрос, который сохраняется между сеансами, если в будущем вам понадобится выполнять такой же запрос с этими фильтрами. Этот запрос можно также закрепить на панели мониторинга Azure, чтобы всегда следить за определенными событиями.

Если щелкнуть "Применить", будет выполнен запрос и показаны все соответствующие ему события. Если щелкнуть любое событие в списке, отобразится сводка по этому событию, а также полные необработанные данные JSON для него.

Чтобы еще больше расширить возможности, можно щелкнуть значок **Поиск по журналу**. Это позволит отобразить данные журнала действий в [решении Log Analytics для аналитики журнала действий](../log-analytics/log-analytics-activity.md). В колонке "Журнал действий" доступны основные фильтры и средства обзора журналов, тогда как Log Analytics позволяет сводить, запрашивать и визуализировать данные более эффективными способами.

## <a name="export-the-activity-log-with-a-log-profile"></a>Экспорт журнала действий с помощью профиля журнала
**Профиль журнала** определяет, как экспортируется журнал действий. С помощью профиля журнала вы можете настроить следующие параметры.

* Куда будет отправлен журнал действий (учетная запись хранения или концентраторы событий).
* Какие категории событий будут отправляться (запись, удаление, действие). *Термин "категория" имеет разное значение в профилях журнала и событиях журнала действий. В профиле журнала "категория" обозначает тип операции (запись, удаление, действие). А в событии журнала действий "категория" представляет источник или тип события (например, Administration, ServiceHealth, Alert и т. д.).*
* Какие регионы (расположения) будут экспортированы. Обязательно укажите глобальное расположение, так как в журнале действий существует множество глобальных событий.
* Как долго должен храниться журнал действий в учетной записи хранения.
    - Срок хранения 0 дней означает, что журналы хранятся неограниченно долго. В противном случае укажите количество дней в диапазоне от 1 до 2 147 483 647.
    - Если политики хранения заданы, но хранение журналов в учетной записи хранения отключено (например, выбраны только концентраторы событий или Log Analytics), политики хранения не будут применены.
    - Политики хранения применяются по дням, поэтому в конце дня (по времени в формате UTC) журналы, срок которых теперь превышает период хранения, будут удалены. Например, если настроена политика хранения в течение одного дня, то в начале текущего дня журналы за вчерашний день будет удалены.

Вы можете использовать учетную запись хранения или пространство имен концентратора событий, не входящее в подписку, в которой создаются журналы. Пользователю, который настраивает этот параметр, должен быть предоставлен соответствующий уровень доступа RBAC к обеим подпискам.

Эти параметры можно настроить с помощью параметра "Экспорт" в колонке журнала изменений на портале. Их также можно настроить программно [с помощью REST API Azure Monitor](https://msdn.microsoft.com/library/azure/dn931927.aspx), командлетов PowerShell или интерфейса командной строки. Для каждой подписки может существовать только один профиль журнала.

### <a name="configure-log-profiles-using-the-azure-portal"></a>Настройка профилей журнала на портале Azure
С помощью параметра "Экспорт" на портале Azure можно выполнить потоковую передачу журнала действий в концентратор событий или сохранить журнал в учетную запись хранения.

1. Перейдите к области **Журнал действий** с помощью меню в левой части портала.

    ![Переход к журналу действий на портале](./media/monitoring-overview-activity-logs/activity-logs-portal-navigate.png)
2. Нажмите кнопку **Экспорт** в верхней части колонки.

    ![Кнопка экспорта на портале](./media/monitoring-overview-activity-logs/activity-logs-portal-export.png)
3. В появившейся колонке вы можете выбрать следующие параметры:  
  * регионы, события которых нужно экспортировать;
  * учетная запись хранения, в которой вы хотите сохранить события;
  * сколько дней следует хранить эти события в хранилище (если выбрать значение "0 дней", журналы будут храниться бессрочно);
  * пространство имен служебной шины, в котором следует создать концентратор событий для потоковой передачи этих событий.

     ![Колонка экспорта журнала действий](./media/monitoring-overview-activity-logs/activity-logs-portal-export-blade.png)
4. Нажмите кнопку **Сохранить** , чтобы сохранить эти параметры. Параметры будут немедленно применены к подписке

### <a name="configure-log-profiles-using-the-azure-powershell-cmdlets"></a>Настройка профилей журнала с помощью командлетов Azure PowerShell

#### <a name="get-existing-log-profile"></a>Получение существующего профиля журнала

```
Get-AzureRmLogProfile
```

#### <a name="add-a-log-profile"></a>Добавление профиля журнала

```
Add-AzureRmLogProfile -Name my_log_profile -StorageAccountId /subscriptions/s1/resourceGroups/myrg1/providers/Microsoft.Storage/storageAccounts/my_storage -serviceBusRuleId /subscriptions/s1/resourceGroups/Default-ServiceBus-EastUS/providers/Microsoft.ServiceBus/namespaces/mytestSB/authorizationrules/RootManageSharedAccessKey -Locations global,westus,eastus -RetentionInDays 90 -Categories Write,Delete,Action
```

| Свойство | Обязательно | ОПИСАНИЕ |
| --- | --- | --- |
| ИМЯ |Yes |Имя профиля журнала. |
| StorageAccountId |Нет  |Идентификатор ресурса для учетной записи хранения, в которую будет сохранен журнал действий. |
| serviceBusRuleId |Нет  |Идентификатор правила служебной шины для пространства имен служебной шины, в котором вы будут созданы концентраторы событий. Это строка в таком формате: `{service bus resource ID}/authorizationrules/{key name}`. |
| Расположения |Yes |Разделенный запятыми список регионов, для которых будут собираться события журнала действий. |
| RetentionInDays |Yes |Количество дней, в течение которых будут храниться события: от 1 до 2 147 483 647. Нулевое значение означает, что журналы хранятся неограниченно долго, то есть всегда. |
| Категории |Нет  |Разделенный запятыми список категорий событий, которые будут собираться. Возможные значения: Write, Delete или Action. |

#### <a name="remove-a-log-profile"></a>Удаление профиля журнала
```
Remove-AzureRmLogProfile -name my_log_profile
```

### <a name="configure-log-profiles-using-the-azure-cli-20"></a>Настройка профилей журнала с использованием Azure CLI 2.0

#### <a name="get-existing-log-profile"></a>Получение существующего профиля журнала

```azurecli
az monitor log-profiles list
az monitor log-profiles show --name <profile name>
```

Свойство `name` должно содержать имя профиля журнала.

#### <a name="add-a-log-profile"></a>Добавление профиля журнала

```azurecli
az monitor log-profiles create --name <profile name> \
    --locations <location1 location2 ...> \
    --location <location> \
    --categories <category1 category2 ...>
```

Полную документацию по созданию профиля монитора с помощью CLI см. в [справочнике по командам CLI](/cli/azure/monitor/log-profiles#az-monitor-log-profiles-create).

#### <a name="remove-a-log-profile"></a>Удаление профиля журнала

```azurecli
az monitor log-profiles delete --name <profile name>
```

## <a name="next-steps"></a>Дальнейшие действия
* [Дополнительные сведения о журнале действий (прежнее название — журналы аудита)](../azure-resource-manager/resource-group-audit.md)
* [Потоковая передача журнала действий Azure в концентраторы событий](monitoring-stream-activity-logs-event-hubs.md)
