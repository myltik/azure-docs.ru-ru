---
title: "Рекомендации по автомасштабированию | Документы Майкрософт"
description: "Шаблоны автоматического масштабирования в веб-приложениях службы приложений Azure, масштабируемых наборах виртуальных машин и облачных службах"
author: anirudhcavale
manager: orenr
editor: 
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: 9fa2b94b-dfa5-4106-96ff-74fd1fba4657
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/07/2017
ms.author: ancav
ms.openlocfilehash: d5b33b15c315c7538bba7bf9ae067946f3b6d3c4
ms.sourcegitcommit: fa28ca091317eba4e55cef17766e72475bdd4c96
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2017
---
# <a name="best-practices-for-autoscale"></a>Рекомендации по автомасштабированию
В этой статье даны рекомендации по автомасштабированию в Azure. Автомасштабирование Azure Monitor используется только с [масштабируемыми наборами виртуальных машин](https://azure.microsoft.com/services/virtual-machine-scale-sets/), [облачными службами](https://azure.microsoft.com/services/cloud-services/) и [веб-приложениями службы приложений](https://azure.microsoft.com/services/app-service/web/). Прочие службы Azure используют другие методы масштабирования.

## <a name="autoscale-concepts"></a>Основные понятия автомасштабирования
* У ресурса может быть только *один* параметр автомасштабирования.
* У параметра автомасштабирования может быть один или несколько профилей, и каждый профиль может содержать одно или несколько правил автомасштабирования.
* Параметр автомасштабирования обеспечивает горизонтальное масштабирование экземпляров, то есть *развертывает* их, увеличивая количество экземпляров, или *свертывает*, уменьшая их количество.
  Параметр автомасштабирования определяет максимальное, минимальное и используемое по умолчанию число экземпляров.
* Задание автомасштабирования всегда считывает связанную метрику для масштабирования по ней, проверяя, превышено ли пороговое значение для развертывания или свертывания. Список метрик для автомасштабирования можно просмотреть в статье, посвященной [общим метрикам автомасштабирования Azure Monitor](insights-autoscale-common-metrics.md).
* Все пороговые значения вычисляются на уровне экземпляров. Например, инструкция "развернуть еще один экземпляр, если средняя загрузка ЦП > 80 % и количество экземпляров равно 2" означает, что развертывание выполняется, когда средняя загрузка ЦП во всех экземплярах превышает 80 %.
* Все ошибки автомасштабирования записываются в журнал действий. Затем можно настроить [оповещение журнала действий](./monitoring-activity-log-alerts.md), чтобы в случае сбоя автоматического масштабирования получать уведомления при помощи электронной почты, SMS, веб-перехватчика и т. д.
* Сведения обо всех успешных действиях при масштабировании также публикуются в журнале действий. Вы можете настроить оповещение журнала действий, чтобы при каждом успешном действии автомасштабирования получать уведомления при помощи электронной почты, SMS, веб-перехватчика и т. д. Также можно настроить уведомления по электронной почте или через веб-перехватчики, чтобы узнавать об успешных действиях масштабирования посредством вкладки уведомлений в настройках автомасштабирования.

## <a name="autoscale-best-practices"></a>Рекомендации по автомасштабированию
Используйте следующие рекомендации для автомасштабирования.

### <a name="ensure-the-maximum-and-minimum-values-are-different-and-have-an-adequate-margin-between-them"></a>Обязательно используйте разные минимальное и максимальное значения с соответствующим интервалом между ними
Если у вас есть параметр, у которого максимальное и минимальное значения равны 2, и текущее количество экземпляров равно 2, масштабирование будет невозможно. Обеспечьте достаточный интервал между минимальным и максимальным количеством экземпляров, включая их предельное количество. Служба автомасштабирования всегда масштабирует экземпляры в этих границах.

### <a name="manual-scaling-is-reset-by-autoscale-min-and-max"></a>Параметры масштабирования вручную будут сброшены заданными для автомасштабирования минимальным и максимальным значениями.
Если вы вручную обновляете количество экземпляров и устанавливаете значение, которое превышает или не превышает максимальное, параметр автомасштабирования автоматически масштабирует значение до минимального (если оно было меньше) или до максимального (если оно было больше). Например, вы задаете диапазон от 3 до 6. При наличии одного запущенного экземпляра при следующем запуске параметр автомасштабирования развернет количество экземпляров до 3 . Аналогичным образом, если вручную задать масштабирование до 8 экземпляров, при следующем запуске будет выполнено обратное автомасштабирование до 6 экземпляров.  Масштабирование вручную — очень временное, если только не сбросить также правила автомасштабирования.

### <a name="always-use-a-scale-out-and-scale-in-rule-combination-that-performs-an-increase-and-decrease"></a>Всегда используйте сочетание правил развертывания и свертывания, которые обеспечивают увеличение и уменьшение количества экземпляров.
Если использовать только одну часть сочетания, то служба автомасштабирования будет свертывать (или развертывать) экземпляры, пока не достигнет максимального (или минимального) количества.

### <a name="choose-the-appropriate-statistic-for-your-diagnostics-metric"></a>Выберите соответствующий статистический показатель для диагностической метрики
Для диагностических метрик можно выбрать одно из следующих опорных значений для масштабирования: *Средний*, *Минимальный*, *Максимальный* и *Общий*. Наиболее распространенные статистический показатель — *Средний*.

### <a name="choose-the-thresholds-carefully-for-all-metric-types"></a>Внимательно выберите пороговые значения для всех типов метрик
Рекомендуется тщательно выбирать различные пороговые значения для развертывания и свертывания в зависимости от практических ситуаций.

Мы *не рекомендуем* приведенные ниже примеры автомасштабирования с одинаковыми или достаточно близкими пороговыми значениями в условиях разворачивания и сворачивания.

* Увеличение числа экземпляров на 1, если число потоков ≤ 600
* Уменьшение числа экземпляров на 1, если число потоков ≥ 600

Рассмотрим пример того, что может привести к противоречивому поведению. Рассмотрим следующую последовательность.

1. Предположим, что сначала было два экземпляра, и затем среднее число потоков на один экземпляр увеличилось до 625.
2. Служба автомасштабирования разворачивает третий экземпляр.
3. Затем предположим, что среднее число потоков на экземпляр уменьшилось до 575.
4. Перед уменьшением масштаба служба автомасштабирования пытается оценить, какое конечное состояние будет после сворачивания. Например, 575 x 3 (текущее количество экземпляров) = 1725 / 2 (итоговое количество экземпляров после уменьшения масштаба) = 862,5 потока. Это означает, что если среднее количество потоков не меняется или даже немного уменьшается, службе автомасштабирования сразу после свертывания придется опять развертывать новый экземпляр. Однако после повторного разворачивания весь опять процесс повторится, что приведет к бесконечному циклу.
5. Чтобы избежать такой нестабильности, параметр автомасштабирования вообще не уменьшает масштаб. Вместо этого она пропускает, а затем повторно оценивает условие при следующем выполнении задания службы. Это многих может сбить с толку, ведь все выглядело так, будто автомасштабирование не работало, когда среднее число потоков было равно 575.

Оценка во время свертывания направлена на то, чтобы избежать нестабильности, при которой действия свертывания и развертывания постоянно колеблются. Следует помнить об этом механизме, выбирая одинаковые пороговые значения для развертывания и свертывания.

Рекомендуется выбирать достаточный интервал между пороговыми значениями для развертывания и свертывания. Например, рассмотрим более удачное сочетание правил.

* Увеличивать количество экземпляров на 1, если загрузка ЦП ≥ 80.
* Уменьшение числа экземпляров на 1, если загрузка ЦП ≤ 60

В данном случае:  

1. Предположим, что с самого начала существуют два экземпляра.
2. Если средняя загрузка ЦП во всех экземплярах достигает 80 %, то служба автомасштабирования добавляет третий экземпляр.
3. Теперь предположим, что со временем загрузка ЦП снижается до 60 %.
4. Правило свертывания службы автомасштабирования оценивает конечное состояние, которое будет после свертывания. Например, 60 x 3 (текущее число экземпляров) = 180 / 2 (итоговое число экземпляров после уменьшения масштаба) = 90. Поэтому служба автомасштабирования не свертывает экземпляр, так как после этого ей пришлось бы тут же развернуть его. Вместо этого она пропускает уменьшение масштаба.
5. При следующей проверке автомасштабирования нагрузка ЦП продолжает снижаться до 50. Служба снова оценивает ее: 50 х 3 экземпляра = 150 / 2 экземпляра = 75. Это значение меньше порогового значения развертывания, равного 80, поэтому служба успешно свертывает масштабирование до 2 экземпляров.

### <a name="considerations-for-scaling-threshold-values-for-special-metrics"></a>Рекомендации по пороговым значениям масштабирования для специальных метрик
 Для специальных метрик, таких как метрика длины очереди хранилища или длины очереди служебной шины, пороговое значение — это среднее число сообщений, доступных для текущего числа экземпляров. Тщательно выбирайте пороговое значение этой метрики.

Проиллюстрируем пример, чтобы вы лучше поняли, как это работает.

* Увеличение числа экземпляров на 1, когда число сообщений в очереди хранилища ≥ 50
* Уменьшение числа экземпляров на 1, когда число сообщений в очереди хранилища ≤ 10

Рассмотрим следующую последовательность:

1. Существует 2 экземпляра очереди хранилища.
2. Сообщения продолжают поступать, и когда вы просматриваете очередь хранилища, их общее количество достигает 50. Вы можете предположить, что служба автомасштабирования должна начать развертывание. Однако обратите внимание, что число сообщений для каждого экземпляра по-прежнему 50 / 2 = 25. Поэтому развертывание не происходит. Чтобы произошло первое развертывание, общее количество сообщений в очереди хранилища должно достичь 100.
3. Далее предположим, что общее количество сообщений достигло 100.
4. После развертывания добавляется третий экземпляр очереди хранилища.  Следующее развертывание не будет выполнено, пока общее количество сообщений в очереди не достигнет 150, так как 150/3 = 50.
5. Теперь количество сообщений в очереди уменьшится. С тремя экземплярами первое свертывание происходит, когда общее количество сообщений во всех очередях достигает 30, так как 30/3 = 10 сообщений на экземпляр. А это и есть пороговое значение свертывания.

### <a name="considerations-for-scaling-when-multiple-profiles-are-configured-in-an-autoscale-setting"></a>Рекомендации по масштабированию при настройке нескольких профилей в параметре автомасштабирования
В параметре автомасштабирования можно выбрать профиль по умолчанию, который применяется всегда, вне зависимости от расписания или времени. Также можно выбрать профиль повторения или профиль для фиксированного периода с диапазоном дат и времени.

При их обработке служба автомасштабирования всегда выполняет проверку в следующем порядке:

1. профиль с фиксированной датой;
2. профиль повторения;
3. профиль по умолчанию ("Всегда").

Если соблюдено какое-либо условие профиля, служба автомасштабирования не проверяет следующее за ним условие профиля. Служба автомасштабирования обрабатывает только один профиль за раз. Это означает, что если требуется добавить условие обработки из профиля нижнего уровня, то необходимо включить соответствующие правила в текущий профиль.

Рассмотрим это на примере.

На следующем рисунке показан параметр автомасштабирования с профилем по умолчанию с минимальным числом экземпляров, равным 2, и максимальным числом экземпляров, равным 10. В этом примере настроены правила для развертывания в случае, когда количество сообщений в очереди превышает 10, и свертывания, когда это количество меньше 3. Итак, теперь ресурс может масштабироваться в пределах 2–10 экземпляров.

Кроме того, имеется профиль повторения, настроенный на "Понедельник". В нем задано минимальное число экземпляров, равное 3, и максимальное число экземпляров, равное 10. Это означает, что в понедельник, когда служба автомасштабирования впервые проверит это условие при количестве экземпляров 2, она масштабирует их до нового минимального значения, т. е. до 3. Пока служба автомасштабирования продолжает считать, что это условие профиля соблюдено (для понедельника), она обрабатывает только настроенные для этого профиля правила развертывания и свертывания на основе использования ресурсов ЦП. На данный момент она не проверяет длину очереди. Тем не менее, если также требуется проверять условие длины очереди, необходимо добавить эти правила из профиля по умолчанию в профиль для понедельника.

Аналогичным образом, когда служба автомасштабирования переключится обратно на профиль по умолчанию, сначала она проверит, соблюдены ли условия минимального и максимального количества экземпляров. Если на тот момент число экземпляров будет равно 12, служба свернет два из них, оставив 10, т. е. максимальное число для профиля по умолчанию.

![Параметры автомасштабирования](./media/insights-autoscale-best-practices/insights-autoscale-best-practices-2.png)

### <a name="considerations-for-scaling-when-multiple-rules-are-configured-in-a-profile"></a>Рекомендации по масштабированию при настройке нескольких правил в профиле
Бывают случаи, когда требуется задать несколько правил в профиле. Ниже приведен набор правил автомасштабирования, используемых при настройке нескольких правил.

Для запуска *развертывания* службе автомасштабирования достаточно, чтобы выполнялось любое из правил.
Для запуска *свертывания* службе автомасштабирования требуется, чтобы выполнялись все правила.

Чтобы проиллюстрировать это, предположим, что заданы следующие 4 правила автомасштабирования:

* если загрузка ЦП < 30 %, свернуть 1 экземпляр;
* если объем используемой памяти < 50 %, свернуть 1 экземпляр;
* если загрузка ЦП > 75 %, развернуть 1 экземпляр;
* если объем используемой памяти > 75 %, развернуть 1 экземпляр.

Затем происходит следующее.

* Если ресурсы ЦП загружены на 76 % и занято 50 % памяти, будет выполнено развертывание.
* Если ресурсы ЦП загружены на 50 % и занято 76 % памяти, будет выполнено развертывание.

С другой стороны, если нагрузка ЦП составляет 25 %, а память занята на 51 %, автомасштабирование **не** выполняет развертывание. Для этого ресурсы ЦП должны быть загружены на 29 %, а память занята на 49 %.

### <a name="always-select-a-safe-default-instance-count"></a>Всегда выбирайте безопасное число экземпляров по умолчанию
Количество экземпляров по умолчанию важно, так как оно устанавливается службой автомасштабирования, когда метрики недоступны. Поэтому выберите число экземпляров по умолчанию, являющееся безопасным для рабочих нагрузок.

### <a name="configure-autoscale-notifications"></a>Настройка уведомлений об автомасштабировании
Сведения об автомасштабировании отправляются в журнал действий при возникновении любого из следующих условий:

* при автомасштабировании вызывается операция масштабирования;
* служба автомасштабирования успешно завершает действие масштабирования;
* службе автомасштабирования не удается выполнить действие масштабирования.
* Службе автомасштабирования не доступны метрики для принятия решения по масштабированию.
* Метрики для принятия решения по масштабированию стали доступны (восстановились).

С помощью оповещений журнала действий также можно отслеживать работоспособность системы автоматического масштабирования. Ниже приведены примеры [создания оповещения журнала действий для отслеживания всех операций системы автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert) или [создания оповещения журнала действий для отслеживания всех неудачных операций свертывания и развертывания автомасштабирования в подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).

Помимо оповещений журнала действий, можно настроить уведомления по электронной почте или через веб-перехватчики, чтобы узнавать об успешных действиях масштабирования посредством вкладки уведомлений в настройках автомасштабирования.

## <a name="next-steps"></a>Дальнейшие действия
- [Создайте оповещение журнала действий, чтобы отслеживать все операции системы автомасштабирования в своей подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert).
- [Создайте оповещение журнала действий, чтобы отслеживать все ошибки автомасштабирования в своей подписке](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).
