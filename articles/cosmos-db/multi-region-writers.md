---
title: База дынных Azure Cosmos DB с несколькими источниками | Документация Майкрософт
description: ''
services: cosmos-db
author: rimman
manager: kfile
ms.service: cosmos-db
ms.workload: data-services
ms.topic: article
ms.date: 05/07/2018
ms.author: rimman
ms.openlocfilehash: 12306b7868fa7fb2321f26657aab81beabb9db35
ms.sourcegitcommit: d98d99567d0383bb8d7cbe2d767ec15ebf2daeb2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
---
# <a name="multi-master-at-global-scale-with-azure-cosmos-db"></a>База дынных Azure Cosmos DB с несколькими источниками 
 
Разработка глобально распределенных приложений, работающих с задержками на уровне локальных приложений, при сохранении целостности глобально хранимых данных является сложной задачей. Клиенты используют глобально распределенные баз данных, поскольку им нужно уменьшить задержки доступа к данным, обеспечивая высокую доступность данных и гарантию аварийного восстановления (4) при удовлетворении производственных нужд своего бизнеса. БД Azure Cosmos DB с несколькими источниками обеспечивает высокий уровень доступности (99,999 %), миллисекундные задержки при записи данных и масштабирование на основе встроенной интуитивно-понятной и гибкой поддержки при разрешении конфликтов. Эти возможности значительно упрощают разработку глобально распределенных приложений. Для глобально распределенных приложений крайне важна поддержка нескольких источников. 

![Архитектура с несколькими источниками](./media/multi-region-writers/multi-master-architecture.png)

При наличии поддержки нескольких источников в Azure Cosmos DB можно выполнять операции записи в контейнерах данных (например, коллекциях, диаграммах, таблицах), размещенных в любом месте на Земле. Данные можно обновлять в любом регионе, связанном с вашей учетной записью базы данных. Такие обновления данных можно распространять асинхронно. Помимо быстрого доступа и малой задержки при записи данных, наличие нескольких источников предоставляет собой практичное решение для отработки отказов и балансировки нагрузки. Таким образом, с помощью Azure Cosmos DB можно получить задержку записи <10 мс для 99-го процентиля и 99,999 % доступности записи и чтения в любой точке мира, а также возможность увеличения производительности операций записи и чтения где угодно.   

> [!IMPORTANT]
> Поддержка нескольких источников предоставляется в режиме закрытой предварительной версии. [Зарегистрируйтесь](#sign-up-for-multi-master-support) сейчас, чтобы использовать предварительную версию.

## <a name="sign-up-for-multi-master-support"></a>Регистрация для получения поддержки нескольких источников

Если у вас уже есть подписка Azure, вы можете зарегистрироваться, чтобы принять участие в программе по ознакомлению с предварительной версией поддержки нескольких источников на портале Azure. Если вы не еще не работали с Azure, зарегистрируйтесь для получения [бесплатной пробной версии](https://azure.microsoft.com/free). В течение 12 месяцев у вас будет бесплатный доступ к Azure Cosmos DB. Чтобы отправить запрос на участие в программе по ознакомлению с предварительной версией поддержки нескольких источников, сделайте следующее.

1. На [портале Azure](https://portal.azure.com) выберите **Создать ресурс** > **Базы данных** > **Azure Cosmos DB**.  

2. На странице "Новая учетная запись" укажите имя учетной записи Azure Cosmos DB, выберите API, подписку, группу ресурсов и расположение.  

3. Затем выберите **Зарегистрируйтесь для получения предварительной версии уже сегодня** в поле Multi Master Preview (Предварительная версия поддержки нескольких источников).  

   ![Регистрация для получения предварительной версии поддержки нескольких источников](./media/multi-region-writers/sign-up-for-multi-master-preview.png)

4. В области **Зарегистрируйтесь для получения предварительной версии уже сегодня** нажмите кнопку **ОК**. Когда запрос будет отправлен, в колонке создания учетной записи состояние изменится на **Ожидает утверждения**.  

После отправки запроса вы получите уведомление по электронной почте о его утверждении. Из-за большого числа запросов вы получите уведомление в течение недели. Не нужно создавать обращение в службу поддержки, чтобы завершить запрос. Запросы будут проверяться в том порядке, в котором они были получены.

## <a name="a-simple-multi-master-example--content-publishing"></a>Простой пример с несколькими источниками — публикация содержимого  

Взглянем на реальный сценарий, описывающий способы использования нескольких источников в Azure Cosmos DB. Рассмотрим платформу публикации содержимого, созданную на базе Azure Cosmos DB. Ниже приведены некоторые требования, которым эта платформа должна соответствовать, чтобы обеспечить удобство работы пользователя как с издателями, так и с потребителями. 

* Оба автора и подписчики рассредоточены по всему миру.  

* Авторам нужно публиковать (писать) статьи в своем (ближайшем) регионе.  

* У авторов статей есть читатели и подписчики, разбросанные по всему миру.  

* Подписчики должны получать уведомление при публикации новой статьи.  

* Подписчики должны иметь возможность читать статьи в своем локальном регионе. Они также должны иметь возможность добавлять рецензентов этих статей.  

* Кто угодно, включая автора статей, должен иметь возможность просматривать все рецензии, прилагаемые к статьям из локального региона.  

Предполагая участие миллионов потребителей и издателей и наличие миллиардов статей, очень скоро мы столкнемся с проблемами масштабирования и гарантирования локальности доступа. Такой вариант применения является идеальным кандидатом для схемы с несколькими источниками в Azure Cosmos DB. 

## <a name="benefits-of-having-multi-master-support"></a>Преимущества поддержки нескольких источников 

Поддержка нескольких источников крайне важна для глобально распределенных приложений. Несколько источников расположены в [нескольких ведущих регионах](distribute-data-globally.md), принимающих равноправное участие в модели записи в произвольном регионе (схема "активный-активный") для обеспечения доступности данных в любое время и там, где это необходимо. Обновления, проводимые в отдельных регионах, асинхронно распространяются на остальные регионы (которые, в свою очередь, также являются ведущими). Регионы Azure Cosmos DB, назначенные ведущими в схеме с несколькими источниками, автоматически сводят данные всех реплик к единому состоянию и гарантируют [глобальную согласованность и целостность данных](consistency-levels.md). На следующем рисунке показана репликация при чтении и записи для схем с одним или несколькими источниками.

![Схемы с одним или несколькими источниками](./media/multi-region-writers/single-vs-multi-master.png)

Самостоятельная реализация с несколькими источниками создает дополнительную нагрузку на разработчиков. Крупные заказчики, пытающиеся реализовать схему с несколькими источниками самостоятельно, могут потратить сотни часов на настройку и тестирование глобальной конфигурации с несколькими источниками. У многих из них есть отдельные технические подразделения, единственной задачей которых является мониторинг и обслуживание схем репликации с несколькими источниками. Создание конфигурации с несколькими источниками и управление ею собственными силами требует времени и ресурсов от разработки новых приложений и приводит к росту издержек. Azure Cosmos DB изначально поддерживает работу с несколькими источниками и избавляет разработчиков от подобных нагрузок.  

Таким образом, поддержка нескольких источников обеспечивает следующие преимущества.

* **Усовершенствованный процесс аварийного восстановления, высокую доступность записи и отработку отказа** — схема с несколькими источниками может использоваться для поддержания высокого уровня доступности особо важных баз данных в большей степени, чем это было возможно до сих пор. Например, база данных с несколькими источниками может реплицировать данные из производственного региона в регион отработки отказа, в то время как основной регион продолжает оставаться отключенным из-за сбоев или региональных бедствий. Регион отработки отказа будет работать как полнофункциональный источник для поддержки работоспособности приложения. Схема с несколькими источниками повышает "устойчивость" защиты к стихийным бедствиям и/или саботажу, поскольку оставшиеся регионы включены в географически разнесенную сеть источников с гарантированной доступностью >99,999 %. 

* **Уменьшенные задержки записи для конечных пользователей** — чем ближе ваши данные (которые вы обслуживаете) к конечным пользователям, тем лучше для всех. Так, например, если ваши пользователи в Европе, а база данных находится в США или Австралии, дополнительная задержка составляет приблизительно 140 мс и 300 мс для соответствующих регионов. Задержки неприемлемы во многих популярных играх, банковских операциях или интерактивных приложениях (в мобильных и веб-приложениях). Задержка играет важную роль в восприятии клиентами качества обслуживания и однозначно влияет на их поведение. Поскольку технология улучшается (особенно с появлением ДР, ВР и СР, требующих еще больше возможностей для обеспечения эффекта присутствия или просто для более реалистичного воспроизведения), разработчикам нужно создавать системы ПО с еще более жесткими требованиями к задержкам. Таким образом, наличие локально доступных приложений и данных (содержимого приложений) является более важным. Благодаря поддержке нескольких источников в Azure Cosmos DB производительность этой БД определяется локальными скоростями операций чтения и записи и повышается при наличии географического рассредоточения.  

* **Улучшенная производительность и масштабируемость операций записи** — несколько источников обеспечивают более высокую пропускную способность и более высокую загрузку, предлагая несколько моделей обеспечения целостности при сохранении точности данных и соблюдении условий соглашения об уровне обслуживания. 

  ![Масштабирование производительности записи в схеме с несколькими источниками](./media/multi-region-writers/scale-write-throughput.png)

* **Улучшенная поддержка отключенных сред (например, пограничных устройств)** — схема с несколькими источниками позволяет пользователям реплицировать все данные пограничных устройств из ближайшего региона в отключенной среде или только их часть. Данный сценарий типичен для систем автоматизации продаж, в которых отдельный ноутбук (отключенное устройство) хранит часть данных, относящихся к конкретному продавцу. Регионы-источники в облаке, расположенные где угодно, могут служить конечной точкой для копирования с удаленных пограничных устройств.  

* **Балансировка нагрузки** — при наличии нескольких источников нагрузку на приложение можно повторно отбалансировать, перемещая пользователей и рабочие нагрузки из более загруженных в менее загруженные регионы. Производительность операций записи можно легко увеличить путем добавления нового региона и последующего переключения части объема операций записи на новый регион. 

* **Повышение эффективности использования выделенных емкостей** — при наличии нескольких источников в условиях тяжелых нагрузок по операциям записи и рабочих нагрузок смешанного типа, можно полностью распределить выделенную емкость по нескольким регионам.  В некоторых случаях можно распространять операции чтения и записи более равномерно, чтобы для них требовалась меньшая полоса пропускания, что, в свою очередь, влечет за собой сокращение клиентских издержек.  

* **Более простая и надежная архитектура приложений** — приложения, мигрирующие на схему с несколькими источниками, получат гарантированную надежность данных.  Скрывая всю сложность, Azure Cosmos DB может существенно упростить проектирование приложения и его архитектуру. 

* **Тестирование безрисковых отработок отказа** — тестирование отработки отказов, не приводящих к снижению пропускной способности при записи. При наличии нескольких источников все регионы являются полноценными источниками и поэтому отказ не оказывает заметного влияния на пропускную способность при записи.  

* **Снижение совокупной стоимости владения и DevOps** — обеспечение соответствия требованиям по масштабированию, производительности, глобальному рассредоточению и заданным показателям сроков восстановления часто сопряжено с необходимостью привлечения дорогостоящих вспомогательных программ или с обслуживанием инфраструктуры резервного копирования, которые не работают, пока не понадобятся из-за аварии. Azure Cosmos DB с поддержкой нескольких источников и соглашение об уровне обслуживания у ведущих поставщиков избавляют от необходимости тратить усилия разработчиков на разработку серверных интеграционных решений и дают им больше времени для работы над особо важными производственными задачами. 

## <a name="use-cases-where-multi-master-support-is-needed"></a>Варианты применения, где необходима схема с несколькими источниками

Существует множество вариантов использования Azure Cosmos DB с несколькими источниками: 

* **IoT** — несколько источников в Azure Cosmos DB позволяют упростить реализацию распределенной обработки данных IoT. Географически распределенные развертывания пограничных устройств с использованием CRDT — бесконфликтных типов реплицированных данных, для которых часто необходимо отслеживать данные временных рядов для нескольких местоположений. Каждое из устройств может располагаться в одном из ближайших регионов. Кроме того, устройство (например, автомобиль) может динамически перемещаться для выполнения операции записи в другом регионе.  

* **Электронная коммерция** — обеспечение удобства использования в сценариях электронной коммерции требует высокого уровня доступности и устойчивости к сбоям. В случае сбоя в регионе, пользовательские сеансы, корзины покупок и открытые списки желаемого должны быть незаметно подхвачены другим регионом без потери данных о текущем состоянии. В промежутках между сеансами необходимо соответствующим образом обработать обновления, выполненные пользователем (например, добавить или удалить элементы из корзины покупок). Azure Cosmos DB с несколькими источниками может правильно обрабатывать такие сценарии с плавным переходом между активными регионами и сохранением целостного представления с точки зрения пользователя. 

* **Обнаружение мошенничества или неполадок** — часто приложения, наблюдающие за действиями пользователя или учетной записи, распределены глобально и должны отслеживать несколько событий одновременно. При составлении или обновлении рейтинга пользователя в результате одновременных действий из разных географических регионов должны одновременно обновляться и оценки для поддержки актуальности текущих метрик рисков. Azure Cosmos DB может избавить разработчиков от необходимости обрабатывать сценарии конфликтов на уровне приложения. 

* **Совместная работа** — для приложений, которые формируют рейтинги на основании популярности статей о продаваемых товарах или предложениях медиа-рынка и т. д. Отслеживание популярности в разных географических регионах может быть затруднено, особенно в том случае, когда необходимо выплачивать роялти или принимать решения по рекламе в реальном времени. Ранжирование, сортировка и составление отчетов по многим регионам мира в реальном времени с помощью Azure Cosmos DB позволяет разработчикам поставлять решения с малыми затратами и без потерь из-за задержек. 

* **Измерение** — использование учета и регулирования (например, вызовов API, транзакций в секунду, использованных минут) можно легко и просто реализовать в глобальном масштабе за счет поддержки нескольких источников в Azure Cosmos DB. Встроенный механизм разрешения конфликтов обеспечивает как точность учета, так и регулирование в режиме реального времени. 

* **Персонализация** — в зависимости от того, обслуживаете ли вы географически разнесенные счетчики, активирующие такие действия, как выплата премий или реализация персонализированных пользовательских сеансов, высокая доступность и упрощенный географически распределенный учет, предоставляемые Azure Cosmos DB, позволяют приложениям легко обеспечивать высокую производительность. 

## <a name="conflict-resolution-with-multi-master"></a>Разрешение конфликтов нескольких источников 

При наличии нескольких источников проблема чаще всего заключается в том, что две (или несколько) реплик одной и той же записи могут обновляться разными процессами записи одновременно в двух или нескольких регионах. Процесс одновременной записи может привести к появлению двух различных версий одной записи, и без наличия встроенного механизма разрешения конфликтов приложению самому необходимо разрешить конфликт для устранения этого несоответствия.  

**Пример**. Допустим, вы используете Azure Cosmos DB в качестве постоянного хранилища данных для приложения корзины покупок, развернутого в двух регионах: на Востоке и Западе США.  Если примерно в одно и тоже время пользователь в Сан-Франциско добавляет товар в свою корзину (например, книгу), во время процесса инвентаризации в регионе Восток США аннулируется другая позиция в корзине (например, новый телефон) для этого же пользователя в ответ на уведомление поставщика о задержке выпуска. В момент времени T1 записи для корзины покупок в двух регионах отличаются. В процессе репликации и использования механизма разрешения конфликтов база данных устранит это несоответствие и в конечном итоге выберет одну из двух версий корзины покупок. С помощью эвристических правил разрешения конфликтов, наиболее часто применяемых в базах данных с несколькими источниками (например, действительными признаются последние записи), для пользователя или приложения невозможно спрогнозировать то, какая версия будет выбрана. В любом случае происходит либо потеря данных, либо наблюдается непредсказуемое поведение. Если выбрана версия для Востока, выбранный пользователем новый товар для покупки (т.е. книги) оказывается утерянным, а если выбрана версия для Запада, ранее выбранный товар (т.е. телефон) все еще находится в корзине. В любом случае теряется информация. Наконец, любой другой процесс проверки содержимого корзины в промежутке времени между T1 и T2 также столкнется с ситуацией непредвиденного поведения. Например, фоновый процесс, проверяющий наполнение склада и обновляющий стоимость доставки товаров из корзины, приведет к конфликту полученного результата с финальным содержимым корзины. Если процесс выполняется в западном регионе и реализуется альтернатива 1, будет вычисляться стоимость доставки двух товаров, несмотря на то, что для покупок вскоре останется только один элемент, книга. 

Azure Cosmos DB реализует логику разрешения конфликтов, записанную внутри ядра самой БД. Azure Cosmos DB предоставляет **всестороннюю и гибкую поддержку алгоритмов разрешения конфликтов**, предлагая для автоматического разрешения конфликтов несколько моделей, в том числе автоматическую (CRDT — бесконфликтные реплицируемые типы данных), с приоритетом последней записи (LWW) и пользовательскую (Хранимая процедура). Модели разрешения конфликтов обеспечивают точность данных и гарантируют их целостность, а также снимают нагрузку с разработчиков, чтобы им не приходилось заботиться о целостности, доступности, производительности, задержках репликации и сложных наложениях событий при возникновении географически распределенных отказов и межрегиональных конфликтах при записи.  

  ![Разрешение конфликтов нескольких источников](./media/multi-region-writers/multi-master-conflict-resolution-blade.png)

У вас будет три типа моделей разрешения конфликтов в Azure Cosmos DB. Модели разрешения конфликтов обладают следующей семантикой. 

**Автоматически** — это политика разрешения конфликтов по умолчанию. Выбор этой политики приводит Azure Cosmos DB к автоматическому разрешению конфликтов обновления на стороне сервера и гарантирует конечную целостность. На внутреннем уровне Azure Cosmos DB реализует механизм автоматического разрешения конфликтов путем использования бесконфликтных типов реплицируемых-данных (CRDT) внутри ядра СУБД.  

**Приоритет последней записи (LWW)** — выбор этой политики позволит решать конфликты либо на основе системной синхронизированной метки времени, либо на основе свойства конфликтной версии записи. Разрешение конфликтов происходит на стороне сервера, и версия с самой последней меткой времени оказывается победителем.  

**Пользовательский** — можно записать логику разрешения конфликтов в приложении путем регистрации соответствующей хранимой процедуры. Хранимая процедура будет вызывается при обнаружении конфликтов обновления во время обработки транзакции в базе данных на стороне сервера. Если выбрать это значение, но не зарегистрировать хранимую процедуру (или если хранимая процедура вызывает исключение во время выполнения), можно получать доступ ко всем конфликтующим версиям через Conflicts Feed (очередь конфликтов) и устранять их по отдельности.  

## <a name="next-steps"></a>Дополнительная информация  

В статье описывается использование глобально распределенной Azure Cosmos DB с несколькими источниками. Далее рекомендуем ознакомиться со следующими ресурсами: 

* [Дополнительные сведения о поддержке глобального распределения в Azure Cosmos DB](distribute-data-globally.md)  

* [Подробнее об автоматическом переходе на другой ресурс в Azure Cosmos DB](regional-failover.md)  

* [Глобальная согласованность в Azure Cosmos DB](consistency-levels.md)  

* Разработка с использованием поддержки нескольких источников в Azure Cosmos DB — [API для SQL](tutorial-global-distribution-sql-api.md), [API для MongoDB ](tutorial-global-distribution-mongodb.md) или [API таблиц](tutorial-global-distribution-table.md)  