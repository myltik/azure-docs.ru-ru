---
title: Завершение срока действия данных в Azure Cosmos DB с использованием срока жизни | Документация Майкрософт
description: Функция TTL в Microsoft Azure Cosmos DB позволяет автоматически удалять документы из системы по прошествии определенного периода времени.
services: cosmos-db
documentationcenter: ''
keywords: Срок жизни
author: SnehaGunda
manager: kfile
ms.assetid: 25fcbbda-71f7-414a-bf57-d8671358ca3f
ms.service: cosmos-db
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/29/2017
ms.author: sngun
ms.openlocfilehash: 13f2caa631817a5745f39b44faccb11252a2d549
ms.sourcegitcommit: d98d99567d0383bb8d7cbe2d767ec15ebf2daeb2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/10/2018
---
# <a name="expire-data-in-azure-cosmos-db-collections-automatically-with-time-to-live"></a>Автоматическое завершение срока действия данных в коллекциях Azure Cosmos DB с использованием срока жизни
Приложения могут создавать и хранить большие объемы данных. Некоторые из этих данных, например созданные компьютером данные о событиях, журналы и пользовательские сеансы, имеют ценность только в течение ограниченного периода времени. Когда данных становится больше, чем нужно приложению, их можно безопасно удалять, чтобы снизить потребности приложения в ресурсах хранения.

Свойство TTL (время жизни) в Microsoft Azure Cosmos DB позволяет автоматически удалять документы из базы данных по прошествии определенного периода времени. Время жизни можно указать на уровне коллекции, и тогда оно будет использоваться по умолчанию, либо отдельно переопределить для каждого документа. Когда свойство TTL определено (будь то время жизни по умолчанию на уровне коллекции или для конкретного документа), Cosmos DB автоматически удаляет документы, время жизни которых с момента их последнего изменения превышает заданное значение.

Срок жизни в Cosmos DB отсчитывается в секундах от последнего изменения документа. Для этого используется поле `_ts`, которое существует в каждом документе. В поле _ts отмечается дата и время в формате UNIX-времени. Поле `_ts` обновляется при каждом изменении документа. 

## <a name="ttl-behavior"></a>Поведение TTL
Функция TTL управляется свойствами TTL на двух уровнях — коллекции и документа. Значения задаются в секундах и отсчитываются от значения `_ts`, то есть от момента последнего изменения документа.

1. DefaultTTL (TTL по умолчанию) на уровне коллекции:
   
   * Если свойство отсутствует (или имеет значение NULL), документы не удаляются автоматически.
   * Если свойство присутствует и имеет значение –1, документы по умолчанию имеют неограниченный срок жизни.
   * Если свойство присутствует и его значением является некоторое число (n), документы удаляются по истечении n секунд после последнего изменения.
2. TTL на уровне документов: 
   
   * Свойство применяется только в том случае, если для родительской коллекции установлено значение DefaultTTL.
   * Переопределяет значение DefaultTTL, установленное для родительской коллекции.

Когда срок жизни документа истекает (`ttl` + `_ts` <= текущее время сервера), документ отмечается как устаревший. После этого не допускаются никакие действия с этим документом, и он исключается из результатов любых запросов. Позднее документ физически удаляется из системы в фоновом режиме. Это действие не использует [единицы запроса](request-units.md) из бюджета коллекции.

Описанную выше логику можно представить в виде следующей таблицы.

|  | Свойство DefaultTTL на уровне коллекции отсутствует или не определено | Свойство DefaultTTL на уровне коллекции имеет значение -1 | Свойство DefaultTTL на уровне коллекции имеет значение n |
| --- |:--- |:--- |:--- |
| Свойство TTL на уровне документа отсутствует |Переопределение на уровне документа не происходит, так как свойство TTL не применяется ни для коллекции, ни для документа. |Документы в этой коллекции не устаревают. |Документы в этой коллекции устаревают по истечении n секунд. |
| Свойство TTL на уровне документа имеет значение -1 |Переопределение на уровне документа не происходит, так как для коллекции не определено свойство DefaultTTL. Система не учитывает свойство TTL, определенное для документа. |Документы в этой коллекции не устаревают. |Документ с TTL=-1 в этой коллекции никогда не устаревает. Все прочие документы устаревают по истечении n секунд. |
| Свойство TTL на уровне документа имеет значение n |Переопределение на уровне документа не происходит. Система не учитывает свойство TTL, определенное для документа. |Документ с TTL=n устаревает через n секунд. Другие документы наследуют значение интервала -1 и никогда не устаревают. |Документ с TTL=n устаревает через n секунд. Другие документы наследуют интервал n из коллекции. |

## <a name="configuring-ttl"></a>Настройка TTL
По умолчанию срок жизни отключен для всех коллекций Cosmos DB и для всех документов. Срок жизни можно задать программно или на портале Azure в разделе **Параметры** для конкретной коллекции. 

## <a name="enabling-ttl"></a>Активация TTL
Чтобы включить TTL на уровне коллекции или документов, необходимо определить для коллекции свойство DefaultTTL и задать в качестве его значения ненулевое положительное число или -1. Значение DefaultTTL, равное –1, означает, что по умолчанию все документы будут сохраняться в коллекции в течение неограниченного времени, но служба Cosmos DB будет отслеживать наличие в этой коллекции документов, для которых значение по умолчанию переопределено.

    DocumentCollection collectionDefinition = new DocumentCollection();
    collectionDefinition.Id = "orders";
    collectionDefinition.PartitionKey.Paths.Add("/customerId");
    collectionDefinition.DefaultTimeToLive =-1; //never expire by default

    DocumentCollection ttlEnabledCollection = await client.CreateDocumentCollectionAsync(
        UriFactory.CreateDatabaseUri(databaseName),
        collectionDefinition,
        new RequestOptions { OfferThroughput = 20000 });

## <a name="configuring-default-ttl-on-a-collection"></a>Настройка TTL по умолчанию на уровне коллекции
Вы можете настроить срок жизни по умолчанию для коллекции. Для этого необходимо ввести ненулевое положительное число, которое будет означать время в секундах, по истечении которого с момента последнего изменения документа (отметка времени `_ts`) любой документ в этой коллекции будет считаться устаревшим. Также можно задать значение по умолчанию -1, что будет означать неограниченное время жизни по умолчанию для всех документов в этой коллекции.

    DocumentCollection collectionDefinition = new DocumentCollection();
    collectionDefinition.Id = "orders";
    collectionDefinition.PartitionKey.Paths.Add("/customerId");
    collectionDefinition.DefaultTimeToLive = 90 * 60 * 60 * 24; // expire all documents after 90 days
    
    DocumentCollection ttlEnabledCollection = await client.CreateDocumentCollectionAsync(
        "/dbs/salesdb",
        collectionDefinition,
        new RequestOptions { OfferThroughput = 20000 });


## <a name="setting-ttl-on-a-document"></a>Настройка TTL на уровне документа
Помимо значения TTL по умолчанию для коллекции, вы можете задать значение TTL на уровне документа. Это значение переопределит значение по умолчанию, установленное для коллекции.

* Чтобы задать TTL для коллекции, необходимо ввести ненулевое положительное число, которое будет означать время в секундах, по истечении которого с момента последнего изменения документа (отметка времени `_ts`) этот документ будет считаться устаревшим.
* Если в документе нет поля TTL, для коллекции будет применяться значение по умолчанию.
* Если свойство TTL отключено на уровне коллекции, поле TTL в документе будет игнорироваться, пока свойство TTL не будет включено для этой коллекции.

Во фрагменте кода ниже показано, как задать срок жизни в документе.

    // Include a property that serializes to "ttl" in JSON
    public class SalesOrder
    {
        [JsonProperty(PropertyName = "id")]
        public string Id { get; set; }
        
        [JsonProperty(PropertyName="cid")]
        public string CustomerId { get; set; }
        
        // used to set expiration policy
        [JsonProperty(PropertyName = "ttl", NullValueHandling = NullValueHandling.Ignore)]
        public int? TimeToLive { get; set; }
        
        //...
    }
    
    // Set the value to the expiration in seconds
    SalesOrder salesOrder = new SalesOrder
    {
        Id = "SO05",
        CustomerId = "CO18009186470",
        TimeToLive = 60 * 60 * 24 * 30;  // Expire sales orders in 30 days 
    };


## <a name="extending-ttl-on-an-existing-document"></a>Продление TTL для существующего документа
Отсчет периода TTL для документа можно сбросить, выполнив для него любую операцию записи. При этом в поле `_ts` будет записано текущее время, и отсчет устаревания документа, определенный свойством `ttl`, начнется заново. Если вы хотите изменить срок жизни (`ttl`) на уровне документа, вы можете обновить поле TTL, как и любое другое редактируемое поле.

    response = await client.ReadDocumentAsync(
        "/dbs/salesdb/colls/orders/docs/SO05"), 
        new RequestOptions { PartitionKey = new PartitionKey("CO18009186470") });
    
    Document readDocument = response.Resource;
    readDocument.TimeToLive = 60 * 30 * 30; // update time to live
    
    response = await client.ReplaceDocumentAsync(readDocument);

## <a name="removing-ttl-from-a-document"></a>Удаление TTL из документа
Если для документа определено свойство TTL, но необходимость в устаревании документа отпала, вы можете извлечь этот документ, удалить поле TTL и сохранить документ на сервере. Когда поле TTL удаляется из документа, для него применяется значение по умолчанию, установленное для коллекции. Чтобы документ не устаревал и к нему не применялось значение TTL для коллекции, следует установить значение TTL, равное -1.

    response = await client.ReadDocumentAsync(
        "/dbs/salesdb/colls/orders/docs/SO05"), 
        new RequestOptions { PartitionKey = new PartitionKey("CO18009186470") });
    
    Document readDocument = response.Resource;
    readDocument.TimeToLive = null; // inherit the default TTL of the collection
    
    response = await client.ReplaceDocumentAsync(readDocument);

## <a name="disabling-ttl"></a>Отключение TTL
Чтобы полностью отключить функцию TTL для коллекции и остановить фоновый поиск устаревших документов, следует удалить свойство DefaultTTL из коллекции. Удаление этого свойства и выбор значения -1 имеют разный эффект. Выбор значения -1 означает, что новые документы, добавляемые в коллекцию, будут сохраняться в течение неограниченного времени, но это поведение можно переопределить для конкретных документов в коллекции. Удаление свойства из коллекции означает, что документы не будут устаревать, даже если для них значение по умолчанию было ранее переопределено.

    DocumentCollection collection = await client.ReadDocumentCollectionAsync("/dbs/salesdb/colls/orders");
    
    // Disable TTL
    collection.DefaultTimeToLive = null;
    
    await client.ReplaceDocumentCollectionAsync(collection);

<a id="ttl-and-index-interaction"></a> 
## <a name="ttl-and-index-interaction"></a>Взаимодействие срока жизни и индекса
Если добавить или изменить параметр срока жизни в коллекции, изменяется базовый индекс. Если значение срока жизни изменено с "Выкл." на "Вкл.", для коллекции выполняется повторное индексирование. При внесении изменений в политику индексирования в согласованном режиме индексирования пользователи не заметят изменения индекса. Если установлен режим отложенного индексирования, индекс всегда перехватывается и при изменении срока жизни создается заново. Если изменяется значение срока жизни и установлен режим отложенного индексирования, запросы, выполненные во время перестроения индекса, не дают полных или правильных результатов.

Чтобы извлечь возвращенные данные, не изменяйте значение срока жизни, если установлен режим отложенного индексирования. В идеале, чтобы получить согласованные результаты запроса, нужно выбирать режим согласованного индексирования. 

## <a name="faq"></a>Часто задаваемые вопросы
**Сколько стоит использование функции TTL?**

Использование TTL на уровне документа не влечет никаких дополнительных затрат.

**Сколько времени займет удаление документа после истечения срока жизни?**

Срок действия документов истекает сразу после истечения срока жизни (TTL); они будут недоступны для операций CRUD или интерфейсов API запросов. 

**Предусматривает ли использование функции TTL на уровне документа оплату за использование единиц запросов?**

Нет, удаление просроченных документов с помощью функции TTL в Cosmos DB не предусматривает оплату за использование единиц запросов.

**Функция TTL применяется только к всему документу, или я могу установить срок жизни для отдельных свойств документа?**

TTL применяется ко всему документу. Если вы хотите, чтобы устаревала только часть документа, мы рекомендуем извлекать эту часть из основного документа в отдельный связанный документ, для которого и применять TTL.

**Есть ли особые требования к индексированию при использовании функции TTL?**

Да. Для коллекции должна быть [задана политика индексирования](indexing-policies.md) — Consistent (Согласованная) или Lazy (Асинхронная). Попытка определить DefaultTTL на уровне коллекции с политикой индексирования None приведет к ошибке. Также ошибкой завершится попытка отключить индексирование коллекции, для которой уже задано свойство DefaultTTL.

## <a name="next-steps"></a>Дополнительная информация
Дополнительные сведения об Azure Cosmos DB см. на странице [*документации*](https://azure.microsoft.com/documentation/services/cosmos-db/) по этой службе.

