---
title: Бессерверные вычисления для баз данных. Служба "Функции Azure" и Azure Cosmos DB | Документация Майкрософт
description: Узнайте, как можно использовать Azure Cosmos DB и служб "Функции Azure" для создания бессерверных вычислительных приложений, управляемых событиями.
services: cosmos-db
author: SnehaGunda
manager: kfile
ms.service: cosmos-db
ms.devlang: na
ms.topic: conceptual
ms.date: 03/26/2018
ms.author: sngun
ms.openlocfilehash: 26d5fe3cf96f7a63b725f1b46d85e453a8aa6ada
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34613971"
---
# <a name="azure-cosmos-db-serverless-database-computing-using-azure-functions"></a>Azure Cosmos DB: обработка данных бессерверных баз данных с помощью службы "Функции Azure"

Бессерверные вычисления дают возможность сосредоточиться на отдельных повторяемых элементах логики без отслеживания состояния. Эти элементы не требуют управления инфраструктурой и потребляют ресурсы в течение считанных секунд или миллисекунд, пока выполняются. В основе бессерверных вычислений лежат функции, которые предоставляются в экосистеме Azure посредством службы [Функции Azure](https://azure.microsoft.com/services/functions).

Благодаря естественной интеграции [Azure Cosmos DB](https://azure.microsoft.com/services/cosmos-db) и службы "Функции Azure", можно создавать триггеры базы данных, входные привязки и выходные привязки непосредственно с помощью учетной записи Azure Cosmos DB. С помощью службы "Функции Azure" и Azure Cosmos DB можно создавать и развертывать бессерверные приложения, управляемые событиями, которые обеспечивают низкую задержку при обращении к сложным данным глобальной базы пользователей.

## <a name="overview"></a>Обзор

Служба "Функции Azure" и Azure Cosmos DB позволяют интегрировать базы данных и бессерверные приложения следующим образом.

* Можно создать **триггер Azure Cosmos DB**, управляемый событиями, в службе "Функции Azure". Этот триггер использует потоки [канала изменений](change-feed.md) для мониторинга изменений в контейнере Azure Cosmos DB. При внесении изменений в контейнер поток канала изменений отправляется в триггер, который вызывает функцию Azure.
* Кроме того, можно привязать функцию Azure к коллекции Azure Cosmos DB с помощью **входной привязки**. Входные привязки считывают данные из контейнера при выполнении функции.
* Можно привязать функцию к коллекции Azure Cosmos DB с помощью **выходной привязки**. Выходные привязки записывают данные в контейнер после завершения выполнения функции.

> [!NOTE]
> Сейчас триггер, входные и выходные привязки Azure Cosmos DB работают только с учетными записями API SQL и API Graph.

На следующей схеме показаны все три способа интеграции. 

![Как интегрируются служба "Функции Azure" и Azure Cosmos DB](./media/serverless-computing-database/cosmos-db-azure-functions-integration.png)

Триггер, входную и выходную привязки Azure Cosmos DB можно использовать в следующих сочетаниях.
* Триггер Azure Cosmos DB можно использовать с выходной привязкой к другому контейнеру Azure Cosmos DB. После того, как функция выполнит действие с элементом в канале изменений, его можно будет записать в другой контейнер (если записать его в тот же контейнер, из которого он поступил, то это может привести к созданию рекурсивного цикла). Кроме того, с помощью триггера Azure Cosmos DB можно эффективно перенести все измененные элементы из одного контейнера в другой контейнер, используя выходную привязку.
* Входные и выходные привязки для Azure Cosmos DB можно использовать в одной и той же функции Azure. Это удобно в случаях, когда требуется найти определенные данные с помощью входной привязки, изменить их в функции Azure, а затем сохранить в том же или другом контейнере.
* Входную привязку к контейнеру Azure Cosmos DB можно использовать в той же функции, что и триггер Azure Cosmos DB, и ее можно применять вместе с выходной привязкой или без нее. С помощью такого сочетания можно передавать актуальные данные курса валют (полученные с помощью входной привязки к контейнеру данных обмена валют) в канал изменений для новых заказов в службе корзины для покупок. Обновленную итоговую сумму для корзины для покупок, в которой учтена конвертация валют, можно записать в третий контейнер с помощью выходной привязки.

## <a name="use-cases"></a>Варианты использования

В следующих вариантах использования демонстрируются несколько способов максимально эффективного использования данных Azure Cosmos DB с помощью подключения данных к функциям Azure, управляемым событиями.

### <a name="iot-use-case---azure-cosmos-db-trigger-and-output-binding"></a>Вариант использования для Интернета вещей. Триггер и выходная привязка Azure Cosmos DB

В реализациях Интернета вещей, например, можно вызывать функцию при отображении индикатора проверки двигателя в подключенном автомобиле.

**Реализация:** использование триггера и выходной привязки Azure Cosmos DB

1. **Триггер Azure Cosmos DB** используется для активации событий, связанных с сигналами автомобиля, такими как включение индикатора проверки двигателя в подключенном автомобиле.
2. Когда загорается индикатор проверки двигателя, данные датчика отправляются в Azure Cosmos DB.
3. Azure Cosmos DB создает или обновляет документы данных датчика, а затем эти изменения передаются потоком в триггер Azure Cosmos DB.
4. Триггер вызывается при каждом изменении данных в коллекции данных датчика, так как все изменения передаются потоком через канал изменений.
5. В функции задано пороговое условие, при достижении которого данные датчика передаются в отдел гарантийного обслуживания.
6. Кроме того, если температура превышает некоторое определенное значение, владельцу отправляется оповещение.
7. **Выходная привязка** в функции обновляет запись автомобиля в другой коллекции Azure Cosmos DB, чтобы сохранить информацию о событии проверки двигателя.

На рисунке ниже приведен код, написанный на портале Azure для этого триггера.

![Создание триггера Azure Cosmos DB на портале Azure](./media/serverless-computing-database/cosmos-db-trigger-portal.png)

### <a name="financial-use-case---timer-trigger-and-input-binding"></a>Вариант использования в сфере финансов. Триггер таймера и входная привязка

В сфере финансов можно вызывать функцию, когда баланс банковского счета становится меньше определенной суммы.

**Реализация:** триггер таймера с входной привязкой Azure Cosmos DB

1. С помощью [триггера таймера](../azure-functions/functions-bindings-timer.md) можно получать сведения о балансе банковского счета, хранящиеся в контейнере Azure Cosmos DB, через заданные интервалы времени с помощью **входной привязки**.
2. Если баланс меньше минимального порогового баланса, установленного пользователем, то выполняется действие из функции Azure.
3. Выходная привязка может быть [интеграцией SendGrid](../azure-functions/functions-bindings-sendgrid.md), которая отправляет сообщение из учетной записи службы на адреса электронной почты, указанные для учетных записей с низким балансом.

На следующих рисунках представлен код на портале Azure для этого сценария.

![Файл index.js триггера таймера для сценария в сфере финансов](./media/serverless-computing-database/cosmos-db-functions-financial-trigger.png)

![Файл Run.csx триггера таймера для сценария в сфере финансов](./media/serverless-computing-database/azure-function-cosmos-db-trigger-run.png)

### <a name="gaming-use-case---azure-cosmos-db-trigger-and-output-binding"></a>Вариант использования в сфере игр. Триггер и выходная привязка Azure Cosmos DB

В играх при создании пользователя можно выполнить поиск других пользователей, которые могут быть знакомы с ним, с помощью [API Graph Azure Cosmos DB](graph-introduction.md). Затем можно записать результаты в [базу данных SQL Azure Cosmos DB] для удобного поиска.

**Реализация:** использование триггера и выходной привязки Azure Cosmos DB

1. Используя [базу данных графа](graph-introduction.md) Azure DB Cosmos для хранения всех пользователей, можно создать новую функцию с триггером Azure Cosmos DB. 
2. При вставке нового пользователя вызывается функция, результат которой сохраняется с помощью **выходной привязки**.
3. Функция отправляет запрос к базе данных графа, чтобы найти всех пользователей, которые непосредственно связаны с новым пользователем, и получает этот набор данных.
4. Затем эти данные сохраняются в Azure Cosmos DB, после чего их легко получить любое внешнее приложение, показывающее новому пользователю подключенных друзей.

### <a name="retail-use-case---multiple-functions"></a>Вариант использования в сфере розничной торговли. Несколько функций

В сфере розничной торговли вы можете создать функции для предложения сопроводительных товаров, вызываемые, когда пользователь добавляет товар в свою корзину.

**Реализация:** несколько триггеров Azure Cosmos DB, ожидающих передачи данных из одной коллекции

1. Можно создать несколько функций Azure и добавить в каждую из них триггеры Azure Cosmos DB, которые ожидают передачи данных из одного канала изменений данных корзины для покупок. Обратите внимание, если несколько функций прослушивают один канал изменений, для каждой функции требуется новая коллекция аренды. Дополнительные сведения о коллекциях аренды см. в разделе [Основные сведения о библиотеке обработчика канала изменений](change-feed.md#understand-cf).
2. Всякий раз, когда пользователь добавляет товар в корзину для покупок, каждая функция независимо вызывается каналом изменений из контейнера корзины для покупок.
    * Одна функция может использовать текущее содержимое корзины, чтобы изменить отображаемый набор дополнительных товаров, которые могут заинтересовать пользователя.
    * Другая функция может обновлять итоговые данные товаров.
    * Еще одна функция может отправлять сведения об определенных товарах, выбранных клиентом, в отдел маркетинга, который рассылает покупателям рекламу. 

    Любой отдел может создать триггер Azure Cosmos DB, ожидающий передачи данных из канала изменений. Это позволит избежать задержки критических событий в процессе обработки заказов.

Во всех этих вариантах использования, так как функция отделена от приложения, не нужно постоянно запускать новые экземпляры приложения. Вместо этого служба "Функции Azure" по мере необходимости запускает отдельные функции для выполнения отдельных процессов.

## <a name="tooling"></a>Инструментарий

Естественная интеграция между службой "Функции Azure" и Azure Cosmos DB доступна на портале Azure и в Visual Studio 2017.
* На портале службы "Функции Azure" можно создать триггер Azure Cosmos DB. Краткое руководство приведено в разделах [Создание триггера Azure Cosmos DB на портале Azure](https://aka.ms/cosmosdbtriggerportalfunc) и ![Create an Azure Cosmos DB trigger in the Azure Functions portal](./media/serverless-computing-database/azure-function-cosmos-db-trigger.png) (Создание триггера Azure Cosmos DB на портале службы "Функции Azure"). 
* На портале службы "Функции Azure" можно также добавлять входные и выходные привязки Azure Cosmos DB для триггеров других типов. Краткое руководство приведено в разделе [Хранение неструктурированных данных с помощью служб Функции Azure и Cosmos DB](../azure-functions/functions-integrate-store-unstructured-data-cosmosdb.md).
    ![Создание триггера Azure Cosmos DB на портале службы "Функции Azure"](./media/serverless-computing-database/function-portal-input-binding.png)
*   На портале Azure Cosmos DB триггер Azure Cosmos DB можно добавить в приложение-функцию Azure в той же группе ресурсов.
    ![Создание триггера Azure Cosmos DB на портале службы "Функции Azure"](./media/serverless-computing-database/cosmos-db-portal.png)
* В Visual Studio 2017 можно создать триггер Azure Cosmos DB с помощью встроенного шаблона.

    >[!VIDEO https://www.youtube.com/embed/iprndNsUeeg]


## <a name="why-choose-azure-functions-integration-for-serverless-computing"></a>В чем преимущества интеграции службы "Функции Azure" для бессерверных вычислений?

Служба "Функции Azure" дает возможность создавать масштабируемые единицы работы, или компактные элементы логики, которые могут выполняться по требованию, без подготовки ресурсов или управления инфраструктурой. Используя службу "Функции Azure", вы можете не создавать полнофункциональное приложение для реагирования на изменения в базе данных Azure Cosmos DB. Можно создать небольшие многократно используемые функции для выполнения конкретных задач. Кроме того, можно использовать данные Azure Cosmos DB как входные или выходные данные функции Azure, передаваемые в ответ на событие, например HTTP-запросы или триггер таймера.

Azure Cosmos DB является рекомендуемой базой данных для бессерверной вычислительной архитектуры по следующим причинам.

* **Мгновенный доступ ко всем данным**. У вас есть детализированный доступ к каждому хранимому значению, так как Azure Cosmos DB [автоматически индексирует](indexing-policies.md) все данные по умолчанию и немедленно предоставляет эти индексы. Это означает, что вы можете непрерывно запрашивать и обновлять имеющиеся элементы в базе данных, а также добавлять в нее новые элементы, используя мгновенный доступ с помощью службы "Функции Azure".

* **Отсутствие схем**. В Azure Cosmos DB нет схем, поэтому предоставляется уникальная возможность обрабатывать любые выходные данные функции Azure. Такой подход "обработка чего угодно" упрощает создание разнообразных функций, выводящих данные в Azure Cosmos DB.

* **Масштабируемая пропускная способность**. Пропускная способность в Azure Cosmos DB может масштабироваться мгновенно. Если у вас есть сотни или тысячи функций, которые отправляют запросы и записывают данные в одну и ту же коллекцию, можно увеличить число [единиц запроса в секунду](request-units.md), чтобы справиться с нагрузкой. Все функции могут работать параллельно, используя выделенное количество единиц запроса в секунду, при этом [согласованность](consistency-levels.md) данных гарантируется.

* **Глобальная репликация**. Можно выполнять репликацию данных Azure Cosmos DB [по всему миру](distribute-data-globally.md), чтобы сократить задержку, находя и предоставляя данные, расположенные ближе всего к вашим пользователям. Как и для всех запросов к Azure Cosmos DB, данные из триггеров, управляемых событиями, считываются из базы данных Azure Cosmos DB, расположенной ближе всего к пользователю.

Если вы собираетесь интегрировать службу "Функции Azure" для хранения данных и вам не нужно глубокое индексирование или если вам необходимо сохранять вложения и файлы мультимедиа, [триггер хранилища BLOB-объектов Azure](../azure-functions/functions-bindings-storage-blob.md) может быть лучшим вариантом.

Преимущества службы "Функции Azure": 

* **Управление событиями**. Служба "Функции Azure" управляется событиями и может ожидать передачи данных из канала изменений Azure Cosmos DB. Это означает, что вам не нужно создавать логику ожидания передачи данных, и можно просто следить за интересующими изменениями. 

* **Нет ограничений**. Функции выполняются в параллельном режиме, и служба запускает столько экземпляров, сколько требуется. Вы можете настроить соответствующие параметры.

* **Хорошо подходит для быстрых задач**. Служба запускает новые экземпляры функций всякий раз, когда происходит событие, и закрывает их сразу же после выполнения функции. Вы платите только за время выполнения функций.

Если вы не уверены, что подойдет для вашей реализации: Flow, Logic Apps, служба "Функции Azure" или веб-задания, ознакомьтесь с разделом [Сравнение Microsoft Flow, Logic Apps, функций и веб-заданий Azure](../azure-functions/functions-compare-logic-apps-ms-flow-webjobs.md).

## <a name="next-steps"></a>Дополнительная информация

Теперь можно подключить Azure Cosmos DB и службу "Функции Azure" по-настоящему: 

* [Создание триггера Azure Cosmos DB на портале Azure](https://aka.ms/cosmosdbtriggerportalfunc)
* [Создание триггера HTTP в Функциях Azure с помощью входной привязки Azure Cosmos DB](https://aka.ms/cosmosdbinputbind)
* [Хранение неструктурированных данных с помощью служб Функции Azure и Cosmos DB](../azure-functions/functions-integrate-store-unstructured-data-cosmosdb.md)
* [Привязки и триггеры Azure Cosmos DB](../azure-functions/functions-bindings-cosmosdb.md)


 



