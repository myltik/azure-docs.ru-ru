---
title: Поддержка брандмауэра Azure Cosmos DB и контроль доступа по протоколу IP | Документация Майкрософт
description: Сведения о настройке поддержки брандмауэра в учетных записях базы данных Azure Cosmos DB с помощью политик контроля доступа на основе IP-адресов.
keywords: Контроль доступа на основе IP-адресов, поддержка брандмауэра
services: cosmos-db
author: SnehaGunda
manager: kfile
tags: azure-resource-manager
ms.service: cosmos-db
ms.devlang: na
ms.topic: conceptual
ms.date: 03/30/2018
ms.author: sngun
ms.openlocfilehash: f0cbbe147386aa5d50e207fdd9c86fd9571ec144
ms.sourcegitcommit: 266fe4c2216c0420e415d733cd3abbf94994533d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34611744"
---
# <a name="azure-cosmos-db-firewall-support"></a>Поддержка брандмауэра для Azure Cosmos DB
Для защиты данных, хранящихся в учетных записях базы данных Azure Cosmos DB, в Cosmos DB реализована поддержка [модели авторизации](https://msdn.microsoft.com/library/azure/dn783368.aspx) на основе секретов. Проверка целостности данных в этой модели осуществляется с помощью надежного кода проверки подлинности сообщений, использующего хэш-функции (HMAC). Теперь, помимо модели авторизации на основе секрета, для поддержки входящего трафика брандмауэра база данных Azure Cosmos DB использует политики контроля доступа на основе IP-адресов. Эта модель похожа на использование правил брандмауэра в традиционной системе базы данных. Она предоставляет дополнительный уровень защиты для учетных записей базы данных Azure Cosmos DB. Кроме того, эта модель позволяет настроить доступ к учетной записи базы данных Azure Cosmos DB только из утвержденных компьютеров и (или) облачных служб. Для доступа к ресурсам Azure Cosmos DB из этих утвержденных компьютеров и служб пользователь (вызывающая сторона) по-прежнему должен предоставить допустимый маркер проверки подлинности.

> [!NOTE]
> Сейчас поддержка брандмауэров доступна для учетных записей API SQL для Azure Cosmos DB и Mongo API. В скором времени будет доступна возможность настройки брандмауэров для других API и национальных облаков, таких как Azure для Германии или Azure для государственных организаций. Если вы планируете настроить список управления доступом (ACL) конечной точки службы для учетной записи Azure Cosmos DB, для которой настроен существующий брандмауэр IP, запишите его конфигурацию, удалите брандмауэр IP и затем настройте ACL конечной точки службы. После настройки конечной точки службы можно повторно включить брандмауэр IP, если это необходимо.

## <a name="ip-access-control-overview"></a>Общие сведения о контроле доступа на основе IP-адресов
По умолчанию доступ к учетной записи базы данных Azure Cosmos DB можно получить через Интернет при условии, что запрос сопровождается допустимым маркером проверки подлинности. Чтобы настроить политики контроля доступа на основе IP-адресов, пользователь должен предоставить набор IP-адресов или их диапазонов в нотации CIDR, которые добавляются в список разрешенных клиентских IP-адресов для указанной учетной записи базы данных. После применения этой конфигурации сервер блокирует все запросы, полученные от компьютеров, IP-адреса которых не входят в список разрешенных.  На следующей схеме показан поток обработки подключения для управления доступом на основе IP-адресов.

![Схема подключения для контроля доступа на основе IP-адресов](./media/firewall-support/firewall-support-flow.png)

## <a id="configure-ip-policy"></a> Настройка политики контроля доступа на основе IP-адресов
Политику управления доступом на основе IP-адресов можно задать на портале Azure или программно с помощью [Azure CLI](cli-samples.md), [Azure PowerShell](powershell-samples.md) или [REST API](/rest/api/cosmos-db/), обновив свойство **ipRangeFilter**. 

Чтобы настроить политику управления доступом на основе IP-адресов на портале Azure, перейдите на страницу учетной записи Azure Cosmos DB, в меню навигации щелкните **Брандмауэр**, а затем измените значение параметра **Разрешить доступ из** на **Выбранные сети** и нажмите кнопку **Сохранить**. 

![Снимок экрана, показывающий, как открыть страницу "Брандмауэр" на портале Azure](./media/firewall-support/azure-portal-firewall.png)

Включив политику управления доступом на основе IP-адресов, вы можете задать IP-адреса и их диапазоны, а также предоставить доступ к другим службам Azure и самому порталу. Дополнительные сведения об этих параметрах см. в разделах ниже.

> [!NOTE]
> После включения политики контроля доступа на основе IP-адресов для учетной записи базы данных Azure Cosmos DB все подключения к этой учетной записи с компьютеров, диапазоны IP-адресов которых не входят в список разрешенных, блокируются. При использовании этой модели просмотр операций с плоскостью данных на портале также блокируется, чтобы обеспечить целостность контроля доступа.

## <a name="connections-from-the-azure-portal"></a>Подключения с портала Azure 

Чтобы программным способом обеспечить доступ к порталу Azure при включении политики управления доступом на основе IP-адресов, необходимо добавить его IP-адрес к свойству **ipRangeFilter**. IP-адрес портала:

|Регион|IP-адрес|
|------|----------|
|Все области, за исключением указанных ниже|104.42.195.92,40.76.54.131,52.176.6.30,52.169.50.45,52.187.184.26|
|Германия|51.4.229.218|
|Китай|139.217.8.252|
|Штат в США (для обслуживания государственных организаций США)|52.244.48.71|

При изменении параметра "Брандмауэр" на **Выбранные сети** на портале Azure доступ к порталу Azure включается по умолчанию. 

![Снимок экрана, показывающий, как разрешить доступ к порталу Azure](./media/firewall-support/enable-azure-portal.png)

## <a name="connections-from-other-azure-paas-services"></a>Подключения из других служб PaaS в Azure 
В Azure такие службы PaaS, как Azure Stream Analytics, Функции Azure и Служба приложений Azure, используются в сочетании с Azure Cosmos DB. Вы можете разрешить доступ к учетной записи базы данных Azure Cosmos DB из служб, IP-адреса которых не являются общедоступными. Для этого добавьте IP-адрес 0.0.0.0 в список разрешенных IP-адресов, связанных программно с учетной записью базы данных Azure Cosmos DB. 

При изменении параметра "Брандмауэр" на **Выбранные сети** на портале Azure доступ к другим службам Azure включается по умолчанию. 

![Снимок экрана, показывающий, как открыть страницу "Брандмауэр" на портале Azure](./media/firewall-support/enable-azure-services.png)

## <a name="connections-from-your-current-ip"></a>Подключения из текущего IP-адреса

Для упрощения разработки портал Azure помогает определить и добавить IP-адрес клиентского компьютера в список разрешенных адресов, чтобы приложения, работающие на вашем компьютере, могли получить доступ к учетной записи Azure Cosmos DB. IP-адрес клиента определяется так, как он отображается на портале. Это может быть IP-адрес клиента вашего компьютера, а также IP-адрес вашего сетевого шлюза. Не забудьте удалить его до внесения изменений в рабочую среду.

Чтобы включить текущий IP-адрес, выберите **Add my current IP** (Добавить текущий IP-адрес), чтобы добавить его в список IP-адресов, а затем нажмите кнопку **Сохранить**.

![Снимок экрана, показывающий, как настроить параметры брандмауэра текущего IP-адреса](./media/firewall-support/enable-current-ip.png)

## <a name="connections-from-cloud-services"></a>Подключения из облачных служб
В Azure облачные службы — это стандартный способ размещения логики службы среднего уровня с помощью Azure Cosmos DB. Чтобы разрешить доступ к учетной записи базы данных Azure Cosmos DB из облачной службы, общедоступный IP-адрес этой службы необходимо добавить в список разрешенных IP-адресов, связанных с учетной записью базы данных Azure Cosmos DB. Для этого следует [настроить политику контроля доступа на основе IP-адресов](#configure-ip-policy). Это позволит обеспечить доступ к учетной записи базы данных Azure Cosmos DB для всех экземпляров ролей облачных служб. IP-адреса для ваших облачных служб можно получить на портале Azure, как показано на следующем снимке экрана:

![Снимок экрана с общедоступным IP-адресом для облачной службы на портале Azure](./media/firewall-support/public-ip-addresses.png)

При расширении своей облачной службы за счет добавления дополнительных экземпляров ролей эти новые экземпляры автоматически получают доступ к учетной записи базы данных Azure Cosmos DB, так как они входят в ту же самую облачную службу.

## <a name="connections-from-virtual-machines"></a>Подключения из виртуальных машин
[Виртуальные машины](https://azure.microsoft.com/services/virtual-machines/) или [масштабируемые наборы виртуальных машин](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) также можно использовать для размещения служб среднего уровня с помощью Azure Cosmos DB.  Чтобы настроить доступ к учетной записи базы данных Azure Cosmos DB из виртуальных машин, общедоступные IP-адреса виртуальной машины и (или) масштабируемого набора виртуальных машин необходимо добавить в список разрешенных IP-адресов для этой учетной записи. Для этого следует [настроить политику контроля доступа на основе IP-адресов](#configure-ip-policy). IP-адреса для виртуальных машин можно получить на портале Azure, как показано на следующем снимке экрана.

![Снимок экрана с общедоступным IP-адресом для виртуальной машины на портале Azure](./media/firewall-support/public-ip-addresses-dns.png)

При добавлении в группу дополнительных экземпляров виртуальных машин они автоматически получают доступ к вашей учетной записи базы данных Azure Cosmos DB.

## <a name="connections-from-the-internet"></a>Подключения через Интернет
При подключении к учетной записи базы данных Azure Cosmos DB с компьютера через Интернет IP-адрес или диапазон IP-адресов клиента необходимо добавить в список разрешенных IP-адресов для этой учетной записи. 

## <a name="troubleshooting-the-ip-access-control-policy"></a>Устранение неполадок с политикой контроля доступа на основе IP-адресов
### <a name="portal-operations"></a>Операции на портале
После включения политики контроля доступа на основе IP-адресов для учетной записи базы данных Azure Cosmos DB все подключения к этой учетной записи с компьютеров, диапазоны IP-адресов которых не входят в список разрешенных, блокируются. Поэтому, чтобы разрешить на портале выполнение операций плоскости данных, таких как просмотр коллекций и запрос документов, необходимо явным образом разрешить доступ к порталу Azure на странице **Брандмауэр**. 

![Снимок экрана, показывающий, как разрешить доступ к порталу Azure](./media/firewall-support/azure-portal-firewall.png)

### <a name="sdk--rest-api"></a>Пакет SDK и REST API
По соображениям безопасности при доступе с помощью пакета SDK и REST API с компьютеров, IP-адреса которых не входят в список разрешенных, вернется ответ с кодом 404 (объект не найден) без каких-либо дополнительных сведений. Проверьте список разрешенных IP-адресов и убедитесь, что у политики допустимая конфигурация для учетной записи базы данных Azure Cosmos DB.

## <a name="next-steps"></a>Дополнительная информация
Советы по улучшению производительности, связанные с сетью, см. в [этой статье](performance-tips.md).

