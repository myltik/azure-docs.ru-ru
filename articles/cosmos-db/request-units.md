---
title: "Единицы запросов и оценка пропускной способности (Azure Cosmos DB) | Документация Майкрософт"
description: "Сведения о том, как понять факторы, задать и оценить количество необходимых единиц запросов в Azure Cosmos DB."
services: cosmos-db
author: mimig1
manager: jhubbard
editor: mimig
documentationcenter: 
ms.assetid: d0a3c310-eb63-4e45-8122-b7724095c32f
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/10/2017
ms.author: mimig
ms.translationtype: HT
ms.sourcegitcommit: 398efef3efd6b47c76967563251613381ee547e9
ms.openlocfilehash: 7a4efc0fb9b3855b9dbbe445768ceb2a9940d0b2
ms.contentlocale: ru-ru
ms.lasthandoff: 08/11/2017

---
# <a name="request-units-in-azure-cosmos-db"></a>Единицы запросов в базе данных Azure Cosmos DB
На странице базы данных Azure Cosmos DB теперь доступен [калькулятор единиц запросов](https://www.documentdb.com/capacityplanner). Дополнительные сведения см. в разделе [Оценка требований к пропускной способности](request-units.md#estimating-throughput-needs).

![Калькулятор пропускной способности][5]

## <a name="introduction"></a>Введение
[Azure Cosmos DB](https://azure.microsoft.com/services/cosmos-db/) — это глобально распределенная многомодельная база данных Майкрософт. Благодаря Azure Cosmos DB вам не нужно арендовать виртуальные машины, развертывать программное обеспечение или отслеживать работу баз данных. Систему Azure Cosmos DB обслуживают и непрерывно контролируют ведущие инженеры корпорации Майкрософт, что позволяет добиться доступности, производительности и защиты данных мирового уровня. Вы можете получить доступ к своим данным, используя выбранные API, так как [DocumentDB SQL](documentdb-sql-query.md) (документ), MongoDB (документ), [Хранилище таблиц Azure](https://azure.microsoft.com/services/storage/tables/) (ключ — значение) и [Gremlin](https://tinkerpop.apache.org/gremlin.html) (Graph) поддерживаются изначально. Плата за использование Azure Cosmos DB выражается в единицах запросов (ЕЗ). При использовании единиц запросов вам не нужно резервировать операции чтения и записи или подготавливать ресурсы ЦП, объем памяти и операции ввода-вывода в секунду.

Azure Cosmos DB поддерживает ряд интерфейсов API для выполнения разных операций — от простых операций чтения и записи до сложных запросов графа. Так как не все запросы одинаковы, им назначается нормализованное количество **единиц запроса** на основе объема вычислений, необходимых для обслуживания запроса. Количество единиц запросов для операции предопределено. В заголовке ответа вы можете проверить количество единиц запросов, потребляемых любой операцией в Azure Cosmos DB. 

Чтобы обеспечить прогнозируемую производительность, пропускную способность необходимо резервировать блоками по 100 единиц запросов в секунду. 

Ознакомившись с данной статьей, вы сможете ответить на следующие вопросы.  

* Что такое единицы запросов и затраты на запросы?
* Как задать количество единиц запросов для одной коллекции?
* Как оценить приемлемое количество единиц запросов для моего приложения?
* Что произойдет, если превысить максимальное количество единиц запросов для одной коллекции?

Azure Cosmos DB — это многомодельная база данных. Поэтому важно отметить, что мы будем рассматривать коллекции или документы в отношении API документа, графы или узлы в отношении API Graph и таблицы или сущности в отношении API таблицы. Пропускная способность в этой статье в целом относится к контейнеру или элементу.

## <a name="request-units-and-request-charges"></a>Единицы запросов и затраты на запросы
Azure Cosmos DB обеспечивает высокую прогнозируемую производительность за счет *резервирования* ресурсов для удовлетворения требований к пропускной способности приложения.  Так как нагрузка приложения и шаблоны доступа могут со временем меняться, Azure Cosmos DB позволяет легко увеличивать или уменьшать зарезервированную пропускную способность для приложения.

В Azure Cosmos DB зарезервированная пропускная способность указывается в обрабатываемых единицах запросов в секунду. Так как пропускная способность зависит от единиц запросов, вы можете *зарезервировать* для приложения гарантированное количество единиц запросов в секунду.  Каждая операция в Azure Cosmos DB (например, создание документа, выполнение запроса, обновление документа) сопровождается потреблением ресурсов ЦП, объема памяти и выполнением операций ввода-вывода.  Иными словами, при выполнении каждой операции взимается *плата за запрос*, которая выражается в *единицах запроса*.  Зная факторы, которые влияют на затраты единиц запросов, и требования приложения к пропускной способности, вы сможете значительно снизить затраты на работу приложения. Обозреватель запросов — это также эффективное средство для тестирования запросов.

Прежде чем приступить к работе, мы рекомендуем просмотреть следующий видеоролик, в котором Аравинд Рамачандран (Aravind Ramachandran) объясняет, что такое единицы запросов и прогнозируемая производительность в Azure Cosmos DB.

> [!VIDEO https://channel9.msdn.com/Shows/Azure-Friday/Predictable-Performance-with-DocumentDB/player]
> 
> 

## <a name="specifying-request-unit-capacity-in-azure-cosmos-db"></a>Указание количества единиц запросов в Azure Cosmos DB
При создании коллекции, таблицы или графа необходимо указать количество единиц запросов в секунду, которое вы хотите зарезервировать. На основе подготовленной пропускной способности база данных Azure Cosmos DB выделяет физические разделы для размещения коллекции и разделяет или перераспределяет данные между разделами по мере увеличения их объема.

Если коллекция подготовлена с 2500 (или более) единицами запросов, для базы данных Azure Cosmos DB необходимо указать ключ раздела. Ключ раздела также потребуется в будущем, если вы захотите масштабировать пропускную способность коллекции до более 2500 единиц запросов. Поэтому мы настоятельно рекомендуем при создании контейнера настроить [ключ раздела](partition-data.md) независимо от начальной пропускной способности. Так как ваши данные могут быть разделены между несколькими разделами, выбирайте ключ раздела с большим количеством элементов (от 100 до миллионов уникальных значений), чтобы база данных Azure Cosmos DB могла равномерно масштабировать вашу коллекцию, таблицу, граф и запросы. 

> [!NOTE]
> Ключ раздела представляет собой логическую границу, а не физическую. Поэтому вам не нужно ограничивать количество отдельных значений ключа раздела. Чем больше отдельных значений ключа раздела, тем лучше. Такой ключ предоставляет Azure Cosmos DB больше вариантов балансировки нагрузки.

Ниже приведен фрагмент кода для создания коллекции с 3000 единиц запросов в секунду с помощью пакета SDK для .NET.

```csharp
DocumentCollection myCollection = new DocumentCollection();
myCollection.Id = "coll";
myCollection.PartitionKey.Paths.Add("/deviceId");

await client.CreateDocumentCollectionAsync(
    UriFactory.CreateDatabaseUri("db"),
    myCollection,
    new RequestOptions { OfferThroughput = 3000 });
```

Azure Cosmos DB использует модель резервирования пропускной способности. То есть вы получаете счет за *зарезервированную* пропускную способность независимо от фактических показателей *использования*. Так как нагрузка, данные и шаблоны использования приложения меняются, вы можете легко увеличивать или уменьшать количество зарезервированных единиц запросов с помощью пакетов SDK или [портала Azure](https://portal.azure.com).

Каждая коллекция, таблица, граф сопоставляется с ресурсом `Offer` в Azure Cosmos DB, который содержит метаданные о подготовленной пропускной способности. Вы можете изменить выделенную пропускную способность. Для этого найдите соответствующий ресурс предложения для контейнера и измените в нем значение пропускной способности. Ниже приведен фрагмент кода для изменения пропускной способности коллекции до 5000 единиц запроса в секунду с помощью пакета SDK для .NET.

```csharp
// Fetch the resource to be updated
Offer offer = client.CreateOfferQuery()
                .Where(r => r.ResourceLink == collection.SelfLink)    
                .AsEnumerable()
                .SingleOrDefault();

// Set the throughput to 5000 request units per second
offer = new OfferV2(offer, 5000);

// Now persist these changes to the database by replacing the original resource
await client.ReplaceOfferAsync(offer);
```

Изменение пропускной способности не влияет на доступность контейнера. Обычно новая зарезервированная пропускная способность становится доступной для приложения в течение нескольких секунд.

## <a name="request-unit-considerations"></a>Рекомендации по оценке необходимого количества единиц запросов
При оценке количества единиц запросов, которое нужно зарезервировать для контейнера Azure Cosmos DB, важно учитывать следующие рекомендации:

* **Размер элемента.** По мере увеличения размера также увеличивается и число единиц запросов, расходуемых на чтение или запись данных.
* **Число свойств элемента.** Если все свойства индексируются, число единиц запросов, расходуемых на запись документа, узла или сущности, увеличивается вместе с увеличением количества свойств.
* **Согласованность данных**. При использовании строгого уровня согласованности данных или уровня согласованности с ограниченным устареванием на чтение элементов расходуются дополнительные единицы запросов.
* **Индексируемые свойства**. Свойства, которые индексируются по умолчанию, определяются политикой индексирования для каждого контейнера. Вы можете сократить потребление единиц запросов, ограничив количество индексируемых свойств или включив отложенное индексирование.
* **Индексирование документов**. По умолчанию каждый элемент индексируется автоматически. Исключение некоторых элементов из этого процесса позволяет сэкономить единицы запросов.
* **Шаблоны запросов**. Сложность запроса влияет на количество потребляемых единиц запросов для операции. Количество предикатов и их характер, проекции, количество определяемых пользователем функций и размер набора исходных данных — все это влияет на плату за операции запроса.
* **Использование скриптов**.  Так же как и запросы, хранимые процедуры и триггеры расходуют единицы запросов с учетом сложности выполняемых операций. При разработке приложения проверяйте заголовок со стоимостью в единицах запросов, чтобы лучше понять, как эти ресурсы используются каждой из операций.

## <a name="estimating-throughput-needs"></a>Оценка требований к пропускной способности
Единица запроса — это нормализованная мера стоимости обработки запросов. Одна единица запроса соответствует вычислительной мощности, необходимой для чтения (через ссылку self или идентификатор) элемента размером 1 КБ, содержащего 10 уникальных значений свойств (кроме свойств системы). Запрос на создание (вставку), замену или удаление того же элемента будет использовать дополнительные вычислительные ресурсы службы и поэтому потребует больше единиц запросов.   

> [!NOTE]
> Базовый план 1 единицы запроса для элемента размером 1 КБ соответствует простой команде GET по ссылке self или идентификатору этого элемента.
> 
> 

Например, ниже приведена таблица, показывающая количество единиц запросов для подготовки с тремя разными размерами элемента (1, 4 и 64 КБ) и двумя разными уровнями производительности (500 операций чтения в секунду + 100 операций записи в секунду и 500 операций чтения в секунду + 500 операций записи в секунду). Согласованность данных была настроена в сеансе, а политике индексации было присвоено значение "Нет".

<table border="0" cellspacing="0" cellpadding="0">
    <tbody>
        <tr>
            <td valign="top"><p><strong>Размер элемента</strong></p></td>
            <td valign="top"><p><strong>Операций чтения в секунду</strong></p></td>
            <td valign="top"><p><strong>Операций записи в секунду</strong></p></td>
            <td valign="top"><p><strong>Единиц запросов</strong></p></td>
        </tr>
        <tr>
            <td valign="top"><p>1 КБ</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>100</p></td>
            <td valign="top"><p>(500 * 1) + (100 * 5) = 1000 единиц запросов в секунду</p></td>
        </tr>
        <tr>
            <td valign="top"><p>1 КБ</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>(500 * 1) + (500 * 5) = 3000 единиц запросов в секунду</p></td>
        </tr>
        <tr>
            <td valign="top"><p>4 КБ</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>100</p></td>
            <td valign="top"><p>(500 * 1,3) + (100 * 7) = 1350 единиц запросов в секунду</p></td>
        </tr>
        <tr>
            <td valign="top"><p>4 КБ</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>(500 * 1,3) + (500 * 7) = 4150 единиц запросов в секунду</p></td>
        </tr>
        <tr>
            <td valign="top"><p>64 КБ</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>100</p></td>
            <td valign="top"><p>(500 * 10) + (100 * 48) = 9800 единиц запросов в секунду</p></td>
        </tr>
        <tr>
            <td valign="top"><p>64 КБ</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>500</p></td>
            <td valign="top"><p>(500 * 10) + (500 * 48) = 29 000 единиц запросов в секунду</p></td>
        </tr>
    </tbody>
</table>

### <a name="use-the-request-unit-calculator"></a>Использование калькулятора единиц запросов
Чтобы клиенты могли точно оценить требуемую пропускную способность, они могут воспользоваться [веб-калькулятором единиц запроса](https://www.documentdb.com/capacityplanner). Это средство помогает оценить количество требующихся единиц запроса для стандартных операций, включая:

* операции создания элемента (запись);
* операции чтения элемента;
* операции удаления элемента;
* операции обновления элемента.

Средство также позволяет оценивать требования к хранилищу данных на основе предоставленных образцов элементов.

Использовать это средство просто:

1. Загрузите один или несколько образцов элементов.
   
    ![Загрузка элементов в калькулятор единиц запросов][2]
2. Чтобы оценить требования к хранилищу данных, укажите общее количество элементов, которые вы планируете хранить.
3. Укажите нужное количество операций создания, чтения, обновления и удаления элементов (в секунду). Чтобы оценить затраты единиц запросов для операций обновления элемента, отправьте копию образца элемента (см. шаг 1 выше), который содержит стандартные обновления полей.  Например, если операции обновления элемента обычно изменяют свойства lastLogin и userVisits, просто скопируйте образец элемента, обновите значения этих двух свойств и отправьте копию элемента.
   
    ![Ввод требований к пропускной способности в калькуляторе единиц запросов][3]
4. Нажмите кнопку "Вычислить" и ознакомьтесь с результатами.
   
    ![Результаты калькулятора единиц запросов][4]

> [!NOTE]
> Если размер и количество индексированных свойств для разных типов элемента существенно отличаются, отправьте в средство образцы стандартного элемента каждого *типа* и проведите вычисления.
> 
> 

### <a name="use-the-azure-cosmos-db-request-charge-response-header"></a>Использование заголовка ответа на запрос Azure Cosmos DB о затратах
Каждый ответ от службы Azure Cosmos DB включает пользовательский заголовок (`x-ms-request-charge`), который содержит количество используемых на данный запрос единиц запросов. Этот заголовок также доступен в пакетах SDK для Azure Cosmos DB. В пакете .NET SDK RequestCharge является свойством объекта ResourceResponse.  В обозревателе запросов Azure Cosmos DB на портале Azure содержится информация о затратах на выполненные запросы.

![Анализ затрат единиц расходов в обозревателе запросов][1]

Исходя из этого, один из методов оценки необходимого для приложения объема зарезервированной пропускной способности — записать затраты единиц запросов на выполнение стандартных операций для определенного элемента, который используется приложением, а затем оценить предполагаемое количество операций в секунду.  Не забудьте учесть стандартные запросы и скрипт Azure Cosmos DB, а также выполнить их оценку.

> [!NOTE]
> Если размер и количество индексированных свойств для типов элемента существенно отличаются, запишите затраты единиц запросов для соответствующей операции, выполняемой с каждым *типом* стандартного элемента.
> 
> 

Например:

1. Запишите затраты единиц запросов на создание (вставку) стандартного элемента. 
2. Запишите затраты единиц запросов на чтение стандартного элемента.
3. Запишите затраты единиц запросов на обновление стандартного элемента.
4. Запишите затраты единиц запросов на выполнение стандартных, общих запросов элемента.
5. Запишите затраты единиц запросов на все настраиваемые скрипты (хранимые процедуры, триггеры, определяемые пользователем функции), которые используются приложением.
6. Рассчитайте необходимое количество единиц запросов для операций, которые вы планируете выполнять каждую секунду.

### <a id="GetLastRequestStatistics"></a>Выполнение команды MongoDB GetLastRequestStatistics с помощью API
API для MongoDB поддерживает пользовательскую команду *getLastRequestStatistics*, используемую для получения затрат единиц запроса для указанных операций.

Например, в оболочке Mongo выполните операцию, для которой необходимо проверить затраты единиц запроса.
```
> db.sample.find()
```

Затем выполните команду *getLastRequestStatistics*.
```
> db.runCommand({getLastRequestStatistics: 1})
{
    "_t": "GetRequestStatisticsResponse",
    "ok": 1,
    "CommandName": "OP_QUERY",
    "RequestCharge": 2.48,
    "RequestDurationInMilliSeconds" : 4.0048
}
```

Исходя из этого, один из методов оценки необходимого для приложения объема зарезервированной пропускной способности — записать затраты единиц запросов на выполнение стандартных операций для определенного элемента, который используется приложением, а затем оценить предполагаемое количество операций в секунду.

> [!NOTE]
> Если размер и количество индексированных свойств для типов элемента существенно отличаются, запишите затраты единиц запросов для соответствующей операции, выполняемой с каждым *типом* стандартного элемента.
> 
> 

## <a name="use-api-for-mongodbs-portal-metrics"></a>Использование метрик API для MongoDB, доступных на портале
Самый простой способ получить достоверную оценку затрат единиц запроса для API для базы данных MongoDB — использовать метрики [портала Azure](https://portal.azure.com). Используя диаграммы *Число запросов* и *Запросить оплату*, можно получить приблизительное количество единиц запроса, потребляемое каждой операцией, и количество единиц запроса, которое они потребляют относительно друг друга.

![Метрики API для MongoDB, доступные на портале][6]

## <a name="a-request-unit-estimation-example"></a>Пример оценки количества единиц запросов
Рассмотрим следующий документ размером примерно 1 КБ.

```json
{
 "id": "08259",
  "description": "Cereals ready-to-eat, KELLOGG, KELLOGG'S CRISPIX",
  "tags": [
    {
      "name": "cereals ready-to-eat"
    },
    {
      "name": "kellogg"
    },
    {
      "name": "kellogg's crispix"
    }
  ],
  "version": 1,
  "commonName": "Includes USDA Commodity B855",
  "manufacturerName": "Kellogg, Co.",
  "isFromSurvey": false,
  "foodGroup": "Breakfast Cereals",
  "nutrients": [
    {
      "id": "262",
      "description": "Caffeine",
      "nutritionValue": 0,
      "units": "mg"
    },
    {
      "id": "307",
      "description": "Sodium, Na",
      "nutritionValue": 611,
      "units": "mg"
    },
    {
      "id": "309",
      "description": "Zinc, Zn",
      "nutritionValue": 5.2,
      "units": "mg"
    }
  ],
  "servings": [
    {
      "amount": 1,
      "description": "cup (1 NLEA serving)",
      "weightInGrams": 29
    }
  ]
}
```

> [!NOTE]
> В Azure Cosmos DB документы минифицированы, поэтому их размер в системе немного меньше 1 КБ.
> 
> 

В таблице ниже показаны приблизительные затраты единиц запросов на выполнение стандартных операций в этом элементе (при оценке приблизительных затрат на единицы запросов предполагается, что уровень согласованности для учетной записи имеет значение "Сеанс" и что все элементы индексируются автоматически).

| Операция | Затраты единиц запросов |
| --- | --- |
| Create item (Создание элемента) |~ 15 ЕЗ |
| Чтение элемента |~ 1 ЕЗ |
| Запрос элемента по идентификатору |~ 2,5 ЕЗ |

Кроме того, эта таблица содержит приблизительные затраты единиц запросов для стандартных запросов, используемых в приложении:

| Запрос | Затраты единиц запросов | Число возвращенных элементов |
| --- | --- | --- |
| Выбор продуктов питания по идентификатору |~ 2,5 ЕЗ |1 |
| Выбор продуктов питания по производителю |~ 7 ЕЗ |7 |
| Выбор группы продуктов питания и сортировка по весу |~ 70 ЕЗ |100 |
| Выбор десяти первых продуктов питания в группе |~ 10 ЕЗ |10 |

> [!NOTE]
> Затраты единиц запросов зависят от количества возвращенных элементов.
> 
> 

На основе этой информации можно оценить количество необходимых единиц запросов для приложения в зависимости от предполагаемого количества операций и запросов в секунду:

| Операции и запросы | Предполагаемое количество в секунду | Необходимые единицы запросов |
| --- | --- | --- |
| Create item (Создание элемента) |10 |150 |
| Чтение элемента |100 |100 |
| Выбор продуктов питания по производителю |25 |175 |
| Выбор продуктов питания по группе |10 |700 |
| Выбор первых десяти продуктов питания |15 |Всего 150 |

В этом случае ожидается, что для средней пропускной способности необходимо 1,275 единиц запросов в секунду.  Если округлить значение до сотен, получается, что для коллекции этого приложения мы должны подготовить 1300 единиц запросов в секунду.

## <a id="RequestRateTooLarge"></a> Превышение лимита зарезервированной пропускной способности в Azure Cosmos DB
Обратите внимание, что при отсутствии средств удельный расход единиц запросов оценивается в расчете на одну секунду. Для приложений, которые превышают подготовленный показатель единиц запросов для контейнера, будет применяться функция регулирования запросов до тех пор, пока их значение не станет ниже зарезервированного уровня. При регулировании сервер заблаговременно завершит запрос с ошибкой RequestRateTooLargeException (код состояния HTTP: 429) и вернет заголовок x-ms-retry-after-ms, указывая время в миллисекундах, спустя которое можно повторно выполнить запрос.

    HTTP Status 429
    Status Line: RequestRateTooLarge
    x-ms-retry-after-ms :100

Если вы используете клиентский пакет SDK для .NET и запросы LINQ, в большинстве случаев вам никогда не придется иметь дело с этим исключением. Текущая версия клиентского пакета SDK для .NET перехватит этот ответ, обработает заголовок "retry-after", указанный сервером, и отправит запрос повторно. Если к вашей учетной записи параллельно имеет доступ только один клиент, следующая попытка будет успешной.

В случае, если к вашей учетной записи имеют доступ несколько клиентов и они выполняют запросы одновременно, процедуры отправки повторного запроса по умолчанию может быть недостаточно, и клиент выдаст для приложения исключение DocumentClientException с кодом состояния 429. В таких случаях рекомендуется обработать алгоритм поведения при отправке повторных запросов и логику для процедуры обработки ошибок приложения или увеличить зарезервированную пропускную способность для контейнера.

## <a id="RequestRateTooLargeAPIforMongoDB"></a> Превышение лимита зарезервированной пропускной способности в API для DocumentDB
Для приложений, которые превышают подготовленный объем единиц запроса для коллекции, будет применяться регулирование до тех пор, пока потребление не опустится ниже зарезервированного уровня. В случае регулирования серверная части будет заблаговременно завершать запрос с кодом ошибки *16500* *Слишком много запросов*. По умолчанию API для MongoDB автоматически повторяет запрос до 10 раз, прежде чем возвращать код ошибки *Слишком много запросов*. Если возникает много ошибок *Слишком много запросов*, рекомендуется добавить механизм повтора в процедуры обработки ошибок своего приложения или [увеличить зарезервированную пропускную способность для коллекции](set-throughput.md).

## <a name="next-steps"></a>Дальнейшие действия
Дополнительные сведения о резервировании пропускной способности с помощью баз данных Azure Cosmos DB см. в следующих ресурсах:

* [Страница цен на Azure Cosmos DB](https://azure.microsoft.com/pricing/details/cosmos-db/)
* [Секционирование в базе данных Azure Cosmos DB с помощью API DocumentDB](partition-data.md)

Дополнительные сведения об Azure Cosmos DB см. в [документации по этой базе данных](https://azure.microsoft.com/documentation/services/cosmos-db/). 

Инструкции по тестированию масштабирования и производительности с помощью Azure Cosmos DB см. в [этой статье](performance-testing.md).

[1]: ./media/request-units/queryexplorer.png 
[2]: ./media/request-units/RUEstimatorUpload.png
[3]: ./media/request-units/RUEstimatorDocuments.png
[4]: ./media/request-units/RUEstimatorResults.png
[5]: ./media/request-units/RUCalculator2.png
[6]: ./media/request-units/api-for-mongodb-metrics.png

