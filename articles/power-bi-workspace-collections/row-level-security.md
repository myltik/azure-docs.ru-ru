---
title: Безопасность уровня строк в коллекциях рабочих областей Power BI
description: Сведения о безопасности уровня строк в коллекциях рабочих областей Power BI.
services: power-bi-embedded
documentationcenter: ''
author: markingmyname
manager: kfile
editor: ''
tags: ''
ROBOTS: NOINDEX
ms.service: power-bi-embedded
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: powerbi
ms.date: 09/20/2017
ms.author: maghan
ms.openlocfilehash: 7256e2f798fbc32c098f19f60b62e577300868c7
ms.sourcegitcommit: 9cdd83256b82e664bd36991d78f87ea1e56827cd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="row-level-security-with-power-bi-workspace-collections"></a>Безопасность уровня строк в коллекциях рабочих областей Power BI

Безопасность на уровне строк можно использовать для ограничения доступа пользователей к определенным данным отчета или набора данных. При этом несколько различных пользователей могут работать в одном и том же отчете, но видеть разные данные. Коллекции рабочих областей Power BI поддерживают наборы данных, для которых настроена функция RLS.

![Блок-схема безопасности уровня строк в коллекциях рабочих областей Power BI](media/row-level-security/flow-1.png)

> [!IMPORTANT]
> Использовать службу "Коллекции рабочих областей Power BI" не рекомендуется. Она будет доступна до июня 2018 года или до даты, указанной в договоре. Мы советуем организовать перенос приложения в Power BI Embedded, чтобы избежать прерываний в его работе. Сведения о том, как перенести данные из коллекций рабочих областей Power BI в Power BI Embedded, см. в [этой статье](https://powerbi.microsoft.com/documentation/powerbi-developer-migrate-from-powerbi-embedded/).

Чтобы воспользоваться преимуществами безопасности на уровне строк, важно понять суть трех основных понятий: "Пользователи", "Роли" и "Правила". Давайте подробнее рассмотрим каждое из них.

**Пользователи** — это фактические конечные пользователи, просматривающие отчеты. В службе коллекций рабочих областей Power BI пользователи идентифицируются по свойству username в маркере приложения.

**Роли**. Пользователям назначаются роли. Роль — это контейнер правил, которому можно присвоить имя "Менеджер по продажам" или "Торговый представитель". В службе коллекций рабочих областей Power BI пользователи идентифицируются по свойству roles в маркере приложения.

**Правила**. У ролей есть правила, представляющие собой фактические фильтры, которые будут применяться к данным. Это может быть просто "Страна — США" или что-то гораздо более динамичное.

### <a name="example"></a>Пример

Далее в этой статье представлен пример настройки безопасности на уровне строк, а затем ее применения во внедренном приложении. В нашем примере используется PBIX-файл с [примером анализа данных о продажах](http://go.microsoft.com/fwlink/?LinkID=780547) .

![Пример отчета о продажах](media/row-level-security/scenario-2.png)

В нашем примере анализа данных о продажах показаны продажи для всех розничных магазинов определенной сети. Если не использовать безопасность на уровне строк, то все региональные менеджеры, которые входят в систему и просматривают отчет, будут видеть одни и те же данные. Руководство решило, что каждый региональный менеджер должен видеть данные по продажам только тех магазинов, которыми он управляет. Для этого мы используем безопасность на уровне строк.

Безопасность на уровне строк настраивается в Power BI Desktop. После открытия набора данных и отчета можно перейти на представление схемы.

![Схема моделирования в Power BI Desktop](media/row-level-security/diagram-view-3.png)

Ниже приведены некоторые примечания по этой схеме.

* Все показатели, например **Общий объем продаж**, хранятся в таблице фактов **Продажи**.
* Есть четыре дополнительных связанных таблицы измерений: **Позиция**, **Время**, **Хранилище** и **Район**.
* Стрелки на линиях связей указывают, каким образом фильтры могут передаваться из одной таблицы в другую. Например, если фильтр размещен в таблице **Время [Дата]**, на текущей схеме он будет отфильтровывать только значения в таблице **Продажи**. Так как все стрелки на линиях связей указывают на таблицу "Продажи", этот фильтр не будет влиять на остальные таблицы.
* В таблице **Район** указаны менеджеры по каждому району.
  
  ![Строки таблицы "Район"](media/row-level-security/district-table-4.png)

Если в рамках этой схемы к столбцу **Региональный менеджер** в таблице "Район" применить фильтр, соответствующий пользователю, просматривающему отчет, таблицы **Хранилище** и **Продажи** будут также отфильтрованы. В результате отобразятся данные только для этого конкретного регионального менеджера.

Этот процесс описывается далее.

1. На вкладке "Моделирование" щелкните **Управление ролями**.  
   ![Кнопка "Управление ролями" на ленте "Моделирование"](media/row-level-security/modeling-tab-5.png)
2. Создайте роль с именем **Менеджер**.  
   ![Создание ролей в Power BI Desktop](media/row-level-security/manager-role-6.png)
3. В таблице **Район** введите следующее выражение DAX: **[Региональный менеджер] = USERNAME()**.  
   ![Выражение DAX фильтра для таблицы в роли](media/row-level-security/manager-role-7.png)
4. Чтобы убедиться, что правила работают, на вкладке **Моделирование** щелкните **Просмотреть как роли**, а затем введите следующую команду:  
   ![Роли просмотра от имени](media/row-level-security/view-as-roles-8.png)

   Теперь данные в отчетах будут отображаться таким образом, как будто вы вошли под именем **Эндрю Ma**.

В случае применения такого фильтра будут отфильтрованы все записи в таблицах **Район**, **Хранилище** и **Продажи**. Однако из-за направления фильтра на линиях связей между таблицами **Продажи** и **Время**, **Продажи** и **Позиция**, а также **Позиция** и **Время** эти таблицы не будут отфильтрованы.

![Представление схемы с выделенными связями](media/row-level-security/diagram-view-9.png)

В нашем примере это приемлемый вариант, но если нужно, чтобы менеджеры не видели позиции не своих продаж, можно включить двунаправленную перекрестную фильтрацию для связи и направить фильтр безопасности в обоих направлениях. Для этого нужно изменить связи между таблицами **Продажи** и **Позиция** следующим образом:

![Направление кроссфильтрации для связи](media/row-level-security/edit-relationship-10.png)

Теперь фильтры могут также направляться из таблицы "Продажи" в таблицу **Позиция** .

![Значок направления фильтра связи в представлении схемы](media/row-level-security/diagram-view-11.png)

> [!NOTE]
> При использовании режима DirectQuery для данных необходимо включить двунаправленную перекрестную фильтрацию, выбрав два следующих параметра.

1. **Файл** -> **Параметры и настройки** -> **Функции предварительной версии** -> **Включить кроссфильтрацию в обоих направлениях для DirectQuery**;
2. **Файл** -> **Параметры и настройки** -> **DirectQuery** -> **Разрешить неограниченные меры в режиме DirectQuery**.

Дополнительные сведения о двунаправленной перекрестной фильтрации см. в техническом документе [Bidirectional cross-filtering in SQL Server Analysis Services 2016 and Power BI Desktop](http://download.microsoft.com/download/2/7/8/2782DF95-3E0D-40CD-BFC8-749A2882E109/Bidirectional cross-filtering in Analysis Services 2016 and Power BI.docx) (Двунаправленная перекрестная фильтрация в службах SQL Server Analysis Services 2016 и Power BI Desktop).

Это последнее, что нужно сделать в Power BI Desktop. Но необходимо проделать еще некоторую работу, чтобы правила безопасности на уровне строк, которые мы определили, работали в Power BI Embedded. Пользователи проходят проверку подлинности и авторизацию в приложении, а для предоставления им доступа к определенному отчету Power BI Embedded используются маркеры приложений. В Power BI Embedded нет сведений о том, кем является конкретный пользователь. Для функционирования безопасности на уровне строк потребуется передавать дополнительный контекст в маркере приложения.

* **username** (необязательно) — используется с безопасностью на уровне строк. Это строка, с помощью которой можно идентифицировать пользователя при применении правил безопасности на уровне строк. См. статью Using Row Level Security with Power BI Embedded (Использование безопасности на уровне строк в Power BI Embedded).
* **roles** — строка, содержащая роли, которые выбираются при применении правил безопасности на уровне строк. При выборе нескольких ролей их нужно передавать в виде массива строк.

Вы создадите маркер с помощью метода [CreateReportEmbedToken](https://docs.microsoft.com/dotnet/api/microsoft.powerbi.security.powerbitoken?redirectedfrom=MSDN#Microsoft_PowerBI_Security_PowerBIToken_CreateReportEmbedToken_System_String_System_String_System_String_System_DateTime_System_String_System_Collections_Generic_IEnumerable_System_String__). Если задано свойство username, необходимо также передать по крайней мере одно значение для свойства roles.

Например, можно изменить EmbedSample. Строку 55 DashboardController можно изменить с

    var embedToken = PowerBIToken.CreateReportEmbedToken(this.workspaceCollection, this.workspaceId, report.Id);

значение

    var embedToken = PowerBIToken.CreateReportEmbedToken(this.workspaceCollection, this.workspaceId, report.Id, "Andrew Ma", ["Manager"]);'

Весь маркер приложения выглядит следующим образом.

![Пример JSON Web Token](media/row-level-security/app-token-string-12.png)

Теперь вся работа проделана, и если пользователь войдет в наше приложение, чтобы просмотреть этот отчет, он увидит только те данные, к которым ему предоставлен доступ, как определено в параметрах безопасности уровня строк.

![Отчет в приложении](media/row-level-security/dashboard-13.png)

## <a name="see-also"></a>См. также

[Безопасность на уровне строк (RLS) в Power BI](https://powerbi.microsoft.com/documentation/powerbi-admin-rls/)  
[Аутентификация и авторизация в коллекциях рабочих областей Power BI](app-token-flow.md)  
[Power BI Desktop](https://powerbi.microsoft.com/documentation/powerbi-desktop-get-the-desktop/)  
[Пример внедрения JavaScript](https://microsoft.github.io/PowerBI-JavaScript/demo/)  

У вас имеются и другие вопросы? [Попробуйте задать их в сообществе Power BI](http://community.powerbi.com/)